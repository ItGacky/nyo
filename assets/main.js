(function(){function fa(a,b,d){return d<a?a:d>b?b:d}function oa(a,b){return null!=a?a:b}function Ea(a){return r(ab()*a)}function pa(a){return null==a?[]:a.map(function(a){return null!=a?a.toJSON():null})}function O(a,b){return null==b?[]:b.map(function(b){return null!=b?a.fromJSON(b):null})}function Fa(a){return void 0===a?"(undefined)":null===a?"(null)":a.toString()}function Ga(a){for(var b=[],d=1;d<arguments.length;d++)b[d-1]=arguments[d];return a.replace(/\$\{(\d+)\}/g,function(a,d){var f=parseInt(d,
10);return Fa(b[f])})}function Ha(a,b,d){return Object.defineProperty(a,b,{enumerable:!0,configurable:!0,writable:!0,value:d})}function qa(a,b,d,e){return Object.defineProperty(a,b,{enumerable:!0,configurable:!0,get:d,set:e})}function Cb(a,b){var d=document.createElement("script");d.src=a;d.onerror=b;document.head.appendChild(d)}function ra(a,b){if(a===b)return 0;if(void 0===a&&void 0!==b)return-1;if(void 0!==a&&void 0===b)return 1;if(null===a&&null!==b)return-1;if(null!==a&&null===b)return 1;var d=
typeof a,e=typeof b;if(d!==e)return d<e?-1:1;if("object"===d){if(a instanceof Date&&b instanceof Date)return ra(a.getTime(),b.getTime());if(a instanceof Array&&b instanceof Array){a:{for(var d=a.length,e=b.length,c=0,f=R(d,e);c<f;++c){var g=ra(a[c],b[c]);if(0!==g){d=g;break a}}d=d<e?-1:d>e?1:0}return d}if(a.consructor===Object&&b.constructor===Object){a:{for(var d=Ia(a).sort(),e=Ia(b).sort(),c=d.length,f=e.length,g=R(c,f),h=0;h<g;++h){var p=d[h],sa=e[h];if(p<sa||p>sa){d=-1;break a}p=ra(a[p],b[sa]);
if(0!==p){d=p;break a}}d=c<f?-1:c>f?1:0}return d}throw new TypeError("Cannot compare: ("+a+") and ("+b+")");}return a<b?-1:a>b?1:0}function ga(a,b){return(a||24)+"px "+(b||"Arial")}function ha(a,b){if(null==a)return b;if("function"===typeof a)return[a,b];a.push(b);return a}function aa(a){if(null!=a)if("function"===typeof a)J.then(a);else for(var b=0;b<a.length;b++)J.then(a[b])}function ta(a){for(var b,d=a.length,e=0;e<a.length;e++)a[e].then(function(){0>=--d&&(aa(b),b=void 0)});return{then:function(a){0<
d?b=ha(b,a):J.then(a);return this}}}function kb(a){var b,d=function(){a().then(function(){aa(b);b=void 0;a=null})};d.then=function(d){a?b=ha(b,d):J.then(d);return this};return d}function h(){for(var a=[],b=0;b<arguments.length;b++)a[b-0]=arguments[b];return new K(a)}function Db(a,b,d){function e(b){return(null==b.pageX?b.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-a.offsetLeft:b.pageX-a.offsetLeft)*k/a.offsetWidth}function c(b){return(null==b.pageY?b.clientY+document.body.scrollTop+
document.documentElement.scrollTop-a.offsetTop:b.pageY-a.offsetTop)*q/a.offsetHeight}function f(a){if(a.buttons&1)b.onDrag(e(a),c(a));else b.onHover(e(a),c(a));a.preventDefault()}function g(a){switch(a.button){case 0:b.onDown(e(a),c(a))}a.preventDefault()}function h(a){switch(a.button){case 0:b.onUp(e(a),c(a));break;case 2:b.onPress(l.TAB)}a.preventDefault()}function p(){null!=v&&clearTimeout(v);v=setTimeout(function(){v=void 0;var b=a.parentElement,e=b.clientWidth,b=b.clientHeight,b=b-a.offsetTop;
0<b&&(d.magnifyCanvas||(e=R(e,k),b=R(b,q)),e*q>k*b?e=ua(b*k/q):b=ua(e*q/k),0<e&&0<b&&(a.style.width=e+"px",a.style.height=b+"px",!d.refineCanvas&&(e>k||b>q)&&(e=k,b=q),a.width!==e||a.height!==b))&&(a.width=e,a.height=b)},300)}function sa(d){J.finish();var e=a.width,c=a.height,f=a.getContext("2d");f.clearRect(0,0,e,c);f.save();f.font=ga();e===k&&c===q||f.scale(e/k,c/q);b.onDraw(f,d);f.restore();window.requestAnimationFrame(sa)}var k=a.width,q=a.height;a.addEventListener("mousemove",f);a.addEventListener("touchmove",
f);a.addEventListener("mousedown",g);a.addEventListener("touchstart",g);a.addEventListener("mouseup",h);a.addEventListener("touchend",h);a.addEventListener("contextmenu",function(a){a.preventDefault()});a.addEventListener("mousewheel",function(a){b.onPress(0<a.wheelDelta?l.PAGE_UP:l.PAGE_DOWN);a.preventDefault()});window.addEventListener("keydown",function(a){if(!a.ctrlKey&&!a.altKey){var d=oa(a.keyCode,a.charCode);d&&l[d]&&(b.onPress(d),a.preventDefault())}});var v;window.addEventListener("resize",
p);"complete"===document.readyState?p():window.addEventListener("load",p);window.requestAnimationFrame(sa)}function Ja(a,b,d,e){void 0===e&&(e=!1);var c=a.w;a=a.h;if(c>b||a>d||e){e=c/b;var f=a/d;e>f?(c=b,a/=e):(c/=f,a=d)}return{w:c,h:a}}function va(a,b){if(b)for(var d in b)switch(d){case "fontSize":a.font=ga(b.fontSize,b.fontFamily);break;case "fontFamily":null==b.fontSize&&(a.font=ga(null,b.fontFamily));break;default:a[d]=b[d]}}function Ka(a,b,d,e,c,f){var g;null==e?(f=b,b=f.x,g=f.y,e=f.w,c=f.h,
f,f=d):g=d;if(0<e&&0<c){a.save();va(a,f);f&&!f.fillStyle||a.fillRect(b,g,e,c);if(!f||f.strokeStyle)d=a.lineWidth-1,a.strokeRect(b+d/2,g+d/2,e-d,c-d);a.restore()}}function La(a,b,d,e,c){function f(a,b,d,e,c){c&&!c.strokeStyle||a.strokeText(b,d,e);c&&!c.fillStyle||a.fillText(b,d,e)}a.save();va(a,c);if(0>b.indexOf("\n"))f(a,b,d,e,c);else{var g=b.split("\n");b=1.2*(c&&c.fontSize||24);switch(a.textBaseline){case "top":for(var h=0;h<g.length;h++){var p=g[h];f(a,p,d,e,c);e+=b}break;case "middle":e-=b*(g.length-
1)/2;for(h=0;h<g.length;h++)p=g[h],f(a,p,d,e,c),e+=b;break;case "bottom":for(h=0,g=g.reverse();h<g.length;h++)p=g[h],f(a,p,d,e,c),e-=b}}a.restore()}function wa(a,b,d,e,c,f,g){a.save();va(a,g);switch(a.textAlign){case "center":d+=c/2;break;case "right":d+=c;break}if(0>b.indexOf("\n")){switch(a.textBaseline){case "middle":e+=f/2;break;case "bottom":e+=f;break}g&&!g.strokeStyle||a.strokeText(b,d,e,c);g&&!g.fillStyle||a.fillText(b,d,e,c)}else{b=b.split("\n");var h=1.2*(g&&g.fontSize||24);switch(a.textBaseline){case "middle":e+=
(f-h*(b.length-1))/2;break;case "bottom":e=e+f-h*(b.length-1);break}for(f=0;f<b.length;f++){var p=a,k=b[f],l=d,q=e,v=c,bb=g;bb&&!bb.strokeStyle||p.strokeText(k,l,q,v);bb&&!bb.fillStyle||p.fillText(k,l,q,v);e+=h}}a.restore()}function lb(a,b,d,e,c,f,g){a=a.createLinearGradient(b,d,e,c);a.addColorStop(0,f);a.addColorStop(1,g);return a}function xa(a,b,d,e,c,f,g){0<e&&0<c&&(a.save(),a.fillStyle=lb(a,b,d,b,d+c,f,g),a.fillRect(b,d,e,c),a.restore())}function cb(a,b,d,e,c,f,g,h){void 0===h&&(h=0);0<e&&0<c&&
(a.save(),a.translate(b+e/2,d+c/2),a.scale(e,c),b=a.createRadialGradient(0,0,h/2,0,0,.5),b.addColorStop(0,f),b.addColorStop(1,g),a.fillStyle=b,a.fillRect(-.5,-.5,1,1),a.restore())}function k(a,b,d){return"rgb("+a+","+b+","+d+")"}function w(a,b,d,e){return"rgba("+a+","+b+","+d+","+e.toFixed(6).replace(/([0-9]+(\.[0-9]+[1-9])?)(\.?0+$)/,"$1")+")"}function Ma(a,b){return null==b?k(a.r,a.g,a.b):w(a.r,a.g,a.b,b)}function db(a){null==Na&&(Na=[h("Tag","Melee"),h("Tag","Throw"),h("Tag","Shoot"),h("Tag","Magic"),
h("Tag","Alchemy"),h("Tag","Slash"),h("Tag","Blunt"),h("Tag","Pierce"),h("Tag","Shield"),h("Tag","Head"),h("Tag","Body"),h("Tag","Arms"),h("Tag","Legs"),h("Tag","Fire"),h("Tag","Cold"),h("Tag","Lightning"),h("Tag","Life")]);return a.map(function(a){return Na[a].localized}).join(", ")}function ya(a){for(var b=0,d=0;d<a.length;d++)b|=1<<a[d];return b}function mb(a){var b={fillStyle:"white",strokeStyle:"black",fontSize:44,textAlign:"center",textBaseline:"middle"},d={textAlign:"right",textBaseline:"middle"},
e={textAlign:"right",textBaseline:"middle"},c=new I(4,4,32,32,new H("assets/config.png"),function(){function c(a,b){var e=100+70*a;(new G(640,e,160,60,new A(b,d))).attach(p);return e}function g(a,b,d){a=c(a,b);b=new Eb(810,a+15,300,30,d);b.attach(p);(new G(1120,a,50,60,new A(d,e))).attach(p);return b}function Z(a,b,d,e,g,h){a=c(a,b);var Z=new I(810,a+0,100,60,new A(function(){var a=g();Z.pressed&&Z.hover&&(a=!a);return(a?d:e).localized}),h);Z.attach(p);return Z}var p=new Oa;(new G(0,0,1280,720,new nb(Pa))).attach(p);
(new G(0,20,1280,80,new A(h("Config","Caption"),b))).attach(p);(new I(480,495,320,90,new A(h("Config","OK")),function(){p.detach()},vb)).attach(p);var k=Ia(K.languages).sort().map(function(a){return h("Language",a)}),l=new B(10,10,160,B.heightOf(R(10,k.length)),[{name:h("Config","LanguageID"),extract:function(a){return a.src[1]},width:40,align:"center"},{name:h("Config","LanguageName"),extract:function(a){return a.localized}}],k,function(a){l.selected=a;K.language=a.src[1]});l.selected=l.rows.find(function(a){return a.src[1]===
K.language});l.attach(p);g(0,h("Config","Volume"),t.volume);g(1,h("Config","CPUEffects"),t.effects);var k=h("Config","On"),q=h("Config","Off");Z(2,h("Config","FullScreen"),k,q,function(){return System.getFullScreen()},function(){System.setFullScreenn(!System.getFullScreen())});Z(3,h("Config","MagnifyCanvas"),k,q,function(){return t.magnifyCanvas},function(){t.magnifyCanvas=!t.magnifyCanvas});Z(4,h("Config","RefineCanvas"),k,q,function(){return t.refineCanvas},function(){t.refineCanvas=!t.refineCanvas});
(function(a,b,d){a=new I(810,70*a+100,300,60,new A(b),d);a.attach(p);return a})(5,h("Config","BackToTitle"),function(){p.detach();Qa()});p.attach(a)},Fb,new I.IconDesign("white"));c.attach(a);return c}function Ra(){try{var a=System.getRoamingStorage("NYO");if(!a)return null;var b=Sa(a);return{shop:b.shop,warehouse:O(ba,b.warehouse),reservers:O(Y,b.reservers),party:O(Y,b.party),gold:b.gold}}catch(d){return E.error(d),null}}function Ta(a){try{System.setRoamingStorage("NYO",eb(a))}catch(b){E.error(b)}fb()}
function Gb(){try{var a=System.getLocalStorage("NYO");if(a){var b=Sa(a);b&&(a=function(a,b){return typeof a===typeof b?b:a},K.language=a(K.language,b.language),t.magnifyCanvas=a(t.magnifyCanvas,b.magnifyCanvas),t.refineCanvas=a(t.refineCanvas,b.refineCanvas),t.volume.value=a(t.volume.value,b.volume),t.effects.value=a(t.effects.value,b.effects))}}catch(d){E.error(d)}}function fb(){try{System.setLocalStorage("NYO",eb({language:K.language,magnifyCanvas:t.magnifyCanvas,refineCanvas:t.refineCanvas,volume:t.volume.value,
effects:t.effects.value}))}catch(a){E.error(a)}}var x=this&&this.__extends||function(a,b){function d(){this.constructor=a}for(var e in b)b.hasOwnProperty(e)&&(a[e]=b[e]);a.prototype=null===b?Object.create(b):(d.prototype=b.prototype,new d)},Ia=Object.keys,ob=Math.abs,R=Math.min,T=Math.max,r=Math.floor,Ua=Math.ceil,ua=Math.round,ja=Math.pow,U=Math.sin,ka=Math.cos,wb=Math.atan2,V=Math.PI,ab=Math.random,Sa=JSON.parse,eb=JSON.stringify,Va=function(){},J={sig:null,then:function(a){this.sig=ha(this.sig,
a);return this},finish:function(){var a=this.sig;if(a)if(this.sig=null,"function"===typeof a)a();else for(var b=0;b<a.length;b++)(0,a[b])()}},K=function(){function a(a){this.src=a}Object.defineProperty(a.prototype,"localized",{get:function(){function b(b){var d=a.languages,f=a.language,g=d[f];null==g&&(f=a.language=a.fallback,g=d[f]);if("string"===typeof g)return d[f]=!0,Cb(g,function(){d[f]=!1}),null;if(!0===g)return null;if(!1===g)return b.join(".");for(var h=g,g=0,p=b.length;g<p;++g)if(h=h[b[g]],
null==h)return b.join(".");return h.toString()}if(this._language!==a.language){var d=b(this.src);if(null===d)return this.src.join(".");this._language=a.language;this._localized=d}return this._localized},enumerable:!0,configurable:!0});a.prototype.toString=function(){return this.localized};a.language=(window.navigator.userLanguage||window.navigator.language||window.navigator.browserLanguage).substr(0,2);a.fallback="en";a.languages={};return a}();System.localize=function(a,b){K.languages[a]=b};var l;
(function(a){a[a.TAB=9]="TAB";a[a.ENTER=13]="ENTER";a[a.ESCAPE=27]="ESCAPE";a[a.SPACE=32]="SPACE";a[a.PAGE_UP=33]="PAGE_UP";a[a.PAGE_DOWN=34]="PAGE_DOWN";a[a._END=35]="_END";a[a._HOME=36]="_HOME";a[a.LEFT=37]="LEFT";a[a.UP=38]="UP";a[a.RIGHT=39]="RIGHT";a[a.DOWN=40]="DOWN";a[a._INSERT=45]="_INSERT";a[a.DELETE=46]="DELETE";a[a.$0=48]="$0";a[a.$1=49]="$1";a[a.$2=50]="$2";a[a.$3=51]="$3";a[a.$4=52]="$4";a[a.$5=53]="$5";a[a.$6=54]="$6";a[a.$7=55]="$7";a[a.$8=56]="$8";a[a.$9=57]="$9";a[a.A=65]="A";a[a.B=
66]="B";a[a.C=67]="C";a[a.D=68]="D";a[a.E=69]="E";a[a.F=70]="F";a[a.G=71]="G";a[a.H=72]="H";a[a.I=73]="I";a[a.J=74]="J";a[a.K=75]="K";a[a.L=76]="L";a[a.M=77]="M";a[a.N=78]="N";a[a.O=79]="O";a[a.P=80]="P";a[a.Q=81]="Q";a[a.R=82]="R";a[a.S=83]="S";a[a.T=84]="T";a[a.U=85]="U";a[a.V=86]="V";a[a.W=87]="W";a[a.X=88]="X";a[a.Y=89]="Y";a[a.Z=90]="Z"})(l||(l={}));var ca=function(){function a(){}a.prototype.onHover=function(a,d){};a.prototype.onDrag=function(a,d){};a.prototype.onDown=function(a,d){};a.prototype.onUp=
function(a,d){};a.prototype.onPress=function(a){};a.prototype.onDraw=function(a,d){};a.prototype.attach=function(a){return a.onAttach(this)};a.prototype.detach=function(){var a=this.parent;return a?(a.onDetach(this),a):null};Object.defineProperty(a.prototype,"visible",{get:function(){return!0},set:function(a){Ha(this,"visible",a)},enumerable:!0,configurable:!0});return a}(),Q=function(a){function b(b){a.call(this);this.children=[];if(b)for(var e=0;e<b.length;e++)b[e].attach(this)}x(b,a);b.prototype.onAttach=
function(a){if(a.parent===this)return!1;this.children.push(a);a.parent=this;return!0};b.prototype.onDetach=function(a){if(null==a.parent)return!1;a.parent=null;for(var b=this.children,c=0;c<b.length;++c)if(b[c]===a){a=this.children;for(var b=a.length,f=Array(b-1),g=0;g<c;++g)f[g]=a[g];for(g=c+1;g<b;++g)f[g-1]=a[g];this.children=f;break}return!0};b.prototype.onHover=function(a,b){for(var c=0,f=this.children;c<f.length;c++){var g=f[c];if(g.visible)g.onHover(a,b)}};b.prototype.onDrag=function(a,b){for(var c=
0,f=this.children;c<f.length;c++){var g=f[c];if(g.visible)g.onDrag(a,b)}};b.prototype.onDown=function(a,b){for(var c=0,f=this.children;c<f.length;c++){var g=f[c];if(g.visible)g.onDown(a,b)}};b.prototype.onUp=function(a,b){for(var c=0,f=this.children;c<f.length;c++){var g=f[c];if(g.visible)g.onUp(a,b)}};b.prototype.onPress=function(a){for(var b=0,c=this.children;b<c.length;b++){var f=c[b];if(f.visible)f.onPress(a)}};b.prototype.onDraw=function(a,b){for(var c=0,f=this.children;c<f.length;c++){var g=
f[c];if(g.visible)g.onDraw(a,b)}};return b}(ca),nb=function(){function a(a){this.rectStyle=a}a.prototype.draw=function(a,d,e){Ka(a,e,this.rectStyle)};return a}(),A=function(){function a(a,d,e){this.value=a;this.textStyle=d;this.rectStyle=e;d&&d.fillStyle&&d.textAlign&&d.textBaseline||(a=Object.create(d||null),d&&d.fillStyle||(a.fillStyle="white"),d&&d.textAlign||(a.textAlign="center"),d&&d.textBaseline||(a.textBaseline="middle"),this.textStyle=a)}a.prototype.draw=function(a,d,e){d=e.x;var c=e.y,f=
e.w;e=e.h;this.rectStyle&&Ka(a,d,c,f,e,this.rectStyle);wa(a,this.text,d,c,f,e,this.textStyle)};Object.defineProperty(a.prototype,"text",{get:function(){var a=this.value;"function"===typeof a&&(a=a());return Fa(a)},enumerable:!0,configurable:!0});return a}(),H=function(){function a(a){this.src=a;this._image=void 0}a.from=function(b){var d=new a(void 0);d._image=b;return d};a.prototype.then=function(a){null==this._image?(this.sig=ha(this.sig,a),this.preload()):J.then(a);return this};a.prototype.preload=
function(){var b=this;if(void 0===this._image){this._image=null;var d=new Image;d.addEventListener("load",function(){b._image=d;aa(b.sig);b.sig=void 0});d.addEventListener("error",function(){b._image=a.DUMMY;aa(b.sig);b.sig=void 0});d.src=this.src}};Object.defineProperty(a.prototype,"image",{get:function(){void 0===this._image&&this.preload();return this._image},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"w",{get:function(){var a=this.image;return a?a.width:1},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"h",{get:function(){var a=this.image;return a?a.height:1},enumerable:!0,configurable:!0});a.prototype.draw=function(a,d,e,c,f){d=this.image;var g=e.x,h=e.y,p=e.w;e=e.h;d&&0<p&&0<e&&(!c||0>=f?a.drawImage(d,g,h,p,e):(a.save(),a.globalCompositeOperation="destination-out",a.drawImage(d,g,h,p,e),a.globalCompositeOperation="destination-over",a.fillStyle=c,a.fillRect(g,h,p,e),1>f&&(a.globalCompositeOperation="source-over",a.globalAlpha=1-f,a.drawImage(d,
g,h,p,e)),a.restore()))};a.DUMMY=null;return a}(),Hb={fontSize:32,fillStyle:"white",strokeStyle:"black",textAlign:"left",textBaseline:"top",lineWidth:2},Pa={fillStyle:w(0,0,0,.8)},Ib={fillStyle:"white",strokeStyle:"black",fontSize:44,textAlign:"center",textBaseline:"middle"},F=function(a){function b(b,e){a.call(this);this.duration=b;e&&(this.onAnimation=e)}x(b,a);b.prototype.attach=function(b){return a.prototype.attach.call(this,b)?(this.start=performance.now(),!0):!1};b.prototype.detach=function(){this.start=
null;return a.prototype.detach.call(this)};b.prototype.onDraw=function(a,b){var c=this.start;null!=c&&(b>=c+this.duration?(this.onAnimation(1,a,b),this.detach(),aa(this.sig),this.sig=void 0):(c=T(0,b-c)/this.duration,this.onAnimation(c,a,b)))};b.prototype.onAnimation=function(a,b,c){};b.prototype.then=function(a){this.sig=ha(this.sig,a);return this};b.clamp=function(a,b,c){return null==b||a<b?0:null==c||b+c<a?1:(a-b)/c};b.cycle=function(a,b,c){return null==b||null==c||a<b?0:(a-b)%c/c};return b}(ca),
gb=function(a){function b(b,e){void 0===e&&(e=400);a.call(this,e);this.next=b}x(b,a);b.prototype.onAnimation=function(a,b,c){if(1>a){if(0<a)this.next.onDraw(b,c);b.save();b.globalAlpha=1-a;b.fillStyle="black";b.fillRect(0,0,1280,720);b.restore()}else this.next.attach(this.parent)};return b}(F),da=function(a){function b(b,e,c){void 0===c&&(c=400);a.call(this,c);this.prev=b;this.next=e}x(b,a);b.prototype.attach=function(b){return a.prototype.attach.call(this,b)?(this.prev.detach(),!0):!1};b.prototype.onAnimation=
function(a,b,c){1>a?(this.prev.onDraw(b,c),0<a&&(b.save(),b.globalAlpha=a,b.fillStyle="black",b.fillRect(0,0,1280,720),b.restore())):this.next&&(new gb(this.next,this.duration)).attach(this.parent)};return b}(F),Oa=function(a){function b(){a.apply(this,arguments)}x(b,a);b.prototype.attach=function(b){return null==this.prev&&null!=b.parent&&a.prototype.attach.call(this,b.parent)?(b.detach(),this.prev=b,!0):!1};b.prototype.detach=function(){var b=a.prototype.detach.call(this);b&&this.prev.attach(b);
return b};b.prototype.onDraw=function(b,e){this.prev.onDraw(b,e);a.prototype.onDraw.call(this,b,e)};b.confirm=function(a,e){for(var c=[],f=2;f<arguments.length;f++)c[f-2]=arguments[f];var g=new b;(new G(0,0,1280,720,new A(e,Ib,Pa))).attach(g);for(var f=c.length,h=1280/(3+f),p=h/8,k=(1280-h*f-p*(f-1))/2,l=function(a){var b=c[a],d=b.click,e=b.mnemonic;(new I(k+(h+p)*a,495,h,90,new A(b.label),d?function(){g.detach();d()}:function(){g.detach()},e)).attach(g)},q=0;q<f;++q)l(q);g.attach(a);return g};return b}(Q),
la=function(a){function b(b,e,c,f){a.call(this);this.x=b;this.y=e;this.w=c;this.h=f}x(b,a);b.prototype.contains=function(a,b){return this.visible&&this.x<=a&&this.y<=b&&a<this.x+this.w&&b<this.y+this.h};Object.defineProperty(b.prototype,"left",{get:function(){return this.x},set:function(a){this.w=this.w+this.x-a;this.x=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"right",{get:function(){return this.x+this.w},set:function(a){this.w=a-this.x},enumerable:!0,configurable:!0});
Object.defineProperty(b.prototype,"top",{get:function(){return this.y},set:function(a){this.h=this.h+this.y-a;this.y=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"bottom",{get:function(){return this.y+this.h},set:function(a){this.h=a-this.y},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"center",{get:function(){return{x:this.x+this.w/2,y:this.y+this.h/2}},enumerable:!0,configurable:!0});b.prototype.moveTo=function(a,b){this.x=a;this.y=b;return this};b.prototype.moveBy=
function(a,b){this.x+=a;this.y+=b;return this};return b}(ca),G=function(a){function b(b,e,c,f,g){a.call(this,b,e,c,f);this.drawable=g}x(b,a);b.prototype.onDraw=function(a,b){this.drawable.draw(a,b,this)};return b}(la),I=function(a){function b(d,e,c,f,g,h,p,k){void 0===k&&(k=b.defaultDesign);a.call(this,d,e,c,f);this.drawable=g;this.click=h;this.mnemonic=p;this.design=k;this.hover=!1}x(b,a);Object.defineProperty(b.prototype,"enabled",{get:function(){return!0},set:function(a){Ha(this,"enabled",a)},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"state",{get:function(){return this.enabled?this.pressed?2:this.hover?1:0:3},enumerable:!0,configurable:!0});b.prototype.onHover=function(a,b){this.hover=this.contains(a,b);this.pressed=null};b.prototype.onDrag=function(a,b){null!=this.pressed&&(this.pressed=this.contains(a,b))};b.prototype.onDown=function(a,b){this.enabled&&this.contains(a,b)&&(this.pressed=!0)};b.prototype.onUp=function(a,b){var c=this.pressed;this.pressed=null;if(c&&
this.contains(a,b))this.onClick()};b.prototype.onPress=function(a){this.mnemonic&&0<=this.mnemonic.indexOf(a)&&this.enabled&&(this.pressed=!1,this.onClick())};b.prototype.onClick=function(){var a=this;this.click&&J.then(function(){return a.click()})};b.prototype.onDraw=function(a,b){this.design.draw(a,b,this)};b.defaultDesign={draw:function(a,b,c){a.save();switch(c.state){case 0:a.fillStyle=w(0,0,0,.8);a.strokeStyle=k(200,200,200);break;case 1:a.fillStyle=w(0,0,50,.8);a.strokeStyle=k(100,100,200);
break;case 2:a.fillStyle=w(0,0,150,.8);a.strokeStyle=k(100,100,255);break;case 3:a.fillStyle=w(200,200,200,.8),a.strokeStyle=k(200,200,200)}a.fillRect(c.x,c.y,c.w,c.h);a.strokeRect(c.x,c.y,c.w,c.h);a.restore();c.drawable&&c.drawable.draw(a,b,c)}};b.IconDesign=function(){function a(b){this.overlay=b}a.prototype.draw=function(a,b,d){var g=d.drawable;switch(d.state){case 0:g.draw(a,b,d);break;case 1:g.draw(a,b,d,this.overlay,.7);break;case 2:g.draw(a,b,d,this.overlay,.9);break;case 3:g.draw(a,b,d,k(200,
200,200),.8)}};return a}();return b}(la),Jb=function(a){function b(b,e,c,f,g,h,k,l,t,q){void 0===q&&(q=I.defaultDesign);a.call(this,b,e,c,f,h,k,t,q);this.group=g;this.swap=l;g.push(this)}x(b,a);b.prototype.onDrag=function(b,e){var c=this;a.prototype.onDrag.call(this,b,e);if(this.dragged&&!this.swapping){var f=this.group.find(function(a){return a!==c&&a.contains(b,e)&&!a.swapping});if(f){var g=performance.now();this.onSwap(f,g);f.onSwap(this,g);this.dragged={xOrig:this.swapping.xTo,yOrig:this.swapping.yTo};
this.swap&&this.swap(f)}else null!=this.dragged.xDown?(this.x=this.dragged.xOrig-this.dragged.xDown+b,this.y=this.dragged.yOrig-this.dragged.yDown+e):(this.dragged.xDown=b,this.dragged.yDown=e)}};b.prototype.onDown=function(b,e){a.prototype.onDown.call(this,b,e);!this.dragged&&this.contains(b,e)&&(this.dragged={xDown:b,yDown:e,xOrig:this.x,yOrig:this.y})};b.prototype.onUp=function(b,e){if(this.swapping)this.dragged=null,a.prototype.onUp.call(this,b,e);else if(this.dragged){var c=this.dragged,f=c.xOrig,
c=c.yOrig;this.swapping={start:performance.now(),xFrom:this.x,yFrom:this.y,xTo:f,yTo:c};this.dragged=null;if(this.pressed&&(this.pressed=null,this.contains(b,e)&&f<=b&&c<=e&&b<f+this.w&&e<c+this.h))this.onClick()}else a.prototype.onUp.call(this,b,e)};b.prototype.onSwap=function(a,b){this.pressed=null;this.swapping={start:b,xFrom:this.x,yFrom:this.y,xTo:a.dragged?a.dragged.xOrig:a.x,yTo:a.dragged?a.dragged.yOrig:a.y}};b.prototype.onDraw=function(b,e){if(this.swapping){var c=F.clamp(e,this.swapping.start,
200);1>c?(c=(1-ka(V*c))/2,this.x=this.swapping.xFrom*(1-c)+this.swapping.xTo*c,this.y=this.swapping.yFrom*(1-c)+this.swapping.yTo*c):(this.x=this.swapping.xTo,this.y=this.swapping.yTo,this.swapping=null)}a.prototype.onDraw.call(this,b,e)};return b}(I),B=function(a){function b(d,e,c,f,g,h,k,l){void 0===l&&(l=b.defaultDesign);a.call(this,d,e,c,f);this.columns=g;this.rows=h;this.click=k;this.design=l;this.topRow=0}x(b,a);b.heightOf=function(a,e){void 0===e&&(e=b.defaultDesign);return e.headerHeight+
a*e.rowHeight};b.prototype.onHover=function(a,b){this.hover=this.toRowIndex(a,b);this.scrolling=this.dragged=null};b.prototype.onDrag=function(a,b){var c=this.design.headerHeight;null!=this.scrolling?this.scrollTo(r(this.rows.length*(b-(this.y+c)-this.scrolling)/(this.h-c))):(c=this.toRowIndex(a,b),null!=c&&null!=this.dragged&&c!==this.dragged&&(f=[this.rows[c],this.rows[this.dragged]],this.rows[this.dragged]=f[0],this.rows[c]=f[1],this.dragged=c,this.sortkeys=this.scrolling=this.hover=null));var f};
b.prototype.onDown=function(a,b){if(this.contains(a,b)&&(this.hover=this.dragged=this.toRowIndex(a,b),null==this.dragged)){var c=this.design,f=c.headerHeight,g=this.w-c.scrollBarWidth,c=this.y+f;if(this.x<=a&&a<this.x+g&&this.y<=b&&b<c)c=this.toColumnIndex(a,b),null!=c&&this.sort(c,null!=this.sortkeys&&this.sortkeys[0]===c+1);else if(this.x+g<=a&&a<this.right){var g=this.rows.length,h=this.displayCount,f=this.h-f,k=c+f*this.topRow/g,l=f*h/g;c<=b&&b<k?(this.scrollTo(r(g*(b-c)/f)),k=c+f*this.topRow/
g):k+l<=b&&b<this.bottom&&(this.scrollTo(r(g*(b-c)/f)-h+1),k=c+f*this.topRow/g);k<=b&&b<k+l&&(this.scrolling=b-k)}}};b.prototype.onUp=function(a,b){null==this.scrolling&&null!=this.dragged&&this.dragged===this.hover&&(this.click(this.rows[this.dragged],this.dragged),this.refresh());this.scrolling=this.dragged=null;this.hover=this.toRowIndex(a,b)};b.prototype.onPress=function(a){switch(a){case l.PAGE_DOWN:this.scrollBy(this.scrollStep);break;case l.PAGE_UP:this.scrollBy(-this.scrollStep)}};b.prototype.onDraw=
function(a,b){var c=this.design,f=c.headerHeight,g=c.scrollBarWidth,h=this.rows.length,k=this.displayCount,l=this.x,t=this.y+f,q=this.w-g,v=this.h-f,r=this.x+q,S=(0<h&&v*this.topRow/h||0)+t,M=0<h&&v*k/h||v,tb=this.defaultColumnWidth;c.drawHeader(a,this.x,this.y,this.w,f);c.drawBackground(a,this.x,t,q,v);0<g&&(c.drawHeader(a,r,t,g,v),k<h&&c.drawScrollBar(a,r,S,g,M));a.save();a.font=c.rowFont;a.fillStyle=c.rowStyle;a.textBaseline="middle";for(var M=c.rowHeight,P=0;P<k;++P){var g=P+this.topRow,ub=this.rows[g],
ia=t+M*P;g===this.dragged?c.drawRowDragged(a,this.x,ia,q,M):ub===this.selected?c.drawRowSelected(a,this.x,ia,q,M):g===this.hover&&null==this.dragged&&c.drawRowHover(a,this.x,ia,q,M);for(var w=0,g=0,h=this.columns.length;g<h;++g){var r=this.columns[g],S=oa(r.width,tb),za=this.extract(ub,r);if(null!=za){var ma=l+w+2,Wa=S-4;a.textAlign=r.align||"left";switch(a.textAlign){case "center":ma+=Wa/2;break;case "right":ma+=Wa}a.fillText(za,ma,ia+M/2,Wa)}w+=S}}a.restore();a.save();M=0;a.font=c.headerFont;a.fillStyle=
c.headerStyle;a.textAlign="center";a.textBaseline="middle";a.strokeStyle=c.lineStyle;g=0;for(h=this.columns.length;g<h;++g)r=this.columns[g],S=oa(r.width,tb),P=l+M,0<g&&(a.beginPath(),a.moveTo(P,t),a.lineTo(P,this.bottom),a.stroke()),a.fillText(r.name.localized,P+S/2,this.y+f/2),M+=S;a.restore();0===k&&0<v&&c.emptyText&&(a.save(),a.font=c.emptyFont,a.textAlign="center",a.textBaseline="middle",a.fillStyle=c.emptyStyle,a.fillText(c.emptyText.localized,this.x+q/2,t+v/2),a.restore())};Object.defineProperty(b.prototype,
"displayCount",{get:function(){var a=this.design;return R(r((this.h-a.headerHeight)/a.rowHeight),this.rows.length)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"scrollStep",{get:function(){return T(r(.2*this.displayCount),1)},enumerable:!0,configurable:!0});b.prototype.extract=function(a,b){var c=b.extract;switch(typeof c){case "function":return c(a);case "number":return a[c];default:return a[c]}};b.prototype.compare=function(a,b){for(var c=0,f=0,g=this.sortkeys.length;0===c&&
f<g;++f){var h=this.sortkeys[f],c=this.columns[(0<h?h:-h)-1],c=c.compare?c.compare(a,b):ra(this.extract(a,c),this.extract(b,c));0>h&&(c=-c)}return c};b.prototype.sort=function(a,b){var c=this;void 0===b&&(b=!1);var f=a+1;if(this.sortkeys){for(var g=0,h=this.sortkeys.length;g<h;++g)if(this.sortkeys[g]===f||this.sortkeys[g]===-f){this.sortkeys.splice(g,1);break}this.sortkeys.unshift(b?-f:f)}else this.sortkeys=[b?-f:f];this.rows.sort(function(a,b){return c.compare(a,b)})};b.prototype.toRowIndex=function(a,
b){var c=this.design,f=this.w-c.scrollBarWidth;return this.x<=a&&a<this.x+f&&(c=this.topRow+r((b-this.y-c.headerHeight)/c.rowHeight),this.topRow<=c&&c<this.rows.length)?c:null};b.prototype.toColumnIndex=function(a,b){var c=this.w-this.design.scrollBarWidth;if(this.x<=a&&a<this.x+c)for(var c=this.defaultColumnWidth,f=this.x,g=0,h=this.columns.length;g<h;++g){var k=oa(this.columns[g].width,c);if(f<=a&&a<f+k)return g;f+=k}return null};Object.defineProperty(b.prototype,"defaultColumnWidth",{get:function(){for(var a=
this.w-this.design.scrollBarWidth,b=0,c=0,f=0,g=this.columns;f<g.length;f++){var h=g[f];null!=h.width?b+=h.width:++c}return 0<c&&b<a?(a-b)/c:0},enumerable:!0,configurable:!0});b.prototype.refresh=function(){var a=this.rows.length;this.dragged>=a&&(this.dragged=null);this.hover>=a&&(this.hover=null);this.scrollTo(this.topRow)};b.prototype.scrollTo=function(a){this.topRow=fa(0,this.rows.length-this.displayCount,a)};b.prototype.scrollBy=function(a){this.scrollTo(this.topRow+a)};b.defaultDesign={rowHeight:28,
rowFont:ga(20),rowStyle:"white",headerHeight:24,headerFont:ga(18),headerStyle:"white",scrollBarWidth:14,lineStyle:k(102,102,102),drawHeader:function(a,b,c,f,g){a.save();a.fillStyle=w(25,25,25,.8);a.fillRect(b,c,f,g);a.restore()},drawBackground:function(a,b,c,f,g){a.save();a.fillStyle=w(0,0,0,.6);a.fillRect(b,c,f,g);a.restore()},drawScrollBar:function(a,b,c,f,g){xa(a,b,c,f,g,k(100,100,100),k(75,75,75))},drawRowDragged:function(a,b,c,f,g){xa(a,b,c,f,g,k(255,0,0),k(50,0,0))},drawRowSelected:function(a,
b,c,f,g){xa(a,b,c,f,g,k(100,0,0),k(50,0,0))},drawRowHover:function(a,b,c,f,g){xa(a,b,c,f,g,k(75,0,0),k(50,0,0))}};return b}(la),xb=function(){function a(a,d,e){this.min=d;this.max=e;this.value=a}Object.defineProperty(a.prototype,"value",{get:function(){return this._value},set:function(a){this._value=fa(this.min,this.max,ua(a))},enumerable:!0,configurable:!0});a.prototype.toString=function(){return this._value.toString()};a.prototype.valueOf=function(){return this._value};return a}(),Eb=function(a){function b(d,
e,c,f,g,h){void 0===h&&(h=b.defaultDesign);a.call(this,d,e,c,f);this.value=g;this.design=h;this.hover=this.dragged=!1}x(b,a);b.prototype.getValueAsX=function(){var a=this.design.knobWidth,b=this.value,c=b.min;return this.x+a/2+(b.value-c)/(b.max-c)*(this.w-a)};b.prototype.setValueByX=function(a){var b=this.design.knobWidth;a=fa(0,1,(a-this.x-b/2)/(this.w-b));var b=this.value,c=b.min;this.value.value=ua(c+a*(b.max-c))};b.prototype.onHover=function(a,b){this.hover=this.contains(a,b);this.dragged=!1};
b.prototype.onDrag=function(a,b){this.hover=this.dragged&&this.contains(a,b);this.dragged&&this.setValueByX(a)};b.prototype.onDown=function(a,b){this.contains(a,b)&&(this.dragged=!0,this.setValueByX(a))};b.prototype.onUp=function(a,b){this.dragged=!1};b.prototype.onDraw=function(a,b){this.design.draw(a,b,this)};Object.defineProperty(b.prototype,"knob",{get:function(){var a=this.design.knobWidth,b=this.h;return{x:this.getValueAsX()-a/2,y:this.y-(this.h-b)/2,w:a,h:b,state:this.dragged?2:this.hover?
1:0}},enumerable:!0,configurable:!0});b.defaultDesign={knobWidth:12,draw:function(a,b,c){Ka(a,c,{fillStyle:w(50,50,50,.8),strokeStyle:"white",lineWidth:4});b=c.knob;c={strokeStyle:"white",lineWidth:4};switch(b.state){case 0:c.fillStyle=w(150,150,150,.8);break;case 1:c.fillStyle=w(200,200,200,.8);break;case 2:c.fillStyle=w(255,255,255,.8)}Ka(a,b,c)}};return b}(la),Kb=function(a){function b(b,e,c,f,g,h){a.call(this,b,e,c,f);this.duration=g;this.style=h;this.logs=[]}x(b,a);b.prototype.onDraw=function(a,
b){var c=this.logs;if(0<c.length){var f=b-this.duration,g=c.findIndex(function(a){return a.when>f});0>g?c.length=0:c.splice(0,g);g=c.length;if(0<g)for(var h=this.style,k=1.2*(h&&h.fontSize||24),l=0;l<g;++l)wa(a,c[l].message,this.x,this.y+l*k,this.w,k,h)}};b.prototype.log=function(a){if(a){var b=performance.now(),c=this.logs,f=c.length;0<f&&c[f-1].message===a?c[f-1].when=b:c.push({message:Fa(a),when:b})}};b.prototype.error=function(a){this.log(a)};return b}(la);K.languages.en="assets/lang/en.js";K.languages.ja=
"assets/lang/ja.js";var pb={bkgnd:w(0,0,0,.6),delta:k(255,51,0),normal:k(153,204,0),full:k(0,204,51)},yb={bkgnd:w(0,0,0,.6),delta:k(0,51,102),normal:k(0,153,204),full:k(0,153,255)},Xa=[{PICK:0,WALK:!1,POPUP:!1},{PICK:0,WALK:!1,POPUP:!0},{PICK:0,WALK:!0,POPUP:!0},{PICK:300,WALK:!0,POPUP:!0}],vb=[l.TAB,l.ENTER,l.ESCAPE,l.SPACE,l.DELETE],qb=[l.ENTER,l.SPACE,l.Y],rb=[l.TAB,l.ESCAPE,l.DELETE,l.N],Fb=[l.ESCAPE],Lb=[l.ENTER,l.SPACE],E,Mb={Warrior:{INT:4,DEX:4,STR:7,equipments:["Mace","PlateArmor","Mace"],
skills:["Swing","Crash","Bash","PathToWarrior"],image:"nazrin"},Samurai:{INT:3,DEX:7,STR:5,equipments:["Katana","Chainmail"],skills:["Swing","Slash","CutThrough","Sweep"],image:"rin"},Knight:{INT:6,DEX:2,STR:7,equipments:["Spear","LamellarArmor","KiteShield"],skills:["Swing","Stab","Thrust","ShieldBash","ShieldCharge"],image:"toramaru"},Thief:{INT:3,DEX:6,STR:6,equipments:["LongBow","LetherArmor","FirstAidKit"],skills:["Shoot","PoisonArrow","FirstAid"],image:"marisa"},Healer:{INT:7,DEX:3,STR:5,equipments:["Staff",
"Robe"],skills:["Swing","Heal","PartyHeal"],image:"reimu"},Mage:{INT:8,DEX:4,STR:3,equipments:["Wand","Robe"],skills:["FireBall","IceSpear","DrainLife","LightningLaser","FireNova"],image:"utsuho"}},zb={Ant:{INT:3,DEX:3,STR:4,equipments:["Dagger","LetherArmor"],skills:["Swing"],image:"ant.png"},Elemental:{INT:4,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["FireBall","ResistFire"],image:"elemental.png"},Frog:{INT:4,DEX:4,STR:4,equipments:["ShortBow","LetherArmor"],skills:["Shoot"],image:"frog.png"},
Plant:{INT:4,DEX:3,STR:4,equipments:["Wand","LetherArmor"],skills:["FireNova"],image:"plant.png"},Slug:{INT:3,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["DrainLife"],image:"slug.png"},Snail:{INT:3,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["Heal"],image:"snail.png"},Sword:{INT:3,DEX:5,STR:4,equipments:["LongSword","LetherArmor"],skills:["Swing"],image:"sword.png"},Wall:{INT:2,DEX:2,STR:6,equipments:["Mace","LetherArmor"],skills:["Swing"],image:"wall.png"},Weasel:{INT:3,DEX:6,
STR:3,equipments:["Spear","LetherArmor"],skills:["Thrust"],image:"weasel.png"}},Nb={AddedFire:{tags:[0,1,2],min:5,max:10,ATK:function(a,b){return b+a}}},W={Dagger:{tags:[0,5],weight:13,price:100,ATK:30},ShortSword:{tags:[0,5],weight:15,price:100,ATK:40},LongSword:{tags:[0,5],weight:16,price:100,ATK:50},Katana:{tags:[0,5],weight:15,price:100,ATK:45},Axe:{tags:[0,5,6],weight:18,price:100,ATK:45},Mace:{tags:[0,6],weight:16,price:100,ATK:40},Spear:{tags:[0,7],weight:20,price:100,ATK:50},Halberd:{tags:[0,
5,6,7],weight:30,price:100,ATK:50},ShortBow:{tags:[2,7],weight:18,price:100,ATK:30},LongBow:{tags:[2,7],weight:20,price:100,ATK:40},Staff:{tags:[0,6,3],weight:20,price:100,ATK:20},Wand:{tags:[3],weight:16,price:100,ATK:25},FirstAidKit:{tags:[4],weight:10,price:100,ATK:10},Buckler:{tags:[8],weight:20,price:100,ATK:10,DEF:10},RoundShield:{tags:[8],weight:25,price:100,ATK:15,DEF:15},SpikedShield:{tags:[8],weight:30,price:100,ATK:30,DEF:15},KiteShield:{tags:[8],weight:35,price:100,ATK:20,DEF:20},TowerShield:{tags:[8],
weight:40,price:100,ATK:30,DEF:20},Circlet:{tags:[9],weight:5,price:100,DEF:2},LeatherHood:{tags:[9],weight:10,price:100,DEF:4},Mask:{tags:[9],weight:15,price:100,DEF:6},Sallet:{tags:[9],weight:20,price:100,DEF:8},Bascinet:{tags:[9],weight:25,price:100,DEF:10},Helmet:{tags:[9],weight:30,price:100,DEF:12},Robe:{tags:[10],weight:20,price:100,DEF:10},LetherArmor:{tags:[10],weight:25,price:100,DEF:15},ScaleArmor:{tags:[10],weight:30,price:100,DEF:20},Chainmail:{tags:[10],weight:35,price:100,DEF:22},LamellarArmor:{tags:[10],
weight:40,price:100,DEF:25},PlateArmor:{tags:[10],weight:45,price:100,DEF:30},Gloves:{tags:[11],weight:10,price:100,DEF:4},Mittens:{tags:[11],weight:20,price:100,DEF:6},Gauntlets:{tags:[11],weight:30,price:100,DEF:8},Slippers:{tags:[12],weight:5,price:100,DEF:2},Sandals:{tags:[12],weight:10,price:100,DEF:4},Shoes:{tags:[12],weight:15,price:100,DEF:6},Boots:{tags:[12],weight:20,price:100,DEF:8},Greaves:{tags:[12],weight:25,price:100,DEF:10}},Ob={Dummy:{tags:[],usage:1,power:0,cost:999,range:0,effect:"Damage",
action:"Charge"},Swing:{tags:[0],usage:1,power:100,cost:14,range:1,effect:"Damage",action:"Charge"},Slash:{tags:[0,5],usage:1,power:110,cost:15,range:1,effect:"Damage",action:"Charge"},CutThrough:{tags:[0,5],usage:1,power:100,cost:20,range:1,effect:"Damage",action:"GoBehind"},Sweep:{tags:[0,5],usage:5,power:100,cost:20,range:1,effect:"Damage",action:"Nova"},Crash:{tags:[0,6],usage:1,power:110,cost:15,range:1,effect:"Damage",action:"Charge"},Bash:{tags:[0,6],usage:1,power:100,cost:20,range:1,effect:"Damage",
action:"Knockback"},Stab:{tags:[0,7],usage:1,power:110,cost:15,range:1,effect:"Damage",action:"Charge"},Thrust:{tags:[0,7],usage:3,power:100,cost:15,range:2,effect:"Damage",action:"Laser"},ShieldBash:{tags:[8],usage:1,power:100,cost:20,range:1,effect:"Damage",action:"Charge"},ShieldCharge:{tags:[8],usage:1,power:100,cost:24,range:1,effect:"Damage",action:"Trample"},Shoot:{tags:[2],usage:1,power:100,cost:20,range:3,effect:"Damage",action:"Shoot"},PoisonArrow:{tags:[2],usage:1,power:60,cost:20,range:3,
effect:"DamageOverTime",action:"Shoot"},IceSpear:{tags:[3,14],usage:1,power:80,cost:16,range:5,effect:"DamageHPandSP",action:"Shoot"},DrainLife:{tags:[3,16],usage:1,power:80,cost:16,range:5,effect:"Damage",action:"Drain"},FireBall:{tags:[3,13],usage:1,power:100,cost:16,range:5,effect:"Damage",action:"Explode"},LightningLaser:{tags:[3,15],usage:3,power:100,cost:16,range:5,effect:"Damage",action:"Laser"},FireNova:{tags:[3,13],usage:5,power:100,cost:16,range:2,effect:"Damage",action:"Nova"},Heal:{tags:[3,
16],usage:2,power:100,cost:24,range:3,effect:"Heal",action:"Shoot"},PartyHeal:{tags:[3,16],usage:6,power:100,cost:24,range:1,effect:"Heal",action:"Nova"},FirstAid:{tags:[4,16],usage:2,power:100,cost:24,range:1,effect:"HealOverTime",action:"Charge"},PathToWarrior:{tags:[0],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},PathToNinja:{tags:[1],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},PathToArcher:{tags:[2],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},PathToMage:{tags:[3],
usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},PathToAlchemist:{tags:[4],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},Defence:{tags:[0],usage:0,power:2,cost:10,effect:"Aura",action:"Defence"},Dodge:{tags:[1,2],usage:0,power:2,cost:10,effect:"Aura",action:"Defence"},Meditation:{tags:[3],usage:0,power:2,cost:10,effect:"Aura",action:"Defence"},Healthy:{tags:[4],usage:0,power:2,cost:10,effect:"Aura",action:"Defence"},AvatarOfFire:{tags:[13],usage:0,power:4,cost:10,effect:"Aura",action:"Offence"},
AvatarOfCold:{tags:[14],usage:0,power:4,cost:10,effect:"Aura",action:"Offence"},AvatarOfLightning:{tags:[15],usage:0,power:4,cost:10,effect:"Aura",action:"Offence"},ResistFire:{tags:[13],usage:0,power:4,cost:10,effect:"Aura",action:"Defence"},ResistCold:{tags:[14],usage:0,power:4,cost:10,effect:"Aura",action:"Defence"},ResistLightning:{tags:[15],usage:0,power:4,cost:10,effect:"Aura",action:"Defence"}},Na,Pb=ya([0,1,2,3,4,5,6,7]),Qb=ya([8,9,10,11,12]),Aa=function(){function a(b){this.EID=b;this.def=
Nb[b];if(null==this.def)throw new RangeError('Enchantment not found: "'+b+'"');this.name=a.nameOf(b);this.spec=a.specOf(b);this.value=this.def.min+Ea(this.def.max-this.def.min)}a.prototype.qualify=function(a){return Ga(this.name.localized,a)};a.prototype.modify=function(a){this.def.ATK&&(a=this.def.ATK(this.value,a));return a};a.nameOf=function(a){return h("Enchant",a,"Name")};a.specOf=function(a){return h("Enchant",a,"Spec")};a.from=function(b){return new a(b)};a.fromJSON=function(b){return new a(b.EID)};
a.prototype.toJSON=function(){return{EID:this.EID,value:this.value}};return a}(),ba=function(){function a(b,d){this.IID=b;this.enchants=d;this.def=W[b];if(null==this.def)throw new RangeError('Item not found: "'+b+'"');this.baseName=a.nameOf(b);this.spec=a.specOf(b);this.tagbits=ya(this.def.tags);null==this.enchants&&(this.enchants=(this.def.enchants||[]).map(Aa.from))}Object.defineProperty(a.prototype,"name",{get:function(){for(var a=this.baseName.localized,d=0,e=this.enchants;d<e.length;d++)a=e[d].qualify(a);
return a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"tags",{get:function(){return this.def.tags},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"weight",{get:function(){return this.def.weight},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"priceToSell",{get:function(){for(var a=this.def.price,d=0,e=this.enchants;d<e.length;d++)a=e[d].modify(a);return r(a)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ATK",{get:function(){for(var a=
this.def.ATK||0,d=0,e=this.enchants;d<e.length;d++)a=e[d].modify(a);return a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){for(var a=this.def.DEF||0,d=0,e=this.enchants;d<e.length;d++)a=e[d].modify(a);return a},enumerable:!0,configurable:!0});a.nameOf=function(a){return h("Item",a,"Name")};a.specOf=function(a){return h("Item",a,"Spec")};a.from=function(b){return new a(b)};a.fromJSON=function(b){return new a(b.IID,O(Aa,b.enchants))};a.prototype.toJSON=function(){return{IID:this.IID,
enchants:pa(this.enchants)}};return a}(),hb=function(){function a(b){this.SID=b;this.def=Ob[b];if(null==this.def)throw new RangeError('Skill not found: "'+b+'"');this.name=a.nameOf(b);this.spec=a.specOf(b);this.tagbits=ya(this.def.tags)}Object.defineProperty(a.prototype,"tags",{get:function(){return this.def.tags},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"rawCost",{get:function(){return this.def.cost},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"rawRange",
{get:function(){return this.def.range},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"rawPower",{get:function(){return this.def.power},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"target",{get:function(){return this.def.usage},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"hostile",{get:function(){var a;a:switch(this.def.usage){case 2:case 4:case 6:a=!1;break a;default:a=!0}return a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"effect",{get:function(){return this.def.effect},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"action",{get:function(){return this.def.action},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"isActive",{get:function(){return"Aura"!==this.effect},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"isPassive",{get:function(){return"Aura"===this.effect},enumerable:!0,configurable:!0});a.prototype.match=function(a){var d=this.tagbits&Pb;return(d&a.tagbits)===
d};a.nameOf=function(a){return h("Skill",a,"Name")};a.specOf=function(a){return h("Skill",a,"Spec")};a.from=function(b){return new a(b)};a.fromJSON=function(b){return new a(b.SID)};a.prototype.toJSON=function(){return{SID:this.SID}};a.DUMMY=new a("Dummy");return a}(),Ab=[1,2,3,4,5,5,5,5,4,3,2,1],Ya;(function(a){a[a.DEFAULT=0]="DEFAULT";a[a.BLINK_1=1]="BLINK_1";a[a.BLINK_2=2]="BLINK_2";a[a.BLINK_3=3]="BLINK_3";a[a.BLINK_4=4]="BLINK_4";a[a.CLOSED=5]="CLOSED"})(Ya||(Ya={}));var Y=function(){function a(a,
d,e,c,f,g,h,k,l){this.name=a;this.level=d;this.INT=e;this.DEX=c;this.STR=f;this.equipments=g;this.skills=h;this.known=k;this.src=l;var r=[];a=0>l.indexOf("/")?"assets/char/"+l:l;if(l.endsWith(".png"))l=new H(a),r[0]=l;else{var q=function(){for(var a=[],b=0;b<arguments.length;b++)a[b-0]=arguments[b];if(0>=a.length)return null;var b=a[0],c=b.w,d=b.h,b=document.createElement("canvas");b.width=c;b.height=d;for(var e=b.getContext("2d"),c={x:0,y:0,w:c,h:d},d=0;d<a.length;d++)a[d].draw(e,null,c);return H.from(b)},
v=[new H(a+"/back.png"),new H(a+"/eye.png"),new H(a+"/eye1.png"),new H(a+"/eye2.png"),new H(a+"/eye3.png"),new H(a+"/eye4.png"),new H(a+"/eye5.png"),new H(a+"/fore.png")];ta(v).then(function(){return r.push(q(v[0],v[1],v[7]),q(v[0],v[2],v[7]),q(v[0],v[3],v[7]),q(v[0],v[4],v[7]),q(v[0],v[5],v[7]),q(v[0],v[6],v[7]))})}this.images=r;this.blinkCycle=4500+100*e;this.blinkOffset=Ea(this.blinkCycle)}Object.defineProperty(a.prototype,"w",{get:function(){var a=this.images[0];return a?a.w:1},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"h",{get:function(){var a=this.images[0];return a?a.h:1},enumerable:!0,configurable:!0});a.prototype.draw=function(a,d,e,c,h){var g;g=(d+this.blinkOffset)%this.blinkCycle;g=450>g?Ab[r(g/450*Ab.length)]:0;var k=this.images;(g=k[g]||k[Ya.DEFAULT])&&g.draw(a,d,e,c,h)};Object.defineProperty(a.prototype,"HP",{get:function(){return 10*(3+this.STR)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"SP",{get:function(){var a=T(0,this.weight-
this.maxWeight);return T(0,4*(3+this.STR)-a)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"reservedSP",{get:function(){var a=this;return this.skills.reduce(function(d,e){return d+(e.isPassive?a.costOf(e):0)},0)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"step",{get:function(){return 13-this.DEX},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ZoC",{get:function(){return 3+this.DEX},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"maxWeight",{get:function(){return 10*(3+this.STR)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"weight",{get:function(){return this.equipments.reduce(function(a,d){return a+d.weight},0)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){return 100*(1-this.equipments.reduce(function(a,d){return a*(1-d.DEF/100)},1))},enumerable:!0,configurable:!0});a.prototype.costOf=function(a){return null==a?void 0:a.rawCost-this.INT};a.prototype.rangeOf=
function(a){return null==a?void 0:a.rawRange};a.prototype.powerOf=function(a){var d=this.itemFor(a);return d?d.ATK*a.rawPower/100:void 0};a.prototype.itemFor=function(a){var d=void 0;if(a)for(var e=0,c=0,h=this.equipments;c<h.length;c++){var g=h[c];if(a.match(g)){var k=g.ATK;e<k&&(e=k,d=g)}}return d};a.adventurer=function(b){var d=Mb[b];if(null==d)throw new RangeError('Adventurer not found: "'+b+'"');return a.from(h("Adventurer",b),0,d)};a.monster=function(b,d){var e=zb[b];if(null==e)throw new RangeError('Monster not found: "'+
b+'"');return a.from(h("Monster",b),d,e)};a.from=function(b,d,e){return new a(b.localized,d,e.INT,e.DEX,e.STR,e.equipments.map(ba.from),e.skills.map(hb.from),[],e.image)};a.fromJSON=function(b){return new a(b.name,b.level||0,b.INT,b.DEX,b.STR,O(ba,b.equipments),O(hb,b.skills),O(hb,b.known),b.image)};a.prototype.toJSON=function(){return{name:this.name,level:this.level,INT:this.INT,DEX:this.DEX,STR:this.STR,equipments:pa(this.equipments),skills:pa(this.skills),known:pa(this.known),image:this.src}};
return a}(),Ba;(function(a){var b=function(a){function b(){var c=this;a.call(this);(new G(0,0,1280,720,new H("assets/scene/title.jpg"))).attach(this);var f=Ra(),g=function(a){(new da(c,new Za.Home(a))).attach(c.parent)},k,l;f?(k=h("Title","Continue"),l=function(){return g(f)},(new I(1070,650,200,60,new A(h("Title","Delete")),function(){Oa.confirm(c,h("Title","ConfirmDelete"),{label:h("Title","Delete"),click:function(){try{System.setRoamingStorage("NYO",null)}catch(a){E.error(a)}(new da(c,new b)).attach(c.parent);
E.log(h("Title","NotifyDelete"))},mnemonic:qb},{label:h("Config","Cancel"),mnemonic:rb})})).attach(this)):(k=h("Title","New"),l=function(){var a={},b;for(b in W){var c=Ea(4);0<c&&(a[b]=c)}a={shop:a,warehouse:[],reservers:[],party:[Y.adventurer("Knight"),Y.adventurer("Warrior"),Y.adventurer("Samurai"),Y.adventurer("Mage"),Y.adventurer("Healer"),Y.adventurer("Thief")],gold:1E3};a.party[0].equipments[0].enchants.push(Aa.from("AddedFire"));Ta(a);g(a)});(new I(480,504,320,72,new A(k),l,Lb)).attach(this);
(new I(480,612,320,72,new A(h("Title","Quit")),System.exit)).attach(this);mb(this)}x(b,a);return b}(Q);a.Scene=b})(Ba||(Ba={}));var Za;(function(a){function b(){return[{name:h("Character","Name"),extract:function(a){return a.name},width:200},{name:h("Character","INT"),extract:function(a){return a.INT},width:60,align:"right"},{name:h("Character","DEX"),extract:function(a){return a.DEX},width:60,align:"right"},{name:h("Character","STR"),extract:function(a){return a.STR},width:60,align:"right"}]}function d(a){return[{name:a,
extract:function(a){return a.name},width:200},{name:h("Town","Tags"),extract:function(a){return db(a.tags)}},{name:h("Town","Weight"),extract:function(a){return a.weight},width:60,align:"right"},{name:h("Town","ATK"),extract:function(a){return a.ATK},width:60,align:"right"},{name:h("Town","DEF"),extract:function(a){return a.DEF},width:60,align:"right"}]}function e(a,b){var c=b.shop,e=d(a);e.push({name:h("Town","Stock"),extract:function(a){return oa(c[a.IID],h("Town","New"))},width:60,align:"right"});
return e}function c(a,b){var c=b.shop,d=b.warehouse;return[{name:a,extract:function(a){return ba.nameOf(a)},width:200},{name:h("Town","Tags"),extract:function(a){return db(W[a].tags)}},{name:h("Town","ATK"),extract:function(a){return W[a].ATK},width:60,align:"right"},{name:h("Town","DEF"),extract:function(a){return W[a].DEF},width:60,align:"right"},{name:h("Town","Weight"),extract:function(a){return W[a].weight},width:60,align:"right"},{name:h("Town","Stock"),extract:function(a){return c[a]},width:60,
align:"right"},{name:h("Town","Owned"),extract:function(a){return d.reduce(function(b,c){return c.IID===a?b+1:b},0)},width:60,align:"right"}]}function f(a){return[{name:a,extract:function(a){return a.name.localized},width:200},{name:h("Town","Required"),extract:function(a){return db(a.tags)}},{name:h("Town","Cost"),extract:function(a){return a.rawCost},width:60,align:"right"},{name:h("Town","Range"),extract:function(a){return a.rawRange},width:60,align:"right"},{name:h("Town","Power"),extract:function(a){return a.rawPower},
width:60,align:"right"},{name:h("Town","Spec"),extract:function(a){return a.spec.localized}}]}var g={fontSize:64,fillStyle:k(255,255,255),strokeStyle:k(0,0,0),textAlign:"center",textBaseline:"middle",lineWidth:2},t=function(){function a(b,c){this.party=b;this.index=c}a.prototype.draw=function(a,b,c){var d=c.x,e=c.y,h=c.w;c=c.h;var f=this.party[this.index];a.save();if(f){var l=Ja(f,140,184);f.draw(a,b,{x:d+h/2-l.w/2,y:e+92-l.h/2,w:l.w,h:l.h});var p=this.party.reduce(function(a,b){return b?T(a,b.HP):
a},1);b=f.HP;var l=d+10,q=h-20,r=e+c-30,p=(q-2)*b/p;a.strokeStyle="black";a.fillStyle=pb.full;a.fillRect(l,r,p,6);a.strokeRect(l,r,p,6);wa(a,b.toString(),l+4,r-20,q,20,{fontSize:20,fillStyle:k(255,255,255),strokeStyle:k(0,0,0),textAlign:"left",textBaseline:"bottom",lineWidth:2});wa(a,f.name,d,e+c-24,h,24,{fontSize:24,fillStyle:k(255,255,255),strokeStyle:k(0,0,0),textAlign:"center",textBaseline:"bottom",lineWidth:2})}else wa(a,(this.index+1).toString(),d,e,h,c,g);a.restore()};return a}(),p=function(a){function b(c){a.call(this);
this.data=c}x(b,a);b.prototype.addButton=function(a,b,c,d){a=new I(1280-170*a,665,160,45,new A(c),d,b);a.attach(this);return a};b.prototype.goTo=function(a){(new da(this,new a(this.data))).attach(this.parent)};return b}(Q),w=function(a){function b(c,d){a.call(this,c);(new G(0,0,1280,720,new H("assets/scene/"+d))).attach(this);mb(this);for(var e=c.party,h=this,f=[],g=0;6>g;++g){var k=r(g/3);(new Jb(10+170*(1-k),10+g%3*214+68*k,160,204,f,new t(e,g),function(){h.onPortraitClick(this.drawable.index)},
function(a){var b=this.drawable;a=a.drawable;c=[e[a.index],e[b.index]];e[b.index]=c[0];e[a.index]=c[1];c=[a.index,b.index];b.index=c[0];a.index=c[1];var c},[l.$1+g])).attach(this)}}x(b,a);return b}(p),F=function(a){function b(c){var d=this;a.call(this,c,"town.jpg");var e=["grass","moss"],g=Ea(e.length);this.addSpot(5,l.A,"Guild",function(){}).enabled=!1;this.addSpot(4,l.B,"Tavern",function(){return d.goTo(q)});this.addSpot(3,l.C,"Shop",function(){return d.goTo(v)});this.addSpot(2,l.D,"Smith",function(){}).enabled=
!1;this.addSpot(1,l.E,"Dungeon",function(){(new da(d,new Ca.Scene(c,new Ca.EndressStage(e[g],0)))).attach(d.parent)}).enabled=c.party.some(function(a){return null!=a});this.addButton(2,[l.L],h("Town","Load"),function(){Oa.confirm(d,h("Town","ConfirmLoad"),{label:h("Town","Load"),click:function(){var a=Ra();a&&((new da(d,new b(a))).attach(d.parent),E.log(h("Town","NotifyLoad")))},mnemonic:qb},{label:h("Config","Cancel"),mnemonic:rb})});this.addButton(1,[l.S],h("Town","Save"),function(){Ta(d.data);
E.log(h("Town","NotifySave"))})}x(b,a);b.prototype.onPortraitClick=function(a){(a=this.data.party[a])&&(new da(this,new J(this.data,a))).attach(this.parent)};b.prototype.addSpot=function(a,b,c,d){a=new I(950,665-100*a,320,90,new A(h("Town",c)),d,[b]);a.attach(this);return a};return b}(w);a.Home=F;var q=function(a){function c(d){function e(a,b){(c=Array.prototype.splice).call.apply(c,[a,0,a.length].concat(b));var c}var g=this;a.call(this,d,"tavern.jpg");var f=d.party.concat(),k=d.reservers.concat();
this.addButton(3,[l.C],h("Town","Clear"),function(){for(var a=0;6>a;++a){var b=d.party[a];b&&(d.reservers.push(b),d.party[a]=null)}});this.addButton(2,[l.R],h("Town","Revert"),function(){e(d.party,f);e(d.reservers,k)});this.addButton(1,[l.TAB,l.DELETE],h("Town","Back"),function(){return g.goTo(F)});(new B(350,10,920,B.heightOf(10),b(),d.reservers,function(a,b){return g.onReserverClick(a,b)})).attach(this)}x(c,a);c.prototype.onPortraitClick=function(a){var b=this.data.party[a];b&&(this.data.party[a]=
null,this.data.reservers.push(b))};c.prototype.onReserverClick=function(a,b){for(var c=0;6>c;++c)if(null==this.data.party[c]){this.data.party[c]=a;this.data.reservers.splice(b,1);return}E.error(h("Town","PartyFull"))};return c}(w),v=function(a){function b(d){var g=this;a.call(this,d,"shop.jpg");var f=d.shop,k=d.warehouse,p=new B(350,10,920,B.heightOf(10),c(h("Town","Buy"),d),Ia(f),function(a){if(0>=f[a])E.error(h("Town","SoldOut"));else{var b=W[a].price;if(d.gold<b)E.error(h("Town","NoMoney"));else{var c=
new ba(a);--f[a];k.push(c);d.gold-=b;E.log(Ga(h("Town","NotifyBuy").localized,c.name,b))}}});p.attach(this);var r=new B(350,10,920,B.heightOf(10),e(h("Town","Sell"),d),k,function(a,b){var c=a.IID,e=a.priceToSell;k.splice(b,1);var g=f[c];null==g?(f[c]=1,p.rows.push(c)):f[c]=1+g;d.gold+=e;E.log(Ga(h("Town","NotifySell").localized,a.name,e))});r.attach(this);var q,t;q=this.addButton(3,[l.B],h("Town","Buy"),function(){p.visible=!0;r.visible=!1;q.enabled=!1;t.enabled=!0});t=this.addButton(2,[l.S],h("Town",
"Sell"),function(){p.visible=!1;r.visible=!0;q.enabled=!0;t.enabled=!1});this.addButton(1,[l.TAB,l.DELETE],h("Town","Back"),function(){return g.goTo(F)});q.click()}x(b,a);b.prototype.onPortraitClick=function(a){E.log("TODO: Shop.onPortraitClick: "+a)};return b}(w),J=function(a){function b(c,e){var g=this;a.call(this,c);var k=c.warehouse,p=Ja(e,1280,720,!0);(new G(0,0,p.w,p.h,e)).attach(this);(new G(0,0,200,40,new A(e.name+" / Lv: "+e.level))).attach(this);(new G(0,40,200,40,new A("INT: "+e.INT))).attach(this);
(new G(100,40,200,40,new A("DEX: "+e.DEX))).attach(this);(new G(200,40,200,40,new A("STR: "+e.STR))).attach(this);(new G(0,80,200,40,new A(function(){return"HP: "+e.HP}))).attach(this);(new G(0,120,200,40,new A(function(){return"SP: "+e.SP}))).attach(this);(new G(0,160,200,40,new A(function(){return"WT: "+e.weight+"/"+e.maxWeight}))).attach(this);(new G(0,200,200,40,new A(function(){return"DEF: "+e.DEF.toFixed(1)}))).attach(this);var q=new Q([new B(350,10,920,B.heightOf(10),d(h("Town","Equipments")),
e.equipments,function(a,b){e.equipments.splice(b,1);k.push(a)}),new B(350,360,920,B.heightOf(10),d(h("Town","Warehouse")),k,function(a,b){k.splice(b,1);var c=e.equipments,d=a.tagbits,g=[],d=d&Qb;if(0!==d)for(var f=0;f<c.length;)0!==(c[f].tagbits&d)?(g.push(c[f]),c.splice(f,1)):++f;e.equipments.push(a);(h=k.push).call.apply(h,[k].concat(g));var h})]);q.attach(this);var r=new Q([new B(350,10,920,B.heightOf(10),f(h("Town","Skills")),e.skills,function(a,b){e.skills.splice(b,1);e.known.push(a)}),new B(350,
360,920,B.heightOf(10),f(h("Town","Knowns")),e.known,function(a,b){e.known.splice(b,1);e.skills.push(a)})]);r.attach(this);var t,v;t=this.addButton(3,[l.E],h("Town","Equipments"),function(){q.visible=!0;r.visible=!1;v.enabled=!0;t.enabled=!1});v=this.addButton(2,[l.S],h("Town","Skills"),function(){q.visible=!1;r.visible=!0;v.enabled=!1;t.enabled=!0});this.addButton(1,[l.TAB,l.DELETE],h("Town","Back"),function(){return g.goTo(F)});t.click()}x(b,a);return b}(p)})(Za||(Za={}));var Ca;(function(a){function b(a,
b){var m=a.xH;return{xH:m+[1,2,1,-1,-2,-1][b],yH:a.yH+(0===m%2?[-1,0,0,0,0,-1]:[0,0,1,1,0,0])[b]}}function d(a,b){var m=a.xH,c=b.xH,n=c-m,m=2*b.yH+c%2-(2*a.yH+m%2);return 0>m?m>n?(-n-m)/2:m>-n?(n-m)/2:-m:m<n?(n+m)/2:m<-n?(-n+m)/2:m}function e(a,b){return a===b||!!a&&!!b&&a.xH===b.xH&&a.yH===b.yH}function c(a,b,m,c,n,d,e,g,f){var h=fa(0,1,d/e);d=null==g?h:fa(0,1,(d+g)/e);a.save();a.fillStyle=f.bkgnd;a.fillRect(b,m,c,n);b+=1;m+=1;c-=2;n-=2;d>h?(a.fillStyle=1<=h?f.full:f.normal,a.fillRect(b,m,c*h-1,
n),a.fillStyle=f.full,a.fillRect(b+c*h,m,c*(d-h),n)):d<h?(e=c*d,0<d&&(e=T(e,2),a.fillStyle=1<=h?f.full:f.normal,a.fillRect(b,m,e-1,n)),a.fillStyle=f.delta,a.fillRect(b+e,m,c*(h-d),n)):(a.fillStyle=1<=h?f.full:f.normal,a.fillRect(b,m,c*h,n));a.restore()}function f(a,b,m,z,n){b=m.toX(n)+16;m=m.toY(n)+60;c(a,b,m,96,6,z.HP,z.maxHP,null,pb)}function g(a,b,m,z,n,d){b=m.toX(n)+16;m=m.toY(n)+60+6;c(a,b,m,96,6,z.SP,z.maxSP,d-z.SP,yb)}function B(a,b,m,c){a=m.tagbits;m=b.powerOf(m);b=b.level+b.getOffencePassive(a)-
c.level-c.getDefencePassive(a);return Ua(m*(100-c.DEF)/100*ja(S,b))}function p(a,b,m){var c=m.tagbits;m=b.powerOf(m);a=b.level+b.getOffencePassive(c)-a.level;return Ua(m*ja(S,a))}function K(a){var b=a.tagbits;return 0!==(b&8192)?{r:255,g:128,b:0}:0!==(b&16384)?{r:0,g:128,b:255}:0!==(b&32768)?{r:255,g:255,b:0}:0!==(b&65536)?a.hostile?{r:255,g:0,b:128}:{r:0,g:255,b:128}:{r:255,g:255,b:255}}function O(a,b,m){var c=void 0,n=d(b,m)+1;a.straight(b,m,n,function(b,m){m===n&&a.get(b).empty&&(c=b)});return c}
function q(a,b,m){var c=b.estimate(a,m),n=a.promiseEffect(m,c);m=new Pa(a,b.hex,m.hex);b.state=m;m.hit(function(){return n.attach(a)});return t.wait.POPUP?ta([n,m]):m}function v(a,b,m,c){c=K(c);var n=Ma(c),d=Ma(c,0);c=a.toX(b)-a.toX(m);var e=a.toY(b)-a.toY(m);c=100+ja(c*c+e*e,.5)/1280*400;c=new F(c,function(c,z){var e=a.toX(b),f=a.toY(b),h=a.toX(m),g=a.toY(m);cb(z,e*(1-c)+h*c+64-20,f*(1-c)+g*c+40-20,40,40,n,d,.5)});c.attach(a);return c}function W(a,b,m,c,n){function d(m,c){var z=e.get(m).unit;if(b.isTarget(z)){var h=
b.estimate(a,z);n&&(h.deltaHP=n(h.deltaHP,c));z=a.promiseEffect(z,h);z.attach(a);f.push(z)}}var e=a.field,f=[];d(m,0);e.surround(m,c,d);var h=K(b.skill),g=Ma(h,0),k=new F(400,function(b,n){var d=a.toX(m)+64,e=a.toY(m)+40,y=128*c*b,f=80*c*b,ib=Ma(h,1-b);cb(n,d-y,e-f,2*y,2*f,ib,g,b)});k.attach(a);return t.wait.POPUP?(f.push(k),ta(f)):k}var S=ja(2,.1),M=[{lineWidth:2,fillStyle:k(0,0,68),strokeStyle:k(204,204,255)},{lineWidth:2,fillStyle:k(68,0,0),strokeStyle:k(255,204,204)}],ga={fillStyle:"white",textAlign:"left",
textBaseline:"top"},P=w(0,0,0,0),ba=w(0,0,0,.75),ia={inner:k(230,255,180),outer:k(51,230,51)},pa={inner:k(230,180,255),outer:k(51,51,230)},za={inner:k(255,180,230),outer:k(230,51,51)},ma={inner:k(230,180,255),outer:k(51,51,230)},Wa={outer:k(64,192,255),inner:k(180,232,255),bkgnd:w(64,192,255,.3)},ra={outer:k(255,192,64),inner:k(255,232,192),bkgnd:w(255,192,64,.3)},ua={DASH_OR_RANGE:{outer:k(255,64,64),inner:k(255,180,180),bkgnd:w(255,192,64,.3)},RANGE:{outer:k(255,64,64),inner:k(255,180,180),bkgnd:w(255,
128,64,.3)},TARGET:{outer:k(255,24,24),inner:k(255,64,64),bkgnd:w(255,24,24,.3)}},xa={DASH_OR_RANGE:{outer:k(24,24,255),inner:k(180,180,255),bkgnd:w(255,192,64,.3)},RANGE:{outer:k(64,64,255),inner:k(180,180,255),bkgnd:w(24,128,255,.3)},TARGET:{outer:k(24,24,255),inner:k(64,64,255),bkgnd:w(24,24,255,.3)}},ya=w(0,0,0,.65),Ca=w(0,0,0,0),Fa={textAlign:"center",textBaseline:"bottom",fontSize:32,fillStyle:"yellow",strokeStyle:"black",lineWidth:2},Ga={textAlign:"center",textBaseline:"bottom",fontSize:32,
fillStyle:"red",strokeStyle:"black",lineWidth:2},va=w(255,0,0,.8),Na=k(255,180,180),Qa=k(180,255,180),Xa=[{messageID:"PartyTurn",innerStyle:k(0,0,128),outerStyle:w(0,0,128,0),textStyle:{fontSize:64,fillStyle:"white",textAlign:"center",textBaseline:"middle"}},{messageID:"EnemyTurn",innerStyle:k(128,0,0),outerStyle:w(128,0,0,0),textStyle:{fontSize:64,fillStyle:"white",textAlign:"center",textBaseline:"middle"}}],Aa,Ba,$a=function(){function a(b,m){this.dummy=m;this.cells={};this.depth=r(b)}Object.defineProperty(a.prototype,
"minXH",{get:function(){return 1+Ua(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxXH",{get:function(){return 20+r(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"minVisibleXH",{get:function(){return r(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxVisibleXH",{get:function(){return 21+Ua(this.depth)},enumerable:!0,configurable:!0});a.prototype.contains=function(a,b){if(null==a)return!1;var c;null==
b?(n=a,c=n.xH,b=n.yH,n):c=a;return 0<=b&&3>b&&this.minXH<=c&&c<this.maxXH;var n};a.prototype.getLine=function(a){return this.cells[a]};a.prototype.setLine=function(a,b){this.cells[a]=b};a.prototype.deleteLine=function(a){delete this.cells[a]};a.prototype.rawget=function(a,b){var c;null==b?(n=a,c=n.xH,b=n.yH,n):c=a;if(0<=b&&3>b&&this.minVisibleXH<=c&&c<this.maxVisibleXH&&(c=this.cells[c]))return c[b];return;var n};a.prototype.get=function(a,b){var c;null==b?(n=a,c=n.xH,b=n.yH,n):c=a;return oa(this.rawget(c,
b),this.dummy);var n};a.prototype.set=function(a,b,c){null==c&&(n=b,b=n.xH,c=n.yH,n);n=this.cells[b];null==n&&(n=this.cells[b]=[]);n[c]=a;var n};a.prototype.each=function(a){for(var b=this.maxXH,c=this.minXH;c<b;++c)for(var n=0;3>n;++n)a.call(this,this.get(c,n),c,n)};a.prototype.eachVisible=function(a){for(var b=this.maxVisibleXH,c=this.minVisibleXH;c<b;++c)for(var n=0;3>n;++n)a.call(this,this.get(c,n),c,n)};a.prototype.straight=function(a,b,c,n){if(!e(a,b)){var f=a.xH,h=1+2*(2*a.yH+a.xH%2),g=b.xH,
C=1+2*(2*b.yH+b.xH%2);a=d(a,b);g=(g-f)/a;C=(C-h)/a;for(a=1;a<=c;++a){var u=f+a*g;b=r((h+a*C)/2);u=0===b%2?2*r((u+1)/2):2*r(u/2)+1;b=r(b/2);this.contains(u,b)&&n({xH:u,yH:b},a)}}};a.prototype.surround=function(a,c,d){if(1===c)for(var n=0;6>n;++n){var e=b(a,n);this.contains(e)&&d(e,1)}else if(1<c){a=b(a,0);for(var f=1;f<=c;++f){for(var e=a,h=0,g=[2,3,4,5,0,1];h<g.length;h++)for(var n=g[h],C=0;C<f;++C,e=b(e,n))this.contains(e)&&d(e,f);a=b(a,0)}}};return a}(),ea=function(){function a(b){this.duration=
b}a.prototype.then=function(a){null==this.duration?J.then(a):this.sig=ha(this.sig,a);return this};a.prototype.commit=function(){aa(this.sig);this.duration=this.sig=void 0};a.prototype.getXY=function(a,b,c){if(null!=this.duration)if(c=F.clamp(c,this.start,this.duration),1<=c)this.commit();else return this.onGetXY(a,b,c)};a.prototype.drawCharacter=function(a,b,c,n,d,e,f){a.drawCharacter(b,c,n,d,e,f)};return a}(),Ha=function(a){function b(c){a.call(this,400*(13-c)/4)}x(b,a);b.prototype.onGetXY=function(a,
b,c){a=a.hex;return{x:b.toX(a)-128*(1-c)+64,y:b.toY(a)+80}};return b}(ea),Da=function(a){function b(c){a.call(this,100*ja(c.length-1,.75));this.path=c}x(b,a);b.prototype.onGetXY=function(a,b,c){var d=this.path.length-1,e=r(d*c),f=this.path[e],h=this.path[e+1];a=b.toX(f);var f=b.toY(f),g=b.toX(h);b=b.toY(h);c=d*c-e;return{x:a*(1-c)+g*c+64,y:f*(1-c)+b*c+80}};return b}(ea),Pa=function(a){function b(c,d,n){a.call(this,function(a,b,c){var m=a.toX(b)-a.toX(c);a=a.toY(b)-a.toY(c);return 200+ja(m*m+a*a,.3)/
1280*1E3}(c,d,n));this.hexFrom=d;this.hexTo=n}x(b,a);b.prototype.hit=function(a){null==this.duration?J.then(a):this.hitsig=ha(this.hitsig,a)};b.prototype.commit=function(){aa(this.hitsig);this.hitsig=void 0;a.prototype.commit.call(this)};b.prototype.onGetXY=function(a,b,c){var d=this.hexFrom,e=this.hexTo;a=b.toX(d);var d=b.toY(d),f=b.toX(e);b=b.toY(e);.5>c?c*=2:(c=2-2*c,aa(this.hitsig),this.hitsig=null);return{x:a*(1-c)+f*c+64,y:d*(1-c)+b*c+80}};return b}(ea),Ra=function(a){function b(c,d){a.call(this,
500);var n=c.HP;this.dying=d>=n?c.hex:null;this.radius=d>=n/2?1:.5+d/n}x(b,a);b.prototype.onGetXY=function(a,b,c){var d=20*(1-c)*this.radius;c=c*V*this.duration/250*this.radius;a=this.dying||a.hex;return{x:d*U(4*c)+b.toX(a)+64,y:d*U(3*c)+b.toY(a)+80}};b.prototype.drawCharacter=function(b,c,d,e,f,h,g){this.dying?(h=F.clamp(d,this.start,this.duration),c.save(),c.globalAlpha=1-h,a.prototype.drawCharacter.call(this,b,c,d,e,f,"red",h),c.restore()):a.prototype.drawCharacter.call(this,b,c,d,e,f,h,g)};return b}(ea),
sb=function(){function a(b,c,d){this.ch=b;this.team=c;this.hex=d;this.idleOffset=ab();this.skill=b.skills.find(function(a){return 0<b.rangeOf(a)})||hb.DUMMY;this.HP=this.maxHP;this.minCost=this.SP=this.availSP;c=0;for(d=b.skills;c<d.length;c++){var e=d[c];e.isActive&&(e=this.costOf(e),e<this.minCost&&(this.minCost=e))}this.effectsOverTime=[]}Object.defineProperty(a.prototype,"name",{get:function(){return this.ch.name},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"level",{get:function(){return this.ch.level},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"INT",{get:function(){return this.ch.INT},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEX",{get:function(){return this.ch.DEX},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"STR",{get:function(){return this.ch.STR},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxHP",{get:function(){return this.ch.HP},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxSP",
{get:function(){return this.ch.SP},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"availSP",{get:function(){return T(0,this.ch.SP-this.ch.reservedSP)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"step",{get:function(){return this.ch.step},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ZoC",{get:function(){return this.ch.ZoC},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){return this.ch.DEF},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"skills",{get:function(){return this.ch.skills},enumerable:!0,configurable:!0});a.prototype.costOf=function(a){return this.ch.costOf(a)};a.prototype.rangeOf=function(a){return this.ch.rangeOf(a)};a.prototype.powerOf=function(a){return this.ch.powerOf(a)};Object.defineProperty(a.prototype,"cost",{get:function(){return this.costOf(this.skill)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"range",{get:function(){return this.rangeOf(this.skill)},
enumerable:!0,configurable:!0});a.prototype.getPassive=function(a,b){for(var c=0,d=0,e=this.ch.skills;d<e.length;d++){var f=e[d];f.isPassive&&f.action===b&&0!==(a&f.tagbits)&&(c+=f.rawPower)}return c};a.prototype.getOffencePassive=function(a){return this.getPassive(a,"Offence")};a.prototype.getDefencePassive=function(a){return this.getPassive(a,"Defence")};a.prototype.isEnemy=function(a){return null!=a&&this.team!==a.team};a.prototype.isTarget=function(a){return null==a?!1:this.skill.hostile?this.isEnemy(a):
this!==a&&!this.isEnemy(a)};a.prototype.done=function(a){a=a.zoc;if(!a)return!1;var b=this.hex;return!!b&&this.SP<this.minCost&&this.SP<this.step+a[this.team].get(b)};a.prototype.estimate=function(a,b){this.isTarget(b);var c=this.skill.effect,d=Aa[c];if(null==d)throw new RangeError('Effect not found: "'+c+'"');return d(a,this,b)};a.prototype.shoot=function(a,b){this.isTarget(b);var c=this.skill.action,d=Ba[c];if(null==d)throw new RangeError('Action not found: "'+c+'"');c=d(a,this,b);this.SP-=this.cost;
return c};a.prototype.onTurnEnd=function(a){this.team===a.team&&(this.SP=this.availSP)};a.prototype.onTurnStart=function(a){if(this.team===a.team){for(var b=0,c=this.effectsOverTime,d=c.length-1;0<=d;--d){var e=c[d];null!=e.deltaHPoT&&(b+=e.deltaHPoT);0>=--e.duration&&c.splice(d,1)}if(0!==b)return b=a.promiseEffect(this,{deltaHP:b}),b.attach(a),b}return null};a.prototype.getXY=function(a,b){var c;this.state&&(c=this.state.getXY(this,a,b),null==c&&(this.state=null));if(null==c){var d=this.hex;d&&(c=
{x:a.toX(d)+64,y:a.toY(d)+80})}return c};Object.defineProperty(a.prototype,"state",{get:function(){return this._state},set:function(a){var b=this._state;if(this._state=a)a.start=performance.now();b&&b.commit()},enumerable:!0,configurable:!0});a.prototype.drawCharacter=function(a,b,c,d,e,f){var h=this.ch,g=Ja(h,128,128),u=g.w,k=.2*u;cb(a,c-u/2,d-10-k/2,u,k,ya,Ca,.75);b&&(u=200*(13-h.DEX),u=T(0,U(2*V*(this.idleOffset+b%u/u))),d-=16*u+10*(1-u));g.x=c-g.w/2;g.y=d-g.h;h.draw(a,b,g,e,f)};a.prototype.draw=
function(a,b,c,d,e,f){this.state?this.state.drawCharacter(this,a,b,c,d,e,f):this.drawCharacter(a,b,c,d,e,f)};a.prototype.drawBars=function(a,b,d,e,f){var h=this.hex;b=d.toX(h)+16;d=d.toY(h)+60;c(a,b,d,96,6,this.HP,this.maxHP,e,pb);c(a,b,d+6,96,6,this.SP,this.maxSP,f,yb)};a.compare=function(a,b){return a.y<b.y?-1:a.y>b.y?1:a.x<b.x?-1:a.x>b.x?1:0};return a}(),Sa=function(){function a(b,c){void 0===b&&(b=0);this.type=b;this.unit=c}Object.defineProperty(a.prototype,"empty",{get:function(){return null==
this.unit&&0===this.type},enumerable:!0,configurable:!0});a.DUMMY=new a(1);return a}(),Ta=function(a){function c(d,f,n){function h(a,b,c,d){var m=this,f=b.range;if(1<=f){var n=b.hex,g=a.field,z=a.numScrollsPerTurn,k=this.get(d).SP,u=c.get(d),y=ob(2*d.yH+d.xH%2-3),ib=g.minXH+z,Bb=d.xH<ib,l=function(a){var b=m.get(a).SP;if(k>b)return!0;if(k<b)return!1;b=a.xH<ib;if(!Bb&&b)return!0;if(Bb&&!b)return!1;b=c.get(a);return u<b?!0:u>b?!1:d.xH<a.xH?!0:d.xH>a.xH?!1:y<ob(2*a.yH+a.xH%2-3)};g.surround(d,f,function(c){if(!e(c,
n)){var f=g.rawget(c);c=m.ensure(c);null==c.shotFrom?(c.shotFrom=d,f=f.unit,b.isTarget(f)&&(c.effect=b.estimate(a,f))):l(c.shotFrom)&&(c.shotFrom=d)}})}}var g=this,k=d.field;a.call(this,k.depth,c.DUMMY);var l=d.zoc[f.team],u=f.step,N=f.cost,L=f.hex;this.ensure(L).SP=n;if(n>=u+l.get(L))for(var jb=[],na=L;na;na=jb.shift()){var p=this.get(na).SP-(u+l.get(na));if(0<=p)for(var X=0;6>X;++X){var D=b(na,X),q=k.rawget(D);q&&0===q.type&&!f.isEnemy(q.unit)&&(q=this.ensure(D),q.SP<p||q.SP===p&&k.get(na).empty&&
!k.get(q.comeFrom).empty)&&(q.SP=p,q.comeFrom=na,p>=u+l.get(D)&&jb.push(D))}}n>=N&&(h.call(this,d,f,l,L),this.each(function(a,b,c){a.SP>=N&&k.rawget(b,c).empty&&h.call(g,d,f,l,{xH:b,yH:c})}))}x(c,a);c.prototype.ensure=function(a){var b=this.rawget(a);null==b&&(b={SP:-1},this.set(b,a));return b};c.prototype.getPath=function(a,b){var c=this.get(a),d=c.comeFrom,e=c.shotFrom,f;if(c.effect){if(!b.get(e).empty)return null;f=[e];c=this.get(e);d=c.comeFrom;c}else if(d){if(!b.get(a).empty)return null;f=[a]}for(;d;)f.unshift(d),
c=this.get(d),d=c.comeFrom,c;return f};c.DUMMY={SP:-1};return c}($a),eb=function(a){function b(c,d,e,f,h,g){a.call(this,e,f,h,g,new A(function(){var a=c.focus;if(a){var b=a.skills[d];if(b){var e=a.rangeOf(b);if(0<e){var f=a.skill===b,n=a.costOf(b),a=a.powerOf(b);return""+(f?"E ":"")+b.name.localized+"\n"+n+" / "+e+" / "+(0<a?a.toFixed(1):"-")}return b.name.localized+"\n"+("Offence"===b.action?"ATK":"DEF")+": "+db(b.tags)}}},{fontSize:20}),function(){var a=c.focus;if(a){var b=a.skills[d];b&&0<a.rangeOf(b)&&
(a.skill=b,c.onSkillChanged(a))}});this.scene=c;this.index=d}x(b,a);Object.defineProperty(b.prototype,"visible",{get:function(){var a=this.scene.focus;return null!=a&&null!=a.skills[this.index]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"enabled",{get:function(){var a=this.scene.focus;return null!=a&&0<a.rangeOf(a.skills[this.index])},enumerable:!0,configurable:!0});return b}(I),ea=function(){function a(b,c,d){void 0===d&&(d=2);this.level=c;this.numScrollsPerTurn=d;b="assets/"+
("level/"+b+"/");this.imgSky=new H(b+"sky.png");this.imgCells=[new H(b+"tile.png"),new H(b+"hole.png")]}a.prototype.generate=function(a,b){var c=0,d=0;a.eachUnit(function(a){0===a.team?++c:++d});for(var e=0===c?.3:.3*ja(1.1,c-d),f=Array(3),h=Ia(zb),g=0;3>g;++g){var k=void 0,l=0;12<b&&ab()<e?(k=h[Ea(h.length)],k=Y.monster(k,a.level),k=new sb(k,1,{xH:b,yH:g})):6<b&&.1>ab()&&(l=1);f[g]=new Sa(l,k)}return f};a.prototype.draw=function(a,b,c){var d=this,e=c.field,f=this.imgSky.image;if(f){a.save();var h=
128*e.depth/2;a.fillStyle=a.createPattern(f,"repeat");a.translate(-h,0);a.fillRect(0+h,0,1280,80);a.restore()}var g={x:0,y:0,w:128,h:80};e.eachVisible(function(e,f,h){e=e.type;g.x=c.toX(f,h);g.y=c.toY(f,h);d.imgCells[e].draw(a,b,g)})};return a}();a.EndressStage=ea;ea=function(a){function b(c,d){function e(a,b,c){return new I(10+110*b,570,100,140,{draw:function(a,b,d){var e=c.ch,m=d.x,f=d.y,g=Ja(e,d.w,d.h,!0),h=g.w,g=g.h,m=m+(d.w-h)/2,f=f+(d.h-g)/2;if(c.hex)e.draw(a,b,{x:m,y:f,w:h,h:g});else{var n=
c.HP/c.maxHP;.5<=n?e.draw(a,b,{x:m,y:f,w:h,h:g}):(e.images[Ya.CLOSED]||e.images[Ya.DEFAULT]).draw(a,b,{x:m,y:f,w:h,h:g});wa(a,r(100*n).toFixed(0)+"%",d.x,d.y,d.w,d.h,{fillStyle:"white",strokeStyle:"black",textAlign:"center",textBaseline:"bottom"})}}},function(){if(c.hex)y.click(c.hex);else if(.5<=c.HP/c.maxHP){for(var d=k.minXH,e=b%3,m=0;3>m;++m){if(k.get(d,e).empty){a.revive(c,{xH:d,yH:e});return}e=(e+1)%3}E.error(h("Combat","NoSpaceToRevive"))}else E.error(h("Combat","CannotRevive"))},[l.$1+b])}
function f(a,b,c,d,e){b=new I(1280-150*b,570,140,140,new A(c),d);e&&qa(b,"enabled",e);b.attach(a);return b}var g=this;a.call(this);this.data=c;this.stage=d;this.team=0;this.enabled=!1;var k=this.field=new $a(0,Sa.DUMMY);this.dying=[];this.deads=[];this.snapshots=[];var y=new fb;y.attach(this);y.visible=!1;var u=new gb;u.attach(this);u.visible=!1;for(var N=k.minVisibleXH,u=k.maxVisibleXH;N<u;++N)k.setLine(N,this.stage.generate(this,N));for(var L=[],jb=[[2,0],[2,1],[2,2],[1,0],[1,1],[1,2]],p=c.party,
u=0;6>u;++u){var q=p[u];if(q){var X=jb[u],N=X[0],N={xH:N,yH:X[1]},X=new sb(q,0,N);X.state=new Ha(q.DEX);k.rawget(N).unit=X;L.push(e(this,u,X))}}var D=new Q(L);qa(D,"visible",function(){return y.visible&&null==g.focus});D.attach(this);f(D,1,h("Combat","End"),function(){return g.endTurn()});f(D,2,h("Combat","Undo"),function(){return y.undo()},function(){return y.canUndo});f(D,3,h("Combat","Retire"),function(){return g.retire()});var t=f(D,4,h("Combat","View")),u=new ca;u.onDraw=function(a,b){return g.drawUnits(a,
b,g.focusTime)};u.attach(this);u=new ca;u.onDraw=function(a,b){return g.drawBarsOnView(a,b)};qa(u,"visible",function(){return D.visible&&(t.hover||t.pressed)});u.attach(this);u=new Q;qa(u,"visible",function(){return null!=g.focus});u.attach(this);L=new ca;L.onDraw=function(a,b){return g.drawBarsOnFocus(a,b,g.focus,g.controller.caret)};L.attach(u);var v=new la(0,560,1280,160);v.onDraw=function(a,b){return g.drawPanel(a,b,g.focus,v)};v.attach(u);L=new Q;qa(L,"visible",function(){return y.visible&&null!=
g.focus});L.attach(this);for(u=0;6>u;++u)(new eb(this,u,400+170*r(u/2),570+u%2*75,160,65)).attach(L);var w=function(){var a=g.mapFor(g.focus);if(a){var b=g.controller.caret;if(b&&a.get(b).effect)return k.get(b).unit}return null},x=new la(640,560,640,160);qa(x,"visible",function(){return null!=w()});x.onDraw=function(a,b){return g.drawPanel(a,b,w(),x)};x.attach(this);u=System.canvas.getContext("2d");(new G(0,0,128,560,new nb({fillStyle:lb(u,0,0,128,0,ba,P)}))).attach(this);(new G(1152,0,1280,560,new nb({fillStyle:lb(u,
1152,0,1280,0,P,ba)}))).attach(this);mb(this);this.startTurn()}x(b,a);Object.defineProperty(b.prototype,"controller",{get:function(){return this.children[this.team]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"level",{get:function(){var a=this.stage,b=a.level,a=a.numScrollsPerTurn;0<a&&(b+=this.field.depth/a*.1);return b},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"numScrollsPerTurn",{get:function(){return this.stage.numScrollsPerTurn},enumerable:!0,configurable:!0});
Object.defineProperty(b.prototype,"focus",{get:function(){return this._focus},set:function(a){null==a?(this._focus=null,this.focusTime=void 0):this._focus!==a&&(this._focus=a,this.focusTime=performance.now())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"zoc",{get:function(){if(this.enabled){var a=this._zoc;if(!a){var a=this.field.depth,b=[new $a(a,0),new $a(a,0)];this.eachUnit(function(a){var c=a.ZoC;if(0<c){var d=b[0===a.team?1:0];d.surround(a.hex,1,function(a){return d.set(d.get(a)+
c,a)})}});this._zoc=a=b}return a}},enumerable:!0,configurable:!0});b.prototype.mapFor=function(a){if(a&&this.enabled){var b=this.maps;b||(this.maps=b=new $a(this.field.depth));var c=a.hex,d=b.rawget(c);null==d&&(d=new Ta(this,a,a.SP),b.set(d,c));return d}};b.prototype.onSkillChanged=function(a){var b=this.maps,c=this.snapshots;b&&b.set(void 0,a.hex);if(c)for(b=0;b<c.length;b++){var d=c[b];d.unit===a&&d.maps.set(void 0,d.hex)}};b.prototype.savepoint=function(a){this.snapshots.push({unit:a,hex:a.hex,
SP:a.SP,maps:this.maps,zoc:this.zoc})};b.prototype.rollback=function(){var a=this.snapshots.pop(),b=a.unit;this.setUnit(b,a.hex);b.SP=a.SP;this._zoc=a.zoc;this.maps=a.maps;this.focus=b};b.prototype.setUnit=function(a,b){var c=this.field,d=c.rawget(b),e=d.unit;if(a){if(e===a)return;a.hex&&(c.rawget(a.hex).unit=null);a.hex=b}else e&&(e.hex=null);d.unit=a;this.invalidate()};b.prototype.revive=function(a,b){var c=this.deads,d=c.indexOf(a);c.splice(d,1);a.SP=a.availSP;a.state=new Ha(a.DEX);this.setUnit(a,
b);this.snapshots.length=0};b.prototype.invalidate=function(){this.maps=this._zoc=void 0};b.prototype.startTurn=function(){for(var a=this,b=this.team,c=0,d=this.deads;c<d.length;c++){var e=d[c];if(e.team===b){var f=r(.1*e.maxHP);e.HP=R(e.maxHP,e.HP+f)}}var g;this.eachUnit(function(b){(b=b.onTurnStart(a))&&(g?g.push(b):g=[b])});b=function(){a.enabled=!0;a.controller.visible=!0};g?ta(g).then(b):b()};b.prototype.retire=function(){var a=this;Oa.confirm(this,h("Combat","ConfirmRetire"),{label:h("Combat",
"Retire"),click:function(){a.controller.visible=!1;(new da(a,new Za.Home(a.data))).attach(a.parent)},mnemonic:qb},{label:h("Config","Cancel"),mnemonic:rb})};b.prototype.endTurn=function(){var a=this;this.enabled=!1;this.snapshots.length=0;this.controller.visible=!1;this.eachUnit(function(b){b.onTurnEnd(a)});if(0===this.team){var b=this.numScrollsPerTurn;if(0<b){var c=this.field.minXH+b;this.eachUnit(function(b){b.hex.xH<c&&(b.state=new Ra(b,b.HP),a.kill(b))});var d=this.field.depth;(new F(400*b,function(c){a.scrollTo(d+
b*c)})).attach(this);if(this.isGameOver)return}}this.team=0===this.team?1:0;var e=Xa[this.team],f=e.innerStyle,g=e.outerStyle,k=e.textStyle,l=h("Combat",e.messageID);(new F(800,function(a,b){b.save();b.globalAlpha=U(V*a);cb(b,0,0,1280,560,f,g);La(b,l.localized,640,280,k);b.restore()})).then(function(){a.startTurn()}).attach(this)};b.prototype.move=function(a,b){var c=this;Va(!e(b,a.hex));var d=function(){c.enabled=!0;a.done(c)&&(c.focus=null)};this.focus=a;var f=this.field,g=this.mapFor(a),h=g.get(b);
if(h.effect){this.enabled=!1;var k=f.get(b).unit;Va(a.isTarget(k));var l=function(){c.snapshots.length=0;c.invalidate();return a.shoot(c,k).then(d)};if(e(h.shotFrom,a.hex))return l();f=g.getPath(b,f);h=f[f.length-1];Va(!e(h,b));Va(!e(h,a.hex));this.setUnit(a,h);a.SP=g.get(h).SP;g=a.state=new Da(f);l=kb(l);g.then(l);return l}Va(0<=h.SP&&f.rawget(b).empty);f=g.getPath(b,f);this.setUnit(a,b);a.SP=h.SP;g=a.state=new Da(f);d();return t.wait.WALK?g:J};b.prototype.findUnit=function(a,b,c){var d=this.field,
e=d.minXH,f=d.maxXH,g=(0===this.team?b:!b)?1:-1;b=b?1:-1;var h,k;a?(h=a.xH,k=a.yH,a):(h=0>g?e:f-1,k=0>b?0:2);a=1;for(var l=3*(f-e+1);a<l;++a){k+=b;if(0>k||3<=k)k=0>k?2:0,h+=g,h<e?h=f-1:f<=h&&(h=e);var y=d.rawget(h,k).unit;if(y&&c(y))return y}return null};b.prototype.kill=function(a){var b=this;a.HP=0;this.setUnit(null,a.hex);this.dying.push(a);0===a.team&&(this.deads.push(a),this.parent&&this.isGameOver&&(this.controller.visible=!1,(a.state||J).then(function(){Oa.confirm(b,h("Combat","GameOver"),
{label:h("Combat","Retire"),click:function(){(new da(b,new Za.Home(b.data))).attach(b.parent)},mnemonic:vb})})))};Object.defineProperty(b.prototype,"isGameOver",{get:function(){return null==this.findUnit(null,!0,function(a){return 0===a.team})},enumerable:!0,configurable:!0});b.prototype.createPopup=function(a,b,c){var d=this.toX(c)+64,e=this.toY(c)+80;return new F(600,function(c,f){return La(f,a,d,e-40*c,{fontSize:48,fillStyle:b,strokeStyle:"black",globalAlpha:U(V*c),lineWidth:4,textAlign:"center",
textBaseline:"bottom"})})};b.prototype.promiseEffect=function(a,b,c){var d=this,e=b.deltaHP||0,f=ob(e).toString(),g=this.createPopup(f,0<e?Qa:Na,c||a.hex),h=g.attach;g.attach=function(c){var f=b.deltaSP||0;if(0>e||0>f)a.state=new Ra(a,-e);a.HP=fa(0,a.maxHP,a.HP+e);0!==f&&(a.SP=fa(0,a.maxSP,a.SP+f));0>=a.HP?d.kill(a):(f=b.duration,null!=f&&a.effectsOverTime.push({duration:f,deltaHPoT:b.deltaHPoT}));return h.call(g,c)};return g};b.prototype.eachUnit=function(a){var b=this;this.field.eachVisible(function(c){(c=
c.unit)&&a.call(b,c)})};b.prototype.toX=function(a,b){var c;null==b?(d=a,c=d.xH,d):c=a;return 0+64*(c-1-this.field.depth);var d};b.prototype.toY=function(a,b){var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;return 80+80*(2*b+c%2);var d};b.prototype.toHex=function(a,b){var c=this.field,d=a-0+128*c.depth/2,e=r((b-0-80)/80);return 0<=e&&6>e&&(d=0===e%2?2*r((d+64)/128):2*r(d/128)+1,c.minXH<=d&&d<c.maxXH)?(c=r(e/2),{xH:d,yH:c}):null};b.prototype.scrollTo=function(a){var b=this.field;if(a>b.depth){var c=b.minVisibleXH,
d=b.maxVisibleXH;b.depth=a;a=b.minVisibleXH;for(var e=b.maxVisibleXH;c<a;++c)b.deleteLine(c);for(c=T(a,d);c<e;++c)b.setLine(c,this.stage.generate(this,c))}};b.prototype.onDraw=function(b,c){this.stage.draw(b,c,this);var d=this.focus,e=this.mapFor(d);e&&this.drawMarkers(b,c,this.focusTime,e,d);a.prototype.onDraw.call(this,b,c)};b.prototype.drawMarkers=function(a,b,c,d,e){var f=this,g=F.clamp(b,c,300);if(!(0>=g)){var h=e.cost;b=e.skill.hostile?ua:xa;var k=b.DASH_OR_RANGE,l=b.RANGE,y=b.TARGET;a.save();
1>g&&(a.globalAlpha=g);d.eachVisible(function(b,c,d){var e=b.SP,n=b.shotFrom,z,C=0,p=0;b.effect?(z=y,C=32*(1-g),p=20*(1-g)):e>=h?z=Wa:0<=e?z=n?k:ra:n&&(z=l);z&&(b=f.toX(c,d)-C,c=f.toY(c,d)-p,C=128+2*C,p=80+2*p,a.fillStyle=z.bkgnd,a.fillRect(b+5,c+5,C-10,p-10),a.strokeStyle=z.outer,a.lineWidth=2,a.strokeRect(b+2,c+2,C-4,p-4),a.strokeStyle=z.inner,a.lineWidth=1,a.strokeRect(b+4,c+4,C-8,p-8))});a.restore()}};b.prototype.drawUnits=function(a,b,c){var d=this,e=this.zoc,f=this.focus,g=[];this.eachUnit(function(a){var c=
a.getXY(d,b);c.unit=a;g.push(c)});for(var k=0;k<this.dying.length;){var l=this.dying[k],y=l.getXY(this,b);y?(y.unit=l,g.push(y),++k):this.dying.splice(k,1)}g.sort(sb.compare);k=h("Combat","Done").localized;c=(1-ka(2*V*F.cycle(b,c,1E3)))/2*.5;for(var C=(y=this.mapFor(f))&&f.skill.hostile?"red":"blue",p=0;p<g.length;p++){var q=g[p],l=q.unit,r=q.x,q=q.y,D=void 0;if(y)if(f===l)D="yellow";else{var t=l.hex;t&&y.get(t).effect&&(D=C)}l.draw(a,b,r,q,D,c);if(!l.state&&e){var t=l.hex,D=l.SP,v=l.step,w=l.cost,
l=l.team;t&&D<w&&(D<v?La(a,k,r,q,Fa):D<v+e[l].get(t)&&La(a,k,r,q,Ga))}}};b.prototype.drawBarsOnView=function(a,b){var c=this;this.eachUnit(function(d){return d.drawBars(a,b,c)})};b.prototype.drawBarsOnFocus=function(a,b,c,d){var h=this,k=this.mapFor(c);if(k){var l=this.field;k.each(function(c,d,e){(c=c.effect)&&l.get(d,e).unit.drawBars(a,b,h,c.deltaHP,c.deltaSP)});if(d){var y=k.get(d);y.effect?(d=y.shotFrom,e(d,c.hex)?c.drawBars(a,b,this,null,-c.cost):(f(a,b,this,c,c.hex),g(a,b,this,c,d,k.get(d).SP-
c.cost))):0<y.SP&&l.get(d).empty?(f(a,b,this,c,c.hex),g(a,b,this,c,d,y.SP)):c.drawBars(a,b,this)}else c.drawBars(a,b,this)}};b.prototype.drawPanel=function(a,b,c,d){if(c){Ka(a,d,M[c.team]);var e=c.ch,f=Ja(e,128,128);f.x=d.x+10+(128-f.w)/2;f.y=d.y+(d.h-f.h)/2;e.draw(a,b,f);b=c.SP>=c.cost?r((c.SP-c.cost)/c.step):"-";var e=c.powerOf(c.skill),f=c.name+" / Lv: ",g;g=c.level;g=null!=g?g.toFixed(1):"-";La(a,f+g+"\n"+("HP: "+c.HP+" / "+c.maxHP+"\n")+("SP: "+c.SP+" / "+c.maxSP+"\n")+("MOVE: "+b+"/"+r(c.SP/
c.step)+"\n")+("ATK/DEF: "+(null!=e?e.toFixed(1):"-")+" / "+c.DEF.toFixed(1)),d.x+148,d.y+10,ga)}};return b}(Q);a.Scene=ea;var fb=function(a){function c(){a.apply(this,arguments);this.mode=0}x(c,a);Object.defineProperty(c.prototype,"caret",{get:function(){return this._caret},set:function(a){this._caret=a;if(0===this.mode){var b=this.parent;b.focus=a?b.field.get(a).unit:null}},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"canUndo",{get:function(){return 0<this.parent.snapshots.length||
1<=this.mode},enumerable:!0,configurable:!0});c.prototype.undo=function(){var a=this.parent,b=a.snapshots,c=b.length,b=0<c?b[c-1].unit:null;1<=this.mode&&b!==a.focus?this.mode=0:b?a.rollback():E.error(h("Combat","CannotUndo"));this.caret=this._caret};c.prototype.onHover=function(a,b){this.caret=this.parent.toHex(a,b)};c.prototype.onDrag=function(a,b){this.caret=this.parent.toHex(a,b)};c.prototype.downCaret=function(a){if(this.caret=a){var b=this.parent,c=this.mode,d=b.focus;if(d){if(d.team===b.team&&
!d.done(b)){1===c&&e(a,d.hex)?this.mode=3:this.mode=2;return}}else if(a=b.field.get(a).unit,b.focus=a){this.mode=2;return}this.mode=0}};c.prototype.onDown=function(a,b){this.downCaret(this.parent.toHex(a,b))};c.prototype.upCaret=function(a){var b=this;if(this.caret=a){var c=this.parent,d=this.mode;if(c.enabled&&!(2>d)){var f=c.focus;if(null==f||c.team!==f.team)this.mode=0;else if(e(a,f.hex))this.mode=2===d?1:0;else{d=c.mapFor(f).get(a);if(!d.effect)if(0<=d.SP&&c.field.rawget(a).empty)c.savepoint(f);
else{c.focus=null;this.mode=0;return}this.mode=1;a=c.move(f,a);f=function(){null==c.focus&&(b.mode=0)};c.enabled?f():a.then(f)}}}};c.prototype.onUp=function(a,b){this.upCaret(this.parent.toHex(a,b))};c.prototype.onPress=function(a){function c(a){var d=this.parent.field,e=this.caret;e?(a=b(e,a),d.contains(a)&&(this.caret=a)):this.caret={xH:d.minXH,yH:0}}function d(a){var b=this.parent,c=this.caret,e=b.team,f=b.focus;(a=b.findUnit(f?f.hex:c,a,function(a){return a.team===e&&!a.done(b)}))?(b.focus=a,
null==c&&(this.caret=a.hex),0===this._mode&&(this.mode=1)):E.error(h("Combat","UnitNotAvailable"))}switch(a){case l.TAB:case l.DELETE:case l.Q:this.undo();break;case l.PAGE_DOWN:case l.C:d.call(this,!0);break;case l.PAGE_UP:d.call(this,!1);break;case l.SPACE:case l.ENTER:this.click(this.caret);break;case l.E:c.call(this,0);break;case l.RIGHT:case l.D:c.call(this,1);break;case l.DOWN:case l.X:case l.S:c.call(this,2);break;case l.Z:c.call(this,3);break;case l.LEFT:case l.A:c.call(this,4);break;case l.UP:case l.W:c.call(this,
5)}};c.prototype.click=function(a){this.parent.field.contains(a)&&(this.downCaret(a),this.upCaret(a))};c.prototype.onDraw=function(a,b){function c(a,b,d,e){var f=b.toX(d)+6.5;b=b.toY(d)+6.5;a.save();a.lineCap="round";a.lineJoin="round";a.beginPath();a.moveTo(f+32,b);a.lineTo(f,b);a.lineTo(f,b+20);a.moveTo(f+115-32,b);a.lineTo(f+115,b);a.lineTo(f+115,b+20);a.moveTo(f+115-32,b+67);a.lineTo(f+115,b+67);a.lineTo(f+115,b+67-20);a.moveTo(f+32,b+67);a.lineTo(f,b+67);a.lineTo(f,b+67-20);a.lineWidth=7;a.strokeStyle=
e.outer;a.stroke();a.lineWidth=3;a.strokeStyle=e.inner;a.stroke();a.restore()}function d(a,b,c){a.save();a.lineCap="butt";a.lineJoin="round";var e=c[c.length-2],f=c[c.length-1],g=b.toX(e)+64,h=b.toY(e)+40,e=b.toX(f)+64,f=b.toY(f)+40,g=wb(f-h,e-g);a.beginPath();a.moveTo(e+20*ka(g),f+20*U(g));a.lineTo(e+20*ka(g+2*V/3),f+20*U(g+2*V/3));a.lineTo(e+20*ka(g-2*V/3),f+20*U(g-2*V/3));a.fillStyle=va;a.fill();a.beginPath();a.moveTo(e-10*ka(g),f-10*U(g));for(g=c.length-2;0<=g;--g)e=c[g],a.lineTo(b.toX(e)+64,
b.toY(e)+40);a.strokeStyle=va;a.lineWidth=12;a.stroke();a.restore()}var e=this.caret;if(e){var f=this.parent,g=f.focus,h=f.field;if(0===this.mode)c(a,f,e,ia);else if(g){var k=f.mapFor(g);if(k){var l=k.get(e);(k=k.getPath(e,h))&&2<=k.length&&d(a,f,k);if(l.effect)switch(g.skill.target){case 1:c(a,f,e,za);break;case 2:c(a,f,e,ma);break;case 3:h.straight(l.shotFrom,e,g.range,function(b){return c(a,f,b,za)});break;case 4:h.straight(l.shotFrom,e,g.range,function(b){return c(a,f,b,ma)});break;case 5:h.surround(l.shotFrom,
g.range,function(b){return c(a,f,b,za)});break;case 6:h.surround(l.shotFrom,g.range,function(b){return c(a,f,b,ma)})}else 0<=l.SP?c(a,f,e,pa):c(a,f,e,ia)}}}};return c}(ca),gb=function(a){function b(){a.apply(this,arguments);this.running=!1}x(b,a);Object.defineProperty(b.prototype,"visible",{get:function(){return this.running},set:function(a){var b=this;(this.running=a)&&J.then(function(){return b.run([])})},enumerable:!0,configurable:!0});b.prototype.run=function(a){function b(a,c){var d=a.focus;
if(d)return d;var e=a.team,d=c.length,d=0<d?a.findUnit(c[d-1].hex,!1,function(b){return b.team===e&&!b.done(a)&&0>c.indexOf(b)}):a.findUnit(null,!1,function(b){return b.team===e&&!b.done(a)});return a.focus=d}function c(a,b,f){var g=a.mapFor(b),h=d(a,b,g),k=h.hex;if(!g.get(k).effect&&b.SP>=b.availSP){var l=new Ta(a,b,999),k=d(a,b,l,h).hex,h=l.get(k);h.effect&&(k=h.shotFrom);for(h=a.field;k&&(0>g.get(k).SP||!h.get(k).empty);)k=l.get(k).comeFrom;null==k&&(k=b.hex)}if(e(k,b.hex))return f.push(b),a.focus=
null;f.length=0;this.caret=k;f=t.wait.PICK;return 0<f?(g=kb(function(){return a.move(b,k)}),(new F(f)).then(g).attach(a),g):a.move(b,k)}function d(a,b,c,e){var g=a.field,h=g.minXH,k=g.maxXH,l=b.maxSP,m=b.hex,n=b.cost,y=h+a.numScrollsPerTurn;e||(e={hex:m,score:f(b,m.xH,m.yH,h,k,y)+40*b.SP/l});c.each(function(d,m,C){var q=d.SP,u=d.effect;d=d.shotFrom;var r;if(u){q=r=f(b,d.xH,d.yH,h,k,y);r=a.field.rawget(m,C).unit;var t;t=r.ch;for(var v=0,z=0,w=t.skills;z<w.length;z++){var x=w[z];0<t.rangeOf(x)&&(t.powerOf(x),
v=x.hostile?B(a,r,x,b)/b.HP:p(a,r,x)/r.maxHP,v=T(v,v))}t=R(1,v);u=u.deltaHP||0;u=0>u?-u:R(u,r.maxHP-r.HP);u=R(1,u/r.HP);r=q+1E3*t*u;q=c.get(d).SP-n}else if(0<=q&&g.get(m,C).empty)r=f(b,m,C,h,k,y);else return;r+=40*q/l;e.score<r&&(e.score=r,e.hex={xH:m,yH:C})});return e}function f(a,b,c,d,e,g){var h=0,h=1===a.team?h+10*(e-b):h+10*(b-d);a=2*c+b%2;h=3>a?h+10*a:h+10*(5-a);b<g&&(h*=.1);return h}for(var g=this,h=this.parent,k=null;this.running;){h.enabled||(k=J);if(k){k.then(function(){return g.run(a)});
break}this.caret=null;k=b(h,a);if(null==k){h.endTurn();break}k=c.call(this,h,k,a)}};return b}(ca);Aa={Damage:function(a,b,c){return{deltaHP:-B(a,b,b.skill,c)}},DamageHPandSP:function(a,b,c){a=-B(a,b,b.skill,c);return{deltaHP:a,deltaSP:r(a/2)}},DamageOverTime:function(a,b,c){a=-B(a,b,b.skill,c);return{deltaHP:a,duration:2,deltaHPoT:r(a/2)}},Heal:function(a,b,c){return{deltaHP:p(a,b,b.skill)}},HealOverTime:function(a,b,c){a=p(a,b,b.skill);return{deltaHP:a,duration:2,deltaHPoT:Ua(a/2)}}};Ba={Charge:q,
Knockback:function(a,b,c){var d=c.hex,e=O(a.field,b.hex,d);if(null==e)return q(a,b,c);var f=b.estimate(a,c),g=a.promiseEffect(c,f,e),f=new Pa(a,b.hex,c.hex),h=new Da([d,e]);b.state=f;f.hit(function(){a.setUnit(c,e);c.state=h});h.then(function(){g.attach(a)});return t.wait.POPUP?ta([g,f]):f},GoBehind:function(a,b,c){var d=c.hex,e=O(a.field,b.hex,d);if(null==e)return q(a,b,c);var f=b.hex,g=b.estimate(a,c),h=a.promiseEffect(c,g);c=new Da([f,d]);a.setUnit(b,e);b.state=c;c.then(function(){h.attach(a)});
return t.wait.POPUP?h:c},Trample:function(a,b,c){var d=c.hex,e=O(a.field,b.hex,d);if(null==e)return q(a,b,c);var f=b.hex,g=b.estimate(a,c),h=a.promiseEffect(c,g,e),f=new Da([f,d]),g=new Da([d,d,e]);a.setUnit(c,e);c.state=g;a.setUnit(b,d);b.state=f;g.then(function(){h.attach(a)});return t.wait.POPUP?h:g},Shoot:function(a,b,c){var d=b.estimate(a,c),e=a.promiseEffect(c,d);b=v(a,b.hex,c.hex,b.skill);b.then(function(){return e.attach(a)});return t.wait.POPUP?e:b},Drain:function(a,b,c){var d=b.estimate(a,
c),e=a.promiseEffect(c,d),f=a.promiseEffect(b,{deltaHP:-d.deltaHP});b=v(a,c.hex,b.hex,b.skill);b.then(function(){return f.attach(a)});e.attach(a);return t.wait.POPUP?f:b},Explode:function(a,b,c){b.estimate(a,c);var d=v(a,b.hex,c.hex,b.skill),e=kb(function(){return W(a,b,c.hex,1,function(a,b){return r(a/(1+b))})});d.then(e);return e},Laser:function(a,b,c){var d=a.field,e=b.hex,f,g=[];d.straight(e,c.hex,b.range,function(c){var e=d.get(c).unit;if(b.isTarget(e)){var h=b.estimate(a,e),e=a.promiseEffect(e,
h);e.attach(a);g.push(e)}f=c});var h=K(b.skill);c=new F(400,function(b,c){var d=a.toX(e)+64,g=a.toY(e)+40,k=a.toX(f)+64,l=a.toY(f)+40,m=wb(l-g,k-d),p=64*ka(m),m=40*U(m);c.save();c.beginPath();c.moveTo(d+p,g+m);c.lineTo(k+p,l+m);c.lineCap="round";c.lineWidth=80*b/4;c.strokeStyle=Ma(h,1-b);c.stroke();c.restore()});c.attach(a);return t.wait.POPUP?(g.push(c),ta(g)):c},Nova:function(a,b,c){return W(a,b,b.hex,b.range)}}})(Ca||(Ca={}));var Qa,t=new (function(){function a(){this._refineCanvas=this._magnifyCanvas=
!1;this.volume=new xb(50,0,100);this.effects=new xb(Xa.length-1,0,Xa.length-1)}Object.defineProperty(a.prototype,"magnifyCanvas",{get:function(){return this._magnifyCanvas},set:function(a){this._magnifyCanvas!==a&&(this._magnifyCanvas=a,window.dispatchEvent(new UIEvent("resize")))},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"refineCanvas",{get:function(){return this._refineCanvas},set:function(a){this._refineCanvas!==a&&(this._refineCanvas=a,window.dispatchEvent(new UIEvent("resize")))},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"wait",{get:function(){return Xa[this.effects.value]},enumerable:!0,configurable:!0});return a}());System.main=function(a,b){var d=new Image;d.src="assets/dummy.png";H.DUMMY=d;var d=new Q,e=new Q;e.attach(d);var c=new Kb(10,10,1260,700,2E3,Hb);c.attach(d);E=c;Qa=function(){for(;;){var a=e.children,b=a.length;if(0===b)break;a[b-1].detach()}(new gb(new Ba.Scene)).attach(e)};Gb();Qa();Db(a,d,t);System.checkpoint=function(){fb()}}})();
