(function(){function fa(b,a,c){return c<b?b:c>a?a:c}function ba(b,a){return null!=b?b:a}function Ja(b){return q(Wa()*b)}function sa(b,a){return b?b.map(function(c){return null!=c?c.toJSON():a}):[]}function N(b,a,c){return a?a.map(function(a){return null!=a?b.fromJSON(a):c}):[]}function ta(b){return void 0===b?"(undefined)":null===b?"(null)":b.toString()}function Ka(b){for(var a=[],c=1;c<arguments.length;c++)a[c-1]=arguments[c];return b.replace(/\$\{(\d+)\}/g,function(c,b){return ta(a[parseInt(b,10)])})}
function La(b,a,c){return Object.defineProperty(b,a,{enumerable:!0,configurable:!0,writable:!0,value:c})}function ua(b,a,c,e){return Object.defineProperty(b,a,{enumerable:!0,configurable:!0,get:c,set:e})}function Cb(b,a){var c=document.createElement("script");c.src=b;c.onerror=a;document.head.appendChild(c)}function ga(b,a){if(b===a)return 0;if(void 0===b&&void 0!==a)return-1;if(void 0!==b&&void 0===a)return 1;if(null===b&&null!==a)return-1;if(null!==b&&null===a)return 1;var c=typeof b,e=typeof a;
if(c!==e)return c<e?-1:1;if("object"===c){if(b instanceof Date&&a instanceof Date)return ga(b.getTime(),a.getTime());if(b instanceof Array&&a instanceof Array){a:{for(var c=b.length,e=a.length,d=0,f=O(c,e);d<f;++d){var g=ga(b[d],a[d]);if(0!==g){c=g;break a}}c=c<e?-1:c>e?1:0}return c}c=b.constructor;if(c===a.constructor){e=b.compare;if("function"===typeof e&&e===a.compare){c=b.compare(a);if("number"!==typeof c)throw new TypeError('Cannot compare "'+b+'" and "'+a+'": operator returns non-number "'+
c+'"');return c}if(c===Object){a:{for(var c=Ma(b).sort(),e=Ma(a).sort(),d=c.length,f=e.length,g=O(d,f),h=0;h<g;++h){var m=c[h],k=e[h];if(m<k||m>k){c=-1;break a}m=ga(b[m],a[k]);if(0!==m){c=m;break a}}c=d<f?-1:d>f?1:0}return c}}throw new TypeError('Cannot compare "'+b+'" and "'+a+'": not supported');}return b<a?-1:b>a?1:0}function ha(b,a){return(b||24)+"px "+(a||"Arial")}function ia(b,a){if(b){if("function"===typeof b)return[b,a];b.push(a);return b}return a}function ca(b){if(b)if("function"===typeof b)I.then(b);
else for(var a=0;a<b.length;a++)I.then(b[a])}function va(b){for(var a,c=b.length,e=0;e<b.length;e++)b[e].then(function(){0>=--c&&(ca(a),a=void 0)});return{then:function(b){0<c?a=ia(a,b):I.then(b);return this}}}function ib(b){function a(c){I.then(c);return this}var c,e=function(){b().then(function(){ca(c);c=void 0;e.then=a})};e.then=function(b){c=ia(c,b);return this};return e}function h(){for(var b=[],a=0;a<arguments.length;a++)b[a-0]=arguments[a];return new K(b)}function Db(b,a,c){function e(c){return(void 0===
c.pageX?c.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-b.offsetLeft:c.pageX-b.offsetLeft)*l/b.offsetWidth}function d(c){return(void 0===c.pageY?c.clientY+document.body.scrollTop+document.documentElement.scrollTop-b.offsetTop:c.pageY-b.offsetTop)*t/b.offsetHeight}function f(c){if(c.buttons&1)a.onDrag(e(c),d(c));else a.onHover(e(c),d(c));c.preventDefault()}function g(c){switch(c.button){case 0:a.onDown(e(c),d(c))}c.preventDefault()}function h(c){switch(c.button){case 0:a.onUp(e(c),
d(c));break;case 2:a.onPress(k.TAB)}c.preventDefault()}function m(){P&&clearTimeout(P);P=setTimeout(function(){P=void 0;var a=b.parentElement,e=a.clientWidth,a=a.clientHeight,a=a-b.offsetTop;0<a&&(c.magnifyCanvas||(e=O(e,l),a=O(a,t)),e*t>l*a?e=wa(a*l/t):a=wa(e*t/l),0<e&&0<a&&(b.style.width=e+"px",b.style.height=a+"px",!c.refineCanvas&&(e>l||a>t)&&(e=l,a=t),b.width!==e||b.height!==a))&&(b.width=e,b.height=a)},300)}function rb(c){I.finish();var e=b.width,d=b.height,f=b.getContext("2d");f&&(f.clearRect(0,
0,e,d),f.save(),f.font=ha(),e===l&&d===t||f.scale(e/l,d/t),a.onDraw(f,c),f.restore());window.requestAnimationFrame(rb)}var l=b.width,t=b.height;b.addEventListener("mousemove",f);b.addEventListener("touchmove",f);b.addEventListener("mousedown",g);b.addEventListener("touchstart",g);b.addEventListener("mouseup",h);b.addEventListener("touchend",h);b.addEventListener("contextmenu",function(c){c.preventDefault()});b.addEventListener("mousewheel",function(c){a.onPress(0<c.wheelDelta?k.PAGE_UP:k.PAGE_DOWN);
c.preventDefault()});window.addEventListener("keydown",function(c){if(!c.ctrlKey&&!c.altKey){var b=ba(c.keyCode,c.charCode);b&&k[b]&&(a.onPress(b),c.preventDefault())}});var P;window.addEventListener("resize",m);"complete"===document.readyState?m():window.addEventListener("load",m);window.requestAnimationFrame(rb)}function Na(b,a,c,e){void 0===e&&(e=!1);var d=b.w;b=b.h;if(d>a||b>c||e){e=d/a;var f=b/c;e>f?(d=a,b/=e):(d/=f,b=c)}return{w:d,h:b}}function Xa(b,a){if(a)for(var c in a)switch(c){case "fontSize":b.font=
ha(a.fontSize,a.fontFamily);break;case "fontFamily":a.fontSize||(b.font=ha(void 0,a.fontFamily));break;default:b[c]=a[c]}}function xa(b,a,c,e,d,f){var g;null==e?(f=a,a=f.x,g=f.y,e=f.w,d=f.h,f,f=c):g=c;if(0<e&&0<d){b.save();Xa(b,f);f&&!f.fillStyle||b.fillRect(a,g,e,d);if(!f||f.strokeStyle)c=b.lineWidth-1,b.strokeRect(a+c/2,g+c/2,e-c,d-c);b.restore()}}function Oa(b,a,c,e,d){function f(c,a,b,e,d){d&&!d.strokeStyle||c.strokeText(a,b,e);d&&!d.fillStyle||c.fillText(a,b,e)}b.save();Xa(b,d);if(0>a.indexOf("\n"))f(b,
a,c,e,d);else{var g=a.split("\n");a=1.2*(d&&d.fontSize||24);switch(b.textBaseline){case "top":for(var h=0;h<g.length;h++){var m=g[h];f(b,m,c,e,d);e+=a}break;case "middle":e-=a*(g.length-1)/2;for(h=0;h<g.length;h++)m=g[h],f(b,m,c,e,d),e+=a;break;case "bottom":for(h=0,g=g.reverse();h<g.length;h++)m=g[h],f(b,m,c,e,d),e-=a}}b.restore()}function ja(b,a,c,e,d,f,g){b.save();Xa(b,g);switch(b.textAlign){case "center":c+=d/2;break;case "right":c+=d;break}if(0>a.indexOf("\n")){switch(b.textBaseline){case "middle":e+=
f/2;break;case "bottom":e+=f;break}g&&!g.strokeStyle||b.strokeText(a,c,e,d);g&&!g.fillStyle||b.fillText(a,c,e,d)}else{a=a.split("\n");var h=1.2*(g&&g.fontSize||24);switch(b.textBaseline){case "middle":e+=(f-h*(a.length-1))/2;break;case "bottom":e=e+f-h*(a.length-1);break}for(f=0;f<a.length;f++){var m=b,k=a[f],l=c,t=e,P=d,v=g;v&&!v.strokeStyle||m.strokeText(k,l,t,P);v&&!v.fillStyle||m.fillText(k,l,t,P);e+=h}}b.restore()}function jb(b,a,c,e,d,f,g){b=b.createLinearGradient(a,c,e,d);b.addColorStop(0,
f);b.addColorStop(1,g);return b}function ya(b,a,c,e,d,f,g){0<e&&0<d&&(b.save(),b.fillStyle=jb(b,a,c,a,c+d,f,g),b.fillRect(a,c,e,d),b.restore())}function Ya(b,a,c,e,d,f,g,h){void 0===h&&(h=0);0<e&&0<d&&(b.save(),b.translate(a+e/2,c+d/2),b.scale(e,d),a=b.createRadialGradient(0,0,h/2,0,0,.5),a.addColorStop(0,f),a.addColorStop(1,g),b.fillStyle=a,b.fillRect(-.5,-.5,1,1),b.restore())}function l(b,a,c){return"rgb("+b+","+a+","+c+")"}function u(b,a,c,e){return"rgba("+b+","+a+","+c+","+e.toFixed(6).replace(/([0-9]+(\.[0-9]+[1-9])?)(\.?0+$)/,
"$1")+")"}function Pa(b,a){return null==a?l(b.r,b.g,b.b):u(b.r,b.g,b.b,a)}function Za(b){Qa||(Qa=[h("Tag","Melee"),h("Tag","Throw"),h("Tag","Shoot"),h("Tag","Magic"),h("Tag","Alchemy"),h("Tag","Slash"),h("Tag","Blunt"),h("Tag","Pierce"),h("Tag","Shield"),h("Tag","Head"),h("Tag","Body"),h("Tag","Arms"),h("Tag","Legs"),h("Tag","Fire"),h("Tag","Cold"),h("Tag","Lightning"),h("Tag","Life")]);return b.map(function(a){return Qa[a].localized}).join(", ")}function za(b){for(var a=0,c=0;c<b.length;c++)a|=1<<
b[c];return a}function kb(b){var a={fillStyle:"white",strokeStyle:"black",fontSize:44,textAlign:"center",textBaseline:"middle"},c={textAlign:"right",textBaseline:"middle"},e={textAlign:"right",textBaseline:"middle"},d=new F(4,4,32,32,new z("assets/config.png"),function(){function d(a,b){var e=100+70*a;(new J(640,e,160,60,new B(b,c))).attach(m);return e}function g(c,a,b){c=d(c,a);a=new Eb(810,c+15,300,30,b);a.attach(m);(new J(1120,c,50,60,new B(b,e))).attach(m);return a}function hb(c,a,b,e,g,h){c=
d(c,a);var k=new F(810,c+0,100,60,new B(function(){var c=g();k.pressed&&k.hover&&(c=!c);return(c?b:e).localized}),h);k.attach(m);return k}var m=new Ra;(new J(0,0,1280,720,new lb(Sa))).attach(m);(new J(0,20,1280,80,new B(h("Config","Caption"),a))).attach(m);(new F(480,495,320,90,new B(h("Config","OK")),function(){return m.detach()},ub)).attach(m);var k=Ma(K.languages).sort().map(function(c){return h("Language",c)}),l=new C(10,10,160,C.heightOf(O(10,k.length)),[{name:h("Config","LanguageID"),extract:function(c){return c.src[1]},
width:40,align:"center"},{name:h("Config","LanguageName"),extract:function(c){return c.localized}}],k,function(c){l.selected=c;K.language=c.src[1]});l.selected=l.rows.find(function(c){return c.src[1]===K.language});l.attach(m);g(0,h("Config","Volume"),p.volume);g(1,h("Config","CPUEffects"),p.effects);var k=h("Config","On"),t=h("Config","Off");hb(2,h("Config","FullScreen"),k,t,function(){return System.getFullScreen()},function(){System.setFullScreenn(!System.getFullScreen())});hb(3,h("Config","MagnifyCanvas"),
k,t,function(){return p.magnifyCanvas},function(){p.magnifyCanvas=!p.magnifyCanvas});hb(4,h("Config","RefineCanvas"),k,t,function(){return p.refineCanvas},function(){p.refineCanvas=!p.refineCanvas});(function(c,a,b){c=new F(810,70*c+100,300,60,new B(a),b);c.attach(m);return c})(5,h("Config","BackToTitle"),function(){m.detach();Ta()});m.attach(b)},Fb,new F.IconDesign("white"));d.attach(b);return d}function $a(){try{var b=System.getRoamingStorage("NYO");if(b){var a=ab(b);return{shop:a.shop,warehouse:N(la,
a.warehouse,void 0),reservers:N(Z,a.reservers,void 0),party:N(Z,a.party,void 0),gold:a.gold}}}catch(c){D.error(c)}}function bb(b){try{System.setRoamingStorage("NYO",cb(b))}catch(a){D.error(a)}db()}function Gb(){function b(c,a){return typeof c===typeof a?a:c}try{var a=System.getLocalStorage("NYO");if(a){var c=ab(a);c&&(K.language=b(K.language,c.language),p.magnifyCanvas=b(p.magnifyCanvas,c.magnifyCanvas),p.refineCanvas=b(p.refineCanvas,c.refineCanvas),p.volume.value=b(p.volume.value,c.volume),p.effects.value=
b(p.effects.value,c.effects))}}catch(e){D.error(e)}}function db(){try{System.setLocalStorage("NYO",cb({language:K.language,magnifyCanvas:p.magnifyCanvas,refineCanvas:p.refineCanvas,volume:p.volume.value,effects:p.effects.value}))}catch(b){D.error(b)}}var x=this&&this.__extends||function(b,a){function c(){this.constructor=b}for(var e in a)a.hasOwnProperty(e)&&(b[e]=a[e]);b.prototype=null===a?Object.create(a):(c.prototype=a.prototype,new c)},Ma=Object.keys,mb=Math.abs,O=Math.min,V=Math.max,q=Math.floor,
Ua=Math.ceil,wa=Math.round,ma=Math.pow,W=Math.sin,na=Math.cos,vb=Math.atan2,X=Math.PI,Wa=Math.random,ab=JSON.parse,cb=JSON.stringify,oa=function(){},I=new (function(){function b(){}b.prototype.then=function(a){this.sig=ia(this.sig,a);return this};b.prototype.finish=function(){var a=this.sig;if(a)if(this.sig=void 0,"function"===typeof a)a();else for(var c=0;c<a.length;c++)(0,a[c])()};return b}()),K=function(){function b(a){this.src=a}Object.defineProperty(b.prototype,"localized",{get:function(){function a(c){var a=
b.languages,f=b.language,g=a[f];if(void 0===g)f in a||(f=b.language=b.fallback,g=a[f]),a[f]=!0,Cb(b.path+f+".js",function(){a[f]=!1});else if(!0!==g){if(!1===g)return c.join(".");for(var h=g,g=0,m=c.length;g<m;++g)if(h=h[c[g]],!h)return c.join(".");return h.toString()}}if(this._language!==b.language){var c=a(this.src);c&&(this._language=b.language,this._localized=c)}return this._localized||this.src.join(".")},enumerable:!0,configurable:!0});b.prototype.toString=function(){return this.localized};b.prototype.compare=
function(a){return ga(this.localized,a.localized)};b.language=window.navigator.language.substr(0,2);b.fallback="en";b.path="";b.languages={};return b}();System.localize=function(b,a){K.languages[b]=a};var k;(function(b){b[b.BACKSPACE=8]="BACKSPACE";b[b.TAB=9]="TAB";b[b.ENTER=13]="ENTER";b[b.ESCAPE=27]="ESCAPE";b[b.SPACE=32]="SPACE";b[b.PAGE_UP=33]="PAGE_UP";b[b.PAGE_DOWN=34]="PAGE_DOWN";b[b.END=35]="END";b[b.HOME=36]="HOME";b[b.LEFT=37]="LEFT";b[b.UP=38]="UP";b[b.RIGHT=39]="RIGHT";b[b.DOWN=40]="DOWN";
b[b.DELETE=46]="DELETE";b[b.$0=48]="$0";b[b.$1=49]="$1";b[b.$2=50]="$2";b[b.$3=51]="$3";b[b.$4=52]="$4";b[b.$5=53]="$5";b[b.$6=54]="$6";b[b.$7=55]="$7";b[b.$8=56]="$8";b[b.$9=57]="$9";b[b.A=65]="A";b[b.B=66]="B";b[b.C=67]="C";b[b.D=68]="D";b[b.E=69]="E";b[b.F=70]="F";b[b.G=71]="G";b[b.H=72]="H";b[b.I=73]="I";b[b.J=74]="J";b[b.K=75]="K";b[b.L=76]="L";b[b.M=77]="M";b[b.N=78]="N";b[b.O=79]="O";b[b.P=80]="P";b[b.Q=81]="Q";b[b.R=82]="R";b[b.S=83]="S";b[b.T=84]="T";b[b.U=85]="U";b[b.V=86]="V";b[b.W=87]=
"W";b[b.X=88]="X";b[b.Y=89]="Y";b[b.Z=90]="Z"})(k||(k={}));var da=function(){function b(){}b.prototype.onHover=function(a,c){};b.prototype.onDrag=function(a,c){};b.prototype.onDown=function(a,c){};b.prototype.onUp=function(a,c){};b.prototype.onPress=function(a){};b.prototype.onDraw=function(a,c){};b.prototype.attach=function(a){return a.onAttach(this)};b.prototype.detach=function(){var a=this.parent;if(a)return a.onDetach(this),a};Object.defineProperty(b.prototype,"visible",{get:function(){return!0},
set:function(a){La(this,"visible",a)},enumerable:!0,configurable:!0});return b}(),R=function(b){function a(c){b.call(this);this.children=[];if(c)for(var a=0;a<c.length;a++)c[a].attach(this)}x(a,b);a.prototype.onAttach=function(c){if(c.parent===this)return!1;this.children.push(c);c.parent=this;return!0};a.prototype.onDetach=function(c){if(!c.parent)return!1;c.parent=void 0;for(var a=this.children,b=0;b<a.length;++b)if(a[b]===c){c=this.children;for(var a=c.length,f=Array(a-1),g=0;g<b;++g)f[g]=c[g];
for(g=b+1;g<a;++g)f[g-1]=c[g];this.children=f;break}return!0};a.prototype.onHover=function(c,a){for(var b=0,f=this.children;b<f.length;b++){var g=f[b];if(g.visible)g.onHover(c,a)}};a.prototype.onDrag=function(c,a){for(var b=0,f=this.children;b<f.length;b++){var g=f[b];if(g.visible)g.onDrag(c,a)}};a.prototype.onDown=function(c,a){for(var b=0,f=this.children;b<f.length;b++){var g=f[b];if(g.visible)g.onDown(c,a)}};a.prototype.onUp=function(c,a){for(var b=0,f=this.children;b<f.length;b++){var g=f[b];
if(g.visible)g.onUp(c,a)}};a.prototype.onPress=function(c){for(var a=0,b=this.children;a<b.length;a++){var f=b[a];if(f.visible)f.onPress(c)}};a.prototype.onDraw=function(c,a){for(var b=0,f=this.children;b<f.length;b++){var g=f[b];if(g.visible)g.onDraw(c,a)}};return a}(da),lb=function(){function b(a){this.rectStyle=a}b.prototype.draw=function(a,c,b){xa(a,b,this.rectStyle)};return b}(),B=function(){function b(a,c,b){this.value=a;this.textStyle=c;this.rectStyle=b;c&&c.fillStyle&&c.textAlign&&c.textBaseline||
(a=Object.create(c||null),c&&c.fillStyle||(a.fillStyle="white"),c&&c.textAlign||(a.textAlign="center"),c&&c.textBaseline||(a.textBaseline="middle"),this.textStyle=a)}b.prototype.draw=function(a,c,b){c=b.x;var d=b.y,f=b.w;b=b.h;this.rectStyle&&xa(a,c,d,f,b,this.rectStyle);ja(a,this.text,c,d,f,b,this.textStyle)};Object.defineProperty(b.prototype,"text",{get:function(){var a=this.value;"function"===typeof a&&(a=a());return ta(a)},enumerable:!0,configurable:!0});return b}(),z=function(){function b(a){this.src=
a;this._image=void 0}b.from=function(a){var c=new b;c._image=a;return c};b.prototype.then=function(a){this._image?I.then(a):(this.sig=ia(this.sig,a),this.preload());return this};b.prototype.preload=function(){var a=this;if(void 0===this._image){this._image=null;var c=new Image;c.addEventListener("load",function(){a._image=c;ca(a.sig);a.sig=void 0});c.addEventListener("error",function(){a._image=b.DUMMY;ca(a.sig);a.sig=void 0});this.src&&(c.src=this.src)}};Object.defineProperty(b.prototype,"image",
{get:function(){void 0===this._image&&this.preload();return this._image},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"w",{get:function(){var a=this.image;return a?a.width:1},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"h",{get:function(){var a=this.image;return a?a.height:1},enumerable:!0,configurable:!0});b.prototype.draw=function(a,c,b,d,f){c=this.image;var g=b.x,h=b.y,m=b.w;b=b.h;c&&0<m&&0<b&&(!d||0>=f?a.drawImage(c,g,h,m,b):(a.save(),a.globalCompositeOperation=
"destination-out",a.drawImage(c,g,h,m,b),a.globalCompositeOperation="destination-over",a.fillStyle=d,a.fillRect(g,h,m,b),1>f&&(a.globalCompositeOperation="source-over",a.globalAlpha=1-f,a.drawImage(c,g,h,m,b)),a.restore()))};b.DUMMY=null;return b}(),Hb={fontSize:32,fillStyle:"white",strokeStyle:"black",textAlign:"left",textBaseline:"top",lineWidth:2},Sa={fillStyle:u(0,0,0,.8)},Ib={fillStyle:"white",strokeStyle:"black",fontSize:44,textAlign:"center",textBaseline:"middle"},G=function(b){function a(c,
a){b.call(this);this.duration=c;a&&(this.onAnimation=a)}x(a,b);a.prototype.attach=function(c){return b.prototype.attach.call(this,c)?(this.start=performance.now(),!0):!1};a.prototype.detach=function(){this.start=void 0;return b.prototype.detach.call(this)};a.prototype.onDraw=function(c,b){var a=this.start;a&&(b>=a+this.duration?(this.onAnimation(1,c,b),this.detach(),ca(this.sig),this.sig=void 0):(a=V(0,b-a)/this.duration,this.onAnimation(a,c,b)))};a.prototype.onAnimation=function(c,b,a){};a.prototype.then=
function(c){this.sig=ia(this.sig,c);return this};a.clamp=function(c,b,a){return!b||c<b?0:!a||b+a<c?1:(c-b)/a};a.cycle=function(b,a,d){return!a||!d||b<a?0:(b-a)%d/d};return a}(da),wb=function(b){function a(a,e){void 0===e&&(e=400);b.call(this,e);this.next=a}x(a,b);a.prototype.onAnimation=function(b,a,d){if(1>b){if(0<b)this.next.onDraw(a,d);a.save();a.globalAlpha=1-b;a.fillStyle="black";a.fillRect(0,0,1280,720);a.restore()}else this.next.attach(this.parent)};return a}(G),S=function(b){function a(a,
e,d){void 0===d&&(d=400);b.call(this,d);this.prev=a;this.next=e}x(a,b);a.go=function(b,e,d){void 0===d&&(d=400);(new a(b,e,d)).attach(b.parent)};a.prototype.attach=function(a){return b.prototype.attach.call(this,a)?(this.prev.detach(),!0):!1};a.prototype.onAnimation=function(a,b,d){1>a?(this.prev.onDraw(b,d),0<a&&(b.save(),b.globalAlpha=a,b.fillStyle="black",b.fillRect(0,0,1280,720),b.restore())):this.next&&(new wb(this.next,this.duration)).attach(this.parent)};return a}(G),Ra=function(b){function a(){b.apply(this,
arguments)}x(a,b);a.prototype.attach=function(a){return!this.prev&&a.parent&&b.prototype.attach.call(this,a.parent)?(a.detach(),this.prev=a,!0):!1};a.prototype.detach=function(){var a=b.prototype.detach.call(this);a&&this.prev.attach(a);return a};a.prototype.onDraw=function(a,e){this.prev.onDraw(a,e);b.prototype.onDraw.call(this,a,e)};a.confirm=function(b,e){for(var d=[],f=2;f<arguments.length;f++)d[f-2]=arguments[f];var g=new a;(new J(0,0,1280,720,new B(e,Ib,Sa))).attach(g);for(var f=d.length,h=
1280/(3+f),m=h/8,k=(1280-h*f-m*(f-1))/2,l=function(a){var b=d[a],c=b.click,e=b.mnemonic;(new F(k+(h+m)*a,495,h,90,new B(b.label),c?function(){g.detach();c()}:function(){g.detach()},e)).attach(g)},t=0;t<f;++t)l(t);g.attach(b);return g};return a}(R),pa=function(b){function a(a,e,d,f){b.call(this);this.x=a;this.y=e;this.w=d;this.h=f}x(a,b);a.prototype.contains=function(a,b){return this.visible&&this.x<=a&&this.y<=b&&a<this.x+this.w&&b<this.y+this.h};Object.defineProperty(a.prototype,"left",{get:function(){return this.x},
set:function(a){this.w=this.w+this.x-a;this.x=a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"right",{get:function(){return this.x+this.w},set:function(a){this.w=a-this.x},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"top",{get:function(){return this.y},set:function(a){this.h=this.h+this.y-a;this.y=a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"bottom",{get:function(){return this.y+this.h},set:function(a){this.h=a-this.y},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"center",{get:function(){return{x:this.x+this.w/2,y:this.y+this.h/2}},enumerable:!0,configurable:!0});a.prototype.moveTo=function(a,b){this.x=a;this.y=b;return this};a.prototype.moveBy=function(a,b){this.x+=a;this.y+=b;return this};return a}(da),J=function(b){function a(a,e,d,f,g){b.call(this,a,e,d,f);this.drawable=g}x(a,b);a.prototype.onDraw=function(a,b){this.drawable.draw(a,b,this)};return a}(pa),F=function(b){function a(c,e,d,f,g,h,k,l){void 0===
l&&(l=a.defaultDesign);b.call(this,c,e,d,f);this.drawable=g;this.click=h;this.mnemonic=k;this.design=l;this.hover=!1}x(a,b);Object.defineProperty(a.prototype,"enabled",{get:function(){return!0},set:function(a){La(this,"enabled",a)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"state",{get:function(){return this.enabled?this.pressed?2:this.hover?1:0:3},enumerable:!0,configurable:!0});a.prototype.onHover=function(a,b){this.hover=this.contains(a,b);this.pressed=void 0};a.prototype.onDrag=
function(a,b){null!=this.pressed&&(this.pressed=this.contains(a,b))};a.prototype.onDown=function(a,b){this.enabled&&this.contains(a,b)&&(this.pressed=!0)};a.prototype.onUp=function(a,b){var d=this.pressed;this.pressed=void 0;if(d&&this.contains(a,b))this.onClick()};a.prototype.onPress=function(a){this.mnemonic&&0<=this.mnemonic.indexOf(a)&&this.enabled&&(this.pressed=!1,this.onClick())};a.prototype.onClick=function(){var a=this,b=this.click;b&&I.then(function(){return b.call(a)})};a.prototype.onDraw=
function(a,b){this.design.draw(a,b,this)};a.defaultDesign={draw:function(b,e,d){xa(b,d,a.defaultDesign.getStyle(d.state));d.drawable&&d.drawable.draw(b,e,d)},getStyle:function(a){var b={};switch(a){case 0:b.fillStyle=u(0,0,0,.8);b.strokeStyle=l(200,200,200);break;case 1:b.fillStyle=u(0,0,50,.8);b.strokeStyle=l(100,100,200);break;case 2:b.fillStyle=u(0,0,150,.8);b.strokeStyle=l(100,100,255);break;case 3:b.fillStyle=u(200,200,200,.8),b.strokeStyle=l(200,200,200)}return b}};a.IconDesign=function(){function a(b){this.overlay=
b}a.prototype.draw=function(a,b,c){var g=c.drawable;switch(c.state){case 0:g.draw(a,b,c);break;case 1:g.draw(a,b,c,this.overlay,.7);break;case 2:g.draw(a,b,c,this.overlay,.9);break;case 3:g.draw(a,b,c,l(200,200,200),.8)}};return a}();return a}(pa),Jb=function(b){function a(a,e,d,f,g,h,k,l,p,t){void 0===t&&(t=F.defaultDesign);b.call(this,a,e,d,f,h,k,p,t);this.group=g;this.swap=l;g.push(this)}x(a,b);a.prototype.onDrag=function(a,e){var d=this;b.prototype.onDrag.call(this,a,e);var f=this.dragged,g=this.swapping;
if(f&&!g){var h=this.group.find(function(b){return b!==d&&b.contains(a,e)&&!b.swapping});h?(f=performance.now(),this.onSwap(h,f),h.onSwap(this,f),g=this.swapping,this.dragged={xOrig:g.xTo,yOrig:g.yTo},this.swap&&this.swap(h)):null!=f.xDown?(this.x=f.xOrig-f.xDown+a,this.y=f.yOrig-f.yDown+e):this.contains(a,e)?(f.xDown=a,f.yDown=e):(this.pressed=this.dragged=void 0,this.hover=!1)}};a.prototype.onDown=function(a,e){b.prototype.onDown.call(this,a,e);!this.dragged&&this.contains(a,e)&&(this.dragged={xDown:a,
yDown:e,xOrig:this.x,yOrig:this.y})};a.prototype.onUp=function(a,e){if(this.swapping)this.dragged=void 0,b.prototype.onUp.call(this,a,e);else if(this.dragged){var d=this.dragged,f=d.xOrig,d=d.yOrig;this.swapping={start:performance.now(),xFrom:this.x,yFrom:this.y,xTo:f,yTo:d};this.dragged=void 0;if(this.pressed&&(this.pressed=void 0,this.contains(a,e)&&f<=a&&d<=e&&a<f+this.w&&e<d+this.h))this.onClick()}else b.prototype.onUp.call(this,a,e)};a.prototype.onSwap=function(a,b){this.pressed=void 0;this.swapping=
{start:b,xFrom:this.x,yFrom:this.y,xTo:a.dragged?a.dragged.xOrig:a.x,yTo:a.dragged?a.dragged.yOrig:a.y}};a.prototype.onDraw=function(a,e){if(this.swapping){var d=G.clamp(e,this.swapping.start,200);1>d?(d=(1-na(X*d))/2,this.x=this.swapping.xFrom*(1-d)+this.swapping.xTo*d,this.y=this.swapping.yFrom*(1-d)+this.swapping.yTo*d):(this.x=this.swapping.xTo,this.y=this.swapping.yTo,this.swapping=void 0)}b.prototype.onDraw.call(this,a,e)};return a}(F),C=function(b){function a(c,e,d,f,g,h,k,l){void 0===l&&(l=
a.defaultDesign);b.call(this,c,e,d,f);this.columns=g;this.rows=h;this.click=k;this.design=l;this.topRow=0}x(a,b);a.heightOf=function(b,e){void 0===e&&(e=a.defaultDesign);return e.headerHeight+b*e.rowHeight};a.prototype.onHover=function(a,b){this.hover=this.toRowIndex(a,b);this.scrolling=this.dragged=void 0};a.prototype.onDrag=function(a,b){var d=this.design.headerHeight;null!=this.scrolling?this.scrollTo(q(this.rows.length*(b-(this.y+d)-this.scrolling)/(this.h-d))):(d=this.toRowIndex(void 0,b),null!=
d&&null!=this.dragged&&d!==this.dragged&&(f=[this.rows[d],this.rows[this.dragged]],this.rows[this.dragged]=f[0],this.rows[d]=f[1],this.dragged=d,this.sortkeys=this.scrolling=this.hover=void 0));var f};a.prototype.onDown=function(a,b){if(this.contains(a,b)&&(this.hover=this.dragged=this.toRowIndex(a,b),null==this.dragged)){var d=this.design,f=d.headerHeight,g=this.w-d.scrollBarWidth,d=this.y+f;if(this.x<=a&&a<this.x+g&&this.y<=b&&b<d)d=this.toColumnIndex(a),null!=d&&this.sort(d,!!this.sortkeys&&this.sortkeys[0]===
d+1);else if(this.x+g<=a&&a<this.right){var g=this.rows.length,h=this.displayCount,f=this.h-f,k=d+f*this.topRow/g,l=f*h/g;d<=b&&b<k?(this.scrollTo(q(g*(b-d)/f)),k=d+f*this.topRow/g):k+l<=b&&b<this.bottom&&(this.scrollTo(q(g*(b-d)/f)-h+1),k=d+f*this.topRow/g);k<=b&&b<k+l&&(this.scrolling=b-k)}}};a.prototype.onUp=function(a,b){null==this.scrolling&&null!=this.dragged&&this.dragged===this.hover&&(this.click(this.rows[this.dragged],this.dragged),this.refresh());this.scrolling=this.dragged=void 0;this.hover=
this.toRowIndex(a,b)};a.prototype.onPress=function(a){switch(a){case k.PAGE_DOWN:this.scrollBy(this.scrollStep);break;case k.PAGE_UP:this.scrollBy(-this.scrollStep)}};a.prototype.onDraw=function(a,b){var d=this.design,f=d.headerHeight,g=d.scrollBarWidth,h=this.rows.length,k=this.displayCount,l=this.x,p=this.y+f,t=this.w-g,q=this.h-f,v=this.x+t,U=(0<h&&q*this.topRow/h||0)+p,M=0<h&&q*k/h||q,sb=this.defaultColumnWidth;d.drawHeader(a,this.x,this.y,this.w,f);d.drawBackground(a,this.x,p,t,q);0<g&&(d.drawHeader(a,
v,p,g,q),k<h&&d.drawScrollBar(a,v,U,g,M));a.save();a.font=d.rowFont;a.fillStyle=d.rowStyle;a.textBaseline="middle";for(var M=d.rowHeight,Q=0;Q<k;++Q){var g=Q+this.topRow,tb=this.rows[g],ka=p+M*Q;g===this.dragged?d.drawRowDragged(a,this.x,ka,t,M):tb===this.selected?d.drawRowSelected(a,this.x,ka,t,M):g===this.hover&&null==this.dragged&&d.drawRowHover(a,this.x,ka,t,M);for(var xb=0,g=0,h=this.columns.length;g<h;++g){var v=this.columns[g],U=ba(v.width,sb),Aa=this.extract(tb,v);if(null!=Aa){var qa=l+xb+
2,nb=U-4;a.textAlign=v.align||"left";switch(a.textAlign){case "center":qa+=nb/2;break;case "right":qa+=nb}a.fillText(Aa,qa,ka+M/2,nb)}xb+=U}}a.restore();a.save();M=0;a.font=d.headerFont;a.fillStyle=d.headerStyle;a.textAlign="center";a.textBaseline="middle";a.strokeStyle=d.lineStyle;g=0;for(h=this.columns.length;g<h;++g)v=this.columns[g],U=ba(v.width,sb),Q=l+M,0<g&&(a.beginPath(),a.moveTo(Q,p),a.lineTo(Q,this.bottom),a.stroke()),a.fillText(v.name.localized,Q+U/2,this.y+f/2),M+=U;a.restore();0===k&&
0<q&&d.emptyText&&(a.save(),d.emptyFont&&(a.font=d.emptyFont),a.textAlign="center",a.textBaseline="middle",d.emptyStyle&&(a.fillStyle=d.emptyStyle),a.fillText(d.emptyText.localized,this.x+t/2,p+q/2),a.restore())};Object.defineProperty(a.prototype,"displayCount",{get:function(){var a=this.design;return O(q((this.h-a.headerHeight)/a.rowHeight),this.rows.length)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"scrollStep",{get:function(){return V(q(.2*this.displayCount),1)},enumerable:!0,
configurable:!0});a.prototype.extract=function(a,b){var d=b.extract;switch(typeof d){case "function":return d(a);case "number":return a[d];default:return a[d]}};a.prototype.compare=function(a,b){var d=this.sortkeys,f=this.columns,g=0;if(d)for(var h=0,k=d.length;0===g&&h<k;++h){var l=d[h],g=f[(0<l?l:-l)-1],g=g.compare?g.compare(a,b):ga(this.extract(a,g),this.extract(b,g));0>l&&(g=-g)}return g};a.prototype.sort=function(a,b){var d=this;void 0===b&&(b=!1);var f=a+1;if(this.sortkeys){for(var g=0,h=this.sortkeys.length;g<
h;++g){var k=this.sortkeys[g];if(k===f||k===-f){this.sortkeys.splice(g,1);break}}this.sortkeys.unshift(b?-f:f)}else this.sortkeys=[b?-f:f];this.rows.sort(function(a,b){return d.compare(a,b)})};a.prototype.toRowIndex=function(a,b){var d=this.design,f=this.w-d.scrollBarWidth;if(void 0===a||this.x<=a&&a<this.x+f)if(d=this.topRow+q((b-this.y-d.headerHeight)/d.rowHeight),this.topRow<=d&&d<this.rows.length)return d};a.prototype.toColumnIndex=function(a){for(var b=this.defaultColumnWidth,d=this.x,f=0,g=
this.columns.length;f<g;++f){var h=ba(this.columns[f].width,b);if(d<=a&&a<d+h)return f;d+=h}};Object.defineProperty(a.prototype,"defaultColumnWidth",{get:function(){for(var a=this.w-this.design.scrollBarWidth,b=0,d=0,f=0,g=this.columns;f<g.length;f++){var h=g[f];null!=h.width?b+=h.width:++d}return 0<d&&b<a?(a-b)/d:0},enumerable:!0,configurable:!0});a.prototype.refresh=function(){var a=this.rows.length;this.dragged>=a&&(this.dragged=void 0);this.hover>=a&&(this.hover=void 0);this.scrollTo(this.topRow)};
a.prototype.scrollTo=function(a){this.topRow=fa(0,this.rows.length-this.displayCount,a)};a.prototype.scrollBy=function(a){this.scrollTo(this.topRow+a)};a.defaultDesign={rowHeight:28,rowFont:ha(20),rowStyle:"white",headerHeight:24,headerFont:ha(18),headerStyle:"white",scrollBarWidth:14,lineStyle:l(102,102,102),drawHeader:function(a,b,d,f,g){a.save();a.fillStyle=u(25,25,25,.8);a.fillRect(b,d,f,g);a.restore()},drawBackground:function(a,b,d,f,g){a.save();a.fillStyle=u(0,0,0,.6);a.fillRect(b,d,f,g);a.restore()},
drawScrollBar:function(a,b,d,f,g){ya(a,b,d,f,g,l(100,100,100),l(75,75,75))},drawRowDragged:function(a,b,d,f,g){ya(a,b,d,f,g,l(255,0,0),l(50,0,0))},drawRowSelected:function(a,b,d,f,g){ya(a,b,d,f,g,l(100,0,0),l(50,0,0))},drawRowHover:function(a,b,d,f,g){ya(a,b,d,f,g,l(75,0,0),l(50,0,0))}};return a}(pa),yb=function(){function b(a,b,e){this.min=b;this.max=e;this.value=a}Object.defineProperty(b.prototype,"value",{get:function(){return this._value},set:function(a){this._value=fa(this.min,this.max,wa(a))},
enumerable:!0,configurable:!0});b.prototype.toString=function(){return this._value.toString()};b.prototype.valueOf=function(){return this._value};return b}(),Eb=function(b){function a(c,e,d,f,g,h){void 0===h&&(h=a.defaultDesign);b.call(this,c,e,d,f);this.value=g;this.design=h;this.hover=this.dragged=!1}x(a,b);a.prototype.getValueAsX=function(){var a=this.design.knobWidth,b=this.value,d=b.min;return this.x+a/2+(b.value-d)/(b.max-d)*(this.w-a)};a.prototype.setValueByX=function(a){var b=this.design.knobWidth;
a=fa(0,1,(a-this.x-b/2)/(this.w-b));var b=this.value,d=b.min;this.value.value=wa(d+a*(b.max-d))};a.prototype.onHover=function(a,b){this.hover=this.contains(a,b);this.dragged=!1};a.prototype.onDrag=function(a,b){this.hover=this.dragged&&this.contains(a,b);this.dragged&&this.setValueByX(a)};a.prototype.onDown=function(a,b){this.contains(a,b)&&(this.dragged=!0,this.setValueByX(a))};a.prototype.onUp=function(a,b){this.dragged=!1};a.prototype.onDraw=function(a,b){this.design.draw(a,b,this)};Object.defineProperty(a.prototype,
"knob",{get:function(){var a=this.design.knobWidth,b=this.h;return{x:this.getValueAsX()-a/2,y:this.y-(this.h-b)/2,w:a,h:b,state:this.dragged?2:this.hover?1:0}},enumerable:!0,configurable:!0});a.defaultDesign={knobWidth:12,draw:function(a,b,d){xa(a,d,{fillStyle:u(50,50,50,.8),strokeStyle:"white",lineWidth:4});b=d.knob;d={strokeStyle:"white",lineWidth:4};switch(b.state){case 0:d.fillStyle=u(150,150,150,.8);break;case 1:d.fillStyle=u(200,200,200,.8);break;case 2:d.fillStyle=u(255,255,255,.8)}xa(a,b,
d)}};return a}(pa),Kb=function(b){function a(a,e,d,f,g,h){b.call(this,a,e,d,f);this.duration=g;this.style=h;this.logs=[]}x(a,b);a.prototype.onDraw=function(a,b){var d=this.logs;if(0<d.length){var f=b-this.duration,g=d.findIndex(function(a){return a.when>f});0>g?d.length=0:d.splice(0,g);g=d.length;if(0<g)for(var h=this.style,k=1.2*(h&&h.fontSize||24),l=0;l<g;++l)ja(a,d[l].message,this.x,this.y+l*k,this.w,k,h)}};a.prototype.log=function(a){if(a){var b=performance.now(),d=this.logs,f=d.length;0<f&&d[f-
1].message===a?d[f-1].when=b:d.push({message:ta(a),when:b})}};a.prototype.error=function(a){this.log(a)};return a}(pa);K.path="assets/lang/";K.languages.en=void 0;K.languages.ja=void 0;var eb={bkgnd:u(0,0,0,.6),delta:l(255,51,0),normal:l(153,204,0),full:l(0,204,51)},zb={bkgnd:u(0,0,0,.6),delta:l(0,51,102),normal:l(0,153,204),full:l(0,153,255)},Ba=[{PICK:0,WALK:!1,POPUP:!1},{PICK:0,WALK:!1,POPUP:!0},{PICK:0,WALK:!0,POPUP:!0},{PICK:300,WALK:!0,POPUP:!0}],ub=[k.BACKSPACE,k.TAB,k.ENTER,k.ESCAPE,k.SPACE,
k.DELETE],ob=[k.ENTER,k.SPACE,k.Y],pb=[k.BACKSPACE,k.TAB,k.ESCAPE,k.DELETE,k.N],Fb=[k.ESCAPE],Lb=[k.ENTER,k.SPACE],Ca=[k.BACKSPACE,k.TAB,k.ESCAPE,k.DELETE],Mb=[k.PAGE_UP,k.HOME,k.LEFT,k.UP],Nb=[k.PAGE_DOWN,k.END,k.RIGHT,k.DOWN],D,p,Ob={Warrior:{INT:4,DEX:4,STR:7,equipments:["Mace","PlateArmor","Mace","FirstAidKit"],skills:["Swing","Crash","Bash","PathToWarrior","PotionOfRegeneration"],image:"nazrin"},Samurai:{INT:3,DEX:7,STR:5,equipments:["Katana","Chainmail","FirstAidKit"],skills:["Swing","Slash",
"CutThrough","Sweep","PotionOfHealth"],image:"rin"},Knight:{INT:6,DEX:2,STR:7,equipments:["Spear","LamellarArmor","KiteShield"],skills:["Swing","Stab","Thrust","ShieldBash","ShieldCharge"],image:"toramaru"},Thief:{INT:3,DEX:6,STR:6,equipments:["LongBow","LetherArmor","FirstAidKit"],skills:["Shoot","PoisonArrow","FirstAid"],image:"marisa"},Healer:{INT:7,DEX:3,STR:5,equipments:["Staff","Robe"],skills:["Swing","Heal","PartyHeal"],image:"reimu"},Mage:{INT:8,DEX:4,STR:3,equipments:["Wand","Robe"],skills:["FireBall",
"IceSpear","DrainLife","LightningLaser","FireNova"],image:"utsuho"}},Ab={Ant:{INT:3,DEX:3,STR:4,equipments:["Dagger","LetherArmor"],skills:["Swing"],image:"ant.png"},Elemental:{INT:4,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["FireBall","ResistFire"],image:"elemental.png"},Frog:{INT:4,DEX:4,STR:4,equipments:["ShortBow","LetherArmor"],skills:["Shoot"],image:"frog.png"},Plant:{INT:4,DEX:3,STR:4,equipments:["Wand","LetherArmor"],skills:["FireNova"],image:"plant.png"},Slug:{INT:3,DEX:3,STR:3,
equipments:["Wand","LetherArmor"],skills:["DrainLife"],image:"slug.png"},Snail:{INT:3,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["Heal"],image:"snail.png"},Sword:{INT:3,DEX:5,STR:4,equipments:["LongSword","LetherArmor"],skills:["Swing"],image:"sword.png"},Wall:{INT:2,DEX:2,STR:6,equipments:["Mace","LetherArmor"],skills:["Swing"],image:"wall.png"},Weasel:{INT:3,DEX:6,STR:3,equipments:["Spear","LetherArmor"],skills:["Thrust"],image:"weasel.png"}},Pb={AddedFire:{tags:[0,1,2],min:5,max:10,
ATK:function(b,a){return a+b}}},aa={Dagger:{tags:[0,5],weight:13,price:100,ATK:30},ShortSword:{tags:[0,5],weight:15,price:100,ATK:40},LongSword:{tags:[0,5],weight:16,price:100,ATK:50},Katana:{tags:[0,5],weight:15,price:100,ATK:45},Axe:{tags:[0,5,6],weight:18,price:100,ATK:45},Mace:{tags:[0,6],weight:16,price:100,ATK:40},Spear:{tags:[0,7],weight:20,price:100,ATK:50},Halberd:{tags:[0,5,6,7],weight:30,price:100,ATK:50},ShortBow:{tags:[2,7],weight:18,price:100,ATK:30},LongBow:{tags:[2,7],weight:20,price:100,
ATK:40},Staff:{tags:[0,6,3],weight:20,price:100,ATK:20},Wand:{tags:[3],weight:16,price:100,ATK:25},FirstAidKit:{tags:[4],weight:10,price:100,ATK:20},Buckler:{tags:[8],weight:20,price:100,ATK:10,DEF:10},RoundShield:{tags:[8],weight:25,price:100,ATK:15,DEF:15},SpikedShield:{tags:[8],weight:30,price:100,ATK:30,DEF:15},KiteShield:{tags:[8],weight:35,price:100,ATK:20,DEF:20},TowerShield:{tags:[8],weight:40,price:100,ATK:30,DEF:20},Circlet:{tags:[9],weight:5,price:100,DEF:2},LeatherHood:{tags:[9],weight:10,
price:100,DEF:4},Mask:{tags:[9],weight:15,price:100,DEF:6},Sallet:{tags:[9],weight:20,price:100,DEF:8},Bascinet:{tags:[9],weight:25,price:100,DEF:10},Helmet:{tags:[9],weight:30,price:100,DEF:12},Robe:{tags:[10],weight:20,price:100,DEF:10},LetherArmor:{tags:[10],weight:25,price:100,DEF:15},ScaleArmor:{tags:[10],weight:30,price:100,DEF:20},Chainmail:{tags:[10],weight:35,price:100,DEF:22},LamellarArmor:{tags:[10],weight:40,price:100,DEF:25},PlateArmor:{tags:[10],weight:45,price:100,DEF:30},Gloves:{tags:[11],
weight:10,price:100,DEF:4},Mittens:{tags:[11],weight:20,price:100,DEF:6},Gauntlets:{tags:[11],weight:30,price:100,DEF:8},Slippers:{tags:[12],weight:5,price:100,DEF:2},Sandals:{tags:[12],weight:10,price:100,DEF:4},Shoes:{tags:[12],weight:15,price:100,DEF:6},Boots:{tags:[12],weight:20,price:100,DEF:8},Greaves:{tags:[12],weight:25,price:100,DEF:10}},Qb={Dummy:{tags:[],usage:2,power:0,cost:999,range:0,effect:"Damage",action:"Charge"},Swing:{tags:[0],usage:2,power:100,cost:14,range:1,effect:"Damage",action:"Charge"},
Slash:{tags:[0,5],usage:2,power:110,cost:15,range:1,effect:"Damage",action:"Charge"},CutThrough:{tags:[0,5],usage:2,power:100,cost:20,range:1,effect:"Damage",action:"GoBehind"},Sweep:{tags:[0,5],usage:6,power:100,cost:20,range:1,effect:"Damage",action:"Nova"},Crash:{tags:[0,6],usage:2,power:110,cost:15,range:1,effect:"Damage",action:"Charge"},Bash:{tags:[0,6],usage:2,power:100,cost:20,range:1,effect:"Damage",action:"Knockback"},Stab:{tags:[0,7],usage:2,power:110,cost:15,range:1,effect:"Damage",action:"Charge"},
Thrust:{tags:[0,7],usage:4,power:100,cost:15,range:2,effect:"Damage",action:"Laser"},ShieldBash:{tags:[8],usage:2,power:100,cost:20,range:1,effect:"Damage",action:"Charge"},ShieldCharge:{tags:[8],usage:2,power:100,cost:24,range:1,effect:"Damage",action:"Trample"},Shoot:{tags:[2],usage:2,power:100,cost:20,range:3,effect:"Damage",action:"Shoot"},PoisonArrow:{tags:[2],usage:2,power:60,cost:20,range:3,effect:"DamageOverTime",action:"Shoot"},IceSpear:{tags:[3,14],usage:2,power:80,cost:16,range:5,effect:"DamageHPandSP",
action:"Shoot"},DrainLife:{tags:[3,16],usage:2,power:80,cost:16,range:5,effect:"Damage",action:"Drain"},FireBall:{tags:[3,13],usage:2,power:100,cost:16,range:5,effect:"Damage",action:"Explode"},LightningLaser:{tags:[3,15],usage:4,power:100,cost:16,range:5,effect:"Damage",action:"Laser"},FireNova:{tags:[3,13],usage:6,power:100,cost:16,range:2,effect:"Damage",action:"Nova"},Heal:{tags:[3,16],usage:3,power:100,cost:24,range:3,effect:"Heal",action:"Shoot"},PartyHeal:{tags:[3,16],usage:7,power:100,cost:24,
range:1,effect:"Heal",action:"Nova"},FirstAid:{tags:[4,16],usage:3,power:50,cost:24,range:1,effect:"HealOverTime",action:"Charge"},PotionOfHealth:{tags:[4,16],usage:1,power:100,cost:24,effect:"Heal",action:"Dose"},PotionOfRegeneration:{tags:[4,16],usage:1,power:75,cost:24,effect:"HealOverTime",action:"Dose"},PathToWarrior:{tags:[0],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},PathToNinja:{tags:[1],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},PathToArcher:{tags:[2],usage:0,power:2,
cost:10,effect:"Aura",action:"Offence"},PathToMage:{tags:[3],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},PathToAlchemist:{tags:[4],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},Defence:{tags:[0],usage:0,power:2,cost:10,effect:"Aura",action:"Defence"},Dodge:{tags:[1,2],usage:0,power:2,cost:10,effect:"Aura",action:"Defence"},Meditation:{tags:[3],usage:0,power:2,cost:10,effect:"Aura",action:"Defence"},Healthy:{tags:[4],usage:0,power:2,cost:10,effect:"Aura",action:"Defence"},AvatarOfFire:{tags:[13],
usage:0,power:4,cost:10,effect:"Aura",action:"Offence"},AvatarOfCold:{tags:[14],usage:0,power:4,cost:10,effect:"Aura",action:"Offence"},AvatarOfLightning:{tags:[15],usage:0,power:4,cost:10,effect:"Aura",action:"Offence"},ResistFire:{tags:[13],usage:0,power:4,cost:10,effect:"Aura",action:"Defence"},ResistCold:{tags:[14],usage:0,power:4,cost:10,effect:"Aura",action:"Defence"},ResistLightning:{tags:[15],usage:0,power:4,cost:10,effect:"Aura",action:"Defence"}},Qa,Rb=za([0,1,2,3,4,5,6,7]),Sb=za([8,9,10,
11,12]),Da=function(){function b(a){this.EID=a;this.def=Pb[a];if(!this.def)throw new RangeError('Enchantment not found: "'+a+'"');this.name=b.nameOf(a);this.spec=b.specOf(a);this.value=this.def.min+Ja(this.def.max-this.def.min)}b.prototype.qualify=function(a){return Ka(this.name.localized,a)};b.prototype.modify=function(a){this.def.ATK&&(a=this.def.ATK(this.value,a));return a};b.nameOf=function(a){return h("Enchant",a,"Name")};b.specOf=function(a){return h("Enchant",a,"Spec")};b.from=function(a){return new b(a)};
b.fromJSON=function(a){return new b(a.EID)};b.prototype.toJSON=function(){return{EID:this.EID,value:this.value}};return b}(),la=function(){function b(a,c){this.IID=a;this.def=aa[a];if(!this.def)throw new RangeError('Item not found: "'+a+'"');this.baseName=b.nameOf(a);this.spec=b.specOf(a);this.tagbits=za(this.def.tags);this.enchants=c?c:this.def.enchants?this.def.enchants.map(Da.from):[]}Object.defineProperty(b.prototype,"name",{get:function(){for(var a=this.baseName.localized,b=0,e=this.enchants;b<
e.length;b++)a=e[b].qualify(a);return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"tags",{get:function(){return this.def.tags},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"weight",{get:function(){return this.def.weight},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"priceToSell",{get:function(){for(var a=this.def.price,b=0,e=this.enchants;b<e.length;b++)a=e[b].modify(a);return q(a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"ATK",{get:function(){for(var a=this.def.ATK||0,b=0,e=this.enchants;b<e.length;b++)a=e[b].modify(a);return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"DEF",{get:function(){for(var a=this.def.DEF||0,b=0,e=this.enchants;b<e.length;b++)a=e[b].modify(a);return a},enumerable:!0,configurable:!0});b.nameOf=function(a){return h("Item",a,"Name")};b.specOf=function(a){return h("Item",a,"Spec")};b.from=function(a){return new b(a)};b.fromJSON=function(a){return new b(a.IID,N(Da,a.enchants,
void 0))};b.prototype.toJSON=function(){return{IID:this.IID,enchants:sa(this.enchants,void 0)}};return b}(),fb=function(){function b(a){this.SID=a;this.def=Qb[a];if(!this.def)throw new RangeError('Skill not found: "'+a+'"');this.name=b.nameOf(a);this.spec=b.specOf(a);this.tagbits=za(this.def.tags)}Object.defineProperty(b.prototype,"tags",{get:function(){return this.def.tags},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"rawCost",{get:function(){return this.def.cost},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"rawRange",{get:function(){return this.def.range},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"rawPower",{get:function(){return this.def.power},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"usage",{get:function(){return this.def.usage},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hostile",{get:function(){var a;a:switch(this.def.usage){case 3:case 5:case 7:a=!1;break a;default:a=!0}return a},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"effect",{get:function(){return this.def.effect},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"action",{get:function(){return this.def.action},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"isActive",{get:function(){return"Aura"!==this.effect},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"isPassive",{get:function(){return"Aura"===this.effect},enumerable:!0,configurable:!0});
b.prototype.match=function(a){var b=this.tagbits&Rb;return(b&a.tagbits)===b};b.nameOf=function(a){return h("Skill",a,"Name")};b.specOf=function(a){return h("Skill",a,"Spec")};b.from=function(a){return new b(a)};b.fromJSON=function(a){return new b(a.SID)};b.prototype.toJSON=function(){return{SID:this.SID}};b.DUMMY=new b("Dummy");return b}(),Bb=[1,2,3,4,5,5,5,5,4,3,2,1],Ea;(function(b){b[b.DEFAULT=0]="DEFAULT";b[b.BLINK_1=1]="BLINK_1";b[b.BLINK_2=2]="BLINK_2";b[b.BLINK_3=3]="BLINK_3";b[b.BLINK_4=4]=
"BLINK_4";b[b.CLOSED=5]="CLOSED";b[b.DEAD=6]="DEAD"})(Ea||(Ea={}));var Z=function(){function b(a,b,e,d,f,g,h,k,l){function p(){for(var a=[],b=0;b<arguments.length;b++)a[b-0]=arguments[b];var b=a[0],c=b.w,d=b.h,b=document.createElement("canvas");b.width=c;b.height=d;var e=b.getContext("2d");if(e)for(c={x:0,y:0,w:c,h:d},d=0;d<a.length;d++)a[d].draw(e,void 0,c);return z.from(b)}function t(a){var b=q[0],c=b.w,d=b.h,b=document.createElement("canvas");b.width=c;b.height=d;var e=b.getContext("2d");if(e){var f=
{x:0,y:0,w:c,h:d};if(void 0!==e.filter)e.save(),e.filter="grayscale(100%)",a.draw(e,void 0,f),e.restore();else{a.draw(e,void 0,f);a=e.getImageData(0,0,c,d);for(var c=a.data,d=a.width,f=a.height,g=0;g<f;++g)for(var h=0;h<d;++h){var k=4*g*d+4*h,l=.2126*c[k]+.7152*c[k+1]+.0722*c[k+2];c[k]=l;c[k+1]=l;c[k+2]=l}e.putImageData(a,0,0,0,0,d,f)}}return z.from(b)}this.name=a;this.level=b;this.INT=e;this.DEX=d;this.STR=f;this.equipments=g;this.skills=h;this.known=k;this.src=l;var q=[];a=0>l.indexOf("/")?"assets/char/"+
l:l;if(l.endsWith(".png"))l=new z(a),q[0]=l;else{var v=[new z(a+"/back.png"),new z(a+"/eye.png"),new z(a+"/eye1.png"),new z(a+"/eye2.png"),new z(a+"/eye3.png"),new z(a+"/eye4.png"),new z(a+"/eye5.png"),new z(a+"/fore.png")];va(v).then(function(){q.push(p(v[0],v[1],v[7]),p(v[0],v[2],v[7]),p(v[0],v[3],v[7]),p(v[0],v[4],v[7]),p(v[0],v[5],v[7]),p(v[0],v[6],v[7]));q.push(t(q[Ea.CLOSED]))})}this.images=q;this.blinkCycle=4500+100*e;this.blinkOffset=Ja(this.blinkCycle)}Object.defineProperty(b.prototype,"w",
{get:function(){var a=this.images[0];return a?a.w:1},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"h",{get:function(){var a=this.images[0];return a?a.h:1},enumerable:!0,configurable:!0});b.prototype.draw=function(a,b,e,d,f){var h;h=(b+this.blinkOffset)%this.blinkCycle;h=450>h?Bb[q(h/450*Bb.length)]:0;var k=this.images;(h=k[h]||k[Ea.DEFAULT])&&h.draw(a,b,e,d,f)};Object.defineProperty(b.prototype,"HP",{get:function(){return 10*(3+this.STR)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"SP",{get:function(){var a=V(0,this.weight-this.maxWeight);return V(0,4*(3+this.STR)-a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"reservedSP",{get:function(){var a=this;return this.skills.reduce(function(b,e){return b+(e.isPassive?a.costOf(e):0)},0)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"step",{get:function(){return 13-this.DEX},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"ZoC",{get:function(){return 3+this.DEX},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"maxWeight",{get:function(){return 10*(3+this.STR)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"weight",{get:function(){return this.equipments.reduce(function(a,b){return a+b.weight},0)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"DEF",{get:function(){return 100*(1-this.equipments.reduce(function(a,b){return a*(1-b.DEF/100)},1))},enumerable:!0,configurable:!0});b.prototype.costOf=function(a){return a?
a.rawCost-this.INT:void 0};b.prototype.rangeOf=function(a){return a?a.rawRange:void 0};b.prototype.powerOf=function(a){var b=this.itemFor(a);return b?b.ATK*a.rawPower/100:void 0};b.prototype.itemFor=function(a){var b=void 0;if(a)for(var e=0,d=0,h=this.equipments;d<h.length;d++){var g=h[d];if(a.match(g)){var k=g.ATK;e<k&&(e=k,b=g)}}return b};b.adventurer=function(a){var c=Ob[a];if(!c)throw new RangeError('Adventurer not found: "'+a+'"');return b.from(h("Adventurer",a),0,c)};b.monster=function(a,c){var e=
Ab[a];if(!e)throw new RangeError('Monster not found: "'+a+'"');return b.from(h("Monster",a),c,e)};b.from=function(a,c,e){return new b(a.localized,c,e.INT,e.DEX,e.STR,e.equipments.map(la.from),e.skills.map(fb.from),[],e.image)};b.fromJSON=function(a){return new b(a.name,a.level||0,a.INT,a.DEX,a.STR,N(la,a.equipments,void 0),N(fb,a.skills,void 0),N(fb,a.known,void 0),a.image)};b.prototype.toJSON=function(){return{name:this.name,level:this.level,INT:this.INT,DEX:this.DEX,STR:this.STR,equipments:sa(this.equipments,
void 0),skills:sa(this.skills,void 0),known:sa(this.known,void 0),image:this.src}};return b}(),ra;(function(b){var a=function(a){function b(){var d=this;a.call(this);(new J(0,0,1280,720,new z("assets/scene/title.jpg"))).attach(this);var f=$a(),g,k;f?(g=h("Title","Continue"),k=function(){return S.go(d,new Fa.Home(f))},(new F(1070,650,200,60,new B(h("Title","Delete")),function(){Ra.confirm(d,h("Title","ConfirmDelete"),{label:h("Title","Delete"),click:function(){try{System.setRoamingStorage("NYO",void 0)}catch(a){D.error(a)}S.go(d,
new b);D.log(h("Title","NotifyDelete"))},mnemonic:ob},{label:h("Config","Cancel"),mnemonic:pb})})).attach(this)):(g=h("Title","New"),k=function(){var a={},b;for(b in aa){var c=Ja(4);0<c&&(a[b]=c)}a={shop:a,warehouse:[],reservers:[],party:[Z.adventurer("Knight"),Z.adventurer("Warrior"),Z.adventurer("Samurai"),Z.adventurer("Mage"),Z.adventurer("Healer"),Z.adventurer("Thief")],gold:1E3};a.party[0].equipments[0].enchants.push(Da.from("AddedFire"));bb(a);S.go(d,new Fa.Home(a))});(new F(480,504,320,72,
new B(g),k,Lb)).attach(this);(new F(480,612,320,72,new B(h("Title","Quit")),System.exit)).attach(this);kb(this)}x(b,a);return b}(R);b.Scene=a})(ra||(ra={}));var Fa;(function(b){function a(){return[{name:h("Character","Name"),extract:function(a){return a.name},width:200},{name:h("Character","INT"),extract:function(a){return a.INT},width:60,align:"right"},{name:h("Character","DEX"),extract:function(a){return a.DEX},width:60,align:"right"},{name:h("Character","STR"),extract:function(a){return a.STR},
width:60,align:"right"}]}function c(a){return[{name:a,extract:function(a){return a.name},width:200},{name:h("Town","Tags"),extract:function(a){return Za(a.tags)}},{name:h("Town","Weight"),extract:function(a){return a.weight},width:60,align:"right"},{name:h("Town","ATK"),extract:function(a){return a.ATK},width:60,align:"right"},{name:h("Town","DEF"),extract:function(a){return a.DEF},width:60,align:"right"}]}function e(a,b){var d=b.shop,e=c(a);e.push({name:h("Town","Stock"),extract:function(a){return ba(d[a.IID],
h("Town","New"))},width:60,align:"right"});return e}function d(a,b){var c=b.shop,d=b.warehouse;return[{name:a,extract:function(a){return la.nameOf(a).localized},width:200},{name:h("Town","Tags"),extract:function(a){return Za(aa[a].tags)}},{name:h("Town","ATK"),extract:function(a){return aa[a].ATK},width:60,align:"right"},{name:h("Town","DEF"),extract:function(a){return aa[a].DEF},width:60,align:"right"},{name:h("Town","Weight"),extract:function(a){return aa[a].weight},width:60,align:"right"},{name:h("Town",
"Stock"),extract:function(a){return c[a]},width:60,align:"right"},{name:h("Town","Owned"),extract:function(a){return d.reduce(function(b,c){return c.IID===a?b+1:b},0)},width:60,align:"right"}]}function f(a){return[{name:a,extract:function(a){return a.name.localized},width:200},{name:h("Town","Required"),extract:function(a){return Za(a.tags)}},{name:h("Town","Cost"),extract:function(a){return a.rawCost},width:60,align:"right"},{name:h("Town","Range"),extract:function(a){return a.rawRange},width:60,
align:"right"},{name:h("Town","Power"),extract:function(a){return a.rawPower},width:60,align:"right"},{name:h("Town","Spec"),extract:function(a){return a.spec.localized}}]}var g={fontSize:64,fillStyle:l(255,255,255),strokeStyle:l(0,0,0),textAlign:"center",textBaseline:"middle",lineWidth:2},p=function(){function a(b,c){this.party=b;this.index=c}a.prototype.draw=function(a,b,c){var d=c.x,e=c.y,h=c.w;c=c.h;var f=this.party[this.index];a.save();if(f){var k=Na(f,140,184);f.draw(a,b,{x:d+h/2-k.w/2,y:e+
92-k.h/2,w:k.w,h:k.h});var p=this.party.reduce(function(a,b){return b?V(a,b.HP):a},1);b=f.HP;var k=d+10,m=h-20,q=e+c-30,p=(m-2)*b/p;a.strokeStyle="black";a.fillStyle=eb.full;a.fillRect(k,q,p,6);a.strokeRect(k,q,p,6);ja(a,b.toString(),k+4,q-20,m,20,{fontSize:20,fillStyle:l(255,255,255),strokeStyle:l(0,0,0),textAlign:"left",textBaseline:"bottom",lineWidth:2});ja(a,f.name,d,e+c-24,h,24,{fontSize:24,fillStyle:l(255,255,255),strokeStyle:l(0,0,0),textAlign:"center",textBaseline:"bottom",lineWidth:2})}else ja(a,
(this.index+1).toString(),d,e,h,c,g);a.restore()};return a}(),m=function(a){function b(c){a.call(this);this.data=c}x(b,a);b.prototype.addButton=function(a,b,c,d){a=new F(1280-170*a,665,160,45,new B(c),d,b);a.attach(this);return a};b.prototype.goTo=function(a){S.go(this,new a(this.data))};return b}(R),u=function(a){function b(c,d){a.call(this,c);(new J(0,0,1280,720,new z("assets/scene/"+d))).attach(this);kb(this);for(var e=c.party,h=this,f=[],g=0;6>g;++g){var l=q(g/3);(new Jb(10+170*(1-l),10+g%3*214+
68*l,160,204,f,new p(e,g),function(){h.onPortraitClick(this.drawable.index)},function(a){var b=this.drawable;a=a.drawable;c=[e[a.index],e[b.index]];e[b.index]=c[0];e[a.index]=c[1];c=[a.index,b.index];b.index=c[0];a.index=c[1];var c},[k.$1+g])).attach(this)}}x(b,a);return b}(m),I=function(a){function b(c){var d=this;a.call(this,c,"town.jpg");var e=["grass","moss"],f=Ja(e.length);this.addSpot(5,k.A,"Guild",function(){}).enabled=!1;this.addSpot(4,k.B,"Tavern",function(){return d.goTo(t)});this.addSpot(3,
k.C,"Shop",function(){return d.goTo(G)});this.addSpot(2,k.D,"Smith",function(){}).enabled=!1;this.addSpot(1,k.E,"Dungeon",function(){S.go(d,new Ga.Scene(c,new Ga.EndressStage(e[f],0)))}).enabled=c.party.some(function(a){return!!a});this.addButton(2,[k.L],h("Town","Load"),function(){Ra.confirm(d,h("Town","ConfirmLoad"),{label:h("Town","Load"),click:function(){var a=$a();a&&(S.go(d,new b(a)),D.log(h("Town","NotifyLoad")))},mnemonic:ob},{label:h("Config","Cancel"),mnemonic:pb})});this.addButton(1,[k.S],
h("Town","Save"),function(){bb(d.data);D.log(h("Town","NotifySave"))})}x(b,a);b.prototype.onPortraitClick=function(a){this.data.party[a]&&S.go(this,new v(this.data,a))};b.prototype.addSpot=function(a,b,c,d){a=new F(950,665-100*a,320,90,new B(h("Town",c)),d,[b]);a.attach(this);return a};return b}(u);b.Home=I;var t=function(b){function c(d){function e(a,b){(c=Array.prototype.splice).call.apply(c,[a,0,a.length].concat(b));var c}var f=this;b.call(this,d,"tavern.jpg");var g=d.party.concat(),l=d.reservers.concat();
this.addButton(3,[k.C],h("Town","Clear"),function(){for(var a=0;6>a;++a){var b=d.party[a];b&&(d.reservers.push(b),d.party[a]=void 0)}});this.addButton(2,[k.R],h("Town","Revert"),function(){e(d.party,g);e(d.reservers,l)});this.addButton(1,Ca,h("Town","Back"),function(){return f.goTo(I)});(new C(350,10,920,C.heightOf(10),a(),d.reservers,function(a,b){return f.onReserverClick(a,b)})).attach(this)}x(c,b);c.prototype.onPortraitClick=function(a){var b=this.data.party[a];b&&(this.data.party[a]=void 0,this.data.reservers.push(b))};
c.prototype.onReserverClick=function(a,b){for(var c=0;6>c;++c)if(!this.data.party[c]){this.data.party[c]=a;this.data.reservers.splice(b,1);return}D.error(h("Town","PartyFull"))};return c}(u),G=function(a){function b(c){var f=this;a.call(this,c,"shop.jpg");var g=c.shop,l=c.warehouse,p=new C(350,10,920,C.heightOf(10),d(h("Town","Buy"),c),Ma(g),function(a){if(0>=g[a])D.error(h("Town","SoldOut"));else{var b=aa[a].price;if(c.gold<b)D.error(h("Town","NoMoney"));else{var d=new la(a);--g[a];l.push(d);c.gold-=
b;D.log(Ka(h("Town","NotifyBuy").localized,d.name,b))}}});p.attach(this);var m=new C(350,10,920,C.heightOf(10),e(h("Town","Sell"),c),l,function(a,b){var d=a.IID,e=a.priceToSell;l.splice(b,1);var f=g[d];null==f?(g[d]=1,p.rows.push(d)):g[d]=1+f;c.gold+=e;D.log(Ka(h("Town","NotifySell").localized,a.name,e))});m.attach(this);var q,t;q=this.addButton(3,[k.B],h("Town","Buy"),function(){p.visible=!0;m.visible=!1;q.enabled=!1;t.enabled=!0});t=this.addButton(2,[k.S],h("Town","Sell"),function(){p.visible=!1;
m.visible=!0;q.enabled=!0;t.enabled=!1});this.addButton(1,Ca,h("Town","Back"),function(){return f.goTo(I)});q.onClick()}x(b,a);b.prototype.onPortraitClick=function(a){D.log("TODO: Shop.onPortraitClick: "+a)};return b}(u),v=function(a){function b(d,e){var g=this;a.call(this,d);var l=d.warehouse,p=d.party,m=p[e],q=Na(m,1280,720,!0);(new J(0,0,q.w,q.h,m)).attach(this);(new J(0,0,200,40,new B(m.name+" / Lv: "+m.level))).attach(this);(new J(0,40,200,40,new B("INT: "+m.INT))).attach(this);(new J(100,40,
200,40,new B("DEX: "+m.DEX))).attach(this);(new J(200,40,200,40,new B("STR: "+m.STR))).attach(this);(new J(0,80,200,40,new B(function(){return"HP: "+m.HP}))).attach(this);(new J(0,120,200,40,new B(function(){return"SP: "+m.SP}))).attach(this);(new J(0,160,200,40,new B(function(){return"WT: "+m.weight+"/"+m.maxWeight}))).attach(this);(new J(0,200,200,40,new B(function(){return"DEF: "+m.DEF.toFixed(1)}))).attach(this);var t=new R([new C(350,10,920,C.heightOf(10),c(h("Town","Equipments")),m.equipments,
function(a,b){m.equipments.splice(b,1);l.push(a)}),new C(350,360,920,C.heightOf(10),c(h("Town","Warehouse")),l,function(a,b){l.splice(b,1);var c=m.equipments,d=a.tagbits,e=[],d=d&Sb;if(0!==d)for(var h=0;h<c.length;)0!==(c[h].tagbits&d)?(e.push(c[h]),c.splice(h,1)):++h;m.equipments.push(a);(f=l.push).call.apply(f,[l].concat(e));var f})]);t.attach(this);var v=new R([new C(350,10,920,C.heightOf(10),f(h("Town","Skills")),m.skills,function(a,b){m.skills.splice(b,1);m.known.push(a)}),new C(350,360,920,
C.heightOf(10),f(h("Town","Knowns")),m.known,function(a,b){m.known.splice(b,1);m.skills.push(a)})]);v.attach(this);for(var u=p.length,x=function(a){var c=(e+u-a)%u;if(p[c])return D.addButton(5,Mb,h("Town","Prev"),function(){return S.go(g,new b(g.data,c))}),"break"},D=this,q=1;q<u&&"break"!==x(q);++q);for(var x=function(a){var c=(e+a)%u;if(p[c])return F.addButton(4,Nb,h("Town","Next"),function(){return S.go(g,new b(g.data,c))}),"break"},F=this,q=1;q<u&&"break"!==x(q);++q);var z,G;z=this.addButton(3,
[k.E],h("Town","Equipments"),function(){t.visible=!0;v.visible=!1;G.enabled=!0;z.enabled=!1});G=this.addButton(2,[k.S],h("Town","Skills"),function(){t.visible=!1;v.visible=!0;G.enabled=!1;z.enabled=!0});this.addButton(1,Ca,h("Town","Back"),function(){return g.goTo(I)});z.onClick()}x(b,a);return b}(m)})(Fa||(Fa={}));var Ga;(function(b){function a(a,b){var n=a.xH;return{xH:n+[1,2,1,-1,-2,-1][b],yH:a.yH+(0===n%2?[-1,0,0,0,0,-1]:[0,0,1,1,0,0])[b]}}function c(a,b){var n=a.xH,w=b.xH,c=w-n,n=2*b.yH+w%2-
(2*a.yH+n%2);return 0>n?n>c?(-c-n)/2:n>-c?(c-n)/2:-n:n<c?(c+n)/2:n<-c?(-c+n)/2:n}function e(a,b){return a===b||!!a&&!!b&&a.xH===b.xH&&a.yH===b.yH}function d(a,b,n,w,c,d,e,h,f){var g=fa(0,1,d/e);d=null==h?g:fa(0,1,(d+h)/e);a.save();a.fillStyle=f.bkgnd;a.fillRect(b,n,w,c);b+=1;n+=1;w-=2;c-=2;d>g?(a.fillStyle=1<=g?f.full:f.normal,a.fillRect(b,n,w*g-1,c),a.fillStyle=f.full,a.fillRect(b+w*g,n,w*(d-g),c)):d<g?(e=w*d,0<d&&(e=V(e,2),a.fillStyle=1<=g?f.full:f.normal,a.fillRect(b,n,e-1,c)),a.fillStyle=f.delta,
a.fillRect(b+e,n,w*(g-d),c)):(a.fillStyle=1<=g?f.full:f.normal,a.fillRect(b,n,w*g,c));a.restore()}function f(a,b,n,w,c){b=n.toX(c)+16;n=n.toY(c)+60;d(a,b,n,96,6,w.HP,w.maxHP,void 0,eb)}function g(a,b,n,w,c,e){b=n.toX(c)+16;n=n.toY(c)+60+6;d(a,b,n,96,6,w.SP,w.maxSP,e-w.SP,zb)}function C(a,b,n,c){a=n.tagbits;n=b.powerOf(n);b=b.level+b.getOffenceLevel(a)-c.level-c.getDefenceLevel(a);return Ua(n*(100-c.DEF)/100*ma(U,b))}function m(a,b,n){var c=n.tagbits;n=b.powerOf(n);a=b.level+b.getOffenceLevel(c)-a.getLevel(c);
return Ua(n*ma(U,a))}function K(a){var b=a.tagbits;return 0!==(b&8192)?{r:255,g:128,b:0}:0!==(b&16384)?{r:0,g:128,b:255}:0!==(b&32768)?{r:255,g:255,b:0}:0!==(b&65536)?a.hostile?{r:255,g:0,b:128}:{r:0,g:255,b:128}:{r:255,g:255,b:255}}function N(a,b,n){var w,d=c(b,n)+1;a.straight(b,n,d,function(b,n){n===d&&a.get(b).empty&&(w=b)});return w}function t(a,b,n,c){var d=b.hex,e=n.hex;c=b.estimate(a,n,c);var f=a.promiseEffect(n,c);n=new Ca(a,d,e);b.state=n;n.hit(function(){return f.attach(a)});return p.wait.POPUP?
va([f,n]):n}function P(a,b,n,c){c=K(c);var d=Pa(c),e=Pa(c,0);c=a.toX(b)-a.toX(n);var f=a.toY(b)-a.toY(n);c=100+ma(c*c+f*f,.5)/1280*400;c=new G(c,function(c,w){var f=a.toX(b),h=a.toY(b),g=a.toX(n),qb=a.toY(n);Ya(w,f*(1-c)+g*c+64-20,h*(1-c)+qb*c+40-20,40,40,d,e,.5)});c.attach(a);return c}function v(a,b,n,c,d,e){function f(c,w){var d=b.getTarget(h,c);if(d){var A=b.estimate(a,d,n);e&&(null!=A.deltaHP&&(A.deltaHP=e(A.deltaHP,w)),null!=A.deltaHPoT&&(A.deltaHPoT=e(A.deltaHPoT,w)),null!=A.deltaSP&&(A.deltaSP=
e(A.deltaSP,w)));d=a.promiseEffect(d,A);d.attach(a);g.push(d)}}var h=a.field,g=[];f(c,0);h.surround(c,d,f);var r=K(n),k=Pa(r,0),l=new G(400,function(b,n){var y=a.toX(c)+64,e=a.toY(c)+40,f=128*d*b,g=80*d*b,h=Pa(r,1-b);Ya(n,y-f,e-g,2*f,2*g,h,k,b)});l.attach(a);return p.wait.POPUP?(g.push(l),va(g)):l}var U=ma(2,.1),M=[{lineWidth:2,fillStyle:l(0,0,68),strokeStyle:l(204,204,255)},{lineWidth:2,fillStyle:l(68,0,0),strokeStyle:l(255,204,204)}],aa={fillStyle:"white",textAlign:"left",textBaseline:"top"},Q=
u(0,0,0,0),ba=u(0,0,0,.75),ka={inner:l(230,255,180),outer:l(51,230,51)},ga={inner:l(230,180,255),outer:l(51,51,230)},Aa={inner:l(255,180,230),outer:l(230,51,51)},qa={inner:l(230,180,255),outer:l(51,51,230)},ha={outer:l(64,192,255),inner:l(180,232,255),bkgnd:u(64,192,255,.3)},ja={outer:l(255,192,64),inner:l(255,232,192),bkgnd:u(255,192,64,.3)},la={DASH_OR_RANGE:{outer:l(255,64,64),inner:l(255,180,180),bkgnd:u(255,192,64,.3)},RANGE:{outer:l(255,64,64),inner:l(255,180,180),bkgnd:u(255,128,64,.3)},TARGET:{outer:l(255,
24,24),inner:l(255,64,64),bkgnd:u(255,24,24,.3)}},sa={DASH_OR_RANGE:{outer:l(24,24,255),inner:l(180,180,255),bkgnd:u(255,192,64,.3)},RANGE:{outer:l(64,64,255),inner:l(180,180,255),bkgnd:u(24,128,255,.3)},TARGET:{outer:l(24,24,255),inner:l(64,64,255),bkgnd:u(24,24,255,.3)}},wa=u(0,0,0,.65),ya=u(0,0,0,0),za={textAlign:"center",textBaseline:"bottom",fontSize:32,fillStyle:"yellow",strokeStyle:"black",lineWidth:2},Ga={textAlign:"center",textBaseline:"bottom",fontSize:32,fillStyle:"red",strokeStyle:"black",
lineWidth:2},ta=u(255,0,0,.8),Ka=l(255,180,180),Qa=l(180,255,180),Ta=[{messageID:"PartyTurn",innerStyle:l(0,0,128),outerStyle:u(0,0,128,0),textStyle:{fontSize:64,fillStyle:"white",textAlign:"center",textBaseline:"middle"}},{messageID:"EnemyTurn",innerStyle:l(128,0,0),outerStyle:u(128,0,0,0),textStyle:{fontSize:64,fillStyle:"white",textAlign:"center",textBaseline:"middle"}}],Va=function(){function b(a,n){this.dummy=n;this.cells={};this.depth=q(a)}Object.defineProperty(b.prototype,"minXH",{get:function(){return 1+
Ua(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"maxXH",{get:function(){return 20+q(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"minVisibleXH",{get:function(){return q(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"maxVisibleXH",{get:function(){return 21+Ua(this.depth)},enumerable:!0,configurable:!0});b.prototype.contains=function(a,b){if(null==a)return!1;var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;return 0<=
b&&3>b&&this.minXH<=c&&c<this.maxXH;var d};b.prototype.getLine=function(a){return this.cells[a]};b.prototype.setLine=function(a,b){this.cells[a]=b};b.prototype.deleteLine=function(a){delete this.cells[a]};b.prototype.rawget=function(a,b){var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;if(0<=b&&3>b&&this.minVisibleXH<=c&&c<this.maxVisibleXH&&(c=this.cells[c]))return c[b];return;var d};b.prototype.get=function(a,b){var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;c=this.rawget(c,b);return void 0===c?this.dummy:c;var d};
b.prototype.set=function(a,b,c){null==c&&(d=b,b=d.xH,c=d.yH,d);(d=this.cells[b])||(d=this.cells[b]=[]);d[c]=a;var d};b.prototype.each=function(a){for(var b=this.maxXH,c=this.minXH;c<b;++c)for(var d=0;3>d;++d)a(this.get(c,d),c,d)};b.prototype.eachVisible=function(a){for(var b=this.maxVisibleXH,c=this.minVisibleXH;c<b;++c)for(var d=0;3>d;++d)a(this.get(c,d),c,d)};b.prototype.straight=function(a,b,d,A){if(!e(a,b)){var f=a.xH,g=1+2*(2*a.yH+a.xH%2),h=b.xH,T=1+2*(2*b.yH+b.xH%2);a=c(a,b);h=(h-f)/a;T=(T-
g)/a;for(a=1;a<=d;++a){var r=f+a*h;b=q((g+a*T)/2);r=0===b%2?2*q((r+1)/2):2*q(r/2)+1;b=q(b/2);this.contains(r,b)&&A({xH:r,yH:b},a)}}};b.prototype.surround=function(b,n,c){if(1===n)for(var d=0;6>d;++d){var e=a(b,d);this.contains(e)&&c(e,1)}else if(1<n){b=a(b,0);for(var f=1;f<=n;++f){for(var e=b,g=0,h=[2,3,4,5,0,1];g<h.length;g++)for(var d=h[g],r=0;r<f;++r,e=a(e,d))this.contains(e)&&c(e,f);b=a(b,0)}}};return b}(),ea=function(){function a(b){this.duration=b}a.prototype.then=function(a){this.duration?
this.sig=ia(this.sig,a):I.then(a);return this};a.prototype.commit=function(){ca(this.sig);this.duration=this.sig=void 0};a.prototype.getXY=function(a,b,c){if(this.duration)if(c=G.clamp(c,this.start,this.duration),1<=c)this.commit();else return this.onGetXY(a,b,c)};a.prototype.drawCharacter=function(a,b,c,d,e,f,g){a.drawCharacter(b,c,d,e,f,g)};return a}(),Ba=function(a){function b(c){a.call(this,400*(13-c)/4)}x(b,a);b.prototype.onGetXY=function(a,b,c){a=a.hex;return{x:b.toX(a)-128*(1-c)+64,y:b.toY(a)+
80}};return b}(ea),Ia=function(a){function b(c){a.call(this,100*ma(c.length-1,.75));this.path=c}x(b,a);b.prototype.onGetXY=function(a,b,c){var d=this.path.length-1,e=q(d*c),f=this.path[e],g=this.path[e+1];a=b.toX(f);var f=b.toY(f),h=b.toX(g);b=b.toY(g);c=d*c-e;return{x:a*(1-c)+h*c+64,y:f*(1-c)+b*c+80}};return b}(ea),Ca=function(a){function b(c,d,e){a.call(this,function(a,b,c){var n=a.toX(b)-a.toX(c);a=a.toY(b)-a.toY(c);return 200+ma(n*n+a*a,.3)/1280*1E3}(c,d,e));this.hexFrom=d;this.hexTo=e}x(b,a);
b.prototype.hit=function(a){this.duration?this.hitsig=ia(this.hitsig,a):I.then(a)};b.prototype.commit=function(){ca(this.hitsig);this.hitsig=void 0;a.prototype.commit.call(this)};b.prototype.onGetXY=function(a,b,c){var d=this.hexFrom,e=this.hexTo;a=b.toX(d);var d=b.toY(d),f=b.toX(e);b=b.toY(e);.5>c?c*=2:(c=2-2*c,ca(this.hitsig),this.hitsig=void 0);return{x:a*(1-c)+f*c+64,y:d*(1-c)+b*c+80}};return b}(ea),Da=function(a){function b(c,d){a.call(this,500);var e=c.HP;this.dying=d>=e?c.hex:void 0;this.radius=
d>=e/2?1:.5+d/e}x(b,a);b.prototype.onGetXY=function(a,b,c){var d=20*(1-c)*this.radius;c=c*X*this.duration/250*this.radius;a=this.dying||a.hex;return{x:d*W(4*c)+b.toX(a)+64,y:d*W(3*c)+b.toY(a)+80}};b.prototype.drawCharacter=function(b,c,d,e,f,g,h){this.dying?(g=G.clamp(d,this.start,this.duration),c.save(),c.globalAlpha=1-g,a.prototype.drawCharacter.call(this,b,c,d,e,f,"red",g),c.restore()):a.prototype.drawCharacter.call(this,b,c,d,e,f,g,h)};return b}(ea),ra=function(){function a(b,c,d){this.ch=b;this.team=
c;this._hex=d;this.idleOffset=Wa();this.skill=b.skills.find(function(a){return 0<b.rangeOf(a)})||fb.DUMMY;this.HP=this.maxHP;this.minCost=this.SP=this.availSP;c=0;for(d=b.skills;c<d.length;c++){var e=d[c];e.isActive&&(e=this.costOf(e))&&e<this.minCost&&(this.minCost=e)}this.effectsOverTime=[]}Object.defineProperty(a.prototype,"hex",{get:function(){return this._hex},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"alive",{get:function(){return!!this._hex},enumerable:!0,configurable:!0});
Object.defineProperty(a.prototype,"name",{get:function(){return this.ch.name},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"level",{get:function(){return this.ch.level},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"INT",{get:function(){return this.ch.INT},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEX",{get:function(){return this.ch.DEX},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"STR",{get:function(){return this.ch.STR},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxHP",{get:function(){return this.ch.HP},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxSP",{get:function(){return this.ch.SP},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"availSP",{get:function(){return V(0,this.ch.SP-this.ch.reservedSP)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"step",{get:function(){return this.ch.step},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"ZoC",{get:function(){return this.ch.ZoC},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){return this.ch.DEF},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"skills",{get:function(){return this.ch.skills},enumerable:!0,configurable:!0});a.prototype.costOf=function(a){return this.ch.costOf(a)};a.prototype.rangeOf=function(a){return this.ch.rangeOf(a)};a.prototype.powerOf=function(a){return this.ch.powerOf(a)};a.prototype.getPassive=function(a,
b){for(var c=0,d=0,e=this.ch.skills;d<e.length;d++){var f=e[d];f.isPassive&&f.action===b&&0!==(a&f.tagbits)&&(c+=f.rawPower)}return c};a.prototype.getOffenceLevel=function(a){return this.getPassive(a,"Offence")};a.prototype.getDefenceLevel=function(a){return this.getPassive(a,"Defence")};a.prototype.isEnemy=function(a){return!!a&&this.team!==a.team};a.prototype.isTarget=function(a,b){return a?1===b.usage?this===a:b.hostile?this.isEnemy(a):this!==a&&!this.isEnemy(a):!1};a.prototype.getTarget=function(a,
b){var c=a.get(b).unit;if(this.isTarget(c,this.skill))return c};a.prototype.done=function(a){a=a.zoc;if(!a)return!1;var b=this._hex;return!!b&&this.SP<this.minCost&&this.SP<this.step+a[this.team].get(b)};a.prototype.estimate=function(a,b,c){this.isTarget(b,c);var d=c.effect,e=cb[d];if(!e)throw new RangeError('Effect not found: "'+d+'"');return e(a,this,b,c)};a.prototype.shoot=function(a,b,c){this.isTarget(b,c);var d=this.costOf(c),e=c.action,f=db[e];if(!f)throw new RangeError('Action not found: "'+
e+'"');a=f(a,this,b,c);this.SP-=d;return a};a.prototype.recuperate=function(){var a=q(.1*this.maxHP);this.HP=O(this.maxHP,this.HP+a)};Object.defineProperty(a.prototype,"canRevive",{get:function(){return!this._hex&&.5<=this.HP/this.maxHP},enumerable:!0,configurable:!0});a.prototype.onTurnEnd=function(a){this.team===a.team&&(this.SP=this.availSP)};a.prototype.onTurnStart=function(a){if(this.team===a.team){for(var b=0,c=this.effectsOverTime,d=c.length-1;0<=d;--d){var e=c[d];null!=e.deltaHPoT&&(b+=e.deltaHPoT);
0>=--e.duration&&c.splice(d,1)}if(0!==b)return b=a.promiseEffect(this,{target:this,deltaHP:b}),b.attach(a),b}};a.prototype.getXY=function(a,b){var c;this.state&&(c=this.state.getXY(this,a,b),c||(this.state=void 0));if(!c){var d=this._hex;d&&(c={x:a.toX(d)+64,y:a.toY(d)+80})}return c};Object.defineProperty(a.prototype,"state",{get:function(){return this._state},set:function(a){var b=this._state;if(this._state=a)a.start=performance.now();b&&b.commit()},enumerable:!0,configurable:!0});a.prototype.drawCharacter=
function(a,b,c,d,e,f){var g=this.ch,h=Na(g,128,128),r=h.w,k=.2*r;Ya(a,c-r/2,d-10-k/2,r,k,wa,ya,.75);b&&(r=200*(13-g.DEX),r=V(0,W(2*X*(this.idleOffset+b%r/r))),d-=16*r+10*(1-r));h.x=c-h.w/2;h.y=d-h.h;g.draw(a,b,h,e,f)};a.prototype.draw=function(a,b,c,d,e,f){this.state?this.state.drawCharacter(this,a,b,c,d,e,f):this.drawCharacter(a,b,c,d,e,f)};a.prototype.drawBars=function(a,b,c,e,f){var g=this.hex;b=c.toX(g)+16;c=c.toY(g)+60;d(a,b,c,96,6,this.HP,this.maxHP,e,eb);d(a,b,c+6,96,6,this.SP,this.maxSP,f,
zb)};a.compare=function(a,b){return a.y<b.y?-1:a.y>b.y?1:a.x<b.x?-1:a.x>b.x?1:0};return a}(),La=function(){function a(b,c){void 0===b&&(b=0);this.type=b;this.unit=c}Object.defineProperty(a.prototype,"empty",{get:function(){return null==this.unit&&0===this.type},enumerable:!0,configurable:!0});a.DUMMY=new a(1);return a}(),Sa=function(b){function c(d,w,f){function g(a){var b=this,c=w.hex,f=d.field,h=d.numScrollsPerTurn,A=this.get(a).SP,Y=l.get(a),qb=mb(2*a.yH+a.xH%2-3),k=f.minXH+h,r=a.xH<k,y=function(c){var d=
b.get(c).SP;if(A>d)return!0;if(A<d)return!1;d=c.xH<k;if(!r&&d)return!0;if(r&&!d)return!1;d=l.get(c);return Y<d?!0:Y>d?!1:a.xH<c.xH?!0:a.xH>c.xH?!1:qb<mb(2*c.yH+c.xH%2-3)};f.surround(a,m,function(g){if(!e(g,c)){var h=b.ensure(g);h.shotFrom?y(h.shotFrom)&&(h.shotFrom=a):(h.shotFrom=a,g=f.get(g).unit,w.isTarget(g,H)&&(h.effect=w.estimate(d,g,H)))}})}var h=this,k=d.field;b.call(this,k.depth,c.DUMMY);var l=d.zoc[w.team],r=w.hex,L=w.step,H=w.skill,gb=w.costOf(H),m=w.rangeOf(H)||0;this.ensure(r).SP=f;if(f>=
L+l.get(r))for(var p=[],q=r;q;q=p.shift()){var E=this.get(q).SP-(L+l.get(q));if(0<=E)for(var t=0;6>t;++t){var v=a(q,t),u=k.rawget(v);u&&0===u.type&&!w.isEnemy(u.unit)&&(u=this.ensure(v),u.SP<E||u.SP===E&&k.get(q).empty&&(!u.comeFrom||!k.get(u.comeFrom).empty))&&(u.SP=E,u.comeFrom=q,E>=L+l.get(v)&&p.push(v))}}f>=gb&&1<=m&&(g.call(this,r),this.each(function(a,b,c){a.SP>=gb&&k.get(b,c).empty&&g.call(h,{xH:b,yH:c})}))}x(c,b);c.prototype.ensure=function(a){var b=this.rawget(a);b||(b={SP:-1},this.set(b,
a));return b};c.prototype.getPath=function(a,b){var c=this.get(a);if(c){var d=c.comeFrom,e=c.shotFrom;if(c.effect&&e){if(!b.get(e).empty)return;c=[e];e=this.get(e);d=e.comeFrom;e}else if(d){if(!b.get(a).empty)return;c=[a]}else return;for(;d;)c.unshift(d),e=this.get(d),d=e.comeFrom,e;return c}};c.DUMMY={SP:-1};return c}(Va),$a=function(a){function b(c,d,e,f,g,h){a.call(this,e,f,g,h,new B(function(){var a=c.focus;if(a){var b=a.skills[d];if(b){if(b.isActive){var e=a.skill===b,f=a.costOf(b),g=a.rangeOf(b)||
0,a=a.powerOf(b);return""+(e?"E ":"")+b.name.localized+"\n"+f+" / "+g+" / "+(null!=a?a.toFixed(1):"-")}return b.name.localized+"\n"+("Offence"===b.action?"ATK":"DEF")+": "+Za(b.tags)}}},{fontSize:20}),function(){if(this.enabled){var a=this.scene.focus,b=a.skills[this.index];1===b.usage?c.controller.dose(a,b):(a.skill=b,c.onSkillChanged(a))}},void 0,b.design);this.scene=c;this.index=d}x(b,a);Object.defineProperty(b.prototype,"visible",{get:function(){var a=this.scene.focus;return!!a&&!!a.skills[this.index]},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"enabled",{get:function(){var a=this.scene.focus;if(a){var b=a.skills[this.index];if(b)return 1===b.usage?a.SP>=a.costOf(b):0<a.rangeOf(b)}return!1},enumerable:!0,configurable:!0});b.design={draw:function(a,b,c){if(c.visible){var d=c.scene.focus;if(0<d.rangeOf(d.skills[c.index]))F.defaultDesign.draw(a,b,c);else{var e=F.defaultDesign.getStyle(c.state),f=d=void 0,g=void 0,h,k;null==d?(g=c,h=g.x,k=g.y,d=g.w,f=g.h,g,g=e):(h=c,k=e);if(0<
d&&0<f){a.save();Xa(a,g);if(!g||g.strokeStyle)e=a.lineWidth-1,h+=e/2,k+=e/2,d-=e,f-=e;e=.2*O(d,f);a.beginPath();a.moveTo(h+e,k);a.lineTo(h+d-e,k);a.quadraticCurveTo(h+d,k,h+d,k+e);a.lineTo(h+d,k+f-e);a.quadraticCurveTo(h+d,k+f,h+d-e,k+f);a.lineTo(h+e,k+f);a.quadraticCurveTo(h,k+f,h,k+f-e);a.lineTo(h,k+e);a.quadraticCurveTo(h,k,h+e,k);g&&!g.fillStyle||a.fill();g&&!g.strokeStyle||a.stroke();a.restore()}c.drawable&&c.drawable.draw(a,b,c)}}}};return b}(F),ea=function(){function a(b,c,d){void 0===d&&(d=
2);this.level=c;this.numScrollsPerTurn=d;b="assets/"+("level/"+b+"/");this.imgSky=new z(b+"sky.png");this.imgCells=[new z(b+"tile.png"),new z(b+"hole.png")]}a.prototype.generate=function(a,b){var c=0,d=0;a.eachUnit(function(a){0===a.team?++c:++d});for(var e=0===c?.3:.3*ma(1.1,c-d),f=Array(3),g=Ma(Ab),h=0;3>h;++h){var k=void 0,l=0;12<b&&Wa()<e?(k=g[Ja(g.length)],k=Z.monster(k,a.getLevel()),k=new ra(k,1,{xH:b,yH:h})):6<b&&.1>Wa()&&(l=1);f[h]=new La(l,k)}return f};a.prototype.draw=function(a,b,c){var d=
this,e=c.field,f=this.imgSky.image;if(f){a.save();var g=128*e.depth/2;a.fillStyle=a.createPattern(f,"repeat");a.translate(-g,0);a.fillRect(0+g,0,1280,80);a.restore()}var h={x:0,y:0,w:128,h:80};e.eachVisible(function(e,f,g){e=e.type;h.x=c.toX(f,g);h.y=c.toY(f,g);d.imgCells[e].draw(a,b,h)})};return a}();b.EndressStage=ea;ea=function(a){function b(c,e){function f(a,b,c){return new F(10+110*b,570,100,140,{draw:function(a,b,e){var n=c.ch,f=Na(n,e.w,e.h,!0);f.x=e.x+(e.w-f.w)/2;f.y=e.y+(e.h-f.h)/2;c.alive||
c.canRevive?n.draw(a,b,f):(n=n.images,(n[Ea.DEAD]||n[Ea.DEFAULT]).draw(a,b,f));d(a,e.x+10,e.y+128,80,6,c.HP,c.maxHP,void 0,eb)}},function(){if(c.alive)m.click(c.hex);else if(c.canRevive){for(var d=Ha.minXH,e=b%3,n=0;3>n;++n){if(Ha.get(d,e).empty){a.revive(c,{xH:d,yH:e});return}e=(e+1)%3}D.error(h("Combat","NoSpaceToRevive"))}else D.error(h("Combat","CannotRevive"))},[k.$1+b])}function g(a,b,c,d,e){b=new F(1280-150*b,570,140,140,new B(c),d);e&&ua(b,"enabled",e);b.attach(a);return b}var l=this;a.call(this);
this.data=c;this.stage=e;this.team=0;this.enabled=!1;var Ha=this.field=new Va(0,La.DUMMY);this.dying=[];this.deads=[];this.snapshots=[];var m=new ab;m.attach(this);m.visible=!1;var r=new bb;r.attach(this);r.visible=!1;for(var L=Ha.minVisibleXH,r=Ha.maxVisibleXH;L<r;++L)Ha.setLine(L,this.stage.generate(this,L));for(var H=[],gb=[[2,0],[2,1],[2,2],[1,0],[1,1],[1,2]],y=c.party,r=0;6>r;++r){var p=y[r];if(p){var t=gb[r],L=t[0],L={xH:L,yH:t[1]},t=new ra(p,0,L);t.state=new Ba(p.DEX);Ha.rawget(L).unit=t;H.push(f(this,
r,t))}}var E=new R(H);ua(E,"visible",function(){return m.visible&&!l.focus});E.attach(this);g(E,1,h("Combat","End"),function(){return l.endTurn()});g(E,2,h("Combat","Undo"),function(){return m.undo()},function(){return m.canUndo});g(E,3,h("Combat","Retire"),function(){return l.retire()});var u=g(E,4,h("Combat","View")),r=new da;r.onDraw=function(a,b){return l.drawUnits(a,b,l.focusTime)};r.attach(this);r=new da;r.onDraw=function(a,b){return l.drawBarsOnView(a,b)};ua(r,"visible",function(){return E.visible&&
(u.hover||u.pressed)});r.attach(this);r=new R;ua(r,"visible",function(){return!!l.focus});r.attach(this);H=new da;H.onDraw=function(a,b){return l.drawBarsOnFocus(a,b,l.focus,l.controller.caret)};H.attach(r);var v=new pa(0,560,1280,160);v.onDraw=function(a,b){return l.drawPanel(a,b,v,l.focus)};v.attach(r);H=new R;ua(H,"visible",function(){return m.visible&&!!l.focus});H.attach(this);for(r=0;6>r;++r)(new $a(this,r,400+170*q(r/2),570+r%2*75,160,65)).attach(H);var x=function(){var a=l.mapFor(l.focus);
if(a){var b=l.controller.caret;if(b&&(a=a.get(b).effect))return a.target}},z=new pa(640,560,640,160);ua(z,"visible",function(){return!!x()});z.onDraw=function(a,b){return l.drawPanel(a,b,z,x())};z.attach(this);if(r=System.canvas.getContext("2d"))(new J(0,0,128,560,new lb({fillStyle:jb(r,0,0,128,0,ba,Q)}))).attach(this),(new J(1152,0,1280,560,new lb({fillStyle:jb(r,1152,0,1280,0,Q,ba)}))).attach(this);kb(this);this.startTurn()}x(b,a);Object.defineProperty(b.prototype,"controller",{get:function(){return this.children[this.team]},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"numScrollsPerTurn",{get:function(){return this.stage.numScrollsPerTurn},enumerable:!0,configurable:!0});b.prototype.getLevel=function(a){var b=this.stage;a=b.level;b=b.numScrollsPerTurn;0<b&&(a+=this.field.depth/b*.1);return a};Object.defineProperty(b.prototype,"focus",{get:function(){return this._focus},set:function(a){a?this._focus!==a&&(this._focus=a,this.focusTime=performance.now()):this.focusTime=this._focus=void 0},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"zoc",{get:function(){if(this.enabled){var a=this._zoc;if(!a){var a=this.field.depth,b=[new Va(a,0),new Va(a,0)];this.eachUnit(function(a){var c=a.ZoC;if(0<c){var d=b[0===a.team?1:0];d.surround(a.hex,1,function(a){return d.set(d.get(a)+c,a)})}});this._zoc=a=b}return a}},enumerable:!0,configurable:!0});b.prototype.mapFor=function(a){if(a&&this.enabled){var b=this.maps;b||(this.maps=b=new Va(this.field.depth,void 0));var c=a.hex,d=b.rawget(c);d||(d=
new Sa(this,a,a.SP),b.set(d,c));return d}};b.prototype.onSkillChanged=function(a){var b=a.hex,c=this.maps,d=this.snapshots;c&&c.set(void 0,b);if(d)for(b=0;b<d.length;b++)c=d[b],c.unit===a&&c.maps.set(void 0,c.hex)};b.prototype.savepoint=function(a){this.snapshots.push({unit:a,hex:a.hex,SP:a.SP,maps:this.maps,zoc:this.zoc})};b.prototype.rollback=function(){var a=this.snapshots.pop(),b=a.unit;this.setUnit(b,a.hex);b.SP=a.SP;this._zoc=a.zoc;this.maps=a.maps;this.focus=b};b.prototype.setUnit=function(a,
b){var c=this.field,d=c.rawget(b),e=d.unit;if(a){if(e===a)return;if(e=a._hex)c.rawget(e).unit=void 0;a._hex=b}else e&&(e._hex=void 0);d.unit=a;this.invalidate()};b.prototype.revive=function(a,b){var c=this.deads,d=c.indexOf(a);c.splice(d,1);a.SP=a.availSP;a.state=new Ba(a.DEX);this.setUnit(a,b);this.snapshots.length=0};b.prototype.invalidate=function(){this.maps=this._zoc=void 0};b.prototype.startTurn=function(){for(var a=this,b=this.team,c=0,d=this.deads;c<d.length;c++){var e=d[c];e.team===b&&e.recuperate()}var f;
this.eachUnit(function(b){(b=b.onTurnStart(a))&&(f?f.push(b):f=[b])});b=function(){a.enabled=!0;a.controller.visible=!0};f?va(f).then(b):b()};b.prototype.retire=function(){var a=this;Ra.confirm(this,h("Combat","ConfirmRetire"),{label:h("Combat","Retire"),click:function(){a.controller.visible=!1;S.go(a,new Fa.Home(a.data))},mnemonic:ob},{label:h("Config","Cancel"),mnemonic:pb})};b.prototype.endTurn=function(){var a=this;this.enabled=!1;this.snapshots.length=0;this.controller.visible=!1;this.eachUnit(function(b){b.onTurnEnd(a)});
if(0===this.team){var b=this.numScrollsPerTurn;if(0<b){var c=this.field.minXH+b;this.eachUnit(function(b){b.hex.xH<c&&(b.state=new Da(b,b.HP),a.kill(b))});var d=this.field.depth;(new G(400*b,function(c){a.scrollTo(d+b*c)})).attach(this);if(this.isGameOver)return}}this.team=0===this.team?1:0;var e=Ta[this.team],f=e.innerStyle,g=e.outerStyle,k=e.textStyle,l=h("Combat",e.messageID);(new G(800,function(a,b){b.save();b.globalAlpha=W(X*a);Ya(b,0,0,1280,560,f,g);Oa(b,l.localized,640,280,k);b.restore()})).then(function(){a.startTurn()}).attach(this)};
b.prototype.dose=function(a,b){var c=this;oa(a.SP>=a.costOf(b));this.focus=a;this.enabled=!1;this.snapshots.length=0;this.invalidate();return a.shoot(this,a,b).then(function(){c.enabled=!0;a.done(c)&&(c.focus=void 0)})};b.prototype.move=function(a,b){var c=this;oa(!e(b,a.hex));var d=function(){c.enabled=!0;a.done(c)&&(c.focus=void 0)};this.focus=a;var f=this.field,g=a.skill,h=this.mapFor(a),k=h.get(b);if(k.effect){oa(a.SP>=a.costOf(g));this.enabled=!1;var l=k.effect.target;oa(a.isTarget(l,g));var H=
function(){c.snapshots.length=0;c.invalidate();return a.shoot(c,l,g).then(d)};if(e(k.shotFrom,a.hex))return H();f=h.getPath(b,f);k=f[f.length-1];oa(!e(k,b));oa(!e(k,a.hex));this.setUnit(a,k);a.SP=h.get(k).SP;h=a.state=new Ia(f);H=ib(H);h.then(H);return H}oa(0<=k.SP&&f.get(b).empty);f=h.getPath(b,f);this.setUnit(a,b);a.SP=k.SP;h=a.state=new Ia(f);d();return p.wait.WALK?h:I};b.prototype.findUnit=function(a,b,c){var d=this.field,e=d.minXH,f=d.maxXH,g=(0===this.team?b:!b)?1:-1;b=b?1:-1;var h,k;a?(h=a.xH,
k=a.yH,a):(h=0>g?e:f-1,k=0>b?0:2);a=1;for(var l=3*(f-e+1);a<l;++a){k+=b;if(0>k||3<=k)k=0>k?2:0,h+=g,h<e?h=f-1:f<=h&&(h=e);var m=d.get(h,k).unit;if(m&&c(m))return m}};b.prototype.kill=function(a){var b=this;a.alive&&(a.HP=0,this.setUnit(void 0,a.hex),this.dying.push(a));0===a.team&&(this.deads.push(a),this.parent&&this.isGameOver&&(this.controller.visible=!1,(a.state||I).then(function(){Ra.confirm(b,h("Combat","GameOver"),{label:h("Combat","Retire"),click:function(){return S.go(b,new Fa.Home(b.data))},
mnemonic:ub})})))};Object.defineProperty(b.prototype,"isGameOver",{get:function(){return!this.findUnit(void 0,!0,function(a){return 0===a.team})},enumerable:!0,configurable:!0});b.prototype.createPopup=function(a,b,c){var d=this.toX(c)+64,e=this.toY(c)+80;return new G(600,function(c,f){return Oa(f,a,d,e-40*c,{fontSize:48,fillStyle:b,strokeStyle:"black",globalAlpha:W(X*c),lineWidth:4,textAlign:"center",textBaseline:"bottom"})})};b.prototype.promiseEffect=function(a,b,c){var d=this,e=b.deltaHP||0,f=
mb(e).toString(),g=this.createPopup(f,0<e?Qa:Ka,c||a.hex),h=g.attach;g.attach=function(c){var f=b.deltaSP||0;if(0>e||0>f)a.state=new Da(a,-e);a.HP=fa(0,a.maxHP,a.HP+e);0!==f&&(a.SP=fa(0,a.maxSP,a.SP+f));0>=a.HP?d.kill(a):(f=b.duration,null!=f&&a.effectsOverTime.push({duration:f,deltaHPoT:b.deltaHPoT}));return h.call(g,c)};return g};b.prototype.eachUnit=function(a){this.field.eachVisible(function(b){(b=b.unit)&&a(b)})};b.prototype.toX=function(a,b){var c;null==b?(d=a,c=d.xH,d):c=a;return 0+64*(c-1-
this.field.depth);var d};b.prototype.toY=function(a,b){var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;return 80+80*(2*b+c%2);var d};b.prototype.toHex=function(a,b){var c=this.field,d=a-0+128*c.depth/2,e=q((b-0-80)/80);if(0<=e&&6>e&&(d=0===e%2?2*q((d+64)/128):2*q(d/128)+1,c.minXH<=d&&d<c.maxXH))return c=q(e/2),{xH:d,yH:c}};b.prototype.scrollTo=function(a){var b=this.field;if(a>b.depth){var c=b.minVisibleXH,d=b.maxVisibleXH;b.depth=a;a=b.minVisibleXH;for(var e=b.maxVisibleXH;c<a;++c)b.deleteLine(c);for(c=
V(a,d);c<e;++c)b.setLine(c,this.stage.generate(this,c))}};b.prototype.onDraw=function(b,c){this.stage.draw(b,c,this);var d=this.focus;if(d){var e=this.mapFor(d);e&&this.drawMarkers(b,c,this.focusTime,e,d)}a.prototype.onDraw.call(this,b,c)};b.prototype.drawMarkers=function(a,b,c,d,e){var f=this,g=G.clamp(b,c,300);if(!(0>=g)){var h=e.costOf(e.skill);b=e.skill.hostile?la:sa;var k=b.DASH_OR_RANGE,l=b.RANGE,m=b.TARGET;a.save();1>g&&(a.globalAlpha=g);d.eachVisible(function(b,c,d){var e=b.SP,w=b.shotFrom,
A,Y=0,y=0;b.effect?(A=m,Y=32*(1-g),y=20*(1-g)):e>=h?A=ha:0<=e?A=w?k:ja:w&&(A=l);A&&(b=f.toX(c,d)-Y,c=f.toY(c,d)-y,Y=128+2*Y,y=80+2*y,a.fillStyle=A.bkgnd,a.fillRect(b+5,c+5,Y-10,y-10),a.strokeStyle=A.outer,a.lineWidth=2,a.strokeRect(b+2,c+2,Y-4,y-4),a.strokeStyle=A.inner,a.lineWidth=1,a.strokeRect(b+4,c+4,Y-8,y-8))});a.restore()}};b.prototype.drawUnits=function(a,b,c){var d=this,e=this.zoc,f=this.focus,g=[];this.eachUnit(function(a){var c=a.getXY(d,b);c.unit=a;g.push(c)});for(var k=0;k<this.dying.length;){var l=
this.dying[k],m=l.getXY(this,b);m?(m.unit=l,g.push(m),++k):this.dying.splice(k,1)}g.sort(ra.compare);k=h("Combat","Done").localized;c=(1-na(2*X*G.cycle(b,c,1E3)))/2*.5;var m="blue",y;f&&(f.skill.hostile&&(m="red"),y=this.mapFor(f));for(var T=0;T<g.length;T++){var p=g[T],l=p.unit,q=p.x,p=p.y,E=void 0;y&&(f===l?E="yellow":l.alive&&y.get(l.hex).effect&&(E=m));l.draw(a,b,q,p,E,c);if(!l.state&&e&&l.alive){var E=l.SP,t=l.step,u=l.team;E<l.minCost&&(E<t?Oa(a,k,q,p,za):E<t+e[u].get(l.hex)&&Oa(a,k,q,p,Ga))}}};
b.prototype.drawBarsOnView=function(a,b){var c=this;this.eachUnit(function(d){return d.drawBars(a,b,c)})};b.prototype.drawBarsOnFocus=function(a,b,c,d){var h=this;if(c){var k=this.mapFor(c);if(k){var l=this.field;k.each(function(c){(c=c.effect)&&c.target.drawBars(a,b,h,c.deltaHP,c.deltaSP)});if(d){var m=k.get(d);m.effect?(d=m.shotFrom,l=c.costOf(c.skill),e(d,c.hex)?c.drawBars(a,b,this,void 0,-l):(f(a,b,this,c,c.hex),g(a,b,this,c,d,k.get(d).SP-l))):0<m.SP&&l.get(d).empty?(f(a,b,this,c,c.hex),g(a,b,
this,c,d,m.SP)):c.drawBars(a,b,this)}else c.drawBars(a,b,this)}}};b.prototype.drawPanel=function(a,b,c,d){if(d){xa(a,c,M[d.team]);var e=d.ch,f=Na(e,128,128);f.x=c.x+10+(128-f.w)/2;f.y=c.y+(c.h-f.h)/2;e.draw(a,b,f);b=d.costOf(d.skill);b=d.SP>=b?q((d.SP-b)/d.step):"-";var e=d.powerOf(d.skill),f=d.name+" / Lv: ",g;g=d.level;g=null!=g?g.toFixed(1):"-";Oa(a,f+g+"\n"+("HP: "+d.HP+" / "+d.maxHP+"\n")+("SP: "+d.SP+" / "+d.maxSP+"\n")+("MOVE: "+b+"/"+q(d.SP/d.step)+"\n")+("ATK/DEF: "+(null!=e?e.toFixed(1):
"-")+" / "+d.DEF.toFixed(1)),c.x+148,c.y+10,aa)}};return b}(R);b.Scene=ea;var ab=function(b){function c(){b.apply(this,arguments);this.mode=0}x(c,b);Object.defineProperty(c.prototype,"caret",{get:function(){return this._caret},set:function(a){this._caret=a;if(0===this.mode){var b=this.parent;b.focus=a?b.field.get(a).unit:void 0}},enumerable:!0,configurable:!0});c.prototype.finish=function(a){var b=this,c=this.parent,d=function(){c.focus||(b.mode=0)};c.enabled?d():a.then(d)};c.prototype.dose=function(a,
b){var c=this.parent;this.mode=1;this.finish(c.dose(a,b))};Object.defineProperty(c.prototype,"canUndo",{get:function(){return 0<this.parent.snapshots.length||1<=this.mode},enumerable:!0,configurable:!0});c.prototype.undo=function(){var a=this.parent,b=a.snapshots,c=b.length,b=0<c?b[c-1].unit:void 0;1<=this.mode&&b!==a.focus?this.mode=0:b?a.rollback():D.error(h("Combat","CannotUndo"));this.caret=this._caret};c.prototype.onHover=function(a,b){this.caret=this.parent.toHex(a,b)};c.prototype.onDrag=function(a,
b){this.caret=this.parent.toHex(a,b)};c.prototype.downCaret=function(a){if(this.caret=a){var b=this.parent,c=this.mode,d=b.focus;if(d){if(d.team===b.team&&!d.done(b)){1===c&&e(a,d.hex)?this.mode=3:this.mode=2;return}}else if(a=b.field.get(a).unit,b.focus=a){this.mode=2;return}this.mode=0}};c.prototype.onDown=function(a,b){this.downCaret(this.parent.toHex(a,b))};c.prototype.upCaret=function(a){if(this.caret=a){var b=this.parent,c=this.mode;if(b.enabled&&!(2>c)){var d=b.focus;if(d&&b.team===d.team)if(e(a,
d.hex))this.mode=2===c?1:0;else{if(c=b.mapFor(d)){c=c.get(a);if(!c.effect)if(0<=c.SP&&b.field.get(a).empty)b.savepoint(d);else{b.focus=void 0;this.mode=0;return}this.mode=1;this.finish(b.move(d,a))}}else this.mode=0}}};c.prototype.onUp=function(a,b){this.upCaret(this.parent.toHex(a,b))};c.prototype.onPress=function(b){function c(b){var d=this.parent.field,e=this.caret;e?(b=a(e,b),d.contains(b)&&(this.caret=b)):this.caret={xH:d.minXH,yH:0}}function d(a){var b=this.parent,c=this.caret,e=b.team,f=b.focus;
(a=b.findUnit(f?f.hex:c,a,function(a){return a.team===e&&!a.done(b)}))?(b.focus=a,c||(this.caret=a.hex),0===this.mode&&(this.mode=1)):D.error(h("Combat","UnitNotAvailable"))}switch(b){case k.BACKSPACE:case k.TAB:case k.DELETE:case k.Q:this.undo();break;case k.PAGE_DOWN:case k.C:d.call(this,!0);break;case k.PAGE_UP:d.call(this,!1);break;case k.SPACE:case k.ENTER:this.click(this.caret);break;case k.E:c.call(this,0);break;case k.RIGHT:case k.D:c.call(this,1);break;case k.DOWN:case k.X:case k.S:c.call(this,
2);break;case k.Z:c.call(this,3);break;case k.LEFT:case k.A:c.call(this,4);break;case k.UP:case k.W:c.call(this,5)}};c.prototype.click=function(a){a&&this.parent.field.contains(a)&&(this.downCaret(a),this.upCaret(a))};c.prototype.onDraw=function(a,b){function c(a,b,d,e){var f=b.toX(d)+6.5;b=b.toY(d)+6.5;a.save();a.lineCap="round";a.lineJoin="round";a.beginPath();a.moveTo(f+32,b);a.lineTo(f,b);a.lineTo(f,b+20);a.moveTo(f+115-32,b);a.lineTo(f+115,b);a.lineTo(f+115,b+20);a.moveTo(f+115-32,b+67);a.lineTo(f+
115,b+67);a.lineTo(f+115,b+67-20);a.moveTo(f+32,b+67);a.lineTo(f,b+67);a.lineTo(f,b+67-20);a.lineWidth=7;a.strokeStyle=e.outer;a.stroke();a.lineWidth=3;a.strokeStyle=e.inner;a.stroke();a.restore()}function d(a,b,c){a.save();a.lineCap="butt";a.lineJoin="round";var e=c[c.length-2],f=c[c.length-1],g=b.toX(e)+64,h=b.toY(e)+40,e=b.toX(f)+64,f=b.toY(f)+40,g=vb(f-h,e-g);a.beginPath();a.moveTo(e+20*na(g),f+20*W(g));a.lineTo(e+20*na(g+2*X/3),f+20*W(g+2*X/3));a.lineTo(e+20*na(g-2*X/3),f+20*W(g-2*X/3));a.fillStyle=
ta;a.fill();a.beginPath();a.moveTo(e-10*na(g),f-10*W(g));for(g=c.length-2;0<=g;--g)e=c[g],a.lineTo(b.toX(e)+64,b.toY(e)+40);a.strokeStyle=ta;a.lineWidth=12;a.stroke();a.restore()}var e=this.caret;if(e){var f=this.parent,g=f.focus,h=f.field;if(0===this.mode)c(a,f,e,ka);else if(g){var k=f.mapFor(g);if(k){var l=k.get(e);(k=k.getPath(e,h))&&2<=k.length&&d(a,f,k);if(l.effect)switch(k=g.skill,k.usage){case 2:c(a,f,e,Aa);break;case 3:c(a,f,e,qa);break;case 4:h.straight(l.shotFrom,e,g.rangeOf(k),function(b){return c(a,
f,b,Aa)});break;case 5:h.straight(l.shotFrom,e,g.rangeOf(k),function(b){return c(a,f,b,qa)});break;case 6:h.surround(l.shotFrom,g.rangeOf(k),function(b){return c(a,f,b,Aa)});break;case 7:h.surround(l.shotFrom,g.rangeOf(k),function(b){return c(a,f,b,qa)})}else 0<=l.SP?c(a,f,e,ga):c(a,f,e,ka)}}}};return c}(da),bb=function(a){function b(){a.apply(this,arguments);this.running=!1}x(b,a);Object.defineProperty(b.prototype,"visible",{get:function(){return this.running},set:function(a){var b=this;(this.running=
a)&&I.then(function(){return b.run([])})},enumerable:!0,configurable:!0});b.prototype.dose=function(a,b){throw Error("not implemented");};b.prototype.run=function(a){function b(a,c){var d=a.focus;if(d)return d;var e=a.team,d=c.length,d=0<d?a.findUnit(c[d-1].hex,!1,function(b){return b.team===e&&!b.done(a)&&0>c.indexOf(b)}):a.findUnit(void 0,!1,function(b){return b.team===e&&!b.done(a)});return a.focus=d}function c(a,b,f){var g=a.mapFor(b),h=d(a,b,g),k=h.hex;if(!g.get(k).effect&&b.SP>=b.availSP){var l=
new Sa(a,b,999),k=d(a,b,l,h).hex,h=l.get(k);h.effect&&(k=h.shotFrom);for(var h=a.field,n=k;n&&(0>g.get(n).SP||!h.get(n).empty);)n=l.get(n).comeFrom;k=n?n:b.hex}if(e(k,b.hex))f.push(b),a.focus=void 0;else return f.length=0,this.caret=k,f=p.wait.PICK,0<f?(g=ib(function(){return a.move(b,k)}),(new G(f)).then(g).attach(a),g):a.move(b,k)}function d(a,b,c,e){var g=a.field,h=a.numScrollsPerTurn,k=g.minXH,l=g.maxXH,n=b.hex,w=b.maxSP,p=b.costOf(b.skill)||w,T=k+h,q=e?e:{hex:n,score:f(b,n.xH,n.yH,k,l,T)+40*
b.SP/w};c.each(function(d,e,h){var n=d.SP,y=d.effect;d=d.shotFrom;var r;if(y&&d){n=r=f(b,d.xH,d.yH,k,l,T);r=y.target;var t;t=r.ch;for(var u=0,v=0,A=t.skills;v<A.length;v++){var x=A[v];0<t.rangeOf(x)&&(u=x.hostile?C(a,r,x,b)/b.HP:m(a,r,x)/r.maxHP,u=V(u,u))}t=O(1,u);y=y.deltaHP||0;y=0>y?-y:O(y,r.maxHP-r.HP);y=O(1,y/r.HP);r=n+1E3*t*y;n=c.get(d).SP-p}else if(0<=n&&g.get(e,h).empty)r=f(b,e,h,k,l,T);else return;r+=40*n/w;q.score<r&&(q.score=r,q.hex={xH:e,yH:h})});return q}function f(a,b,c,d,e,g){var h=
0,h=1===a.team?h+10*(e-b):h+10*(b-d);a=2*c+b%2;h=3>a?h+10*a:h+10*(5-a);b<g&&(h*=.1);return h}for(var g=this,h=this.parent,k;this.running;){h.enabled||(k=I);if(k){k.then(function(){return g.run(a)});break}this.caret=void 0;k=b(h,a);if(!k){h.endTurn();break}k=c.call(this,h,k,a)}};return b}(da),cb={Damage:function(a,b,c,d){return{target:c,deltaHP:-C(a,b,d,c)}},DamageHPandSP:function(a,b,c,d){a=-C(a,b,d,c);return{target:c,deltaHP:a,deltaSP:q(a/2)}},DamageOverTime:function(a,b,c,d){a=-C(a,b,d,c);return{target:c,
deltaHP:a,duration:2,deltaHPoT:q(a/2)}},Heal:function(a,b,c,d){return{target:c,deltaHP:m(a,b,d)}},HealOverTime:function(a,b,c,d){a=m(a,b,d);return{target:c,deltaHP:a,duration:2,deltaHPoT:Ua(a/2)}}},db={Charge:t,Knockback:function(a,b,c,d){var e=b.hex,f=c.hex,g=N(a.field,e,f);if(!g)return t(a,b,c,d);d=b.estimate(a,c,d);var h=a.promiseEffect(c,d,g),e=new Ca(a,e,f),k=new Ia([f,g]);b.state=e;e.hit(function(){a.setUnit(c,g);c.state=k});k.then(function(){return h.attach(a)});return p.wait.POPUP?va([h,e]):
e},GoBehind:function(a,b,c,d){var e=b.hex,f=c.hex,g=N(a.field,e,f);if(!g)return t(a,b,c,d);d=b.estimate(a,c,d);var h=a.promiseEffect(c,d);c=new Ia([e,f]);a.setUnit(b,g);b.state=c;c.then(function(){return h.attach(a)});return p.wait.POPUP?h:c},Trample:function(a,b,c,d){var e=b.hex,f=c.hex,g=N(a.field,e,f);if(!g)return t(a,b,c,d);d=b.estimate(a,c,d);var h=a.promiseEffect(c,d,g),e=new Ia([e,f]);d=new Ia([f,f,g]);a.setUnit(c,g);c.state=d;a.setUnit(b,f);b.state=e;d.then(function(){return h.attach(a)});
return p.wait.POPUP?h:d},Shoot:function(a,b,c,d){var e=b.hex,f=c.hex;b=b.estimate(a,c,d);var g=a.promiseEffect(c,b);c=P(a,e,f,d);c.then(function(){return g.attach(a)});return p.wait.POPUP?g:c},Drain:function(a,b,c,d){var e=c.hex,f=b.hex,g=b.estimate(a,c,d);c=a.promiseEffect(c,g);var h=a.promiseEffect(b,{target:b,deltaHP:-g.deltaHP});b=P(a,e,f,d);b.then(function(){return h.attach(a)});c.attach(a);return p.wait.POPUP?h:b},Explode:function(a,b,c,d){var e=c.hex;c=P(a,b.hex,e,d);var f=ib(function(){return v(a,
b,d,e,1,function(a,b){return q(a/(1+b))})});c.then(f);return f},Laser:function(a,b,c,d){var e=a.field,f=b.rangeOf(d)||0,g=b.hex,h,k=[];e.straight(g,c.hex,f,function(c){var f=b.getTarget(e,c);if(f){var g=b.estimate(a,f,d),f=a.promiseEffect(f,g);f.attach(a);k.push(f)}h=c});var l=K(d);c=new G(400,function(b,c){var d=a.toX(g)+64,e=a.toY(g)+40,f=a.toX(h)+64,k=a.toY(h)+40,n=vb(k-e,f-d),m=64*na(n),n=40*W(n);c.save();c.beginPath();c.moveTo(d+m,e+n);c.lineTo(f+m,k+n);c.lineCap="round";c.lineWidth=80*b/4;c.strokeStyle=
Pa(l,1-b);c.stroke();c.restore()});c.attach(a);return p.wait.POPUP?(k.push(c),va(k)):c},Nova:function(a,b,c,d){return v(a,b,d,b.hex,b.rangeOf(d)||0)},Dose:function(a,b,c,d){b=b.estimate(a,c,d);c=a.promiseEffect(c,b);c.attach(a);return p.wait.POPUP?c:I}}})(Ga||(Ga={}));var Ta;p=new (function(){function b(){this._refineCanvas=this._magnifyCanvas=!1;this.volume=new yb(50,0,100);this.effects=new yb(Ba.length-1,0,Ba.length-1)}Object.defineProperty(b.prototype,"magnifyCanvas",{get:function(){return this._magnifyCanvas},
set:function(a){this._magnifyCanvas!==a&&(this._magnifyCanvas=a,window.dispatchEvent(new UIEvent("resize")))},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"refineCanvas",{get:function(){return this._refineCanvas},set:function(a){this._refineCanvas!==a&&(this._refineCanvas=a,window.dispatchEvent(new UIEvent("resize")))},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"wait",{get:function(){return Ba[this.effects.value]},enumerable:!0,configurable:!0});return b}());
System.main=function(b,a){var c=new Image;c.src="assets/dummy.png";z.DUMMY=c;var c=new R,e=new R;e.attach(c);var d=new Kb(10,10,1260,700,2E3,Hb);d.attach(c);D=d;Ta=function(){for(;;){var a=e.children,b=a.length;if(0===b)break;a[b-1].detach()}(new wb(new ra.Scene)).attach(e)};Gb();Ta();Db(b,c,p);System.checkpoint=function(){db()}}})();
