(function(){function ga(b,a,h){return h<b?b:h>a?a:h}function oa(b,a){return null!=b?b:a}function Ea(b){return r(Za()*b)}function pa(b){return null==b?[]:b.map(function(a){return null!=a?a.toJSON():null})}function V(b,a){return null==a?[]:a.map(function(a){return null!=a?b.fromJSON(a):null})}function Fa(b){return void 0===b?"(undefined)":null===b?"(null)":b.toString()}function qa(b){for(var a=[],h=1;h<arguments.length;h++)a[h-1]=arguments[h];return b.replace(/\$\{(\d+)\}/g,function(b,h){var g=parseInt(h,
10);return Fa(a[g])})}function Ga(b,a,h){return Object.defineProperty(b,a,{enumerable:!0,configurable:!0,writable:!0,value:h})}function ra(b,a,h,d){return Object.defineProperty(b,a,{enumerable:!0,configurable:!0,get:h,set:d})}function Ab(b,a){var h=document.createElement("script");h.src=b;h.onerror=a;document.head.appendChild(h)}function sa(b,a){if(b===a)return 0;if(void 0===b&&void 0!==a)return-1;if(void 0!==b&&void 0===a)return 1;if(null===b&&null!==a)return-1;if(null!==b&&null===a)return 1;var h=
typeof b,d=typeof a;if(h!==d)return h<d?-1:1;if("object"===h){if(b instanceof Date&&a instanceof Date)return sa(b.getTime(),a.getTime());if(b instanceof Array&&a instanceof Array){a:{for(var h=b.length,d=a.length,c=0,g=R(h,d);c<g;++c){var f=sa(b[c],a[c]);if(0!==f){h=f;break a}}h=h<d?-1:h>d?1:0}return h}if(b.consructor===Object&&a.constructor===Object){a:{for(var h=Ha(b).sort(),d=Ha(a).sort(),c=h.length,g=d.length,f=R(c,g),G=0;G<f;++G){var e=h[G],t=d[G];if(e<t||e>t){h=-1;break a}e=sa(b[e],a[t]);if(0!==
e){h=e;break a}}h=c<g?-1:c>g?1:0}return h}throw new TypeError("Cannot compare: ("+b+") and ("+a+")");}return b<a?-1:b>a?1:0}function ha(b,a){return(b||24)+"px "+(a||"Arial")}function ia(b,a){if(null==b)return a;if("function"===typeof b)return[b,a];b.push(a);return b}function ba(b){if(null!=b)if("function"===typeof b)M.then(b);else for(var a=0;a<b.length;a++)M.then(b[a])}function Ia(b){for(var a,h=b.length,d=0;d<b.length;d++)b[d].then(function(){0>=--h&&(ba(a),a=void 0)});return{then:function(b){0<
h?a=ia(a,b):M.then(b);return this}}}function hb(b){var a,h=function(){b().then(function(){ba(a);a=void 0;b=null})};h.then=function(h){b?a=ia(a,h):M.then(h);return this};return h}function e(){for(var b=[],a=0;a<arguments.length;a++)b[a-0]=arguments[a];return new N(b)}function Bb(b,a,h){function d(a){return(null==a.pageX?a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-b.offsetLeft:a.pageX-b.offsetLeft)*e/b.offsetWidth}function c(a){return(null==a.pageY?a.clientY+document.body.scrollTop+
document.documentElement.scrollTop-b.offsetTop:a.pageY-b.offsetTop)*p/b.offsetHeight}function g(){null!=I&&clearTimeout(I);I=setTimeout(function(){I=void 0;var a=b.parentElement,d=a.clientWidth,a=a.clientHeight,a=a-b.offsetTop;0<a&&(h.magnifyCanvas||(d=R(d,e),a=R(a,p)),d*p>e*a?d=ta(a*e/p):a=ta(d*p/e),0<d&&0<a&&(b.style.width=d+"px",b.style.height=a+"px",!h.refineCanvas&&(d>e||a>p)&&(d=e,a=p),b.width!==d||b.height!==a))&&(b.width=d,b.height=a)},300)}function f(h){M.finish();var d=b.width,c=b.height,
g=b.getContext("2d");g.clearRect(0,0,d,c);g.save();g.font=ha();d===e&&c===p||g.scale(d/e,c/p);a.onDraw(g,h);g.restore();window.requestAnimationFrame(f)}var e=b.width,p=b.height,t=window.navigator.pointerEnabled,l=window.navigator.msPointerEnabled,y=null!=document.ontouchstart,v=t?"pointerdown":l?"MSPointerDown":y?"touchstart":"mousedown",ua=t?"pointerup":l?"MSPointerUp":y?"touchend":"mouseup";b.addEventListener(t?"pointermove":l?"MSPointerMove":y?"touchmove":"mousemove",function(b){if(b.buttons&1)a.onDrag(d(b),
c(b));else a.onHover(d(b),c(b));b.preventDefault()});b.addEventListener(v,function(b){switch(b.button){case 0:a.onDown(d(b),c(b))}b.preventDefault()});b.addEventListener(ua,function(b){switch(b.button){case 0:a.onUp(d(b),c(b));break;case 2:a.onPress(k.TAB)}b.preventDefault()});b.addEventListener("contextmenu",function(a){a.preventDefault()});b.addEventListener("mousewheel",function(b){a.onPress(0<b.wheelDelta?k.PAGE_UP:k.PAGE_DOWN);b.preventDefault()});window.addEventListener("keydown",function(b){if(!b.ctrlKey&&
!b.altKey){var h=oa(b.keyCode,b.charCode);h&&k[h]&&(a.onPress(h),b.preventDefault())}});var I;window.addEventListener("resize",g);"complete"===document.readyState?g():window.addEventListener("load",g);window.requestAnimationFrame(f)}function Ja(b,a,h,d){void 0===d&&(d=!1);var c=b.w;b=b.h;if(c>a||b>h||d){d=c/a;var g=b/h;d>g?(c=a,b/=d):(c/=g,b=h)}return{w:c,h:b}}function Ka(b,a){if(a)for(var h in a)switch(h){case "fontSize":b.font=ha(a.fontSize,a.fontFamily);break;case "fontFamily":null==a.fontSize&&
(b.font=ha(null,a.fontFamily));break;default:b[h]=a[h]}}function La(b,a,h,d,c,g){var f;null==d?(g=a,a=g.x,f=g.y,d=g.w,c=g.h,g,g=h):f=h;if(0<d&&0<c){b.save();Ka(b,g);g&&!g.fillStyle||b.fillRect(a,f,d,c);if(!g||g.strokeStyle)h=b.lineWidth-1,b.strokeRect(a+h/2,f+h/2,d-h,c-h);b.restore()}}function Ma(b,a,h,d,c){function g(a,b,h,d,c){c&&!c.strokeStyle||a.strokeText(b,h,d);c&&!c.fillStyle||a.fillText(b,h,d)}b.save();Ka(b,c);if(0>a.indexOf("\n"))g(b,a,h,d,c);else{var f=a.split("\n");a=1.2*(c&&c.fontSize||
24);switch(b.textBaseline){case "top":for(var e=0;e<f.length;e++){var p=f[e];g(b,p,h,d,c);d+=a}break;case "middle":d-=a*(f.length-1)/2;for(e=0;e<f.length;e++)p=f[e],g(b,p,h,d,c),d+=a;break;case "bottom":for(e=0,f=f.reverse();e<f.length;e++)p=f[e],g(b,p,h,d,c),d-=a}}b.restore()}function va(b,a,h,d,c,g,f){b.save();Ka(b,f);switch(b.textAlign){case "center":h+=c/2;break;case "right":h+=c;break}if(0>a.indexOf("\n")){switch(b.textBaseline){case "middle":d+=g/2;break;case "bottom":d+=g;break}f&&!f.strokeStyle||
b.strokeText(a,h,d,c);f&&!f.fillStyle||b.fillText(a,h,d,c)}else{a=a.split("\n");var e=1.2*(f&&f.fontSize||24);switch(b.textBaseline){case "middle":d+=(g-e*(a.length-1))/2;break;case "bottom":d=d+g-e*(a.length-1);break}for(g=0;g<a.length;g++){var p=b,t=a[g],k=h,l=d,v=c,ua=f;ua&&!ua.strokeStyle||p.strokeText(t,k,l,v);ua&&!ua.fillStyle||p.fillText(t,k,l,v);d+=e}}b.restore()}function ib(b,a,h,d,c,g,f){b=b.createLinearGradient(a,h,d,c);b.addColorStop(0,g);b.addColorStop(1,f);return b}function wa(b,a,h,
d,c,g,f){0<d&&0<c&&(b.save(),b.fillStyle=ib(b,a,h,a,h+c,g,f),b.fillRect(a,h,d,c),b.restore())}function $a(b,a,h,d,c,g,f,e){void 0===e&&(e=0);0<d&&0<c&&(b.save(),b.translate(a+d/2,h+c/2),b.scale(d,c),a=b.createRadialGradient(0,0,e/2,0,0,.5),a.addColorStop(0,g),a.addColorStop(1,f),b.fillStyle=a,b.fillRect(-.5,-.5,1,1),b.restore())}function l(b,a,h){return"rgb("+b+","+a+","+h+")"}function w(b,a,h,d){return"rgba("+b+","+a+","+h+","+d.toFixed(6).replace(/([0-9]+(\.[0-9]+[1-9])?)(\.?0+$)/,"$1")+")"}function Na(b,
a){return null==a?l(b.r,b.g,b.b):w(b.r,b.g,b.b,a)}function ab(b){null==Oa&&(Oa=[e("Tag","Melee"),e("Tag","Throw"),e("Tag","Shoot"),e("Tag","Magic"),e("Tag","Alchemy"),e("Tag","Slash"),e("Tag","Blunt"),e("Tag","Pierce"),e("Tag","Shield"),e("Tag","Head"),e("Tag","Body"),e("Tag","Arms"),e("Tag","Legs"),e("Tag","Fire"),e("Tag","Cold"),e("Tag","Lightning"),e("Tag","Life")]);return b.map(function(a){return Oa[a].localized}).join(", ")}function xa(b){for(var a=0,h=0;h<b.length;h++)a|=1<<b[h];return a}function jb(b){var a=
{fillStyle:"white",strokeStyle:"black",fontSize:44,textAlign:"center",textBaseline:"middle"},h={textAlign:"right",textBaseline:"middle"},d={textAlign:"right",textBaseline:"middle"},c=new J(4,4,32,32,new H("assets/config.png"),function(){function c(a,b){var d=100+70*a;(new F(640,d,160,60,new B(b,h))).attach(p);return d}function f(a,b,h){a=c(a,b);b=new Cb(810,a+15,300,30,h);b.attach(p);(new F(1120,a,50,60,new B(h,d))).attach(p);return b}function G(a,b,h,d,f,e){a=c(a,b);var G=new J(810,a+0,100,60,new B(function(){var a=
f();G.pressed&&G.hover&&(a=!a);return(a?h:d).localized}),e);G.attach(p);return G}var p=new Pa;(new F(0,0,1280,720,new kb(Qa))).attach(p);(new F(0,20,1280,80,new B(e("Config","Caption"),a))).attach(p);(new J(480,495,320,90,new B(e("Config","OK")),function(){p.detach()},tb)).attach(p);var t=Ha(N.languages).sort().map(function(a){return e("Language",a)}),k=new D(10,10,160,D.heightOf(R(10,t.length)),[{name:e("Config","LanguageID"),extract:function(a){return a.src[1]},width:40,align:"center"},{name:e("Config",
"LanguageName"),extract:function(a){return a.localized}}],t,function(a){k.selected=a;N.language=a.src[1]});k.selected=k.rows.find(function(a){return a.src[1]===N.language});k.attach(p);f(0,e("Config","Volume"),q.volume);f(1,e("Config","CPUEffects"),q.effects);var t=e("Config","On"),l=e("Config","Off");G(2,e("Config","FullScreen"),t,l,function(){return System.getFullScreen()},function(){System.setFullScreenn(!System.getFullScreen())});G(3,e("Config","MagnifyCanvas"),t,l,function(){return q.magnifyCanvas},
function(){q.magnifyCanvas=!q.magnifyCanvas});G(4,e("Config","RefineCanvas"),t,l,function(){return q.refineCanvas},function(){q.refineCanvas=!q.refineCanvas});(function(a,b,h){a=new J(810,70*a+100,300,60,new B(b),h);a.attach(p);return a})(5,e("Config","BackToTitle"),function(){p.detach();Ra()});p.attach(b)},Db,new J.IconDesign("white"));c.attach(b);return c}function Sa(){try{var b=System.getRoamingStorage("NYO");if(!b)return null;var a=Ta(b);return{shop:a.shop,warehouse:V(ka,a.warehouse),reservers:V(W,
a.reservers),party:V(W,a.party),gold:a.gold}}catch(h){return E.error(h),null}}function bb(b){try{System.setRoamingStorage("NYO",cb(b))}catch(a){E.error(a)}db()}function Eb(){try{var b=System.getLocalStorage("NYO");if(b){var a=Ta(b);a&&(typeof a.language===typeof N.language&&(N.language=a.language),typeof a.magnifyCanvas===typeof q.magnifyCanvas&&(q.magnifyCanvas=a.magnifyCanvas),typeof a.refineCanvas===typeof q.refineCanvas&&(q.refineCanvas=a.refineCanvas),typeof a.volume===typeof q.volume.value&&
(q.volume.value=a.volume),typeof a.effects===typeof q.effects.value&&(q.effects.value=a.effects))}}catch(h){E.error(h)}}function db(){try{System.setLocalStorage("NYO",cb({language:N.language,magnifyCanvas:q.magnifyCanvas,refineCanvas:q.refineCanvas,volume:q.volume.value,effects:q.effects.value}))}catch(b){E.error(b)}}var x=this&&this.__extends||function(b,a){function h(){this.constructor=b}for(var d in a)a.hasOwnProperty(d)&&(b[d]=a[d]);b.prototype=null===a?Object.create(a):(h.prototype=a.prototype,
new h)},Ha=Object.keys,lb=Math.abs,R=Math.min,X=Math.max,r=Math.floor,Ua=Math.ceil,ta=Math.round,ca=Math.pow,S=Math.sin,la=Math.cos,ub=Math.atan2,T=Math.PI,Za=Math.random,Ta=JSON.parse,cb=JSON.stringify,Va=function(){},M={sig:null,then:function(b){this.sig=ia(this.sig,b);return this},finish:function(){var b=this.sig;if(b)if(this.sig=null,"function"===typeof b)b();else for(var a=0;a<b.length;a++)(0,b[a])()}},N=function(){function b(a){this.src=a}Object.defineProperty(b.prototype,"localized",{get:function(){function a(a){var h=
b.languages,g=b.language,f=h[g];null==f&&(g=b.language=b.fallback,f=h[g]);if("string"===typeof f)return h[g]=!0,Ab(f,function(){h[g]=!1}),null;if(!0===f)return null;if(!1===f)return a.join(".");for(var e=f,f=0,p=a.length;f<p;++f)if(e=e[a[f]],null==e)return a.join(".");return e.toString()}if(this._language!==b.language){var h=a(this.src);if(null===h)return this.src.join(".");this._language=b.language;this._localized=h}return this._localized},enumerable:!0,configurable:!0});b.prototype.toString=function(){return this.localized};
b.language=(window.navigator.userLanguage||window.navigator.language||window.navigator.browserLanguage).substr(0,2);b.fallback="en";b.languages={};return b}();System.localize=function(b,a){N.languages[b]=a};var k;(function(b){b[b.TAB=9]="TAB";b[b.ENTER=13]="ENTER";b[b.ESCAPE=27]="ESCAPE";b[b.SPACE=32]="SPACE";b[b.PAGE_UP=33]="PAGE_UP";b[b.PAGE_DOWN=34]="PAGE_DOWN";b[b._END=35]="_END";b[b._HOME=36]="_HOME";b[b.LEFT=37]="LEFT";b[b.UP=38]="UP";b[b.RIGHT=39]="RIGHT";b[b.DOWN=40]="DOWN";b[b._INSERT=45]=
"_INSERT";b[b.DELETE=46]="DELETE";b[b.$0=48]="$0";b[b.$1=49]="$1";b[b.$2=50]="$2";b[b.$3=51]="$3";b[b.$4=52]="$4";b[b.$5=53]="$5";b[b.$6=54]="$6";b[b.$7=55]="$7";b[b.$8=56]="$8";b[b.$9=57]="$9";b[b.A=65]="A";b[b.B=66]="B";b[b.C=67]="C";b[b.D=68]="D";b[b.E=69]="E";b[b.F=70]="F";b[b.G=71]="G";b[b.H=72]="H";b[b.I=73]="I";b[b.J=74]="J";b[b.K=75]="K";b[b.L=76]="L";b[b.M=77]="M";b[b.N=78]="N";b[b.O=79]="O";b[b.P=80]="P";b[b.Q=81]="Q";b[b.R=82]="R";b[b.S=83]="S";b[b.T=84]="T";b[b.U=85]="U";b[b.V=86]="V";
b[b.W=87]="W";b[b.X=88]="X";b[b.Y=89]="Y";b[b.Z=90]="Z"})(k||(k={}));var da=function(){function b(){}b.prototype.onHover=function(a,b){};b.prototype.onDrag=function(a,b){};b.prototype.onDown=function(a,b){};b.prototype.onUp=function(a,b){};b.prototype.onPress=function(a){};b.prototype.onDraw=function(a,b){};b.prototype.attach=function(a){return a.onAttach(this)};b.prototype.detach=function(){var a=this.parent;return a?(a.onDetach(this),a):null};Object.defineProperty(b.prototype,"visible",{get:function(){return!0},
set:function(a){Ga(this,"visible",a)},enumerable:!0,configurable:!0});return b}(),Q=function(b){function a(a){b.call(this);this.children=[];if(a)for(var d=0;d<a.length;d++)a[d].attach(this)}x(a,b);a.prototype.onAttach=function(a){if(a.parent===this)return!1;this.children.push(a);a.parent=this;return!0};a.prototype.onDetach=function(a){if(null==a.parent)return!1;a.parent=null;for(var b=this.children,c=0;c<b.length;++c)if(b[c]===a){a=this.children;for(var b=a.length,g=Array(b-1),f=0;f<c;++f)g[f]=a[f];
for(f=c+1;f<b;++f)g[f-1]=a[f];this.children=g;break}return!0};a.prototype.onHover=function(a,b){for(var c=0,g=this.children;c<g.length;c++){var f=g[c];if(f.visible)f.onHover(a,b)}};a.prototype.onDrag=function(a,b){for(var c=0,g=this.children;c<g.length;c++){var f=g[c];if(f.visible)f.onDrag(a,b)}};a.prototype.onDown=function(a,b){for(var c=0,g=this.children;c<g.length;c++){var f=g[c];if(f.visible)f.onDown(a,b)}};a.prototype.onUp=function(a,b){for(var c=0,g=this.children;c<g.length;c++){var f=g[c];
if(f.visible)f.onUp(a,b)}};a.prototype.onPress=function(a){for(var b=0,c=this.children;b<c.length;b++){var g=c[b];if(g.visible)g.onPress(a)}};a.prototype.onDraw=function(a,b){for(var c=0,g=this.children;c<g.length;c++){var f=g[c];if(f.visible)f.onDraw(a,b)}};return a}(da),kb=function(){function b(a){this.rectStyle=a}b.prototype.draw=function(a,b,d){La(a,d,this.rectStyle)};return b}(),B=function(){function b(a,b,d){this.value=a;this.textStyle=b;this.rectStyle=d;b&&b.fillStyle&&b.textAlign&&b.textBaseline||
(a=Object.create(b||null),b&&b.fillStyle||(a.fillStyle="white"),b&&b.textAlign||(a.textAlign="center"),b&&b.textBaseline||(a.textBaseline="middle"),this.textStyle=a)}b.prototype.draw=function(a,b,d){b=d.x;var c=d.y,g=d.w;d=d.h;this.rectStyle&&La(a,b,c,g,d,this.rectStyle);va(a,this.text,b,c,g,d,this.textStyle)};Object.defineProperty(b.prototype,"text",{get:function(){var a=this.value;"function"===typeof a&&(a=a());return Fa(a)},enumerable:!0,configurable:!0});return b}(),H=function(){function b(a){this.src=
a;this._image=void 0}b.from=function(a){var h=new b(void 0);h._image=a;return h};b.prototype.then=function(a){null==this._image?(this.sig=ia(this.sig,a),this.preload()):M.then(a);return this};b.prototype.preload=function(){var a=this;if(void 0===this._image){this._image=null;var h=new Image;h.addEventListener("load",function(){a._image=h;ba(a.sig);a.sig=void 0});h.addEventListener("error",function(){a._image=b.DUMMY;ba(a.sig);a.sig=void 0});h.src=this.src}};Object.defineProperty(b.prototype,"image",
{get:function(){void 0===this._image&&this.preload();return this._image},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"w",{get:function(){var a=this.image;return a?a.width:1},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"h",{get:function(){var a=this.image;return a?a.height:1},enumerable:!0,configurable:!0});b.prototype.draw=function(a,b,d,c,g){b=this.image;var f=d.x,e=d.y,p=d.w;d=d.h;b&&0<p&&0<d&&(!c||0>=g?a.drawImage(b,f,e,p,d):(a.save(),a.globalCompositeOperation=
"destination-out",a.drawImage(b,f,e,p,d),a.globalCompositeOperation="destination-over",a.fillStyle=c,a.fillRect(f,e,p,d),1>g&&(a.globalCompositeOperation="source-over",a.globalAlpha=1-g,a.drawImage(b,f,e,p,d)),a.restore()))};b.DUMMY=null;return b}(),Fb={fontSize:32,fillStyle:"white",strokeStyle:"black",textAlign:"left",textBaseline:"top",lineWidth:2},Qa={fillStyle:w(0,0,0,.8)},Gb={fillStyle:"white",strokeStyle:"black",fontSize:44,textAlign:"center",textBaseline:"middle"},K=function(b){function a(a,
d){b.call(this);this.duration=a;d&&(this.onAnimation=d)}x(a,b);a.prototype.attach=function(a){return b.prototype.attach.call(this,a)?(this.start=performance.now(),!0):!1};a.prototype.detach=function(){this.start=null;return b.prototype.detach.call(this)};a.prototype.onDraw=function(a,b){if(null!=this.start)if(b>=this.start+this.duration)this.onAnimation(1,a,b),this.detach(),ba(this.sig),this.sig=void 0;else if(b>=this.start)this.onAnimation((b-this.start)/this.duration,a,b)};a.prototype.onAnimation=
function(a,b,c){};a.prototype.then=function(a){this.sig=ia(this.sig,a);return this};a.clamp=function(a,b,c){return null==b||a<b?0:null==c||b+c<a?1:(a-b)/c};a.cycle=function(a,b,c){return null==b||null==c||a<b?0:(a-b)%c/c};return a}(da),vb=function(b){function a(a,d){void 0===d&&(d=400);b.call(this,d);this.next=a}x(a,b);a.prototype.onAnimation=function(a,b,c){if(1>a){if(0<a)this.next.onDraw(b,c);b.save();b.globalAlpha=1-a;b.fillStyle="black";b.fillRect(0,0,1280,720);b.restore()}else this.next.attach(this.parent)};
return a}(K),ea=function(b){function a(a,d,c){void 0===c&&(c=400);b.call(this,c);this.prev=a;this.next=d}x(a,b);a.prototype.attach=function(a){return b.prototype.attach.call(this,a)?(this.prev.detach(),!0):!1};a.prototype.onAnimation=function(a,b,c){1>a?(this.prev.onDraw(b,c),0<a&&(b.save(),b.globalAlpha=a,b.fillStyle="black",b.fillRect(0,0,1280,720),b.restore())):this.next&&(new vb(this.next,this.duration)).attach(this.parent)};return a}(K),Pa=function(b){function a(){b.apply(this,arguments)}x(a,
b);a.prototype.attach=function(a){return null==this.prev&&null!=a.parent&&b.prototype.attach.call(this,a.parent)?(a.detach(),this.prev=a,!0):!1};a.prototype.detach=function(){var a=b.prototype.detach.call(this);a&&this.prev.attach(a);return a};a.prototype.onDraw=function(a,d){this.prev.onDraw(a,d);b.prototype.onDraw.call(this,a,d)};a.confirm=function(b,d){for(var c=[],g=2;g<arguments.length;g++)c[g-2]=arguments[g];var f=new a;(new F(0,0,1280,720,new B(d,Gb,Qa))).attach(f);for(var g=c.length,e=1280/
(3+g),p=e/8,k=(1280-e*g-p*(g-1))/2,l=function(a){var b=c[a],h=b.click,d=b.mnemonic;(new J(k+(e+p)*a,495,e,90,new B(b.label),h?function(){f.detach();h()}:function(){f.detach()},d)).attach(f)},y=0;y<g;++y)l(y);f.attach(b);return f};return a}(Q),ma=function(b){function a(a,d,c,g){b.call(this);this.x=a;this.y=d;this.w=c;this.h=g}x(a,b);a.prototype.contains=function(a,b){return this.visible&&this.x<=a&&this.y<=b&&a<this.x+this.w&&b<this.y+this.h};Object.defineProperty(a.prototype,"left",{get:function(){return this.x},
set:function(a){this.w=this.w+this.x-a;this.x=a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"right",{get:function(){return this.x+this.w},set:function(a){this.w=a-this.x},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"top",{get:function(){return this.y},set:function(a){this.h=this.h+this.y-a;this.y=a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"bottom",{get:function(){return this.y+this.h},set:function(a){this.h=a-this.y},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"center",{get:function(){return{x:this.x+this.w/2,y:this.y+this.h/2}},enumerable:!0,configurable:!0});a.prototype.moveTo=function(a,b){this.x=a;this.y=b;return this};a.prototype.moveBy=function(a,b){this.x+=a;this.y+=b;return this};return a}(da),F=function(b){function a(a,d,c,g,f){b.call(this,a,d,c,g);this.drawable=f}x(a,b);a.prototype.onDraw=function(a,b){this.drawable.draw(a,b,this)};return a}(ma),J=function(b){function a(h,d,c,g,f,e,p,k){void 0===
k&&(k=a.defaultDesign);b.call(this,h,d,c,g);this.drawable=f;this.click=e;this.mnemonic=p;this.design=k;this.hover=!1}x(a,b);Object.defineProperty(a.prototype,"enabled",{get:function(){return!0},set:function(a){Ga(this,"enabled",a)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"state",{get:function(){return this.enabled?this.pressed?2:this.hover?1:0:3},enumerable:!0,configurable:!0});a.prototype.onHover=function(a,b){this.hover=this.contains(a,b);this.pressed=null};a.prototype.onDrag=
function(a,b){null!=this.pressed&&(this.pressed=this.contains(a,b))};a.prototype.onDown=function(a,b){this.enabled&&this.contains(a,b)&&(this.pressed=!0)};a.prototype.onUp=function(a,b){var c=this.pressed;this.pressed=null;if(c&&this.contains(a,b))this.onClick()};a.prototype.onPress=function(a){this.mnemonic&&0<=this.mnemonic.indexOf(a)&&this.enabled&&(this.pressed=!1,this.onClick())};a.prototype.onClick=function(){var a=this;this.click&&M.then(function(){return a.click()})};a.prototype.onDraw=function(a,
b){this.design.draw(a,b,this)};a.defaultDesign={draw:function(a,b,c){a.save();switch(c.state){case 0:a.fillStyle=w(0,0,0,.8);a.strokeStyle=l(200,200,200);break;case 1:a.fillStyle=w(0,0,50,.8);a.strokeStyle=l(100,100,200);break;case 2:a.fillStyle=w(0,0,150,.8);a.strokeStyle=l(100,100,255);break;case 3:a.fillStyle=w(200,200,200,.8),a.strokeStyle=l(200,200,200)}a.fillRect(c.x,c.y,c.w,c.h);a.strokeRect(c.x,c.y,c.w,c.h);a.restore();c.drawable&&c.drawable.draw(a,b,c)}};a.IconDesign=function(){function a(b){this.overlay=
b}a.prototype.draw=function(a,b,h){var f=h.drawable;switch(h.state){case 0:f.draw(a,b,h);break;case 1:f.draw(a,b,h,this.overlay,.7);break;case 2:f.draw(a,b,h,this.overlay,.9);break;case 3:f.draw(a,b,h,l(200,200,200),.8)}};return a}();return a}(ma),Hb=function(b){function a(a,d,c,g,f,e,p,k,l,y){void 0===y&&(y=J.defaultDesign);b.call(this,a,d,c,g,e,p,l,y);this.group=f;this.swap=k;f.push(this)}x(a,b);a.prototype.onDrag=function(a,d){var c=this;b.prototype.onDrag.call(this,a,d);if(this.dragged&&!this.swapping){var g=
this.group.find(function(b){return b!==c&&b.contains(a,d)&&!b.swapping});if(g){var f=performance.now();this.onSwap(g,f);g.onSwap(this,f);this.dragged={xOrig:this.swapping.xTo,yOrig:this.swapping.yTo};this.swap&&this.swap(g)}else null!=this.dragged.xDown?(this.x=this.dragged.xOrig-this.dragged.xDown+a,this.y=this.dragged.yOrig-this.dragged.yDown+d):(this.dragged.xDown=a,this.dragged.yDown=d)}};a.prototype.onDown=function(a,d){b.prototype.onDown.call(this,a,d);!this.dragged&&this.contains(a,d)&&(this.dragged=
{xDown:a,yDown:d,xOrig:this.x,yOrig:this.y})};a.prototype.onUp=function(a,d){if(this.swapping)this.dragged=null,b.prototype.onUp.call(this,a,d);else if(this.dragged){var c=this.dragged,g=c.xOrig,c=c.yOrig;this.swapping={start:performance.now(),xFrom:this.x,yFrom:this.y,xTo:g,yTo:c};this.dragged=null;if(this.pressed&&(this.pressed=null,this.contains(a,d)&&g<=a&&c<=d&&a<g+this.w&&d<c+this.h))this.onClick()}else b.prototype.onUp.call(this,a,d)};a.prototype.onSwap=function(a,b){this.pressed=null;this.swapping=
{start:b,xFrom:this.x,yFrom:this.y,xTo:a.dragged?a.dragged.xOrig:a.x,yTo:a.dragged?a.dragged.yOrig:a.y}};a.prototype.onDraw=function(a,d){if(this.swapping){var c=K.clamp(d,this.swapping.start,200);1>c?(c=(1-la(T*c))/2,this.x=this.swapping.xFrom*(1-c)+this.swapping.xTo*c,this.y=this.swapping.yFrom*(1-c)+this.swapping.yTo*c):(this.x=this.swapping.xTo,this.y=this.swapping.yTo,this.swapping=null)}b.prototype.onDraw.call(this,a,d)};return a}(J),D=function(b){function a(h,d,c,g,f,e,p,k){void 0===k&&(k=
a.defaultDesign);b.call(this,h,d,c,g);this.columns=f;this.rows=e;this.click=p;this.design=k;this.topRow=0}x(a,b);a.heightOf=function(b,d){void 0===d&&(d=a.defaultDesign);return d.headerHeight+b*d.rowHeight};a.prototype.onHover=function(a,b){this.hover=this.toRowIndex(a,b);this.scrolling=this.dragged=null};a.prototype.onDrag=function(a,b){var c=this.design.headerHeight;null!=this.scrolling?this.scrollTo(r(this.rows.length*(b-(this.y+c)-this.scrolling)/(this.h-c))):(c=this.toRowIndex(a,b),null!=c&&
null!=this.dragged&&c!==this.dragged&&(g=[this.rows[c],this.rows[this.dragged]],this.rows[this.dragged]=g[0],this.rows[c]=g[1],this.dragged=c,this.sortkeys=this.scrolling=this.hover=null));var g};a.prototype.onDown=function(a,b){if(this.contains(a,b)&&(this.hover=this.dragged=this.toRowIndex(a,b),null==this.dragged)){var c=this.design,g=c.headerHeight,f=this.w-c.scrollBarWidth,c=this.y+g;if(this.x<=a&&a<this.x+f&&this.y<=b&&b<c)c=this.toColumnIndex(a,b),null!=c&&this.sort(c,null!=this.sortkeys&&this.sortkeys[0]===
c+1);else if(this.x+f<=a&&a<this.right){var f=this.rows.length,e=this.displayCount,g=this.h-g,k=c+g*this.topRow/f,l=g*e/f;c<=b&&b<k?(this.scrollTo(r(f*(b-c)/g)),k=c+g*this.topRow/f):k+l<=b&&b<this.bottom&&(this.scrollTo(r(f*(b-c)/g)-e+1),k=c+g*this.topRow/f);k<=b&&b<k+l&&(this.scrolling=b-k)}}};a.prototype.onUp=function(a,b){null==this.scrolling&&null!=this.dragged&&this.dragged===this.hover&&(this.click(this.rows[this.dragged],this.dragged),this.refresh());this.scrolling=this.dragged=null;this.hover=
this.toRowIndex(a,b)};a.prototype.onPress=function(a){switch(a){case k.PAGE_DOWN:this.scrollBy(this.scrollStep);break;case k.PAGE_UP:this.scrollBy(-this.scrollStep)}};a.prototype.onDraw=function(a,b){var c=this.design,g=c.headerHeight,f=c.scrollBarWidth,e=this.rows.length,k=this.displayCount,l=this.x,q=this.y+g,y=this.w-f,v=this.h-g,r=this.x+y,I=(0<e&&v*this.topRow/e||0)+q,O=0<e&&v*k/e||v,rb=this.defaultColumnWidth;c.drawHeader(a,this.x,this.y,this.w,g);c.drawBackground(a,this.x,q,y,v);0<f&&(c.drawHeader(a,
r,q,f,v),k<e&&c.drawScrollBar(a,r,I,f,O));a.save();a.font=c.rowFont;a.fillStyle=c.rowStyle;a.textBaseline="middle";for(var O=c.rowHeight,P=0;P<k;++P){var f=P+this.topRow,sb=this.rows[f],ja=q+O*P;f===this.dragged?c.drawRowDragged(a,this.x,ja,y,O):sb===this.selected?c.drawRowSelected(a,this.x,ja,y,O):f===this.hover&&null==this.dragged&&c.drawRowHover(a,this.x,ja,y,O);for(var w=0,f=0,e=this.columns.length;f<e;++f){var r=this.columns[f],I=oa(r.width,rb),ya=this.extract(sb,r);if(null!=ya){var Y=l+w+2,
mb=I-4;a.textAlign=r.align||"left";switch(a.textAlign){case "center":Y+=mb/2;break;case "right":Y+=mb}a.fillText(ya,Y,ja+O/2,mb)}w+=I}}a.restore();a.save();O=0;a.font=c.headerFont;a.fillStyle=c.headerStyle;a.textAlign="center";a.textBaseline="middle";a.strokeStyle=c.lineStyle;f=0;for(e=this.columns.length;f<e;++f)r=this.columns[f],I=oa(r.width,rb),P=l+O,0<f&&(a.beginPath(),a.moveTo(P,q),a.lineTo(P,this.bottom),a.stroke()),a.fillText(r.name.localized,P+I/2,this.y+g/2),O+=I;a.restore();0===k&&0<v&&
c.emptyText&&(a.save(),a.font=c.emptyFont,a.textAlign="center",a.textBaseline="middle",a.fillStyle=c.emptyStyle,a.fillText(c.emptyText.localized,this.x+y/2,q+v/2),a.restore())};Object.defineProperty(a.prototype,"displayCount",{get:function(){var a=this.design;return R(r((this.h-a.headerHeight)/a.rowHeight),this.rows.length)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"scrollStep",{get:function(){return X(r(.2*this.displayCount),1)},enumerable:!0,configurable:!0});a.prototype.extract=
function(a,b){var c=b.extract;switch(typeof c){case "function":return c(a);case "number":return a[c];default:return a[c]}};a.prototype.compare=function(a,b){for(var c=0,g=0,f=this.sortkeys.length;0===c&&g<f;++g){var e=this.sortkeys[g],c=this.columns[(0<e?e:-e)-1],c=c.compare?c.compare(a,b):sa(this.extract(a,c),this.extract(b,c));0>e&&(c=-c)}return c};a.prototype.sort=function(a,b){var c=this;void 0===b&&(b=!1);var g=a+1;if(this.sortkeys){for(var f=0,e=this.sortkeys.length;f<e;++f)if(this.sortkeys[f]===
g||this.sortkeys[f]===-g){this.sortkeys.splice(f,1);break}this.sortkeys.unshift(b?-g:g)}else this.sortkeys=[b?-g:g];this.rows.sort(function(a,b){return c.compare(a,b)})};a.prototype.toRowIndex=function(a,b){var c=this.design,g=this.w-c.scrollBarWidth;return this.x<=a&&a<this.x+g&&(c=this.topRow+r((b-this.y-c.headerHeight)/c.rowHeight),this.topRow<=c&&c<this.rows.length)?c:null};a.prototype.toColumnIndex=function(a,b){var c=this.w-this.design.scrollBarWidth;if(this.x<=a&&a<this.x+c)for(var c=this.defaultColumnWidth,
g=this.x,f=0,e=this.columns.length;f<e;++f){var k=oa(this.columns[f].width,c);if(g<=a&&a<g+k)return f;g+=k}return null};Object.defineProperty(a.prototype,"defaultColumnWidth",{get:function(){for(var a=this.w-this.design.scrollBarWidth,b=0,c=0,g=0,f=this.columns;g<f.length;g++){var e=f[g];null!=e.width?b+=e.width:++c}return 0<c&&b<a?(a-b)/c:0},enumerable:!0,configurable:!0});a.prototype.refresh=function(){var a=this.rows.length;this.dragged>=a&&(this.dragged=null);this.hover>=a&&(this.hover=null);
this.scrollTo(this.topRow)};a.prototype.scrollTo=function(a){this.topRow=ga(0,this.rows.length-this.displayCount,a)};a.prototype.scrollBy=function(a){this.scrollTo(this.topRow+a)};a.defaultDesign={rowHeight:28,rowFont:ha(20),rowStyle:"white",headerHeight:24,headerFont:ha(18),headerStyle:"white",scrollBarWidth:14,lineStyle:l(102,102,102),drawHeader:function(a,b,c,g,f){a.save();a.fillStyle=w(25,25,25,.8);a.fillRect(b,c,g,f);a.restore()},drawBackground:function(a,b,c,g,f){a.save();a.fillStyle=w(0,0,
0,.6);a.fillRect(b,c,g,f);a.restore()},drawScrollBar:function(a,b,c,g,f){wa(a,b,c,g,f,l(100,100,100),l(75,75,75))},drawRowDragged:function(a,b,c,g,f){wa(a,b,c,g,f,l(255,0,0),l(50,0,0))},drawRowSelected:function(a,b,c,g,f){wa(a,b,c,g,f,l(100,0,0),l(50,0,0))},drawRowHover:function(a,b,c,g,f){wa(a,b,c,g,f,l(75,0,0),l(50,0,0))}};return a}(ma),wb=function(){function b(a,b,d){this.min=b;this.max=d;this.value=a}Object.defineProperty(b.prototype,"value",{get:function(){return this._value},set:function(a){this._value=
ga(this.min,this.max,ta(a))},enumerable:!0,configurable:!0});b.prototype.toString=function(){return this._value.toString()};b.prototype.valueOf=function(){return this._value};return b}(),Cb=function(b){function a(h,d,c,g,f,e){void 0===e&&(e=a.defaultDesign);b.call(this,h,d,c,g);this.value=f;this.design=e;this.hover=this.dragged=!1}x(a,b);a.prototype.getValueAsX=function(){var a=this.design.knobWidth,b=this.value,c=b.min;return this.x+a/2+(b.value-c)/(b.max-c)*(this.w-a)};a.prototype.setValueByX=function(a){var b=
this.design.knobWidth;a=ga(0,1,(a-this.x-b/2)/(this.w-b));var b=this.value,c=b.min;this.value.value=ta(c+a*(b.max-c))};a.prototype.onHover=function(a,b){this.hover=this.contains(a,b);this.dragged=!1};a.prototype.onDrag=function(a,b){this.hover=this.dragged&&this.contains(a,b);this.dragged&&this.setValueByX(a)};a.prototype.onDown=function(a,b){this.contains(a,b)&&(this.dragged=!0,this.setValueByX(a))};a.prototype.onUp=function(a,b){this.dragged=!1};a.prototype.onDraw=function(a,b){this.design.draw(a,
b,this)};Object.defineProperty(a.prototype,"knob",{get:function(){var a=this.design.knobWidth,b=this.h;return{x:this.getValueAsX()-a/2,y:this.y-(this.h-b)/2,w:a,h:b,state:this.dragged?2:this.hover?1:0}},enumerable:!0,configurable:!0});a.defaultDesign={knobWidth:12,draw:function(a,b,c){La(a,c,{fillStyle:w(50,50,50,.8),strokeStyle:"white",lineWidth:4});b=c.knob;c={strokeStyle:"white",lineWidth:4};switch(b.state){case 0:c.fillStyle=w(150,150,150,.8);break;case 1:c.fillStyle=w(200,200,200,.8);break;case 2:c.fillStyle=
w(255,255,255,.8)}La(a,b,c)}};return a}(ma),Ib=function(b){function a(a,d,c,g,e,k){b.call(this,a,d,c,g);this.duration=e;this.style=k;this.logs=[]}x(a,b);a.prototype.onDraw=function(a,b){var c=this.logs;if(0<c.length){var e=b-this.duration,f=c.findIndex(function(a){return a.when>e});0>f?c.length=0:c.splice(0,f);f=c.length;if(0<f)for(var k=this.style,l=1.2*(k&&k.fontSize||24),t=0;t<f;++t)va(a,c[t].message,this.x,this.y+t*l,this.w,l,k)}};a.prototype.log=function(a){if(a){var b=performance.now(),c=this.logs,
e=c.length;0<e&&c[e-1].message===a?c[e-1].when=b:c.push({message:Fa(a),when:b})}};a.prototype.error=function(a){this.log(a)};return a}(ma);N.languages.en="assets/lang/en.js";N.languages.ja="assets/lang/ja.js";var nb={bkgnd:w(0,0,0,.6),delta:l(255,51,0),normal:l(153,204,0),full:l(0,204,51)},xb={bkgnd:w(0,0,0,.6),delta:l(0,51,102),normal:l(0,153,204),full:l(0,153,255)},za=[{PICK:0,WALK:!1,POPUP:!1},{PICK:0,WALK:!1,POPUP:!0},{PICK:0,WALK:!0,POPUP:!0},{PICK:300,WALK:!0,POPUP:!0}],tb=[k.TAB,k.ENTER,k.ESCAPE,
k.SPACE,k.DELETE],ob=[k.ENTER,k.SPACE,k.Y],pb=[k.TAB,k.ESCAPE,k.DELETE,k.N],Db=[k.ESCAPE],Jb=[k.ENTER,k.SPACE],E,Kb={Warrior:{INT:4,DEX:4,STR:7,equipments:["Mace","PlateArmor","Mace"],skills:["Swing","Crash","Bash","PathToWarrior"],image:"nazrin"},Samurai:{INT:3,DEX:7,STR:5,equipments:["Katana","Chainmail"],skills:["Swing","Slash","CutThrough","Sweep"],image:"rin"},Knight:{INT:6,DEX:2,STR:7,equipments:["Spear","LamellarArmor","KiteShield"],skills:["Swing","Stab","Thrust","ShieldBash","ShieldCharge"],
image:"toramaru"},Thief:{INT:3,DEX:6,STR:6,equipments:["LongBow","LetherArmor","FirstAidKit"],skills:["Shoot","FirstAid"],image:"marisa"},Healer:{INT:7,DEX:3,STR:5,equipments:["Staff","Robe"],skills:["Swing","Heal","PartyHeal"],image:"reimu"},Mage:{INT:8,DEX:4,STR:3,equipments:["Wand","Robe"],skills:["FireBall","IceSpear","DrainLife","LightningLaser","FireNova"],image:"utsuho"}},yb={Ant:{INT:3,DEX:3,STR:4,equipments:["Dagger","LetherArmor"],skills:["Swing"],image:"ant.png"},Elemental:{INT:4,DEX:3,
STR:3,equipments:["Wand","LetherArmor"],skills:["FireBall","ResistFire"],image:"elemental.png"},Frog:{INT:4,DEX:4,STR:4,equipments:["ShortBow","LetherArmor"],skills:["Shoot"],image:"frog.png"},Plant:{INT:4,DEX:3,STR:4,equipments:["Wand","LetherArmor"],skills:["FireNova"],image:"plant.png"},Slug:{INT:3,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["DrainLife"],image:"slug.png"},Snail:{INT:3,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["Heal"],image:"snail.png"},Sword:{INT:3,DEX:5,
STR:4,equipments:["LongSword","LetherArmor"],skills:["Swing"],image:"sword.png"},Wall:{INT:2,DEX:2,STR:6,equipments:["Mace","LetherArmor"],skills:["Swing"],image:"wall.png"},Weasel:{INT:3,DEX:6,STR:3,equipments:["Spear","LetherArmor"],skills:["Thrust"],image:"weasel.png"}},Lb={AddedFire:{tags:[0,1,2],min:5,max:10,ATK:function(b,a){return a+b}}},U={Dagger:{tags:[0,5],weight:13,price:100,ATK:30},ShortSword:{tags:[0,5],weight:15,price:100,ATK:40},LongSword:{tags:[0,5],weight:16,price:100,ATK:50},Katana:{tags:[0,
5],weight:15,price:100,ATK:45},Axe:{tags:[0,5,6],weight:18,price:100,ATK:45},Mace:{tags:[0,6],weight:16,price:100,ATK:40},Spear:{tags:[0,7],weight:20,price:100,ATK:50},Halberd:{tags:[0,5,6,7],weight:30,price:100,ATK:50},ShortBow:{tags:[2,7],weight:18,price:100,ATK:30},LongBow:{tags:[2,7],weight:20,price:100,ATK:40},Staff:{tags:[0,6,3],weight:20,price:100,ATK:20},Wand:{tags:[3],weight:16,price:100,ATK:25},FirstAidKit:{tags:[4],weight:10,price:100,ATK:10},Buckler:{tags:[8],weight:20,price:100,ATK:10,
DEF:10},RoundShield:{tags:[8],weight:25,price:100,ATK:15,DEF:15},SpikedShield:{tags:[8],weight:30,price:100,ATK:30,DEF:15},KiteShield:{tags:[8],weight:35,price:100,ATK:20,DEF:20},TowerShield:{tags:[8],weight:40,price:100,ATK:30,DEF:20},Circlet:{tags:[9],weight:5,price:100,DEF:2},LeatherHood:{tags:[9],weight:10,price:100,DEF:4},Mask:{tags:[9],weight:15,price:100,DEF:6},Sallet:{tags:[9],weight:20,price:100,DEF:8},Bascinet:{tags:[9],weight:25,price:100,DEF:10},Helmet:{tags:[9],weight:30,price:100,DEF:12},
Robe:{tags:[10],weight:20,price:100,DEF:10},LetherArmor:{tags:[10],weight:25,price:100,DEF:15},ScaleArmor:{tags:[10],weight:30,price:100,DEF:20},Chainmail:{tags:[10],weight:35,price:100,DEF:22},LamellarArmor:{tags:[10],weight:40,price:100,DEF:25},PlateArmor:{tags:[10],weight:45,price:100,DEF:30},Gloves:{tags:[11],weight:10,price:100,DEF:4},Mittens:{tags:[11],weight:20,price:100,DEF:6},Gauntlets:{tags:[11],weight:30,price:100,DEF:8},Slippers:{tags:[12],weight:5,price:100,DEF:2},Sandals:{tags:[12],
weight:10,price:100,DEF:4},Shoes:{tags:[12],weight:15,price:100,DEF:6},Boots:{tags:[12],weight:20,price:100,DEF:8},Greaves:{tags:[12],weight:25,price:100,DEF:10}},Mb={Dummy:{tags:[],usage:1,power:0,cost:999,range:0,effect:"Damage",action:"Charge"},Swing:{tags:[0],usage:1,power:100,cost:14,range:1,effect:"Damage",action:"Charge"},Slash:{tags:[0,5],usage:1,power:110,cost:15,range:1,effect:"Damage",action:"Charge"},CutThrough:{tags:[0,5],usage:1,power:100,cost:20,range:1,effect:"Damage",action:"GoBehind"},
Sweep:{tags:[0,5],usage:5,power:100,cost:20,range:1,effect:"Damage",action:"Nova"},Crash:{tags:[0,6],usage:1,power:110,cost:15,range:1,effect:"Damage",action:"Charge"},Bash:{tags:[0,6],usage:1,power:100,cost:20,range:1,effect:"Damage",action:"Knockback"},Stab:{tags:[0,7],usage:1,power:110,cost:15,range:1,effect:"Damage",action:"Charge"},Thrust:{tags:[0,7],usage:3,power:100,cost:15,range:2,effect:"Damage",action:"Laser"},ShieldBash:{tags:[8],usage:1,power:100,cost:20,range:1,effect:"Damage",action:"Charge"},
ShieldCharge:{tags:[8],usage:1,power:100,cost:24,range:1,effect:"Damage",action:"Trample"},Shoot:{tags:[2],usage:1,power:100,cost:20,range:3,effect:"Damage",action:"Shoot"},IceSpear:{tags:[3,14],usage:1,power:80,cost:16,range:5,effect:"DamageHPandSP",action:"Shoot"},DrainLife:{tags:[3,16],usage:1,power:80,cost:16,range:5,effect:"Damage",action:"Drain"},FireBall:{tags:[3,13],usage:1,power:100,cost:16,range:5,effect:"Damage",action:"Explode"},LightningLaser:{tags:[3,15],usage:3,power:100,cost:16,range:5,
effect:"Damage",action:"Laser"},FireNova:{tags:[3,13],usage:5,power:100,cost:16,range:2,effect:"Damage",action:"Nova"},Heal:{tags:[3,16],usage:2,power:100,cost:24,range:3,effect:"Heal",action:"Shoot"},PartyHeal:{tags:[3,16],usage:6,power:100,cost:24,range:1,effect:"Heal",action:"Nova"},FirstAid:{tags:[4,16],usage:2,power:100,cost:24,range:1,effect:"Heal",action:"Charge"},PathToWarrior:{tags:[0],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},PathToNinja:{tags:[1],usage:0,power:2,cost:10,effect:"Aura",
action:"Offence"},PathToArcher:{tags:[2],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},PathToMage:{tags:[3],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},PathToAlchemist:{tags:[4],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},Defence:{tags:[0],usage:0,power:2,cost:10,effect:"Aura",action:"Defence"},Dodge:{tags:[1,2],usage:0,power:2,cost:10,effect:"Aura",action:"Defence"},Meditation:{tags:[3],usage:0,power:2,cost:10,effect:"Aura",action:"Defence"},Healthy:{tags:[4],usage:0,
power:2,cost:10,effect:"Aura",action:"Defence"},AvatarOfFire:{tags:[13],usage:0,power:4,cost:10,effect:"Aura",action:"Offence"},AvatarOfCold:{tags:[14],usage:0,power:4,cost:10,effect:"Aura",action:"Offence"},AvatarOfLightning:{tags:[15],usage:0,power:4,cost:10,effect:"Aura",action:"Offence"},ResistFire:{tags:[13],usage:0,power:4,cost:10,effect:"Aura",action:"Defence"},ResistCold:{tags:[14],usage:0,power:4,cost:10,effect:"Aura",action:"Defence"},ResistLightning:{tags:[15],usage:0,power:4,cost:10,effect:"Aura",
action:"Defence"}},Oa,Nb=xa([0,1,2,3,4,5,6,7]),Ob=xa([8,9,10,11,12]),Aa=function(){function b(a){this.EID=a;this.def=Lb[this.EID];if(null==this.def)throw new RangeError('Enchantment not found: "'+this.EID+'"');this.name=b.nameOf(this.EID);this.spec=b.specOf(this.EID);this.value=this.def.min+Ea(this.def.max-this.def.min)}b.prototype.qualify=function(a){return qa(this.name.localized,a)};b.prototype.modify=function(a){this.def.ATK&&(a=this.def.ATK(this.value,a));return a};b.nameOf=function(a){return e("Enchant",
a,"Name")};b.specOf=function(a){return e("Enchant",a,"Spec")};b.from=function(a){return new b(a)};b.fromJSON=function(a){return new b(a.EID)};b.prototype.toJSON=function(){return{EID:this.EID,value:this.value}};return b}(),ka=function(){function b(a,h){this.IID=a;this.enchants=h;this.def=U[this.IID];if(null==this.def)throw new RangeError('Item not found: "'+this.IID+'"');this.baseName=b.nameOf(this.IID);this.spec=b.specOf(this.IID);this.tagbits=xa(this.def.tags);null==this.enchants&&(this.enchants=
(this.def.enchants||[]).map(Aa.from))}Object.defineProperty(b.prototype,"name",{get:function(){for(var a=this.baseName.localized,b=0,d=this.enchants;b<d.length;b++)a=d[b].qualify(a);return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"tags",{get:function(){return this.def.tags},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"weight",{get:function(){return this.def.weight},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"priceToSell",{get:function(){for(var a=
this.def.price,b=0,d=this.enchants;b<d.length;b++)a=d[b].modify(a);return r(a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"ATK",{get:function(){for(var a=this.def.ATK||0,b=0,d=this.enchants;b<d.length;b++)a=d[b].modify(a);return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"DEF",{get:function(){for(var a=this.def.DEF||0,b=0,d=this.enchants;b<d.length;b++)a=d[b].modify(a);return a},enumerable:!0,configurable:!0});b.nameOf=function(a){return e("Item",
a,"Name")};b.specOf=function(a){return e("Item",a,"Spec")};b.from=function(a){return new b(a)};b.fromJSON=function(a){return new b(a.IID,V(Aa,a.enchants))};b.prototype.toJSON=function(){return{IID:this.IID,enchants:pa(this.enchants)}};return b}(),eb=function(){function b(a){this.SID=a;this.def=Mb[a];if(null==this.def)throw new RangeError('Skill not found: "'+a+'"');this.name=b.nameOf(a);this.spec=b.specOf(a);this.tagbits=xa(this.def.tags)}Object.defineProperty(b.prototype,"tags",{get:function(){return this.def.tags},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"rawCost",{get:function(){return this.def.cost},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"rawRange",{get:function(){return this.def.range},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"rawPower",{get:function(){return this.def.power},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"target",{get:function(){return this.def.usage},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"hostile",{get:function(){var a;a:switch(this.def.usage){case 2:case 4:case 6:a=!1;break a;default:a=!0}return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"effect",{get:function(){return this.def.effect},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"action",{get:function(){return this.def.action},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"isActive",{get:function(){return"Aura"!==this.effect},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"isPassive",{get:function(){return"Aura"===this.effect},enumerable:!0,configurable:!0});b.prototype.match=function(a){var b=this.tagbits&Nb;return(b&a.tagbits)===b};b.nameOf=function(a){return e("Skill",a,"Name")};b.specOf=function(a){return e("Skill",a,"Spec")};b.from=function(a){return new b(a)};b.fromJSON=function(a){return new b(a.SID)};b.prototype.toJSON=function(){return{SID:this.SID}};b.DUMMY=new b("Dummy");return b}(),zb=[1,2,3,4,5,5,5,5,4,3,2,1],Wa;(function(b){b[b.DEFAULT=0]="DEFAULT";b[b.BLINK_1=
1]="BLINK_1";b[b.BLINK_2=2]="BLINK_2";b[b.BLINK_3=3]="BLINK_3";b[b.BLINK_4=4]="BLINK_4";b[b.CLOSED=5]="CLOSED"})(Wa||(Wa={}));var W=function(){function b(a,b,d,c,e,f,k,l,t){this.name=a;this.level=b;this.INT=d;this.DEX=c;this.STR=e;this.equipments=f;this.skills=k;this.known=l;this.src=t;var r=[];a=0>t.indexOf("/")?"assets/char/"+t:t;if(t.endsWith(".png"))t=new H(a),r[0]=t;else{var q=function(){for(var a=[],b=0;b<arguments.length;b++)a[b-0]=arguments[b];if(0>=a.length)return null;var b=a[0],c=b.w,d=
b.h,b=document.createElement("canvas");b.width=c;b.height=d;for(var e=b.getContext("2d"),c={x:0,y:0,w:c,h:d},d=0;d<a.length;d++)a[d].draw(e,null,c);return H.from(b)},v=[new H(a+"/back.png"),new H(a+"/eye.png"),new H(a+"/eye1.png"),new H(a+"/eye2.png"),new H(a+"/eye3.png"),new H(a+"/eye4.png"),new H(a+"/eye5.png"),new H(a+"/fore.png")];Ia(v).then(function(){return r.push(q(v[0],v[1],v[7]),q(v[0],v[2],v[7]),q(v[0],v[3],v[7]),q(v[0],v[4],v[7]),q(v[0],v[5],v[7]),q(v[0],v[6],v[7]))})}this.images=r;this.blinkCycle=
4500+100*d;this.blinkOffset=Ea(this.blinkCycle)}Object.defineProperty(b.prototype,"w",{get:function(){var a=this.images[0];return a?a.w:1},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"h",{get:function(){var a=this.images[0];return a?a.h:1},enumerable:!0,configurable:!0});b.prototype.draw=function(a,b,d,c,e){var f;f=(b+this.blinkOffset)%this.blinkCycle;f=450>f?zb[r(f/450*zb.length)]:0;var k=this.images;(f=k[f]||k[Wa.DEFAULT])&&f.draw(a,b,d,c,e)};Object.defineProperty(b.prototype,
"HP",{get:function(){return 10*(3+this.STR)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"SP",{get:function(){var a=X(0,this.weight-this.maxWeight);return X(0,4*(3+this.STR)-a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"reservedSP",{get:function(){var a=this;return this.skills.reduce(function(b,d){return b+(d.isPassive?a.costOf(d):0)},0)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"step",{get:function(){return 13-this.DEX},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"ZoC",{get:function(){return 3+this.DEX},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"maxWeight",{get:function(){return 10*(3+this.STR)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"weight",{get:function(){return this.equipments.reduce(function(a,b){return a+b.weight},0)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"DEF",{get:function(){return 100*(1-this.equipments.reduce(function(a,
b){return a*(1-b.DEF/100)},1))},enumerable:!0,configurable:!0});b.prototype.costOf=function(a){return null==a?void 0:a.rawCost-this.INT};b.prototype.rangeOf=function(a){return null==a?void 0:a.rawRange};b.prototype.powerOf=function(a){var b=this.itemFor(a);return b?b.ATK*a.rawPower/100:void 0};b.prototype.itemFor=function(a){var b=void 0;if(a)for(var d=0,c=0,e=this.equipments;c<e.length;c++){var f=e[c];if(a.match(f)){var k=f.ATK;d<k&&(d=k,b=f)}}return b};b.adventurer=function(a){var h=Kb[a];if(null==
h)throw new RangeError('Adventurer not found: "'+a+'"');return b.from(e("Adventurer",a),0,h)};b.monster=function(a,h){var d=yb[a];if(null==d)throw new RangeError('Monster not found: "'+a+'"');return b.from(e("Monster",a),h,d)};b.from=function(a,e,d){return new b(a.localized,e,d.INT,d.DEX,d.STR,d.equipments.map(ka.from),d.skills.map(eb.from),[],d.image)};b.fromJSON=function(a){return new b(a.name,a.level||0,a.INT,a.DEX,a.STR,V(ka,a.equipments),V(eb,a.skills),V(eb,a.known),a.image)};b.prototype.toJSON=
function(){return{name:this.name,level:this.level,INT:this.INT,DEX:this.DEX,STR:this.STR,equipments:pa(this.equipments),skills:pa(this.skills),known:pa(this.known),image:this.src}};return b}(),Ba;(function(b){var a=function(a){function b(){var c=this;a.call(this);(new F(0,0,1280,720,new H("assets/scene/title.jpg"))).attach(this);var g=Sa(),f=function(a){(new ea(c,new Xa.Home(a))).attach(c.parent)},k,l;g?(k=e("Title","Continue"),l=function(){return f(g)},(new J(1070,650,200,60,new B(e("Title","Delete")),
function(){Pa.confirm(c,e("Title","ConfirmDelete"),{label:e("Title","Delete"),click:function(){try{System.setRoamingStorage("NYO",null)}catch(a){E.error(a)}(new ea(c,new b)).attach(c.parent);E.log(e("Title","NotifyDelete"))},mnemonic:ob},{label:e("Config","Cancel"),mnemonic:pb})})).attach(this)):(k=e("Title","New"),l=function(){var a={},b;for(b in U){var c=Ea(4);0<c&&(a[b]=c)}a={shop:a,warehouse:[],reservers:[],party:[W.adventurer("Knight"),W.adventurer("Warrior"),W.adventurer("Samurai"),W.adventurer("Mage"),
W.adventurer("Healer"),W.adventurer("Thief")],gold:1E3};a.party[0].equipments[0].enchants.push(Aa.from("AddedFire"));bb(a);f(a)});(new J(480,504,320,72,new B(k),l,Jb)).attach(this);(new J(480,612,320,72,new B(e("Title","Quit")),System.exit)).attach(this);jb(this)}x(b,a);return b}(Q);b.Scene=a})(Ba||(Ba={}));var Xa;(function(b){function a(){return[{name:e("Character","Name"),extract:function(a){return a.name},width:200},{name:e("Character","INT"),extract:function(a){return a.INT},width:60,align:"right"},
{name:e("Character","DEX"),extract:function(a){return a.DEX},width:60,align:"right"},{name:e("Character","STR"),extract:function(a){return a.STR},width:60,align:"right"}]}function h(a){return[{name:a,extract:function(a){return a.name},width:200},{name:e("Town","Tags"),extract:function(a){return ab(a.tags)}},{name:e("Town","Weight"),extract:function(a){return a.weight},width:60,align:"right"},{name:e("Town","ATK"),extract:function(a){return a.ATK},width:60,align:"right"},{name:e("Town","DEF"),extract:function(a){return a.DEF},
width:60,align:"right"}]}function d(a,b){var c=b.shop,d=h(a);d.push({name:e("Town","Stock"),extract:function(a){return oa(c[a.IID],e("Town","New"))},width:60,align:"right"});return d}function c(a,b){var c=b.shop,d=b.warehouse;return[{name:a,extract:function(a){return ka.nameOf(a)},width:200},{name:e("Town","Tags"),extract:function(a){return ab(U[a].tags)}},{name:e("Town","ATK"),extract:function(a){return U[a].ATK},width:60,align:"right"},{name:e("Town","DEF"),extract:function(a){return U[a].DEF},
width:60,align:"right"},{name:e("Town","Weight"),extract:function(a){return U[a].weight},width:60,align:"right"},{name:e("Town","Stock"),extract:function(a){return c[a]},width:60,align:"right"},{name:e("Town","Owned"),extract:function(a){return d.reduce(function(b,c){return c.IID===a?b+1:b},0)},width:60,align:"right"}]}function g(a){return[{name:a,extract:function(a){return a.name.localized},width:200},{name:e("Town","Required"),extract:function(a){return ab(a.tags)}},{name:e("Town","Cost"),extract:function(a){return a.rawCost},
width:60,align:"right"},{name:e("Town","Range"),extract:function(a){return a.rawRange},width:60,align:"right"},{name:e("Town","Power"),extract:function(a){return a.rawPower},width:60,align:"right"},{name:e("Town","Spec"),extract:function(a){return a.spec.localized}}]}var f={fontSize:64,fillStyle:l(255,255,255),strokeStyle:l(0,0,0),textAlign:"center",textBaseline:"middle",lineWidth:2},q=function(){function a(b,c){this.party=b;this.index=c}a.prototype.draw=function(a,b,c){var d=c.x,e=c.y,g=c.w;c=c.h;
var h=this.party[this.index];a.save();if(h){var k=Ja(h,140,184);h.draw(a,b,{x:d+g/2-k.w/2,y:e+92-k.h/2,w:k.w,h:k.h});var p=this.party.reduce(function(a,b){return b?X(a,b.HP):a},1);b=h.HP;var k=d+10,q=g-20,r=e+c-30,p=(q-2)*b/p;a.strokeStyle="black";a.fillStyle=nb.full;a.fillRect(k,r,p,6);a.strokeRect(k,r,p,6);va(a,b.toString(),k+4,r-20,q,20,{fontSize:20,fillStyle:l(255,255,255),strokeStyle:l(0,0,0),textAlign:"left",textBaseline:"bottom",lineWidth:2});va(a,h.name,d,e+c-24,g,24,{fontSize:24,fillStyle:l(255,
255,255),strokeStyle:l(0,0,0),textAlign:"center",textBaseline:"bottom",lineWidth:2})}else va(a,(this.index+1).toString(),d,e,g,c,f);a.restore()};return a}(),p=function(a){function b(c){a.call(this);this.data=c}x(b,a);b.prototype.addButton=function(a,b,c,d){a=new J(1280-170*a,665,160,45,new B(c),d,b);a.attach(this);return a};b.prototype.goTo=function(a){(new ea(this,new a(this.data))).attach(this.parent)};return b}(Q),t=function(a){function b(c,d){a.call(this,c);(new F(0,0,1280,720,new H("assets/scene/"+
d))).attach(this);jb(this);for(var e=c.party,f=this,g=[],h=0;6>h;++h){var l=r(h/3);(new Hb(10+170*(1-l),10+h%3*214+68*l,160,204,g,new q(e,h),function(){f.onPortraitClick(this.drawable.index)},function(a){var b=this.drawable;a=a.drawable;c=[e[a.index],e[b.index]];e[b.index]=c[0];e[a.index]=c[1];c=[a.index,b.index];b.index=c[0];a.index=c[1];var c},[k.$1+h])).attach(this)}}x(b,a);return b}(p),w=function(a){function b(c){var d=this;a.call(this,c,"town.jpg");var f=["grass","moss"],g=Ea(f.length);this.addSpot(5,
k.A,"Guild",function(){}).enabled=!1;this.addSpot(4,k.B,"Tavern",function(){return d.goTo(y)});this.addSpot(3,k.C,"Shop",function(){return d.goTo(v)});this.addSpot(2,k.D,"Smith",function(){}).enabled=!1;this.addSpot(1,k.E,"Dungeon",function(){(new ea(d,new Ca.Scene(c,new Ca.EndressStage(f[g],0)))).attach(d.parent)}).enabled=c.party.some(function(a){return null!=a});this.addButton(2,[k.L],e("Town","Load"),function(){Pa.confirm(d,e("Town","ConfirmLoad"),{label:e("Town","Load"),click:function(){var a=
Sa();a&&((new ea(d,new b(a))).attach(d.parent),E.log(e("Town","NotifyLoad")))},mnemonic:ob},{label:e("Config","Cancel"),mnemonic:pb})});this.addButton(1,[k.S],e("Town","Save"),function(){bb(d.data);E.log(e("Town","NotifySave"))})}x(b,a);b.prototype.onPortraitClick=function(a){(a=this.data.party[a])&&(new ea(this,new K(this.data,a))).attach(this.parent)};b.prototype.addSpot=function(a,b,c,d){a=new J(950,665-100*a,320,90,new B(e("Town",c)),d,[b]);a.attach(this);return a};return b}(t);b.Home=w;var y=
function(b){function c(d){function f(a,b){(c=Array.prototype.splice).call.apply(c,[a,0,a.length].concat(b));var c}var g=this;b.call(this,d,"tavern.jpg");var h=d.party.concat(),l=d.reservers.concat();this.addButton(3,[k.C],e("Town","Clear"),function(){for(var a=0;6>a;++a){var b=d.party[a];b&&(d.reservers.push(b),d.party[a]=null)}});this.addButton(2,[k.R],e("Town","Revert"),function(){f(d.party,h);f(d.reservers,l)});this.addButton(1,[k.TAB,k.DELETE],e("Town","Back"),function(){return g.goTo(w)});(new D(350,
10,920,D.heightOf(10),a(),d.reservers,function(a,b){return g.onReserverClick(a,b)})).attach(this)}x(c,b);c.prototype.onPortraitClick=function(a){var b=this.data.party[a];b&&(this.data.party[a]=null,this.data.reservers.push(b))};c.prototype.onReserverClick=function(a,b){for(var c=0;6>c;++c)if(null==this.data.party[c]){this.data.party[c]=a;this.data.reservers.splice(b,1);return}E.error(e("Town","PartyFull"))};return c}(t),v=function(a){function b(f){var g=this;a.call(this,f,"shop.jpg");var h=f.shop,
l=f.warehouse,p=new D(350,10,920,D.heightOf(10),c(e("Town","Buy"),f),Ha(h),function(a){if(0>=h[a])E.error(e("Town","SoldOut"));else{var b=U[a].price;if(f.gold<b)E.error(e("Town","NoMoney"));else{var c=new ka(a);--h[a];l.push(c);f.gold-=b;E.log(qa(e("Town","NotifyBuy").localized,c.name,b))}}});p.attach(this);var q=new D(350,10,920,D.heightOf(10),d(e("Town","Sell"),f),l,function(a,b){var c=a.IID,d=a.priceToSell;l.splice(b,1);var g=h[c];null==g?(h[c]=1,p.rows.push(c)):h[c]=1+g;f.gold+=d;E.log(qa(e("Town",
"NotifySell").localized,a.name,d))});q.attach(this);var r,t;r=this.addButton(3,[k.B],e("Town","Buy"),function(){p.visible=!0;q.visible=!1;r.enabled=!1;t.enabled=!0});t=this.addButton(2,[k.S],e("Town","Sell"),function(){p.visible=!1;q.visible=!0;r.enabled=!0;t.enabled=!1});this.addButton(1,[k.TAB,k.DELETE],e("Town","Back"),function(){return g.goTo(w)});r.click()}x(b,a);b.prototype.onPortraitClick=function(a){E.log("TODO: Shop.onPortraitClick: "+a)};return b}(t),K=function(a){function b(c,d){var f=
this;a.call(this,c);var l=c.warehouse,p=Ja(d,1280,720,!0);(new F(0,0,p.w,p.h,d)).attach(this);(new F(0,0,200,40,new B(d.name+" / Lv: "+d.level))).attach(this);(new F(0,40,200,40,new B("INT: "+d.INT))).attach(this);(new F(100,40,200,40,new B("DEX: "+d.DEX))).attach(this);(new F(200,40,200,40,new B("STR: "+d.STR))).attach(this);(new F(0,80,200,40,new B(function(){return"HP: "+d.HP}))).attach(this);(new F(0,120,200,40,new B(function(){return"SP: "+d.SP}))).attach(this);(new F(0,160,200,40,new B(function(){return"WT: "+
d.weight+"/"+d.maxWeight}))).attach(this);(new F(0,200,200,40,new B(function(){return"DEF: "+d.DEF.toFixed(1)}))).attach(this);var q=new Q([new D(350,10,920,D.heightOf(10),h(e("Town","Equipments")),d.equipments,function(a,b){d.equipments.splice(b,1);l.push(a)}),new D(350,360,920,D.heightOf(10),h(e("Town","Warehouse")),l,function(a,b){l.splice(b,1);var c=d.equipments,e=a.tagbits,f=[],e=e&Ob;if(0!==e)for(var g=0;g<c.length;)0!==(c[g].tagbits&e)?(f.push(c[g]),c.splice(g,1)):++g;d.equipments.push(a);
(h=l.push).call.apply(h,[l].concat(f));var h})]);q.attach(this);var r=new Q([new D(350,10,920,D.heightOf(10),g(e("Town","Skills")),d.skills,function(a,b){d.skills.splice(b,1);d.known.push(a)}),new D(350,360,920,D.heightOf(10),g(e("Town","Knowns")),d.known,function(a,b){d.known.splice(b,1);d.skills.push(a)})]);r.attach(this);var t,v;t=this.addButton(3,[k.E],e("Town","Equipments"),function(){q.visible=!0;r.visible=!1;v.enabled=!0;t.enabled=!1});v=this.addButton(2,[k.S],e("Town","Skills"),function(){q.visible=
!1;r.visible=!0;v.enabled=!1;t.enabled=!0});this.addButton(1,[k.TAB,k.DELETE],e("Town","Back"),function(){return f.goTo(w)});t.click()}x(b,a);return b}(p)})(Xa||(Xa={}));var Ca;(function(b){function a(a,b){var m=a.xH;return{xH:m+[1,2,1,-1,-2,-1][b],yH:a.yH+(0===m%2?[-1,0,0,0,0,-1]:[0,0,1,1,0,0])[b]}}function h(a,b){var m=a.xH,c=b.xH,n=c-m,m=2*b.yH+c%2-(2*a.yH+m%2);return 0>m?m>n?(-n-m)/2:m>-n?(n-m)/2:-m:m<n?(n+m)/2:m<-n?(-n+m)/2:m}function d(a,b){return a===b||!!a&&!!b&&a.xH===b.xH&&a.yH===b.yH}function c(a,
b,m,c,n,d,e,f,g){var h=ga(0,1,d/e);d=null==f?h:ga(0,1,(d+f)/e);a.save();a.fillStyle=g.bkgnd;a.fillRect(b,m,c,n);b+=1;m+=1;c-=2;n-=2;d>h?(a.fillStyle=1<=h?g.full:g.normal,a.fillRect(b,m,c*h-1,n),a.fillStyle=g.full,a.fillRect(b+c*h,m,c*(d-h),n)):d<h?(e=c*d,0<d&&(e=X(e,2),a.fillStyle=1<=h?g.full:g.normal,a.fillRect(b,m,e-1,n)),a.fillStyle=g.delta,a.fillRect(b+e,m,c*(h-d),n)):(a.fillStyle=1<=h?g.full:g.normal,a.fillRect(b,m,c*h,n));a.restore()}function g(a,b,m,A,n){b=m.toX(n)+16;m=m.toY(n)+60;c(a,b,m,
96,6,A.HP,A.maxHP,null,nb)}function f(a,b,m,A,n,d){b=m.toX(n)+16;m=m.toY(n)+60+6;c(a,b,m,96,6,A.SP,A.maxSP,d-A.SP,xb)}function G(a,b,m,c,n,d){var e=0,e=1===a.team?e+10*(n-b):e+10*(b-c);a=2*m+b%2;e=3>a?e+10*a:e+10*(5-a);b<d&&(e*=.1);return e}function p(a,b,m,c){a=b.powerOf(m);b=b.level+b.getOffencePassive(m)-c.level-c.getDefencePassive(m);return Ua(a*(100-c.DEF)/100*ca(I,b))}function t(a){var b=a.tagbits;return 0!==(b&8192)?{r:255,g:128,b:0}:0!==(b&16384)?{r:0,g:128,b:255}:0!==(b&32768)?{r:255,g:255,
b:0}:0!==(b&65536)?a.hostile?{r:255,g:0,b:128}:{r:0,g:255,b:128}:{r:255,g:255,b:255}}function D(a,b,m){var c=void 0,n=h(b,m)+1;a.straight(b,m,n,function(b,m){m===n&&a.get(b).empty&&(c=b)});return c}function y(a,b,m){var c=b.trySkill(a,m),n=a.promiseEffect(m,c);m=new Ga(a,b.hex,m.hex);b.state=m;m.hit(function(){return n.attach(a)});return q.wait.POPUP?Ia([n,m]):m}function v(a,b,m,c){c=t(c);var n=Na(c),d=Na(c,0);c=a.toX(b)-a.toX(m);var e=a.toY(b)-a.toY(m);c=100+ca(c*c+e*e,.5)/1280*400;c=new K(c,function(c,
A){var e=a.toX(b),f=a.toY(b),g=a.toX(m),h=a.toY(m);$a(A,e*(1-c)+g*c+64-20,f*(1-c)+h*c+40-20,40,40,n,d,.5)});c.attach(a);return c}function N(a,b,m,c,n){function d(m,c){var A=e.get(m).unit;if(b.isTarget(A)){var g=b.trySkill(a,A);n&&(g.deltaHP=n(g.deltaHP,c));A=a.promiseEffect(A,g);A.attach(a);f.push(A)}}var e=a.field,f=[];d(m,0);e.surround(m,c,d);var g=t(b.skill),h=Na(g,0),k=new K(400,function(b,n){var d=a.toX(m)+64,z=a.toY(m)+40,e=128*c*b,f=80*c*b,C=Na(g,1-b);$a(n,d-e,z-f,2*e,2*f,C,h,b)});k.attach(a);
return q.wait.POPUP?(f.push(k),Ia(f)):k}var I=ca(2,.1),O=[{lineWidth:2,fillStyle:l(0,0,68),strokeStyle:l(204,204,255)},{lineWidth:2,fillStyle:l(68,0,0),strokeStyle:l(255,204,204)}],V={fillStyle:"white",textAlign:"left",textBaseline:"top"},P=w(0,0,0,0),U=w(0,0,0,.75),ja={inner:l(230,255,180),outer:l(51,230,51)},ha={inner:l(230,180,255),outer:l(51,51,230)},ya={inner:l(255,180,230),outer:l(230,51,51)},Y={inner:l(230,180,255),outer:l(51,51,230)},ka={outer:l(64,192,255),inner:l(180,232,255),bkgnd:w(64,
192,255,.3)},pa={outer:l(255,192,64),inner:l(255,232,192),bkgnd:w(255,192,64,.3)},sa={DASH_OR_RANGE:{outer:l(255,64,64),inner:l(255,180,180),bkgnd:w(255,192,64,.3)},RANGE:{outer:l(255,64,64),inner:l(255,180,180),bkgnd:w(255,128,64,.3)},TARGET:{outer:l(255,24,24),inner:l(255,64,64),bkgnd:w(255,24,24,.3)}},ta={DASH_OR_RANGE:{outer:l(24,24,255),inner:l(180,180,255),bkgnd:w(255,192,64,.3)},RANGE:{outer:l(64,64,255),inner:l(180,180,255),bkgnd:w(24,128,255,.3)},TARGET:{outer:l(24,24,255),inner:l(64,64,
255),bkgnd:w(24,24,255,.3)}},wa=w(0,0,0,.65),xa=w(0,0,0,0),Ca={textAlign:"center",textBaseline:"bottom",fontSize:32,fillStyle:"yellow",strokeStyle:"black",lineWidth:2},Fa={textAlign:"center",textBaseline:"bottom",fontSize:32,fillStyle:"red",strokeStyle:"black",lineWidth:2},qa=w(255,0,0,.8),Ka=l(255,180,180),Oa=l(180,255,180),Ra=[{messageID:"PartyTurn",innerStyle:l(0,0,128),outerStyle:w(0,0,128,0),textStyle:{fontSize:64,fillStyle:"white",textAlign:"center",textBaseline:"middle"}},{messageID:"EnemyTurn",
innerStyle:l(128,0,0),outerStyle:w(128,0,0,0),textStyle:{fontSize:64,fillStyle:"white",textAlign:"center",textBaseline:"middle"}}],za,Aa,Ya=function(){function b(a,m){this.dummy=m;this.cells={};this.depth=r(a)}Object.defineProperty(b.prototype,"minXH",{get:function(){return 1+Ua(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"maxXH",{get:function(){return 20+r(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"minVisibleXH",{get:function(){return r(this.depth)},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"maxVisibleXH",{get:function(){return 21+Ua(this.depth)},enumerable:!0,configurable:!0});b.prototype.contains=function(a,b){if(null==a)return!1;var c;null==b?(n=a,c=n.xH,b=n.yH,n):c=a;return 0<=b&&3>b&&this.minXH<=c&&c<this.maxXH;var n};b.prototype.getLine=function(a){return this.cells[a]};b.prototype.setLine=function(a,b){this.cells[a]=b};b.prototype.deleteLine=function(a){delete this.cells[a]};b.prototype.rawget=function(a,b){var c;
null==b?(n=a,c=n.xH,b=n.yH,n):c=a;if(0<=b&&3>b&&this.minVisibleXH<=c&&c<this.maxVisibleXH&&(c=this.cells[c]))return c[b];return;var n};b.prototype.get=function(a,b){var c;null==b?(n=a,c=n.xH,b=n.yH,n):c=a;return oa(this.rawget(c,b),this.dummy);var n};b.prototype.set=function(a,b,c){null==c&&(n=b,b=n.xH,c=n.yH,n);n=this.cells[b];null==n&&(n=this.cells[b]=[]);n[c]=a;var n};b.prototype.each=function(a){for(var b=this.maxXH,c=this.minXH;c<b;++c)for(var n=0;3>n;++n)a.call(this,this.get(c,n),c,n)};b.prototype.eachVisible=
function(a){for(var b=this.maxVisibleXH,c=this.minVisibleXH;c<b;++c)for(var n=0;3>n;++n)a.call(this,this.get(c,n),c,n)};b.prototype.straight=function(a,b,c,n){if(!d(a,b)){var e=a.xH,f=1+2*(2*a.yH+a.xH%2),g=b.xH,L=1+2*(2*b.yH+b.xH%2);a=h(a,b);g=(g-e)/a;L=(L-f)/a;for(a=1;a<=c;++a){var u=e+a*g,k=r((f+a*L)/2);b=void 0;b=0===k%2?2*r((u+1)/2):2*r(u/2)+1;u=r(k/2);this.contains(b,u)&&n({xH:b,yH:u},a)}}};b.prototype.surround=function(b,c,d){if(1===c)for(var n=0;6>n;++n){var e=a(b,n);this.contains(e)&&d(e,
1)}else if(1<c){b=a(b,0);for(var f=1;f<=c;++f){for(var e=b,g=0,h=[2,3,4,5,0,1];g<h.length;g++)for(var n=h[g],u=0;u<f;++u,e=a(e,n))this.contains(e)&&d(e,f);b=a(b,0)}}};return b}(),fa=function(){function a(b){this.duration=b}a.prototype.then=function(a){null==this.duration?M.then(a):this.sig=ia(this.sig,a);return this};a.prototype.commit=function(){ba(this.sig);this.duration=this.sig=void 0};a.prototype.getXY=function(a,b,c){if(null!=this.duration)if(c=K.clamp(c,this.start,this.duration),1<=c)this.commit();
else return this.onGetXY(a,b,c)};a.prototype.drawCharacter=function(a,b,c,n,d,e,f){a.drawCharacter(b,c,n,d,e,f)};return a}(),Ba=function(a){function b(c){a.call(this,400*(13-c)/4)}x(b,a);b.prototype.onGetXY=function(a,b,c){a=a.hex;return{x:b.toX(a)-128*(1-c)+64,y:b.toY(a)+80}};return b}(fa),Da=function(a){function b(c){a.call(this,100*ca(c.length-1,.75));this.path=c}x(b,a);b.prototype.onGetXY=function(a,b,c){var d=this.path.length-1,e=r(d*c),f=this.path[e],g=this.path[e+1];a=b.toX(f);var f=b.toY(f),
z=b.toX(g);b=b.toY(g);c=d*c-e;return{x:a*(1-c)+z*c+64,y:f*(1-c)+b*c+80}};return b}(fa),Ga=function(a){function b(c,d,n){a.call(this,function(a,b,c){var m=a.toX(b)-a.toX(c);a=a.toY(b)-a.toY(c);return 200+ca(m*m+a*a,.3)/1280*1E3}(c,d,n));this.hexFrom=d;this.hexTo=n}x(b,a);b.prototype.hit=function(a){null==this.duration?M.then(a):this.hitsig=ia(this.hitsig,a)};b.prototype.commit=function(){ba(this.hitsig);this.hitsig=void 0;a.prototype.commit.call(this)};b.prototype.onGetXY=function(a,b,c){var d=this.hexFrom,
e=this.hexTo;a=b.toX(d);var d=b.toY(d),f=b.toX(e);b=b.toY(e);.5>c?c*=2:(c=2-2*c,ba(this.hitsig),this.hitsig=null);return{x:a*(1-c)+f*c+64,y:d*(1-c)+b*c+80}};return b}(fa),Qa=function(a){function b(c,d){a.call(this,500);var n=c.HP;this.dying=d>=n?c.hex:null;this.radius=d>=n/2?1:.5+d/n}x(b,a);b.prototype.onGetXY=function(a,b,c){var d=20*(1-c)*this.radius;c=c*T*this.duration/250*this.radius;a=this.dying||a.hex;return{x:d*S(4*c)+b.toX(a)+64,y:d*S(3*c)+b.toY(a)+80}};b.prototype.drawCharacter=function(b,
c,d,e,f,g,h){this.dying?(g=K.clamp(d,this.start,this.duration),c.save(),c.globalAlpha=1-g,a.prototype.drawCharacter.call(this,b,c,d,e,f,"red",g),c.restore()):a.prototype.drawCharacter.call(this,b,c,d,e,f,g,h)};return b}(fa),qb=function(){function a(b,c,d){this.ch=b;this.team=c;this.hex=d;this.idleOffset=Za();this.skill=b.skills.find(function(a){return 0<b.rangeOf(a)})||eb.DUMMY;this.HP=this.maxHP;this.minCost=this.SP=this.availSP;c=0;for(d=b.skills;c<d.length;c++){var n=d[c];n.isActive&&(n=this.costOf(n),
n<this.minCost&&(this.minCost=n))}}Object.defineProperty(a.prototype,"name",{get:function(){return this.ch.name},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"level",{get:function(){return this.ch.level},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"INT",{get:function(){return this.ch.INT},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEX",{get:function(){return this.ch.DEX},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"STR",{get:function(){return this.ch.STR},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxHP",{get:function(){return this.ch.HP},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxSP",{get:function(){return this.ch.SP},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"availSP",{get:function(){return X(0,this.ch.SP-this.ch.reservedSP)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"step",{get:function(){return this.ch.step},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ZoC",{get:function(){return this.ch.ZoC},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){return this.ch.DEF},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"skills",{get:function(){return this.ch.skills},enumerable:!0,configurable:!0});a.prototype.costOf=function(a){return this.ch.costOf(a)};a.prototype.rangeOf=function(a){return this.ch.rangeOf(a)};a.prototype.powerOf=function(a){return this.ch.powerOf(a)};
Object.defineProperty(a.prototype,"cost",{get:function(){return this.costOf(this.skill)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"range",{get:function(){return this.rangeOf(this.skill)},enumerable:!0,configurable:!0});a.prototype.getPassive=function(a,b){for(var c=a.tagbits,d=0,e=0,f=this.ch.skills;e<f.length;e++){var g=f[e];g.isPassive&&g.action===b&&0!==(c&g.tagbits)&&(d+=g.rawPower)}return d};a.prototype.getOffencePassive=function(a){return this.getPassive(a,"Offence")};
a.prototype.getDefencePassive=function(a){return this.getPassive(a,"Defence")};a.prototype.isEnemy=function(a){return null!=a&&this.team!==a.team};a.prototype.isTarget=function(a){return null==a?!1:this.skill.hostile?this.isEnemy(a):this!==a&&!this.isEnemy(a)};a.prototype.done=function(a){a=a.zoc;if(!a)return!1;var b=this.hex;return b&&this.SP<this.minCost&&this.SP<this.step+a[this.team].get(b)};a.prototype.trySkill=function(a,b){if(!this.isTarget(b))return null;var c=this.skill.effect,d=za[c];if(null==
d)throw new RangeError('Action not found: "'+c+'"');return d(a,this,b)};a.prototype.shoot=function(a,b){var c=this.skill.action,d=Aa[c];if(null==d)throw new RangeError('Action not found: "'+c+'"');c=d(a,this,b);this.SP-=this.cost;return c};a.prototype.onTurnEnd=function(a){this.team===a.team&&(this.SP=this.availSP)};a.prototype.onTurnStart=function(a){};a.prototype.getXY=function(a,b){var c;this.state&&(c=this.state.getXY(this,a,b),null==c&&(this.state=null));if(null==c){var d=this.hex;d&&(c={x:a.toX(d)+
64,y:a.toY(d)+80})}return c};Object.defineProperty(a.prototype,"state",{get:function(){return this._state},set:function(a){var b=this._state;if(this._state=a)a.start=performance.now();b&&b.commit()},enumerable:!0,configurable:!0});a.prototype.drawCharacter=function(a,b,c,d,e,f){var g=this.ch,h=Ja(g,128,128),u=h.w,k=.2*u;$a(a,c-u/2,d-10-k/2,u,k,wa,xa,.75);b&&(u=200*(13-g.DEX),u=X(0,S(2*T*(this.idleOffset+b%u/u))),d-=16*u+10*(1-u));h.x=c-h.w/2;h.y=d-h.h;g.draw(a,b,h,e,f)};a.prototype.draw=function(a,
b,c,d,e,f){this.state?this.state.drawCharacter(this,a,b,c,d,e,f):this.drawCharacter(a,b,c,d,e,f)};a.prototype.drawBars=function(a,b,d,e,f){var g=this.hex;b=d.toX(g)+16;d=d.toY(g)+60;c(a,b,d,96,6,this.HP,this.maxHP,e,nb);c(a,b,d+6,96,6,this.SP,this.maxSP,f,xb)};a.compare=function(a,b){return a.y<b.y?-1:a.y>b.y?1:a.x<b.x?-1:a.x>b.x?1:0};return a}(),Sa=function(){function a(b,c){void 0===b&&(b=0);this.type=b;this.unit=c}Object.defineProperty(a.prototype,"empty",{get:function(){return null==this.unit&&
0===this.type},enumerable:!0,configurable:!0});a.DUMMY=new a(1);return a}(),Ta=function(b){function c(m,e,n){function f(a,b,c,m){var e=this,n=b.range;if(1<=n){var g=b.hex,h=a.field,A=a.numScrollsPerTurn,u=this.get(m).SP,k=c.get(m),Pb=lb(2*m.yH+m.xH%2-3),z=h.minXH+A,C=m.xH<z,Qb=function(a){var b=e.get(a).SP;if(u>b)return!0;if(u<b)return!1;b=a.xH<z;if(!C&&b)return!0;if(C&&!b)return!1;b=c.get(a);return k<b?!0:k>b?!1:m.xH<a.xH?!0:m.xH>a.xH?!1:Pb<lb(2*a.yH+a.xH%2-3)};h.surround(m,n,function(c){if(!d(c,
g)){var n=h.rawget(c);c=e.ensure(c);null==c.shotFrom?(c.shotFrom=m,c.effect=b.trySkill(a,n.unit)):Qb(c.shotFrom)&&(c.shotFrom=m)}})}}var g=this,h=m.field;b.call(this,h.depth,c.DUMMY);var k=m.zoc[e.team],u=e.step,l=e.cost,fb=e.hex;this.ensure(fb).SP=n;if(n>=u+k.get(fb))for(var gb=[],p=fb;p;p=gb.shift()){var aa=this.get(p).SP-(u+k.get(p));if(0<=aa)for(var q=0;6>q;++q){var r=a(p,q),t=h.rawget(r);t&&0===t.type&&!e.isEnemy(t.unit)&&(t=this.ensure(r),t.SP<aa||t.SP===aa&&h.get(p).empty&&!h.get(t.comeFrom).empty)&&
(t.SP=aa,t.comeFrom=p,aa>=u+k.get(r)&&gb.push(r))}}n>=l&&(f.call(this,m,e,k,fb),this.each(function(a,b,c){a.SP>=l&&h.rawget(b,c).empty&&f.call(g,m,e,k,{xH:b,yH:c})}))}x(c,b);c.prototype.ensure=function(a){var b=this.rawget(a);null==b&&(b={SP:-1},this.set(b,a));return b};c.prototype.getPath=function(a,b){var c=this.get(a),d=c.comeFrom,e=c.shotFrom,f;if(c.effect){if(!b.get(e).empty)return null;f=[e];c=this.get(e);d=c.comeFrom;c}else if(d){if(!b.get(a).empty)return null;f=[a]}for(;d;)f.unshift(d),c=
this.get(d),d=c.comeFrom,c;return f};c.DUMMY={SP:-1};return c}(Ya),bb=function(a){function b(c,d,e,f,g,h){a.call(this,e,f,g,h,new B(function(){var a=c.focus;if(a){var b=a.skills[d];if(b){var e=a.rangeOf(b);if(0<e){var n=a.skill===b,f=a.costOf(b),a=a.powerOf(b);return""+(n?"E ":"")+b.name.localized+"\n"+f+" / "+e+" / "+(0<a?a.toFixed(1):"-")}return b.name.localized+"\n"+("Offence"===b.action?"ATK":"DEF")+": "+ab(b.tags)}}},{fontSize:20}),function(){var a=c.focus;if(a){var b=a.skills[d];b&&0<a.rangeOf(b)&&
(a.skill=b,c.onSkillChanged(a))}});this.scene=c;this.index=d}x(b,a);Object.defineProperty(b.prototype,"visible",{get:function(){var a=this.scene.focus;return null!=a&&null!=a.skills[this.index]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"enabled",{get:function(){var a=this.scene.focus;return null!=a&&0<a.rangeOf(a.skills[this.index])},enumerable:!0,configurable:!0});return b}(J),fa=function(){function a(b,c,d){void 0===d&&(d=2);this.level=c;this.numScrollsPerTurn=d;b="assets/"+
("level/"+b+"/");this.imgSky=new H(b+"sky.png");this.imgCells=[new H(b+"tile.png"),new H(b+"hole.png")]}a.prototype.generate=function(a,b){var c=0,d=0;a.eachUnit(function(a){0===a.team?++c:++d});for(var e=0===c?.3:.3*ca(1.1,c-d),f=Array(3),g=Ha(yb),h=0;3>h;++h){var u=void 0,k=0;12<b&&Za()<e?(u=g[Ea(g.length)],u=W.monster(u,a.level),u=new qb(u,1,{xH:b,yH:h})):6<b&&.1>Za()&&(k=1);f[h]=new Sa(k,u)}return f};a.prototype.draw=function(a,b,c){var d=this,e=c.field,f=this.imgSky.image;if(f){a.save();var g=
128*e.depth/2;a.fillStyle=a.createPattern(f,"repeat");a.translate(-g,0);a.fillRect(0+g,0,1280,80);a.restore()}var h={x:0,y:0,w:128,h:80};e.eachVisible(function(e,f,g){e=e.type;h.x=c.toX(f,g);h.y=c.toY(f,g);d.imgCells[e].draw(a,b,h)})};return a}();b.EndressStage=fa;fa=function(a){function b(c,d){function f(a,b,c){return new J(10+110*b,570,100,140,{draw:function(a,b,d){var m=c.ch,e=d.x,f=d.y,g=Ja(m,d.w,d.h,!0),n=g.w,g=g.h,e=e+(d.w-n)/2,f=f+(d.h-g)/2;if(c.hex)m.draw(a,b,{x:e,y:f,w:n,h:g});else{var h=
c.HP/c.maxHP;.5<=h?m.draw(a,b,{x:e,y:f,w:n,h:g}):(m.images[Wa.CLOSED]||m.images[Wa.DEFAULT]).draw(a,b,{x:e,y:f,w:n,h:g});va(a,r(100*h).toFixed(0)+"%",d.x,d.y,d.w,d.h,{fillStyle:"white",strokeStyle:"black",textAlign:"center",textBaseline:"bottom"})}}},function(){if(c.hex)z.click(c.hex);else if(.5<=c.HP/c.maxHP){for(var d=l.minXH,m=b%3,f=0;3>f;++f){if(l.get(d,m).empty){a.revive(c,{xH:d,yH:m});return}m=(m+1)%3}E.error(e("Combat","NoSpaceToRevive"))}else E.error(e("Combat","CannotRevive"))},[k.$1+b])}
function g(a,b,c,d,m){b=new J(1280-150*b,570,140,140,new B(c),d);m&&ra(b,"enabled",m);b.attach(a);return b}var h=this;a.call(this);this.data=c;this.stage=d;this.team=0;this.enabled=!1;var l=this.field=new Ya(0,Sa.DUMMY);this.dying=[];this.deads=[];this.snapshots=[];var z=new cb;z.attach(this);z.visible=!1;var u=new db;u.attach(this);u.visible=!1;for(var Z=l.minVisibleXH,u=l.maxVisibleXH;Z<u;++Z)l.setLine(Z,this.stage.generate(this,Z));for(var p=[],gb=[[2,0],[2,1],[2,2],[1,0],[1,1],[1,2]],q=c.party,
u=0;6>u;++u){var aa=q[u];if(aa){var t=gb[u],Z=t[0],Z={xH:Z,yH:t[1]},t=new qb(aa,0,Z);t.state=new Ba(aa.DEX);l.rawget(Z).unit=t;p.push(f(this,u,t))}}var na=new Q(p);ra(na,"visible",function(){return z.visible&&null==h.focus});na.attach(this);g(na,1,e("Combat","End"),function(){return h.endTurn()});g(na,2,e("Combat","Undo"),function(){return z.undo()},function(){return z.canUndo});g(na,3,e("Combat","Retire"),function(){return h.retire()});var v=g(na,4,e("Combat","View")),u=new da;u.onDraw=function(a,
b){return h.drawUnits(a,b,h.focusTime)};u.attach(this);u=new da;u.onDraw=function(a,b){return h.drawBarsOnView(a,b)};ra(u,"visible",function(){return na.visible&&(v.hover||v.pressed)});u.attach(this);u=new Q;ra(u,"visible",function(){return null!=h.focus});u.attach(this);p=new da;p.onDraw=function(a,b){return h.drawBarsOnFocus(a,b,h.focus,h.controller.caret)};p.attach(u);var w=new ma(0,560,1280,160);w.onDraw=function(a,b){return h.drawPanel(a,b,h.focus,w)};w.attach(u);p=new Q;ra(p,"visible",function(){return z.visible&&
null!=h.focus});p.attach(this);for(u=0;6>u;++u)(new bb(this,u,400+170*r(u/2),570+u%2*75,160,65)).attach(p);var x=function(){var a=h.mapFor(h.focus);if(a){var b=h.controller.caret;if(b&&a.get(b).effect)return l.get(b).unit}return null},y=new ma(640,560,640,160);ra(y,"visible",function(){return null!=x()});y.onDraw=function(a,b){return h.drawPanel(a,b,x(),y)};y.attach(this);u=System.canvas.getContext("2d");(new F(0,0,128,560,new kb({fillStyle:ib(u,0,0,128,0,U,P)}))).attach(this);(new F(1152,0,1280,
560,new kb({fillStyle:ib(u,1152,0,1280,0,P,U)}))).attach(this);jb(this);this.startTurn()}x(b,a);Object.defineProperty(b.prototype,"controller",{get:function(){return this.children[this.team]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"level",{get:function(){var a=this.stage,b=a.level,a=a.numScrollsPerTurn;0<a&&(b+=this.field.depth/a*.1);return b},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"numScrollsPerTurn",{get:function(){return this.stage.numScrollsPerTurn},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"focus",{get:function(){return this._focus},set:function(a){null==a?(this._focus=null,this.focusTime=void 0):this._focus!==a&&(this._focus=a,this.focusTime=performance.now())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"zoc",{get:function(){if(this.enabled){var a=this._zoc;if(!a){var a=this.field.depth,b=[new Ya(a,0),new Ya(a,0)];this.eachUnit(function(a){var c=a.ZoC;if(0<c){var d=b[0===a.team?1:0];d.surround(a.hex,
1,function(a){return d.set(d.get(a)+c,a)})}});this._zoc=a=b}return a}},enumerable:!0,configurable:!0});b.prototype.mapFor=function(a){if(a&&this.enabled){var b=this.maps;b||(this.maps=b=new Ya(this.field.depth));var c=a.hex,d=b.rawget(c);null==d&&(d=new Ta(this,a,a.SP),b.set(d,c));return d}};b.prototype.onSkillChanged=function(a){var b=this.maps,c=this.snapshots;b&&b.set(void 0,a.hex);if(c)for(b=0;b<c.length;b++){var d=c[b];d.unit===a&&d.maps.set(void 0,d.hex)}};b.prototype.savepoint=function(a){this.snapshots.push({unit:a,
hex:a.hex,SP:a.SP,maps:this.maps,zoc:this.zoc})};b.prototype.rollback=function(){var a=this.snapshots.pop(),b=a.unit;this.setUnit(b,a.hex);b.SP=a.SP;this._zoc=a.zoc;this.maps=a.maps;this.focus=b};b.prototype.setUnit=function(a,b){var c=this.field,d=c.rawget(b),e=d.unit;if(a){if(e===a)return;a.hex&&(c.rawget(a.hex).unit=null);a.hex=b}else e&&(e.hex=null);d.unit=a;this.invalidate()};b.prototype.revive=function(a,b){var c=this.deads,d=c.indexOf(a);c.splice(d,1);a.SP=a.availSP;a.state=new Ba(a.DEX);this.setUnit(a,
b);this.snapshots.length=0};b.prototype.invalidate=function(){this.maps=this._zoc=void 0};b.prototype.startTurn=function(){for(var a=this,b=this.team,c=0,d=this.deads;c<d.length;c++){var e=d[c];if(e.team===b){var f=r(.1*e.maxHP);e.HP=R(e.maxHP,e.HP+f)}}this.eachUnit(function(b){return b.onTurnStart(a)});this.enabled=!0;this.controller.visible=!0};b.prototype.retire=function(){var a=this;Pa.confirm(this,e("Combat","ConfirmRetire"),{label:e("Combat","Retire"),click:function(){a.controller.visible=!1;
(new ea(a,new Xa.Home(a.data))).attach(a.parent)},mnemonic:ob},{label:e("Config","Cancel"),mnemonic:pb})};b.prototype.endTurn=function(){var a=this;this.enabled=!1;this.snapshots.length=0;this.controller.visible=!1;this.eachUnit(function(b){b.onTurnEnd(a)});if(0===this.team){var b=this.numScrollsPerTurn;if(0<b){var c=this.field.minXH+b;this.eachUnit(function(b){b.hex.xH<c&&(b.state=new Qa(b,b.HP),a.kill(b))});var d=this.field.depth;(new K(400*b,function(c){a.scrollTo(d+b*c)})).attach(this);if(this.isGameOver)return}}this.team=
0===this.team?1:0;var f=Ra[this.team],g=f.innerStyle,h=f.outerStyle,k=f.textStyle,l=e("Combat",f.messageID);(new K(800,function(a,b){b.save();b.globalAlpha=S(T*a);$a(b,0,0,1280,560,g,h);Ma(b,l.localized,640,280,k);b.restore()})).then(function(){a.startTurn()}).attach(this)};b.prototype.move=function(a,b){var c=this;Va(!d(b,a.hex));var e=function(){c.enabled=!0;a.done(c)&&(c.focus=null)};this.focus=a;var f=this.field,g=this.mapFor(a),h=g.get(b);if(h.effect){this.enabled=!1;var k=f.get(b).unit;Va(a.isTarget(k));
var l=function(){c.snapshots.length=0;c.invalidate();return a.shoot(c,k).then(e)};if(d(h.shotFrom,a.hex))return l();f=g.getPath(b,f);h=f[f.length-1];Va(!d(h,b));Va(!d(h,a.hex));this.setUnit(a,h);a.SP=g.get(h).SP;g=a.state=new Da(f);l=hb(l);g.then(l);return l}Va(0<=h.SP&&f.rawget(b).empty);f=g.getPath(b,f);this.setUnit(a,b);a.SP=h.SP;g=a.state=new Da(f);e();return q.wait.WALK?g:M};b.prototype.findUnit=function(a,b,c){var d=this.field,e=d.minXH,f=d.maxXH,g=(0===this.team?b:!b)?1:-1;b=b?1:-1;var h,k;
a?(h=a.xH,k=a.yH,a):(h=0>g?e:f-1,k=0>b?0:2);a=1;for(var l=3*(f-e+1);a<l;++a){k+=b;if(0>k||3<=k)k=0>k?2:0,h+=g,h<e?h=f-1:f<=h&&(h=e);var z=d.rawget(h,k).unit;if(z&&c(z))return z}return null};b.prototype.kill=function(a){var b=this;a.HP=0;this.setUnit(null,a.hex);this.dying.push(a);0===a.team&&(this.deads.push(a),this.parent&&this.isGameOver&&(this.controller.visible=!1,(a.state||M).then(function(){Pa.confirm(b,e("Combat","GameOver"),{label:e("Combat","Retire"),click:function(){(new ea(b,new Xa.Home(b.data))).attach(b.parent)},
mnemonic:tb})})))};Object.defineProperty(b.prototype,"isGameOver",{get:function(){return null==this.findUnit(null,!0,function(a){return 0===a.team})},enumerable:!0,configurable:!0});b.prototype.createPopup=function(a,b,c){var d=this.toX(c)+64,e=this.toY(c)+80;return new K(600,function(c,f){return Ma(f,a,d,e-40*c,{fontSize:48,fillStyle:b,strokeStyle:"black",globalAlpha:S(T*c),lineWidth:4,textAlign:"center",textBaseline:"bottom"})})};b.prototype.promiseEffect=function(a,b,c){var d=this,e=b.deltaHP||
0,f=b.deltaSP;b=lb(e).toString();var g=this.createPopup(b,0<e?Oa:Ka,c||a.hex),h=g.attach;g.attach=function(b){if(0>e||0>f)a.state=new Qa(a,-e);a.HP=ga(0,a.maxHP,a.HP+e);null!=f&&(a.SP=ga(0,a.maxSP,a.SP+f));0>=a.HP&&d.kill(a);return h.call(g,b)};return g};b.prototype.eachUnit=function(a){var b=this;this.field.eachVisible(function(c){(c=c.unit)&&a.call(b,c)})};b.prototype.toX=function(a,b){var c;null==b?(d=a,c=d.xH,d):c=a;return 0+64*(c-1-this.field.depth);var d};b.prototype.toY=function(a,b){var c;
null==b?(d=a,c=d.xH,b=d.yH,d):c=a;return 80+80*(2*b+c%2);var d};b.prototype.toHex=function(a,b){var c=this.field,d=a-0+128*c.depth/2,e=r((b-0-80)/80);if(0<=e&&6>e){var f=void 0,f=0===e%2?2*r((d+64)/128):2*r(d/128)+1;if(c.minXH<=f&&f<c.maxXH)return c=r(e/2),{xH:f,yH:c}}return null};b.prototype.scrollTo=function(a){var b=this.field;if(a>b.depth){var c=b.minVisibleXH,d=b.maxVisibleXH;b.depth=a;a=b.minVisibleXH;for(var e=b.maxVisibleXH;c<a;++c)b.deleteLine(c);for(c=X(a,d);c<e;++c)b.setLine(c,this.stage.generate(this,
c))}};b.prototype.onDraw=function(b,c){this.stage.draw(b,c,this);var d=this.focus,e=this.mapFor(d);e&&this.drawMarkers(b,c,this.focusTime,e,d);a.prototype.onDraw.call(this,b,c)};b.prototype.drawMarkers=function(a,b,c,d,e){var f=this,g=K.clamp(b,c,300);if(!(0>=g)){var h=e.cost;b=e.skill.hostile?sa:ta;var k=b.DASH_OR_RANGE,l=b.RANGE,z=b.TARGET;a.save();1>g&&(a.globalAlpha=g);d.eachVisible(function(b,c,d){var e=b.SP,n=b.shotFrom,A,p=0,C=0;b.effect?(A=z,p=32*(1-g),C=20*(1-g)):e>=h?A=ka:0<=e?A=n?k:pa:
n&&(A=l);A&&(b=f.toX(c,d)-p,c=f.toY(c,d)-C,p=128+2*p,C=80+2*C,a.fillStyle=A.bkgnd,a.fillRect(b+5,c+5,p-10,C-10),a.strokeStyle=A.outer,a.lineWidth=2,a.strokeRect(b+2,c+2,p-4,C-4),a.strokeStyle=A.inner,a.lineWidth=1,a.strokeRect(b+4,c+4,p-8,C-8))});a.restore()}};b.prototype.drawUnits=function(a,b,c){var d=this,f=this.zoc,g=this.focus,h=[];this.eachUnit(function(a){var c=a.getXY(d,b);c.unit=a;h.push(c)});for(var k=0;k<this.dying.length;){var l=this.dying[k],z=l.getXY(this,b);z?(z.unit=l,h.push(z),++k):
this.dying.splice(k,1)}h.sort(qb.compare);k=e("Combat","Done").localized;c=(1-la(2*T*K.cycle(b,c,1E3)))/2*.5;for(var p=(z=this.mapFor(g))&&g.skill.hostile?"red":"blue",L=0;L<h.length;L++){var t=h[L],l=t.unit,q=t.x,t=t.y,r=void 0;if(z)if(g===l)r="yellow";else{var v=l.hex;v&&z.get(v).effect&&(r=p)}l.draw(a,b,q,t,r,c);if(!l.state&&f){var v=l.hex,r=l.SP,w=l.step,x=l.cost,l=l.team;v&&r<x&&(r<w?Ma(a,k,q,t,Ca):r<w+f[l].get(v)&&Ma(a,k,q,t,Fa))}}};b.prototype.drawBarsOnView=function(a,b){var c=this;this.eachUnit(function(d){return d.drawBars(a,
b,c)})};b.prototype.drawBarsOnFocus=function(a,b,c,e){var h=this,k=this.mapFor(c);if(k){var l=this.field;k.each(function(c,d,e){(c=c.effect)&&l.get(d,e).unit.drawBars(a,b,h,c.deltaHP,c.deltaSP)});if(e){var u=k.get(e);u.effect?(e=u.shotFrom,d(e,c.hex)?c.drawBars(a,b,this,null,-c.cost):(g(a,b,this,c,c.hex),f(a,b,this,c,e,k.get(e).SP-c.cost))):0<u.SP&&l.get(e).empty?(g(a,b,this,c,c.hex),f(a,b,this,c,e,u.SP)):c.drawBars(a,b,this)}else c.drawBars(a,b,this)}};b.prototype.drawPanel=function(a,b,c,d){if(c){La(a,
d,O[c.team]);var e=c.ch,f=Ja(e,128,128);f.x=d.x+10+(128-f.w)/2;f.y=d.y+(d.h-f.h)/2;e.draw(a,b,f);b=c.SP>=c.cost?r((c.SP-c.cost)/c.step):"-";var e=c.powerOf(c.skill),f=c.name+" / Lv: ",g;g=c.level;g=null!=g?g.toFixed(1):"-";Ma(a,f+g+"\n"+("HP: "+c.HP+" / "+c.maxHP+"\n")+("SP: "+c.SP+" / "+c.maxSP+"\n")+("MOVE: "+b+"/"+r(c.SP/c.step)+"\n")+("ATK/DEF: "+(null!=e?e.toFixed(1):"-")+" / "+c.DEF.toFixed(1)),d.x+148,d.y+10,V)}};return b}(Q);b.Scene=fa;var cb=function(b){function c(){b.apply(this,arguments);
this.mode=0}x(c,b);Object.defineProperty(c.prototype,"caret",{get:function(){return this._caret},set:function(a){this._caret=a;if(0===this.mode){var b=this.parent;b.focus=a?b.field.get(a).unit:null}},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"canUndo",{get:function(){return 0<this.parent.snapshots.length||1<=this.mode},enumerable:!0,configurable:!0});c.prototype.undo=function(){var a=this.parent,b=a.snapshots,c=b.length,b=0<c?b[c-1].unit:null;1<=this.mode&&b!==a.focus?this.mode=
0:b?a.rollback():E.error(e("Combat","CannotUndo"));this.caret=this._caret};c.prototype.onHover=function(a,b){this.caret=this.parent.toHex(a,b)};c.prototype.onDrag=function(a,b){this.caret=this.parent.toHex(a,b)};c.prototype.downCaret=function(a){if(this.caret=a){var b=this.parent,c=this.mode,e=b.focus;if(e){if(e.team===b.team&&!e.done(b)){1===c&&d(a,e.hex)?this.mode=3:this.mode=2;return}}else if(a=b.field.get(a).unit,b.focus=a){this.mode=2;return}this.mode=0}};c.prototype.onDown=function(a,b){this.downCaret(this.parent.toHex(a,
b))};c.prototype.upCaret=function(a){var b=this;if(this.caret=a){var c=this.parent,e=this.mode;if(c.enabled&&!(2>e)){var f=c.focus;if(null==f||c.team!==f.team)this.mode=0;else if(d(a,f.hex))this.mode=2===e?1:0;else{e=c.mapFor(f).get(a);if(!e.effect)if(0<=e.SP&&c.field.rawget(a).empty)c.savepoint(f);else{c.focus=null;this.mode=0;return}this.mode=1;a=c.move(f,a);f=function(){null==c.focus&&(b.mode=0)};c.enabled?f():a.then(f)}}}};c.prototype.onUp=function(a,b){this.upCaret(this.parent.toHex(a,b))};c.prototype.onPress=
function(b){function c(b){var d=this.parent.field,e=this.caret;e?(b=a(e,b),d.contains(b)&&(this.caret=b)):this.caret={xH:d.minXH,yH:0}}function d(a){var b=this.parent,c=this.caret,f=b.team,g=b.focus;(a=b.findUnit(g?g.hex:c,a,function(a){return a.team===f&&!a.done(b)}))?(b.focus=a,null==c&&(this.caret=a.hex),0===this._mode&&(this.mode=1)):E.error(e("Combat","UnitNotAvailable"))}switch(b){case k.TAB:case k.DELETE:case k.Q:this.undo();break;case k.PAGE_DOWN:case k.C:d.call(this,!0);break;case k.PAGE_UP:d.call(this,
!1);break;case k.SPACE:case k.ENTER:this.click(this.caret);break;case k.E:c.call(this,0);break;case k.RIGHT:case k.D:c.call(this,1);break;case k.DOWN:case k.X:case k.S:c.call(this,2);break;case k.Z:c.call(this,3);break;case k.LEFT:case k.A:c.call(this,4);break;case k.UP:case k.W:c.call(this,5)}};c.prototype.click=function(a){this.parent.field.contains(a)&&(this.downCaret(a),this.upCaret(a))};c.prototype.onDraw=function(a,b){function c(a,b,d,e){var f=b.toX(d)+6.5;b=b.toY(d)+6.5;a.save();a.lineCap=
"round";a.lineJoin="round";a.beginPath();a.moveTo(f+32,b);a.lineTo(f,b);a.lineTo(f,b+20);a.moveTo(f+115-32,b);a.lineTo(f+115,b);a.lineTo(f+115,b+20);a.moveTo(f+115-32,b+67);a.lineTo(f+115,b+67);a.lineTo(f+115,b+67-20);a.moveTo(f+32,b+67);a.lineTo(f,b+67);a.lineTo(f,b+67-20);a.lineWidth=7;a.strokeStyle=e.outer;a.stroke();a.lineWidth=3;a.strokeStyle=e.inner;a.stroke();a.restore()}function d(a,b,c){a.save();a.lineCap="butt";a.lineJoin="round";var e=c[c.length-2],f=c[c.length-1],g=b.toX(e)+64,h=b.toY(e)+
40,e=b.toX(f)+64,f=b.toY(f)+40,g=ub(f-h,e-g);a.beginPath();a.moveTo(e+20*la(g),f+20*S(g));a.lineTo(e+20*la(g+2*T/3),f+20*S(g+2*T/3));a.lineTo(e+20*la(g-2*T/3),f+20*S(g-2*T/3));a.fillStyle=qa;a.fill();a.beginPath();a.moveTo(e-10*la(g),f-10*S(g));for(g=c.length-2;0<=g;--g)e=c[g],a.lineTo(b.toX(e)+64,b.toY(e)+40);a.strokeStyle=qa;a.lineWidth=12;a.stroke();a.restore()}var e=this.caret;if(e){var f=this.parent,g=f.focus,h=f.field;if(0===this.mode)c(a,f,e,ja);else if(g){var k=f.mapFor(g);if(k){var l=k.get(e);
(k=k.getPath(e,h))&&2<=k.length&&d(a,f,k);if(l.effect)switch(g.skill.target){case 1:c(a,f,e,ya);break;case 2:c(a,f,e,Y);break;case 3:h.straight(l.shotFrom,e,g.range,function(b){return c(a,f,b,ya)});break;case 4:h.straight(l.shotFrom,e,g.range,function(b){return c(a,f,b,Y)});break;case 5:h.surround(l.shotFrom,g.range,function(b){return c(a,f,b,ya)});break;case 6:h.surround(l.shotFrom,g.range,function(b){return c(a,f,b,Y)})}else 0<=l.SP?c(a,f,e,ha):c(a,f,e,ja)}}}};return c}(da),db=function(a){function b(){a.apply(this,
arguments);this.running=!1}x(b,a);Object.defineProperty(b.prototype,"visible",{get:function(){return this.running},set:function(a){var b=this;(this.running=a)&&M.then(function(){return b.run([])})},enumerable:!0,configurable:!0});b.prototype.run=function(a){function b(a,c){var d=a.focus;if(d)return d;var e=a.team,d=c.length,d=0<d?a.findUnit(c[d-1].hex,!1,function(b){return b.team===e&&!b.done(a)&&0>c.indexOf(b)}):a.findUnit(null,!1,function(b){return b.team===e&&!b.done(a)});return a.focus=d}function c(a,
b,f){var g=a.mapFor(b),h=e(a,b,g),k=h.hex;if(!g.get(k).effect&&b.SP>=b.availSP){var m=new Ta(a,b,999),k=e(a,b,m,h).hex,h=m.get(k);h.effect&&(k=h.shotFrom);for(h=a.field;k&&(0>g.get(k).SP||!h.get(k).empty);)k=m.get(k).comeFrom;null==k&&(k=b.hex)}if(d(k,b.hex))return f.push(b),a.focus=null;f.length=0;this.caret=k;f=q.wait.PICK;return 0<f?(g=hb(function(){return a.move(b,k)}),(new K(f)).then(g).attach(a),g):a.move(b,k)}function e(a,b,c,d){var f=a.field,g=f.minXH,h=f.maxXH,k=b.maxSP,m=b.hex,l=b.cost,
n=g+a.numScrollsPerTurn;d||(d={hex:m,score:G(b,m.xH,m.yH,g,h,n)+40*b.SP/k});c.each(function(e,m,z){var t=e.SP,r=e.effect;e=e.shotFrom;var q;if(r){t=q=G(b,e.xH,e.yH,g,h,n);q=a.field.rawget(m,z).unit;var L;L=q.ch;for(var v=0,A=0,w=L.skills;A<w.length;A++){var C=w[A];if(0<L.rangeOf(C)){L.powerOf(C);v=void 0;if(C.hostile)C=p(a,q,C,b)/b.HP;else var v=a,x=q,y=C,C=x.powerOf(y),v=x.level+x.getOffencePassive(y)-v.level,C=Ua(C*ca(I,v))/q.maxHP;v=C;v=X(v,v)}}L=R(1,v);r=r.deltaHP||0;r=0>r?-r:R(r,q.maxHP-q.HP);
r=R(1,r/q.HP);q=t+1E3*L*r;t=c.get(e).SP-l}else if(0<=t&&f.get(m,z).empty)q=G(b,m,z,g,h,n);else return;q+=40*t/k;d.score<q&&(d.score=q,d.hex={xH:m,yH:z})});return d}for(var f=this,g=this.parent,h=null;this.running;){g.enabled||(h=M);if(h){h.then(function(){return f.run(a)});break}this.caret=null;h=b(g,a);if(null==h){g.endTurn();break}h=c.call(this,g,h,a)}};return b}(da);za={Damage:function(a,b,c){return{deltaHP:-p(a,b,b.skill,c)}},DamageHPandSP:function(a,b,c){a=-p(a,b,b.skill,c);return{deltaHP:a,
deltaSP:r(a/2)}},Heal:function(a,b,c){c=b.powerOf(b.skill);return{deltaHP:Ua(c*ca(I,b.level-a.level))}}};Aa={Charge:y,Knockback:function(a,b,c){var d=c.hex,e=D(a.field,b.hex,d);if(null==e)return y(a,b,c);var f=b.trySkill(a,c),g=a.promiseEffect(c,f,e),f=new Ga(a,b.hex,c.hex),h=new Da([d,e]);b.state=f;f.hit(function(){a.setUnit(c,e);c.state=h});h.then(function(){g.attach(a)});return q.wait.POPUP?Ia([g,f]):f},GoBehind:function(a,b,c){var d=c.hex,e=D(a.field,b.hex,d);if(null==e)return y(a,b,c);var f=
b.hex,g=b.trySkill(a,c),h=a.promiseEffect(c,g);c=new Da([f,d]);a.setUnit(b,e);b.state=c;c.then(function(){h.attach(a)});return q.wait.POPUP?h:c},Trample:function(a,b,c){var d=c.hex,e=D(a.field,b.hex,d);if(null==e)return y(a,b,c);var f=b.hex,g=b.trySkill(a,c),h=a.promiseEffect(c,g,e),f=new Da([f,d]),g=new Da([d,d,e]);a.setUnit(c,e);c.state=g;a.setUnit(b,d);b.state=f;g.then(function(){h.attach(a)});return q.wait.POPUP?h:g},Shoot:function(a,b,c){var d=b.trySkill(a,c),e=a.promiseEffect(c,d);b=v(a,b.hex,
c.hex,b.skill);b.then(function(){return e.attach(a)});return q.wait.POPUP?e:b},Drain:function(a,b,c){var d=b.trySkill(a,c),e=a.promiseEffect(c,d),f=a.promiseEffect(b,{deltaHP:-d.deltaHP});b=v(a,c.hex,b.hex,b.skill);b.then(function(){return f.attach(a)});e.attach(a);return q.wait.POPUP?f:b},Explode:function(a,b,c){b.trySkill(a,c);var d=v(a,b.hex,c.hex,b.skill),e=hb(function(){return N(a,b,c.hex,1,function(a,b){return r(a/(1+b))})});d.then(e);return e},Laser:function(a,b,c){var d=a.field,e=b.hex,f,
g=[];d.straight(e,c.hex,b.range,function(c){var e=d.get(c).unit;if(b.isTarget(e)){var h=b.trySkill(a,e),e=a.promiseEffect(e,h);e.attach(a);g.push(e)}f=c});var h=t(b.skill);c=new K(400,function(b,c){var d=a.toX(e)+64,g=a.toY(e)+40,k=a.toX(f)+64,l=a.toY(f)+40,m=ub(l-g,k-d),p=64*la(m),m=40*S(m);c.save();c.beginPath();c.moveTo(d+p,g+m);c.lineTo(k+p,l+m);c.lineCap="round";c.lineWidth=80*b/4;c.strokeStyle=Na(h,1-b);c.stroke();c.restore()});c.attach(a);return q.wait.POPUP?(g.push(c),Ia(g)):c},Nova:function(a,
b,c){return N(a,b,b.hex,b.range)}}})(Ca||(Ca={}));var Ra,q=new (function(){function b(){this._refineCanvas=this._magnifyCanvas=!1;this.volume=new wb(50,0,100);this.effects=new wb(za.length-1,0,za.length-1)}Object.defineProperty(b.prototype,"magnifyCanvas",{get:function(){return this._magnifyCanvas},set:function(a){this._magnifyCanvas!==a&&(this._magnifyCanvas=a,window.dispatchEvent(new UIEvent("resize")))},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"refineCanvas",{get:function(){return this._refineCanvas},
set:function(a){this._refineCanvas!==a&&(this._refineCanvas=a,window.dispatchEvent(new UIEvent("resize")))},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"wait",{get:function(){return za[this.effects.value]},enumerable:!0,configurable:!0});return b}());System.main=function(b,a){var e=new Image;e.src="assets/dummy.png";H.DUMMY=e;var e=new Q,d=new Q;d.attach(e);var c=new Ib(10,10,1260,700,2E3,Fb);c.attach(e);E=c;Ra=function(){for(;;){var a=d.children,b=a.length;if(0===b)break;a[b-
1].detach()}(new vb(new Ba.Scene)).attach(d)};Eb();Ra();Bb(b,e,q);System.checkpoint=function(){db()}}})();
