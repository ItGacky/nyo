(function(){function ga(a,b,d){return d<a?a:d>b?b:d}function ha(a,b){return null!=a?a:b}function Ma(a){return v(Ya()*a)}function wa(a,b){return a?a.map(function(a){return null!=a?a.toJSON():b}):[]}function aa(a,b,d){return b?b.map(function(b){return null!=b?a.fromJSON(b):d}):[]}function Na(a){return void 0===a?"(undefined)":null===a?"(null)":a.toString()}function Oa(a){for(var b=[],d=1;d<arguments.length;d++)b[d-1]=arguments[d];return a.replace(/\$\{(\d+)\}/g,function(a,d){return Na(b[parseInt(d,
10)])})}function Pa(a,b,d){return Object.defineProperty(a,b,{enumerable:!0,configurable:!0,writable:!0,value:d})}function xa(a,b,d,f){return Object.defineProperty(a,b,{enumerable:!0,configurable:!0,get:d,set:f})}function Eb(a,b){var d=document.createElement("script");d.src=a;d.onerror=b;document.head.appendChild(d)}function ia(a,b){if(a===b)return 0;if(void 0===a&&void 0!==b)return-1;if(void 0!==a&&void 0===b)return 1;if(null===a&&null!==b)return-1;if(null!==a&&null===b)return 1;var d=typeof a,f=
typeof b;if(d!==f)return d<f?-1:1;if("object"===d){if(a instanceof Date&&b instanceof Date)return ia(a.getTime(),b.getTime());if(a instanceof Array&&b instanceof Array){a:{for(var d=a.length,f=b.length,c=0,k=Q(d,f);c<k;++c){var g=ia(a[c],b[c]);if(0!==g){d=g;break a}}d=d<f?-1:d>f?1:0}return d}d=a.constructor;if(d===b.constructor){f=a.compare;if("function"===typeof f&&f===b.compare){d=a.compare(b);if("number"!==typeof d)throw new TypeError('Cannot compare "'+a+'" and "'+b+'": operator returns non-number "'+
d+'"');return d}if(d===Object){a:{for(var d=Qa(a).sort(),f=Qa(b).sort(),c=d.length,k=f.length,g=Q(c,k),e=0;e<g;++e){var h=d[e],U=f[e];if(h<U||h>U){d=-1;break a}h=ia(a[h],b[U]);if(0!==h){d=h;break a}}d=c<k?-1:c>k?1:0}return d}}throw new TypeError('Cannot compare "'+a+'" and "'+b+'": not supported');}return a<b?-1:a>b?1:0}function ja(a,b){return(a||24)+"px "+(b||"Arial")}function ka(a,b){if(a){if("function"===typeof a)return[a,b];a.push(b);return a}return b}function ca(a){if(a)if("function"===typeof a)G.then(a);
else for(var b=0;b<a.length;b++)G.then(a[b])}function ya(a){for(var b,d=a.length,f=0;f<a.length;f++)a[f].then(function(){0>=--d&&(ca(b),b=void 0)});return{then:function(a){0<d?b=ka(b,a):G.then(a);return this}}}function jb(a){function b(a){G.then(a);return this}var d,f=function(){a().then(function(){ca(d);d=void 0;f.then=b})};f.then=function(a){d=ka(d,a);return this};return f}function h(){for(var a=[],b=0;b<arguments.length;b++)a[b-0]=arguments[b];return new J(a)}function Fb(a,b,d){function f(b){return(void 0===
b.pageX?b.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-a.offsetLeft:b.pageX-a.offsetLeft)*l/a.offsetWidth}function c(b){return(void 0===b.pageY?b.clientY+document.body.scrollTop+document.documentElement.scrollTop-a.offsetTop:b.pageY-a.offsetTop)*t/a.offsetHeight}function k(a){if(a.buttons&1)b.onDrag(f(a),c(a));else b.onHover(f(a),c(a));a.preventDefault()}function g(a){switch(a.button){case 0:b.onDown(f(a),c(a))}a.preventDefault()}function e(a){switch(a.button){case 0:b.onUp(f(a),
c(a));break;case 2:b.onPress(m.TAB)}a.preventDefault()}function h(){M&&clearTimeout(M);M=setTimeout(function(){M=void 0;var b=a.parentElement,f=b.clientWidth,b=b.clientHeight,b=b-a.offsetTop;0<b&&(d.magnifyCanvas||(f=Q(f,l),b=Q(b,t)),f*t>l*b?f=za(b*l/t):b=za(f*t/l),0<f&&0<b&&(a.style.width=f+"px",a.style.height=b+"px",!d.refineCanvas&&(f>l||b>t)&&(f=l,b=t),a.width!==f||a.height!==b))&&(a.width=f,a.height=b)},300)}function U(d){G.finish();var f=a.width,c=a.height,k=a.getContext("2d");k&&(k.clearRect(0,
0,f,c),k.save(),k.font=ja(),f===l&&c===t||k.scale(f/l,c/t),b.onDraw(k,d),k.restore());window.requestAnimationFrame(U)}var l=a.width,t=a.height;a.addEventListener("mousemove",k);a.addEventListener("touchmove",k);a.addEventListener("mousedown",g);a.addEventListener("touchstart",g);a.addEventListener("mouseup",e);a.addEventListener("touchend",e);a.addEventListener("contextmenu",function(a){a.preventDefault()});a.addEventListener("mousewheel",function(a){b.onPress(0<a.wheelDelta?m.PAGE_UP:m.PAGE_DOWN);
a.preventDefault()});window.addEventListener("keydown",function(a){if(!a.ctrlKey&&!a.altKey){var d=ha(a.keyCode,a.charCode);d&&m[d]&&(b.onPress(d),a.preventDefault())}});var M;window.addEventListener("resize",h);"complete"===document.readyState?h():window.addEventListener("load",h);window.requestAnimationFrame(U)}function Ra(a,b,d,f){void 0===f&&(f=!1);var c=a.w;a=a.h;if(c>b||a>d||f){f=c/b;var k=a/d;f>k?(c=b,a/=f):(c/=k,a=d)}return{w:c,h:a}}function $a(a,b){if(b)for(var d in b)switch(d){case "fontSize":a.font=
ja(b.fontSize,b.fontFamily);break;case "fontFamily":b.fontSize||(a.font=ja(void 0,b.fontFamily));break;default:a[d]=b[d]}}function Aa(a,b,d,f,c,k){var g;null==f?(k=b,b=k.x,g=k.y,f=k.w,c=k.h,k,k=d):g=d;if(0<f&&0<c){a.save();$a(a,k);k&&!k.fillStyle||a.fillRect(b,g,f,c);if(!k||k.strokeStyle)d=a.lineWidth-1,a.strokeRect(b+d/2,g+d/2,f-d,c-d);a.restore()}}function Sa(a,b,d,f,c){function k(a,b,d,f,c){c&&!c.strokeStyle||a.strokeText(b,d,f);c&&!c.fillStyle||a.fillText(b,d,f)}a.save();$a(a,c);if(0>b.indexOf("\n"))k(a,
b,d,f,c);else{var g=b.split("\n");b=1.2*(c&&c.fontSize||24);switch(a.textBaseline){case "top":for(var e=0;e<g.length;e++){var h=g[e];k(a,h,d,f,c);f+=b}break;case "middle":f-=b*(g.length-1)/2;for(e=0;e<g.length;e++)h=g[e],k(a,h,d,f,c),f+=b;break;case "bottom":for(e=0,g=g.reverse();e<g.length;e++)h=g[e],k(a,h,d,f,c),f-=b}}a.restore()}function la(a,b,d,f,c,k,g){a.save();$a(a,g);switch(a.textAlign){case "center":d+=c/2;break;case "right":d+=c;break}if(0>b.indexOf("\n")){switch(a.textBaseline){case "middle":f+=
k/2;break;case "bottom":f+=k;break}g&&!g.strokeStyle||a.strokeText(b,d,f,c);g&&!g.fillStyle||a.fillText(b,d,f,c)}else{b=b.split("\n");var e=1.2*(g&&g.fontSize||24);switch(a.textBaseline){case "middle":f+=(k-e*(b.length-1))/2;break;case "bottom":f=f+k-e*(b.length-1);break}for(k=0;k<b.length;k++){var h=a,l=b[k],m=d,t=f,M=c,r=g;r&&!r.strokeStyle||h.strokeText(l,m,t,M);r&&!r.fillStyle||h.fillText(l,m,t,M);f+=e}}a.restore()}function kb(a,b,d,f,c,k,g){a=a.createLinearGradient(b,d,f,c);a.addColorStop(0,
k);a.addColorStop(1,g);return a}function Ba(a,b,d,f,c,k,g){0<f&&0<c&&(a.save(),a.fillStyle=kb(a,b,d,b,d+c,k,g),a.fillRect(b,d,f,c),a.restore())}function ab(a,b,d,f,c,k,g,e){void 0===e&&(e=0);0<f&&0<c&&(a.save(),a.translate(b+f/2,d+c/2),a.scale(f,c),b=a.createRadialGradient(0,0,e/2,0,0,.5),b.addColorStop(0,k),b.addColorStop(1,g),a.fillStyle=b,a.fillRect(-.5,-.5,1,1),a.restore())}function l(a,b,d){return"rgb("+a+","+b+","+d+")"}function u(a,b,d,f){return"rgba("+a+","+b+","+d+","+f.toFixed(6).replace(/([0-9]+(\.[0-9]+[1-9])?)(\.?0+$)/,
"$1")+")"}function Ta(a,b){return null==b?l(a.r,a.g,a.b):u(a.r,a.g,a.b,b)}function bb(a){return a.map(function(a){return Gb[a].localized}).join(", ")}function ma(a){for(var b=0,d=0;d<a.length;d++)b|=1<<a[d];return b}function lb(a){var b={fillStyle:"white",strokeStyle:"black",fontSize:44,textAlign:"center",textBaseline:"middle"},d={textAlign:"right",textBaseline:"middle"},f={textAlign:"right",textBaseline:"middle"},c=new B(4,4,32,32,new z("assets/config.png"),function(){function c(a,b){var f=100+70*
a;(new I(640,f,160,60,new C(b,d))).attach(l);return f}function g(a,b,d){a=c(a,b);b=new Hb(810,a+15,300,30,d);b.attach(l);(new I(1120,a,50,60,new C(d,f))).attach(l);return b}function e(a,b,d,f,g,h){a=c(a,b);var Za=new B(810,a+0,100,60,new C(function(){var a=g();Za.pressed&&Za.hover&&(a=!a);return(a?d:f).localized}),h);Za.attach(l);return Za}var l=new Ua;(new I(0,0,1280,720,new mb(cb))).attach(l);(new I(0,20,1280,80,new C(h("Config","Caption"),b))).attach(l);(new B(480,495,320,90,new C(h("Config","OK")),
function(){return l.detach()},ub)).attach(l);var m=Qa(J.languages).sort().map(function(a){return h("Language",a)}),da=new D(10,10,160,D.heightOf(Q(10,m.length)),[{name:h("Config","LanguageID"),extract:function(a){return a.src[1]},width:40,align:"center"},{name:h("Config","LanguageName"),extract:function(a){return a.localized}}],m,function(a){da.selected=a;J.language=a.src[1]});da.selected=da.rows.find(function(a){return a.src[1]===J.language});da.attach(l);g(0,h("Config","Volume"),n.volume);g(1,h("Config",
"CPUEffects"),n.effects);var m=h("Config","On"),t=h("Config","Off");e(2,h("Config","MagnifyCanvas"),m,t,function(){return n.magnifyCanvas},function(){n.magnifyCanvas=!n.magnifyCanvas});e(3,h("Config","RefineCanvas"),m,t,function(){return n.refineCanvas},function(){n.refineCanvas=!n.refineCanvas});(function(a,b,d){a=new B(810,70*a+100,300,60,new C(b),d);a.attach(l);return a})(4,h("Config","BackToTitle"),function(){l.detach();Ca()});l.attach(a)},Ib,new B.IconDesign("white"));c.attach(a);return c}function db(){try{var a=
System.getRoamingStorage("NYO");if(a){var b=eb(a);return{shop:b.shop||{},warehouse:aa(oa,b.warehouse,void 0),reservers:aa(ba,b.reservers,void 0),party:aa(ba,b.party,void 0),gold:b.gold||0}}}catch(d){E.error(d)}}function fb(a){try{System.setRoamingStorage("NYO",gb(a))}catch(b){E.error(b)}vb()}function Jb(){function a(a,b){return typeof a===typeof b?b:a}try{var b=System.getLocalStorage("NYO");if(b){var d=eb(b);d&&(J.language=a(J.language,d.language),n.magnifyCanvas=a(n.magnifyCanvas,d.magnifyCanvas),
n.refineCanvas=a(n.refineCanvas,d.refineCanvas),n.volume.value=a(n.volume.value,d.volume),n.effects.value=a(n.effects.value,d.effects))}}catch(f){E.error(f)}}function vb(){try{System.setLocalStorage("NYO",gb({language:J.language,magnifyCanvas:n.magnifyCanvas,refineCanvas:n.refineCanvas,volume:n.volume.value,effects:n.effects.value}))}catch(a){E.error(a)}}var x=this&&this.__extends||function(a,b){function d(){this.constructor=a}for(var f in b)b.hasOwnProperty(f)&&(a[f]=b[f]);a.prototype=null===b?Object.create(b):
(d.prototype=b.prototype,new d)},Qa=Object.keys,nb=Math.abs,Q=Math.min,W=Math.max,v=Math.floor,Va=Math.ceil,za=Math.round,pa=Math.pow,X=Math.sin,qa=Math.cos,wb=Math.atan2,Y=Math.PI,Ya=Math.random,eb=JSON.parse,gb=JSON.stringify,ra=function(){},xb=function(){function a(a,d){this.min=a;this.max=d}a.prototype.map=function(a,d){for(var f=this.min,c=this.max,k=Array(c-f);f<c;++f)k[f]=a.call(d,f);return k};a.prototype.toArray=function(){for(var a=this.min,d=this.max,f=Array(d-a);a<d;++a)f[a]=a;return f};
return a}(),G=new (function(){function a(){}a.prototype.then=function(a){this.sig=ka(this.sig,a);return this};a.prototype.finish=function(){var a=this.sig;if(a)if(this.sig=void 0,"function"===typeof a)a();else for(var d=0;d<a.length;d++)(0,a[d])()};return a}()),J=function(){function a(a){this.src=a}Object.defineProperty(a.prototype,"localized",{get:function(){function b(b){var d=a.languages,k=a.language,g=d[k];if(void 0===g)k in d||(k=a.language=a.fallback,g=d[k]),d[k]=!0,Eb(a.path+k+".js",function(){d[k]=
!1});else if(!0!==g){if(!1===g)return b.join(".");for(var e=g,g=0,h=b.length;g<h;++g)if(e=e[b[g]],!e)return b.join(".");return e.toString()}}if(this._language!==a.language){var d=b(this.src);d&&(this._language=a.language,this._localized=d)}return this._localized||this.src.join(".")},enumerable:!0,configurable:!0});a.prototype.toString=function(){return this.localized};a.prototype.compare=function(a){return ia(this.localized,a.localized)};a.language=window.navigator.language.substr(0,2);a.fallback=
"en";a.path="";a.languages={};return a}();System.localize=function(a,b){J.languages[a]=b};var m;(function(a){a[a.BACKSPACE=8]="BACKSPACE";a[a.TAB=9]="TAB";a[a.ENTER=13]="ENTER";a[a.ESCAPE=27]="ESCAPE";a[a.SPACE=32]="SPACE";a[a.PAGE_UP=33]="PAGE_UP";a[a.PAGE_DOWN=34]="PAGE_DOWN";a[a.END=35]="END";a[a.HOME=36]="HOME";a[a.LEFT=37]="LEFT";a[a.UP=38]="UP";a[a.RIGHT=39]="RIGHT";a[a.DOWN=40]="DOWN";a[a.DELETE=46]="DELETE";a[a.$0=48]="$0";a[a.$1=49]="$1";a[a.$2=50]="$2";a[a.$3=51]="$3";a[a.$4=52]="$4";a[a.$5=
53]="$5";a[a.$6=54]="$6";a[a.$7=55]="$7";a[a.$8=56]="$8";a[a.$9=57]="$9";a[a.A=65]="A";a[a.B=66]="B";a[a.C=67]="C";a[a.D=68]="D";a[a.E=69]="E";a[a.F=70]="F";a[a.G=71]="G";a[a.H=72]="H";a[a.I=73]="I";a[a.J=74]="J";a[a.K=75]="K";a[a.L=76]="L";a[a.M=77]="M";a[a.N=78]="N";a[a.O=79]="O";a[a.P=80]="P";a[a.Q=81]="Q";a[a.R=82]="R";a[a.S=83]="S";a[a.T=84]="T";a[a.U=85]="U";a[a.V=86]="V";a[a.W=87]="W";a[a.X=88]="X";a[a.Y=89]="Y";a[a.Z=90]="Z"})(m||(m={}));var ea=function(){function a(){}a.prototype.onHover=
function(a,d){};a.prototype.onDrag=function(a,d){};a.prototype.onDown=function(a,d){};a.prototype.onUp=function(a,d){};a.prototype.onPress=function(a){};a.prototype.onDraw=function(a,d){};a.prototype.attach=function(a){return a.onAttach(this)};a.prototype.detach=function(){var a=this.parent;if(a)return a.onDetach(this),a};Object.defineProperty(a.prototype,"visible",{get:function(){return!0},set:function(a){Pa(this,"visible",a)},enumerable:!0,configurable:!0});return a}(),S=function(a){function b(d){a.call(this);
this.children=[];if(d)for(var b=0;b<d.length;b++)d[b].attach(this)}x(b,a);b.prototype.onAttach=function(a){if(a.parent===this)return!1;this.children.push(a);a.parent=this;return!0};b.prototype.onDetach=function(a){if(!a.parent)return!1;a.parent=void 0;for(var b=this.children,c=0;c<b.length;++c)if(b[c]===a){a=this.children;for(var b=a.length,k=Array(b-1),g=0;g<c;++g)k[g]=a[g];for(g=c+1;g<b;++g)k[g-1]=a[g];this.children=k;break}return!0};b.prototype.onHover=function(a,b){for(var c=0,k=this.children;c<
k.length;c++){var g=k[c];if(g.visible)g.onHover(a,b)}};b.prototype.onDrag=function(a,b){for(var c=0,k=this.children;c<k.length;c++){var g=k[c];if(g.visible)g.onDrag(a,b)}};b.prototype.onDown=function(a,b){for(var c=0,k=this.children;c<k.length;c++){var g=k[c];if(g.visible)g.onDown(a,b)}};b.prototype.onUp=function(a,b){for(var c=0,k=this.children;c<k.length;c++){var g=k[c];if(g.visible)g.onUp(a,b)}};b.prototype.onPress=function(a){for(var b=0,c=this.children;b<c.length;b++){var k=c[b];if(k.visible)k.onPress(a)}};
b.prototype.onDraw=function(a,b){for(var c=0,k=this.children;c<k.length;c++){var g=k[c];if(g.visible)g.onDraw(a,b)}};return b}(ea),mb=function(){function a(a){this.rectStyle=a}a.prototype.draw=function(a,d,f){Aa(a,f,this.rectStyle)};return a}(),C=function(){function a(a,d,f){this.value=a;this.textStyle=d;this.rectStyle=f;d&&d.fillStyle&&d.textAlign&&d.textBaseline||(a=Object.create(d||null),d&&d.fillStyle||(a.fillStyle="white"),d&&d.textAlign||(a.textAlign="center"),d&&d.textBaseline||(a.textBaseline=
"middle"),this.textStyle=a)}a.prototype.draw=function(a,d,f){d=f.x;var c=f.y,k=f.w;f=f.h;this.rectStyle&&Aa(a,d,c,k,f,this.rectStyle);la(a,this.text,d,c,k,f,this.textStyle)};Object.defineProperty(a.prototype,"text",{get:function(){var a=this.value;"function"===typeof a&&(a=a());return Na(a)},enumerable:!0,configurable:!0});return a}(),z=function(){function a(a){this.src=a;this._image=void 0}a.from=function(b){var d=new a;d._image=b;return d};a.prototype.then=function(a){this._image?G.then(a):(this.sig=
ka(this.sig,a),this.preload());return this};a.prototype.preload=function(){var b=this;if(void 0===this._image){this._image=null;var d=new Image;d.addEventListener("load",function(){b._image=d;ca(b.sig);b.sig=void 0});d.addEventListener("error",function(){b._image=a.DUMMY;ca(b.sig);b.sig=void 0});this.src&&(d.src=this.src)}};Object.defineProperty(a.prototype,"image",{get:function(){void 0===this._image&&this.preload();return this._image},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"w",{get:function(){var a=this.image;return a?a.width:1},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"h",{get:function(){var a=this.image;return a?a.height:1},enumerable:!0,configurable:!0});a.prototype.draw=function(a,d,f,c,k){d=this.image;var g=f.x,e=f.y,h=f.w;f=f.h;d&&0<h&&0<f&&(!c||0>=k?a.drawImage(d,g,e,h,f):(a.save(),a.globalCompositeOperation="destination-out",a.drawImage(d,g,e,h,f),a.globalCompositeOperation="destination-over",a.fillStyle=c,a.fillRect(g,e,h,f),1>k&&(a.globalCompositeOperation=
"source-over",a.globalAlpha=1-k,a.drawImage(d,g,e,h,f)),a.restore()))};a.DUMMY=null;return a}(),Kb={fontSize:32,fillStyle:"white",strokeStyle:"black",textAlign:"left",textBaseline:"top",lineWidth:2},cb={fillStyle:u(0,0,0,.8)},Lb={fillStyle:"white",strokeStyle:"black",fontSize:44,textAlign:"center",textBaseline:"middle"},H=function(a){function b(b,f){a.call(this);this.duration=b;f&&(this.onAnimation=f)}x(b,a);b.prototype.attach=function(b){return a.prototype.attach.call(this,b)?(this.start=performance.now(),
!0):!1};b.prototype.detach=function(){this.start=void 0;return a.prototype.detach.call(this)};b.prototype.onDraw=function(a,b){var c=this.start;c&&(b>=c+this.duration?(this.onAnimation(1,a,b),this.detach(),ca(this.sig),this.sig=void 0):(c=W(0,b-c)/this.duration,this.onAnimation(c,a,b)))};b.prototype.onAnimation=function(a,b,c){};b.prototype.then=function(a){this.sig=ka(this.sig,a);return this};b.clamp=function(a,b,c){return!b||a<b?0:!c||b+c<a?1:(a-b)/c};b.cycle=function(a,b,c){return!b||!c||a<b?0:
(a-b)%c/c};return b}(ea),yb=function(a){function b(b,f){void 0===f&&(f=400);a.call(this,f);this.next=b}x(b,a);b.prototype.onAnimation=function(a,b,c){if(1>a){if(0<a)this.next.onDraw(b,c);b.save();b.globalAlpha=1-a;b.fillStyle="black";b.fillRect(0,0,1280,720);b.restore()}else this.next.attach(this.parent)};return b}(H),T=function(a){function b(b,f,c){void 0===c&&(c=400);a.call(this,c);this.prev=b;this.next=f}x(b,a);b.go=function(a,f,c){void 0===c&&(c=400);(new b(a,f,c)).attach(a.parent)};b.prototype.attach=
function(b){return a.prototype.attach.call(this,b)?(this.prev.detach(),!0):!1};b.prototype.onAnimation=function(a,b,c){1>a?(this.prev.onDraw(b,c),0<a&&(b.save(),b.globalAlpha=a,b.fillStyle="black",b.fillRect(0,0,1280,720),b.restore())):this.next&&(new yb(this.next,this.duration)).attach(this.parent)};return b}(H),Ua=function(a){function b(){a.apply(this,arguments)}x(b,a);b.prototype.attach=function(b){return!this.prev&&b.parent&&a.prototype.attach.call(this,b.parent)?(b.detach(),this.prev=b,!0):!1};
b.prototype.detach=function(){var b=a.prototype.detach.call(this);b&&this.prev.attach(b);return b};b.prototype.onDraw=function(b,f){this.prev.onDraw(b,f);a.prototype.onDraw.call(this,b,f)};b.confirm=function(a,f){for(var c=[],k=2;k<arguments.length;k++)c[k-2]=arguments[k];var g=new b;(new I(0,0,1280,720,new C(f,Lb,cb))).attach(g);for(var k=c.length,e=1280/(3+k),h=e/8,l=(1280-e*k-h*(k-1))/2,m=function(a){var b=c[a],d=b.click,f=b.mnemonic;(new B(l+(e+h)*a,495,e,90,new C(b.label),d?function(){g.detach();
d()}:function(){g.detach()},f)).attach(g)},t=0;t<k;++t)m(t);g.attach(a);return g};return b}(S),sa=function(a){function b(b,f,c,k){a.call(this);this.x=b;this.y=f;this.w=c;this.h=k}x(b,a);b.prototype.contains=function(a,b){return this.visible&&this.x<=a&&this.y<=b&&a<this.x+this.w&&b<this.y+this.h};Object.defineProperty(b.prototype,"left",{get:function(){return this.x},set:function(a){this.w=this.w+this.x-a;this.x=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"right",{get:function(){return this.x+
this.w},set:function(a){this.w=a-this.x},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"top",{get:function(){return this.y},set:function(a){this.h=this.h+this.y-a;this.y=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"bottom",{get:function(){return this.y+this.h},set:function(a){this.h=a-this.y},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"center",{get:function(){return{x:this.x+this.w/2,y:this.y+this.h/2}},enumerable:!0,configurable:!0});
b.prototype.moveTo=function(a,b){this.x=a;this.y=b;return this};b.prototype.moveBy=function(a,b){this.x+=a;this.y+=b;return this};return b}(ea),I=function(a){function b(b,f,c,k,g){a.call(this,b,f,c,k);this.drawable=g}x(b,a);b.prototype.onDraw=function(a,b){this.drawable.draw(a,b,this)};return b}(sa),B=function(a){function b(d,f,c,k,g,e,h,l){void 0===l&&(l=b.defaultDesign);a.call(this,d,f,c,k);this.drawable=g;this.click=e;this.mnemonic=h;this.design=l;this.hover=!1}x(b,a);Object.defineProperty(b.prototype,
"enabled",{get:function(){return!0},set:function(a){Pa(this,"enabled",a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"state",{get:function(){return this.enabled?this.pressed?2:this.hover?1:0:3},enumerable:!0,configurable:!0});b.prototype.onHover=function(a,b){this.hover=this.contains(a,b);this.pressed=void 0};b.prototype.onDrag=function(a,b){null!=this.pressed&&(this.pressed=this.contains(a,b))};b.prototype.onDown=function(a,b){this.enabled&&this.contains(a,b)&&(this.pressed=
!0)};b.prototype.onUp=function(a,b){var c=this.pressed;this.pressed=void 0;if(c&&this.contains(a,b))this.onClick()};b.prototype.onPress=function(a){this.mnemonic&&0<=this.mnemonic.indexOf(a)&&this.enabled&&(this.pressed=!1,this.onClick())};b.prototype.onClick=function(){var a=this,b=this.click;b&&G.then(function(){return b.call(a)})};b.prototype.onDraw=function(a,b){this.design.draw(a,b,this)};b.defaultDesign={draw:function(a,f,c){Aa(a,c,b.defaultDesign.getStyle(c.state));c.drawable&&c.drawable.draw(a,
f,c)},getStyle:function(a){var b={};switch(a){case 0:b.fillStyle=u(0,0,0,.8);b.strokeStyle=l(200,200,200);break;case 1:b.fillStyle=u(0,0,50,.8);b.strokeStyle=l(100,100,200);break;case 2:b.fillStyle=u(0,0,150,.8);b.strokeStyle=l(100,100,255);break;case 3:b.fillStyle=u(200,200,200,.8),b.strokeStyle=l(200,200,200)}return b}};b.IconDesign=function(){function a(b){this.overlay=b}a.prototype.draw=function(a,b,d){var g=d.drawable;switch(d.state){case 0:g.draw(a,b,d);break;case 1:g.draw(a,b,d,this.overlay,
.7);break;case 2:g.draw(a,b,d,this.overlay,.9);break;case 3:g.draw(a,b,d,l(200,200,200),.8)}};return a}();return b}(sa),Mb=function(a){function b(b,f,c,k,g,e,h,l,m,t){void 0===t&&(t=B.defaultDesign);a.call(this,b,f,c,k,e,h,m,t);this.group=g;this.swap=l;g.push(this)}x(b,a);b.prototype.onDrag=function(b,f){var c=this;a.prototype.onDrag.call(this,b,f);var k=this.dragged,g=this.swapping;if(k&&!g){var e=this.group.find(function(a){return a!==c&&a.contains(b,f)&&!a.swapping});e?(k=performance.now(),this.onSwap(e,
k),e.onSwap(this,k),g=this.swapping,this.dragged={xOrig:g.xTo,yOrig:g.yTo},this.swap&&this.swap(e)):null!=k.xDown?(this.x=k.xOrig-k.xDown+b,this.y=k.yOrig-k.yDown+f):this.contains(b,f)?(k.xDown=b,k.yDown=f):(this.pressed=this.dragged=void 0,this.hover=!1)}};b.prototype.onDown=function(b,f){a.prototype.onDown.call(this,b,f);!this.dragged&&this.contains(b,f)&&(this.dragged={xDown:b,yDown:f,xOrig:this.x,yOrig:this.y})};b.prototype.onUp=function(b,f){if(this.swapping)this.dragged=void 0,a.prototype.onUp.call(this,
b,f);else if(this.dragged){var c=this.dragged,k=c.xOrig,c=c.yOrig;this.swapping={start:performance.now(),xFrom:this.x,yFrom:this.y,xTo:k,yTo:c};this.dragged=void 0;if(this.pressed&&(this.pressed=void 0,this.contains(b,f)&&k<=b&&c<=f&&b<k+this.w&&f<c+this.h))this.onClick()}else a.prototype.onUp.call(this,b,f)};b.prototype.onSwap=function(a,b){this.pressed=void 0;this.swapping={start:b,xFrom:this.x,yFrom:this.y,xTo:a.dragged?a.dragged.xOrig:a.x,yTo:a.dragged?a.dragged.yOrig:a.y}};b.prototype.onDraw=
function(b,f){if(this.swapping){var c=H.clamp(f,this.swapping.start,200);1>c?(c=(1-qa(Y*c))/2,this.x=this.swapping.xFrom*(1-c)+this.swapping.xTo*c,this.y=this.swapping.yFrom*(1-c)+this.swapping.yTo*c):(this.x=this.swapping.xTo,this.y=this.swapping.yTo,this.swapping=void 0)}a.prototype.onDraw.call(this,b,f)};return b}(B),D=function(a){function b(d,f,c,k,g,e,h,l){void 0===l&&(l=b.defaultDesign);a.call(this,d,f,c,k);this.columns=g;this.rows=e;this.click=h;this.design=l;this.topRow=0}x(b,a);b.heightOf=
function(a,f){void 0===f&&(f=b.defaultDesign);return f.headerHeight+a*f.rowHeight};b.prototype.onHover=function(a,b){this.hover=this.toRowIndex(a,b);this.scrolling=this.dragged=void 0};b.prototype.onDrag=function(a,b){var c=this.design.headerHeight;null!=this.scrolling?this.scrollTo(v(this.rows.length*(b-(this.y+c)-this.scrolling)/(this.h-c))):(c=this.toRowIndex(void 0,b),null!=c&&null!=this.dragged&&c!==this.dragged&&(k=[this.rows[c],this.rows[this.dragged]],this.rows[this.dragged]=k[0],this.rows[c]=
k[1],this.dragged=c,this.sortkeys=this.scrolling=this.hover=void 0));var k};b.prototype.onDown=function(a,b){if(this.contains(a,b)&&(this.hover=this.dragged=this.toRowIndex(a,b),null==this.dragged)){var c=this.design,k=c.headerHeight,g=this.w-c.scrollBarWidth,c=this.y+k;if(this.x<=a&&a<this.x+g&&this.y<=b&&b<c)c=this.toColumnIndex(a),null!=c&&this.sort(c,!!this.sortkeys&&this.sortkeys[0]===c+1);else if(this.x+g<=a&&a<this.right){var g=this.rows.length,e=this.displayCount,k=this.h-k,h=c+k*this.topRow/
g,l=k*e/g;c<=b&&b<h?(this.scrollTo(v(g*(b-c)/k)),h=c+k*this.topRow/g):h+l<=b&&b<this.bottom&&(this.scrollTo(v(g*(b-c)/k)-e+1),h=c+k*this.topRow/g);h<=b&&b<h+l&&(this.scrolling=b-h)}}};b.prototype.onUp=function(a,b){null==this.scrolling&&null!=this.dragged&&this.dragged===this.hover&&(this.click(this.rows[this.dragged],this.dragged),this.refresh());this.scrolling=this.dragged=void 0;this.hover=this.toRowIndex(a,b)};b.prototype.onPress=function(a){switch(a){case m.PAGE_DOWN:this.scrollBy(this.scrollStep);
break;case m.PAGE_UP:this.scrollBy(-this.scrollStep)}};b.prototype.onDraw=function(a,b){var c=this.design,k=c.headerHeight,g=c.scrollBarWidth,e=this.rows.length,h=this.displayCount,l=this.x,m=this.y+k,t=this.w-g,n=this.h-k,r=this.x+t,V=(0<e&&n*this.topRow/e||0)+m,O=0<e&&n*h/e||n,sb=this.defaultColumnWidth;c.drawHeader(a,this.x,this.y,this.w,k);c.drawBackground(a,this.x,m,t,n);0<g&&(c.drawHeader(a,r,m,g,n),h<e&&c.drawScrollBar(a,r,V,g,O));a.save();a.font=c.rowFont;a.fillStyle=c.rowStyle;a.textBaseline=
"middle";for(var O=c.rowHeight,R=0;R<h;++R){var g=R+this.topRow,tb=this.rows[g],na=m+O*R;g===this.dragged?c.drawRowDragged(a,this.x,na,t,O):tb===this.selected?c.drawRowSelected(a,this.x,na,t,O):g===this.hover&&null==this.dragged&&c.drawRowHover(a,this.x,na,t,O);for(var zb=0,g=0,e=this.columns.length;g<e;++g){var r=this.columns[g],V=ha(r.width,sb),Da=this.extract(tb,r);if(null!=Da){var ta=l+zb+2,ob=V-4;a.textAlign=r.align||"left";switch(a.textAlign){case "center":ta+=ob/2;break;case "right":ta+=ob}a.fillText(Da,
ta,na+O/2,ob)}zb+=V}}a.restore();a.save();O=0;a.font=c.headerFont;a.fillStyle=c.headerStyle;a.textAlign="center";a.textBaseline="middle";a.strokeStyle=c.lineStyle;g=0;for(e=this.columns.length;g<e;++g)r=this.columns[g],V=ha(r.width,sb),R=l+O,0<g&&(a.beginPath(),a.moveTo(R,m),a.lineTo(R,this.bottom),a.stroke()),a.fillText(r.name.localized,R+V/2,this.y+k/2),O+=V;a.restore();0===h&&0<n&&c.emptyText&&(a.save(),c.emptyFont&&(a.font=c.emptyFont),a.textAlign="center",a.textBaseline="middle",c.emptyStyle&&
(a.fillStyle=c.emptyStyle),a.fillText(c.emptyText.localized,this.x+t/2,m+n/2),a.restore())};Object.defineProperty(b.prototype,"displayCount",{get:function(){var a=this.design;return Q(v((this.h-a.headerHeight)/a.rowHeight),this.rows.length)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"scrollStep",{get:function(){return W(v(.2*this.displayCount),1)},enumerable:!0,configurable:!0});b.prototype.extract=function(a,b){var c=b.extract;switch(typeof c){case "function":return c(a);
case "number":return a[c];default:return a[c]}};b.prototype.compare=function(a,b){var c=this.sortkeys,k=this.columns,g=0;if(c)for(var e=0,h=c.length;0===g&&e<h;++e){var l=c[e],g=k[(0<l?l:-l)-1],g=g.compare?g.compare(a,b):ia(this.extract(a,g),this.extract(b,g));0>l&&(g=-g)}return g};b.prototype.sort=function(a,b){var c=this;void 0===b&&(b=!1);var k=a+1;if(this.sortkeys){for(var e=0,h=this.sortkeys.length;e<h;++e){var l=this.sortkeys[e];if(l===k||l===-k){this.sortkeys.splice(e,1);break}}this.sortkeys.unshift(b?
-k:k)}else this.sortkeys=[b?-k:k];this.rows.sort(function(a,b){return c.compare(a,b)})};b.prototype.toRowIndex=function(a,b){var c=this.design,e=this.w-c.scrollBarWidth;if(void 0===a||this.x<=a&&a<this.x+e)if(c=this.topRow+v((b-this.y-c.headerHeight)/c.rowHeight),this.topRow<=c&&c<this.rows.length)return c};b.prototype.toColumnIndex=function(a){for(var b=this.defaultColumnWidth,c=this.x,e=0,g=this.columns.length;e<g;++e){var h=ha(this.columns[e].width,b);if(c<=a&&a<c+h)return e;c+=h}};Object.defineProperty(b.prototype,
"defaultColumnWidth",{get:function(){for(var a=this.w-this.design.scrollBarWidth,b=0,c=0,e=0,g=this.columns;e<g.length;e++){var h=g[e];null!=h.width?b+=h.width:++c}return 0<c&&b<a?(a-b)/c:0},enumerable:!0,configurable:!0});b.prototype.refresh=function(){var a=this.rows.length;this.dragged>=a&&(this.dragged=void 0);this.hover>=a&&(this.hover=void 0);this.scrollTo(this.topRow)};b.prototype.scrollTo=function(a){this.topRow=ga(0,this.rows.length-this.displayCount,a)};b.prototype.scrollBy=function(a){this.scrollTo(this.topRow+
a)};b.defaultDesign={rowHeight:28,rowFont:ja(20),rowStyle:"white",headerHeight:24,headerFont:ja(18),headerStyle:"white",scrollBarWidth:14,lineStyle:l(102,102,102),drawHeader:function(a,b,c,e,g){a.save();a.fillStyle=u(25,25,25,.8);a.fillRect(b,c,e,g);a.restore()},drawBackground:function(a,b,c,e,g){a.save();a.fillStyle=u(0,0,0,.6);a.fillRect(b,c,e,g);a.restore()},drawScrollBar:function(a,b,c,e,g){Ba(a,b,c,e,g,l(100,100,100),l(75,75,75))},drawRowDragged:function(a,b,c,e,g){Ba(a,b,c,e,g,l(255,0,0),l(50,
0,0))},drawRowSelected:function(a,b,c,e,g){Ba(a,b,c,e,g,l(100,0,0),l(50,0,0))},drawRowHover:function(a,b,c,e,g){Ba(a,b,c,e,g,l(75,0,0),l(50,0,0))}};return b}(sa),Ab=function(){function a(a,d,f){this.min=d;this.max=f;this.value=a}Object.defineProperty(a.prototype,"value",{get:function(){return this._value},set:function(a){this._value=ga(this.min,this.max,za(a))},enumerable:!0,configurable:!0});a.prototype.toString=function(){return this._value.toString()};a.prototype.valueOf=function(){return this._value};
return a}(),Hb=function(a){function b(d,f,c,e,g,h){void 0===h&&(h=b.defaultDesign);a.call(this,d,f,c,e);this.value=g;this.design=h;this.hover=this.dragged=!1}x(b,a);b.prototype.getValueAsX=function(){var a=this.design.knobWidth,b=this.value,c=b.min;return this.x+a/2+(b.value-c)/(b.max-c)*(this.w-a)};b.prototype.setValueByX=function(a){var b=this.design.knobWidth;a=ga(0,1,(a-this.x-b/2)/(this.w-b));var b=this.value,c=b.min;this.value.value=za(c+a*(b.max-c))};b.prototype.onHover=function(a,b){this.hover=
this.contains(a,b);this.dragged=!1};b.prototype.onDrag=function(a,b){this.hover=this.dragged&&this.contains(a,b);this.dragged&&this.setValueByX(a)};b.prototype.onDown=function(a,b){this.contains(a,b)&&(this.dragged=!0,this.setValueByX(a))};b.prototype.onUp=function(a,b){this.dragged=!1};b.prototype.onDraw=function(a,b){this.design.draw(a,b,this)};Object.defineProperty(b.prototype,"knob",{get:function(){var a=this.design.knobWidth,b=this.h;return{x:this.getValueAsX()-a/2,y:this.y-(this.h-b)/2,w:a,
h:b,state:this.dragged?2:this.hover?1:0}},enumerable:!0,configurable:!0});b.defaultDesign={knobWidth:12,draw:function(a,b,c){Aa(a,c,{fillStyle:u(50,50,50,.8),strokeStyle:"white",lineWidth:4});b=c.knob;c={strokeStyle:"white",lineWidth:4};switch(b.state){case 0:c.fillStyle=u(150,150,150,.8);break;case 1:c.fillStyle=u(200,200,200,.8);break;case 2:c.fillStyle=u(255,255,255,.8)}Aa(a,b,c)}};return b}(sa),Nb=function(a){function b(b,f,c,e,g,h){a.call(this,b,f,c,e);this.duration=g;this.style=h;this.logs=
[]}x(b,a);b.prototype.onDraw=function(a,b){var c=this.logs;if(0<c.length){var e=b-this.duration,g=c.findIndex(function(a){return a.when>e});0>g?c.length=0:c.splice(0,g);g=c.length;if(0<g)for(var h=this.style,l=1.2*(h&&h.fontSize||24),m=0;m<g;++m)la(a,c[m].message,this.x,this.y+m*l,this.w,l,h)}};b.prototype.log=function(a){if(a){var b=performance.now(),c=this.logs,e=c.length;0<e&&c[e-1].message===a?c[e-1].when=b:c.push({message:Na(a),when:b})}};b.prototype.error=function(a){this.log(a)};return b}(sa);
J.path="assets/lang/";J.languages.en=void 0;J.languages.ja=void 0;var Ib=[m.ESCAPE],Ea=[m.ENTER,m.SPACE],ua=[m.BACKSPACE,m.TAB,m.ESCAPE,m.DELETE],Ob=[m.PAGE_UP,m.HOME,m.LEFT,m.UP],Pb=[m.PAGE_DOWN,m.END,m.RIGHT,m.DOWN],ub=Ea.concat(ua),pb=Ea.concat(m.Y),qb=ua.concat(m.N),e;(function(a){a[a.Melee=0]="Melee";a[a.Throw=1]="Throw";a[a.Shoot=2]="Shoot";a[a.Magic=3]="Magic";a[a.Alchemy=4]="Alchemy";a[a.Slash=5]="Slash";a[a.Blunt=6]="Blunt";a[a.Pierce=7]="Pierce";a[a.Shield=8]="Shield";a[a.Head=9]="Head";
a[a.Body=10]="Body";a[a.Arms=11]="Arms";a[a.Legs=12]="Legs";a[a.Fire=13]="Fire";a[a.Cold=14]="Cold";a[a.Lightning=15]="Lightning";a[a.Life=16]="Life";a[a.MAX=17]="MAX"})(e||(e={}));var hb={bkgnd:u(0,0,0,.6),delta:l(255,51,0),normal:l(153,204,0),full:l(0,204,51)},Bb={bkgnd:u(0,0,0,.6),delta:l(0,51,102),normal:l(0,153,204),full:l(0,153,255)},Fa=[{PICK:0,WALK:!1,POPUP:!1},{PICK:0,WALK:!1,POPUP:!0},{PICK:0,WALK:!0,POPUP:!0},{PICK:300,WALK:!0,POPUP:!0}],n,E,Qb={Warrior:{INT:4,DEX:4,STR:7,equipments:["Mace",
"PlateArmor","Mace","FirstAidKit"],skills:["Swing","Crash","Bash","PathToWarrior","PotionOfRegeneration"],image:"nazrin"},Samurai:{INT:3,DEX:7,STR:5,equipments:["Katana","Chainmail","FirstAidKit"],skills:["Swing","Slash","CutThrough","Sweep","PotionOfHealth"],image:"rin"},Knight:{INT:6,DEX:2,STR:7,equipments:["Spear","LamellarArmor","KiteShield"],skills:["Swing","Stab","Thrust","ShieldBash","ShieldCharge"],image:"toramaru"},Thief:{INT:3,DEX:6,STR:6,equipments:["LongBow","LetherArmor","FirstAidKit"],
skills:["Shoot","PoisonArrow","FirstAid"],image:"marisa"},Healer:{INT:7,DEX:3,STR:5,equipments:["Staff","Robe"],skills:["Swing","Heal","PartyHeal"],image:"reimu"},Mage:{INT:8,DEX:4,STR:3,equipments:["Wand","Robe"],skills:["FireBall","IceSpear","DrainLife","LightningLaser","FireNova"],image:"utsuho"}},Cb={Ant:{INT:3,DEX:3,STR:4,equipments:["Dagger","LetherArmor"],skills:["Swing"],image:"ant.png"},Elemental:{INT:4,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["FireBall","ResistFire"],image:"elemental.png"},
Frog:{INT:4,DEX:4,STR:4,equipments:["ShortBow","LetherArmor"],skills:["Shoot"],image:"frog.png"},Plant:{INT:4,DEX:3,STR:4,equipments:["Wand","LetherArmor"],skills:["FireNova"],image:"plant.png"},Slug:{INT:3,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["DrainLife"],image:"slug.png"},Snail:{INT:3,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["Heal"],image:"snail.png"},Sword:{INT:3,DEX:5,STR:4,equipments:["LongSword","LetherArmor"],skills:["Swing"],image:"sword.png"},Wall:{INT:2,DEX:2,
STR:6,equipments:["Mace","LetherArmor"],skills:["Swing"],image:"wall.png"},Weasel:{INT:3,DEX:6,STR:3,equipments:["Spear","LetherArmor"],skills:["Thrust"],image:"weasel.png"}},Rb={AddedFire:{tags:[e.Melee,e.Throw,e.Shoot],min:5,max:10,ATK:function(a,b){return b+a}}},Z={Dagger:{tags:[e.Melee,e.Slash],weight:13,price:100,ATK:30},ShortSword:{tags:[e.Melee,e.Slash],weight:15,price:100,ATK:40},LongSword:{tags:[e.Melee,e.Slash],weight:16,price:100,ATK:50},Katana:{tags:[e.Melee,e.Slash],weight:15,price:100,
ATK:45},Axe:{tags:[e.Melee,e.Slash,e.Blunt],weight:18,price:100,ATK:45},Mace:{tags:[e.Melee,e.Blunt],weight:16,price:100,ATK:40},Spear:{tags:[e.Melee,e.Pierce],weight:20,price:100,ATK:50},Halberd:{tags:[e.Melee,e.Slash,e.Blunt,e.Pierce],weight:30,price:100,ATK:50},ShortBow:{tags:[e.Shoot,e.Pierce],weight:18,price:100,ATK:30},LongBow:{tags:[e.Shoot,e.Pierce],weight:20,price:100,ATK:40},Staff:{tags:[e.Melee,e.Blunt,e.Magic],weight:20,price:100,ATK:20},Wand:{tags:[e.Magic],weight:16,price:100,ATK:25},
FirstAidKit:{tags:[e.Alchemy],weight:10,price:100,ATK:20},Buckler:{tags:[e.Shield],weight:20,price:100,ATK:10,DEF:10},RoundShield:{tags:[e.Shield],weight:25,price:100,ATK:15,DEF:15},SpikedShield:{tags:[e.Shield],weight:30,price:100,ATK:30,DEF:15},KiteShield:{tags:[e.Shield],weight:35,price:100,ATK:20,DEF:20},TowerShield:{tags:[e.Shield],weight:40,price:100,ATK:30,DEF:20},Circlet:{tags:[e.Head],weight:5,price:100,DEF:2},LeatherHood:{tags:[e.Head],weight:10,price:100,DEF:4},Mask:{tags:[e.Head],weight:15,
price:100,DEF:6},Sallet:{tags:[e.Head],weight:20,price:100,DEF:8},Bascinet:{tags:[e.Head],weight:25,price:100,DEF:10},Helmet:{tags:[e.Head],weight:30,price:100,DEF:12},Robe:{tags:[e.Body],weight:20,price:100,DEF:10},LetherArmor:{tags:[e.Body],weight:25,price:100,DEF:15},ScaleArmor:{tags:[e.Body],weight:30,price:100,DEF:20},Chainmail:{tags:[e.Body],weight:35,price:100,DEF:22},LamellarArmor:{tags:[e.Body],weight:40,price:100,DEF:25},PlateArmor:{tags:[e.Body],weight:45,price:100,DEF:30},Gloves:{tags:[e.Arms],
weight:10,price:100,DEF:4},Mittens:{tags:[e.Arms],weight:20,price:100,DEF:6},Gauntlets:{tags:[e.Arms],weight:30,price:100,DEF:8},Slippers:{tags:[e.Legs],weight:5,price:100,DEF:2},Sandals:{tags:[e.Legs],weight:10,price:100,DEF:4},Shoes:{tags:[e.Legs],weight:15,price:100,DEF:6},Boots:{tags:[e.Legs],weight:20,price:100,DEF:8},Greaves:{tags:[e.Legs],weight:25,price:100,DEF:10}},Sb={Dummy:{tags:[],usage:2,power:0,cost:999,range:0,effect:"Damage",action:"Charge"},Swing:{tags:[e.Melee],usage:2,power:100,
cost:14,range:1,effect:"Damage",action:"Charge"},Slash:{tags:[e.Melee,e.Slash],usage:2,power:110,cost:15,range:1,effect:"Damage",action:"Charge"},CutThrough:{tags:[e.Melee,e.Slash],usage:2,power:100,cost:20,range:1,effect:"Damage",action:"GoBehind"},Sweep:{tags:[e.Melee,e.Slash],usage:6,power:100,cost:20,range:1,effect:"Damage",action:"Nova"},Crash:{tags:[e.Melee,e.Blunt],usage:2,power:110,cost:15,range:1,effect:"Damage",action:"Charge"},Bash:{tags:[e.Melee,e.Blunt],usage:2,power:100,cost:20,range:1,
effect:"Damage",action:"Knockback"},Stab:{tags:[e.Melee,e.Pierce],usage:2,power:110,cost:15,range:1,effect:"Damage",action:"Charge"},Thrust:{tags:[e.Melee,e.Pierce],usage:4,power:100,cost:15,range:2,effect:"Damage",action:"Laser"},ShieldBash:{tags:[e.Shield],usage:2,power:100,cost:20,range:1,effect:"Damage",action:"Charge"},ShieldCharge:{tags:[e.Shield],usage:2,power:100,cost:24,range:1,effect:"Damage",action:"Trample"},Shoot:{tags:[e.Shoot],usage:2,power:100,cost:20,range:3,effect:"Damage",action:"Shoot"},
PoisonArrow:{tags:[e.Shoot],usage:2,power:60,cost:20,range:3,effect:"DamageOverTime",action:"Shoot"},IceSpear:{tags:[e.Magic,e.Cold],usage:2,power:80,cost:16,range:5,effect:"DamageHPandSP",action:"Shoot"},DrainLife:{tags:[e.Magic,e.Life],usage:2,power:80,cost:16,range:5,effect:"Damage",action:"Drain"},FireBall:{tags:[e.Magic,e.Fire],usage:2,power:100,cost:16,range:5,effect:"Damage",action:"Explode"},LightningLaser:{tags:[e.Magic,e.Lightning],usage:4,power:100,cost:16,range:5,effect:"Damage",action:"Laser"},
FireNova:{tags:[e.Magic,e.Fire],usage:6,power:100,cost:16,range:2,effect:"Damage",action:"Nova"},Heal:{tags:[e.Magic,e.Life],usage:3,power:100,cost:24,range:3,effect:"Heal",action:"Shoot"},PartyHeal:{tags:[e.Magic,e.Life],usage:7,power:100,cost:24,range:1,effect:"Heal",action:"Nova"},FirstAid:{tags:[e.Alchemy,e.Life],usage:3,power:50,cost:24,range:1,effect:"HealOverTime",action:"Charge"},PotionOfHealth:{tags:[e.Alchemy,e.Life],usage:1,power:100,cost:24,effect:"Heal",action:"Dose"},PotionOfRegeneration:{tags:[e.Alchemy,
e.Life],usage:1,power:75,cost:24,effect:"HealOverTime",action:"Dose"},PathToWarrior:{tags:[e.Melee],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},PathToNinja:{tags:[e.Throw],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},PathToArcher:{tags:[e.Shoot],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},PathToMage:{tags:[e.Magic],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},PathToAlchemist:{tags:[e.Alchemy],usage:0,power:2,cost:10,effect:"Aura",action:"Offence"},Defence:{tags:[e.Melee],
usage:0,power:2,cost:10,effect:"Aura",action:"Defence"},Dodge:{tags:[e.Throw,e.Shoot],usage:0,power:2,cost:10,effect:"Aura",action:"Defence"},Meditation:{tags:[e.Magic],usage:0,power:2,cost:10,effect:"Aura",action:"Defence"},Healthy:{tags:[e.Alchemy],usage:0,power:2,cost:10,effect:"Aura",action:"Defence"},AvatarOfFire:{tags:[e.Fire],usage:0,power:4,cost:10,effect:"Aura",action:"Offence"},AvatarOfCold:{tags:[e.Cold],usage:0,power:4,cost:10,effect:"Aura",action:"Offence"},AvatarOfLightning:{tags:[e.Lightning],
usage:0,power:4,cost:10,effect:"Aura",action:"Offence"},ResistFire:{tags:[e.Fire],usage:0,power:4,cost:10,effect:"Aura",action:"Defence"},ResistCold:{tags:[e.Cold],usage:0,power:4,cost:10,effect:"Aura",action:"Defence"},ResistLightning:{tags:[e.Lightning],usage:0,power:4,cost:10,effect:"Aura",action:"Defence"}},Gb=function(a,b){return void 0===b?new xb(0,a):new xb(a,b)}(e.MAX).map(function(a){return h("Tag",e[a])}),Tb=ma([e.Melee,e.Throw,e.Shoot,e.Magic,e.Alchemy,e.Slash,e.Blunt,e.Pierce]),Ub=ma([e.Shield,
e.Head,e.Body,e.Arms,e.Legs]),va=function(){function a(b){this.EID=b;this.def=Rb[b];if(!this.def)throw new RangeError('Enchantment not found: "'+b+'"');this.name=a.nameOf(b);this.spec=a.specOf(b);this.value=this.def.min+Ma(this.def.max-this.def.min)}a.prototype.qualify=function(a){return Oa(this.name.localized,a)};a.prototype.modify=function(a){this.def.ATK&&(a=this.def.ATK(this.value,a));return a};a.nameOf=function(a){return h("Enchant",a,"Name")};a.specOf=function(a){return h("Enchant",a,"Spec")};
a.from=function(b){return new a(b)};a.fromJSON=function(b){return new a(b.EID)};a.prototype.toJSON=function(){return{EID:this.EID,value:this.value}};return a}(),oa=function(){function a(b,d){this.IID=b;this.def=Z[b];if(!this.def)throw new RangeError('Item not found: "'+b+'"');this.baseName=a.nameOf(b);this.spec=a.specOf(b);this.tagbits=ma(this.def.tags);this.enchants=d?d:this.def.enchants?this.def.enchants.map(va.from):[]}Object.defineProperty(a.prototype,"name",{get:function(){for(var a=this.baseName.localized,
d=0,f=this.enchants;d<f.length;d++)a=f[d].qualify(a);return a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"tags",{get:function(){return this.def.tags},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"weight",{get:function(){return this.def.weight},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"priceToSell",{get:function(){for(var a=this.def.price,d=0,f=this.enchants;d<f.length;d++)a=f[d].modify(a);return v(a)},enumerable:!0,configurable:!0});
Object.defineProperty(a.prototype,"ATK",{get:function(){for(var a=this.def.ATK||0,d=0,f=this.enchants;d<f.length;d++)a=f[d].modify(a);return a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){for(var a=this.def.DEF||0,d=0,f=this.enchants;d<f.length;d++)a=f[d].modify(a);return a},enumerable:!0,configurable:!0});a.nameOf=function(a){return h("Item",a,"Name")};a.specOf=function(a){return h("Item",a,"Spec")};a.from=function(b){return new a(b)};a.fromJSON=function(b){return new a(b.IID,
aa(va,b.enchants,void 0))};a.prototype.toJSON=function(){return{IID:this.IID,enchants:wa(this.enchants,void 0)}};return a}(),ib=function(){function a(b){this.SID=b;this.def=Sb[b];if(!this.def)throw new RangeError('Skill not found: "'+b+'"');this.name=a.nameOf(b);this.spec=a.specOf(b);this.tagbits=ma(this.def.tags)}Object.defineProperty(a.prototype,"tags",{get:function(){return this.def.tags},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"rawCost",{get:function(){return this.def.cost},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"rawRange",{get:function(){return this.def.range},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"rawPower",{get:function(){return this.def.power},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"usage",{get:function(){return this.def.usage},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"hostile",{get:function(){var a;a:switch(this.def.usage){case 3:case 5:case 7:a=!1;break a;
default:a=!0}return a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"effect",{get:function(){return this.def.effect},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"action",{get:function(){return this.def.action},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"isActive",{get:function(){return"Aura"!==this.effect},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"isPassive",{get:function(){return"Aura"===this.effect},enumerable:!0,
configurable:!0});a.prototype.match=function(a){var d=this.tagbits&Tb;return(d&a.tagbits)===d};a.nameOf=function(a){return h("Skill",a,"Name")};a.specOf=function(a){return h("Skill",a,"Spec")};a.from=function(b){return new a(b)};a.fromJSON=function(b){return new a(b.SID)};a.prototype.toJSON=function(){return{SID:this.SID}};a.DUMMY=new a("Dummy");return a}(),Db=[1,2,3,4,5,5,5,5,4,3,2,1],Ga;(function(a){a[a.DEFAULT=0]="DEFAULT";a[a.BLINK_1=1]="BLINK_1";a[a.BLINK_2=2]="BLINK_2";a[a.BLINK_3=3]="BLINK_3";
a[a.BLINK_4=4]="BLINK_4";a[a.CLOSED=5]="CLOSED";a[a.DEAD=6]="DEAD"})(Ga||(Ga={}));var ba=function(){function a(a,d,f,c,e,g,h,l,m){function n(){for(var a=[],b=0;b<arguments.length;b++)a[b-0]=arguments[b];var b=a[0],c=b.w,d=b.h,b=document.createElement("canvas");b.width=c;b.height=d;var f=b.getContext("2d");if(f)for(c={x:0,y:0,w:c,h:d},d=0;d<a.length;d++)a[d].draw(f,void 0,c);return z.from(b)}function t(a){var b=v[0],c=b.w,d=b.h,b=document.createElement("canvas");b.width=c;b.height=d;var f=b.getContext("2d");
if(f){var e={x:0,y:0,w:c,h:d};if(void 0!==f.filter)f.save(),f.filter="grayscale(100%)",a.draw(f,void 0,e),f.restore();else{a.draw(f,void 0,e);a=f.getImageData(0,0,c,d);for(var c=a.data,d=a.width,e=a.height,g=0;g<e;++g)for(var k=0;k<d;++k){var h=4*g*d+4*k,l=.2126*c[h]+.7152*c[h+1]+.0722*c[h+2];c[h]=l;c[h+1]=l;c[h+2]=l}f.putImageData(a,0,0,0,0,d,e)}}return z.from(b)}this.name=a;this.level=d;this.INT=f;this.DEX=c;this.STR=e;this.equipments=g;this.skills=h;this.known=l;this.src=m;var v=[];a=0>m.indexOf("/")?
"assets/char/"+m:m;if(m.endsWith(".png"))m=new z(a),v[0]=m;else{var r=[new z(a+"/back.png"),new z(a+"/eye.png"),new z(a+"/eye1.png"),new z(a+"/eye2.png"),new z(a+"/eye3.png"),new z(a+"/eye4.png"),new z(a+"/eye5.png"),new z(a+"/fore.png")];ya(r).then(function(){v.push(n(r[0],r[1],r[7]),n(r[0],r[2],r[7]),n(r[0],r[3],r[7]),n(r[0],r[4],r[7]),n(r[0],r[5],r[7]),n(r[0],r[6],r[7]));v.push(t(v[Ga.CLOSED]))})}this.images=v;this.blinkCycle=4500+100*f;this.blinkOffset=Ma(this.blinkCycle)}Object.defineProperty(a.prototype,
"w",{get:function(){var a=this.images[0];return a?a.w:1},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"h",{get:function(){var a=this.images[0];return a?a.h:1},enumerable:!0,configurable:!0});a.prototype.draw=function(a,d,f,c,e){var g;g=(d+this.blinkOffset)%this.blinkCycle;g=450>g?Db[v(g/450*Db.length)]:0;var h=this.images;(g=h[g]||h[Ga.DEFAULT])&&g.draw(a,d,f,c,e)};Object.defineProperty(a.prototype,"HP",{get:function(){return 10*(3+this.STR)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"SP",{get:function(){var a=W(0,this.weight-this.maxWeight);return W(0,4*(3+this.STR)-a)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"reservedSP",{get:function(){var a=this;return this.skills.reduce(function(d,f){return d+(f.isPassive?a.costOf(f):0)},0)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"step",{get:function(){return 13-this.DEX},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ZoC",{get:function(){return 3+this.DEX},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"maxWeight",{get:function(){return 10*(3+this.STR)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"weight",{get:function(){return this.equipments.reduce(function(a,d){return a+d.weight},0)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){return 100*(1-this.equipments.reduce(function(a,d){return a*(1-d.DEF/100)},1))},enumerable:!0,configurable:!0});a.prototype.costOf=function(a){return a?
a.rawCost-this.INT:void 0};a.prototype.rangeOf=function(a){return a?a.rawRange:void 0};a.prototype.powerOf=function(a){var d=this.itemFor(a);return d?d.ATK*a.rawPower/100:void 0};a.prototype.itemFor=function(a){var d=void 0;if(a)for(var f=0,c=0,e=this.equipments;c<e.length;c++){var g=e[c];if(a.match(g)){var h=g.ATK;f<h&&(f=h,d=g)}}return d};a.adventurer=function(b){var d=Qb[b];if(!d)throw new RangeError('Adventurer not found: "'+b+'"');return a.from(h("Adventurer",b),0,d)};a.monster=function(b,d){var f=
Cb[b];if(!f)throw new RangeError('Monster not found: "'+b+'"');return a.from(h("Monster",b),d,f)};a.from=function(b,d,f){return new a(b.localized,d,f.INT,f.DEX,f.STR,f.equipments.map(oa.from),f.skills.map(ib.from),[],f.image)};a.fromJSON=function(b){return new a(b.name,b.level||0,b.INT,b.DEX,b.STR,aa(oa,b.equipments,void 0),aa(ib,b.skills,void 0),aa(ib,b.known,void 0),b.image)};a.prototype.toJSON=function(){return{name:this.name,level:this.level,INT:this.INT,DEX:this.DEX,STR:this.STR,equipments:wa(this.equipments,
void 0),skills:wa(this.skills,void 0),known:wa(this.known,void 0),image:this.src}};return a}(),Ha;(function(a){var b=function(a){function b(){var c=this;a.call(this);(new I(0,0,1280,720,new z("assets/scene/title.jpg"))).attach(this);var e=db(),g,l;e?(g=h("Title","Continue"),l=function(){return T.go(c,new Ia.Home(e))},(new B(1070,650,200,60,new C(h("Title","Delete")),function(){Ua.confirm(c,h("Title","ConfirmDelete"),{label:h("Title","Delete"),click:function(){try{System.setRoamingStorage("NYO",void 0)}catch(a){E.error(a)}T.go(c,
new b);E.log(h("Title","NotifyDelete"))},mnemonic:pb},{label:h("Config","Cancel"),mnemonic:qb})})).attach(this)):(g=h("Title","New"),l=function(){var a={},b;for(b in Z){var d=Ma(4);0<d&&(a[b]=d)}a={shop:a,warehouse:[],reservers:[],party:[ba.adventurer("Knight"),ba.adventurer("Warrior"),ba.adventurer("Samurai"),ba.adventurer("Mage"),ba.adventurer("Healer"),ba.adventurer("Thief")],gold:1E3};a.party[0].equipments[0].enchants.push(va.from("AddedFire"));fb(a);T.go(c,new Ia.Home(a))});(new B(480,504,320,
72,new C(g),l,Ea)).attach(this);(new B(480,612,320,72,new C(h("Title","Quit")),System.exit)).attach(this);lb(this)}x(b,a);return b}(S);a.Scene=b})(Ha||(Ha={}));var Ia;(function(a){function b(){return[{name:h("Character","Name"),extract:function(a){return a.name},width:200},{name:h("Character","INT"),extract:function(a){return a.INT},width:60,align:"right"},{name:h("Character","DEX"),extract:function(a){return a.DEX},width:60,align:"right"},{name:h("Character","STR"),extract:function(a){return a.STR},
width:60,align:"right"}]}function d(a){return[{name:a,extract:function(a){return a.name},width:200},{name:h("Town","Tags"),extract:function(a){return bb(a.tags)}},{name:h("Town","Weight"),extract:function(a){return a.weight},width:60,align:"right"},{name:h("Town","ATK"),extract:function(a){return a.ATK},width:60,align:"right"},{name:h("Town","DEF"),extract:function(a){return a.DEF},width:60,align:"right"}]}function e(a,b){var c=b.shop,f=d(a);f.push({name:h("Town","Stock"),extract:function(a){return ha(c[a.IID],
h("Town","New"))},width:60,align:"right"});return f}function c(a,b){var c=b.shop,d=b.warehouse;return[{name:a,extract:function(a){return oa.nameOf(a).localized},width:200},{name:h("Town","Tags"),extract:function(a){return bb(Z[a].tags)}},{name:h("Town","ATK"),extract:function(a){return Z[a].ATK},width:60,align:"right"},{name:h("Town","DEF"),extract:function(a){return Z[a].DEF},width:60,align:"right"},{name:h("Town","Weight"),extract:function(a){return Z[a].weight},width:60,align:"right"},{name:h("Town",
"Stock"),extract:function(a){return c[a]},width:60,align:"right"},{name:h("Town","Owned"),extract:function(a){return d.reduce(function(b,c){return c.IID===a?b+1:b},0)},width:60,align:"right"}]}function k(a){return[{name:a,extract:function(a){return a.name.localized},width:200},{name:h("Town","Required"),extract:function(a){return bb(a.tags)}},{name:h("Town","Cost"),extract:function(a){return a.rawCost},width:60,align:"right"},{name:h("Town","Range"),extract:function(a){return a.rawRange},width:60,
align:"right"},{name:h("Town","Power"),extract:function(a){return a.rawPower},width:60,align:"right"},{name:h("Town","Spec"),extract:function(a){return a.spec.localized}}]}var g={fontSize:64,fillStyle:l(255,255,255),strokeStyle:l(0,0,0),textAlign:"center",textBaseline:"middle",lineWidth:2},n=function(){function a(b,c){this.party=b;this.index=c}a.prototype.draw=function(a,b,c){var d=c.x,e=c.y,f=c.w;c=c.h;var h=this.party[this.index];a.save();if(h){var k=Ra(h,140,184);h.draw(a,b,{x:d+f/2-k.w/2,y:e+
92-k.h/2,w:k.w,h:k.h});var m=this.party.reduce(function(a,b){return b?W(a,b.HP):a},1);b=h.HP;var k=d+10,n=f-20,r=e+c-30,m=(n-2)*b/m;a.strokeStyle="black";a.fillStyle=hb.full;a.fillRect(k,r,m,6);a.strokeRect(k,r,m,6);la(a,b.toString(),k+4,r-20,n,20,{fontSize:20,fillStyle:l(255,255,255),strokeStyle:l(0,0,0),textAlign:"left",textBaseline:"bottom",lineWidth:2});la(a,h.name,d,e+c-24,f,24,{fontSize:24,fillStyle:l(255,255,255),strokeStyle:l(0,0,0),textAlign:"center",textBaseline:"bottom",lineWidth:2})}else la(a,
(this.index+1).toString(),d,e,f,c,g);a.restore()};return a}(),u=function(a){function b(c){a.call(this);this.data=c}x(b,a);b.prototype.addButton=function(a,b,c,d){a=new B(1280-170*a,665,160,45,new C(c),d,b);a.attach(this);return a};b.prototype.goTo=function(a){T.go(this,new a(this.data))};return b}(S),G=function(a){function b(c,d){a.call(this,c);(new I(0,0,1280,720,new z("assets/scene/"+d))).attach(this);lb(this);for(var e=c.party,f=this,g=[],h=0;6>h;++h){var k=v(h/3);(new Mb(10+170*(1-k),10+h%3*214+
68*k,160,204,g,new n(e,h),function(){f.onPortraitClick(this.drawable.index)},function(a){var b=this.drawable;a=a.drawable;c=[e[a.index],e[b.index]];e[b.index]=c[0];e[a.index]=c[1];c=[a.index,b.index];b.index=c[0];a.index=c[1];var c},[m.$1+h])).attach(this)}}x(b,a);return b}(u),H=function(a){function b(c){var d=this;a.call(this,c,"town.jpg");var e=["grass","moss"],f=Ma(e.length);this.addSpot(5,m.A,"Guild",function(){}).enabled=!1;this.addSpot(4,m.B,"Tavern",function(){return d.goTo(t)});this.addSpot(3,
m.C,"Shop",function(){return d.goTo(M)});this.addSpot(2,m.D,"Smith",function(){}).enabled=!1;this.addSpot(1,m.E,"Dungeon",function(){T.go(d,new Ja.Scene(c,new Ja.EndressStage(e[f],0)))}).enabled=c.party.some(function(a){return!!a});this.addButton(2,[m.L],h("Town","Load"),function(){Ua.confirm(d,h("Town","ConfirmLoad"),{label:h("Town","Load"),click:function(){var a=db();a&&(T.go(d,new b(a)),E.log(h("Town","NotifyLoad")))},mnemonic:pb},{label:h("Config","Cancel"),mnemonic:qb})});this.addButton(1,[m.S],
h("Town","Save"),function(){fb(d.data);E.log(h("Town","NotifySave"))})}x(b,a);b.prototype.onPortraitClick=function(a){this.data.party[a]&&T.go(this,new r(this.data,a))};b.prototype.addSpot=function(a,b,c,d){a=new B(950,665-100*a,320,90,new C(h("Town",c)),d,[b]);a.attach(this);return a};return b}(G);a.Home=H;var t=function(a){function c(d){function e(a,b){(c=Array.prototype.splice).call.apply(c,[a,0,a.length].concat(b));var c}var f=this;a.call(this,d,"tavern.jpg");var g=d.party.concat(),k=d.reservers.concat();
this.addButton(3,[m.C],h("Town","Clear"),function(){for(var a=0;6>a;++a){var b=d.party[a];b&&(d.reservers.push(b),d.party[a]=void 0)}});this.addButton(2,[m.R],h("Town","Revert"),function(){e(d.party,g);e(d.reservers,k)});this.addButton(1,ua,h("Town","Back"),function(){return f.goTo(H)});(new D(350,10,920,D.heightOf(10),b(),d.reservers,function(a,b){return f.onReserverClick(a,b)})).attach(this)}x(c,a);c.prototype.onPortraitClick=function(a){var b=this.data.party[a];b&&(this.data.party[a]=void 0,this.data.reservers.push(b))};
c.prototype.onReserverClick=function(a,b){for(var c=0;6>c;++c)if(!this.data.party[c]){this.data.party[c]=a;this.data.reservers.splice(b,1);return}E.error(h("Town","PartyFull"))};return c}(G),M=function(a){function b(d){var g=this;a.call(this,d,"shop.jpg");var k=d.shop,l=d.warehouse,n=new D(350,10,920,D.heightOf(10),c(h("Town","Buy"),d),Qa(k),function(a){if(0>=k[a])E.error(h("Town","SoldOut"));else{var b=Z[a].price;if(d.gold<b)E.error(h("Town","NoMoney"));else{var c=new oa(a);--k[a];l.push(c);d.gold-=
b;E.log(Oa(h("Town","NotifyBuy").localized,c.name,b))}}});n.attach(this);var r=new D(350,10,920,D.heightOf(10),e(h("Town","Sell"),d),l,function(a,b){var c=a.IID,e=a.priceToSell;l.splice(b,1);var f=k[c];null==f?(k[c]=1,n.rows.push(c)):k[c]=1+f;d.gold+=e;E.log(Oa(h("Town","NotifySell").localized,a.name,e))});r.attach(this);var t,v;t=this.addButton(3,[m.B],h("Town","Buy"),function(){n.visible=!0;r.visible=!1;t.enabled=!1;v.enabled=!0});v=this.addButton(2,[m.S],h("Town","Sell"),function(){n.visible=!1;
r.visible=!0;t.enabled=!0;v.enabled=!1});this.addButton(1,ua,h("Town","Back"),function(){return g.goTo(H)});t.onClick()}x(b,a);b.prototype.onPortraitClick=function(a){E.log("TODO: Shop.onPortraitClick: "+a)};return b}(G),r=function(a){function b(c,e){var f=this;a.call(this,c);var g=c.warehouse,l=c.party,n=l[e],r=Ra(n,1280,720,!0);(new I(0,0,r.w,r.h,n)).attach(this);(new I(0,0,200,40,new C(n.name+" / Lv: "+n.level))).attach(this);(new I(0,40,200,40,new C("INT: "+n.INT))).attach(this);(new I(100,40,
200,40,new C("DEX: "+n.DEX))).attach(this);(new I(200,40,200,40,new C("STR: "+n.STR))).attach(this);(new I(0,80,200,40,new C(function(){return"HP: "+n.HP}))).attach(this);(new I(0,120,200,40,new C(function(){return"SP: "+n.SP}))).attach(this);(new I(0,160,200,40,new C(function(){return"WT: "+n.weight+"/"+n.maxWeight}))).attach(this);(new I(0,200,200,40,new C(function(){return"DEF: "+n.DEF.toFixed(1)}))).attach(this);var t=new S([new D(350,10,920,D.heightOf(10),d(h("Town","Equipments")),n.equipments,
function(a,b){n.equipments.splice(b,1);g.push(a)}),new D(350,360,920,D.heightOf(10),d(h("Town","Warehouse")),g,function(a,b){g.splice(b,1);var c=n.equipments,d=a.tagbits,e=[],d=d&Ub;if(0!==d)for(var f=0;f<c.length;)0!==(c[f].tagbits&d)?(e.push(c[f]),c.splice(f,1)):++f;n.equipments.push(a);(h=g.push).call.apply(h,[g].concat(e));var h})]);t.attach(this);var v=new S([new D(350,10,920,D.heightOf(10),k(h("Town","Skills")),n.skills,function(a,b){n.skills.splice(b,1);n.known.push(a)}),new D(350,360,920,
D.heightOf(10),k(h("Town","Knowns")),n.known,function(a,b){n.known.splice(b,1);n.skills.push(a)})]);v.attach(this);for(var u=l.length,x=function(a){var c=(e+u-a)%u;if(l[c])return E.addButton(5,Ob,h("Town","Prev"),function(){return T.go(f,new b(f.data,c))}),"break"},E=this,r=1;r<u&&"break"!==x(r);++r);for(var x=function(a){var c=(e+a)%u;if(l[c])return G.addButton(4,Pb,h("Town","Next"),function(){return T.go(f,new b(f.data,c))}),"break"},G=this,r=1;r<u&&"break"!==x(r);++r);var B,z;B=this.addButton(3,
[m.E],h("Town","Equipments"),function(){t.visible=!0;v.visible=!1;z.enabled=!0;B.enabled=!1});z=this.addButton(2,[m.S],h("Town","Skills"),function(){t.visible=!1;v.visible=!0;z.enabled=!1;B.enabled=!0});this.addButton(1,ua,h("Town","Back"),function(){return f.goTo(H)});B.onClick()}x(b,a);return b}(u)})(Ia||(Ia={}));var Ja;(function(a){function b(a,b){var p=a.xH;return{xH:p+[1,2,1,-1,-2,-1][b],yH:a.yH+(0===p%2?[-1,0,0,0,0,-1]:[0,0,1,1,0,0])[b]}}function d(a,b){var p=a.xH,q=b.xH,c=q-p,p=2*b.yH+q%2-
(2*a.yH+p%2);return 0>p?p>c?(-c-p)/2:p>-c?(c-p)/2:-p:p<c?(c+p)/2:p<-c?(-c+p)/2:p}function f(a,b){return a===b||!!a&&!!b&&a.xH===b.xH&&a.yH===b.yH}function c(a,b,p,q,c,d,e,f,g){var h=ga(0,1,d/e);d=null==f?h:ga(0,1,(d+f)/e);a.save();a.fillStyle=g.bkgnd;a.fillRect(b,p,q,c);b+=1;p+=1;q-=2;c-=2;d>h?(a.fillStyle=1<=h?g.full:g.normal,a.fillRect(b,p,q*h-1,c),a.fillStyle=g.full,a.fillRect(b+q*h,p,q*(d-h),c)):d<h?(e=q*d,0<d&&(e=W(e,2),a.fillStyle=1<=h?g.full:g.normal,a.fillRect(b,p,e-1,c)),a.fillStyle=g.delta,
a.fillRect(b+e,p,q*(h-d),c)):(a.fillStyle=1<=h?g.full:g.normal,a.fillRect(b,p,q*h,c));a.restore()}function k(a,b,p,q,d){b=p.toX(d)+16;p=p.toY(d)+60;c(a,b,p,96,6,q.HP,q.maxHP,void 0,hb)}function g(a,b,p,q,d,e){b=p.toX(d)+16;p=p.toY(d)+60+6;c(a,b,p,96,6,q.SP,q.maxSP,e-q.SP,Bb)}function D(a,b,p,q){a=p.tagbits;p=b.powerOf(p);b=b.level+b.getOffenceLevel(a)-q.level-q.getDefenceLevel(a);return Va(p*(100-q.DEF)/100*pa(V,b))}function J(a,b,p){var q=p.tagbits;p=b.powerOf(p);a=b.level+b.getOffenceLevel(q)-a.getLevel(q);
return Va(p*pa(V,a))}function U(a){var b=a.tagbits;return 0!==(b&1<<e.Fire)?{r:255,g:128,b:0}:0!==(b&1<<e.Cold)?{r:0,g:128,b:255}:0!==(b&1<<e.Lightning)?{r:255,g:255,b:0}:0!==(b&1<<e.Life)?a.hostile?{r:255,g:0,b:128}:{r:0,g:255,b:128}:{r:255,g:255,b:255}}function da(a,b,p){var q,c=d(b,p)+1;a.straight(b,p,c,function(b,p){p===c&&a.get(b).empty&&(q=b)});return q}function t(a,b,p,q){var c=b.hex,d=p.hex;p=b.estimate(a,p,q);var e=a.promiseEffect(p,d),c=new Ea(a,c,d);b.state=c;c.hit(function(){return e.attach(a)});
return n.wait.POPUP?ya([e,c]):c}function M(a,b,p,q){q=U(q);var c=Ta(q),d=Ta(q,0);q=a.toX(b)-a.toX(p);var e=a.toY(b)-a.toY(p);q=100+pa(q*q+e*e,.5)/1280*400;q=new H(q,function(q,e){var f=a.toX(b),g=a.toY(b),rb=a.toX(p),h=a.toY(p);ab(e,f*(1-q)+rb*q+64-20,g*(1-q)+h*q+40-20,40,40,c,d,.5)});q.attach(a);return q}function r(a,b,p,q,c,d){function e(q,c){var y=b.getTarget(f,q);y&&(y=b.estimate(a,y,p),d&&(null!=y.deltaHP&&(y.deltaHP=d(y.deltaHP,c)),null!=y.deltaHPoT&&(y.deltaHPoT=d(y.deltaHPoT,c)),null!=y.deltaSP&&
(y.deltaSP=d(y.deltaSP,c))),y=a.promiseEffect(y,q),y.attach(a),g.push(y))}var f=a.field,g=[];e(q,0);f.surround(q,c,e);var h=U(p),k=Ta(h,0),l=new H(400,function(b,p){var d=a.toX(q)+64,e=a.toY(q)+40,f=128*c*b,A=80*c*b,K=Ta(h,1-b);ab(p,d-f,e-A,2*f,2*A,K,k,b)});l.attach(a);return n.wait.POPUP?(g.push(l),ya(g)):l}var V=pa(2,.1),O=[{lineWidth:2,fillStyle:l(0,0,68),strokeStyle:l(204,204,255)},{lineWidth:2,fillStyle:l(68,0,0),strokeStyle:l(255,204,204)}],aa={fillStyle:"white",textAlign:"left",textBaseline:"top"},
R=u(0,0,0,0),Z=u(0,0,0,.75),na={inner:l(230,255,180),outer:l(51,230,51)},ha={inner:l(230,180,255),outer:l(51,51,230)},Da={inner:l(255,180,230),outer:l(230,51,51)},ta={inner:l(230,180,255),outer:l(51,51,230)},ia={outer:l(64,192,255),inner:l(180,232,255),bkgnd:u(64,192,255,.3)},ja={outer:l(255,192,64),inner:l(255,232,192),bkgnd:u(255,192,64,.3)},la={DASH_OR_RANGE:{outer:l(255,64,64),inner:l(255,180,180),bkgnd:u(255,192,64,.3)},RANGE:{outer:l(255,64,64),inner:l(255,180,180),bkgnd:u(255,128,64,.3)},TARGET:{outer:l(255,
24,24),inner:l(255,64,64),bkgnd:u(255,24,24,.3)}},oa={DASH_OR_RANGE:{outer:l(24,24,255),inner:l(180,180,255),bkgnd:u(255,192,64,.3)},RANGE:{outer:l(64,64,255),inner:l(180,180,255),bkgnd:u(24,128,255,.3)},TARGET:{outer:l(24,24,255),inner:l(64,64,255),bkgnd:u(24,24,255,.3)}},ua=u(0,0,0,.65),wa=u(0,0,0,0),za={textAlign:"center",textBaseline:"bottom",fontSize:32,fillStyle:"yellow",strokeStyle:"black",lineWidth:2},Ba={textAlign:"center",textBaseline:"bottom",fontSize:32,fillStyle:"red",strokeStyle:"black",
lineWidth:2},ma=u(255,0,0,.8),Ja=l(255,180,180),Na=l(180,255,180),Oa=[{messageID:"PartyTurn",innerStyle:l(0,0,128),outerStyle:u(0,0,128,0),textStyle:{fontSize:64,fillStyle:"white",textAlign:"center",textBaseline:"middle"}},{messageID:"EnemyTurn",innerStyle:l(128,0,0),outerStyle:u(128,0,0,0),textStyle:{fontSize:64,fillStyle:"white",textAlign:"center",textBaseline:"middle"}}],Wa=function(){function a(b,p){this.dummy=p;this.cells={};this.depth=v(b)}Object.defineProperty(a.prototype,"minXH",{get:function(){return 1+
Va(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxXH",{get:function(){return 20+v(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"minVisibleXH",{get:function(){return v(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxVisibleXH",{get:function(){return 21+Va(this.depth)},enumerable:!0,configurable:!0});a.prototype.contains=function(a,b){if(null==a)return!1;var q;null==b?(c=a,q=c.xH,b=c.yH,c):q=a;return 0<=
b&&3>b&&this.minXH<=q&&q<this.maxXH;var c};a.prototype.getLine=function(a){return this.cells[a]};a.prototype.setLine=function(a,b){this.cells[a]=b};a.prototype.deleteLine=function(a){delete this.cells[a]};a.prototype.rawget=function(a,b){var q;null==b?(c=a,q=c.xH,b=c.yH,c):q=a;if(0<=b&&3>b&&this.minVisibleXH<=q&&q<this.maxVisibleXH&&(q=this.cells[q]))return q[b];return;var c};a.prototype.get=function(a,b){var q;null==b?(c=a,q=c.xH,b=c.yH,c):q=a;q=this.rawget(q,b);return void 0===q?this.dummy:q;var c};
a.prototype.set=function(a,b,c){null==c&&(d=b,b=d.xH,c=d.yH,d);(d=this.cells[b])||(d=this.cells[b]=[]);d[c]=a;var d};a.prototype.each=function(a){for(var b=this.maxXH,c=this.minXH;c<b;++c)for(var d=0;3>d;++d)a(this.get(c,d),c,d)};a.prototype.eachVisible=function(a){for(var b=this.maxVisibleXH,c=this.minVisibleXH;c<b;++c)for(var d=0;3>d;++d)a(this.get(c,d),c,d)};a.prototype.straight=function(a,b,c,e){if(!f(a,b)){var K=a.xH,g=1+2*(2*a.yH+a.xH%2),h=b.xH,k=1+2*(2*b.yH+b.xH%2);a=d(a,b);h=(h-K)/a;k=(k-
g)/a;for(a=1;a<=c;++a){var w=K+a*h;b=v((g+a*k)/2);w=0===b%2?2*v((w+1)/2):2*v(w/2)+1;b=v(b/2);this.contains(w,b)&&e({xH:w,yH:b},a)}}};a.prototype.surround=function(a,p,c){if(1===p)for(var d=0;6>d;++d){var e=b(a,d);this.contains(e)&&c(e,1)}else if(1<p){a=b(a,0);for(var f=1;f<=p;++f){for(var e=a,g=0,h=[2,3,4,5,0,1];g<h.length;g++)for(var d=h[g],k=0;k<f;++k,e=b(e,d))this.contains(e)&&c(e,f);a=b(a,0)}}};return a}(),fa=function(){function a(b){this.duration=b}a.prototype.then=function(a){this.duration?
this.sig=ka(this.sig,a):G.then(a);return this};a.prototype.commit=function(){ca(this.sig);this.duration=this.sig=void 0};a.prototype.getXY=function(a,b,c){if(this.duration)if(c=H.clamp(c,this.start,this.duration),1<=c)this.commit();else return this.onGetXY(a,b,c)};a.prototype.drawCharacter=function(a,b,c,d,e,f,g){a.drawCharacter(b,c,d,e,f,g)};return a}(),Ca=function(a){function b(p){a.call(this,400*(13-p)/4)}x(b,a);b.prototype.onGetXY=function(a,b,c){a=a.hex;return{x:b.toX(a)-128*(1-c)+64,y:b.toY(a)+
80}};return b}(fa),La=function(a){function b(p){a.call(this,100*pa(p.length-1,.75));this.path=p}x(b,a);b.prototype.onGetXY=function(a,b,c){var d=this.path.length-1,e=v(d*c),f=this.path[e],g=this.path[e+1];a=b.toX(f);var f=b.toY(f),A=b.toX(g);b=b.toY(g);c=d*c-e;return{x:a*(1-c)+A*c+64,y:f*(1-c)+b*c+80}};return b}(fa),Ea=function(a){function b(c,q,d){a.call(this,function(a,b,c){var p=a.toX(b)-a.toX(c);a=a.toY(b)-a.toY(c);return 200+pa(p*p+a*a,.3)/1280*1E3}(c,q,d));this.hexFrom=q;this.hexTo=d}x(b,a);
b.prototype.hit=function(a){this.duration?this.hitsig=ka(this.hitsig,a):G.then(a)};b.prototype.commit=function(){ca(this.hitsig);this.hitsig=void 0;a.prototype.commit.call(this)};b.prototype.onGetXY=function(a,b,c){var d=this.hexFrom,e=this.hexTo;a=b.toX(d);var d=b.toY(d),f=b.toX(e);b=b.toY(e);.5>c?c*=2:(c=2-2*c,ca(this.hitsig),this.hitsig=void 0);return{x:a*(1-c)+f*c+64,y:d*(1-c)+b*c+80}};return b}(fa),Fa=function(a){function b(c,q){a.call(this,500);var d=c.HP;this.dying=q>=d?c.hex:void 0;this.radius=
q>=d/2?1:.5+q/d}x(b,a);b.prototype.onGetXY=function(a,b,c){var d=20*(1-c)*this.radius;c=c*Y*this.duration/250*this.radius;a=this.dying||a.hex;return{x:d*X(4*c)+b.toX(a)+64,y:d*X(3*c)+b.toY(a)+80}};b.prototype.drawCharacter=function(b,c,d,e,f,g,h){this.dying?(g=H.clamp(d,this.start,this.duration),c.save(),c.globalAlpha=1-g,a.prototype.drawCharacter.call(this,b,c,d,e,f,"red",g),c.restore()):a.prototype.drawCharacter.call(this,b,c,d,e,f,g,h)};return b}(fa),va=function(){function a(b,c,d){this.ch=b;this.team=
c;this._hex=d;this.idleOffset=Ya();this.skill=b.skills.find(function(a){return 0<b.rangeOf(a)})||ib.DUMMY;this.HP=this.maxHP;this.minCost=this.SP=this.availSP;c=0;for(d=b.skills;c<d.length;c++){var e=d[c];e.isActive&&(e=this.costOf(e))&&e<this.minCost&&(this.minCost=e)}this.effectsOverTime=[]}Object.defineProperty(a.prototype,"hex",{get:function(){return this._hex},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"alive",{get:function(){return!!this._hex},enumerable:!0,configurable:!0});
Object.defineProperty(a.prototype,"name",{get:function(){return this.ch.name},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"level",{get:function(){return this.ch.level},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"INT",{get:function(){return this.ch.INT},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEX",{get:function(){return this.ch.DEX},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"STR",{get:function(){return this.ch.STR},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxHP",{get:function(){return this.ch.HP},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxSP",{get:function(){return this.ch.SP},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"availSP",{get:function(){return W(0,this.ch.SP-this.ch.reservedSP)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"step",{get:function(){return this.ch.step},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"ZoC",{get:function(){return this.ch.ZoC},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){return this.ch.DEF},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"skills",{get:function(){return this.ch.skills},enumerable:!0,configurable:!0});a.prototype.costOf=function(a){return this.ch.costOf(a)};a.prototype.rangeOf=function(a){return this.ch.rangeOf(a)};a.prototype.powerOf=function(a){return this.ch.powerOf(a)};a.prototype.getPassive=function(a,
b){for(var c=0,d=0,e=this.ch.skills;d<e.length;d++){var f=e[d];f.isPassive&&f.action===b&&0!==(a&f.tagbits)&&(c+=f.rawPower)}return c};a.prototype.getOffenceLevel=function(a){return this.getPassive(a,"Offence")};a.prototype.getDefenceLevel=function(a){return this.getPassive(a,"Defence")};a.prototype.isEnemy=function(a){return!!a&&this.team!==a.team};a.prototype.isTarget=function(a,b){return a?1===b.usage?this===a:b.hostile?this.isEnemy(a):this!==a&&!this.isEnemy(a):!1};a.prototype.getTarget=function(a,
b){var c=a.get(b).unit;if(this.isTarget(c,this.skill))return c};a.prototype.done=function(a){var b=this._hex;return a.enabled&&!!b&&this.SP<this.minCost&&this.SP<this.step+a.zoc[this.team].get(b)};a.prototype.estimate=function(a,b,c){this.isTarget(b,c);var d=c.effect,e=fb[d];if(!e)throw new RangeError('Effect not found: "'+d+'"');return e(a,this,b,c)};a.prototype.shoot=function(a,b,c){this.isTarget(b,c);var d=this.costOf(c),e=c.action,f=gb[e];if(!f)throw new RangeError('Action not found: "'+e+'"');
a=f(a,this,b,c);this.SP-=d;return a};a.prototype.recuperate=function(){var a=v(.1*this.maxHP);this.HP=Q(this.maxHP,this.HP+a)};Object.defineProperty(a.prototype,"canRevive",{get:function(){return!this._hex&&.5<=this.HP/this.maxHP},enumerable:!0,configurable:!0});a.prototype.onTurnEnd=function(a){this.team===a.team&&(this.SP=this.availSP)};a.prototype.onTurnStart=function(a){if(this.team===a.team){for(var b=0,c=this.effectsOverTime,d=c.length-1;0<=d;--d){var e=c[d];null!=e.deltaHPoT&&(b+=e.deltaHPoT);
0>=--e.duration&&c.splice(d,1)}if(0!==b)return b=a.promiseEffect({target:this,deltaHP:b},this.hex),b.attach(a),b}};a.prototype.getXY=function(a,b){var c;this.state&&(c=this.state.getXY(this,a,b),c||(this.state=void 0));if(!c){var d=this._hex;d&&(c={x:a.toX(d)+64,y:a.toY(d)+80})}return c};Object.defineProperty(a.prototype,"state",{get:function(){return this._state},set:function(a){var b=this._state;if(this._state=a)a.start=performance.now();b&&b.commit()},enumerable:!0,configurable:!0});a.prototype.drawCharacter=
function(a,b,c,d,e,f){var g=this.ch,h=Ra(g,128,128),k=h.w,l=.2*k;ab(a,c-k/2,d-10-l/2,k,l,ua,wa,.75);b&&(k=200*(13-g.DEX),k=W(0,X(2*Y*(this.idleOffset+b%k/k))),d-=16*k+10*(1-k));h.x=c-h.w/2;h.y=d-h.h;g.draw(a,b,h,e,f)};a.prototype.draw=function(a,b,c,d,e,f){this.state?this.state.drawCharacter(this,a,b,c,d,e,f):this.drawCharacter(a,b,c,d,e,f)};a.prototype.drawBars=function(a,b,d,e,f){var g=this.hex;b=d.toX(g)+16;d=d.toY(g)+60;c(a,b,d,96,6,this.HP,this.maxHP,e,hb);c(a,b,d+6,96,6,this.SP,this.maxSP,f,
Bb)};a.compare=function(a,b){return a.y<b.y?-1:a.y>b.y?1:a.x<b.x?-1:a.x>b.x?1:0};return a}(),Ha=function(){function a(b,c){void 0===b&&(b=0);this.type=b;this.unit=c}Object.defineProperty(a.prototype,"empty",{get:function(){return null==this.unit&&0===this.type},enumerable:!0,configurable:!0});a.DUMMY=new a(1);return a}(),Pa=function(a){function c(d,e,g){function h(a){var b=this,c=e.hex,g=d.field,k=d.numScrollsPerTurn,y=this.get(a).SP,K=Xa.get(a),rb=nb(2*a.yH+a.xH%2-3),l=g.minXH+k,w=a.xH<l,A=function(c){var d=
b.get(c).SP;if(y>d)return!0;if(y<d)return!1;d=c.xH<l;if(!w&&d)return!0;if(w&&!d)return!1;d=Xa.get(c);return K<d?!0:K>d?!1:a.xH<c.xH?!0:a.xH>c.xH?!1:rb<nb(2*c.yH+c.xH%2-3)};g.surround(a,n,function(h){if(!f(h,c)){var k=b.ensure(h);k.shotFrom?A(k.shotFrom)&&(k.shotFrom=a):(k.shotFrom=a,h=g.get(h).unit,e.isTarget(h,L)&&(k.effect=e.estimate(d,h,L)))}})}var k=this,l=d.field;a.call(this,l.depth,c.DUMMY);var Xa=d.zoc[e.team],w=e.hex,N=e.step,L=e.skill,m=e.costOf(L),n=e.rangeOf(L)||0;this.ensure(w).SP=g;if(g>=
N+Xa.get(w))for(var Ka=[],r=w;r;r=Ka.shift()){var F=this.get(r).SP-(N+Xa.get(r));if(0<=F)for(var t=0;6>t;++t){var v=b(r,t),u=l.rawget(v);u&&0===u.type&&!e.isEnemy(u.unit)&&(u=this.ensure(v),u.SP<F||u.SP===F&&l.get(r).empty&&(!u.comeFrom||!l.get(u.comeFrom).empty))&&(u.SP=F,u.comeFrom=r,F>=N+Xa.get(v)&&Ka.push(v))}}g>=m&&1<=n&&(h.call(this,w),this.each(function(a,b,c){a.SP>=m&&l.get(b,c).empty&&h.call(k,{xH:b,yH:c})}))}x(c,a);c.prototype.ensure=function(a){var b=this.rawget(a);b||(b={SP:-1},this.set(b,
a));return b};c.prototype.getPath=function(a,b){var c=this.get(a);if(c){var d=c.comeFrom,e=c.shotFrom;if(c.effect&&e){if(!b.get(e).empty)return;c=[e];e=this.get(e);d=e.comeFrom;e}else if(d){if(!b.get(a).empty)return;c=[a]}else return;for(;d;)c.unshift(d),e=this.get(d),d=e.comeFrom,e;return c}};c.DUMMY={SP:-1};return c}(Wa),cb=function(a){function b(c,d,e,f,g,h){a.call(this,e,f,g,h,new C(function(){var a=c.focus;if(a){var b=a.skills[d];if(b){if(b.isActive){var e=a.skill===b,f=a.costOf(b),g=a.rangeOf(b)||
0,a=a.powerOf(b);return""+(e?"E ":"")+b.name.localized+"\n"+f+" / "+g+" / "+(null!=a?a.toFixed(1):"-")}return b.name.localized+"\n"+("Offence"===b.action?"ATK":"DEF")+": "+bb(b.tags)}}},{fontSize:20}),function(){if(this.enabled){var a=this.scene.focus,b=a.skills[this.index];1===b.usage?c.controller.dose(a,b):(a.skill=b,c.onSkillChanged(a))}},void 0,b.design);this.scene=c;this.index=d}x(b,a);Object.defineProperty(b.prototype,"visible",{get:function(){var a=this.scene.focus;return!!a&&!!a.skills[this.index]},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"enabled",{get:function(){var a=this.scene.focus;if(a){var b=a.skills[this.index];if(b)return 1===b.usage?a.SP>=a.costOf(b):0<a.rangeOf(b)}return!1},enumerable:!0,configurable:!0});b.design={draw:function(a,b,c){if(c.visible){var d=c.scene.focus;if(0<d.rangeOf(d.skills[c.index]))B.defaultDesign.draw(a,b,c);else{var e=B.defaultDesign.getStyle(c.state),f=d=void 0,g=void 0,h,k;null==d?(g=c,h=g.x,k=g.y,d=g.w,f=g.h,g,g=e):(h=c,k=e);if(0<
d&&0<f){a.save();$a(a,g);if(!g||g.strokeStyle)e=a.lineWidth-1,h+=e/2,k+=e/2,d-=e,f-=e;e=.2*Q(d,f);a.beginPath();a.moveTo(h+e,k);a.lineTo(h+d-e,k);a.quadraticCurveTo(h+d,k,h+d,k+e);a.lineTo(h+d,k+f-e);a.quadraticCurveTo(h+d,k+f,h+d-e,k+f);a.lineTo(h+e,k+f);a.quadraticCurveTo(h,k+f,h,k+f-e);a.lineTo(h,k+e);a.quadraticCurveTo(h,k,h+e,k);g&&!g.fillStyle||a.fill();g&&!g.strokeStyle||a.stroke();a.restore()}c.drawable&&c.drawable.draw(a,b,c)}}}};return b}(B),fa=function(){function a(b,c,d){void 0===d&&(d=
2);this.level=c;this.numScrollsPerTurn=d;b="assets/"+("level/"+b+"/");this.imgSky=new z(b+"sky.png");this.imgCells=[new z(b+"tile.png"),new z(b+"hole.png")]}a.prototype.generate=function(a,b){var c=0,d=0;a.eachUnit(function(a){0===a.team?++c:++d});for(var e=0===c?.3:.3*pa(1.1,c-d),f=Array(3),g=Qa(Cb),h=0;3>h;++h){var k=void 0,l=0;12<b&&Ya()<e?(k=g[Ma(g.length)],k=ba.monster(k,a.getLevel()),k=new va(k,1,{xH:b,yH:h})):6<b&&.1>Ya()&&(l=1);f[h]=new Ha(l,k)}return f};a.prototype.draw=function(a,b,c){var d=
this,e=c.field,f=this.imgSky.image;if(f){a.save();var g=128*e.depth/2;a.fillStyle=a.createPattern(f,"repeat");a.translate(-g,0);a.fillRect(0+g,0,1280,80);a.restore()}var h={x:0,y:0,w:128,h:80};e.eachVisible(function(e,f,g){e=e.type;h.x=c.toX(f,g);h.y=c.toY(f,g);d.imgCells[e].draw(a,b,h)})};return a}();a.EndressStage=fa;fa=function(a){function b(d,e){function f(a,b,d){return new B(10+110*b,570,100,140,{draw:function(a,b,e){var f=d.ch,p=Ra(f,e.w,e.h,!0);p.x=e.x+(e.w-p.w)/2;p.y=e.y+(e.h-p.h)/2;d.alive||
d.canRevive?f.draw(a,b,p):(f=f.images,(f[Ga.DEAD]||f[Ga.DEFAULT]).draw(a,b,p));c(a,e.x+10,e.y+128,80,6,d.HP,d.maxHP,void 0,hb)}},function(){if(d.alive)n.click(d.hex);else if(d.canRevive){for(var c=l.minXH,e=b%3,f=0;3>f;++f){if(l.get(c,e).empty){a.revive(d,{xH:c,yH:e});return}e=(e+1)%3}E.error(h("Combat","NoSpaceToRevive"))}else E.error(h("Combat","CannotRevive"))},[m.$1+b])}function g(a,b,c,d,e){b=new B(1280-150*b,570,140,140,new C(c),d);e&&xa(b,"enabled",e);b.attach(a);return b}var k=this;a.call(this);
this.data=d;this.stage=e;this.team=0;this.enabled=!1;var l=this.field=new Wa(0,Ha.DUMMY);this.dying=[];this.deads=[];this.snapshots=[];var n=new db;n.attach(this);n.visible=!1;var w=new eb;w.attach(this);w.visible=!1;for(var N=l.minVisibleXH,w=l.maxVisibleXH;N<w;++N)l.setLine(N,this.stage.generate(this,N));for(var L=[],Vb=[[2,0],[2,1],[2,2],[1,0],[1,1],[1,2]],A=d.party,w=0;6>w;++w){var Ka=A[w];if(Ka){var r=Vb[w],N=r[0],N={xH:N,yH:r[1]},r=new va(Ka,0,N);r.state=new Ca(Ka.DEX);l.rawget(N).unit=r;L.push(f(this,
w,r))}}var F=new S(L);xa(F,"visible",function(){return n.visible&&!k.focus});F.attach(this);g(F,1,h("Combat","End"),function(){return k.endTurn()});g(F,2,h("Combat","Undo"),function(){return n.undo()},function(){return n.canUndo});g(F,3,h("Combat","Retire"),function(){return k.retire()});var t=g(F,4,h("Combat","View")),w=new ea;w.onDraw=function(a,b){return k.drawUnits(a,b,k.focusTime)};w.attach(this);w=new ea;w.onDraw=function(a,b){return k.drawBarsOnView(a,b)};xa(w,"visible",function(){return F.visible&&
(t.hover||t.pressed)});w.attach(this);w=new S;xa(w,"visible",function(){return!!k.focus});w.attach(this);L=new ea;L.onDraw=function(a,b){return k.drawBarsOnFocus(a,b,k.focus,k.controller.caret)};L.attach(w);var u=new sa(0,560,1280,160);u.onDraw=function(a,b){return k.drawPanel(a,b,u,k.focus)};u.attach(w);L=new S;xa(L,"visible",function(){return n.visible&&!!k.focus});L.attach(this);for(w=0;6>w;++w)(new cb(this,w,400+170*v(w/2),570+w%2*75,160,65)).attach(L);var x=function(){var a=k.focus;if(a&&k.enabled){var a=
k.mapFor(a),b=k.controller.caret;if(b&&(a=a.get(b).effect))return a.target}},z=new sa(640,560,640,160);xa(z,"visible",function(){return!!x()});z.onDraw=function(a,b){return k.drawPanel(a,b,z,x())};z.attach(this);if(w=System.canvas.getContext("2d"))(new I(0,0,128,560,new mb({fillStyle:kb(w,0,0,128,0,Z,R)}))).attach(this),(new I(1152,0,1280,560,new mb({fillStyle:kb(w,1152,0,1280,0,R,Z)}))).attach(this);lb(this);this.startTurn()}x(b,a);Object.defineProperty(b.prototype,"controller",{get:function(){return this.children[this.team]},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"numScrollsPerTurn",{get:function(){return this.stage.numScrollsPerTurn},enumerable:!0,configurable:!0});b.prototype.getLevel=function(a){var b=this.stage;a=b.level;b=b.numScrollsPerTurn;0<b&&(a+=this.field.depth/b*.1);return a};Object.defineProperty(b.prototype,"focus",{get:function(){return this._focus},set:function(a){a?this._focus!==a&&(this._focus=a,this.focusTime=performance.now()):this.focusTime=this._focus=void 0},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"zoc",{get:function(){var a=this._zoc;if(!a){var a=this.field.depth,b=[new Wa(a,0),new Wa(a,0)];this.eachUnit(function(a){var c=a.ZoC;if(0<c){var d=b[0===a.team?1:0];d.surround(a.hex,1,function(a){return d.set(d.get(a)+c,a)})}});this._zoc=a=b}return a},enumerable:!0,configurable:!0});b.prototype.mapFor=function(a){var b=this.maps;b||(this.maps=b=new Wa(this.field.depth,void 0));var c=a.hex,d=b.rawget(c);d||(d=new Pa(this,a,a.SP),b.set(d,c));return d};
b.prototype.onSkillChanged=function(a){var b=a.hex,c=this.maps,d=this.snapshots;c&&c.set(void 0,b);if(d)for(b=0;b<d.length;b++)c=d[b],c.unit===a&&c.maps.set(void 0,c.hex)};b.prototype.savepoint=function(a){this.snapshots.push({unit:a,hex:a.hex,SP:a.SP,maps:this.maps,zoc:this.zoc})};b.prototype.rollback=function(){var a=this.snapshots.pop(),b=a.unit;this.setUnit(b,a.hex);b.SP=a.SP;this._zoc=a.zoc;this.maps=a.maps;this.focus=b};b.prototype.setUnit=function(a,b){var c=this.field,d=c.rawget(b),e=d.unit;
if(a){if(e===a)return;if(e=a._hex)c.rawget(e).unit=void 0;a._hex=b}else e&&(e._hex=void 0);d.unit=a;this.invalidate()};b.prototype.revive=function(a,b){var c=this.deads,d=c.indexOf(a);c.splice(d,1);a.SP=a.availSP;a.state=new Ca(a.DEX);this.setUnit(a,b);this.snapshots.length=0};b.prototype.invalidate=function(){this.maps=this._zoc=void 0};b.prototype.startTurn=function(){for(var a=this,b=this.team,c=0,d=this.deads;c<d.length;c++){var e=d[c];e.team===b&&e.recuperate()}var f;this.eachUnit(function(b){(b=
b.onTurnStart(a))&&(f?f.push(b):f=[b])});b=function(){a.enabled=!0;a.controller.visible=!0};f?ya(f).then(b):b()};b.prototype.retire=function(){var a=this;Ua.confirm(this,h("Combat","ConfirmRetire"),{label:h("Combat","Retire"),click:function(){a.controller.visible=!1;T.go(a,new Ia.Home(a.data))},mnemonic:pb},{label:h("Config","Cancel"),mnemonic:qb})};b.prototype.endTurn=function(){var a=this;this.enabled=!1;this.snapshots.length=0;this.controller.visible=!1;this.eachUnit(function(b){b.onTurnEnd(a)});
if(0===this.team){var b=this.numScrollsPerTurn;if(0<b){var c=this.field.minXH+b;this.eachUnit(function(b){b.hex.xH<c&&(b.state=new Fa(b,b.HP),a.kill(b))});var d=this.field.depth;(new H(400*b,function(c){a.scrollTo(d+b*c)})).attach(this);if(this.isGameOver)return}}this.team=0===this.team?1:0;var e=Oa[this.team],f=e.innerStyle,g=e.outerStyle,k=e.textStyle,l=h("Combat",e.messageID);(new H(800,function(a,b){b.save();b.globalAlpha=X(Y*a);ab(b,0,0,1280,560,f,g);Sa(b,l.localized,640,280,k);b.restore()})).then(function(){a.startTurn()}).attach(this)};
b.prototype.dose=function(a,b){var c=this;ra(a.SP>=a.costOf(b));this.focus=a;this.enabled=!1;this.snapshots.length=0;this.invalidate();return a.shoot(this,a,b).then(function(){c.enabled=!0;a.done(c)&&(c.focus=void 0)})};b.prototype.move=function(a,b){var c=this;ra(!f(b,a.hex));var d=function(){c.enabled=!0;a.done(c)&&(c.focus=void 0)};this.focus=a;var e=this.field,g=a.skill,h=this.mapFor(a),k=h.get(b);if(k.effect){ra(a.SP>=a.costOf(g));this.enabled=!1;var l=k.effect.target;ra(a.isTarget(l,g));var m=
function(){c.snapshots.length=0;c.invalidate();return a.shoot(c,l,g).then(d)};if(f(k.shotFrom,a.hex))return m();e=h.getPath(b,e);k=e[e.length-1];ra(!f(k,b));ra(!f(k,a.hex));this.setUnit(a,k);a.SP=h.get(k).SP;h=a.state=new La(e);m=jb(m);h.then(m);return m}ra(0<=k.SP&&e.get(b).empty);e=h.getPath(b,e);this.setUnit(a,b);a.SP=k.SP;h=a.state=new La(e);d();return n.wait.WALK?h:G};b.prototype.findUnit=function(a,b,c){var d=this.field,e=d.minXH,f=d.maxXH,g=(0===this.team?b:!b)?1:-1;b=b?1:-1;var h,k;a?(h=a.xH,
k=a.yH,a):(h=0>g?e:f-1,k=0>b?0:2);a=1;for(var l=3*(f-e+1);a<l;++a){k+=b;if(0>k||3<=k)k=0>k?2:0,h+=g,h<e?h=f-1:f<=h&&(h=e);var m=d.get(h,k).unit;if(m&&c(m))return m}};b.prototype.kill=function(a){var b=this;a.alive&&(a.HP=0,this.setUnit(void 0,a.hex),this.dying.push(a));0===a.team&&(this.deads.push(a),this.parent&&this.isGameOver&&(this.controller.visible=!1,(a.state||G).then(function(){Ua.confirm(b,h("Combat","GameOver"),{label:h("Combat","Retire"),click:function(){return T.go(b,new Ia.Home(b.data))},
mnemonic:ub})})))};Object.defineProperty(b.prototype,"isGameOver",{get:function(){return!this.findUnit(void 0,!0,function(a){return 0===a.team})},enumerable:!0,configurable:!0});b.prototype.createPopup=function(a,b,c){var d=this.toX(c)+64,e=this.toY(c)+80;return new H(600,function(c,f){return Sa(f,a,d,e-40*c,{fontSize:48,fillStyle:b,strokeStyle:"black",globalAlpha:X(Y*c),lineWidth:4,textAlign:"center",textBaseline:"bottom"})})};b.prototype.promiseEffect=function(a,b){var c=this,d=a.target,e=a.deltaHP||
0,f=nb(e).toString(),g=this.createPopup(f,0<e?Na:Ja,b),h=g.attach;g.attach=function(b){var f=a.deltaSP||0;if(0>e||0>f)d.state=new Fa(d,-e);d.HP=ga(0,d.maxHP,d.HP+e);0!==f&&(d.SP=ga(0,d.maxSP,d.SP+f));0>=d.HP?c.kill(d):(f=a.duration,null!=f&&d.effectsOverTime.push({duration:f,deltaHPoT:a.deltaHPoT}));return h.call(g,b)};return g};b.prototype.eachUnit=function(a){this.field.eachVisible(function(b){(b=b.unit)&&a(b)})};b.prototype.toX=function(a,b){var c;null==b?(d=a,c=d.xH,d):c=a;return 0+64*(c-1-this.field.depth);
var d};b.prototype.toY=function(a,b){var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;return 80+80*(2*b+c%2);var d};b.prototype.toHex=function(a,b){var c=this.field,d=a-0+128*c.depth/2,e=v((b-0-80)/80);if(0<=e&&6>e&&(d=0===e%2?2*v((d+64)/128):2*v(d/128)+1,c.minXH<=d&&d<c.maxXH))return c=v(e/2),{xH:d,yH:c}};b.prototype.scrollTo=function(a){var b=this.field;if(a>b.depth){var c=b.minVisibleXH,d=b.maxVisibleXH;b.depth=a;a=b.minVisibleXH;for(var e=b.maxVisibleXH;c<a;++c)b.deleteLine(c);for(c=W(a,d);c<e;++c)b.setLine(c,
this.stage.generate(this,c))}};b.prototype.onDraw=function(b,c){this.stage.draw(b,c,this);var d=this.focus;d&&this.enabled&&this.drawMarkers(b,c,this.focusTime,this.mapFor(d),d);a.prototype.onDraw.call(this,b,c)};b.prototype.drawMarkers=function(a,b,c,d,e){var f=this,g=H.clamp(b,c,300);if(!(0>=g)){var h=e.costOf(e.skill);b=e.skill.hostile?la:oa;var k=b.DASH_OR_RANGE,l=b.RANGE,m=b.TARGET;a.save();1>g&&(a.globalAlpha=g);d.eachVisible(function(b,c,d){var e=b.SP,q=b.shotFrom,y,K=0,n=0;b.effect?(y=m,K=
32*(1-g),n=20*(1-g)):e>=h?y=ia:0<=e?y=q?k:ja:q&&(y=l);y&&(b=f.toX(c,d)-K,c=f.toY(c,d)-n,K=128+2*K,n=80+2*n,a.fillStyle=y.bkgnd,a.fillRect(b+5,c+5,K-10,n-10),a.strokeStyle=y.outer,a.lineWidth=2,a.strokeRect(b+2,c+2,K-4,n-4),a.strokeStyle=y.inner,a.lineWidth=1,a.strokeRect(b+4,c+4,K-8,n-8))});a.restore()}};b.prototype.drawUnits=function(a,b,c){var d=this,e=this.focus,f=this.enabled?this.zoc:void 0,g=[];this.eachUnit(function(a){var c=a.getXY(d,b);c.unit=a;g.push(c)});for(var k=0;k<this.dying.length;){var l=
this.dying[k],m=l.getXY(this,b);m?(m.unit=l,g.push(m),++k):this.dying.splice(k,1)}g.sort(va.compare);k=h("Combat","Done").localized;c=(1-qa(2*Y*H.cycle(b,c,1E3)))/2*.5;var m="blue",n;e&&(e.skill.hostile&&(m="red"),this.enabled&&(n=this.mapFor(e)));for(var A=0;A<g.length;A++){var P=g[A],l=P.unit,r=P.x,P=P.y,F=void 0;n&&(e===l?F="yellow":l.alive&&n.get(l.hex).effect&&(F=m));l.draw(a,b,r,P,F,c);if(!l.state&&f&&l.alive){var F=l.SP,t=l.step,u=l.team;F<l.minCost&&(F<t?Sa(a,k,r,P,za):F<t+f[u].get(l.hex)&&
Sa(a,k,r,P,Ba))}}};b.prototype.drawBarsOnView=function(a,b){var c=this;this.eachUnit(function(d){return d.drawBars(a,b,c)})};b.prototype.drawBarsOnFocus=function(a,b,c,d){var e=this;if(c&&this.enabled){var h=this.mapFor(c),l=this.field;h.each(function(c){(c=c.effect)&&c.target.drawBars(a,b,e,c.deltaHP,c.deltaSP)});if(d){var m=h.get(d);m.effect?(d=m.shotFrom,l=c.costOf(c.skill),f(d,c.hex)?c.drawBars(a,b,this,void 0,-l):(k(a,b,this,c,c.hex),g(a,b,this,c,d,h.get(d).SP-l))):0<m.SP&&l.get(d).empty?(k(a,
b,this,c,c.hex),g(a,b,this,c,d,m.SP)):c.drawBars(a,b,this)}else c.drawBars(a,b,this)}};b.prototype.drawPanel=function(a,b,c,d){if(d){Aa(a,c,O[d.team]);var e=d.ch,f=Ra(e,128,128);f.x=c.x+10+(128-f.w)/2;f.y=c.y+(c.h-f.h)/2;e.draw(a,b,f);b=d.costOf(d.skill);b=d.SP>=b?v((d.SP-b)/d.step):"-";var e=d.powerOf(d.skill),f=d.name+" / Lv: ",g;g=d.level;g=null!=g?g.toFixed(1):"-";Sa(a,f+g+"\n"+("HP: "+d.HP+" / "+d.maxHP+"\n")+("SP: "+d.SP+" / "+d.maxSP+"\n")+("MOVE: "+b+"/"+v(d.SP/d.step)+"\n")+("ATK/DEF: "+
(null!=e?e.toFixed(1):"-")+" / "+d.DEF.toFixed(1)),c.x+148,c.y+10,aa)}};return b}(S);a.Scene=fa;var db=function(a){function c(){a.apply(this,arguments);this.mode=0}x(c,a);Object.defineProperty(c.prototype,"caret",{get:function(){return this._caret},set:function(a){this._caret=a;if(0===this.mode){var b=this.parent;b.focus=a?b.field.get(a).unit:void 0}},enumerable:!0,configurable:!0});c.prototype.finish=function(a){var b=this,c=this.parent,d=function(){c.focus||(b.mode=0)};c.enabled?d():a.then(d)};
c.prototype.dose=function(a,b){var c=this.parent;this.mode=1;this.finish(c.dose(a,b))};Object.defineProperty(c.prototype,"canUndo",{get:function(){return 0<this.parent.snapshots.length||1<=this.mode},enumerable:!0,configurable:!0});c.prototype.undo=function(){var a=this.parent,b=a.snapshots,c=b.length,b=0<c?b[c-1].unit:void 0;1<=this.mode&&b!==a.focus?this.mode=0:b?a.rollback():E.error(h("Combat","CannotUndo"));this.caret=this._caret};c.prototype.onHover=function(a,b){this.caret=this.parent.toHex(a,
b)};c.prototype.onDrag=function(a,b){this.caret=this.parent.toHex(a,b)};c.prototype.downCaret=function(a){if(this.caret=a){var b=this.parent,c=this.mode,d=b.focus;if(d){if(d.team===b.team&&!d.done(b)){1===c&&f(a,d.hex)?this.mode=3:this.mode=2;return}}else if(a=b.field.get(a).unit,b.focus=a){this.mode=2;return}this.mode=0}};c.prototype.onDown=function(a,b){this.downCaret(this.parent.toHex(a,b))};c.prototype.upCaret=function(a){if(this.caret=a){var b=this.parent,c=this.mode;if(b.enabled&&!(2>c)){var d=
b.focus;if(d&&b.team===d.team)if(f(a,d.hex))this.mode=2===c?1:0;else{c=b.mapFor(d).get(a);if(!c.effect)if(0<=c.SP&&b.field.get(a).empty)b.savepoint(d);else{b.focus=void 0;this.mode=0;return}this.mode=1;this.finish(b.move(d,a))}else this.mode=0}}};c.prototype.onUp=function(a,b){this.upCaret(this.parent.toHex(a,b))};c.prototype.onPress=function(a){function c(a){var d=this.parent.field,e=this.caret;e?(a=b(e,a),d.contains(a)&&(this.caret=a)):this.caret={xH:d.minXH,yH:0}}function d(a){var b=this.parent,
c=this.caret,e=b.team,f=b.focus;(a=b.findUnit(f?f.hex:c,a,function(a){return a.team===e&&!a.done(b)}))?(b.focus=a,c||(this.caret=a.hex),0===this.mode&&(this.mode=1)):E.error(h("Combat","UnitNotAvailable"))}switch(a){case m.BACKSPACE:case m.TAB:case m.DELETE:case m.Q:this.undo();break;case m.PAGE_DOWN:case m.C:d.call(this,!0);break;case m.PAGE_UP:d.call(this,!1);break;case m.SPACE:case m.ENTER:this.click(this.caret);break;case m.E:c.call(this,0);break;case m.RIGHT:case m.D:c.call(this,1);break;case m.DOWN:case m.X:case m.S:c.call(this,
2);break;case m.Z:c.call(this,3);break;case m.LEFT:case m.A:c.call(this,4);break;case m.UP:case m.W:c.call(this,5)}};c.prototype.click=function(a){a&&this.parent.field.contains(a)&&(this.downCaret(a),this.upCaret(a))};c.prototype.onDraw=function(a,b){function c(a,b,d,e,f){b=d.toX(e)+6.5;d=d.toY(e)+6.5;a.save();a.lineCap="round";a.lineJoin="round";a.beginPath();a.moveTo(b+32,d);a.lineTo(b,d);a.lineTo(b,d+20);a.moveTo(b+115-32,d);a.lineTo(b+115,d);a.lineTo(b+115,d+20);a.moveTo(b+115-32,d+67);a.lineTo(b+
115,d+67);a.lineTo(b+115,d+67-20);a.moveTo(b+32,d+67);a.lineTo(b,d+67);a.lineTo(b,d+67-20);a.lineWidth=7;a.strokeStyle=f.outer;a.stroke();a.lineWidth=3;a.strokeStyle=f.inner;a.stroke();a.restore()}function d(a,b,c){a.save();a.lineCap="butt";a.lineJoin="round";var e=c[c.length-2],f=c[c.length-1],g=b.toX(e)+64,k=b.toY(e)+40,e=b.toX(f)+64,f=b.toY(f)+40,g=wb(f-k,e-g);a.beginPath();a.moveTo(e+20*qa(g),f+20*X(g));a.lineTo(e+20*qa(g+2*Y/3),f+20*X(g+2*Y/3));a.lineTo(e+20*qa(g-2*Y/3),f+20*X(g-2*Y/3));a.fillStyle=
ma;a.fill();a.beginPath();a.moveTo(e-10*qa(g),f-10*X(g));for(g=c.length-2;0<=g;--g)e=c[g],a.lineTo(b.toX(e)+64,b.toY(e)+40);a.strokeStyle=ma;a.lineWidth=12;a.stroke();a.restore()}var e=this.caret;if(e){var f=this.parent,g=f.focus,h=f.field;if(0===this.mode)c(a,b,f,e,na);else if(g&&f.enabled){var k=f.mapFor(g),l=k.getPath(e,h);l&&2<=l.length&&d(a,f,l);k=k.get(e);if(k.effect)switch(l=g.skill,l.usage){case 2:c(a,b,f,e,Da);break;case 3:c(a,b,f,e,ta);break;case 4:h.straight(k.shotFrom,e,g.rangeOf(l),function(d){return c(a,
b,f,d,Da)});break;case 5:h.straight(k.shotFrom,e,g.rangeOf(l),function(d){return c(a,b,f,d,ta)});break;case 6:h.surround(k.shotFrom,g.rangeOf(l),function(d){return c(a,b,f,d,Da)});break;case 7:h.surround(k.shotFrom,g.rangeOf(l),function(d){return c(a,b,f,d,ta)})}else 0<=k.SP?c(a,b,f,e,ha):c(a,b,f,e,na)}}};return c}(ea),eb=function(a){function b(){a.apply(this,arguments);this.running=!1}x(b,a);Object.defineProperty(b.prototype,"visible",{get:function(){return this.running},set:function(a){var b=this;
(this.running=a)&&G.then(function(){return b.run([])})},enumerable:!0,configurable:!0});b.prototype.dose=function(a,b){throw Error("not implemented");};b.prototype.run=function(a){function b(a,c){var d=a.focus;if(d)return d;var e=a.team,d=c.length,d=0<d?a.findUnit(c[d-1].hex,!1,function(b){return b.team===e&&!b.done(a)&&0>c.indexOf(b)}):a.findUnit(void 0,!1,function(b){return b.team===e&&!b.done(a)});return a.focus=d}function c(a,b,e){var g=a.mapFor(b),k=d(a,b,g),h=k.hex;if(!g.get(h).effect&&b.SP>=
b.availSP){var l=new Pa(a,b,999),h=d(a,b,l,k).hex,k=l.get(h);k.effect&&(h=k.shotFrom);for(var k=a.field,p=h;p&&(0>g.get(p).SP||!k.get(p).empty);)p=l.get(p).comeFrom;h=p?p:b.hex}if(f(h,b.hex))e.push(b),a.focus=void 0;else return e.length=0,this.caret=h,e=n.wait.PICK,0<e?(g=jb(function(){return a.move(b,h)}),(new H(e)).then(g).attach(a),g):a.move(b,h)}function d(a,b,c,f){var g=a.field,h=a.numScrollsPerTurn,k=g.minXH,l=g.maxXH,p=b.hex,q=b.maxSP,m=b.costOf(b.skill)||q,n=k+h,P=f?f:{hex:p,score:e(b,p.xH,
p.yH,k,l,n)+40*b.SP/q};c.each(function(d,f,h){var p=d.SP,r=d.effect;d=d.shotFrom;var A;if(r&&d){p=A=e(b,d.xH,d.yH,k,l,n);A=r.target;var y;y=A.ch;for(var t=0,u=0,v=y.skills;u<v.length;u++){var w=v[u];0<y.rangeOf(w)&&(t=w.hostile?D(a,A,w,b)/b.HP:J(a,A,w)/A.maxHP,t=W(t,t))}y=Q(1,t);r=r.deltaHP||0;r=0>r?-r:Q(r,A.maxHP-A.HP);r=Q(1,r/A.HP);A=p+1E3*y*r;p=c.get(d).SP-m}else if(0<=p&&g.get(f,h).empty)A=e(b,f,h,k,l,n);else return;A+=40*p/q;P.score<A&&(P.score=A,P.hex={xH:f,yH:h})});return P}function e(a,b,
c,d,f,g){var h=0,h=1===a.team?h+10*(f-b):h+10*(b-d);a=2*c+b%2;h=3>a?h+10*a:h+10*(5-a);b<g&&(h*=.1);return h}for(var g=this,k=this.parent,h;this.running;){k.enabled||(h=G);if(h){h.then(function(){return g.run(a)});break}this.caret=void 0;h=b(k,a);if(!h){k.endTurn();break}h=c.call(this,k,h,a)}};return b}(ea),fb={Damage:function(a,b,c,d){return{target:c,deltaHP:-D(a,b,d,c)}},DamageHPandSP:function(a,b,c,d){a=-D(a,b,d,c);return{target:c,deltaHP:a,deltaSP:v(a/2)}},DamageOverTime:function(a,b,c,d){a=-D(a,
b,d,c);return{target:c,deltaHP:a,duration:2,deltaHPoT:v(a/2)}},Heal:function(a,b,c,d){return{target:c,deltaHP:J(a,b,d)}},HealOverTime:function(a,b,c,d){a=J(a,b,d);return{target:c,deltaHP:a,duration:2,deltaHPoT:Va(a/2)}}},gb={Charge:t,Knockback:function(a,b,c,d){var e=b.hex,f=c.hex,g=da(a.field,e,f);if(!g)return t(a,b,c,d);d=b.estimate(a,c,d);var h=a.promiseEffect(d,g),e=new Ea(a,e,f),k=new La([f,g]);b.state=e;e.hit(function(){a.setUnit(c,g);c.state=k});k.then(function(){return h.attach(a)});return n.wait.POPUP?
ya([h,e]):e},GoBehind:function(a,b,c,d){var e=b.hex,f=c.hex,g=da(a.field,e,f);if(!g)return t(a,b,c,d);c=b.estimate(a,c,d);var h=a.promiseEffect(c,f),e=new La([e,f]);a.setUnit(b,g);b.state=e;e.then(function(){return h.attach(a)});return n.wait.POPUP?h:e},Trample:function(a,b,c,d){var e=b.hex,f=c.hex,g=da(a.field,e,f);if(!g)return t(a,b,c,d);d=b.estimate(a,c,d);var h=a.promiseEffect(d,g),e=new La([e,f]);d=new La([f,f,g]);a.setUnit(c,g);c.state=d;a.setUnit(b,f);b.state=e;d.then(function(){return h.attach(a)});
return n.wait.POPUP?h:d},Shoot:function(a,b,c,d){var e=b.hex,f=c.hex;b=b.estimate(a,c,d);var g=a.promiseEffect(b,f);d=M(a,e,f,d);d.then(function(){return g.attach(a)});return n.wait.POPUP?g:d},Drain:function(a,b,c,d){var e=c.hex,f=b.hex,g=b.estimate(a,c,d);c=a.promiseEffect(g,e);var h=a.promiseEffect({target:b,deltaHP:-g.deltaHP},f);b=M(a,e,f,d);b.then(function(){return h.attach(a)});c.attach(a);return n.wait.POPUP?h:b},Explode:function(a,b,c,d){var e=c.hex;c=M(a,b.hex,e,d);var f=jb(function(){return r(a,
b,d,e,1,function(a,b){return v(a/(1+b))})});c.then(f);return f},Laser:function(a,b,c,d){var e=a.field,f=b.rangeOf(d)||0,g=b.hex,h,k=[];e.straight(g,c.hex,f,function(c){var f=b.getTarget(e,c);f&&(f=b.estimate(a,f,d),f=a.promiseEffect(f,c),f.attach(a),k.push(f));h=c});var l=U(d);c=new H(400,function(b,c){var d=a.toX(g)+64,e=a.toY(g)+40,f=a.toX(h)+64,k=a.toY(h)+40,m=wb(k-e,f-d),p=64*qa(m),m=40*X(m);c.save();c.beginPath();c.moveTo(d+p,e+m);c.lineTo(f+p,k+m);c.lineCap="round";c.lineWidth=80*b/4;c.strokeStyle=
Ta(l,1-b);c.stroke();c.restore()});c.attach(a);return n.wait.POPUP?(k.push(c),ya(k)):c},Nova:function(a,b,c,d){return r(a,b,d,b.hex,b.rangeOf(d)||0)},Dose:function(a,b,c,d){b=b.estimate(a,c,d);c=a.promiseEffect(b,c.hex);c.attach(a);return n.wait.POPUP?c:G}}})(Ja||(Ja={}));var Ca;n=new (function(){function a(){this._refineCanvas=this._magnifyCanvas=!1;this.volume=new Ab(50,0,100);this.effects=new Ab(Fa.length-1,0,Fa.length-1)}Object.defineProperty(a.prototype,"magnifyCanvas",{get:function(){return this._magnifyCanvas},
set:function(a){this._magnifyCanvas!==a&&(this._magnifyCanvas=a,window.dispatchEvent(new CustomEvent("resize")))},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"refineCanvas",{get:function(){return this._refineCanvas},set:function(a){this._refineCanvas!==a&&(this._refineCanvas=a,window.dispatchEvent(new CustomEvent("resize")))},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"wait",{get:function(){return Fa[this.effects.value]},enumerable:!0,configurable:!0});
return a}());System.main=function(a,b){var d=new Image;d.src="assets/dummy.png";z.DUMMY=d;var d=new S,e=new S;e.attach(d);var c=new Nb(10,10,1260,700,2E3,Kb);c.attach(d);E=c;Ca=function(){for(;;){var a=e.children,b=a.length;if(0===b)break;a[b-1].detach()}(new yb(new Ha.Scene)).attach(e)};Jb();Ca();Fb(a,d,n);System.checkpoint=function(){vb()}}})();
