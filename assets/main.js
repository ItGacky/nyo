(function(){function ca(b,a,c){return c<b?b:c>a?a:c}function da(b,a){return null!=b?b:a}function Ba(b){return u(Oa()*b)}function ma(b){return null==b?[]:b.map(function(a){return null!=a?a.toJSON():null})}function S(b,a){return null==a?[]:a.map(function(c){return null!=c?b.fromJSON(c):null})}function Ca(b){return void 0===b?"(undefined)":null===b?"(null)":b.toString()}function Da(b){for(var a=[],c=1;c<arguments.length;c++)a[c-1]=arguments[c];return b.replace(/\$\{(\d+)\}/g,function(c,b){var f=parseInt(b,
10);return Ca(a[f])})}function jb(b,a,c){return Object.defineProperty(b,a,{enumerable:!0,configurable:!0,writable:!0,value:c})}function na(b,a,c,h){return Object.defineProperty(b,a,{enumerable:!0,configurable:!0,get:c,set:h})}function Bb(b,a){var c=document.createElement("script");c.src=b;c.onerror=a;document.head.appendChild(c)}function oa(b,a){if(b===a)return 0;if(void 0===b&&void 0!==a)return-1;if(void 0!==b&&void 0===a)return 1;if(null===b&&null!==a)return-1;if(null!==b&&null===a)return 1;var c=
typeof b,h=typeof a;if(c!==h)return c<h?-1:1;if("object"===c){if(b instanceof Date&&a instanceof Date)return oa(b.getTime(),a.getTime());if(b instanceof Array&&a instanceof Array){a:{for(var c=b.length,h=a.length,d=0,f=T(c,h);d<f;++d){var g=oa(b[d],a[d]);if(0!==g){c=g;break a}}c=c<h?-1:c>h?1:0}return c}if(b.consructor===Object&&a.constructor===Object){a:{for(var c=Ea(b).sort(),h=Ea(a).sort(),d=c.length,f=h.length,g=T(d,f),w=0;w<g;++w){var e=c[w],ea=h[w];if(e<ea||e>ea){c=-1;break a}e=oa(b[e],a[ea]);
if(0!==e){c=e;break a}}c=d<f?-1:d>f?1:0}return c}throw new TypeError("Cannot compare: ("+b+") and ("+a+")");}return b<a?-1:b>a?1:0}function pa(b,a){if(null==b)return a;if("function"===typeof b)return[b,a];b.push(a);return b}function qa(b){if(null!=b)if("function"===typeof b)L.then(b);else for(var a=0;a<b.length;a++)L.then(b[a])}function Ya(b){var a=function(){b().then(function(){qa(a.sig);a.sig=void 0})};a.then=function(c){this.sig=pa(this.sig,c);return this};return a}function e(){for(var b=[],a=
0;a<arguments.length;a++)b[a-0]=arguments[a];return new E(b)}function Cb(b,a,c){function h(c){return(null==c.pageX?c.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-b.offsetLeft:c.pageX-b.offsetLeft)*w/b.offsetWidth}function d(c){return(null==c.pageY?c.clientY+document.body.scrollTop+document.documentElement.scrollTop-b.offsetTop:c.pageY-b.offsetTop)*e/b.offsetHeight}function f(){null!=F&&clearTimeout(F);F=setTimeout(function(){F=void 0;var a=b.parentElement,h=a.clientWidth,a=
a.clientHeight,a=a-b.offsetTop;0<a&&(c.magnifyCanvas||(h=T(h,w),a=T(a,e)),h*e>w*a?h=ra(a*w/e):a=ra(h*e/w),0<h&&0<a&&(b.style.width=h+"px",b.style.height=a+"px",!c.refineCanvas&&(h>w||a>e)&&(h=w,a=e),b.width!=h||b.width!=h))&&(b.width=h,b.height=a)},300)}function g(c){L.finish();var h=b.width,d=b.height,f=b.getContext("2d");f.clearRect(0,0,h,d);f.save();f.font="24px Arial";h===w&&d===e||f.scale(h/w,d/e);a.onDraw(f,c);f.restore();window.requestAnimationFrame(g)}var w=b.width,e=b.height,ea=window.navigator.pointerEnabled,
l=window.navigator.msPointerEnabled,m=null!=document.ontouchstart,Pa=ea?"pointerdown":l?"MSPointerDown":m?"touchstart":"mousedown",Q=ea?"pointerup":l?"MSPointerUp":m?"touchend":"mouseup";b.addEventListener(ea?"pointermove":l?"MSPointerMove":m?"touchmove":"mousemove",function(c){if(c.buttons&1)a.onDrag(h(c),d(c));else a.onHover(h(c),d(c));c.preventDefault()});b.addEventListener(Pa,function(c){switch(c.button){case 0:a.onDown(h(c),d(c))}c.preventDefault()});b.addEventListener(Q,function(c){switch(c.button){case 0:a.onUp(h(c),
d(c));break;case 2:a.onPress(k.TAB)}c.preventDefault()});b.addEventListener("contextmenu",function(c){c.preventDefault()});b.addEventListener("mousewheel",function(c){a.onPress(0<c.wheelDelta?k.PAGE_UP:k.PAGE_DOWN);c.preventDefault()});window.addEventListener("keydown",function(c){if(!c.ctrlKey&&!c.altKey){var b=da(c.keyCode,c.charCode);b&&k[b]&&(a.onPress(b),c.preventDefault())}});var F;window.addEventListener("resize",f);"complete"===document.readyState?f():window.addEventListener("load",f);window.requestAnimationFrame(g)}
function Fa(b,a,c,h){void 0===h&&(h=!1);var d=b.w,f=b.h;return d>a||f>c||h?(b=d/a,h=f/c,b>h?(d=a,f/=b):(d/=h,f=c),{w:d,h:f}):b}function sa(b,a){if(a)for(var c in a)switch(c){case "fontSize":b.font=a.fontSize+"px "+(a.fontFamily||"Arial");break;case "fontFamily":null==a.fontSize&&(b.font="24px "+a.fontFamily);break;default:b[c]=a[c]}}function fa(b,a,c,h,d,f){var g;null==h?(f=a,a=f.x,g=f.y,h=f.w,d=f.h,f,f=c):g=c;0<h&&0<d&&(b.save(),sa(b,f),f&&!f.fillStyle||b.fillRect(a,g,h,d),f&&!f.strokeStyle||b.strokeRect(a,
g,h,d),b.restore())}function Qa(b,a,c,h,d){function f(c,a,b,h,d){d&&!d.strokeStyle||c.strokeText(a,b,h);d&&!d.fillStyle||c.fillText(a,b,h)}b.save();sa(b,d);if(0>a.indexOf("\n"))f(b,a,c,h,d);else{var g=a.split("\n");a=d&&d.fontSize||24;switch(b.textBaseline){case "top":for(var e=0;e<g.length;e++){var r=g[e];f(b,r,c,h,d);h+=a}break;case "middle":h-=a*(g.length-1)/2;for(e=0;e<g.length;e++)r=g[e],f(b,r,c,h,d),h+=a;break;case "bottom":for(e=0,g=g.reverse();e<g.length;e++)r=g[e],f(b,r,c,h,d),h-=a}}b.restore()}
function ga(b,a,c,h,d,f,g){b.save();sa(b,g);switch(b.textAlign){case "center":c+=d/2;break;case "right":c+=d;break}if(0>a.indexOf("\n")){switch(b.textBaseline){case "middle":h+=f/2;break;case "bottom":h+=f;break}g&&!g.strokeStyle||b.strokeText(a,c,h,d);g&&!g.fillStyle||b.fillText(a,c,h,d)}else{a=a.split("\n");var e=g&&g.fontSize||24;switch(b.textBaseline){case "middle":h+=(f-e*(a.length-1))/2;break;case "bottom":h=h+f-e*(a.length-1);break}for(f=0;f<a.length;f++){var r=b,k=a[f],l=c,m=h,Pa=d,Q=g;Q&&
!Q.strokeStyle||r.strokeText(k,l,m,Pa);Q&&!Q.fillStyle||r.fillText(k,l,m,Pa);h+=e}}b.restore()}function ta(b,a,c,h,d,f,g){if(0<h&&0<d){b.save();var e=b.createLinearGradient(a,c,a,c+d);e.addColorStop(0,f);e.addColorStop(1,g);b.fillStyle=e;b.fillRect(a,c,h,d);b.restore()}}function Ra(b,a,c,h,d,f,g,e){void 0===e&&(e=0);0<h&&0<d&&(b.save(),b.translate(a+h/2,c+d/2),b.scale(h,d),a=b.createRadialGradient(0,0,e/2,0,0,.5),a.addColorStop(0,f),a.addColorStop(1,g),b.fillStyle=a,b.fillRect(-.5,-.5,1,1),b.restore())}
function l(b,a,c){return"rgb("+b+","+a+","+c+")"}function m(b,a,c,h){return"rgba("+b+","+a+","+c+","+h.toFixed(6).replace(/([0-9]+(\.[0-9]+[1-9])?)(\.?0+$)/,"$1")+")"}function ua(b){null==ha&&(ha=[e("Tag","Melee"),e("Tag","Throw"),e("Tag","Shoot"),e("Tag","Shield"),e("Tag","Head"),e("Tag","Body"),e("Tag","Arms"),e("Tag","Legs"),e("Tag","Slash"),e("Tag","Blunt"),e("Tag","Pierce"),e("Tag","Magic"),e("Tag","Alchemy")]);return b.map(function(a){return ha[a].localized}).join(", ")}function va(b){for(var a=
0,c=0;c<b.length;c++)a|=1<<b[c];return a}function mb(b,a){0>b.indexOf("/")&&(b="assets/char/"+b);return b.endsWith(".png")?new N(b):new Db(b,a)}function Za(b){var a={fillStyle:"white",strokeStyle:"black",fontSize:44,textAlign:"center",textBaseline:"middle"},c={textAlign:"right",textBaseline:"middle"},h={textAlign:"right",textBaseline:"middle"},d=new G(4,4,32,32,new N("assets/config.png"),function(){function d(a,b){var h=100+70*a;(new C(640,h,160,60,new y(b,c))).attach(r);return h}function g(c,a,b){c=
d(c,a);a=new Eb(810,c+15,300,30,b);a.attach(r);(new C(1120,c,50,60,new y(b,h))).attach(r);return a}function w(c,a,b,h,g,e){c=d(c,a);var w=new G(810,c+0,100,60,new y(function(){var c=g();w.pressed&&w.hover&&(c=!c);return(c?b:h).localized}),e);w.attach(r);return w}var r=new Ga;(new C(0,0,1280,720,new $a(nb))).attach(r);(new C(0,20,1280,80,new y(e("Config","Caption"),a))).attach(r);(new G(480,495,320,90,new y(e("Config","OK")),function(){r.detach()},ob)).attach(r);var k=Ea(E.languages).sort().map(function(c){return e("Language",
c)}),l=new z(10,10,160,z.heightOf(T(10,k.length)),[{name:e("Config","LanguageID"),extract:function(c){return c.src[1]},width:40,align:"center"},{name:e("Config","LanguageName"),extract:function(c){return c.localized}}],k,function(c){l.selected=c;E.language=c.src[1]});l.selected=l.rows.find(function(c){return c.src[1]===E.language});l.attach(r);g(0,e("Config","Volume"),n.volume);g(1,e("Config","CPUEffects"),n.effects);var k=e("Config","On"),m=e("Config","Off");w(2,e("Config","FullScreen"),k,m,function(){return System.getFullScreen()},
function(){System.setFullScreenn(!System.getFullScreen())});w(3,e("Config","MagnifyCanvas"),k,m,function(){return n.magnifyCanvas},function(){n.magnifyCanvas=!n.magnifyCanvas});w(4,e("Config","RefineCanvas"),k,m,function(){return n.refineCanvas},function(){n.refineCanvas=!n.refineCanvas});(function(c,a,b){c=new G(810,70*c+100,300,60,new y(a),b);c.attach(r);return c})(5,e("Config","BackToTitle"),function(){r.detach();Ha()});r.attach(b)},Fb,new G.IconDesign("white"));d.attach(b);return d}function pb(){try{var b=
System.getRoamingStorage("NYO");if(!b)return null;var a=qb(b);return{shop:a.shop,warehouse:S(ia,a.warehouse),reservers:S(X,a.reservers),party:S(X,a.party),gold:a.gold}}catch(c){return D.error(c),null}}function rb(b){try{System.setRoamingStorage("NYO",sb(b))}catch(a){D.error(a)}tb()}function Gb(){try{var b=System.getLocalStorage("NYO");if(b){var a=qb(b);a&&(typeof a.language===typeof E.language&&(E.language=a.language),typeof a.magnifyCanvas===typeof n.magnifyCanvas&&(n.magnifyCanvas=a.magnifyCanvas),
typeof a.refineCanvas===typeof n.refineCanvas&&(n.refineCanvas=a.refineCanvas),typeof a.volume===typeof n.volume.value&&(n.volume.value=a.volume),typeof a.effects===typeof n.effects.value&&(n.effects.value=a.effects))}}catch(c){D.error(c)}}function tb(){try{System.setLocalStorage("NYO",sb({language:E.language,magnifyCanvas:n.magnifyCanvas,refineCanvas:n.refineCanvas,volume:n.volume.value,effects:n.effects.value}))}catch(b){D.error(b)}}var t=this&&this.__extends||function(b,a){function c(){this.constructor=
b}for(var h in a)a.hasOwnProperty(h)&&(b[h]=a[h]);b.prototype=null===a?Object.create(a):(c.prototype=a.prototype,new c)},Ea=Object.keys,ab=Math.abs,T=Math.min,R=Math.max,u=Math.floor,bb=Math.ceil,ra=Math.round,Sa=Math.pow,U=Math.sin,ja=Math.cos,ub=Math.atan2,V=Math.PI,Oa=Math.random,qb=JSON.parse,sb=JSON.stringify,Ta=function(){},L={sig:null,then:function(b){this.sig=pa(this.sig,b);return this},finish:function(){var b=this.sig;if(b)if(this.sig=null,"function"===typeof b)b();else for(var a=0;a<b.length;a++)(0,b[a])()}},
Ua=function(){function b(a){for(var c=this,b=a.length,d=0;d<a.length;d++)a[d].then(function(){0>=--b&&(qa(c.sig),c.sig=void 0)})}b.prototype.then=function(a){this.sig=pa(this.sig,a);return this};return b}(),E=function(){function b(a){this.src=a}Object.defineProperty(b.prototype,"localized",{get:function(){function a(c){var a=b.languages,f=b.language,g=a[f];null==g&&(f=b.language=b.fallback,g=a[f]);if("string"===typeof g)return a[f]=!0,Bb(g,function(){a[f]=!1}),null;if(!0===g)return null;if(!1===g)return c.join(".");
for(var e=g,g=0,r=c.length;g<r;++g)if(e=e[c[g]],null==e)return c.join(".");return e.toString()}if(this._language!==b.language){var c=a(this.src);if(null===c)return this.src.join(".");this._language=b.language;this._localized=c}return this._localized},enumerable:!0,configurable:!0});b.prototype.toString=function(){return this.localized};b.language=(window.navigator.userLanguage||window.navigator.language||window.navigator.browserLanguage).substr(0,2);b.fallback="en";b.languages={};return b}();System.localize=
function(b,a){E.languages[b]=a};var k;(function(b){b[b.TAB=9]="TAB";b[b.ENTER=13]="ENTER";b[b.ESCAPE=27]="ESCAPE";b[b.SPACE=32]="SPACE";b[b.PAGE_UP=33]="PAGE_UP";b[b.PAGE_DOWN=34]="PAGE_DOWN";b[b._END=35]="_END";b[b._HOME=36]="_HOME";b[b.LEFT=37]="LEFT";b[b.UP=38]="UP";b[b.RIGHT=39]="RIGHT";b[b.DOWN=40]="DOWN";b[b._INSERT=45]="_INSERT";b[b.DELETE=46]="DELETE";b[b.$0=48]="$0";b[b.$1=49]="$1";b[b.$2=50]="$2";b[b.$3=51]="$3";b[b.$4=52]="$4";b[b.$5=53]="$5";b[b.$6=54]="$6";b[b.$7=55]="$7";b[b.$8=56]=
"$8";b[b.$9=57]="$9";b[b.A=65]="A";b[b.B=66]="B";b[b.C=67]="C";b[b.D=68]="D";b[b.E=69]="E";b[b.F=70]="F";b[b.G=71]="G";b[b.H=72]="H";b[b.I=73]="I";b[b.J=74]="J";b[b.K=75]="K";b[b.L=76]="L";b[b.M=77]="M";b[b.N=78]="N";b[b.O=79]="O";b[b.P=80]="P";b[b.Q=81]="Q";b[b.R=82]="R";b[b.S=83]="S";b[b.T=84]="T";b[b.U=85]="U";b[b.V=86]="V";b[b.W=87]="W";b[b.X=88]="X";b[b.Y=89]="Y";b[b.Z=90]="Z"})(k||(k={}));var Z=function(){function b(){}b.prototype.onHover=function(a,c){};b.prototype.onDrag=function(a,c){};b.prototype.onDown=
function(a,c){};b.prototype.onUp=function(a,c){};b.prototype.onPress=function(a){};b.prototype.onDraw=function(a,c){};b.prototype.attach=function(a){if(a)return a.onAttach(this);throw new RangeError("Cannot attach to null");};b.prototype.detach=function(){var a=this.parent;return a?(a.onDetach(this),a):null};Object.defineProperty(b.prototype,"visible",{get:function(){return!0},set:function(a){jb(this,"visible",a)},enumerable:!0,configurable:!0});return b}(),O=function(b){function a(c){b.call(this);
this.children=[];if(c)for(var a=0;a<c.length;a++)c[a].attach(this)}t(a,b);a.prototype.onAttach=function(c){if(null==c.parent)return this.children.push(c),c.parent=this,!0;if(c.parent===this)return!1;throw new RangeError("Cannot add Component with another parent");};a.prototype.onDetach=function(c){if(c.parent===this){c.parent=null;for(var a=this.children,b=0;b<a.length;++b)if(a[b]===c){c=this.children;a=c.length;if(0>b||a<=b)throw new RangeError("index is out of range");for(var f=Array(a-1),g=0;g<
b;++g)f[g]=c[g];for(g=b+1;g<a;++g)f[g-1]=c[g];this.children=f;break}return!0}if(null==c.parent)return!1;throw new RangeError("Cannot remove Component with another parent");};a.prototype.onHover=function(c,a){for(var b=0,f=this.children;b<f.length;b++){var g=f[b];if(g.visible)g.onHover(c,a)}};a.prototype.onDrag=function(c,a){for(var b=0,f=this.children;b<f.length;b++){var g=f[b];if(g.visible)g.onDrag(c,a)}};a.prototype.onDown=function(c,a){for(var b=0,f=this.children;b<f.length;b++){var g=f[b];if(g.visible)g.onDown(c,
a)}};a.prototype.onUp=function(c,a){for(var b=0,f=this.children;b<f.length;b++){var g=f[b];if(g.visible)g.onUp(c,a)}};a.prototype.onPress=function(c){for(var a=0,b=this.children;a<b.length;a++){var f=b[a];if(f.visible)f.onPress(c)}};a.prototype.onDraw=function(c,a){for(var b=0,f=this.children;b<f.length;b++){var g=f[b];if(g.visible)g.onDraw(c,a)}};return a}(Z),$a=function(){function b(a){this.rectStyle=a}b.prototype.draw=function(a,c,b){fa(a,b,this.rectStyle)};return b}(),y=function(){function b(a,
c,b){this.value=a;this.textStyle=c;this.rectStyle=b;null==this.textStyle&&(this.textStyle={});this.textStyle.fillStyle||(this.textStyle.fillStyle="white");this.textStyle.textAlign||(this.textStyle.textAlign="center");this.textStyle.textBaseline||(this.textStyle.textBaseline="middle")}b.prototype.draw=function(a,c,b){c=b.x;var d=b.y,f=b.w;b=b.h;this.rectStyle&&fa(a,c,d,f,b,this.rectStyle);ga(a,this.text,c,d,f,b,this.textStyle)};Object.defineProperty(b.prototype,"text",{get:function(){var a=this.value;
"function"===typeof a&&(a=a());return Ca(a)},enumerable:!0,configurable:!0});return b}(),N=function(){function b(a){this.src=a;this._image=void 0}Object.defineProperty(b.prototype,"image",{get:function(){var a=this;if(void 0===this._image){this._image=null;var c=new Image;c.addEventListener("load",function(){a._image=c});c.addEventListener("error",function(){a._image=b.DUMMY});c.src=this.src}return this._image},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"w",{get:function(){var a=
this.image;return a?a.width:1},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"h",{get:function(){var a=this.image;return a?a.height:1},enumerable:!0,configurable:!0});b.prototype.draw=function(a,c,b,d,f){c=this.image;var g=b.x,e=b.y,r=b.w;b=b.h;c&&0<r&&0<b&&(a.save(),!d||0>=f?a.drawImage(c,g,e,r,b):(a.globalCompositeOperation="destination-out",a.drawImage(c,g,e,r,b),a.globalCompositeOperation="destination-over",a.fillStyle=d,a.fillRect(g,e,r,b),1>f&&(a.globalCompositeOperation=
"source-over",a.globalAlpha=1-f,a.drawImage(c,g,e,r,b))),a.restore())};b.prototype.createPattern=function(b,c){var h=this.image;return h?b.createPattern(h,c):m(0,0,0,0)};b.DUMMY=null;return b}(),D,Hb={fontSize:32,fillStyle:"white",strokeStyle:"black",textAlign:"left",textBaseline:"top",lineWidth:2},nb={fillStyle:m(0,0,0,.8)},Ib={fillStyle:"white",strokeStyle:"black",fontSize:44,textAlign:"center",textBaseline:"middle"},B=function(b){function a(c,a){b.call(this);this.duration=c;a&&(this.onAnimation=
a)}t(a,b);a.prototype.attach=function(c){return b.prototype.attach.call(this,c)?(this.start=performance.now(),!0):!1};a.prototype.detach=function(){this.start=null;return b.prototype.detach.call(this)};a.prototype.onDraw=function(c,b){if(null!=this.start)if(b>=this.start+this.duration)this.onAnimation(1,c,b),this.detach(),qa(this.sig),this.sig=void 0;else if(b>=this.start)this.onAnimation((b-this.start)/this.duration,c,b)};a.prototype.onAnimation=function(c,b,a){};a.prototype.then=function(c){this.sig=
pa(this.sig,c);return this};a.clamp=function(c,b,a){return null==b||c<b?0:null==a||b+a<c?1:(c-b)/a};a.cycle=function(c,b,a){return null==b||null==a||c<b?0:(c-b)%a/a};return a}(Z),vb=function(b){function a(c,a){void 0===a&&(a=400);b.call(this,a);this.next=c}t(a,b);a.prototype.onAnimation=function(c,b,a){if(1>c){if(0<c)this.next.onDraw(b,a);b.save();b.globalAlpha=1-c;b.fillStyle="black";b.fillRect(0,0,1280,720);b.restore()}else this.next.attach(this.parent)};return a}(B),aa=function(b){function a(c,
a,d){void 0===d&&(d=400);b.call(this,d);this.prev=c;this.next=a}t(a,b);a.prototype.attach=function(c){return b.prototype.attach.call(this,c)?(this.prev.detach(),!0):!1};a.prototype.onAnimation=function(b,a,d){1>b?(this.prev.onDraw(a,d),0<b&&(a.save(),a.globalAlpha=b,a.fillStyle="black",a.fillRect(0,0,1280,720),a.restore())):this.next&&(new vb(this.next,this.duration)).attach(this.parent)};return a}(B),Ga=function(b){function a(){b.apply(this,arguments)}t(a,b);a.prototype.attach=function(a){return null==
this.prev&&null!=a.parent&&b.prototype.attach.call(this,a.parent)?(a.detach(),this.prev=a,!0):!1};a.prototype.detach=function(){var a=b.prototype.detach.call(this);a&&this.prev.attach(a);return a};a.prototype.onDraw=function(a,h){this.prev.onDraw(a,h);b.prototype.onDraw.call(this,a,h)};a.confirm=function(b,h){for(var d=[],f=2;f<arguments.length;f++)d[f-2]=arguments[f];var g=new a;(new C(0,0,1280,720,new y(h,Ib,nb))).attach(g);for(var f=d.length,e=1280/(3+d.length),r=e/8,k=(1280-e*f-r*(f-1))/2,l=function(a){var b=
d[a],c=b.click,h=b.mnemonic;(new G(k+(e+r)*a,495,e,90,new y(b.label),c?function(){g.detach();c()}:function(){g.detach()},h)).attach(g)},m=0;m<f;++m)l(m);g.attach(b);return g};return a}(O),ka=function(b){function a(a,h,d,f){b.call(this);this.x=a;this.y=h;this.w=d;this.h=f}t(a,b);a.prototype.contains=function(a,b){return this.visible&&this.x<=a&&this.y<=b&&a<this.x+this.w&&b<this.y+this.h};Object.defineProperty(a.prototype,"left",{get:function(){return this.x},set:function(a){this.w=this.w+this.x-a;
this.x=a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"right",{get:function(){return this.x+this.w},set:function(a){this.w=a-this.x},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"top",{get:function(){return this.y},set:function(a){this.h=this.h+this.y-a;this.y=a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"bottom",{get:function(){return this.y+this.h},set:function(a){this.h=a-this.y},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"center",{get:function(){return{x:this.x+this.w/2,y:this.y+this.h/2}},enumerable:!0,configurable:!0});a.prototype.moveTo=function(a,b){this.x=a;this.y=b;return this};a.prototype.moveBy=function(a,b){this.x+=a;this.y+=b;return this};return a}(Z),C=function(b){function a(a,h,d,f,g){b.call(this,a,h,d,f);this.drawable=g}t(a,b);a.prototype.onDraw=function(a,b){this.drawable.draw(a,b,this)};return a}(ka),G=function(b){function a(c,h,d,f,g,e,r,k){void 0===k&&(k=a.defaultDesign);b.call(this,c,h,d,f);this.drawable=
g;this.click=e;this.mnemonic=r;this.design=k;this.hover=!1}t(a,b);Object.defineProperty(a.prototype,"enabled",{get:function(){return!0},set:function(a){jb(this,"enabled",a)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"state",{get:function(){return this.enabled?this.pressed?2:this.hover?1:0:3},enumerable:!0,configurable:!0});a.prototype.onHover=function(a,b){this.hover=this.contains(a,b);this.pressed=null};a.prototype.onDrag=function(a,b){null!=this.pressed&&(this.pressed=this.contains(a,
b))};a.prototype.onDown=function(a,b){this.enabled&&this.contains(a,b)&&(this.pressed=!0)};a.prototype.onUp=function(a,b){var d=this.pressed;this.pressed=null;if(d&&this.contains(a,b))this.onClick()};a.prototype.onPress=function(a){this.mnemonic&&0<=this.mnemonic.indexOf(a)&&this.enabled&&(this.pressed=!1,this.onClick())};a.prototype.onClick=function(){var a=this;this.click&&L.then(function(){return a.click()})};a.prototype.onDraw=function(a,b){this.design.draw(a,b,this)};a.defaultDesign={draw:function(a,
b,d){a.save();switch(d.state){case 0:a.fillStyle=m(0,0,0,.8);a.strokeStyle=l(200,200,200);break;case 1:a.fillStyle=m(0,0,50,.8);a.strokeStyle=l(100,100,200);break;case 2:a.fillStyle=m(0,0,150,.8);a.strokeStyle=l(100,100,255);break;case 3:a.fillStyle=m(200,200,200,.8),a.strokeStyle=l(200,200,200)}a.fillRect(d.x,d.y,d.w,d.h);a.strokeRect(d.x,d.y,d.w,d.h);a.restore();d.drawable&&d.drawable.draw(a,b,d)}};a.IconDesign=function(){function a(b){this.overlay=b}a.prototype.draw=function(a,b,c){var g=c.drawable;
switch(c.state){case 0:g.draw(a,b,c);break;case 1:g.draw(a,b,c,this.overlay,.7);break;case 2:g.draw(a,b,c,this.overlay,.9);break;case 3:g.draw(a,b,c,l(200,200,200),.8)}};return a}();return a}(ka),wb=function(b){function a(a,h,d,f,g,e,r,k,l,m){void 0===m&&(m=G.defaultDesign);b.call(this,a,h,d,f,e,r,l,m);this.group=g;this.swap=k;g.push(this)}t(a,b);a.prototype.onDrag=function(a,h){var d=this;b.prototype.onDrag.call(this,a,h);if(this.dragged&&!this.swapping){var f=this.group.find(function(b){return b!==
d&&b.contains(a,h)&&!b.swapping});if(f){var g=performance.now();this.onSwap(f,g);f.onSwap(this,g);this.dragged={xOrig:this.swapping.xTo,yOrig:this.swapping.yTo};this.swap&&this.swap(f)}else null!=this.dragged.xDown?(this.x=this.dragged.xOrig-this.dragged.xDown+a,this.y=this.dragged.yOrig-this.dragged.yDown+h):(this.dragged.xDown=a,this.dragged.yDown=h)}};a.prototype.onDown=function(a,h){b.prototype.onDown.call(this,a,h);!this.dragged&&this.contains(a,h)&&(this.dragged={xDown:a,yDown:h,xOrig:this.x,
yOrig:this.y})};a.prototype.onUp=function(a,h){if(this.swapping)this.dragged=null,b.prototype.onUp.call(this,a,h);else if(this.dragged){var d=this.dragged,f=d.xOrig,d=d.yOrig;this.swapping={start:performance.now(),xFrom:this.x,yFrom:this.y,xTo:f,yTo:d};this.dragged=null;if(this.pressed&&(this.pressed=!1,this.contains(a,h)&&f<=a&&d<=h&&a<f+this.w&&h<d+this.h))this.onClick()}else b.prototype.onUp.call(this,a,h)};a.prototype.onSwap=function(a,b){this.pressed=!1;this.swapping={start:b,xFrom:this.x,yFrom:this.y,
xTo:a.dragged?a.dragged.xOrig:a.x,yTo:a.dragged?a.dragged.yOrig:a.y}};a.prototype.onDraw=function(a,h){if(this.swapping){var d=B.clamp(h,this.swapping.start,200);1>d?(d=(1-ja(V*d))/2,this.x=this.swapping.xFrom*(1-d)+this.swapping.xTo*d,this.y=this.swapping.yFrom*(1-d)+this.swapping.yTo*d):(this.x=this.swapping.xTo,this.y=this.swapping.yTo,this.swapping=null)}b.prototype.onDraw.call(this,a,h)};return a}(G),z=function(b){function a(c,h,d,f,g,e,k,l){void 0===l&&(l=a.defaultDesign);b.call(this,c,h,d,
f);this.columns=g;this.rows=e;this.click=k;this.design=l;this.topRow=0}t(a,b);a.heightOf=function(b,h){void 0===h&&(h=a.defaultDesign);return h.headerHeight+b*h.rowHeight};a.prototype.onHover=function(a,b){this.hover=this.toRowIndex(a,b);this.scrolling=this.dragged=null};a.prototype.onDrag=function(a,b){var d=this.design.headerHeight;null!=this.scrolling?this.scrollTo(u(this.rows.length*(b-(this.y+d)-this.scrolling)/(this.h-d))):(d=this.toRowIndex(a,b),null!=d&&null!=this.dragged&&d!==this.dragged&&
(f=[this.rows[d],this.rows[this.dragged]],this.rows[this.dragged]=f[0],this.rows[d]=f[1],this.dragged=d,this.sortkeys=this.scrolling=this.hover=null));var f};a.prototype.onDown=function(a,b){if(this.contains(a,b)&&(this.hover=this.dragged=this.toRowIndex(a,b),null==this.dragged)){var d=this.design,f=d.headerHeight,g=this.w-d.scrollBarWidth,d=this.y+f;if(this.x<=a&&a<this.x+g&&this.y<=b&&b<d)d=this.toColumnIndex(a,b),null!=d&&this.sort(d,null!=this.sortkeys&&this.sortkeys[0]===d+1);else if(this.x+
g<=a&&a<this.right){var g=this.rows.length,e=this.displayCount,f=this.h-f,k=d+f*this.topRow/g,l=f*e/g;d<=b&&b<k?(this.scrollTo(u(g*(b-d)/f)),k=d+f*this.topRow/g):k+l<=b&&b<this.bottom&&(this.scrollTo(u(g*(b-d)/f)-e+1),k=d+f*this.topRow/g);k<=b&&b<k+l&&(this.scrolling=b-k)}}};a.prototype.onUp=function(a,b){null==this.scrolling&&null!=this.dragged&&this.dragged===this.hover&&(this.click(this.rows[this.dragged],this.dragged),this.refresh());this.scrolling=this.dragged=null;this.hover=this.toRowIndex(a,
b)};a.prototype.onPress=function(a){switch(a){case k.PAGE_DOWN:this.scrollBy(this.scrollStep);break;case k.PAGE_UP:this.scrollBy(-this.scrollStep)}};a.prototype.onDraw=function(a,b){var d=this.design,f=d.headerHeight,g=d.scrollBarWidth,e=this.rows.length,k=this.displayCount,l=this.x,m=this.y+f,n=this.w-g,u=this.h-f,t=this.x+n,F=(0<e&&u*this.topRow/e||0)+m,I=0<e&&u*k/e||u,kb=this.defaultColumnWidth;d.drawHeader(a,this.x,this.y,this.w,f);d.drawBackground(a,this.x,m,n,u);0<g&&(d.drawHeader(a,t,m,g,u),
k<e&&d.drawScrollBar(a,t,F,g,I));a.save();a.font=d.rowFont;a.fillStyle=d.rowStyle;a.textBaseline="middle";for(var I=d.rowHeight,M=0;M<k;++M){var g=M+this.topRow,lb=this.rows[g],wa=m+I*M;g===this.dragged?d.drawRowDragged(a,this.x,wa,n,I):lb===this.selected?d.drawRowSelected(a,this.x,wa,n,I):g===this.hover&&null==this.dragged&&d.drawRowHover(a,this.x,wa,n,I);for(var cb=0,g=0,e=this.columns.length;g<e;++g){var t=this.columns[g],F=da(t.width,kb),xb=this.extract(lb,t);if(null!=xb){var la=l+cb+2,Ia=F-4;
a.textAlign=t.align||"left";switch(a.textAlign){case "center":la+=Ia/2;break;case "right":la+=Ia}a.fillText(xb,la,wa+I/2,Ia)}cb+=F}}a.restore();a.save();I=0;a.font=d.headerFont;a.fillStyle=d.headerStyle;a.textAlign="center";a.textBaseline="middle";a.strokeStyle=d.lineStyle;g=0;for(e=this.columns.length;g<e;++g)t=this.columns[g],F=da(t.width,kb),M=l+I,0<g&&(a.beginPath(),a.moveTo(M,m),a.lineTo(M,this.bottom),a.stroke()),a.fillText(t.name.localized,M+F/2,this.y+f/2),I+=F;a.restore();0===k&&0<u&&d.emptyText&&
(a.save(),a.font=d.emptyFont,a.textAlign="center",a.textBaseline="middle",a.fillStyle=d.emptyStyle,a.fillText(d.emptyText.localized,this.x+n/2,m+u/2),a.restore())};Object.defineProperty(a.prototype,"displayCount",{get:function(){var a=this.design;return T(u((this.h-a.headerHeight)/a.rowHeight),this.rows.length)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"scrollStep",{get:function(){return R(u(.2*this.displayCount),1)},enumerable:!0,configurable:!0});a.prototype.extract=function(a,
b){var d=b.extract;switch(typeof d){case "function":return d(a);case "number":return a[d];default:return a[d]}};a.prototype.compare=function(a,b){for(var d=0,f=0,g=this.sortkeys.length;0===d&&f<g;++f){var e=this.sortkeys[f],d=this.columns[(0<e?e:-e)-1],d=d.compare?d.compare(a,b):oa(this.extract(a,d),this.extract(b,d));0>e&&(d=-d)}return d};a.prototype.sort=function(a,b){var d=this;void 0===b&&(b=!1);var f=a+1;if(this.sortkeys){for(var g=0,e=this.sortkeys.length;g<e;++g)if(this.sortkeys[g]===f||this.sortkeys[g]===
-f){this.sortkeys.splice(g,1);break}this.sortkeys.unshift(b?-f:f)}else this.sortkeys=[b?-f:f];this.rows.sort(function(a,b){return d.compare(a,b)})};a.prototype.toRowIndex=function(a,b){var d=this.design,f=this.w-d.scrollBarWidth;return this.x<=a&&a<this.x+f&&(d=this.topRow+u((b-this.y-d.headerHeight)/d.rowHeight),this.topRow<=d&&d<this.rows.length)?d:null};a.prototype.toColumnIndex=function(a,b){var d=this.w-this.design.scrollBarWidth;if(this.x<=a&&a<this.x+d)for(var d=this.defaultColumnWidth,f=this.x,
g=0,e=this.columns.length;g<e;++g){var k=da(this.columns[g].width,d);if(f<=a&&a<f+k)return g;f+=k}return null};Object.defineProperty(a.prototype,"defaultColumnWidth",{get:function(){for(var a=this.w-this.design.scrollBarWidth,b=0,d=0,f=0,g=this.columns;f<g.length;f++){var e=g[f];null!=e.width?b+=e.width:++d}return 0<d&&b<a?(a-b)/d:0},enumerable:!0,configurable:!0});a.prototype.refresh=function(){var a=this.rows.length;this.dragged>=a&&(this.dragged=null);this.hover>=a&&(this.hover=null);this.scrollTo(this.topRow)};
a.prototype.scrollTo=function(a){this.topRow=ca(0,this.rows.length-this.displayCount,a)};a.prototype.scrollBy=function(a){this.scrollTo(this.topRow+a)};a.defaultDesign={rowHeight:28,rowFont:"20px Arial",rowStyle:"white",headerHeight:24,headerFont:"18px Arial",headerStyle:"white",scrollBarWidth:14,lineStyle:l(102,102,102),drawHeader:function(a,b,d,f,g){a.save();a.fillStyle=m(25,25,25,.8);a.fillRect(b,d,f,g);a.restore()},drawBackground:function(a,b,d,f,g){a.save();a.fillStyle=m(0,0,0,.6);a.fillRect(b,
d,f,g);a.restore()},drawScrollBar:function(a,b,d,f,g){ta(a,b,d,f,g,l(100,100,100),l(75,75,75))},drawRowDragged:function(a,b,d,f,g){ta(a,b,d,f,g,l(255,0,0),l(50,0,0))},drawRowSelected:function(a,b,d,f,g){ta(a,b,d,f,g,l(100,0,0),l(50,0,0))},drawRowHover:function(a,b,d,f,g){ta(a,b,d,f,g,l(75,0,0),l(50,0,0))}};return a}(ka),yb=function(){function b(a,b,h){this.min=b;this.max=h;this.value=a}Object.defineProperty(b.prototype,"value",{get:function(){return this._value},set:function(a){this._value=ca(this.min,
this.max,ra(a))},enumerable:!0,configurable:!0});b.prototype.toString=function(){return this._value.toString()};b.prototype.valueOf=function(){return this._value};return b}(),Eb=function(b){function a(c,h,d,f,g,e){void 0===e&&(e=a.defaultDesign);b.call(this,c,h,d,f);this.value=g;this.design=e;this.hover=this.dragged=!1}t(a,b);a.prototype.getValueAsX=function(){var a=this.design.knobWidth,b=this.value,d=b.min;return this.x+a/2+(b.value-d)/(b.max-d)*(this.w-a)};a.prototype.setValueByX=function(a){var b=
this.design.knobWidth;a=ca(0,1,(a-this.x-b/2)/(this.w-b));var b=this.value,d=b.min;this.value.value=ra(d+a*(b.max-d))};a.prototype.onHover=function(a,b){this.hover=this.contains(a,b);this.dragged=!1};a.prototype.onDrag=function(a,b){this.hover=this.dragged&&this.contains(a,b);this.dragged&&this.setValueByX(a)};a.prototype.onDown=function(a,b){this.contains(a,b)&&(this.dragged=!0,this.setValueByX(a))};a.prototype.onUp=function(a,b){this.dragged=!1};a.prototype.onDraw=function(a,b){this.design.draw(a,
b,this)};Object.defineProperty(a.prototype,"knob",{get:function(){var a=this.design.knobWidth,b=this.h;return{x:this.getValueAsX()-a/2,y:this.y-(this.h-b)/2,w:a,h:b,state:this.dragged?2:this.hover?1:0}},enumerable:!0,configurable:!0});a.defaultDesign={knobWidth:12,draw:function(a,b,d){fa(a,d,{fillStyle:m(50,50,50,.8),strokeStyle:"white",lineWidth:4});b=d.knob;d={strokeStyle:"white",lineWidth:4};switch(b.state){case 0:d.fillStyle=m(150,150,150,.8);break;case 1:d.fillStyle=m(200,200,200,.8);break;case 2:d.fillStyle=
m(255,255,255,.8)}fa(a,b,d)}};return a}(ka),Jb=function(b){function a(a,e,d,f,g,k){b.call(this,a,e,d,f);this.duration=g;this.style=k;this.logs=[]}t(a,b);a.prototype.onDraw=function(a,b){var d=this.logs;if(0<d.length){var f=b-this.duration,e=d.findIndex(function(a){return a.when>f});0>e?d.length=0:d.splice(0,e);e=d.length;if(0<e)for(var k=this.style,l=da(k.fontSize,24),m=0;m<e;++m)ga(a,d[m].message,this.x,this.y+m*l,this.w,l,k)}};a.prototype.log=function(a){if(a){var b=performance.now(),d=this.logs,
e=d.length;0<e&&d[e-1].message===a?d[e-1].when=b:d.push({message:Ca(a),when:b})}};a.prototype.error=function(a){this.log(a)};return a}(ka);E.languages.en="assets/lang/en.js";E.languages.ja="assets/lang/ja.js";var db={bkgnd:m(0,0,0,.6),delta:l(255,51,0),normal:l(153,204,0),full:l(0,204,51)},zb={bkgnd:m(0,0,0,.6),delta:l(0,51,102),normal:l(0,153,204),full:l(0,153,255)},Ja=[{PICK:0,WALK:!1,POPUP:!1},{PICK:0,WALK:!1,POPUP:!0},{PICK:0,WALK:!0,POPUP:!0},{PICK:300,WALK:!0,POPUP:!0}],ob=[k.TAB,k.ENTER,k.ESCAPE,
k.SPACE,k.DELETE],eb=[k.ENTER,k.SPACE,k.Y],fb=[k.TAB,k.ESCAPE,k.DELETE,k.N],Fb=[k.ESCAPE],Kb=[k.ENTER,k.SPACE],Lb={Warrior:{INT:4,DEX:4,STR:7,equipments:["Mace","PlateArmor","Mace"],skills:["Swing","Crash","Bash"],image:"nazrin"},Samurai:{INT:3,DEX:7,STR:5,equipments:["Katana","Chainmail"],skills:["Swing","Slash","CutThrough","Sweep"],image:"rin"},Knight:{INT:6,DEX:2,STR:7,equipments:["Spear","LamellarArmor","KiteShield"],skills:["Swing","Stab","Thrust","ShieldBash","ShieldCharge"],image:"toramaru"},
Thief:{INT:3,DEX:6,STR:6,equipments:["LongBow","LetherArmor","FirstAidKit"],skills:["Shoot","FirstAid"],image:"marisa"},Healer:{INT:7,DEX:3,STR:5,equipments:["Staff","Robe"],skills:["Swing","Heal","PartyHeal"],image:"reimu"},Mage:{INT:8,DEX:4,STR:3,equipments:["Wand","Robe"],skills:["FireBall","IceSpear","DrainLife","LightningLaser","FireNova"],image:"utsuho"}},Ab={Ant:{INT:3,DEX:3,STR:4,equipments:["Dagger","LetherArmor"],skills:["Swing"],image:"ant.png"},Elemental:{INT:4,DEX:3,STR:3,equipments:["Wand",
"LetherArmor"],skills:["FireBall"],image:"elemental.png"},Frog:{INT:4,DEX:4,STR:4,equipments:["ShortBow","LetherArmor"],skills:["Shoot"],image:"frog.png"},Plant:{INT:4,DEX:3,STR:4,equipments:["Wand","LetherArmor"],skills:["FireNova"],image:"plant.png"},Slug:{INT:3,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["DrainLife"],image:"slug.png"},Snail:{INT:3,DEX:3,STR:3,equipments:["LongBow","LetherArmor"],skills:["Shoot"],image:"snail.png"},Sword:{INT:3,DEX:5,STR:4,equipments:["LongSword","LetherArmor"],
skills:["Swing"],image:"sword.png"},Wall:{INT:3,DEX:3,STR:6,equipments:["Mace","LetherArmor"],skills:["Swing"],image:"wall.png"},Weasel:{INT:3,DEX:6,STR:3,equipments:["Spear","LetherArmor"],skills:["Thrust"],image:"weasel.png"}},Mb={AddedFire:{tags:[0,1,2],min:5,max:10,ATK:function(b,a){return a+b}}},W={Dagger:{tags:[0,8],weight:13,price:100,ATK:30},ShortSword:{tags:[0,8],weight:15,price:100,ATK:40},LongSword:{tags:[0,8],weight:16,price:100,ATK:50},Katana:{tags:[0,8],weight:15,price:100,ATK:45},Axe:{tags:[0,
8,9],weight:18,price:100,ATK:45},Mace:{tags:[0,9],weight:16,price:100,ATK:40},Spear:{tags:[0,10],weight:20,price:100,ATK:50},Halberd:{tags:[0,8,9,10],weight:30,price:100,ATK:50},ShortBow:{tags:[2,10],weight:18,price:100,ATK:30},LongBow:{tags:[2,10],weight:20,price:100,ATK:40},Staff:{tags:[0,9,11],weight:20,price:100,ATK:20},Wand:{tags:[11],weight:16,price:100,ATK:25},FirstAidKit:{tags:[12],weight:10,price:100,ATK:10},Buckler:{tags:[3],weight:20,price:100,ATK:10,DEF:10},RoundShield:{tags:[3],weight:25,
price:100,ATK:15,DEF:15},SpikedShield:{tags:[3],weight:30,price:100,ATK:30,DEF:15},KiteShield:{tags:[3],weight:35,price:100,ATK:20,DEF:20},TowerShield:{tags:[3],weight:40,price:100,ATK:30,DEF:20},Circlet:{tags:[4],weight:5,price:100,DEF:2},LeatherHood:{tags:[4],weight:10,price:100,DEF:4},Mask:{tags:[4],weight:15,price:100,DEF:6},Sallet:{tags:[4],weight:20,price:100,DEF:8},Bascinet:{tags:[4],weight:25,price:100,DEF:10},Helmet:{tags:[4],weight:30,price:100,DEF:12},Robe:{tags:[5],weight:20,price:100,
DEF:10},LetherArmor:{tags:[5],weight:25,price:100,DEF:15},ScaleArmor:{tags:[5],weight:30,price:100,DEF:20},Chainmail:{tags:[5],weight:35,price:100,DEF:22},LamellarArmor:{tags:[5],weight:40,price:100,DEF:25},PlateArmor:{tags:[5],weight:45,price:100,DEF:30},Gloves:{tags:[6],weight:10,price:100,DEF:4},Mittens:{tags:[6],weight:20,price:100,DEF:6},Gauntlets:{tags:[6],weight:30,price:100,DEF:8},Slippers:{tags:[7],weight:5,price:100,DEF:2},Sandals:{tags:[7],weight:10,price:100,DEF:4},Shoes:{tags:[7],weight:15,
price:100,DEF:6},Boots:{tags:[7],weight:20,price:100,DEF:8},Greaves:{tags:[7],weight:25,price:100,DEF:10}},Nb={Dummy:{tags:[],cost:999,range:0,power:0,target:0,aciton:"Charge"},Swing:{tags:[0],cost:14,range:1,power:100,target:0,aciton:"Charge"},Slash:{tags:[0,8],cost:15,range:1,power:110,target:0,aciton:"Charge"},CutThrough:{tags:[0,8],cost:20,range:1,power:100,target:0,aciton:"GoBehind"},Sweep:{tags:[0,8],cost:20,range:1,power:100,target:4,aciton:"Nova"},Crash:{tags:[0,9],cost:15,range:1,power:110,
target:0,aciton:"Charge"},Bash:{tags:[0,9],cost:20,range:1,power:100,target:0,aciton:"Knockback"},Stab:{tags:[0,10],cost:15,range:1,power:110,target:0,aciton:"Charge"},Thrust:{tags:[0,10],cost:15,range:2,power:100,target:2,aciton:"Laser"},ShieldBash:{tags:[3],cost:20,range:1,power:100,target:0,aciton:"Charge"},ShieldCharge:{tags:[3],cost:24,range:1,power:100,target:0,aciton:"Trample"},Shoot:{tags:[2],cost:20,range:3,power:100,target:0,aciton:"Shoot"},IceSpear:{tags:[11],cost:16,range:5,power:80,target:0,
aciton:"Freeze"},DrainLife:{tags:[11],cost:16,range:5,power:80,target:0,aciton:"Drain"},FireBall:{tags:[11],cost:16,range:5,power:100,target:0,aciton:"Explode"},LightningLaser:{tags:[11],cost:16,range:5,power:100,target:2,aciton:"Laser"},FireNova:{tags:[11],cost:16,range:2,power:100,target:4,aciton:"Nova"},Heal:{tags:[11],cost:24,range:3,power:100,target:1,aciton:"Shoot"},PartyHeal:{tags:[11],cost:24,range:1,power:100,target:5,aciton:"Nova"},FirstAid:{tags:[12],cost:24,range:1,power:100,target:1,
aciton:"Charge"}},ha,Ob=va([3,4,5,6,7]),Ka=function(){function b(a){this.EID=a;this.def=Mb[this.EID];if(null==this.def)throw new RangeError('Enchantment not found: "'+this.EID+'"');this.name=b.nameOf(this.EID);this.spec=b.specOf(this.EID);this.value=this.def.min+Ba(this.def.max-this.def.min)}b.prototype.qualify=function(a){return Da(this.name.localized,a)};b.prototype.modify=function(a){this.def.ATK&&(a=this.def.ATK(this.value,a));return a};b.nameOf=function(a){return e("Enchant",a,"Name")};b.specOf=
function(a){return e("Enchant",a,"Spec")};b.from=function(a){return new b(a)};b.fromJSON=function(a){return new b(a.EID)};b.prototype.toJSON=function(){return{EID:this.EID,value:this.value}};return b}(),ia=function(){function b(a,c){this.IID=a;this.enchants=c;this.def=W[this.IID];if(null==this.def)throw new RangeError('Item not found: "'+this.IID+'"');this.baseName=b.nameOf(this.IID);this.spec=b.specOf(this.IID);this.tagbits=va(this.def.tags);null==this.enchants&&(this.enchants=(this.def.enchants||
[]).map(Ka.from))}Object.defineProperty(b.prototype,"name",{get:function(){for(var a=this.baseName.localized,b=0,e=this.enchants;b<e.length;b++)a=e[b].qualify(a);return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"tags",{get:function(){return this.def.tags},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"weight",{get:function(){return this.def.weight},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"priceToSell",{get:function(){for(var a=
this.def.price,b=0,e=this.enchants;b<e.length;b++)a=e[b].modify(a);return u(a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"ATK",{get:function(){for(var a=this.def.ATK||0,b=0,e=this.enchants;b<e.length;b++)a=e[b].modify(a);return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"DEF",{get:function(){for(var a=this.def.DEF||0,b=0,e=this.enchants;b<e.length;b++)a=e[b].modify(a);return a},enumerable:!0,configurable:!0});b.nameOf=function(a){return e("Item",
a,"Name")};b.specOf=function(a){return e("Item",a,"Spec")};b.from=function(a){return new b(a)};b.fromJSON=function(a){return new b(a.IID,S(Ka,a.enchants))};b.prototype.toJSON=function(){return{IID:this.IID,enchants:ma(this.enchants)}};return b}(),Va=function(){function b(a){this.SID=a;this.def=Nb[this.SID];if(null==this.def)throw new RangeError('Skill not found: "'+this.SID+'"');this.name=b.nameOf(this.SID);this.spec=b.specOf(this.SID);this.tagbits=va(this.def.tags)}Object.defineProperty(b.prototype,
"tags",{get:function(){return this.def.tags},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"cost",{get:function(){return this.def.cost},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"range",{get:function(){return this.def.range},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"power",{get:function(){return this.def.power},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"target",{get:function(){return this.def.target},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"hostile",{get:function(){var a;a:switch(this.def.target){case 1:case 3:case 5:a=!1;break a;default:a=!0}return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"action",{get:function(){return this.def.aciton},enumerable:!0,configurable:!0});b.prototype.match=function(a){return(this.tagbits&a.tagbits)===this.tagbits};b.nameOf=function(a){return e("Skill",a,"Name")};b.specOf=function(a){return e("Skill",a,"Spec")};b.from=function(a){return new b(a)};
b.fromJSON=function(a){return new b(a.SID)};b.prototype.toJSON=function(){return{SID:this.SID}};b.DUMMY=new b("Dummy");return b}(),La=[1,2,3,4,5,5,5,5,4,3,2,1],Pb=La.reduce(function(b,a){return R(b,a)},0),Db=function(){function b(a,b){this.src=a;this.back=new N(a+"/back.png");for(var e=[new N(a+"/eye.png")],d=1;d<=Pb;++d)e.push(new N(a+("/eye"+d+".png")));this.eyes=e;this.fore=new N(a+"/fore.png");this.cycle=4500+100*b;this.offset=Ba(this.cycle)}Object.defineProperty(b.prototype,"w",{get:function(){return this.back.w},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"h",{get:function(){return this.back.h},enumerable:!0,configurable:!0});b.prototype.draw=function(a,b,e,d,f){this.back.draw(a,b,e,d,f);var g;g=(b+this.offset)%this.cycle;g=450>g?La[u(g/450*La.length)]:0;this.eyes[g].draw(a,b,e,d,f);this.fore.draw(a,b,e,d,f)};return b}(),X=function(){function b(a,b,e,d,f,g,k,l){this.name=a;this.INT=b;this.DEX=e;this.STR=d;this.equipments=f;this.skills=g;this.known=k;this.image=l}Object.defineProperty(b.prototype,
"HP",{get:function(){return 10*(3+this.STR)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"SP",{get:function(){var a=R(0,this.weight-this.maxWeight);return R(0,4*(3+this.STR)-a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"step",{get:function(){return 13-this.DEX},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"ZoC",{get:function(){return 3+this.DEX},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"maxWeight",{get:function(){return 10*
(3+this.STR)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"weight",{get:function(){return this.equipments.reduce(function(a,b){return a+b.weight},0)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"DEF",{get:function(){return 100*(1-this.equipments.reduce(function(a,b){return a*(1-b.DEF/100)},1))},enumerable:!0,configurable:!0});b.prototype.costOf=function(a){return null==a?void 0:a.cost-this.INT};b.prototype.rangeOf=function(a){return null==a?void 0:a.range};
b.prototype.powerOf=function(a){var b=this.itemFor(a);return b?b.ATK*a.power/100:void 0};b.prototype.itemFor=function(a){var b=void 0;if(a)for(var e=0,d=0,f=this.equipments;d<f.length;d++){var g=f[d];if(a.match(g)){var k=g.ATK;e<k&&(e=k,b=g)}}return b};b.adventurer=function(a){var c=Lb[a];if(null==c)throw new RangeError('Adventurer not found: "'+a+'"');return b.from(e("Adventurer",a),c)};b.monster=function(a){var c=Ab[a];if(null==c)throw new RangeError('Monster not found: "'+a+'"');return b.from(e("Monster",
a),c)};b.from=function(a,c){return new b(a.localized,c.INT,c.DEX,c.STR,c.equipments.map(ia.from),c.skills.map(Va.from),[],mb(c.image,c.INT))};b.fromJSON=function(a){return new b(a.name,a.INT,a.DEX,a.STR,S(ia,a.equipments),S(Va,a.skills),S(Va,a.known),mb(a.image,a.INT))};b.prototype.toJSON=function(){var a=this.name,b=this.INT,e=this.DEX,d=this.STR,f=ma(this.equipments),g=ma(this.skills),k=ma(this.known),l;l=this.image.src;l=l.startsWith("assets/char/")?l.substr(12):l;return{name:a,INT:b,DEX:e,STR:d,
equipments:f,skills:g,known:k,image:l}};return b}(),gb;(function(b){var a=function(a){function b(){var d=this;a.call(this);(new C(0,0,1280,720,new N("assets/scene/title.jpg"))).attach(this);var f=pb(),g=function(a){(new aa(d,new Ma.Home(a))).attach(d.parent)},k,l;f?(k=e("Title","Continue"),l=function(){return g(f)},(new G(1070,650,200,60,new y(e("Title","Delete")),function(){Ga.confirm(d,e("Title","ConfirmDelete"),{label:e("Title","Delete"),click:function(){try{System.setRoamingStorage("NYO",null)}catch(a){D.error(a)}(new aa(d,
new b)).attach(d.parent);D.log(e("Title","NotifyDelete"))},mnemonic:eb},{label:e("Config","Cancel"),mnemonic:fb})})).attach(this)):(k=e("Title","New"),l=function(){var a={},b;for(b in W){var c=Ba(4);0<c&&(a[b]=c)}a={shop:a,warehouse:[],reservers:[],party:[X.adventurer("Knight"),X.adventurer("Warrior"),X.adventurer("Samurai"),X.adventurer("Mage"),X.adventurer("Healer"),X.adventurer("Thief")],gold:1E3};a.party[0].equipments[0].enchants.push(Ka.from("AddedFire"));rb(a);g(a)});(new G(480,504,320,72,new y(k),
l,Kb)).attach(this);(new G(480,612,320,72,new y(e("Title","Quit")),System.exit)).attach(this);Za(this)}t(b,a);return b}(O);b.Scene=a})(gb||(gb={}));var Ma;(function(b){function a(){return[{name:e("Character","Name"),extract:function(a){return a.name},width:200},{name:e("Character","INT"),extract:function(a){return a.INT},width:60,align:"right"},{name:e("Character","DEX"),extract:function(a){return a.DEX},width:60,align:"right"},{name:e("Character","STR"),extract:function(a){return a.STR},width:60,
align:"right"}]}function c(a){return[{name:a,extract:function(a){return a.name},width:200},{name:e("Town","Tags"),extract:function(a){return ua(a.tags)}},{name:e("Town","Weight"),extract:function(a){return a.weight},width:60,align:"right"},{name:e("Town","ATK"),extract:function(a){return a.ATK},width:60,align:"right"},{name:e("Town","DEF"),extract:function(a){return a.DEF},width:60,align:"right"}]}function h(a,b){var d=b.shop,f=c(a);f.push({name:e("Town","Stock"),extract:function(a){return da(d[a.IID],
e("Town","New"))},width:60,align:"right"});return f}function d(a,b){var c=b.shop,d=b.warehouse;return[{name:a,extract:function(a){return ia.nameOf(a)},width:200},{name:e("Town","Tags"),extract:function(a){return ua(W[a].tags)}},{name:e("Town","ATK"),extract:function(a){return W[a].ATK},width:60,align:"right"},{name:e("Town","DEF"),extract:function(a){return W[a].DEF},width:60,align:"right"},{name:e("Town","Weight"),extract:function(a){return W[a].weight},width:60,align:"right"},{name:e("Town","Stock"),
extract:function(a){return c[a]},width:60,align:"right"},{name:e("Town","Owned"),extract:function(a){return d.reduce(function(b,c){return c.IID===a?b+1:b},0)},width:60,align:"right"}]}function f(a){return[{name:a,extract:function(a){return a.name.localized},width:200},{name:e("Town","Required"),extract:function(a){return ua(a.tags)}},{name:e("Town","Cost"),extract:function(a){return a.cost},width:60,align:"right"},{name:e("Town","Range"),extract:function(a){return a.range},width:60,align:"right"},
{name:e("Town","Power"),extract:function(a){return a.power},width:60,align:"right"},{name:e("Town","Spec"),extract:function(a){return a.spec.localized}}]}var g={fontSize:64,fillStyle:l(255,255,255),strokeStyle:l(0,0,0),textAlign:"center",textBaseline:"middle",lineWidth:2},m=function(){function a(b,c){this.party=b;this.index=c}a.prototype.draw=function(a,b,c){var d=c.x,e=c.y,f=c.w;c=c.h;var h=this.party[this.index];a.save();if(h){var k=Fa(h.image,140,184);h.image.draw(a,b,{x:d+f/2-k.w/2,y:e+92-k.h/
2,w:k.w,h:k.h});var m=this.party.reduce(function(a,b){return b?R(a,b.HP):a},1);b=h.HP;var k=d+10,r=f-20,n=e+c-30,m=(r-2)*b/m;a.strokeStyle="black";a.fillStyle=db.full;a.fillRect(k,n,m,6);a.strokeRect(k,n,m,6);ga(a,b.toString(),k+4,n-20,r,20,{fontSize:20,fillStyle:l(255,255,255),strokeStyle:l(0,0,0),textAlign:"left",textBaseline:"bottom",lineWidth:2});ga(a,h.name,d,e+c-24,f,24,{fontSize:24,fillStyle:l(255,255,255),strokeStyle:l(0,0,0),textAlign:"center",textBaseline:"bottom",lineWidth:2})}else ga(a,
(this.index+1).toString(),d,e,f,c,g);a.restore()};return a}(),r=function(a){function b(c){a.call(this);this.data=c}t(b,a);b.prototype.addButton=function(a,b,c,d){a=new G(1280-170*a,665,160,45,new y(c),d,b);a.attach(this);return a};b.prototype.goTo=function(a){(new aa(this,new a(this.data))).attach(this.parent)};return b}(O),n=function(a){function b(c,d){a.call(this,c);(new C(0,0,1280,720,new N("assets/scene/"+d))).attach(this);Za(this);for(var e=c.party,f=this,g=[],h=0;6>h;++h){var k=u(h/3),l=u(h%
3);(new wb(10+170*(1-k),10+214*l+68*k,160,204,g,new m(e,h),function(){f.onPortraitClick(this.drawable.index)},function(a){var b=this.drawable;a=a.drawable;c=[e[a.index],e[b.index]];e[b.index]=c[0];e[a.index]=c[1];c=[a.index,b.index];b.index=c[0];a.index=c[1];var c})).attach(this)}}t(b,a);return b}(r),B=function(a){function b(c){var d=this;a.call(this,c,"town.jpg");var f=["grass","moss"],g=Ba(f.length);this.addSpot(5,k.G,"Guild",function(){}).enabled=!1;this.addSpot(4,k.P,"Pub",function(){return d.goTo(L)});
this.addSpot(3,k.T,"Shop",function(){return d.goTo(E)});this.addSpot(2,k.S,"Smith",function(){}).enabled=!1;this.addSpot(1,k.D,"Dungeon",function(){(new aa(d,new xa.Scene(c,new xa.EndressStage(f[g])))).attach(d.parent)}).enabled=c.party.some(function(a){return null!=a});this.addButton(2,[k.L],e("Town","Load"),function(){Ga.confirm(d,e("Town","ConfirmLoad"),{label:e("Town","Load"),click:function(){var a=pb();a&&((new aa(d,new b(a))).attach(d.parent),D.log(e("Town","NotifyLoad")))},mnemonic:eb},{label:e("Config",
"Cancel"),mnemonic:fb})});this.addButton(1,[k.S],e("Town","Save"),function(){rb(d.data);D.log(e("Town","NotifySave"))})}t(b,a);b.prototype.onPortraitClick=function(a){(a=this.data.party[a])&&(new aa(this,new Q(this.data,a))).attach(this.parent)};b.prototype.addSpot=function(a,b,c,d){a=new G(950,665-100*a,320,90,new y(e("Town",c)),d,[b]);a.attach(this);return a};return b}(n);b.Home=B;var L=function(b){function c(d){function f(a,b){(c=Array.prototype.splice).call.apply(c,[a,0,a.length].concat(b));var c}
var g=this;b.call(this,d,"pub.jpg");var h=d.party.concat(),l=d.reservers.concat();this.addButton(3,[k.C],e("Town","Clear"),function(){for(var a=0;6>a;++a){var b=d.party[a];b&&(d.reservers.push(b),d.party[a]=null)}});this.addButton(2,[k.R],e("Town","Revert"),function(){f(d.party,h);f(d.reservers,l)});this.addButton(1,[k.TAB,k.DELETE],e("Town","Back"),function(){return g.goTo(B)});(new z(350,10,920,z.heightOf(10),a(),d.reservers,function(a,b){return g.onReserverClick(a,b)})).attach(this)}t(c,b);c.prototype.onPortraitClick=
function(a){var b=this.data.party[a];b&&(this.data.party[a]=null,this.data.reservers.push(b))};c.prototype.onReserverClick=function(a,b){for(var c=0;6>c;++c)if(null==this.data.party[c]){this.data.party[c]=a;this.data.reservers.splice(b,1);return}D.error(e("Town","PartyFull"))};return c}(n),E=function(a){function b(c){var f=this;a.call(this,c,"shop.jpg");var g=c.shop,l=c.warehouse,m=new z(350,10,920,z.heightOf(10),d(e("Town","Buy"),c),Ea(g),function(a){if(0>=g[a])D.error(e("Town","SoldOut"));else{var b=
W[a].price;if(c.gold<b)D.error(e("Town","NoMoney"));else{var d=new ia(a);--g[a];l.push(d);c.gold-=b;D.log(Da(e("Town","NotifyBuy").localized,d.name,b))}}});m.attach(this);var r=new z(350,10,920,z.heightOf(10),h(e("Town","Sell"),c),l,function(a,b){var d=a.IID,f=a.priceToSell;l.splice(b,1);var h=g[d];null==h?(g[d]=1,m.rows.push(d)):g[d]=1+h;c.gold+=f;D.log(Da(e("Town","NotifySell").localized,a.name,f))});r.attach(this);var n,t;n=this.addButton(3,[k.B],e("Town","Buy"),function(){m.visible=!0;r.visible=
!1;n.enabled=!1;t.enabled=!0});t=this.addButton(2,[k.S],e("Town","Sell"),function(){m.visible=!1;r.visible=!0;n.enabled=!0;t.enabled=!1});this.addButton(1,[k.TAB,k.DELETE],e("Town","Back"),function(){return f.goTo(B)});n.click()}t(b,a);b.prototype.onPortraitClick=function(a){D.log("Shop.onPortraitClick: "+a)};return b}(n),Q=function(a){function b(d,g){var h=this;a.call(this,d);var l=d.warehouse,m=Fa(g.image,1280,720,!0);(new C(0,0,m.w,m.h,g.image)).attach(this);(new C(0,0,200,40,new y(g.name))).attach(this);
(new C(0,40,200,40,new y("INT: "+g.INT))).attach(this);(new C(100,40,200,40,new y("DEX: "+g.DEX))).attach(this);(new C(200,40,200,40,new y("STR: "+g.STR))).attach(this);(new C(0,80,200,40,new y(function(){return"HP: "+g.HP}))).attach(this);(new C(0,120,200,40,new y(function(){return"SP: "+g.SP}))).attach(this);(new C(0,160,200,40,new y(function(){return"WT: "+g.weight+"/"+g.maxWeight}))).attach(this);(new C(0,200,200,40,new y(function(){return"DEF: "+g.DEF.toFixed(1)}))).attach(this);var n=new O([new z(350,
10,920,z.heightOf(10),c(e("Town","Equipments")),g.equipments,function(a,b){g.equipments.splice(b,1);l.push(a)}),new z(350,360,920,z.heightOf(10),c(e("Town","Warehouse")),l,function(a,b){l.splice(b,1);var c=g.equipments,d=a.tagbits,e=[],d=d&Ob;if(0!==d)for(var f=0;f<c.length;)0!==(c[f].tagbits&d)?(e.push(c[f]),c.splice(f,1)):++f;g.equipments.push(a);(h=l.push).call.apply(h,[l].concat(e));var h})]);n.attach(this);var r=new O([new z(350,10,920,z.heightOf(10),f(e("Town","Skills")),g.skills,function(a,
b){g.skills.splice(b,1);g.known.push(a)}),new z(350,360,920,z.heightOf(10),f(e("Town","Knowns")),g.known,function(a,b){g.known.splice(b,1);g.skills.push(a)})]);r.attach(this);var t,u;t=this.addButton(3,[k.E],e("Town","Equipments"),function(){n.visible=!0;r.visible=!1;u.enabled=!0;t.enabled=!1});u=this.addButton(2,[k.S],e("Town","Skills"),function(){n.visible=!1;r.visible=!0;u.enabled=!1;t.enabled=!0});this.addButton(1,[k.TAB,k.DELETE],e("Town","Back"),function(){return h.goTo(B)});t.click()}t(b,a);
return b}(r)})(Ma||(Ma={}));var xa;(function(b){function a(a,b){var q=a.xH;return{xH:q+[1,2,1,-1,-2,-1][b],yH:a.yH+(0===q%2?[-1,0,0,0,0,-1]:[0,0,1,1,0,0])[b]}}function c(a,b){var q=a.xH,c=b.xH,d=c-q,q=2*b.yH+c%2-(2*a.yH+q%2);return 0>q?q>d?(-d-q)/2:q>-d?(d-q)/2:-q:q<d?(d+q)/2:q<-d?(-d+q)/2:q}function h(a,b){return a===b||!!a&&!!b&&a.xH===b.xH&&a.yH===b.yH}function d(a,b,q,c,d,e,f,g,p){var h=ca(0,1,e/f);e=null==g?h:ca(0,1,(e+g)/f);a.save();a.fillStyle=p.bkgnd;a.fillRect(b,q,c,d);b+=1;q+=1;c-=2;d-=
2;e>h?(a.fillStyle=1<=h?p.full:p.normal,a.fillRect(b,q,c*h-1,d),a.fillStyle=p.full,a.fillRect(b+c*h,q,c*(e-h),d)):e<h?(f=c*e,0<e&&(f=R(f,2),a.fillStyle=1<=h?p.full:p.normal,a.fillRect(b,q,f-1,d)),a.fillStyle=p.delta,a.fillRect(b+f,q,c*(h-e),d)):(a.fillStyle=1<=h?p.full:p.normal,a.fillRect(b,q,c*h,d));a.restore()}function f(a,b,q,c,A){b=q.toX(A)+16;q=q.toY(A)+60;d(a,b,q,96,6,c.HP,c.maxHP,null,db)}function g(a,b,q,c,A,e){b=q.toX(A)+16;q=q.toY(A)+60+6;d(a,b,q,96,6,c.SP,c.maxSP,e-c.SP,zb)}function w(a,
b,q,c,d,e){var f=0,f=1===a.team?f+10*(d-b):f+10*(b-c);a=2*q+b%2;f=3>a?f+10*a:f+10*(5-a);b<e&&(f*=.1);return f}function r(a,b,q){var d=void 0,A=c(b,q)+1;a.straight(b,q,A,function(b,q){q===A&&a.get(b).empty&&(d=b)});return d}function z(a,b,q,c,d){var e=a.toX(b)-a.toX(q),f=a.toY(b)-a.toY(q),e=100+Sa(e*e+f*f,.5)/1280*400,e=new B(e,function(e,f){var g=a.toX(b),K=a.toY(b),h=a.toX(q),ya=a.toY(q);Ra(f,g*(1-e)+h*e+64-20,K*(1-e)+ya*e+40-20,40,40,c,d,.5)});e.attach(a);return e}function E(a,b,q,c,d,e){b=z(a,
b.hex,q.hex,d,e);b.then(function(){c.attach(a)});return n.wait.POPUP?c:b}function S(a,b,q,c,d,e){function f(q,c){var d=g.get(q).unit;if(b.isTarget(d)){var J=b.trySkill(d);e&&(J=e(J,c));d=a.promiseEffect(d,J);d.attach(a);h.push(d)}}var g=a.field,h=[];f(q,0);g.surround(q,c,f);var v=new B(400,function(b,e){var x=a.toX(q)+64,f=a.toY(q)+40,g=128*c*b,h=80*c*b,K=m(d.r,d.g,d.b,1-b),p=m(d.r,d.g,d.b,0);Ra(e,x-g,f-h,2*g,2*h,K,p,b)});v.attach(a);return n.wait.POPUP?(h.push(v),new Ua(h)):v}var W=m(0,0,0,0),Q=
m(0,0,0,.75),F={inner:l(230,255,180),outer:l(51,230,51)},I={inner:l(230,180,255),outer:l(51,51,230)},T={inner:l(255,180,230),outer:l(230,51,51)},M={inner:l(230,180,255),outer:l(51,51,230)},ga={outer:l(64,192,255),inner:l(180,232,255),bkgnd:m(64,192,255,.3)},wa={outer:l(255,192,64),inner:l(255,232,192),bkgnd:m(255,192,64,.3)},ia={DASH_OR_RANGE:{outer:l(255,64,64),inner:l(255,180,180),bkgnd:m(255,192,64,.3)},RANGE:{outer:l(255,64,64),inner:l(255,180,180),bkgnd:m(255,128,64,.3)},TARGET:{outer:l(255,
24,24),inner:l(255,64,64),bkgnd:m(255,24,24,.3)}},ma={DASH_OR_RANGE:{outer:l(24,24,255),inner:l(180,180,255),bkgnd:m(255,192,64,.3)},RANGE:{outer:l(64,64,255),inner:l(180,180,255),bkgnd:m(24,128,255,.3)},TARGET:{outer:l(24,24,255),inner:l(64,64,255),bkgnd:m(24,24,255,.3)}},la=m(0,0,0,.65),Ia=m(0,0,0,0),oa={textAlign:"center",textBaseline:"bottom",fontSize:32,fillStyle:"yellow",strokeStyle:"black",lineWidth:2},ra={textAlign:"center",textBaseline:"bottom",fontSize:32,fillStyle:"red",strokeStyle:"black",
lineWidth:2},fa=m(255,0,0,.8),ta=l(255,180,180),xa=l(180,255,180),Ca=[{messageID:"PartyTurn",innerStyle:l(0,0,128),outerStyle:m(0,0,128,0),textStyle:{fontSize:64,fillStyle:"white",textAlign:"center",textBaseline:"middle"}},{messageID:"EnemyTurn",innerStyle:l(128,0,0),outerStyle:m(128,0,0,0),textStyle:{fontSize:64,fillStyle:"white",textAlign:"center",textBaseline:"middle"}}],Na=function(){function b(a,q){this.dummy=q;this.cells={};this.depth=u(a)}Object.defineProperty(b.prototype,"minXH",{get:function(){return 1+
bb(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"maxXH",{get:function(){return 20+u(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"minVisibleXH",{get:function(){return u(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"maxVisibleXH",{get:function(){return 21+bb(this.depth)},enumerable:!0,configurable:!0});b.prototype.contains=function(a,b){if(null==a)return!1;var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;return 0<=
b&&3>b&&this.minXH<=c&&c<this.maxXH;var d};b.prototype.getLine=function(a){return this.cells[a]};b.prototype.setLine=function(a,b){this.cells[a]=b};b.prototype.deleteLine=function(a){delete this.cells[a]};b.prototype.rawget=function(a,b){var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;return 0<=b&&3>b&&this.minVisibleXH<=c&&c<this.maxVisibleXH&&(c=this.cells[c])?c[b]:null;var d};b.prototype.get=function(a,b){var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;c=this.rawget(c,b);return da(c,this.dummy);var d};b.prototype.set=
function(a,b,c){null==c&&(d=b,b=d.xH,c=d.yH,d);d=this.cells[b];null==d&&(d=this.cells[b]=[]);d[c]=a;var d};b.prototype.each=function(a){for(var b=this.maxXH,c=this.minXH;c<b;++c)for(var d=0;3>d;++d)a.call(this,this.get(c,d),c,d)};b.prototype.eachVisible=function(a){for(var b=this.maxVisibleXH,c=this.minVisibleXH;c<b;++c)for(var d=0;3>d;++d)a.call(this,this.get(c,d),c,d)};b.prototype.straight=function(a,b,d,e){if(!h(a,b)){var f=a.xH,g=1+2*(2*a.yH+a.xH%2),hb=b.xH,p=1+2*(2*b.yH+b.xH%2);a=c(a,b);hb=(hb-
f)/a;p=(p-g)/a;for(a=1;a<=d;++a){var v=f+a*hb,P=u((g+a*p)/2);b=void 0;b=0===P%2?2*u((v+1)/2):2*u(v/2)+1;v=u(P/2);this.contains(b,v)&&e({xH:b,yH:v},a)}}};b.prototype.surround=function(b,q,c){if(1===q)for(var d=0;6>d;++d){var e=a(b,d);this.contains(e)&&c(e,1)}else if(1<q){b=a(b,0);for(var f=1;f<=q;++f){for(var e=b,g=0,h=[2,3,4,5,0,1];g<h.length;g++)for(var d=h[g],v=0;v<f;++v,e=a(e,d))this.contains(e)&&c(e,f);b=a(b,0)}}};return b}(),ba=function(){function a(b){this.duration=b}a.prototype.then=function(a){null==
this.duration?L.then(a):this.sig=pa(this.sig,a);return this};a.prototype.commit=function(){qa(this.sig);this.duration=this.sig=void 0};a.prototype.getXY=function(a,b,c){if(null!=this.duration)if(c=B.clamp(c,this.start,this.duration),1<=c)this.commit();else return this.onGetXY(a,b,c)};a.prototype.drawCharacter=function(a,b,c,d,e,f,g){a.drawCharacter(b,c,d,e,f,g)};return a}(),Da=function(a){function b(c){a.call(this,400*(13-c)/4)}t(b,a);b.prototype.onGetXY=function(a,b,c){a=a.hex;return{x:b.toX(a)-
128*(1-c)+64,y:b.toY(a)+80}};return b}(ba),Aa=function(a){function b(c){a.call(this,100*Sa(c.length-1,.75));this.path=c}t(b,a);b.prototype.onGetXY=function(a,b,c){var d=this.path.length-1,e=u(d*c),f=this.path[e],g=this.path[e+1];a=b.toX(f);var f=b.toY(f),h=b.toX(g);b=b.toY(g);c=d*c-e;return{x:a*(1-c)+h*c+64,y:f*(1-c)+b*c+80}};return b}(ba),sa=function(a){function b(c,d,e){a.call(this,function(a,b,c){var d=a.toX(b)-a.toX(c);a=a.toY(b)-a.toY(c);return 200+Sa(d*d+a*a,.3)/1280*1E3}(c,d,e));this.hexFrom=
d;this.hexTo=e}t(b,a);b.prototype.hit=function(a){null==this.duration?L.then(a):this.hitsig=pa(this.hitsig,a)};b.prototype.commit=function(){qa(this.hitsig);this.hitsig=void 0;a.prototype.commit.call(this)};b.prototype.onGetXY=function(a,b,c){var d=this.hexFrom,e=this.hexTo;a=b.toX(d);var d=b.toY(d),f=b.toX(e);b=b.toY(e);.5>c?c*=2:(c=2-2*c,qa(this.hitsig),this.hitsig=null);return{x:a*(1-c)+f*c+64,y:d*(1-c)+b*c+80}};return b}(ba),ua=function(a){function b(c,d){a.call(this,500);var e=c.HP;this.dying=
d>=e?c.hex:null;this.radius=d>=e/2?1:.5+d/e}t(b,a);b.prototype.onGetXY=function(a,b,c){var d=20*(1-c)*this.radius;c=c*V*this.duration/250*this.radius;a=this.dying||a.hex;return{x:d*U(4*c)+b.toX(a)+64,y:d*U(3*c)+b.toY(a)+80}};b.prototype.drawCharacter=function(b,c,d,e,f,g,h){this.dying?(g=B.clamp(d,this.start,this.duration),c.save(),c.globalAlpha=1-g,a.prototype.drawCharacter.call(this,b,c,d,e,f,"red",g),c.restore()):a.prototype.drawCharacter.call(this,b,c,d,e,f,g,h)};return b}(ba),ha=function(){function a(b,
c,d){this.ch=b;this.team=c;this.hex=d;this.idleOffset=Oa();this.HP=this.maxHP;this.SP=this.maxSP;this.skill=b.skills.find(function(a){return null!=b.powerOf(a)})||Va.DUMMY}a.prototype.toString=function(){return"Unit(name="+this.name+", hex="+this.hex+")"};Object.defineProperty(a.prototype,"name",{get:function(){return this.ch.name},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxHP",{get:function(){return this.ch.HP},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"maxSP",{get:function(){return this.ch.SP},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"step",{get:function(){return this.ch.step},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ZoC",{get:function(){return this.ch.ZoC},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){return this.ch.DEF},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"cost",{get:function(){return this.ch.costOf(this.skill)},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"range",{get:function(){return this.ch.rangeOf(this.skill)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ATK",{get:function(){return this.ch.powerOf(this.skill)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"minCost",{get:function(){var a=this;return this.ch.skills.reduce(function(b,c){var d=a.ch.costOf(c);return d<b?d:b},this.maxSP)},enumerable:!0,configurable:!0});a.prototype.isEnemy=function(a){return null!=
a&&this.team!==a.team};a.prototype.isTarget=function(a){return null==a?!1:this.skill.hostile?this.isEnemy(a):this!==a&&!this.isEnemy(a)};a.prototype.canTarget=function(a,b){return this.SP>=this.cost&&this.isTarget(a.get(b).unit)&&c(this.hex,b)<=this.range};a.prototype.done=function(a){a=a.zoc;if(!a)return!1;var b=this.hex;return b&&this.SP<this.minCost&&this.SP<this.step+a[this.team].get(b)};a.prototype.trySkill=function(a){return this.isTarget(a)?this.skill.hostile?-bb(this.ATK*(100-a.DEF)/100):
this.ATK:null};a.prototype.shoot=function(a,b){var c=Xa[this.skill.action](a,this,b);this.SP-=this.cost;return c};a.prototype.onTurnEnd=function(a){this.team===a.team&&(this.SP=this.maxSP)};a.prototype.onTurnStart=function(a){};a.prototype.getXY=function(a,b){var c;this.state&&(c=this.state.getXY(this,a,b),null==c&&(this.state=null));if(null==c){var d=this.hex;d&&(c={x:a.toX(d)+64,y:a.toY(d)+80})}return c};Object.defineProperty(a.prototype,"state",{get:function(){return this._state},set:function(a){var b=
this._state;if(this._state=a)a.start=performance.now();b&&b.commit()},enumerable:!0,configurable:!0});a.prototype.drawCharacter=function(a,b,c,d,e,f){var g=this.ch.image,h=Fa(g,128,128),v=h.w,k=.2*v;Ra(a,c-v/2,d-10-k/2,v,k,la,Ia,.75);b&&(v=200*(12-this.ch.DEX),v=R(0,U(2*V*(this.idleOffset+b%v/v))),d-=16*v+10*(1-v));h.x=c-h.w/2;h.y=d-h.h;g.draw(a,b,h,e,f)};a.prototype.draw=function(a,b,c,d,e,f){this.state?this.state.drawCharacter(this,a,b,c,d,e,f):this.drawCharacter(a,b,c,d,e,f)};a.prototype.drawBars=
function(a,b,c,e,f){var g=this.hex;b=c.toX(g)+16;c=c.toY(g)+60;d(a,b,c,96,6,this.HP,this.maxHP,e,db);d(a,b,c+6,96,6,this.SP,this.maxSP,f,zb)};a.compare=function(a,b){return a.y<b.y?-1:a.y>b.y?1:a.x<b.x?-1:a.x>b.x?1:0};return a}(),va=function(){function a(b,c){void 0===b&&(b=0);this.type=b;this.unit=c}Object.defineProperty(a.prototype,"empty",{get:function(){return null==this.unit&&0===this.type},enumerable:!0,configurable:!0});a.DUMMY=new a(1);return a}(),Ha=function(b){function c(d,e,f){function g(a,
b,c,d){var q=this,e=b.range;if(1<=e){var f=b.hex,J=a.field;a=a.numScrollsPerTurn;var A=this.get(d),p=c.get(d),K=ab(2*d.yH+d.xH%2-3),v=J.minXH+a,ya=d.xH<v,k=function(a){var b=q.get(a);if(A.SP>b.SP)return!0;if(A.SP<b.SP)return!1;b=a.xH<v;if(!ya&&b)return!0;if(ya&&!b)return!1;b=c.get(a);return p<b?!0:p>b?!1:d.xH<a.xH?!0:d.xH>a.xH?!1:K<ab(2*a.yH+a.xH%2-3)};J.surround(d,e,function(a){if(!h(a,f)){var c=J.rawget(a);a=q.ensure(a);if(null==a.shotFrom||k(a.shotFrom))a.shotFrom=d,null==a.deltaHP&&(a.deltaHP=
b.trySkill(c.unit))}})}}var ya=this,k=d.field;b.call(this,k.depth,c.DUMMY);var p=e.step,v=e.cost,l=e.hex,m=e.SP;this.ensure(l).SP=m;if(m>=p+f.get(l)){l=[l];do{var Y=l.shift(),za=this.get(Y).SP,n=p+f.get(Y);if(za>=n)for(za-=n,n=0;6>n;++n){var r=a(Y,n),H=k.rawget(r);H&&0===H.type&&!e.isEnemy(H.unit)&&(H=this.ensure(r),H.SP<za&&(H.SP=za,H.comeFrom=Y,za>=p+f.get(r)&&l.push(r)))}}while(0<l.length)}m>=v&&(this.each(function(a,b,c){a.SP>=v&&k.rawget(b,c).empty&&g.call(ya,d,e,f,{xH:b,yH:c})}),g.call(this,
d,e,f,e.hex))}t(c,b);c.prototype.ensure=function(a){var b=this.rawget(a);null==b&&(b={SP:-1},this.set(b,a));return b};c.prototype.getPath=function(a,b){var c=this.get(a),d=c.comeFrom,e=c.shotFrom,f;if(null!=c.deltaHP){if(!b.get(e).empty)return null;f=[e];c=this.get(e);d=c.comeFrom;c}else if(d){if(!b.get(a).empty)return null;f=[a]}for(;d;)f.unshift(d),c=this.get(d),d=c.comeFrom,c;return f};c.DUMMY={SP:-1};return c}(Na),Ja=function(a){function b(c,d,e,f,g,h){var p=this;a.call(this,d,e,f,g,h,new y(function(){var a=
p.focus;if(a){var b=a.ch.skills[p.index];if(b){var c=a.skill===b,d=a.ch.costOf(b),q=a.ch.rangeOf(b),a=a.ch.powerOf(b);return""+(c?"E ":"")+b.name.localized+"\n"+d+" / "+q+" / "+(0<a?a.toFixed(1):"-")}}},b.textStyle),function(){var a=this.focus;if(a){var b=a.ch.skills[this.index];b&&0<a.ch.powerOf(b)&&(a.skill=b,c.onSkillChanged(a))}},function(a){var b=this.focus;b&&(c=[b.ch.skills[a.index],b.ch.skills[this.index]],b.ch.skills[this.index]=c[0],b.ch.skills[a.index]=c[1],b=[a.index,this.index],this.index=
b[0],a.index=b[1]);var c});this.scene=c;this.index=h.length-1}t(b,a);Object.defineProperty(b.prototype,"visible",{get:function(){return null!=this.skill},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"enabled",{get:function(){var a=this.focus;return a?null!=a.ch.powerOf(a.ch.skills[this.index]):null},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"focus",{get:function(){return this.scene.focus},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"skill",{get:function(){var a=this.focus;return a?a.ch.skills[this.index]:null},enumerable:!0,configurable:!0});b.textStyle={fontSize:20};return b}(wb),ba=function(){function a(b,c){void 0===c&&(c=2);this.numScrollsPerTurn=c;var d="assets/"+("level/"+b+"/");this.imgSky=new N(d+"sky.png");this.imgCells=[new N(d+"tile.png"),new N(d+"hole.png")]}a.prototype.generate=function(a,b){var c=0,d=0;a.each(function(a){(a=a.unit)&&(0===a.team?++c:++d)});for(var e=0===c?.3:.3*Sa(1.1,c-d),f=Array(3),g=Ea(Ab),h=
0;3>h;++h){var k=void 0,l=0;12<b&&Oa()<e?(k=g[Ba(g.length)],k=X.monster(k),k=new ha(k,1,{xH:b,yH:h})):6<b&&.1>Oa()&&(l=1);f[h]=new va(l,k)}return f};a.prototype.draw=function(a,b,c){var d=this,e=c.field;a.save();var f=128*e.depth/2;a.fillStyle=this.imgSky.createPattern(a,"repeat");a.translate(-f,0);a.fillRect(0+f,0,1280,80);a.restore();var g={x:0,y:0,w:128,h:80};e.eachVisible(function(e,f,h){e=e.type;g.x=c.toX(f,h);g.y=c.toY(f,h);d.imgCells[e].draw(a,b,g)})};return a}();b.EndressStage=ba;ba=function(a){function b(c,
d){function f(a,b){return new G(10+110*a,570,100,140,{draw:function(a,c,d){var e=d.x,q=d.y,f=Fa(b.ch.image,d.w,d.h,!0),g=f.w,f=f.h,e=e+(d.w-g)/2,q=q+(d.h-f)/2;b.ch.image.draw(a,c,{x:e,y:q,w:g,h:f})}},function(){return l.click(b.hex)},[k.$1+a])}function g(a,b,c,d,e){b=new G(1280-150*b,570,140,140,new y(c),d);e&&na(b,"enabled",e);b.attach(a);return b}var h=this;a.call(this);this.data=c;this.stage=d;this.team=0;this.enabled=!1;var l=new Ka;l.attach(this);l.visible=!1;var p=new La;p.attach(this);p.visible=
!1;for(var v=c.party,m=new Na(0,va.DUMMY),x=m.minVisibleXH,p=m.maxVisibleXH;x<p;++x)m.setLine(x,this.stage.generate(m,x));for(var Y=[],n=[[2,0],[2,1],[2,2],[1,0],[1,1],[1,2]],p=0,r=n.length;p<r;++p){var t=v[p];if(t){var H=n[p],x=H[0],x={xH:x,yH:H[1]},H=new ha(t,0,x);H.state=new Da(t.DEX);m.rawget(x).unit=H;Y.push(f(p,H))}}this.field=m;this.dying=[];this.snapshots=[];this.startTurn();p=new O(Y);na(p,"visible",function(){return l.visible&&null==h.focus});p.attach(this);g(p,1,e("Combat","End"),function(){return h.endTurn()});
g(p,2,e("Combat","Undo"),function(){return l.undo()},function(){return l.canUndo});g(p,3,e("Combat","Retire"),function(){return h.retire()});var Wa=g(p,4,e("Combat","View")),p=new Z;p.onDraw=function(a,b){return h.drawUnits(a,b,h.focusTime)};p.attach(this);p=new Z;p.onDraw=function(a,b){return h.drawBarsOnView(a,b)};na(p,"visible",function(){return Wa.visible&&Wa.enabled&&(Wa.hover||Wa.pressed)});p.attach(this);p=new O;na(p,"visible",function(){return h.controller.visible&&null!=h.focus});p.attach(this);
v=new Z;v.onDraw=function(a,b){return h.drawBarsOnFocus(a,b,h.focus,h.controller.caret)};v.attach(p);var w=new ka(0,560,1280,160);w.onDraw=function(a,b){return h.drawPanel(a,b,h.focus,w)};w.attach(p);v=new O;na(v,"visible",function(){return l.visible&&null!=h.focus});v.attach(this);Y=[];for(p=0;6>p;++p)(new Ja(this,400+170*u(p/2),570+p%2*75,160,65,Y)).attach(v);var z=function(){var a=h.mapFor(h.focus);if(a){var b=h.controller.caret;if(b&&null!=a.get(b).deltaHP)return m.get(b).unit}return null},p=
new O;na(p,"visible",function(){return null!=z()});p.attach(this);var ib=new ka(640,560,640,160);ib.onDraw=function(a,b){return h.drawPanel(a,b,z(),ib)};ib.attach(p);p=System.canvas.getContext("2d");v=p.createLinearGradient(0,0,128,0);v.addColorStop(0,Q);v.addColorStop(1,W);(new C(0,0,128,560,new $a({fillStyle:v}))).attach(this);p=p.createLinearGradient(1152,0,1280,0);p.addColorStop(0,W);p.addColorStop(1,Q);(new C(1152,0,1280,560,new $a({fillStyle:p}))).attach(this);Za(this)}t(b,a);Object.defineProperty(b.prototype,
"controller",{get:function(){return this.children[this.team]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"numScrollsPerTurn",{get:function(){return this.stage.numScrollsPerTurn},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"focus",{get:function(){return this._focus},set:function(a){null==a?(this._focus=null,this.focusTime=void 0):this._focus!==a&&(this._focus=a,this.focusTime=performance.now())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"zoc",{get:function(){if(this.enabled){var a=this._zoc;if(!a){var a=this.field.depth,b=[new Na(a,0),new Na(a,0)];this.eachUnit(function(a){var c=a.ZoC;if(0<c){var d=b[0===a.team?1:0];d.surround(a.hex,1,function(a){return d.set(d.get(a)+c,a)})}});this._zoc=a=b}return a}},enumerable:!0,configurable:!0});b.prototype.mapFor=function(a){if(a&&this.enabled){var b=this.zoc,c=this.maps;c||(this.maps=c=new Na(this.field.depth));var d=a.hex,e=c.rawget(d);null==e&&(e=new Ha(this,a,b[a.team]),c.set(e,d));return e}};
b.prototype.onSkillChanged=function(a){var b=this.maps,c=this.snapshots;b&&b.set(void 0,a.hex);if(c)for(b=0;b<c.length;b++){var d=c[b];d.unit===a&&d.maps.set(void 0,d.hex)}};b.prototype.savepoint=function(a){this.snapshots.push({unit:a,hex:a.hex,SP:a.SP,maps:this.maps,zoc:this.zoc})};b.prototype.rollback=function(){var a=this.snapshots.pop(),b=a.unit;this.setUnit(b,a.hex);b.SP=a.SP;this._zoc=a.zoc;this.maps=a.maps;this.focus=b};b.prototype.setUnit=function(a,b){var c=this.field,d=c.rawget(b);if(null==
d)throw Error("Cannot set unit at "+b+": out of range");var e=d.unit;if(a){if(e===a)return;if(e)throw Error("Cannot set unit at "+b+": already exists");a.hex&&(c.rawget(a.hex).unit=null);a.hex=b}else e&&(e.hex=null);d.unit=a;this.invalidate()};b.prototype.invalidate=function(){this.maps=this.zoc=void 0};b.prototype.startTurn=function(){var a=this;this.eachUnit(function(b){b.onTurnStart(a)});this.enabled=!0;this.controller.visible=!0};b.prototype.retire=function(){var a=this;Ga.confirm(this,e("Combat",
"ConfirmRetire"),{label:e("Combat","Retire"),click:function(){a.controller.visible=!1;(new aa(a,new Ma.Home(a.data))).attach(a.parent)},mnemonic:eb},{label:e("Config","Cancel"),mnemonic:fb})};b.prototype.endTurn=function(){var a=this;this.enabled=!1;this.snapshots.length=0;this.controller.visible=!1;this.eachUnit(function(b){b.onTurnEnd(a)});if(0===this.team){var b=this.numScrollsPerTurn;if(0<b){var c=this.field.minXH+b;this.eachUnit(function(b){b.hex.xH<c&&(b.state=new ua(b,b.HP),a.kill(b))});var d=
this.field.depth;(new B(400*b,function(c){a.scrollTo(d+b*c)})).attach(this);if(this.isGameOver)return}}this.team=0===this.team?1:0;var f=Ca[this.team],g=f.innerStyle,h=f.outerStyle,k=f.textStyle,l=e("Combat",f.messageID);(new B(800,function(a,b){b.save();b.globalAlpha=U(V*a);Ra(b,0,0,1280,560,g,h);Qa(b,l.localized,640,280,k);b.restore()})).then(function(){a.startTurn()}).attach(this)};b.prototype.move=function(a,b){var c=this;Ta(!h(b,a.hex));var d=function(){c.enabled=!0;a.done(c)&&(c.focus=null)};
this.focus=a;var e=this.field,f=this.mapFor(a),g=f.get(b);if(null!=g.deltaHP){this.enabled=!1;g=function(){c.snapshots.length=0;c.invalidate();return a.shoot(c,b).then(d)};if(a.canTarget(e,b))return g();var e=f.getPath(b,e),k=e[e.length-1];Ta(!h(k,b));Ta(!h(k,a.hex));this.setUnit(a,k);a.SP=f.get(k).SP;f=a.state=new Aa(e);g=Ya(g);f.then(g);return g}Ta(0<=g.SP&&e.rawget(b).empty);e=f.getPath(b,e);this.setUnit(a,b);a.SP=g.SP;f=a.state=new Aa(e);d();return n.wait.WALK?f:L};b.prototype.findUnit=function(a,
b,c){var d=this.field,e=d.minXH,f=d.maxXH,g=(0===this.team?b:!b)?1:-1;b=b?1:-1;var h,k;a?(h=a.xH,k=a.yH,a):(h=0>g?e:f-1,k=0>b?0:2);a=1;for(var l=3*(f-e+1);a<l;++a){k+=b;if(0>k||3<=k)k=0>k?2:0,h+=g,h<e?h=f-1:f<=h&&(h=e);var m=d.rawget(h,k).unit;if(m&&c(m))return m}return null};b.prototype.kill=function(a){var b=this;a.HP=0;this.setUnit(null,a.hex);this.dying.push(a);0===a.team&&this.parent&&this.isGameOver&&(this.controller.visible=!1,(a.state||L).then(function(){Ga.confirm(b,e("Combat","GameOver"),
{label:e("Combat","Retire"),click:function(){(new aa(b,new Ma.Home(b.data))).attach(b.parent)},mnemonic:ob})}))};Object.defineProperty(b.prototype,"isGameOver",{get:function(){return null==this.findUnit(null,!0,function(a){return 0===a.team})},enumerable:!0,configurable:!0});b.prototype.createPopup=function(a,b,c){var d=this.toX(c)+64,e=this.toY(c)+80;return new B(600,function(c,f){return Qa(f,a,d,e-40*c,{fontSize:48,fillStyle:b,strokeStyle:"black",globalAlpha:U(V*c),lineWidth:4,textAlign:"center",
textBaseline:"bottom"})})};b.prototype.promiseEffect=function(a,b,c,d){var e=this,f=ab(b).toString(),g=this.createPopup(f,0<b?xa:ta,d||a.hex),h=g.attach;g.attach=function(d){if(0>b||0>c)a.state=new ua(a,-b);a.HP=ca(0,a.maxHP,a.HP+b);null!=c&&(a.SP=ca(0,a.maxSP,a.SP+c));0>=a.HP&&e.kill(a);return h.call(g,d)};return g};b.prototype.eachUnit=function(a){var b=this;this.field.eachVisible(function(c){(c=c.unit)&&a.call(b,c)})};b.prototype.toX=function(a,b){var c;null==b?(d=a,c=d.xH,d):c=a;return 0+64*(c-
1-this.field.depth);var d};b.prototype.toY=function(a,b){var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;return 80+80*(2*b+c%2);var d};b.prototype.toHex=function(a,b){var c=this.field,d=a-0+128*c.depth/2,e=u((b-0-80)/80);if(0<=e&&6>e){var f=void 0,f=0===e%2?2*u((d+64)/128):2*u(d/128)+1;if(c.minXH<=f&&f<c.maxXH)return c=u(e/2),{xH:f,yH:c}}return null};b.prototype.scrollTo=function(a){var b=this.field;if(a>b.depth){var c=b.minVisibleXH,d=b.maxVisibleXH;b.depth=a;a=b.minVisibleXH;for(var e=b.maxVisibleXH;c<
a;++c)b.deleteLine(c);for(c=R(a,d);c<e;++c)b.setLine(c,this.stage.generate(b,c))}};b.prototype.onDraw=function(b,c){this.stage.draw(b,c,this);var d=this.focus,e=this.mapFor(d);e&&this.drawMarkers(b,c,this.focusTime,e,d);a.prototype.onDraw.call(this,b,c)};b.prototype.drawMarkers=function(a,b,c,d,e){var f=this,g=B.clamp(b,c,300);if(!(0>=g)){var h=e.cost;b=e.skill.hostile?ia:ma;var k=b.DASH_OR_RANGE,l=b.RANGE,m=b.TARGET;a.save();1>g&&(a.globalAlpha=g);d.eachVisible(function(b,c,d){var e=b.SP,J=b.shotFrom,
A,K=0,x=0;null!=b.deltaHP?(A=m,K=32*(1-g),x=20*(1-g)):e>=h?A=ga:0<=e?A=J?k:wa:J&&(A=l);A&&(b=f.toX(c,d)-K,c=f.toY(c,d)-x,K=128+2*K,x=80+2*x,a.fillStyle=A.bkgnd,a.fillRect(b+5,c+5,K-10,x-10),a.strokeStyle=A.outer,a.lineWidth=2,a.strokeRect(b+2,c+2,K-4,x-4),a.strokeStyle=A.inner,a.lineWidth=1,a.strokeRect(b+4,c+4,K-8,x-8))});a.restore()}};b.prototype.drawUnits=function(a,b,c){var d=this,f=this.zoc,g=this.focus,h=[];this.eachUnit(function(a){var c=a.getXY(d,b);c.unit=a;h.push(c)});for(var k=0;k<this.dying.length;){var l=
this.dying[k],m=l.getXY(this,b);m?(m.unit=l,h.push(m),++k):this.dying.splice(k,1)}h.sort(ha.compare);k=e("Combat","Done").localized;c=(1-ja(2*V*B.cycle(b,c,1E3)))/2*.5;for(var m=this.mapFor(g),x=0;x<h.length;x++){var n=h[x],l=n.unit,P=n.x,n=n.y,r=void 0;if(m)if(g===l)r="yellow";else{var t=l.hex;t&&(t=m.get(t).deltaHP,0>t?r="red":0<t&&(r="blue"))}l.draw(a,b,P,n,r,c);if(!l.state&&f){var t=l.hex,r=l.SP,u=l.step,w=l.cost,l=l.team;t&&r<w&&(r<u?Qa(a,k,P,n,oa):r<u+f[l].get(t)&&Qa(a,k,P,n,ra))}}};b.prototype.drawBarsOnView=
function(a,b){var c=this;this.eachUnit(function(d){return d.drawBars(a,b,c)})};b.prototype.drawBarsOnFocus=function(a,b,c,d){var e=this,k=this.mapFor(c);if(k){var l=this.field;k.each(function(c,d,f){c=c.deltaHP;null!=c&&l.get(d,f).unit.drawBars(a,b,e,c)});if(d){var m=k.get(d);null!=m.deltaHP?(d=m.shotFrom,h(d,c.hex)?c.drawBars(a,b,this,null,-c.cost):(f(a,b,this,c,c.hex),g(a,b,this,c,d,k.get(d).SP-c.cost))):0<m.SP&&l.get(d).empty?(f(a,b,this,c,c.hex),g(a,b,this,c,d,m.SP)):c.drawBars(a,b,this)}else c.drawBars(a,
b,this)}};b.prototype.drawPanel=function(a,b,c,d){if(c){a.save();switch(c.team){case 0:a.fillStyle="#000044";a.strokeStyle="#CCCCFF";break;case 1:a.fillStyle="#440000";a.strokeStyle="#FFCCCC";break;default:a.fillStyle="#004400",a.strokeStyle="#CCFFCC"}a.fillRect(d.x,d.y,d.w,d.h);a.strokeRect(d.x,d.y,d.w,d.h);a.restore();var e=d.x,f=d.y,g=Fa(c.ch.image,128,128,!0),h=g.w,g=g.h,f=f+(d.h-g)/2;c.ch.image.draw(a,b,{x:e+(128-h)/2,y:f,w:h,h:g});a.save();a.fillStyle="#FFFFFF";a.textAlign="left";a.textBaseline=
"top";a.fillText(c.name,d.x+128,d.y+10);a.fillText("HP: "+c.HP+" / "+c.maxHP,d.x+128,d.y+10+30);b=c.SP>=c.cost?u((c.SP-c.cost)/c.step):"-";a.fillText("SP: "+c.SP+" / "+c.maxSP,d.x+128,d.y+10+60);a.fillText("MOVE: "+b+"/"+u(c.SP/c.step),d.x+128,d.y+10+90);a.fillText("ATK/DEF: "+function(a){return null!=a?a.toFixed(1):"-"}(c.ATK)+" / "+c.DEF.toFixed(1),d.x+128,d.y+10+120);a.restore()}};return b}(O);b.Scene=ba;var Ka=function(b){function c(){b.call(this);this.mode=0}t(c,b);Object.defineProperty(c.prototype,
"caret",{get:function(){return this._caret},set:function(a){this._caret=a;if(0===this.mode){var b=this.parent;b.focus=a?b.field.get(a).unit:null}},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"canUndo",{get:function(){return 0<this.parent.snapshots.length||1<=this.mode},enumerable:!0,configurable:!0});c.prototype.undo=function(){var a=this.parent,b=a.snapshots,c=b.length,b=0<c?b[c-1].unit:null;1<=this.mode&&b!==a.focus?this.mode=0:b?a.rollback():D.error(e("Combat","CannotUndo"));
this.caret=this._caret};c.prototype.onHover=function(a,b){this.caret=this.parent.toHex(a,b)};c.prototype.onDrag=function(a,b){this.caret=this.parent.toHex(a,b)};c.prototype.downCaret=function(a){if(this.caret=a){var b;a:{b=this.parent;var c=this.mode,d=b.focus;if(d){if(d.team===b.team&&!d.done(b)){b=1===c&&h(a,d.hex)?3:2;break a}}else if(a=b.field.get(a).unit,b.focus=a){b=2;break a}b=0}this.mode=b}};c.prototype.onDown=function(a,b){this.downCaret(this.parent.toHex(a,b))};c.prototype.upCaret=function(a){function b(a,
c,d){if(2>c)return c;var e=a.focus;if(null==e||a.team!=e.team)return 0;if(h(d,e.hex))return 2===c?1:0;if(!a.enabled)return c;c=a.mapFor(e).get(d);if(null==c.deltaHP)if(0<=c.SP&&a.field.rawget(d).empty)a.savepoint(e);else return a.focus=null,0;a.move(e,d);return a.focus?1:0}if(this.caret=a)this.mode=b(this.parent,this.mode,a)};c.prototype.onUp=function(a,b){this.upCaret(this.parent.toHex(a,b))};c.prototype.onPress=function(b){function c(b){var d=this.parent.field,e=this.caret;e?(b=a(e,b),d.contains(b)&&
(this.caret=b)):this.caret={xH:d.minXH,yH:0}}function d(a){var b=this.parent,c=this.caret,f=b.team,g=b.focus;(a=b.findUnit(g?g.hex:c,a,function(a){return a.team===f&&!a.done(b)}))?(b.focus=a,null==c&&(this.caret=a.hex),0===this._mode&&(this.mode=1)):D.error(e("Combat","UnitNotAvailable"))}switch(b){case k.TAB:case k.DELETE:case k.Q:this.undo();break;case k.PAGE_DOWN:case k.C:d.call(this,!0);break;case k.PAGE_UP:d.call(this,!1);break;case k.SPACE:case k.ENTER:this.click(this.caret);break;case k.E:c.call(this,
0);break;case k.RIGHT:case k.D:c.call(this,1);break;case k.DOWN:case k.X:case k.S:c.call(this,2);break;case k.Z:c.call(this,3);break;case k.LEFT:case k.A:c.call(this,4);break;case k.UP:case k.W:c.call(this,5)}};c.prototype.click=function(a){this.parent.field.contains(a)&&(this.downCaret(a),this.upCaret(a))};c.prototype.onDraw=function(a,b){function c(a,b,d,e){var f=b.toX(d)+6.5;b=b.toY(d)+6.5;a.save();a.lineCap="round";a.lineJoin="round";a.beginPath();a.moveTo(f+32,b);a.lineTo(f,b);a.lineTo(f,b+20);
a.moveTo(f+115-32,b);a.lineTo(f+115,b);a.lineTo(f+115,b+20);a.moveTo(f+115-32,b+67);a.lineTo(f+115,b+67);a.lineTo(f+115,b+67-20);a.moveTo(f+32,b+67);a.lineTo(f,b+67);a.lineTo(f,b+67-20);a.lineWidth=7;a.strokeStyle=e.outer;a.stroke();a.lineWidth=3;a.strokeStyle=e.inner;a.stroke();a.restore()}function d(a,b,c){a.save();a.lineCap="butt";a.lineJoin="round";var e=c[c.length-2],f=c[c.length-1],g=b.toX(e)+64,h=b.toY(e)+40,e=b.toX(f)+64,f=b.toY(f)+40,g=ub(f-h,e-g);a.beginPath();a.moveTo(e+20*ja(g),f+20*U(g));
a.lineTo(e+20*ja(g+2*V/3),f+20*U(g+2*V/3));a.lineTo(e+20*ja(g-2*V/3),f+20*U(g-2*V/3));a.fillStyle=fa;a.fill();a.beginPath();a.moveTo(e-10*ja(g),f-10*U(g));for(g=c.length-2;0<=g;--g)e=c[g],a.lineTo(b.toX(e)+64,b.toY(e)+40);a.strokeStyle=fa;a.lineWidth=12;a.stroke();a.restore()}var e=this.caret;if(e){var f=this.parent,g=f.focus,h=f.field;if(0===this.mode)c(a,f,e,F);else if(g){var k=f.mapFor(g);if(k){var l=k.get(e);(k=k.getPath(e,h))&&2<=k.length&&d(a,f,k);if(null!=l.deltaHP)switch(g=g.skill,g.target){case 0:c(a,
f,e,T);break;case 1:c(a,f,e,M);break;case 2:h.straight(l.shotFrom,e,g.range,function(b){return c(a,f,b,T)});break;case 3:h.straight(l.shotFrom,e,g.range,function(b){return c(a,f,b,M)});break;case 4:h.surround(l.shotFrom,g.range,function(b){return c(a,f,b,T)});break;case 5:h.surround(l.shotFrom,g.range,function(b){return c(a,f,b,M)})}else 0<=l.SP?c(a,f,e,I):c(a,f,e,F)}}}};return c}(Z),La=function(a){function b(){a.apply(this,arguments);this.running=!1}t(b,a);Object.defineProperty(b.prototype,"visible",
{get:function(){return this.running},set:function(a){var b=this;(this.running=a)&&L.then(function(){return b.run([])})},enumerable:!0,configurable:!0});b.prototype.run=function(a){function b(a,c){var d=a.focus;if(d)return d;var e=a.team,d=c.length,d=0<d?a.findUnit(c[d-1].hex,!1,function(b){return b.team===e&&!b.done(a)&&0>c.indexOf(b)}):a.findUnit(null,!1,function(b){return b.team===e&&!b.done(a)});return a.focus=d}function c(a,b,d){var e=a.field,f=a.numScrollsPerTurn,g=a.mapFor(b),k=e.minXH,l=e.maxXH,
q=b.maxSP,m=b.hex,x=b.cost,r=k+f,P=m,t=w(b,m.xH,m.yH,k,l,r)+40*b.SP/q;g.each(function(a,c,d){var f=a.SP,h=a.deltaHP;a=a.shotFrom;var m;if(null!=h){f=m=w(b,a.xH,a.yH,k,l,r);m=400;var p=e.rawget(c,d).unit,n=-p.trySkill(b),p=p.HP,h=-h,J=b.maxHP;0<n&&0<h&&(m=p<=h?m+600*R(1,n/J):m+600*R(1,n/J)*R(1,h/p));m=f+m;f=g.get(a).SP-x}else if(0<=f&&e.rawget(c,d).empty)m=w(b,c,d,k,l,r);else return;m+=40*f/q;t<m&&(t=m,P={xH:c,yH:d})});if(h(P,m))return d.push(b),a.focus=null;d.length=0;this.caret=P;d=n.wait.PICK;return 0<
d?(f=Ya(function(){return a.move(b,P)}),(new B(d)).then(f).attach(a),f):a.move(b,P)}for(var d=this,e=this.parent,f=null;this.running;){e.enabled||(f=L);if(f){f.then(function(){return d.run(a)});break}this.caret=null;f=b(e,a);if(null==f){e.endTurn();break}f=c.call(this,e,f,a)}};return b}(Z),Xa={Charge:function(a,b,c){c=a.field.get(c).unit;var d=b.trySkill(c),e=a.promiseEffect(c,d);c=new sa(a,b.hex,c.hex);b.state=c;c.hit(function(){e.attach(a)});return n.wait.POPUP?new Ua([e,c]):c},Knockback:function(a,
b,c){var d=a.field,e=r(d,b.hex,c);if(null==e)return Xa.Charge(a,b,c);var f=d.get(c).unit,d=b.trySkill(f),g=a.promiseEffect(f,d,null,e),d=new sa(a,b.hex,f.hex),h=new Aa([c,e]);b.state=d;d.hit(function(){a.setUnit(f,e);f.state=h});h.then(function(){g.attach(a)});return n.wait.POPUP?new Ua([g,d]):d},GoBehind:function(a,b,c){var d=a.field,e=r(d,b.hex,c);if(null==e)return Xa.Charge(a,b,c);var f=b.hex,d=d.get(c).unit,g=b.trySkill(d),h=a.promiseEffect(d,g);c=new Aa([f,c]);a.setUnit(b,e);b.state=c;c.then(function(){h.attach(a)});
return n.wait.POPUP?h:c},Trample:function(a,b,c){var d=a.field,e=r(d,b.hex,c);if(null==e)return Xa.Charge(a,b,c);var f=b.hex,d=d.get(c).unit,g=b.trySkill(d),h=a.promiseEffect(d,g,null,e),f=new Aa([f,c]),g=new Aa([c,c,e]);a.setUnit(d,e);d.state=g;a.setUnit(b,c);b.state=f;g.then(function(){h.attach(a)});return n.wait.POPUP?h:g},Shoot:function(a,b,c){c=a.field.get(c).unit;var d=b.trySkill(c);return E(a,b,c,a.promiseEffect(c,d),l(255,128,0),m(255,128,0,0))},Freeze:function(a,b,c){c=a.field.get(c).unit;
var d=b.trySkill(c),e=u(d/2);return E(a,b,c,a.promiseEffect(c,d,e),l(0,128,255),m(0,128,255,0))},Drain:function(a,b,c){var d=a.field.get(c).unit,e=b.trySkill(d);c=a.promiseEffect(d,e);var f=a.promiseEffect(b,-e);b=z(a,d.hex,b.hex,l(255,0,128),m(255,0,128,0));b.then(function(){f.attach(a)});c.attach(a);return n.wait.POPUP?f:b},Explode:function(a,b,c){var d=a.field.get(c).unit;b.trySkill(d);var d=z(a,b.hex,d.hex,l(255,128,0),m(255,128,0,0)),e=Ya(function(){return S(a,b,c,1,{r:255,g:128,b:0},function(a,
b){return u(a/(1+b))})});d.then(e);return e},Laser:function(a,b,c){var d=a.field,e=b.hex,f,g=[];d.straight(e,c,b.skill.range,function(c){var e=d.get(c).unit;if(b.isTarget(e)){var h=b.trySkill(e),e=a.promiseEffect(e,h);e.attach(a);g.push(e)}f=c});c=new B(400,function(b,c){var d=a.toX(e)+64,g=a.toY(e)+40,h=a.toX(f)+64,k=a.toY(f)+40,l=ub(k-g,h-d),n=64*ja(l),l=40*U(l);c.save();c.beginPath();c.moveTo(d+n,g+l);c.lineTo(h+n,k+l);c.lineCap="round";c.lineWidth=80*b/4;c.strokeStyle=m(255,128,0,1-b);c.stroke();
c.restore()});c.attach(a);return n.wait.POPUP?(g.push(c),new Ua(g)):c},Nova:function(a,b,c){return S(a,b,b.hex,b.skill.range,{r:255,g:128,b:0})}}})(xa||(xa={}));var Ha,n=new (function(){function b(){this._refineCanvas=this._magnifyCanvas=!1;this.volume=new yb(50,0,100);this.effects=new yb(Ja.length-1,0,Ja.length-1)}Object.defineProperty(b.prototype,"magnifyCanvas",{get:function(){return this._magnifyCanvas},set:function(a){this._magnifyCanvas!=a&&(this._magnifyCanvas=a,window.dispatchEvent(new UIEvent("resize")))},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"refineCanvas",{get:function(){return this._refineCanvas},set:function(a){this._refineCanvas!=a&&(this._refineCanvas=a,window.dispatchEvent(new UIEvent("resize")))},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"wait",{get:function(){return Ja[this.effects.value]},enumerable:!0,configurable:!0});return b}());System.main=function(b,a){var c=new Image;c.src="assets/dummy.png";N.DUMMY=c;var c=new O,e=new O;e.attach(c);
var d=new Jb(10,10,1260,700,2E3,Hb);d.attach(c);D=d;Ha=function(){for(;;){var a=e.children,b=a.length;if(0===b)break;a[b-1].detach()}(new vb(new gb.Scene)).attach(e)};Gb();Ha();Cb(b,c,n)};System.checkpoint=function(){tb()}})();
