var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(k,w,r){k!=Array.prototype&&k!=Object.prototype&&(k[w]=r.value)};$jscomp.getGlobal=function(k){return"undefined"!=typeof window&&window===k?k:"undefined"!=typeof global&&null!=global?global:k};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(k,w,r,v){if(w){r=$jscomp.global;k=k.split(".");for(v=0;v<k.length-1;v++){var D=k[v];D in r||(r[D]={});r=r[D]}k=k[k.length-1];v=r[k];w=w(v);w!=v&&null!=w&&$jscomp.defineProperty(r,k,{configurable:!0,writable:!0,value:w})}};$jscomp.underscoreProtoCanBeSet=function(){var k={a:!0},w={};try{return w.__proto__=k,w.a}catch(r){}return!1};
$jscomp.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(k,w){k.__proto__=w;if(k.__proto__!==w)throw new TypeError(k+" is not extensible");return k}:null;$jscomp.polyfill("Object.setPrototypeOf",function(k){return k||$jscomp.setPrototypeOf},"es6","es5");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};
$jscomp.Symbol=function(){var k=0;return function(w){return $jscomp.SYMBOL_PREFIX+(w||"")+k++}}();$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var k=$jscomp.global.Symbol.iterator;k||(k=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[k]&&$jscomp.defineProperty(Array.prototype,k,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};
$jscomp.arrayIterator=function(k){var w=0;return $jscomp.iteratorPrototype(function(){return w<k.length?{done:!1,value:k[w++]}:{done:!0}})};$jscomp.iteratorPrototype=function(k){$jscomp.initSymbolIterator();k={next:k};k[$jscomp.global.Symbol.iterator]=function(){return this};return k};
$jscomp.iteratorFromArray=function(k,w){$jscomp.initSymbolIterator();k instanceof String&&(k+="");var r=0,v={next:function(){if(r<k.length){var D=r++;return{value:w(D,k[D]),done:!1}}v.next=function(){return{done:!0,value:void 0}};return v.next()}};v[Symbol.iterator]=function(){return v};return v};$jscomp.polyfill("Array.prototype.keys",function(k){return k?k:function(){return $jscomp.iteratorFromArray(this,function(k){return k})}},"es6","es3");
$jscomp.findInternal=function(k,w,r){k instanceof String&&(k=String(k));for(var v=k.length,D=0;D<v;D++){var ca=k[D];if(w.call(r,ca,D,k))return{i:D,v:ca}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(k){return k?k:function(k,r){return $jscomp.findInternal(this,k,r).v}},"es6","es3");$jscomp.polyfill("Array.prototype.findIndex",function(k){return k?k:function(k,r){return $jscomp.findInternal(this,k,r).i}},"es6","es3");
$jscomp.polyfill("Array.prototype.fill",function(k){return k?k:function(k,r,v){var w=this.length||0;0>r&&(r=Math.max(0,w+r));if(null==v||v>w)v=w;v=Number(v);0>v&&(v=Math.max(0,w+v));for(r=Number(r||0);r<v;r++)this[r]=k;return this}},"es6","es3");
$jscomp.checkStringArgs=function(k,w,r){if(null==k)throw new TypeError("The 'this' value for String.prototype."+r+" must not be null or undefined");if(w instanceof RegExp)throw new TypeError("First argument to String.prototype."+r+" must not be a regular expression");return k+""};
$jscomp.polyfill("String.prototype.endsWith",function(k){return k?k:function(k,r){var v=$jscomp.checkStringArgs(this,k,"endsWith");k+="";void 0===r&&(r=v.length);r=Math.max(0,Math.min(r|0,v.length));for(var w=k.length;0<w&&0<r;)if(v[--r]!=k[--w])return!1;return 0>=w}},"es6","es3");
(function(){function k(a,b,c){return a?a.find(b,c):void 0}function w(a,b,c){return a?a.findIndex(b,c):-1}function r(a,b,c){return a?a.map(b,c):void 0}function v(a,b,c){return c<a?a:c>b?b:c}function D(a,b){return null!=a?a:b}function ca(a){return A(Za()*a)}function ta(a){return a.map(function(a){return null!=a?a.toJSON():void 0})}function P(a,b){return b.map(function(c){return null!=c?a.fromJSON(c):void 0})}function Ia(a){return void 0===a?"(undefined)":null===a?"(null)":a.toString()}function Ja(a){for(var b=
[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];return a.replace(/\$\{(\d+)\}/g,function(c,a){return Ia(b[parseInt(a,10)])})}function Ka(a,b,c){return Object.defineProperty(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c})}function ua(a,b,c,e){return Object.defineProperty(a,b,{enumerable:!0,configurable:!0,get:c,set:e})}function zb(a,b){var c=document.createElement("script");c.src=a;c.onerror=b;document.head.appendChild(c)}function ka(a,b){if(a===b)return 0;if(void 0===a&&void 0!==b)return-1;
if(void 0!==a&&void 0===b)return 1;if(null===a&&null!==b)return-1;if(null!==a&&null===b)return 1;var c=typeof a,e=typeof b;if(c!==e)return c<e?-1:1;if("object"===c){if(a instanceof Date&&b instanceof Date)return ka(a.getTime(),b.getTime());if(a instanceof Array&&b instanceof Array){a:{c=a.length;e=b.length;for(var l=0,n=V(c,e);l<n;++l){var t=ka(a[l],b[l]);if(0!==t){a=t;break a}}a=c<e?-1:c>e?1:0}return a}c=a.constructor;if(c===b.constructor){e=a.compare;if("function"===typeof e&&e===b.compare){c=a.compare(b);
if("number"!==typeof c)throw new TypeError('Cannot compare "'+a+'" and "'+b+'": operator returns non-number "'+c+'"');return c}if(c===Object){a:{c=La(a).sort();e=La(b).sort();l=c.length;n=e.length;t=V(l,n);for(var d=0;d<t;++d){var g=c[d],f=e[d];if(g<f||g>f){a=-1;break a}g=ka(a[g],b[f]);if(0!==g){a=g;break a}}a=l<n?-1:l>n?1:0}return a}}throw new TypeError('Cannot compare "'+a+'" and "'+b+'": not supported');}return a<b?-1:a>b?1:0}function va(a,b){return(a||24)+"px "+(b||"Arial")}function la(a,b){if(a){if("function"===
typeof a)return[a,b];a.push(b);return a}return b}function da(a){if(a)if("function"===typeof a)N.then(a);else for(var b=0;b<a.length;b++)N.then(a[b])}function wa(a){for(var b,c=a.length,e=0;e<a.length;e++)a[e].then(function(){0>=--c&&(da(b),b=void 0)});return{then:function(a){0<c?b=la(b,a):N.then(a);return this}}}function hb(a){function b(c){N.then(c);return this}var c,e=function(){a().then(function(){da(c);c=void 0;e.then=b})};e.then=function(a){c=la(c,a);return this};return e}function g(){for(var a=
[],b=0;b<arguments.length;b++)a[b]=arguments[b];return new L(a)}function Bb(a,b,c){function e(c){return(c.pageX-a.offsetLeft)*k/a.offsetWidth}function l(c){return(c.pageY-a.offsetTop)*m/a.offsetHeight}function n(c){if(c.buttons&1)b.onDrag(e(c),l(c));else b.onHover(e(c),l(c));c.preventDefault()}function t(c){switch(c.button){case 0:b.onDown(e(c),l(c))}c.preventDefault()}function d(c){switch(c.button){case 0:b.onUp(e(c),l(c));break;case 2:b.onPress(p.TAB)}c.preventDefault()}function g(){S&&clearTimeout(S);
S=setTimeout(function(){S=void 0;var b=a.parentElement;if(b){var e=b.clientWidth;b=b.clientHeight;b-=a.offsetTop;0<b&&(c.magnifyCanvas||(e=V(e,k),b=V(b,m)),e*m>k*b?e=xa(b*k/m):b=xa(e*m/k),0<e&&0<b&&(a.style.width=e+"px",a.style.height=b+"px",!c.refineCanvas&&(e>k||b>m)&&(e=k,b=m),a.width!==e||a.height!==b))&&(a.width=e,a.height=b)}},300)}function f(c){N.finish();var e=a.width,l=a.height,n=a.getContext("2d");n&&(n.clearRect(0,0,e,l),n.save(),n.font=va(),e===k&&l===m||n.scale(e/k,l/m),b.onDraw(n,c),
n.restore());window.requestAnimationFrame(f)}var k=a.width,m=a.height;a.addEventListener("mousemove",n);a.addEventListener("touchmove",n);a.addEventListener("mousedown",t);a.addEventListener("touchstart",t);a.addEventListener("mouseup",d);a.addEventListener("touchend",d);a.addEventListener("contextmenu",function(c){c.preventDefault()});a.addEventListener("mousewheel",function(c){b.onPress(0<c.wheelDelta?p.PAGE_UP:p.PAGE_DOWN);c.preventDefault()});window.addEventListener("keydown",function(c){if(!c.ctrlKey&&
!c.altKey){var a=D(c.keyCode,c.charCode);a&&p[a]&&(b.onPress(a),c.preventDefault())}});var S;window.addEventListener("resize",g);"complete"===document.readyState?g():window.addEventListener("load",g);window.requestAnimationFrame(f)}function Ma(a,b,c,e){void 0===e&&(e=!1);var l=a.w;a=a.h;if(l>b||a>c||e){e=l/b;var n=a/c;e>n?(l=b,a/=e):(l/=n,a=c)}return{w:l,h:a}}function $a(a,b){if(b)for(var c in b)switch(c){case "fontSize":a.font=va(b.fontSize,b.fontFamily);break;case "fontFamily":b.fontSize||(a.font=
va(void 0,b.fontFamily));break;default:c in a&&(a[c]=b[c])}}function ya(a,b,c,e,l,n){if(null==e||null==l){l=b;b=l.x;var t=l.y;e=l.w;l=l.h;n=c}else t=c;if(0<e&&0<l){a.save();$a(a,n);n&&!n.fillStyle||a.fillRect(b,t,e,l);if(!n||n.strokeStyle)c=a.lineWidth-1,a.strokeRect(b+c/2,t+c/2,e-c,l-c);a.restore()}}function za(a,b,c,e,l){function n(c,a,b,e,l){l&&!l.strokeStyle||c.strokeText(a,b,e);l&&!l.fillStyle||c.fillText(a,b,e)}a.save();$a(a,l);if(0>b.indexOf("\n"))n(a,b,c,e,l);else{var t=b.split("\n");b=1.2*
(l&&l.fontSize||24);switch(a.textBaseline){case "top":for(var d=0;d<t.length;d++){var g=t[d];n(a,g,c,e,l);e+=b}break;case "middle":e-=b*(t.length-1)/2;for(d=0;d<t.length;d++)g=t[d],n(a,g,c,e,l),e+=b;break;case "bottom":for(d=0,t=t.reverse();d<t.length;d++)g=t[d],n(a,g,c,e,l),e-=b}}a.restore()}function ea(a,b,c,e,l,n,d){a.save();$a(a,d);switch(a.textAlign){case "center":c+=l/2;break;case "right":c+=l}if(0>b.indexOf("\n")){switch(a.textBaseline){case "middle":e+=n/2;break;case "bottom":e+=n}d&&!d.strokeStyle||
a.strokeText(b,c,e,l);d&&!d.fillStyle||a.fillText(b,c,e,l)}else{b=b.split("\n");var t=1.2*(d&&d.fontSize||24);switch(a.textBaseline){case "middle":e+=(n-t*(b.length-1))/2;break;case "bottom":e=e+n-t*(b.length-1)}for(n=0;n<b.length;n++){var g=a,f=b[n],k=c,m=e,S=l,p=d;p&&!p.strokeStyle||g.strokeText(f,k,m,S);p&&!p.fillStyle||g.fillText(f,k,m,S);e+=t}}a.restore()}function ib(a,b,c,e,l,n,d){a=a.createLinearGradient(b,c,e,l);a.addColorStop(0,n);a.addColorStop(1,d);return a}function Aa(a,b,c,e,l,n,d){0<
e&&0<l&&(a.save(),a.fillStyle=ib(a,b,c,b,c+l,n,d),a.fillRect(b,c,e,l),a.restore())}function ab(a,b,c,e,l,n,d,g){void 0===g&&(g=0);0<e&&0<l&&(a.save(),a.translate(b+e/2,c+l/2),a.scale(e,l),b=a.createRadialGradient(0,0,g/2,0,0,.5),b.addColorStop(0,n),b.addColorStop(1,d),a.fillStyle=b,a.fillRect(-.5,-.5,1,1),a.restore())}function jb(a,b){return a.toFixed(b).replace(/([0-9]+(\.[0-9]+[1-9])?)(\.?0+$)/,"$1")}function m(a,b,c){return"rgb("+a+","+b+","+c+")"}function y(a,b,c,e){return"rgba("+a+","+b+","+
c+","+jb(e,6)+")"}function Na(a,b){return null==b?m(a.r,a.g,a.b):y(a.r,a.g,a.b,b)}function Oa(a){for(var b=0,c=0;c<a.length;c++)b|=1<<a[c];return b}function f(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];return{tags:a,bits:Oa(a)}}function Ba(a){return a.tags.map(function(a){return Cb[a].localized}).join(", ")}function kb(a){var b={fillStyle:"white",strokeStyle:"black",fontSize:44,textAlign:"center",textBaseline:"middle"},c={textAlign:"right",textBaseline:"middle"},e={textAlign:"right",
textBaseline:"middle"},l=new I(4,4,32,32,new J("assets/config.png"),function(){function l(a,b){a=100+70*a;(new K(640,a,160,60,new E(b,c))).attach(m);return a}function d(c,a,b){c=l(c,a);a=new Db(810,c+15,300,30,b);a.attach(m);(new K(1120,c,50,60,new E(b,e))).attach(m);return a}function f(c,a,b,e,n,d){c=l(c,a);var t=new I(810,c+0,100,60,new E(function(){var c=n();t.pressed&&t.hover&&(c=!c);return(c?b:e).localized}),d);t.attach(m);return t}var m=new Pa;(new K(0,0,1280,720,new lb(Qa))).attach(m);(new K(0,
20,1280,80,new E(g("Config","Caption"),b))).attach(m);(new I(480,495,320,90,new E(g("Config","OK")),function(){return m.detach()},tb)).attach(m);var p=La(L.languages).sort().map(function(c){return g("Language",c)}),r=new F(10,10,160,F.heightOf(V(10,p.length)),[{name:g("Config","LanguageID"),extract:function(c){return c.src[1]},width:40,align:"center"},{name:g("Config","LanguageName"),extract:function(c){return c.localized}}],p,function(c){r.selected=c;L.language=c.src[1]});r.selected=k(r.rows,function(c){return c.src[1]===
L.language});r.attach(m);d(0,g("Config","Volume"),x.volume);d(1,g("Config","CPUEffects"),x.effects);p=g("Config","On");var v=g("Config","Off");f(2,g("Config","MagnifyCanvas"),p,v,function(){return x.magnifyCanvas},function(){x.magnifyCanvas=!x.magnifyCanvas});f(3,g("Config","RefineCanvas"),p,v,function(){return x.refineCanvas},function(){x.refineCanvas=!x.refineCanvas});(function(c,a,b){c=new I(810,70*c+100,300,60,new E(a),b);c.attach(m);return c})(4,g("Config","BackToTitle"),function(){m.detach();
Ra()});m.attach(a)},Eb,new I.IconDesign("white"));l.attach(a);return l}function Sa(){try{var a=System.getRoamingStorage("NYO");if(a){var b=Ta(a);return{shop:b.shop||{},warehouse:P(fa,b.warehouse),reservers:P(ba,b.reservers),party:P(ba,b.party),gold:b.gold||0}}}catch(c){G.error(c)}}function Ua(a){try{System.setRoamingStorage("NYO",bb(a))}catch(b){G.error(b)}cb()}function Fb(){function a(c,a){return typeof c===typeof a?a:c}try{var b=System.getLocalStorage("NYO");if(b){var c=Ta(b);c&&(L.language=a(L.language,
c.language),x.magnifyCanvas=a(x.magnifyCanvas,c.magnifyCanvas),x.refineCanvas=a(x.refineCanvas,c.refineCanvas),x.volume.value=a(x.volume.value,c.volume),x.effects.value=a(x.effects.value,c.effects))}}catch(e){G.error(e)}}function cb(){try{System.setLocalStorage("NYO",bb({language:L.language,magnifyCanvas:x.magnifyCanvas,refineCanvas:x.refineCanvas,volume:x.volume.value,effects:x.effects.value}))}catch(a){G.error(a)}}var z=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof
Array&&function(a,c){a.__proto__=c}||function(a,c){for(var b in c)c.hasOwnProperty(b)&&(a[b]=c[b])};return function(b,c){function e(){this.constructor=b}a(b,c);b.prototype=null===c?Object.create(c):(e.prototype=c.prototype,new e)}}(),La=Object.keys,na=Math.abs,V=Math.min,W=Math.max,A=Math.floor,mb=Math.ceil,xa=Math.round,Ca=Math.pow,X=Math.sin,oa=Math.cos,ub=Math.atan2,Y=Math.PI,Za=Math.random,Ta=JSON.parse,bb=JSON.stringify,ha=function(){},db=function(){function a(a,c){this.min=a;this.max=c}a.prototype.map=
function(a,c){for(var b=this.min,l=this.max,n=Array(l-b);b<l;++b)n[b]=a.call(c,b);return n};a.prototype.toArray=function(){for(var a=this.min,c=this.max,e=Array(c-a);a<c;++a)e[a]=a;return e};return a}(),N=new (function(){function a(){}a.prototype.then=function(a){this.sig=la(this.sig,a);return this};a.prototype.finish=function(){var a=this.sig;if(a)if(this.sig=void 0,"function"===typeof a)a();else for(var c=0;c<a.length;c++)(0,a[c])()};return a}()),L=function(){function a(a){this.src=a}Object.defineProperty(a.prototype,
"localized",{get:function(){function b(c){var b=a.languages,e=a.language,d=b[e];if(void 0===d)e in b||(e=a.language=a.fallback,d=b[e]),b[e]=!0,zb(a.path+e+".js",function(){b[e]=!1});else if(!0!==d){if(!1===d)return c.join(".");var g=d;d=0;for(var f=c.length;d<f;++d)if(g=g[c[d]],!g)return c.join(".");return g.toString()}}if(this._language!==a.language){var c=b(this.src);c&&(this._language=a.language,this._localized=c)}return this._localized||this.src.join(".")},enumerable:!0,configurable:!0});a.prototype.toString=
function(){return this.localized};a.prototype.compare=function(a){return ka(this.localized,a.localized)};a.language=window.navigator.language.substr(0,2);a.fallback="en";a.path="";a.languages={};return a}();System.localize=function(a,b){L.languages[a]=b};var p;(function(a){a[a.BACKSPACE=8]="BACKSPACE";a[a.TAB=9]="TAB";a[a.ENTER=13]="ENTER";a[a.ESCAPE=27]="ESCAPE";a[a.SPACE=32]="SPACE";a[a.PAGE_UP=33]="PAGE_UP";a[a.PAGE_DOWN=34]="PAGE_DOWN";a[a.END=35]="END";a[a.HOME=36]="HOME";a[a.LEFT=37]="LEFT";
a[a.UP=38]="UP";a[a.RIGHT=39]="RIGHT";a[a.DOWN=40]="DOWN";a[a.DELETE=46]="DELETE";a[a.$0=48]="$0";a[a.$1=49]="$1";a[a.$2=50]="$2";a[a.$3=51]="$3";a[a.$4=52]="$4";a[a.$5=53]="$5";a[a.$6=54]="$6";a[a.$7=55]="$7";a[a.$8=56]="$8";a[a.$9=57]="$9";a[a.A=65]="A";a[a.B=66]="B";a[a.C=67]="C";a[a.D=68]="D";a[a.E=69]="E";a[a.F=70]="F";a[a.G=71]="G";a[a.H=72]="H";a[a.I=73]="I";a[a.J=74]="J";a[a.K=75]="K";a[a.L=76]="L";a[a.M=77]="M";a[a.N=78]="N";a[a.O=79]="O";a[a.P=80]="P";a[a.Q=81]="Q";a[a.R=82]="R";a[a.S=83]=
"S";a[a.T=84]="T";a[a.U=85]="U";a[a.V=86]="V";a[a.W=87]="W";a[a.X=88]="X";a[a.Y=89]="Y";a[a.Z=90]="Z"})(p||(p={}));var ia=function(){function a(){}a.prototype.onHover=function(a,c){};a.prototype.onDrag=function(a,c){};a.prototype.onDown=function(a,c){};a.prototype.onUp=function(a,c){};a.prototype.onPress=function(a){};a.prototype.onDraw=function(a,c){};a.prototype.attach=function(a){return a.onAttach(this)};a.prototype.detach=function(){var a=this.parent;if(a)return a.onDetach(this),a};Object.defineProperty(a.prototype,
"visible",{get:function(){return!0},set:function(a){Ka(this,"visible",a)},enumerable:!0,configurable:!0});return a}(),T=function(a){function b(c){var b=a.call(this)||this;b.children=[];if(c)for(var l=0;l<c.length;l++)c[l].attach(b);return b}z(b,a);b.prototype.onAttach=function(c){if(c.parent===this)return!1;this.children.push(c);c.parent=this;return!0};b.prototype.onDetach=function(c){if(!c.parent)return!1;c.parent=void 0;for(var a=this.children,b=0;b<a.length;++b)if(a[b]===c){c=this.children;a=c.length;
for(var d=Array(a-1),t=0;t<b;++t)d[t]=c[t];for(t=b+1;t<a;++t)d[t-1]=c[t];this.children=d;break}return!0};b.prototype.onHover=function(c,a){for(var b=0,e=this.children;b<e.length;b++){var d=e[b];if(d.visible)d.onHover(c,a)}};b.prototype.onDrag=function(c,a){for(var b=0,e=this.children;b<e.length;b++){var d=e[b];if(d.visible)d.onDrag(c,a)}};b.prototype.onDown=function(c,a){for(var b=0,e=this.children;b<e.length;b++){var d=e[b];if(d.visible)d.onDown(c,a)}};b.prototype.onUp=function(a,b){for(var c=0,
e=this.children;c<e.length;c++){var d=e[c];if(d.visible)d.onUp(a,b)}};b.prototype.onPress=function(a){for(var c=0,b=this.children;c<b.length;c++){var d=b[c];if(d.visible)d.onPress(a)}};b.prototype.onDraw=function(a,b){for(var c=0,e=this.children;c<e.length;c++){var d=e[c];if(d.visible)d.onDraw(a,b)}};return b}(ia),lb=function(){function a(a){this.rectStyle=a}a.prototype.draw=function(a,c,e){ya(a,e,this.rectStyle)};return a}(),E=function(){function a(a,c,e){this.value=a;this.textStyle=c;this.rectStyle=
e;c&&c.fillStyle&&c.textAlign&&c.textBaseline||(a=Object.create(c||null),c&&c.fillStyle||(a.fillStyle="white"),c&&c.textAlign||(a.textAlign="center"),c&&c.textBaseline||(a.textBaseline="middle"),this.textStyle=a)}a.prototype.draw=function(a,c,e){c=e.x;var b=e.y,d=e.w;e=e.h;this.rectStyle&&ya(a,c,b,d,e,this.rectStyle);ea(a,this.text,c,b,d,e,this.textStyle)};Object.defineProperty(a.prototype,"text",{get:function(){var a=this.value;"function"===typeof a&&(a=a());return Ia(a)},enumerable:!0,configurable:!0});
return a}(),J=function(){function a(a){this.src=a;this._image=void 0}a.from=function(b){var c=new a;c._image=b;return c};a.prototype.then=function(a){this._image?N.then(a):(this.sig=la(this.sig,a),this.preload());return this};a.prototype.preload=function(){var b=this;if(void 0===this._image&&this.src){this._image=null;var c=new Image;c.addEventListener("load",function(){b._image=c;da(b.sig);b.sig=void 0});c.addEventListener("error",function(){b._image=a.DUMMY;da(b.sig);b.sig=void 0});c.src=this.src}};
Object.defineProperty(a.prototype,"image",{get:function(){void 0===this._image&&this.preload();return this._image},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"w",{get:function(){var a=this.image;return a?a.width:1},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"h",{get:function(){var a=this.image;return a?a.height:1},enumerable:!0,configurable:!0});a.prototype.draw=function(a,c,e,l,d){c=this.image;var b=e.x,n=e.y,g=e.w;e=e.h;c&&0<g&&0<e&&(!l||null==d||0>=
d?a.drawImage(c,b,n,g,e):(a.save(),a.globalCompositeOperation="destination-out",a.drawImage(c,b,n,g,e),a.globalCompositeOperation="destination-over",a.fillStyle=l,a.fillRect(b,n,g,e),1>d&&(a.globalCompositeOperation="source-over",a.globalAlpha=1-d,a.drawImage(c,b,n,g,e)),a.restore()))};a.DUMMY=null;return a}(),Gb={fontSize:32,fillStyle:"white",strokeStyle:"black",textAlign:"left",textBaseline:"top",lineWidth:2},Qa={fillStyle:y(0,0,0,.8)},Hb={fillStyle:"white",strokeStyle:"black",fontSize:44,textAlign:"center",
textBaseline:"middle"},O=function(a){function b(c,b){var e=a.call(this)||this;e.duration=c;b&&(e.onAnimation=b);return e}z(b,a);b.prototype.attach=function(c){return a.prototype.attach.call(this,c)?(this.start=performance.now(),!0):!1};b.prototype.detach=function(){this.start=void 0;return a.prototype.detach.call(this)};b.prototype.onDraw=function(a,b){var c=this.start;c&&(b>=c+this.duration?(this.onAnimation(1,a,b),this.detach(),da(this.sig),this.sig=void 0):(c=W(0,b-c)/this.duration,this.onAnimation(c,
a,b)))};b.prototype.onAnimation=function(a,b,l){};b.prototype.then=function(a){this.sig=la(this.sig,a);return this};b.clamp=function(a,b,l){return!b||a<b?0:!l||b+l<a?1:(a-b)/l};b.cycle=function(a,b,l){return!b||!l||a<b?0:(a-b)%l/l};return b}(ia),eb=function(a){function b(c,b){void 0===b&&(b=400);b=a.call(this,b)||this;b.next=c;return b}z(b,a);b.prototype.onAnimation=function(a,b,l){if(1>a){if(0<a)this.next.onDraw(b,l);b.save();b.globalAlpha=1-a;b.fillStyle="black";b.fillRect(0,0,1280,720);b.restore()}else this.next.attach(this.parent)};
return b}(O),U=function(a){function b(c,b,l){void 0===l&&(l=400);l=a.call(this,l)||this;l.prev=c;l.next=b;return l}z(b,a);b.go=function(a,e,l){void 0===l&&(l=400);(new b(a,e,l)).attach(a.parent)};b.prototype.attach=function(c){return a.prototype.attach.call(this,c)?(this.prev.detach(),!0):!1};b.prototype.onAnimation=function(a,b,l){1>a?(this.prev.onDraw(b,l),0<a&&(b.save(),b.globalAlpha=a,b.fillStyle="black",b.fillRect(0,0,1280,720),b.restore())):this.next&&(new eb(this.next,this.duration)).attach(this.parent)};
return b}(O),Pa=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}z(b,a);b.prototype.attach=function(c){return!this.prev&&c.parent&&a.prototype.attach.call(this,c.parent)?(c.detach(),this.prev=c,!0):!1};b.prototype.detach=function(){var c=a.prototype.detach.call(this);c&&this.prev.attach(c);return c};b.prototype.onDraw=function(c,b){this.prev.onDraw(c,b);a.prototype.onDraw.call(this,c,b)};b.confirm=function(a,e){for(var c=[],d=2;d<arguments.length;d++)c[d-2]=arguments[d];var t=
new b;(new K(0,0,1280,720,new E(e,Hb,Qa))).attach(t);d=c.length;for(var g=1280/(3+d),f=g/8,k=(1280-g*d-f*(d-1))/2,m=function(a){var b=c[a],e=b.click,d=b.mnemonic;(new I(k+(g+f)*a,495,g,90,new E(b.label),e?function(){t.detach();e()}:function(){t.detach()},d)).attach(t)},p=0;p<d;++p)m(p);t.attach(a);return t};return b}(T),pa=function(a){function b(c,b,d,n){var e=a.call(this)||this;e.x=c;e.y=b;e.w=d;e.h=n;return e}z(b,a);b.prototype.contains=function(a,b){return this.visible&&this.x<=a&&this.y<=b&&a<
this.x+this.w&&b<this.y+this.h};Object.defineProperty(b.prototype,"left",{get:function(){return this.x},set:function(a){this.w=this.w+this.x-a;this.x=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"right",{get:function(){return this.x+this.w},set:function(a){this.w=a-this.x},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"top",{get:function(){return this.y},set:function(a){this.h=this.h+this.y-a;this.y=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"bottom",{get:function(){return this.y+this.h},set:function(a){this.h=a-this.y},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"center",{get:function(){return{x:this.x+this.w/2,y:this.y+this.h/2}},enumerable:!0,configurable:!0});b.prototype.moveTo=function(a,b){this.x=a;this.y=b;return this};b.prototype.moveBy=function(a,b){this.x+=a;this.y+=b;return this};return b}(ia),K=function(a){function b(c,b,d,n,t){c=a.call(this,c,b,d,n)||this;c.drawable=t;return c}z(b,a);b.prototype.onDraw=
function(a,b){this.drawable.draw(a,b,this)};return b}(pa),I=function(a){function b(c,e,d,n,t,g,f,k){void 0===k&&(k=b.defaultDesign);c=a.call(this,c,e,d,n)||this;c.drawable=t;c.click=g;c.mnemonic=f;c.design=k;c.hover=!1;return c}z(b,a);Object.defineProperty(b.prototype,"enabled",{get:function(){return!0},set:function(a){Ka(this,"enabled",a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"state",{get:function(){return this.enabled?this.pressed?2:this.hover?1:0:3},enumerable:!0,configurable:!0});
b.prototype.onHover=function(a,b){this.hover=this.contains(a,b);this.pressed=void 0};b.prototype.onDrag=function(a,b){null!=this.pressed&&(this.pressed=this.contains(a,b))};b.prototype.onDown=function(a,b){this.enabled&&this.contains(a,b)&&(this.pressed=!0)};b.prototype.onUp=function(a,b){var c=this.pressed;this.pressed=void 0;if(c&&this.contains(a,b))this.onClick()};b.prototype.onPress=function(a){this.mnemonic&&0<=this.mnemonic.indexOf(a)&&this.enabled&&(this.pressed=!1,this.onClick())};b.prototype.onClick=
function(){var a=this,b=this.click;b&&N.then(function(){return b.call(a)})};b.prototype.onDraw=function(a,b){this.design.draw(a,b,this)};b.defaultDesign={draw:function(a,e,d){ya(a,d,b.defaultDesign.getStyle(d.state));d.drawable&&d.drawable.draw(a,e,d)},getStyle:function(a){var b={};switch(a){case 0:b.fillStyle=y(0,0,0,.8);b.strokeStyle=m(200,200,200);break;case 1:b.fillStyle=y(0,0,50,.8);b.strokeStyle=m(100,100,200);break;case 2:b.fillStyle=y(0,0,150,.8);b.strokeStyle=m(100,100,255);break;case 3:b.fillStyle=
y(200,200,200,.8),b.strokeStyle=m(200,200,200)}return b}};b.IconDesign=function(){function a(a){this.overlay=a}a.prototype.draw=function(a,b,c){var e=c.drawable;switch(c.state){case 0:e.draw(a,b,c);break;case 1:e.draw(a,b,c,this.overlay,.7);break;case 2:e.draw(a,b,c,this.overlay,.9);break;case 3:e.draw(a,b,c,m(200,200,200),.8)}};return a}();return b}(pa),Ib=function(a){function b(b,e,d,n,g,f,k,m,p,r){void 0===r&&(r=I.defaultDesign);b=a.call(this,b,e,d,n,f,k,p,r)||this;b.group=g;b.swap=m;g.push(b);
return b}z(b,a);b.prototype.onDrag=function(b,e){var c=this;a.prototype.onDrag.call(this,b,e);var d=this.dragged,g=this.swapping;if(d&&!g){var f=k(this.group,function(a){return a!==c&&a.contains(b,e)&&!a.swapping});f?(d=performance.now(),this.onSwap(f,d),f.onSwap(this,d),g=this.swapping,this.dragged={xOrig:g.xTo,yOrig:g.yTo},this.swap&&this.swap(f)):null!=d.xDown&&null!=d.yDown?(this.x=d.xOrig-d.xDown+b,this.y=d.yOrig-d.yDown+e):this.contains(b,e)?(d.xDown=b,d.yDown=e):(this.pressed=this.dragged=
void 0,this.hover=!1)}};b.prototype.onDown=function(b,e){a.prototype.onDown.call(this,b,e);!this.dragged&&this.contains(b,e)&&(this.dragged={xDown:b,yDown:e,xOrig:this.x,yOrig:this.y})};b.prototype.onUp=function(b,e){if(this.swapping)this.dragged=void 0,a.prototype.onUp.call(this,b,e);else if(this.dragged){var c=this.dragged,d=c.xOrig;c=c.yOrig;this.swapping={start:performance.now(),xFrom:this.x,yFrom:this.y,xTo:d,yTo:c};this.dragged=void 0;if(this.pressed&&(this.pressed=void 0,this.contains(b,e)&&
d<=b&&c<=e&&b<d+this.w&&e<c+this.h))this.onClick()}else a.prototype.onUp.call(this,b,e)};b.prototype.onSwap=function(a,b){this.pressed=void 0;this.swapping={start:b,xFrom:this.x,yFrom:this.y,xTo:a.dragged?a.dragged.xOrig:a.x,yTo:a.dragged?a.dragged.yOrig:a.y}};b.prototype.onDraw=function(b,e){if(this.swapping){var c=O.clamp(e,this.swapping.start,200);1>c?(c=(1-oa(Y*c))/2,this.x=this.swapping.xFrom*(1-c)+this.swapping.xTo*c,this.y=this.swapping.yFrom*(1-c)+this.swapping.yTo*c):(this.x=this.swapping.xTo,
this.y=this.swapping.yTo,this.swapping=void 0)}a.prototype.onDraw.call(this,b,e)};return b}(I),F=function(a){function b(c,e,d,n,g,f,k,m){void 0===m&&(m=b.defaultDesign);c=a.call(this,c,e,d,n)||this;c.columns=g;c.rows=f;c.click=k;c.design=m;c.topRow=0;return c}z(b,a);b.heightOf=function(a,e){void 0===e&&(e=b.defaultDesign);return e.headerHeight+a*e.rowHeight};b.prototype.onHover=function(a,b){this.hover=this.toRowIndex(a,b);this.scrolling=this.dragged=void 0};b.prototype.onDrag=function(a,b){a=this.design.headerHeight;
null!=this.scrolling?this.scrollTo(A(this.rows.length*(b-(this.y+a)-this.scrolling)/(this.h-a))):(b=this.toRowIndex(void 0,b),null!=b&&null!=this.dragged&&b!==this.dragged&&(a=[this.rows[b],this.rows[this.dragged]],this.rows[this.dragged]=a[0],this.rows[b]=a[1],this.dragged=b,this.sortkeys=this.scrolling=this.hover=void 0))};b.prototype.onDown=function(a,b){if(this.contains(a,b)&&(this.hover=this.dragged=this.toRowIndex(a,b),null==this.dragged)){var c=this.design,e=c.headerHeight,d=this.w-c.scrollBarWidth;
c=this.y+e;if(this.x<=a&&a<this.x+d&&this.y<=b&&b<c)b=this.toColumnIndex(a),null!=b&&this.sort(b,!!this.sortkeys&&this.sortkeys[0]===b+1);else if(this.x+d<=a&&a<this.right){a=this.rows.length;d=this.displayCount;e=this.h-e;var g=c+e*this.topRow/a,f=e*d/a;c<=b&&b<g?(this.scrollTo(A(a*(b-c)/e)),g=c+e*this.topRow/a):g+f<=b&&b<this.bottom&&(this.scrollTo(A(a*(b-c)/e)-d+1),g=c+e*this.topRow/a);g<=b&&b<g+f&&(this.scrolling=b-g)}}};b.prototype.onUp=function(a,b){null==this.scrolling&&null!=this.dragged&&
this.dragged===this.hover&&(this.click(this.rows[this.dragged],this.dragged),this.refresh());this.scrolling=this.dragged=void 0;this.hover=this.toRowIndex(a,b)};b.prototype.onPress=function(a){switch(a){case p.PAGE_DOWN:this.scrollBy(this.scrollStep);break;case p.PAGE_UP:this.scrollBy(-this.scrollStep)}};b.prototype.onDraw=function(a,b){b=this.design;var c=b.headerHeight,e=b.scrollBarWidth,d=this.rows.length,g=this.displayCount,f=this.x,k=this.y+c,m=this.w-e,p=this.h-c,r=this.x+m,v=(0<d&&p*this.topRow/
d||0)+k,Q=0<d&&p*g/d||p,qb=this.defaultColumnWidth;b.drawHeader(a,this.x,this.y,this.w,c);b.drawBackground(a,this.x,k,m,p);0<e&&(b.drawHeader(a,r,k,e,p),g<d&&b.drawScrollBar(a,r,v,e,Q));a.save();a.font=b.rowFont;a.fillStyle=b.rowStyle;a.textBaseline="middle";Q=b.rowHeight;for(var M=0;M<g;++M){e=M+this.topRow;var rb=this.rows[e],ma=k+Q*M;e===this.dragged?b.drawRowDragged(a,this.x,ma,m,Q):rb===this.selected?b.drawRowSelected(a,this.x,ma,m,Q):e===this.hover&&null==this.dragged&&b.drawRowHover(a,this.x,
ma,m,Q);var sb=0;e=0;for(d=this.columns.length;e<d;++e){r=this.columns[e];v=D(r.width,qb);var w=this.extract(rb,r);if(null!=w){var qa=f+sb+2,ra=v-4;a.textAlign=r.align||"left";switch(a.textAlign){case "center":qa+=ra/2;break;case "right":qa+=ra}a.fillText(w,qa,ma+Q/2,ra)}sb+=v}}a.restore();a.save();Q=0;a.font=b.headerFont;a.fillStyle=b.headerStyle;a.textAlign="center";a.textBaseline="middle";a.strokeStyle=b.lineStyle;e=0;for(d=this.columns.length;e<d;++e)r=this.columns[e],v=D(r.width,qb),M=f+Q,0<
e&&(a.beginPath(),a.moveTo(M,k),a.lineTo(M,this.bottom),a.stroke()),a.fillText(r.name.localized,M+v/2,this.y+c/2),Q+=v;a.restore();0===g&&0<p&&b.emptyText&&(a.save(),b.emptyFont&&(a.font=b.emptyFont),a.textAlign="center",a.textBaseline="middle",b.emptyStyle&&(a.fillStyle=b.emptyStyle),a.fillText(b.emptyText.localized,this.x+m/2,k+p/2),a.restore())};Object.defineProperty(b.prototype,"displayCount",{get:function(){var a=this.design;return V(A((this.h-a.headerHeight)/a.rowHeight),this.rows.length)},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"scrollStep",{get:function(){return W(A(.2*this.displayCount),1)},enumerable:!0,configurable:!0});b.prototype.extract=function(a,b){b=b.extract;return"function"===typeof b?b(a):a[b]};b.prototype.compare=function(a,b){var c=this.sortkeys,e=this.columns,d=0;if(c)for(var g=0,f=c.length;0===d&&g<f;++g){var k=c[g];d=e[(0<k?k:-k)-1];d=d.compare?d.compare(a,b):ka(this.extract(a,d),this.extract(b,d));0>k&&(d=-d)}return d};b.prototype.sort=
function(a,b){var c=this;void 0===b&&(b=!1);a+=1;if(this.sortkeys){for(var e=0,d=this.sortkeys.length;e<d;++e){var g=this.sortkeys[e];if(g===a||g===-a){this.sortkeys.splice(e,1);break}}this.sortkeys.unshift(b?-a:a)}else this.sortkeys=[b?-a:a];this.rows.sort(function(a,b){return c.compare(a,b)})};b.prototype.toRowIndex=function(a,b){var c=this.design,e=this.w-c.scrollBarWidth;if(void 0===a||this.x<=a&&a<this.x+e)if(a=this.topRow+A((b-this.y-c.headerHeight)/c.rowHeight),this.topRow<=a&&a<this.rows.length)return a};
b.prototype.toColumnIndex=function(a){for(var b=this.defaultColumnWidth,c=this.x,d=0,g=this.columns.length;d<g;++d){var f=D(this.columns[d].width,b);if(c<=a&&a<c+f)return d;c+=f}};Object.defineProperty(b.prototype,"defaultColumnWidth",{get:function(){for(var a=this.w-this.design.scrollBarWidth,b=0,d=0,g=0,f=this.columns;g<f.length;g++){var k=f[g];null!=k.width?b+=k.width:++d}return 0<d&&b<a?(a-b)/d:0},enumerable:!0,configurable:!0});b.prototype.refresh=function(){var a=this.rows.length;this.dragged>=
a&&(this.dragged=void 0);this.hover>=a&&(this.hover=void 0);this.scrollTo(this.topRow)};b.prototype.scrollTo=function(a){this.topRow=v(0,this.rows.length-this.displayCount,a)};b.prototype.scrollBy=function(a){this.scrollTo(this.topRow+a)};b.defaultDesign={rowHeight:28,rowFont:va(20),rowStyle:"white",headerHeight:24,headerFont:va(18),headerStyle:"white",scrollBarWidth:14,lineStyle:m(102,102,102),drawHeader:function(a,b,d,g,f){a.save();a.fillStyle=y(25,25,25,.8);a.fillRect(b,d,g,f);a.restore()},drawBackground:function(a,
b,d,g,f){a.save();a.fillStyle=y(0,0,0,.6);a.fillRect(b,d,g,f);a.restore()},drawScrollBar:function(a,b,d,g,f){Aa(a,b,d,g,f,m(100,100,100),m(75,75,75))},drawRowDragged:function(a,b,d,g,f){Aa(a,b,d,g,f,m(255,0,0),m(50,0,0))},drawRowSelected:function(a,b,d,g,f){Aa(a,b,d,g,f,m(100,0,0),m(50,0,0))},drawRowHover:function(a,b,d,g,f){Aa(a,b,d,g,f,m(75,0,0),m(50,0,0))}};return b}(pa),vb=function(){function a(a,c,d){this.min=c;this.max=d;this.value=a}Object.defineProperty(a.prototype,"value",{get:function(){return this._value},
set:function(a){this._value=v(this.min,this.max,xa(a))},enumerable:!0,configurable:!0});a.prototype.toString=function(){return this._value.toString()};a.prototype.valueOf=function(){return this._value};return a}(),Db=function(a){function b(c,d,g,f,k,m){void 0===m&&(m=b.defaultDesign);c=a.call(this,c,d,g,f)||this;c.value=k;c.design=m;c.dragged=!1;c.hover=!1;return c}z(b,a);b.prototype.getValueAsX=function(){var a=this.design.knobWidth,b=this.value,d=b.min;return this.x+a/2+(b.value-d)/(b.max-d)*(this.w-
a)};b.prototype.setValueByX=function(a){var b=this.design.knobWidth;a=v(0,1,(a-this.x-b/2)/(this.w-b));b=this.value;var c=b.min;this.value.value=xa(c+a*(b.max-c))};b.prototype.onHover=function(a,b){this.hover=this.contains(a,b);this.dragged=!1};b.prototype.onDrag=function(a,b){this.hover=this.dragged&&this.contains(a,b);this.dragged&&this.setValueByX(a)};b.prototype.onDown=function(a,b){this.contains(a,b)&&(this.dragged=!0,this.setValueByX(a))};b.prototype.onUp=function(a,b){this.dragged=!1};b.prototype.onDraw=
function(a,b){this.design.draw(a,b,this)};Object.defineProperty(b.prototype,"knob",{get:function(){var a=this.design.knobWidth,b=this.h;return{x:this.getValueAsX()-a/2,y:this.y-(this.h-b)/2,w:a,h:b,state:this.dragged?2:this.hover?1:0}},enumerable:!0,configurable:!0});b.defaultDesign={knobWidth:12,draw:function(a,b,d){ya(a,d,{fillStyle:y(50,50,50,.8),strokeStyle:"white",lineWidth:4});b=d.knob;d={strokeStyle:"white",lineWidth:4};switch(b.state){case 0:d.fillStyle=y(150,150,150,.8);break;case 1:d.fillStyle=
y(200,200,200,.8);break;case 2:d.fillStyle=y(255,255,255,.8)}ya(a,b,d)}};return b}(pa),Jb=function(a){function b(b,d,g,f,k,m){b=a.call(this,b,d,g,f)||this;b.duration=k;b.style=m;b.logs=[];return b}z(b,a);b.prototype.onDraw=function(a,b){var c=this.logs;if(0<c.length){var d=b-this.duration;b=w(c,function(a){return a.when>d});0>b?c.length=0:c.splice(0,b);b=c.length;if(0<b)for(var e=this.style,g=1.2*(e&&e.fontSize||24),f=0;f<b;++f)ea(a,c[f].message,this.x,this.y+f*g,this.w,g,e)}};b.prototype.log=function(a){if(a){var b=
performance.now(),c=this.logs,d=c.length;0<d&&c[d-1].message===a?c[d-1].when=b:c.push({message:Ia(a),when:b})}};b.prototype.error=function(a){this.log(a)};return b}(pa);L.path="assets/lang/";L.languages.en=void 0;L.languages.ja=void 0;var Eb=[p.ESCAPE],Da=[p.ENTER,p.SPACE],sa=[p.BACKSPACE,p.TAB,p.DELETE],Kb=[p.PAGE_UP,p.HOME,p.LEFT,p.UP],Lb=[p.PAGE_DOWN,p.END,p.RIGHT,p.DOWN],tb=Da.concat(sa),nb=Da.concat(p.Y),ob=sa.concat(p.N),d;(function(a){a[a.Melee=0]="Melee";a[a.Throw=1]="Throw";a[a.Shoot=2]=
"Shoot";a[a.Magic=3]="Magic";a[a.Alchemy=4]="Alchemy";a[a.Slash=5]="Slash";a[a.Blunt=6]="Blunt";a[a.Pierce=7]="Pierce";a[a.Shield=8]="Shield";a[a.Head=9]="Head";a[a.Body=10]="Body";a[a.Arms=11]="Arms";a[a.Legs=12]="Legs";a[a.Fire=13]="Fire";a[a.Cold=14]="Cold";a[a.Lightning=15]="Lightning";a[a.Life=16]="Life";a[a.MAX=17]="MAX"})(d||(d={}));var fb={bkgnd:y(0,0,0,.6),delta:m(255,51,0),normal:m(153,204,0),full:m(0,204,51)},wb={bkgnd:y(0,0,0,.6),delta:m(0,51,102),normal:m(0,153,204),full:m(0,153,255)},
Va=[{PICK:0,WALK:!1,POPUP:!1},{PICK:0,WALK:!1,POPUP:!0},{PICK:0,WALK:!0,POPUP:!0},{PICK:300,WALK:!0,POPUP:!0}],G,Mb={Warrior:{INT:4,DEX:4,STR:7,equipments:["Mace","PlateArmor","FirstAidKit"],skills:["Swing","Crash","Bash","PathToWarrior","PotionOfRegeneration"],image:"nazrin"},Samurai:{INT:3,DEX:7,STR:5,equipments:["Katana","Chainmail","FirstAidKit"],skills:["Swing","Slash","CutThrough","Sweep","PotionOfHealth"],image:"rin"},Knight:{INT:6,DEX:2,STR:7,equipments:["Spear","LamellarArmor","KiteShield",
"FirstAidKit"],skills:"Swing Stab Thrust ShieldBash ShieldCharge PotionOfStrength".split(" "),image:"toramaru"},Thief:{INT:3,DEX:6,STR:6,equipments:["LongBow","LetherArmor","FirstAidKit"],skills:["Shoot","PoisonArrow","OilArrow","FirstAid","PotionOfDexterity"],image:"marisa"},Healer:{INT:7,DEX:3,STR:5,equipments:["Staff","Robe"],skills:"Swing Heal PartyHeal Empower Enhance Enlighten Absorber Shelter Barrier".split(" "),image:"reimu"},Mage:{INT:8,DEX:4,STR:3,equipments:["Wand","Robe","FirstAidKit"],
skills:"FireBall IceSpear DrainLife LightningLaser FireNova PotionOfIntelligence".split(" "),image:"utsuho"}},xb={Ant:{INT:3,DEX:3,STR:4,equipments:["Dagger","LetherArmor"],skills:["Swing"],image:"ant.png"},Elemental:{INT:4,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["FireBall","AffinityToFire"],image:"elemental.png"},Frog:{INT:4,DEX:4,STR:4,equipments:["ShortBow","LetherArmor"],skills:["Shoot"],image:"frog.png"},Plant:{INT:4,DEX:3,STR:4,equipments:["Wand","LetherArmor"],skills:["FireNova"],
image:"plant.png"},Slug:{INT:3,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["DrainLife"],image:"slug.png"},Snail:{INT:3,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["Heal"],image:"snail.png"},Sword:{INT:3,DEX:5,STR:4,equipments:["LongSword","LetherArmor"],skills:["Swing"],image:"sword.png"},Wall:{INT:2,DEX:2,STR:6,equipments:["Mace","LetherArmor"],skills:["Swing"],image:"wall.png"},Weasel:{INT:3,DEX:6,STR:3,equipments:["Spear","LetherArmor"],skills:["Thrust"],image:"weasel.png"}},
Nb={AddedFire:{tags:[d.Melee,d.Throw,d.Shoot],min:5,max:10,ATK:function(a,b){return b+a}}},Z={Dagger:{tags:f(d.Melee,d.Slash),weight:13,price:100,ATK:30},ShortSword:{tags:f(d.Melee,d.Slash),weight:15,price:100,ATK:40},LongSword:{tags:f(d.Melee,d.Slash),weight:16,price:100,ATK:50},Katana:{tags:f(d.Melee,d.Slash),weight:15,price:100,ATK:45},Axe:{tags:f(d.Melee,d.Slash,d.Blunt),weight:18,price:100,ATK:45},Mace:{tags:f(d.Melee,d.Blunt),weight:16,price:100,ATK:40},Spear:{tags:f(d.Melee,d.Pierce),weight:20,
price:100,ATK:50},Halberd:{tags:f(d.Melee,d.Slash,d.Blunt,d.Pierce),weight:30,price:100,ATK:50},ShortBow:{tags:f(d.Shoot,d.Pierce),weight:18,price:100,ATK:30},LongBow:{tags:f(d.Shoot,d.Pierce),weight:20,price:100,ATK:40},Staff:{tags:f(d.Melee,d.Blunt,d.Magic),weight:20,price:100,ATK:20},Wand:{tags:f(d.Magic),weight:16,price:100,ATK:25},FirstAidKit:{tags:f(d.Alchemy),weight:10,price:100,ATK:20},Buckler:{tags:f(d.Shield),weight:20,price:100,ATK:10,DEF:10},RoundShield:{tags:f(d.Shield),weight:25,price:100,
ATK:15,DEF:15},SpikedShield:{tags:f(d.Shield),weight:30,price:100,ATK:30,DEF:15},KiteShield:{tags:f(d.Shield),weight:35,price:100,ATK:20,DEF:20},TowerShield:{tags:f(d.Shield),weight:40,price:100,ATK:30,DEF:20},Circlet:{tags:f(d.Head),weight:5,price:100,DEF:2},LeatherHood:{tags:f(d.Head),weight:10,price:100,DEF:4},Mask:{tags:f(d.Head),weight:15,price:100,DEF:6},Sallet:{tags:f(d.Head),weight:20,price:100,DEF:8},Bascinet:{tags:f(d.Head),weight:25,price:100,DEF:10},Helmet:{tags:f(d.Head),weight:30,price:100,
DEF:12},Robe:{tags:f(d.Body),weight:20,price:100,DEF:10},LetherArmor:{tags:f(d.Body),weight:25,price:100,DEF:15},ScaleArmor:{tags:f(d.Body),weight:30,price:100,DEF:20},Chainmail:{tags:f(d.Body),weight:35,price:100,DEF:22},LamellarArmor:{tags:f(d.Body),weight:40,price:100,DEF:25},PlateArmor:{tags:f(d.Body),weight:45,price:100,DEF:30},Gloves:{tags:f(d.Arms),weight:10,price:100,DEF:4},Mittens:{tags:f(d.Arms),weight:20,price:100,DEF:6},Gauntlets:{tags:f(d.Arms),weight:30,price:100,DEF:8},Slippers:{tags:f(d.Legs),
weight:5,price:100,DEF:2},Sandals:{tags:f(d.Legs),weight:10,price:100,DEF:4},Shoes:{tags:f(d.Legs),weight:15,price:100,DEF:6},Boots:{tags:f(d.Legs),weight:20,price:100,DEF:8},Greaves:{tags:f(d.Legs),weight:25,price:100,DEF:10}},Ob={Dummy:{usage:"single-hostile",range:0,cost:999,AID:"Charge"},Swing:{usage:"single-hostile",range:1,cost:14,tags:f(d.Melee),deltaHP:-100,AID:"Charge"},Slash:{usage:"single-hostile",range:1,cost:15,tags:f(d.Melee,d.Slash),deltaHP:-110,AID:"Charge"},CutThrough:{usage:"single-hostile",
range:1,cost:20,tags:f(d.Melee,d.Slash),deltaHP:-100,AID:"GoBehind"},Sweep:{usage:"surround-hostile",range:1,cost:20,tags:f(d.Melee,d.Slash),deltaHP:-100,AID:"Nova"},Crash:{usage:"single-hostile",range:1,cost:15,tags:f(d.Melee,d.Blunt),deltaHP:-110,AID:"Charge"},Bash:{usage:"single-hostile",range:1,cost:20,tags:f(d.Melee,d.Blunt),deltaHP:-100,AID:"Knockback"},Stab:{usage:"single-hostile",range:1,cost:15,tags:f(d.Melee,d.Pierce),deltaHP:-110,AID:"Charge"},Thrust:{usage:"straight-hostile",range:2,cost:15,
tags:f(d.Melee,d.Pierce),deltaHP:-100,AID:"Laser"},ShieldBash:{usage:"single-hostile",range:1,cost:20,tags:f(d.Shield),deltaHP:-100,AID:"Charge"},ShieldCharge:{usage:"single-hostile",range:1,cost:24,tags:f(d.Shield),deltaHP:-100,AID:"Trample"},Shoot:{usage:"single-hostile",range:3,cost:20,tags:f(d.Shoot),deltaHP:-100,AID:"Shoot"},PoisonArrow:{usage:"single-hostile",range:3,cost:20,tags:f(d.Shoot),deltaHP:-60,turns:2,deltaHPoT:-30,AID:"Shoot"},OilArrow:{usage:"single-hostile",range:3,cost:20,tags:f(d.Shoot),
deltaHP:-60,turns:2,mods:[{type:"incoming",level:-4,tags:f(d.Fire)}],AID:"Shoot"},IceSpear:{usage:"single-hostile",range:5,cost:16,tags:f(d.Magic,d.Cold),deltaHP:-80,deltaSP:-40,AID:"Shoot"},DrainLife:{usage:"single-hostile",range:5,cost:16,tags:f(d.Magic,d.Life),deltaHP:-80,AID:"Drain"},FireBall:{usage:"single-hostile",range:5,cost:16,tags:f(d.Magic,d.Fire),deltaHP:-100,AID:"Explode"},LightningLaser:{usage:"straight-hostile",range:5,cost:16,tags:f(d.Magic,d.Lightning),deltaHP:-100,AID:"Laser"},FireNova:{usage:"surround-hostile",
range:2,cost:16,tags:f(d.Magic,d.Fire),deltaHP:-100,AID:"Nova"},Heal:{usage:"single-friendly",range:3,cost:16,tags:f(d.Magic,d.Life),deltaHP:100,AID:"Shoot"},PartyHeal:{usage:"surround-friendly",range:1,cost:24,tags:f(d.Magic,d.Life),deltaHP:100,AID:"Nova"},FirstAid:{usage:"single-friendly",range:1,cost:24,tags:f(d.Alchemy,d.Life),deltaHP:50,turns:2,deltaHPoT:25,AID:"Charge"},Empower:{usage:"single-friendly",range:3,cost:16,tags:f(d.Magic,d.Life),turns:2,mods:[{type:"outgoing",level:4,tags:f(d.Melee)}],
AID:"Shoot"},Enhance:{usage:"single-friendly",range:3,cost:16,tags:f(d.Magic,d.Life),turns:2,mods:[{type:"outgoing",level:4,tags:f(d.Throw,d.Shoot)}],AID:"Shoot"},Enlighten:{usage:"single-friendly",range:3,cost:16,tags:f(d.Magic,d.Life),turns:2,mods:[{type:"outgoing",level:4,tags:f(d.Magic)}],AID:"Shoot"},Absorber:{usage:"single-friendly",range:3,cost:16,tags:f(d.Magic,d.Life),turns:2,mods:[{type:"incoming",level:4,tags:f(d.Melee)}],AID:"Shoot"},Shelter:{usage:"single-friendly",range:3,cost:16,tags:f(d.Magic,
d.Life),turns:2,mods:[{type:"incoming",level:4,tags:f(d.Throw,d.Shoot)}],AID:"Shoot"},Barrier:{usage:"single-friendly",range:3,cost:16,tags:f(d.Magic,d.Life),turns:2,mods:[{type:"incoming",level:4,tags:f(d.Magic)}],AID:"Shoot"},PotionOfHealth:{usage:"dose",cost:24,tags:f(d.Alchemy,d.Life),deltaHP:100,AID:"Dose"},PotionOfRegeneration:{usage:"dose",cost:24,tags:f(d.Alchemy,d.Life),deltaHP:50,turns:2,deltaHPoT:50,AID:"Dose"},PotionOfStrength:{usage:"dose",cost:24,tags:f(d.Alchemy,d.Life),turns:3,mods:[{type:"outgoing",
level:4,tags:f(d.Melee)}],AID:"Dose"},PotionOfDexterity:{usage:"dose",cost:24,tags:f(d.Alchemy,d.Life),turns:3,mods:[{type:"outgoing",level:4,tags:f(d.Throw,d.Shoot)}],AID:"Dose"},PotionOfIntelligence:{usage:"dose",cost:24,tags:f(d.Alchemy,d.Life),turns:3,mods:[{type:"outgoing",level:4,tags:f(d.Magic)}],AID:"Dose"},PathToWarrior:{usage:"passive",cost:10,mods:[{type:"outgoing",level:2,tags:f(d.Melee)}]},PathToNinja:{usage:"passive",cost:10,mods:[{type:"outgoing",level:2,tags:f(d.Throw)}]},PathToArcher:{usage:"passive",
cost:10,mods:[{type:"outgoing",level:2,tags:f(d.Shoot)}]},PathToMage:{usage:"passive",cost:10,mods:[{type:"outgoing",level:2,tags:f(d.Magic)}]},PathToAlchemist:{usage:"passive",cost:10,mods:[{type:"outgoing",level:2,tags:f(d.Alchemy)}]},Defence:{usage:"passive",cost:10,mods:[{type:"incoming",level:2,tags:f(d.Melee)}]},Dodge:{usage:"passive",cost:10,mods:[{type:"incoming",level:2,tags:f(d.Throw,d.Shoot)}]},Meditation:{usage:"passive",cost:10,mods:[{type:"incoming",level:2,tags:f(d.Magic)}]},Healthy:{usage:"passive",
cost:10,mods:[{type:"incoming",level:2,tags:f(d.Alchemy)}]},AffinityToFire:{usage:"passive",cost:10,mods:[{type:"outgoing",level:3,tags:f(d.Fire)},{type:"outgoing",level:-3,tags:f(d.Cold,d.Lightning)},{type:"incoming",level:3,tags:f(d.Fire)}]},AffinityToCold:{usage:"passive",cost:10,mods:[{type:"outgoing",level:3,tags:f(d.Cold)},{type:"outgoing",level:-3,tags:f(d.Fire,d.Lightning)},{type:"incoming",level:3,tags:f(d.Cold)}]},AffinityToLightning:{usage:"passive",cost:10,mods:[{type:"outgoing",level:3,
tags:f(d.Lightning)},{type:"outgoing",level:-3,tags:f(d.Fire,d.Cold)},{type:"incoming",level:3,tags:f(d.Lightning)}]}},Cb=function(a,b){return void 0===b?new db(0,a):new db(a,b)}(d.MAX).map(function(a){return g("Tag",d[a])}),Pb=Oa([d.Melee,d.Throw,d.Shoot,d.Magic,d.Alchemy,d.Slash,d.Blunt,d.Pierce]),Qb=Oa([d.Shield,d.Head,d.Body,d.Arms,d.Legs]),Wa=function(){function a(b){this.EID=b;this.def=Nb[b];if(!this.def)throw new RangeError('Enchantment not found: "'+b+'"');this.name=a.nameOf(b);this.spec=
a.specOf(b);this.value=this.def.min+ca(this.def.max-this.def.min)}a.prototype.qualify=function(a){return Ja(this.name.localized,a)};a.prototype.modify=function(a){this.def.ATK&&(a=this.def.ATK(this.value,a));return a};a.nameOf=function(a){return g("Enchant",a,"Name")};a.specOf=function(a){return g("Enchant",a,"Spec")};a.from=function(b){return new a(b)};a.fromJSON=function(b){return new a(b.EID)};a.prototype.toJSON=function(){return{EID:this.EID,value:this.value}};return a}(),fa=function(){function a(b,
c){var d=Z[b];if(!d)throw new RangeError('Item not found: "'+b+'"');this.IID=b;this.def=d;this.baseName=a.nameOf(b);this.spec=a.specOf(b);this.enchants=c?c:this.def.enchants?this.def.enchants.map(Wa.from):[]}Object.defineProperty(a.prototype,"name",{get:function(){for(var a=this.baseName.localized,c=0,d=this.enchants;c<d.length;c++)a=d[c].qualify(a);return a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"tags",{get:function(){return this.def.tags},enumerable:!0,configurable:!0});
Object.defineProperty(a.prototype,"weight",{get:function(){return this.def.weight},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"priceToSell",{get:function(){for(var a=this.def.price,c=0,d=this.enchants;c<d.length;c++)a=d[c].modify(a);return A(a)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ATK",{get:function(){for(var a=this.def.ATK||0,c=0,d=this.enchants;c<d.length;c++)a=d[c].modify(a);return a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"DEF",{get:function(){for(var a=this.def.DEF||0,c=0,d=this.enchants;c<d.length;c++)a=d[c].modify(a);return a},enumerable:!0,configurable:!0});a.nameOf=function(a){return g("Item",a,"Name")};a.specOf=function(a){return g("Item",a,"Spec")};a.from=function(b){return new a(b)};a.fromJSON=function(b){return new a(b.IID,P(Wa,b.enchants))};a.prototype.toJSON=function(){return{IID:this.IID,enchants:ta(this.enchants)}};return a}(),gb=function(){function a(b){var c=Ob[b];if(!c)throw new RangeError('Skill not found: "'+
b+'"');this.SID=b;this.def=c;this.name=a.nameOf(b);this.spec=a.specOf(b)}Object.defineProperty(a.prototype,"tags",{get:function(){return this.def.tags},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"usage",{get:function(){return this.def.usage},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"hostile",{get:function(){a:switch(this.def.usage){case "single-hostile":case "straight-hostile":case "surround-hostile":var a=!0;break a;default:a=!1}return a},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"AID",{get:function(){return this.def.AID},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"isActive",{get:function(){return"passive"!==this.usage},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"isPassive",{get:function(){return"passive"===this.usage},enumerable:!0,configurable:!0});a.prototype.match=function(a){if(!this.def.tags)return!0;var b=this.def.tags.bits&Pb;return(b&a.def.tags.bits)===b};a.nameOf=function(a){return g("Skill",
a,"Name")};a.specOf=function(a){return g("Skill",a,"Spec")};a.from=function(b){return new a(b)};a.fromJSON=function(b){return new a(b.SID)};a.prototype.toJSON=function(){return{SID:this.SID}};a.DUMMY=new a("Dummy");return a}(),yb=[1,2,3,4,5,5,5,5,4,3,2,1],Ea;(function(a){a[a.DEFAULT=0]="DEFAULT";a[a.BLINK_1=1]="BLINK_1";a[a.BLINK_2=2]="BLINK_2";a[a.BLINK_3=3]="BLINK_3";a[a.BLINK_4=4]="BLINK_4";a[a.CLOSED=5]="CLOSED";a[a.DEAD=6]="DEAD"})(Ea||(Ea={}));var ba=function(){function a(a,c,d,g,f,k,m,p,r){function b(){for(var a=
[],b=0;b<arguments.length;b++)a[b]=arguments[b];b=a[0];var c=b.w,d=b.h;b=document.createElement("canvas");b.width=c;b.height=d;var e=b.getContext("2d");if(e)for(c={x:0,y:0,w:c,h:d},d=0;d<a.length;d++)a[d].draw(e,void 0,c);return J.from(b)}function e(a){var b=l[0],c=b.w,d=b.h;b=document.createElement("canvas");b.width=c;b.height=d;var e=b.getContext("2d");if(e){var g={x:0,y:0,w:c,h:d};if(void 0!==e.filter)e.save(),e.filter="grayscale(100%)",a.draw(e,void 0,g),e.restore();else{a.draw(e,void 0,g);a=
e.getImageData(0,0,c,d);c=a.data;d=a.width;g=a.height;for(var f=0;f<g;++f)for(var k=0;k<d;++k){var m=4*f*d+4*k,n=.2126*c[m]+.7152*c[m+1]+.0722*c[m+2];c[m]=n;c[m+1]=n;c[m+2]=n}e.putImageData(a,0,0,0,0,d,g)}}return J.from(b)}this.name=a;this.level=c;this.INT=d;this.DEX=g;this.STR=f;this.equipments=k;this.skills=m;this.known=p;this.src=r;var l=[];a=0>r.indexOf("/")?"assets/char/"+r:r;if(r.endsWith(".png"))r=new J(a),l[0]=r;else{var n=[new J(a+"/back.png"),new J(a+"/eye.png"),new J(a+"/eye1.png"),new J(a+
"/eye2.png"),new J(a+"/eye3.png"),new J(a+"/eye4.png"),new J(a+"/eye5.png"),new J(a+"/fore.png")];wa(n).then(function(){l.push(b(n[0],n[1],n[7]),b(n[0],n[2],n[7]),b(n[0],n[3],n[7]),b(n[0],n[4],n[7]),b(n[0],n[5],n[7]),b(n[0],n[6],n[7]));l.push(e(l[Ea.CLOSED]))})}this.images=l;this.blinkCycle=4500+100*d;this.blinkOffset=ca(this.blinkCycle)}Object.defineProperty(a.prototype,"w",{get:function(){var a=this.images[0];return a?a.w:1},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"h",
{get:function(){var a=this.images[0];return a?a.h:1},enumerable:!0,configurable:!0});a.prototype.draw=function(a,c,d,g,f){var b=(c+this.blinkOffset)%this.blinkCycle;b=450>b?yb[A(b/450*yb.length)]:0;var e=this.images;(b=e[b]||e[Ea.DEFAULT])&&b.draw(a,c,d,g,f)};Object.defineProperty(a.prototype,"HP",{get:function(){return 10*(3+this.STR)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"SP",{get:function(){var a=W(0,this.weight-this.maxWeight);return W(0,4*(3+this.STR)-a)},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"reservedSP",{get:function(){var a=this;return this.skills.reduce(function(b,d){return b+(d.isPassive?a.costOf(d):0)},0)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"step",{get:function(){return 13-this.DEX},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ZoC",{get:function(){return 3+this.DEX},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxWeight",{get:function(){return 10*(3+this.STR)},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"weight",{get:function(){return this.equipments.reduce(function(a,c){return a+c.weight},0)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){return 100*(1-this.equipments.reduce(function(a,c){return a*(1-c.DEF/100)},1))},enumerable:!0,configurable:!0});a.prototype.costOf=function(a){return a.def.cost-this.INT};a.prototype.rangeOf=function(a){return a.def.range};a.prototype.itemFor=function(a){if(a&&
a.isActive)for(var b=0,d=0,g=this.equipments;d<g.length;d++){var f=g[d];if(a.match(f)){var k=f.ATK;if(b<k){b=k;var m=f}}}return m};a.adventurer=function(b){var c=Mb[b];if(!c)throw new RangeError('Adventurer not found: "'+b+'"');return a.from(g("Adventurer",b),0,c)};a.monster=function(b,c){var d=xb[b];if(!d)throw new RangeError('Monster not found: "'+b+'"');return a.from(g("Monster",b),c,d)};a.from=function(b,c,d){return new a(b.localized,c,d.INT,d.DEX,d.STR,d.equipments.map(fa.from),d.skills.map(gb.from),
[],d.image)};a.fromJSON=function(b){return new a(b.name,b.level,b.INT,b.DEX,b.STR,P(fa,b.equipments),P(gb,b.skills),P(gb,b.known),b.image)};a.prototype.toJSON=function(){return{name:this.name,level:this.level,INT:this.INT,DEX:this.DEX,STR:this.STR,equipments:ta(this.equipments),skills:ta(this.skills),known:ta(this.known),image:this.src}};return a}(),Xa;(function(a){var b=function(a){function b(){var c=a.call(this)||this;(new K(0,0,1280,720,new J("assets/scene/title.jpg"))).attach(c);var d=Sa();if(d){var e=
g("Title","Continue");var f=function(){return U.go(c,new Fa.Home(d))};(new I(1070,650,200,60,new E(g("Title","Delete")),function(){Pa.confirm(c,g("Title","ConfirmDelete"),{label:g("Title","Delete"),click:function(){try{System.setRoamingStorage("NYO",void 0)}catch(Ab){G.error(Ab)}U.go(c,new b);G.log(g("Title","NotifyDelete"))},mnemonic:nb},{label:g("Config","Cancel"),mnemonic:ob})})).attach(c)}else e=g("Title","New"),f=function(){var a={},b;for(b in Z){var d=ca(4);0<d&&(a[b]=d)}a={shop:a,warehouse:[],
reservers:[],party:[ba.adventurer("Knight"),ba.adventurer("Warrior"),ba.adventurer("Samurai"),ba.adventurer("Mage"),ba.adventurer("Healer"),ba.adventurer("Thief")],gold:1E3};a.party[0].equipments[0].enchants.push(Wa.from("AddedFire"));Ua(a);U.go(c,new Fa.Home(a))};(new I(480,504,320,72,new E(e),f,Da)).attach(c);(new I(480,612,320,72,new E(g("Title","Quit")),System.exit)).attach(c);kb(c);return c}z(b,a);return b}(T);a.Scene=b})(Xa||(Xa={}));var Fa;(function(a){function b(){return[{name:g("Character",
"Name"),extract:function(a){return a.name},width:200},{name:g("Character","INT"),extract:function(a){return a.INT},width:60,align:"right"},{name:g("Character","DEX"),extract:function(a){return a.DEX},width:60,align:"right"},{name:g("Character","STR"),extract:function(a){return a.STR},width:60,align:"right"}]}function c(a){return[{name:a,extract:function(a){return a.name},width:200},{name:g("Town","Tags"),extract:function(a){return Ba(a.tags)}},{name:g("Town","Weight"),extract:function(a){return a.weight},
width:60,align:"right"},{name:g("Town","ATK"),extract:function(a){return a.ATK},width:60,align:"right"},{name:g("Town","DEF"),extract:function(a){return a.DEF},width:60,align:"right"}]}function d(a,b){var d=b.shop;a=c(a);a.push({name:g("Town","Stock"),extract:function(a){return D(d[a.IID],g("Town","New"))},width:60,align:"right"});return a}function f(a,b){var c=b.shop,d=b.warehouse;return[{name:a,extract:function(a){return fa.nameOf(a).localized},width:200},{name:g("Town","Tags"),extract:function(a){return Ba(Z[a].tags)}},
{name:g("Town","ATK"),extract:function(a){return Z[a].ATK},width:60,align:"right"},{name:g("Town","DEF"),extract:function(a){return Z[a].DEF},width:60,align:"right"},{name:g("Town","Weight"),extract:function(a){return Z[a].weight},width:60,align:"right"},{name:g("Town","Stock"),extract:function(a){return c[a]},width:60,align:"right"},{name:g("Town","Owned"),extract:function(a){return d.reduce(function(b,c){return c.IID===a?b+1:b},0)},width:60,align:"right"}]}function k(a,b){return[{name:a,extract:function(a){return a.name.localized},
width:200},{name:g("Town","Required"),extract:function(a){return a.tags?Ba(a.tags):"-"}},{name:g("Town","Cost"),extract:function(a){return b.costOf(a)},width:60,align:"right"},{name:g("Town","Range"),extract:function(a){return b.rangeOf(a)},width:60,align:"right"},{name:g("Town","Power"),extract:function(a){return a.def.deltaHP},width:60,align:"right"},{name:g("Town","Spec"),extract:function(a){return a.spec.localized}}]}var r={fontSize:64,fillStyle:m(255,255,255),strokeStyle:m(0,0,0),textAlign:"center",
textBaseline:"middle",lineWidth:2},v=function(){function a(a,b){this.party=a;this.index=b}a.prototype.draw=function(a,b,c){var d=c.x,e=c.y,g=c.w;c=c.h;var f=this.party[this.index];a.save();if(f){var k=Ma(f,140,184);f.draw(a,b,{x:d+g/2-k.w/2,y:e+92-k.h/2,w:k.w,h:k.h});var l=this.party.reduce(function(a,b){return b?W(a,b.HP):a},1);b=f.HP;k=d+10;var n=g-20,M=e+c-30;l=(n-2)*b/l;a.strokeStyle="black";a.fillStyle=fb.full;a.fillRect(k,M,l,6);a.strokeRect(k,M,l,6);ea(a,b.toString(),k+4,M-20,n,20,{fontSize:20,
fillStyle:m(255,255,255),strokeStyle:m(0,0,0),textAlign:"left",textBaseline:"bottom",lineWidth:2});ea(a,f.name,d,e+c-24,g,24,{fontSize:24,fillStyle:m(255,255,255),strokeStyle:m(0,0,0),textAlign:"center",textBaseline:"bottom",lineWidth:2})}else ea(a,(this.index+1).toString(),d,e,g,c,r);a.restore()};return a}(),w=function(a){function b(b){var c=a.call(this)||this;c.data=b;return c}z(b,a);b.prototype.addButton=function(a,b,c,d){a=new I(1280-170*a,665,160,45,new E(c),d,b);a.attach(this);return a};b.prototype.goTo=
function(a){U.go(this,new a(this.data))};return b}(T),x=function(a){function b(b,c){var d=a.call(this,b)||this;(new K(0,0,1280,720,new J("assets/scene/"+c))).attach(d);kb(d);var e=b.party;b=[];for(c=0;6>c;++c){var g=A(c/3);(new Ib(10+170*(1-g),10+c%3*214+68*g,160,204,b,new v(e,c),function(){d.onPortraitClick(this.drawable.index)},function(a){var b=this.drawable;a=a.drawable;var c=[e[a.index],e[b.index]];e[b.index]=c[0];e[a.index]=c[1];c=[a.index,b.index];b.index=c[0];a.index=c[1]},[p.$1+c])).attach(d)}return d}
z(b,a);return b}(w),y=function(a){function b(c){var d=a.call(this,c,"town.jpg")||this,e=["grass","moss"],f=ca(e.length);d.addSpot(5,p.A,"Guild",function(){}).enabled=!1;d.addSpot(4,p.B,"Tavern",function(){return d.goTo(N)});d.addSpot(3,p.C,"Shop",function(){return d.goTo(O)});d.addSpot(2,p.D,"Smith",function(){}).enabled=!1;d.addSpot(1,p.E,"Dungeon",function(){U.go(d,new Ga.Scene(c,new Ga.EndressStage(e[f],0)))}).enabled=c.party.some(function(a){return!!a});d.addButton(2,[p.L],g("Town","Load"),function(){Pa.confirm(d,
g("Town","ConfirmLoad"),{label:g("Town","Load"),click:function(){var a=Sa();a&&(U.go(d,new b(a)),G.log(g("Town","NotifyLoad")))},mnemonic:nb},{label:g("Config","Cancel"),mnemonic:ob})});d.addButton(1,[p.S],g("Town","Save"),function(){Ua(d.data);G.log(g("Town","NotifySave"))});return d}z(b,a);b.prototype.onPortraitClick=function(a){this.data.party[a]&&U.go(this,new L(this.data,a))};b.prototype.addSpot=function(a,b,c,d){a=new I(950,665-100*a,320,90,new E(g("Town",c)),d,[b]);a.attach(this);return a};
return b}(x);a.Home=y;var N=function(a){function c(c){function d(a,b){(c=Array.prototype.splice).call.apply(c,[a,0,a.length].concat(b));var c}var e=a.call(this,c,"tavern.jpg")||this,f=c.party.concat(),k=c.reservers.concat();e.addButton(3,[p.C],g("Town","Clear"),function(){for(var a=0;6>a;++a){var b=c.party[a];b&&(c.reservers.push(b),c.party[a]=void 0)}});e.addButton(2,[p.R],g("Town","Revert"),function(){d(c.party,f);d(c.reservers,k)});e.addButton(1,sa,g("Town","Back"),function(){return e.goTo(y)});
(new F(350,10,920,F.heightOf(10),b(),c.reservers,function(a,b){return e.onReserverClick(a,b)})).attach(e);return e}z(c,a);c.prototype.onPortraitClick=function(a){var b=this.data.party[a];b&&(this.data.party[a]=void 0,this.data.reservers.push(b))};c.prototype.onReserverClick=function(a,b){for(var c=0;6>c;++c)if(!this.data.party[c]){this.data.party[c]=a;this.data.reservers.splice(b,1);return}G.error(g("Town","PartyFull"))};return c}(x),O=function(a){function b(b){var c=a.call(this,b,"shop.jpg")||this,
e=b.shop,k=b.warehouse,l=new F(350,10,920,F.heightOf(10),f(g("Town","Buy"),b),La(e),function(a){if(0>=e[a])G.error(g("Town","SoldOut"));else{var c=Z[a].price;if(b.gold<c)G.error(g("Town","NoMoney"));else{var d=new fa(a);--e[a];k.push(d);b.gold-=c;G.log(Ja(g("Town","NotifyBuy").localized,d.name,c))}}});l.attach(c);var m=new F(350,10,920,F.heightOf(10),d(g("Town","Sell"),b),k,function(a,c){var d=a.IID,f=a.priceToSell;k.splice(c,1);c=e[d];null==c?(e[d]=1,l.rows.push(d)):e[d]=1+c;b.gold+=f;G.log(Ja(g("Town",
"NotifySell").localized,a.name,f))});m.attach(c);var n=c.addButton(3,[p.B],g("Town","Buy"),function(){l.visible=!0;m.visible=!1;n.enabled=!1;r.enabled=!0});var r=c.addButton(2,[p.S],g("Town","Sell"),function(){l.visible=!1;m.visible=!0;n.enabled=!0;r.enabled=!1});c.addButton(1,sa,g("Town","Back"),function(){return c.goTo(y)});n.onClick();return c}z(b,a);b.prototype.onPortraitClick=function(a){G.log("TODO: Shop.onPortraitClick: "+a)};return b}(x),L=function(a){function b(d,e){var f=a.call(this,d)||
this,l=d.warehouse,m=d.party,n=m[e];d=Ma(n,1280,720,!0);(new K(0,0,d.w,d.h,n)).attach(f);(new K(0,0,200,40,new E(n.name+" / Lv: "+n.level))).attach(f);d={textAlign:"left"};(new K(0,40,200,40,new E("INT: "+n.INT,d))).attach(f);(new K(100,40,200,40,new E("DEX: "+n.DEX,d))).attach(f);(new K(200,40,200,40,new E("STR: "+n.STR,d))).attach(f);(new K(0,80,200,40,new E(function(){return"HP: "+n.HP},d))).attach(f);(new K(0,120,200,40,new E(function(){var a=n.reservedSP;a=0<a?"SP: "+(n.SP-a)+" ("+a+" reserved)":
"SP: "+n.SP;return a},d))).attach(f);(new K(0,160,200,40,new E(function(){return"WT: "+n.weight+"/"+n.maxWeight},d))).attach(f);(new K(0,200,200,40,new E(function(){return"DEF: "+n.DEF.toFixed(1)},d))).attach(f);var r=new T([new F(350,10,920,F.heightOf(10),c(g("Town","Equipments")),n.equipments,function(a,b){n.equipments.splice(b,1);l.push(a)}),new F(350,360,920,F.heightOf(10),c(g("Town","Warehouse")),l,function(a,b){l.splice(b,1);b=n.equipments;var c=a.tags.bits,d=[];if(c&=Qb)for(var e=0;e<b.length;)b[e].tags.bits&
c?(d.push(b[e]),b.splice(e,1)):++e;n.equipments.push(a);(g=l.push).call.apply(g,[l].concat(d));var g})]);r.attach(f);var t=new T([new F(350,10,920,F.heightOf(10),k(g("Town","Skills"),n),n.skills,function(a,b){n.skills.splice(b,1);n.known.push(a)}),new F(350,360,920,F.heightOf(10),k(g("Town","Knowns"),n),n.known,function(a,b){10>n.skills.length?(n.known.splice(b,1),n.skills.push(a)):G.error(g("Town","SkillFull"))})]);t.attach(f);var v=m.length,w=function(a){var c=(e+v-a)%v;if(m[c])return x.addButton(5,
Kb,g("Town","Prev"),function(){return U.go(f,new b(f.data,c))}),"break"},x=this;for(d=1;d<v&&"break"!==w(d);++d);w=function(a){var c=(e+a)%v;if(m[c])return z.addButton(4,Lb,g("Town","Next"),function(){return U.go(f,new b(f.data,c))}),"break"};var z=this;for(d=1;d<v&&"break"!==w(d);++d);var A=f.addButton(3,[p.E],g("Town","Equipments"),function(){r.visible=!0;t.visible=!1;D.enabled=!0;A.enabled=!1});var D=f.addButton(2,[p.S],g("Town","Skills"),function(){r.visible=!1;t.visible=!0;D.enabled=!1;A.enabled=
!0});f.addButton(1,sa,g("Town","Back"),function(){return f.goTo(y)});A.onClick();return f}z(b,a);return b}(w)})(Fa||(Fa={}));var Ga;(function(a){function b(a,b){var c=a.xH;return{xH:c+[1,2,1,-1,-2,-1][b],yH:a.yH+(0===c%2?[-1,0,0,0,0,-1]:[0,0,1,1,0,0])[b]}}function c(a,b){var c=a.xH,d=b.xH,u=d-c;a=2*b.yH+d%2-(2*a.yH+c%2);return 0>a?a>u?(-u-a)/2:a>-u?(u-a)/2:-a:a<u?(u+a)/2:a<-u?(-u+a)/2:a}function e(a,b){return a===b||!!a&&!!b&&a.xH===b.xH&&a.yH===b.yH}function f(a){return 0>a?a.toString():"+"+a}function k(a,
b,c){if(a)return""+na(a);if(b)return"SP: "+na(a);if(c){a=c.deltaHPoT;b=c.deltaSPoT;c=c.mods;if(a)return"HPoT: "+na(a);if(b)return"SPoT: "+na(b);if(c)return c=c[0],g("Character",c.type)+" "+Ba(c.tags)+" "+f(c.level)}return"?"}function t(a,b,c,d,e,C,H,g,f){var h=v(0,1,C/H);C=null==g?h:v(0,1,(C+g)/H);a.save();a.fillStyle=f.bkgnd;a.fillRect(b,c,d,e);b+=1;c+=1;d-=2;e-=2;C>h?(a.fillStyle=1<=h?f.full:f.normal,a.fillRect(b,c,d*h-1,e),a.fillStyle=f.full,a.fillRect(b+d*h,c,d*(C-h),e)):C<h?(H=d*C,0<C&&(H=W(H,
2),a.fillStyle=1<=h?f.full:f.normal,a.fillRect(b,c,H-1,e)),a.fillStyle=f.delta,a.fillRect(b+H,c,d*(h-C),e)):(a.fillStyle=1<=h?f.full:f.normal,a.fillRect(b,c,d*h,e));a.restore()}function w(a,b,c,d,e){b=c.toX(e)+16;c=c.toY(e)+60;t(a,b,c,96,6,d.HP,d.maxHP,void 0,fb)}function D(a,b,c,d,e,C){b=c.toX(e)+16;c=c.toY(e)+60+6;t(a,b,c,96,6,d.SP,d.maxSP,C-d.SP,wb)}function F(a){var b=a.def.tags;b=b?b.bits:0;return b&1<<d.Fire?{r:255,g:128,b:0}:b&1<<d.Cold?{r:0,g:128,b:255}:b&1<<d.Lightning?{r:255,g:255,b:0}:
b&1<<d.Life?a.hostile?{r:255,g:0,b:128}:{r:0,g:255,b:128}:{r:255,g:255,b:255}}function L(a,b,h){var d,e=c(b,h)+1;a.straight(b,h,e,function(b,c){c===e&&a.get(b).empty&&(d=b)});return d}function P(a,b,c,d){var h=b.hex,q=c.hex;c=b.estimate(a,c,d);var e=a.promiseEffect(c,q);h=new Qa(a,h,q);b.state=h;h.hit(function(){return e.attach(a)});return x.wait.POPUP?wa([e,h]):h}function S(a,b,c,d){d=F(d);var h=Na(d),q=Na(d,0);d=a.toX(b)-a.toX(c);var e=a.toY(b)-a.toY(c);d=100+Ca(d*d+e*e,.5)/1280*400;d=new O(d,function(d,
e){var u=a.toX(b),B=a.toY(b),C=a.toX(c),H=a.toY(c);ab(e,u*(1-d)+C*d+64-20,B*(1-d)+H*d+40-20,40,40,h,q,.5)});d.attach(a);return d}function Z(a,b,c,d,e,C){function h(d,h){var e=b.getTarget(q,d);e&&(e=b.estimate(a,e,c),C&&(e.deltaHP&&(e.deltaHP=C(e.deltaHP,h)),e.deltaSP&&(e.deltaSP=C(e.deltaSP,h)),e.eot&&(e.eot.deltaHPoT&&(e.eot.deltaHPoT=C(e.eot.deltaHPoT,h)),e.eot.deltaSPoT&&(e.eot.deltaSPoT=C(e.eot.deltaSPoT,h)))),d=a.promiseEffect(e,d),d.attach(a),u.push(d))}var q=a.field,u=[];h(d,0);q.surround(d,
e,h);var B=F(c),f=Na(B,0),g=new O(400,function(b,c){var h=a.toX(d)+64,q=a.toY(d)+40,u=128*e*b,C=80*e*b,H=Na(B,1-b);ab(c,h-u,q-C,2*u,2*C,H,f,b)});g.attach(a);return x.wait.POPUP?(u.push(g),wa(u)):g}var Q=Ca(2,.1),ka=[{lineWidth:2,fillStyle:m(0,0,68),strokeStyle:m(204,204,255)},{lineWidth:2,fillStyle:m(68,0,0),strokeStyle:m(255,204,204)}],M={fillStyle:"white",textAlign:"left",textBaseline:"top"},ea=y(0,0,0,0),ma=y(0,0,0,.75),fa={inner:m(230,255,180),outer:m(51,230,51)},sa={inner:m(230,180,255),outer:m(51,
51,230)},qa={inner:m(255,180,230),outer:m(230,51,51)},ra={inner:m(230,180,255),outer:m(51,51,230)},ta={outer:m(64,192,255),inner:m(180,232,255),bkgnd:y(64,192,255,.3)},xa={outer:m(255,192,64),inner:m(255,232,192),bkgnd:y(255,192,64,.3)},Aa={DASH_OR_RANGE:{outer:m(255,64,64),inner:m(255,180,180),bkgnd:y(255,192,64,.3)},RANGE:{outer:m(255,64,64),inner:m(255,180,180),bkgnd:y(255,128,64,.3)},TARGET:{outer:m(255,24,24),inner:m(255,64,64),bkgnd:y(255,24,24,.3)}},Ga={DASH_OR_RANGE:{outer:m(24,24,255),inner:m(180,
180,255),bkgnd:y(255,192,64,.3)},RANGE:{outer:m(64,64,255),inner:m(180,180,255),bkgnd:y(24,128,255,.3)},TARGET:{outer:m(24,24,255),inner:m(64,64,255),bkgnd:y(24,24,255,.3)}},Ia=y(0,0,0,.65),Ja=y(0,0,0,0),Oa={textAlign:"center",textBaseline:"bottom",fontSize:32,fillStyle:"yellow",strokeStyle:"black",lineWidth:2},Ra={textAlign:"center",textBaseline:"bottom",fontSize:32,fillStyle:"red",strokeStyle:"black",lineWidth:2},Da=y(255,0,0,.8),Va=m(255,180,180),Wa=m(180,255,180),Xa=[{messageID:"PartyTurn",innerStyle:m(0,
0,128),outerStyle:y(0,0,128,0),textStyle:{fontSize:64,fillStyle:"white",textAlign:"center",textBaseline:"middle"}},{messageID:"EnemyTurn",innerStyle:m(128,0,0),outerStyle:y(128,0,0,0),textStyle:{fontSize:64,fillStyle:"white",textAlign:"center",textBaseline:"middle"}}],Ya=function(){function a(a,b){this.dummy=b;this.cells={};this.depth=A(a)}Object.defineProperty(a.prototype,"minXH",{get:function(){return 1+mb(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxXH",{get:function(){return 20+
A(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"minVisibleXH",{get:function(){return A(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxVisibleXH",{get:function(){return 21+mb(this.depth)},enumerable:!0,configurable:!0});a.prototype.contains=function(a,b){if(null==a)return!1;null==b&&(b=a,a=b.xH,b=b.yH);return 0<=b&&3>b&&this.minXH<=a&&a<this.maxXH};a.prototype.getLine=function(a){return this.cells[a]};a.prototype.setLine=function(a,
b){this.cells[a]=b};a.prototype.deleteLine=function(a){delete this.cells[a]};a.prototype.rawget=function(a,b){null==b&&(b=a,a=b.xH,b=b.yH);if(0<=b&&3>b&&this.minVisibleXH<=a&&a<this.maxVisibleXH&&(a=this.cells[a]))return a[b]};a.prototype.get=function(a,b){null==b&&(b=a,a=b.xH,b=b.yH);b=this.rawget(a,b);return void 0===b?this.dummy:b};a.prototype.set=function(a,b,c){null==c&&(c=b,b=c.xH,c=c.yH);var d=this.cells[b];d||(d=this.cells[b]=[]);d[c]=a};a.prototype.each=function(a){for(var b=this.maxXH,c=
this.minXH;c<b;++c)for(var d=0;3>d;++d)a(this.get(c,d),c,d)};a.prototype.eachVisible=function(a){for(var b=this.maxVisibleXH,c=this.minVisibleXH;c<b;++c)for(var d=0;3>d;++d)a(this.get(c,d),c,d)};a.prototype.straight=function(a,b,d,B){if(!e(a,b)){var h=a.xH,q=1+2*(2*a.yH+a.xH%2),u=b.xH,f=1+2*(2*b.yH+b.xH%2);a=c(a,b);u=(u-h)/a;f=(f-q)/a;for(a=1;a<=d;++a){var g=h+a*u;b=A((q+a*f)/2);g=0===b%2?2*A((g+1)/2):2*A(g/2)+1;b=A(b/2);this.contains(g,b)&&B({xH:g,yH:b},a)}}};a.prototype.surround=function(a,c,d){if(1===
c)for(var h=0;6>h;++h){var q=b(a,h);this.contains(q)&&d(q,1)}else if(1<c){a=b(a,0);for(var e=1;e<=c;++e){q=a;for(var u=0,f=[2,3,4,5,0,1];u<f.length;u++){h=f[u];for(var g=0;g<e;++g,q=b(q,h))this.contains(q)&&d(q,e)}a=b(a,0)}}};return a}(),ja=function(){function a(a){this.duration=a}a.prototype.then=function(a){this.duration?this.sig=la(this.sig,a):N.then(a);return this};a.prototype.commit=function(){da(this.sig);this.duration=this.sig=void 0};a.prototype.getXY=function(a,b,c){if(this.duration)if(c=
O.clamp(c,this.start,this.duration),1<=c)this.commit();else return this.onGetXY(a,b,c)};a.prototype.drawCharacter=function(a,b,c,d,e,H,f){a.drawCharacter(b,c,d,e,H,f)};return a}(),Ka=function(a){function b(b){return a.call(this,400*(13-b)/4)||this}z(b,a);b.prototype.onGetXY=function(a,b,c){a=a.hex;return{x:b.toX(a)-128*(1-c)+64,y:b.toY(a)+80}};return b}(ja),Ha=function(a){function b(b){var c=a.call(this,100*Ca(b.length-1,.75))||this;c.path=b;return c}z(b,a);b.prototype.onGetXY=function(a,b,c){var d=
this.path.length-1,h=A(d*c),q=this.path[h],e=this.path[h+1];a=b.toX(q);q=b.toY(q);var B=b.toX(e);b=b.toY(e);c=d*c-h;return{x:a*(1-c)+B*c+64,y:q*(1-c)+b*c+80}};return b}(ja),Qa=function(a){function b(b,c,d){b=a.call(this,function(a,b,c){var d=a.toX(b)-a.toX(c);a=a.toY(b)-a.toY(c);return 200+Ca(d*d+a*a,.3)/1280*1E3}(b,c,d))||this;b.hexFrom=c;b.hexTo=d;return b}z(b,a);b.prototype.hit=function(a){this.duration?this.hitsig=la(this.hitsig,a):N.then(a)};b.prototype.commit=function(){da(this.hitsig);this.hitsig=
void 0;a.prototype.commit.call(this)};b.prototype.onGetXY=function(a,b,c){var d=this.hexFrom,h=this.hexTo;a=b.toX(d);d=b.toY(d);var q=b.toX(h);b=b.toY(h);.5>c?c*=2:(c=2-2*c,da(this.hitsig),this.hitsig=void 0);return{x:a*(1-c)+q*c+64,y:d*(1-c)+b*c+80}};return b}(ja),Sa=function(a){function b(b,c){var d=a.call(this,500)||this,h=b.HP;d.dying=c>=h?b.hex:void 0;d.radius=c>=h/2?1:.5+c/h;return d}z(b,a);b.prototype.onGetXY=function(a,b,c){a=this.dying||a.hex;b={x:b.toX(a)+64,y:b.toY(a)+80};this.duration&&
(a=20*(1-c)*this.radius,c=c*Y*this.duration/250*this.radius,b.x+=a*X(4*c),b.y+=a*X(3*c));return b};b.prototype.drawCharacter=function(b,c,d,e,f,g,u){this.dying?(g=O.clamp(d,this.start,this.duration),c.save(),c.globalAlpha=1-g,a.prototype.drawCharacter.call(this,b,c,d,e,f,"red",g),c.restore()):a.prototype.drawCharacter.call(this,b,c,d,e,f,g,u)};return b}(ja),pb=function(){function a(a,b,c){this.ch=a;this.team=b;this._hex=c;this.idleOffset=Za();this.effectsOverTime=[];this.HP=this.maxHP;b=this.minCost=
this.SP=this.availSP;var d;c=0;for(var h=a.skills;c<h.length;c++){var e=h[c];if(a.itemFor(e)){var q=this.costOf(e);!d&&0<a.rangeOf(e)&&q<=b&&(d=e);q<this.minCost&&(this.minCost=q)}}this.skill=d||gb.DUMMY}Object.defineProperty(a.prototype,"hex",{get:function(){return this._hex},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"alive",{get:function(){return!!this._hex},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"name",{get:function(){return this.ch.name},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"level",{get:function(){return this.ch.level},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"INT",{get:function(){return this.ch.INT},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEX",{get:function(){return this.ch.DEX},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"STR",{get:function(){return this.ch.STR},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxHP",{get:function(){return this.ch.HP},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxSP",{get:function(){return this.ch.SP},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"availSP",{get:function(){return W(0,this.ch.SP-this.ch.reservedSP)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"step",{get:function(){return this.ch.step},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ZoC",{get:function(){return this.ch.ZoC},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"DEF",{get:function(){return this.ch.DEF},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"skills",{get:function(){return this.ch.skills},enumerable:!0,configurable:!0});a.prototype.costOf=function(a){return this.ch.costOf(a)};a.prototype.rangeOf=function(a){return this.ch.rangeOf(a)||0};a.prototype.getModsLevel=function(a,b){function c(a,b,c){var d=0;if(c)for(var h=0;h<c.length;h++){var e=c[h];e.type===b&&a&e.tags.bits&&(d+=e.level)}return d}for(var d=this.level,h=0,e=this.ch.skills;h<
e.length;h++){var f=e[h].def;"passive"===f.usage&&(d+=c(a,b,f.mods))}h=0;for(e=this.effectsOverTime;h<e.length;h++)d+=c(a,b,e[h].mods);return d};a.prototype.getOutgoingLevel=function(a){return this.getModsLevel(a,"outgoing")};a.prototype.getIncomingLevel=function(a){return this.getModsLevel(a,"incoming")};a.prototype.isEnemy=function(a){return!!a&&this.team!==a.team};a.prototype.isTarget=function(a,b){return a?"dose"===b.usage?this===a:b.hostile?this.isEnemy(a):this!==a&&!this.isEnemy(a):!1};a.prototype.getTarget=
function(a,b){a=a.get(b).unit;if(this.isTarget(a,this.skill))return a};a.prototype.done=function(a){var b=this._hex;return a.enabled&&!!b&&this.SP<this.minCost&&this.SP<this.step+a.zoc[this.team].get(b)};a.prototype.estimate=function(a,b,c){function d(a){return mb(a*Ca(Q,g-(0>a?u:k)))}function h(a){if(a)return d(e*a/100*(100-q)/100)}ha(this.isTarget(b,c));var e=this.ch.itemFor(c).ATK,q=b.DEF,f=c.def;c=f.tags?f.tags.bits:0;var g=this.getOutgoingLevel(c),u=b.getIncomingLevel(c),k=a.getLevel(c);return{target:b,
deltaHP:h(f.deltaHP),deltaSP:h(f.deltaSP),eot:function(a){if(a)return{turns:a,deltaHPoT:h(f.deltaHPoT),deltaSPoT:h(f.deltaSPoT),mods:r(f.mods,function(a){return{type:a.type,level:d(a.level),tags:a.tags}})}}(f.turns)}};a.prototype.shoot=function(a,b,c){this.isTarget(b,c);var d=this.costOf(c);a:{var h=c.AID;if(h){var e=eb[h];if(e)break a}throw new RangeError('Action not found: "'+h+'"');}a=e(a,this,b,c);this.SP-=d;return a};a.prototype.recuperate=function(){var a=A(.1*this.maxHP);this.HP=V(this.maxHP,
this.HP+a)};Object.defineProperty(a.prototype,"canRevive",{get:function(){return!this._hex&&.5<=this.HP/this.maxHP},enumerable:!0,configurable:!0});a.prototype.onTurnEnd=function(a){this.team===a.team&&(this.SP=this.availSP)};a.prototype.onTurnStart=function(a){if(this.team===a.team){for(var b=0,c=this.effectsOverTime,d=c.length-1;0<=d;--d){var e=c[d];null!=e.deltaHPoT&&(b+=e.deltaHPoT);0>=--e.turns&&c.splice(d,1)}if(b)return b=a.promiseEffect({target:this,deltaHP:b},this.hex),b.attach(a),b}};a.prototype.getXY=
function(a,b){if(this.state){var c=this.state.getXY(this,a,b);c||(this.state=void 0)}c||(b=this._hex)&&(c={x:a.toX(b)+64,y:a.toY(b)+80});return c};Object.defineProperty(a.prototype,"state",{get:function(){return this._state},set:function(a){var b=this._state;if(this._state=a)a.start=performance.now();b&&b.commit()},enumerable:!0,configurable:!0});a.prototype.drawCharacter=function(a,b,c,d,e,f){var h=this.ch,q=Ma(h,128,128),g=q.w,H=.2*g;ab(a,c-g/2,d-10-H/2,g,H,Ia,Ja,.75);b&&(g=200*(13-h.DEX),g=W(0,
X(2*Y*(this.idleOffset+b%g/g))),d-=16*g+10*(1-g));q.x=c-q.w/2;q.y=d-q.h;h.draw(a,b,q,e,f)};a.prototype.draw=function(a,b,c,d,e,f){this.state?this.state.drawCharacter(this,a,b,c,d,e,f):this.drawCharacter(a,b,c,d,e,f)};a.prototype.drawBars=function(a,b,c,d,e){var h=this.hex;b=c.toX(h)+16;c=c.toY(h)+60;t(a,b,c,96,6,this.HP,this.maxHP,d,fb);t(a,b,c+6,96,6,this.SP,this.maxSP,e,wb)};a.compare=function(a,b){return a.y<b.y?-1:a.y>b.y?1:a.x<b.x?-1:a.x>b.x?1:0};return a}(),Ta=function(){function a(a,b){void 0===
a&&(a=0);this.type=a;this.unit=b}Object.defineProperty(a.prototype,"empty",{get:function(){return null==this.unit&&0===this.type},enumerable:!0,configurable:!0});a.DUMMY=new a(1);return a}(),Ua=function(a){function c(d,q,f){function h(a){var b=this,c=q.hex,h=d.field,f=d.numScrollsPerTurn,g=this.get(a).SP,B=k.get(a),H=na(2*a.yH+a.xH%2-3),C=h.minXH+f,u=a.xH<C,l=function(c){var d=b.get(c).SP;if(g>d)return!0;if(g<d)return!1;d=c.xH<C;if(!u&&d)return!0;if(u&&!d)return!1;d=k.get(c);return B<d?!0:B>d?!1:
a.xH<c.xH?!0:a.xH>c.xH?!1:H<na(2*c.yH+c.xH%2-3)};h.surround(a,p,function(g){if(!e(g,c)){var f=b.ensure(g);if(f.shotFrom)l(f.shotFrom)&&(f.shotFrom=a);else if(f.shotFrom=a,g=q.getTarget(h,g))f.effect=q.estimate(d,g,n)}})}var g=this,B=d.field;g=a.call(this,B.depth,c.DUMMY)||this;var k=d.zoc[q.team],u=q.hex,l=q.step,n=q.skill,m=q.costOf(n),p=q.rangeOf(n);g.ensure(u).SP=f;if(f>=l+k.get(u))for(var r=[],R=u;R;R=r.shift()){var t=g.get(R).SP-(l+k.get(R));if(0<=t)for(var v=0;6>v;++v){var w=b(R,v),aa=B.rawget(w);
aa&&0===aa.type&&!q.isEnemy(aa.unit)&&(aa=g.ensure(w),aa.SP<t||aa.SP===t&&B.get(R).empty&&(!aa.comeFrom||!B.get(aa.comeFrom).empty))&&(aa.SP=t,aa.comeFrom=R,t>=l+k.get(w)&&r.push(w))}}f>=m&&1<=p&&(h.call(g,u),g.each(function(a,b,c){a.SP>=m&&B.get(b,c).empty&&h.call(g,{xH:b,yH:c})}));return g}z(c,a);c.prototype.ensure=function(a){var b=this.rawget(a);b||(b={SP:-1},this.set(b,a));return b};c.prototype.getPath=function(a,b){var c=this.get(a);if(c){var d=c.comeFrom,h=c.shotFrom;if(c.effect&&h){if(!b.get(h).empty)return;
a=[h];d=this.get(h).comeFrom}else if(d){if(!b.get(a).empty)return;a=[a]}else return;for(;d;)a.unshift(d),d=this.get(d).comeFrom;return a}};c.DUMMY={SP:-1};return c}(Ya),bb=function(a){function b(c,d,e,f,H,k){e=a.call(this,e,f,H,k,new E(function(){var a=c.focus;if(a){var b=a.skills[d];if(b){var h=b.def;if("passive"===h.usage)return h=h.mods[0],b.name.localized+"\n"+g("Character",h.type)+": "+Ba(h.tags);h=a.skill===b;var e=a.costOf(b);a=a.rangeOf(b);var q=na(b.def.deltaHP||0);return""+(h?"E ":"")+b.name.localized+
"\n"+e+" / "+a+" / "+jb(q,1)}}},{fontSize:20}),function(){if(this.enabled){var a=this.scene.focus,b=a.skills[this.index];"dose"===b.usage?c.controller.dose(a,b):(a.skill=b,c.onSkillChanged(a))}},void 0,b.design)||this;e.scene=c;e.index=d;return e}z(b,a);Object.defineProperty(b.prototype,"visible",{get:function(){var a=this.scene.focus;return!!a&&!!a.skills[this.index]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"enabled",{get:function(){var a=this.scene.focus;if(a){var b=a.skills[this.index];
if(b&&a.ch.itemFor(b))return a.SP>=a.costOf(b)}return!1},enumerable:!0,configurable:!0});b.design={draw:function(a,b,c){if(c.visible){var d=c.scene.focus;if(0<d.rangeOf(d.skills[c.index]))I.defaultDesign.draw(a,b,c);else{var e=I.defaultDesign.getStyle(c.state),h=d=void 0,q=void 0;if(null==d||null==h){h=c;var f=h.x;var g=h.y;d=h.w;h=h.h;q=e}else f=c,g=e;if(0<d&&0<h){a.save();$a(a,q);if(!q||q.strokeStyle)e=a.lineWidth-1,f+=e/2,g+=e/2,d-=e,h-=e;e=.2*V(d,h);a.beginPath();a.moveTo(f+e,g);a.lineTo(f+d-
e,g);a.quadraticCurveTo(f+d,g,f+d,g+e);a.lineTo(f+d,g+h-e);a.quadraticCurveTo(f+d,g+h,f+d-e,g+h);a.lineTo(f+e,g+h);a.quadraticCurveTo(f,g+h,f,g+h-e);a.lineTo(f,g+e);a.quadraticCurveTo(f,g,f+e,g);q&&!q.fillStyle||a.fill();q&&!q.strokeStyle||a.stroke();a.restore()}c.drawable&&c.drawable.draw(a,b,c)}}}};return b}(I);ja=function(){function a(a,b,c){void 0===c&&(c=2);this.level=b;this.numScrollsPerTurn=c;a="assets/"+("level/"+a+"/");this.imgSky=new J(a+"sky.png");this.imgCells=[new J(a+"tile.png"),new J(a+
"hole.png")]}a.prototype.generate=function(a,b){var c=0,d=0;a.eachUnit(function(a){0===a.team?++c:++d});for(var e=0===c?.3:.3*Ca(1.1,c-d),h=Array(3),f=La(xb),g=0;3>g;++g){var k=void 0,u=0;12<b&&Za()<e?(k=f[ca(f.length)],k=ba.monster(k,a.getLevel()),k=new pb(k,1,{xH:b,yH:g})):6<b&&.1>Za()&&(u=1);h[g]=new Ta(u,k)}return h};a.prototype.draw=function(a,b,c){var d=this,e=c.field,h=this.imgSky.image;if(h){a.save();var q=128*e.depth/2;a.fillStyle=a.createPattern(h,"repeat");a.translate(-q,0);a.fillRect(0+
q,0,1280,80);a.restore()}var g={x:0,y:0,w:128,h:80};e.eachVisible(function(e,h,q){e=e.type;g.x=c.toX(h,q);g.y=c.toY(h,q);d.imgCells[e].draw(a,b,g)})};return a}();a.EndressStage=ja;ja=function(a){function b(b,c){function d(a,b,c){return new I(10+110*b,570,100,140,{draw:function(a,b,d){var h=c.ch,e=Ma(h,d.w,d.h,!0);e.x=d.x+(d.w-e.w)/2;e.y=d.y+(d.h-e.h)/2;c.alive||c.canRevive?h.draw(a,b,e):(h=h.images,(h[Ea.DEAD]||h[Ea.DEFAULT]).draw(a,b,e));t(a,d.x+10,d.y+128,80,6,c.HP,c.maxHP,void 0,fb)}},function(){if(c.alive)q.click(c.hex);
else if(c.canRevive){for(var d=f.minXH,h=b%3,e=0;3>e;++e){if(f.get(d,h).empty){a.revive(c,{xH:d,yH:h});return}h=(h+1)%3}G.error(g("Combat","NoSpaceToRevive"))}else G.error(g("Combat","CannotRevive"))},[p.$1+b])}function e(a,b,c,d,h){b=new I(1280-150*b,570,140,140,new E(c),d);h&&ua(b,"enabled",h);b.attach(a);return b}var h=a.call(this)||this;h.data=b;h.stage=c;h.team=0;h.enabled=!1;var f=h.field=new Ya(0,Ta.DUMMY);h.dying=[];h.deads=[];h.snapshots=[];var q=new cb;q.attach(h);q.visible=!1;c=new db;
c.attach(h);c.visible=!1;var k=f.minVisibleXH;for(c=f.maxVisibleXH;k<c;++k)f.setLine(k,h.stage.generate(h,k));c=[];var l=[[2,0],[2,1],[2,2],[1,0],[1,1],[1,2]],n=b.party;for(b=0;6>b;++b){var m=n[b];if(m){var u=l[b];k=u[0];k={xH:k,yH:u[1]};u=new pb(m,0,k);u.state=new Ka(m.DEX);f.rawget(k).unit=u;c.push(d(h,b,u))}}var r=new T(c);ua(r,"visible",function(){return q.visible&&!h.focus});r.attach(h);e(r,1,g("Combat","End"),function(){return h.endTurn()});e(r,2,g("Combat","Undo"),function(){return q.undo()},
function(){return q.canUndo});e(r,3,g("Combat","Retire"),function(){return h.retire()});var R=e(r,4,g("Combat","View"));c=new ia;c.onDraw=function(a,b){return h.drawUnits(a,b,h.focusTime)};c.attach(h);c=new ia;c.onDraw=function(a,b){return h.drawBarsOnView(a,b)};ua(c,"visible",function(){return r.visible&&(R.hover||R.pressed)});c.attach(h);c=new T;ua(c,"visible",function(){return!!h.focus});c.attach(h);l=new ia;l.onDraw=function(a,b){return h.drawBarsOnFocus(a,b,h.focus,h.controller.caret)};l.attach(c);
var v=new pa(0,560,1280,160);v.onDraw=function(a,b){return h.drawPanel(a,b,v,h.focus)};v.attach(c);c=new T;ua(c,"visible",function(){return q.visible&&!!h.focus});c.attach(h);for(b=0;10>b;++b)(new bb(h,b,400+170*A(b/2),570+b%2*75,160,65)).attach(c);var w=function(){var a=h.focus;if(a&&h.enabled){a=h.mapFor(a);var b=h.controller.caret;if(b&&(a=a.get(b).effect))return a.target}},x=new pa(640,560,640,160);ua(x,"visible",function(){return!!w()});x.onDraw=function(a,b){return h.drawPanel(a,b,x,w())};x.attach(h);
if(c=System.canvas.getContext("2d"))(new K(0,0,128,560,new lb({fillStyle:ib(c,0,0,128,0,ma,ea)}))).attach(h),(new K(1152,0,1280,560,new lb({fillStyle:ib(c,1152,0,1280,0,ea,ma)}))).attach(h);kb(h);h.startTurn();return h}z(b,a);Object.defineProperty(b.prototype,"controller",{get:function(){return this.children[this.team]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"numScrollsPerTurn",{get:function(){return this.stage.numScrollsPerTurn},enumerable:!0,configurable:!0});b.prototype.getLevel=
function(a){var b=this.stage;a=b.level;b=b.numScrollsPerTurn;0<b&&(a+=this.field.depth/b*.1);return a};Object.defineProperty(b.prototype,"focus",{get:function(){return this._focus},set:function(a){a?this._focus!==a&&(this._focus=a,this.focusTime=performance.now()):this.focusTime=this._focus=void 0},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"zoc",{get:function(){var a=this._zoc;if(!a){a=this.field.depth;var b=[new Ya(a,0),new Ya(a,0)];this.eachUnit(function(a){var c=a.ZoC;if(0<
c){var d=b[0===a.team?1:0];d.surround(a.hex,1,function(a){return d.set(d.get(a)+c,a)})}});this._zoc=a=b}return a},enumerable:!0,configurable:!0});b.prototype.mapFor=function(a){var b=this.maps;b||(this.maps=b=new Ya(this.field.depth,void 0));var c=a.hex,d=b.rawget(c);d||(d=new Ua(this,a,a.SP),b.set(d,c));return d};b.prototype.onSkillChanged=function(a){var b=a.hex,c=this.maps,d=this.snapshots;c&&c.set(void 0,b);if(d)for(b=0;b<d.length;b++)c=d[b],c.unit===a&&c.maps.set(void 0,c.hex)};b.prototype.savepoint=
function(a){this.snapshots.push({unit:a,hex:a.hex,SP:a.SP,maps:this.maps,zoc:this.zoc})};b.prototype.rollback=function(){var a=this.snapshots.pop(),b=a.unit;this.setUnit(b,a.hex);b.SP=a.SP;this._zoc=a.zoc;this.maps=a.maps;this.focus=b};b.prototype.setUnit=function(a,b){var c=this.field,d=c.rawget(b),e=d.unit;if(a){if(e===a)return;if(e=a._hex)c.rawget(e).unit=void 0;a._hex=b}else e&&(e._hex=void 0);d.unit=a;this.invalidate()};b.prototype.revive=function(a,b){var c=this.deads,d=c.indexOf(a);c.splice(d,
1);a.SP=a.availSP;a.state=new Ka(a.DEX);this.setUnit(a,b);this.snapshots.length=0};b.prototype.invalidate=function(){this.maps=this._zoc=void 0};b.prototype.startTurn=function(){for(var a=this,b=this.team,c=0,d=this.deads;c<d.length;c++){var e=d[c];e.team===b&&e.recuperate()}var f;this.eachUnit(function(b){(b=b.onTurnStart(a))&&(f?f.push(b):f=[b])});b=function(){a.enabled=!0;a.controller.visible=!0};f?wa(f).then(b):b()};b.prototype.retire=function(){var a=this;Pa.confirm(this,g("Combat","ConfirmRetire"),
{label:g("Combat","Retire"),click:function(){a.controller.visible=!1;U.go(a,new Fa.Home(a.data))},mnemonic:nb},{label:g("Config","Cancel"),mnemonic:ob})};b.prototype.endTurn=function(){var a=this;this.enabled=!1;this.snapshots.length=0;this.controller.visible=!1;this.eachUnit(function(b){b.onTurnEnd(a)});if(0===this.team){var b=this.numScrollsPerTurn;if(0<b){var c=this.field.minXH+b;this.eachUnit(function(b){b.hex.xH<c&&(b.state=new Sa(b,b.HP),a.kill(b))});var d=this.field.depth;(new O(400*b,function(c){a.scrollTo(d+
b*c)})).attach(this);if(this.isGameOver)return}}this.team=0===this.team?1:0;var e=Xa[this.team],f=e.innerStyle,k=e.outerStyle,l=e.textStyle,n=g("Combat",e.messageID);(new O(800,function(a,b){b.save();b.globalAlpha=X(Y*a);ab(b,0,0,1280,560,f,k);za(b,n.localized,640,280,l);b.restore()})).then(function(){a.startTurn()}).attach(this)};b.prototype.dose=function(a,b){var c=this;ha(a.SP>=a.costOf(b));this.focus=a;this.enabled=!1;this.snapshots.length=0;this.invalidate();return a.shoot(this,a,b).then(function(){c.enabled=
!0;a.done(c)&&(c.focus=void 0)})};b.prototype.move=function(a,b){var c=this;ha(!e(b,a.hex));var d=function(){c.enabled=!0;a.done(c)&&(c.focus=void 0)};this.focus=a;var h=this.field,f=a.skill,g=this.mapFor(a),q=g.get(b);if(q.effect){ha(a.SP>=a.costOf(f));this.enabled=!1;var k=q.effect.target;ha(a.isTarget(k,f));var l=function(){c.snapshots.length=0;c.invalidate();return a.shoot(c,k,f).then(d)};if(e(q.shotFrom,a.hex))return l();h=g.getPath(b,h);q=h[h.length-1];ha(!e(q,b));ha(!e(q,a.hex));this.setUnit(a,
q);a.SP=g.get(q).SP;b=a.state=new Ha(h);l=hb(l);b.then(l);return l}ha(0<=q.SP&&h.get(b).empty);h=g.getPath(b,h);this.setUnit(a,b);a.SP=q.SP;b=a.state=new Ha(h);d();return x.wait.WALK?b:N};b.prototype.findUnit=function(a,b,c){var d=this.field,e=d.minXH,h=d.maxXH,f=(0===this.team?b:!b)?1:-1;b=b?1:-1;if(a){var g=a.xH;a=a.yH}else g=0>f?e:h-1,a=0>b?0:2;for(var q=1,k=3*(h-e+1);q<k;++q){a+=b;if(0>a||3<=a)a=0>a?2:0,g+=f,g<e?g=h-1:h<=g&&(g=e);var l=d.get(g,a).unit;if(l&&c(l))return l}};b.prototype.kill=function(a){var b=
this;a.alive&&(a.HP=0,this.setUnit(void 0,a.hex),this.dying.push(a));0===a.team&&(this.deads.push(a),this.parent&&this.isGameOver&&(this.controller.visible=!1,(a.state||N).then(function(){Pa.confirm(b,g("Combat","GameOver"),{label:g("Combat","Retire"),click:function(){return U.go(b,new Fa.Home(b.data))},mnemonic:tb})})))};Object.defineProperty(b.prototype,"isGameOver",{get:function(){return!this.findUnit(void 0,!0,function(a){return 0===a.team})},enumerable:!0,configurable:!0});b.prototype.promiseEffect=
function(a,b){var c=this,d=a.target,e=a.eot,h=a.deltaHP||0,f=a.deltaSP||0;a=0>h||!h&&0>f;var g=this.toX(b)+64,q=this.toY(b)+80,l=k(h,f,e),n=a?Va:Wa,m=new O(600,function(a,b){b.save();b.font=va(48);var c=b.measureText(l).width;b.restore();c=48/W(1,.7*c/128);za(b,l,g,q-40*a,{fontSize:c,fillStyle:n,strokeStyle:"black",globalAlpha:X(Y*a),lineWidth:4,textAlign:"center",textBaseline:"bottom"})}),u=m.attach;m.attach=function(a){0>h&&(d.state=new Sa(d,-h));h&&(d.HP=v(0,d.maxHP,d.HP+h));f&&(d.SP=v(0,d.maxSP,
d.SP+f));0>=d.HP?c.kill(d):e&&d.effectsOverTime.push(e);return u.call(m,a)};return m};b.prototype.eachUnit=function(a){this.field.eachVisible(function(b){(b=b.unit)&&a(b)})};b.prototype.toX=function(a,b){var c;null==b?(d=a,c=d.xH):c=a;return 0+64*(c-1-this.field.depth);var d};b.prototype.toY=function(a,b){null==b&&(b=a,a=b.xH,b=b.yH);return 80+80*(2*b+a%2)};b.prototype.toHex=function(a,b){var c=this.field;a=a-0+128*c.depth/2;b=A((b-0-80)/80);if(0<=b&&6>b&&(a=0===b%2?2*A((a+64)/128):2*A(a/128)+1,c.minXH<=
a&&a<c.maxXH))return c=A(b/2),{xH:a,yH:c}};b.prototype.scrollTo=function(a){var b=this.field;if(a>b.depth){var c=b.minVisibleXH,d=b.maxVisibleXH;b.depth=a;a=b.minVisibleXH;for(var e=b.maxVisibleXH;c<a;++c)b.deleteLine(c);for(c=W(a,d);c<e;++c)b.setLine(c,this.stage.generate(this,c))}};b.prototype.onDraw=function(b,c){this.stage.draw(b,c,this);var d=this.focus;d&&this.enabled&&this.drawMarkers(b,c,this.focusTime,this.mapFor(d),d);a.prototype.onDraw.call(this,b,c)};b.prototype.drawMarkers=function(a,
b,c,d,e){var h=this,f=O.clamp(b,c,300);if(!(0>=f)){var g=e.costOf(e.skill);b=e.skill.hostile?Aa:Ga;var q=b.DASH_OR_RANGE,k=b.RANGE,l=b.TARGET;a.save();1>f&&(a.globalAlpha=f);d.eachVisible(function(b,c,d){var e=b.SP,n=b.shotFrom,m=0,u=0;if(b.effect){var B=l;m=32*(1-f);u=20*(1-f)}else e>=g?B=ta:0<=e?B=n?q:xa:n&&(B=k);B&&(b=h.toX(c,d)-m,c=h.toY(c,d)-u,m=128+2*m,u=80+2*u,a.fillStyle=B.bkgnd,a.fillRect(b+5,c+5,m-10,u-10),a.strokeStyle=B.outer,a.lineWidth=2,a.strokeRect(b+2,c+2,m-4,u-4),a.strokeStyle=B.inner,
a.lineWidth=1,a.strokeRect(b+4,c+4,m-8,u-8))});a.restore()}};b.prototype.drawUnits=function(a,b,c){var d=this,e=this.focus,h=this.enabled?this.zoc:void 0,f=[];this.eachUnit(function(a){var c=a.getXY(d,b);c.unit=a;f.push(c)});for(var q=0;q<this.dying.length;){var k=this.dying[q],l=k.getXY(this,b);l?(l.unit=k,f.push(l),++q):this.dying.splice(q,1)}f.sort(pb.compare);q=g("Combat","Done").localized;c=(1-oa(2*Y*O.cycle(b,c,1E3)))/2*.5;l="blue";var m;e&&(e.skill.hostile&&(l="red"),this.enabled&&(m=this.mapFor(e)));
for(var n=0;n<f.length;n++){var u=f[n];k=u.unit;var B=u.x;u=u.y;var p=void 0;m&&(e===k?p="yellow":k.alive&&m.get(k.hex).effect&&(p=l));k.draw(a,b,B,u,p,c);if(!k.state&&h&&k.alive){p=k.SP;var r=k.step,R=k.team;p<k.minCost&&(p<r?za(a,q,B,u,Oa):p<r+h[R].get(k.hex)&&za(a,q,B,u,Ra))}}};b.prototype.drawBarsOnView=function(a,b){var c=this;this.eachUnit(function(d){return d.drawBars(a,b,c)})};b.prototype.drawBarsOnFocus=function(a,b,c,d){var f=this;if(c&&this.enabled){var h=this.mapFor(c);h.each(function(c){(c=
c.effect)&&c.target.drawBars(a,b,f,c.deltaHP,c.deltaSP)});if(d){var g=h.get(d);g.effect?(d=g.shotFrom,g=c.costOf(c.skill),e(d,c.hex)?c.drawBars(a,b,this,void 0,-g):(w(a,b,this,c,c.hex),D(a,b,this,c,d,h.get(d).SP-g))):0<g.SP&&this.field.get(d).empty?(w(a,b,this,c,c.hex),D(a,b,this,c,d,g.SP)):c.drawBars(a,b,this)}else c.drawBars(a,b,this)}};b.prototype.drawPanel=function(a,b,c,d){ya(a,c,ka[d.team]);var e=d.ch,h=Ma(e,128,128);h.x=c.x+10+(128-h.w)/2;h.y=c.y+(c.h-h.h)/2;e.draw(a,b,h);za(a,d.name+" / Lv: "+
jb(d.level,1)+"\n"+("HP: "+d.HP+" / SP: "+d.SP),c.x+148,c.y+10,M);b=d.effectsOverTime;d=0;for(e=b.length;d<e;++d){var k=b[d];h="["+k.turns+"] ";k.deltaHPoT?h+="HP: "+f(k.deltaHPoT):k.deltaSPoT?h+="SP: "+f(k.deltaSPoT):k.mods?(k=k.mods[0],h+=g("Character",k.type)+" "+Ba(k.tags)+" "+f(k.level)):h+="?";za(a,h,c.x+148,c.y+10+1.2*(M&&M.fontSize||24)*(d+2),M)}};return b}(T);a.Scene=ja;var cb=function(a){function c(){var b=null!==a&&a.apply(this,arguments)||this;b.mode=0;return b}z(c,a);Object.defineProperty(c.prototype,
"caret",{get:function(){return this._caret},set:function(a){this._caret=a;if(0===this.mode){var b=this.parent;b.focus=a?b.field.get(a).unit:void 0}},enumerable:!0,configurable:!0});c.prototype.finish=function(a){var b=this,c=this.parent,d=function(){c.focus||(b.mode=0)};c.enabled?d():a.then(d)};c.prototype.dose=function(a,b){var c=this.parent;this.mode=1;this.finish(c.dose(a,b))};Object.defineProperty(c.prototype,"canUndo",{get:function(){return 0<this.parent.snapshots.length||1<=this.mode},enumerable:!0,
configurable:!0});c.prototype.undo=function(){var a=this.parent,b=a.snapshots,c=b.length;b=0<c?b[c-1].unit:void 0;1<=this.mode&&b!==a.focus?this.mode=0:b?a.rollback():G.error(g("Combat","CannotUndo"));this.caret=this._caret};c.prototype.onHover=function(a,b){this.caret=this.parent.toHex(a,b)};c.prototype.onDrag=function(a,b){this.caret=this.parent.toHex(a,b)};c.prototype.downCaret=function(a){if(this.caret=a){var b=this.parent,c=this.mode,d=b.focus;if(d){if(d.team===b.team&&!d.done(b)){1===c&&e(a,
d.hex)?this.mode=3:this.mode=2;return}}else if(a=b.field.get(a).unit,b.focus=a){this.mode=2;return}this.mode=0}};c.prototype.onDown=function(a,b){this.downCaret(this.parent.toHex(a,b))};c.prototype.upCaret=function(a){if(this.caret=a){var b=this.parent,c=this.mode;if(b.enabled&&!(2>c)){var d=b.focus;if(d&&b.team===d.team)if(e(a,d.hex))this.mode=2===c?1:0;else{c=b.mapFor(d).get(a);if(!c.effect)if(0<=c.SP&&b.field.get(a).empty)b.savepoint(d);else{b.focus=void 0;this.mode=0;return}this.mode=1;this.finish(b.move(d,
a))}else this.mode=0}}};c.prototype.onUp=function(a,b){this.upCaret(this.parent.toHex(a,b))};c.prototype.onPress=function(a){function c(a){var c=this.parent.field,d=this.caret;d?(a=b(d,a),c.contains(a)&&(this.caret=a)):this.caret={xH:c.minXH,yH:0}}function d(a){var b=this.parent,c=this.caret,d=b.team,e=b.focus;(a=b.findUnit(e?e.hex:c,a,function(a){return a.team===d&&!a.done(b)}))?(b.focus=a,c||(this.caret=a.hex),0===this.mode&&(this.mode=1)):G.error(g("Combat","UnitNotAvailable"))}switch(a){case p.BACKSPACE:case p.TAB:case p.DELETE:case p.Q:this.undo();
break;case p.PAGE_DOWN:case p.C:d.call(this,!0);break;case p.PAGE_UP:d.call(this,!1);break;case p.SPACE:case p.ENTER:this.click(this.caret);break;case p.E:c.call(this,0);break;case p.RIGHT:case p.D:c.call(this,1);break;case p.DOWN:case p.X:case p.S:c.call(this,2);break;case p.Z:c.call(this,3);break;case p.LEFT:case p.A:c.call(this,4);break;case p.UP:case p.W:c.call(this,5)}};c.prototype.click=function(a){a&&this.parent.field.contains(a)&&(this.downCaret(a),this.upCaret(a))};c.prototype.onDraw=function(a,
b){function c(a,b,c,d,e){b=c.toX(d)+6.5;c=c.toY(d)+6.5;a.save();a.lineCap="round";a.lineJoin="round";a.beginPath();a.moveTo(b+32,c);a.lineTo(b,c);a.lineTo(b,c+20);a.moveTo(b+115-32,c);a.lineTo(b+115,c);a.lineTo(b+115,c+20);a.moveTo(b+115-32,c+67);a.lineTo(b+115,c+67);a.lineTo(b+115,c+67-20);a.moveTo(b+32,c+67);a.lineTo(b,c+67);a.lineTo(b,c+67-20);a.lineWidth=7;a.strokeStyle=e.outer;a.stroke();a.lineWidth=3;a.strokeStyle=e.inner;a.stroke();a.restore()}function d(a,b,c){a.save();a.lineCap="butt";a.lineJoin=
"round";var d=c[c.length-2],e=c[c.length-1],f=b.toX(d)+64,g=b.toY(d)+40;d=b.toX(e)+64;e=b.toY(e)+40;f=ub(e-g,d-f);a.beginPath();a.moveTo(d+20*oa(f),e+20*X(f));a.lineTo(d+20*oa(f+2*Y/3),e+20*X(f+2*Y/3));a.lineTo(d+20*oa(f-2*Y/3),e+20*X(f-2*Y/3));a.fillStyle=Da;a.fill();a.beginPath();a.moveTo(d-10*oa(f),e-10*X(f));for(f=c.length-2;0<=f;--f)d=c[f],a.lineTo(b.toX(d)+64,b.toY(d)+40);a.strokeStyle=Da;a.lineWidth=12;a.stroke();a.restore()}var e=this.caret;if(e){var f=this.parent,g=f.focus,h=f.field;if(0===
this.mode)c(a,b,f,e,fa);else if(g&&f.enabled){var k=f.mapFor(g),l=k.getPath(e,h);l&&2<=l.length&&d(a,f,l);k=k.get(e);if(k.effect)switch(l=g.skill,l.usage){case "single-hostile":c(a,b,f,e,qa);break;case "single-friendly":c(a,b,f,e,ra);break;case "straight-hostile":h.straight(k.shotFrom,e,g.rangeOf(l),function(d){return c(a,b,f,d,qa)});break;case "straight-friendly":h.straight(k.shotFrom,e,g.rangeOf(l),function(d){return c(a,b,f,d,ra)});break;case "surround-hostile":h.surround(k.shotFrom,g.rangeOf(l),
function(d){return c(a,b,f,d,qa)});break;case "surround-friendly":h.surround(k.shotFrom,g.rangeOf(l),function(d){return c(a,b,f,d,ra)})}else 0<=k.SP?c(a,b,f,e,sa):c(a,b,f,e,fa)}}};return c}(ia),db=function(a){function b(){var b=null!==a&&a.apply(this,arguments)||this;b.running=!1;return b}z(b,a);Object.defineProperty(b.prototype,"visible",{get:function(){return this.running},set:function(a){var b=this;(this.running=a)&&N.then(function(){return b.run([])})},enumerable:!0,configurable:!0});b.prototype.dose=
function(a,b){throw Error("not implemented");};b.prototype.run=function(a){function b(a,b){var c=a.focus;if(c)return c;var d=a.team;c=b.length;c=0<c?a.findUnit(b[c-1].hex,!1,function(c){return c.team===d&&!c.done(a)&&0>b.indexOf(c)}):a.findUnit(void 0,!1,function(b){return b.team===d&&!b.done(a)});return a.focus=c}function c(a,b,c){var f=a.mapFor(b),g=d(a,b,f),h=g.hex;if(!f.get(h).effect&&b.SP>=b.availSP){var k=new Ua(a,b,999);h=d(a,b,k,g).hex;g=k.get(h);g.effect&&(h=g.shotFrom);g=a.field;for(var l=
h;l&&(0>f.get(l).SP||!g.get(l).empty);)l=k.get(l).comeFrom;h=l?l:b.hex}if(e(h,b.hex))c.push(b),a.focus=void 0;else return c.length=0,this.caret=h,c=x.wait.PICK,0<c?(f=hb(function(){return a.move(b,h)}),(new O(c)).then(f).attach(a),f):a.move(b,h)}function d(a,b,c,d){var e=a.field;a=a.numScrollsPerTurn;var g=e.minXH,h=e.maxXH,k=b.hex,l=b.maxSP,m=b.costOf(b.skill)||l,n=g+a,q=d?d:{hex:k,score:f(b,k.xH,k.yH,g,h,n)+40*b.SP/l};c.each(function(a,d,k){var u=a.SP,p=a.effect;a=a.shotFrom;var r;if(p&&a){u=r=
f(b,a.xH,a.yH,g,h,n);var t=p.target;r=1+b.level;p=p.deltaHP||0;p=0>p?-p:V(p,t.maxHP-t.HP);p=V(1,p/t.HP);r=u+1E3*r*p;u=c.get(a).SP-m}else if(0<=u&&e.get(d,k).empty)r=f(b,d,k,g,h,n);else return;r+=40*u/l;q.score<r&&(q.score=r,q.hex={xH:d,yH:k})});return q}function f(a,b,c,d,e,f){var g=0;g=1===a.team?g+10*(e-b):g+10*(b-d);a=2*c+b%2;g=3>a?g+10*a:g+10*(5-a);b<f&&(g*=.1);return g}for(var g=this,h=this.parent,k;this.running;){h.enabled||(k=N);if(k){k.then(function(){return g.run(a)});break}this.caret=void 0;
k=b(h,a);if(!k){h.endTurn();break}k=c.call(this,h,k,a)}};return b}(ia),eb={Charge:P,Knockback:function(a,b,c,d){var e=b.hex,f=c.hex,g=L(a.field,e,f);if(!g)return P(a,b,c,d);d=b.estimate(a,c,d);var h=a.promiseEffect(d,g);e=new Qa(a,e,f);var k=new Ha([f,g]);b.state=e;e.hit(function(){a.setUnit(c,g);c.state=k});k.then(function(){return h.attach(a)});return x.wait.POPUP?wa([h,e]):e},GoBehind:function(a,b,c,d){var e=b.hex,f=c.hex,g=L(a.field,e,f);if(!g)return P(a,b,c,d);c=b.estimate(a,c,d);var h=a.promiseEffect(c,
f);e=new Ha([e,f]);a.setUnit(b,g);b.state=e;e.then(function(){return h.attach(a)});return x.wait.POPUP?h:e},Trample:function(a,b,c,d){var e=b.hex,f=c.hex,g=L(a.field,e,f);if(!g)return P(a,b,c,d);d=b.estimate(a,c,d);var h=a.promiseEffect(d,g);e=new Ha([e,f]);d=new Ha([f,f,g]);a.setUnit(c,g);c.state=d;a.setUnit(b,f);b.state=e;d.then(function(){return h.attach(a)});return x.wait.POPUP?h:d},Shoot:function(a,b,c,d){var e=b.hex,f=c.hex;b=b.estimate(a,c,d);var g=a.promiseEffect(b,f);d=S(a,e,f,d);d.then(function(){return g.attach(a)});
return x.wait.POPUP?g:d},Drain:function(a,b,c,d){var e=c.hex,f=b.hex,g=b.estimate(a,c,d);c=a.promiseEffect(g,e);var h=a.promiseEffect({target:b,deltaHP:-(g.deltaHP||0)},f);b=S(a,e,f,d);b.then(function(){return h.attach(a)});c.attach(a);return x.wait.POPUP?h:b},Explode:function(a,b,c,d){var e=c.hex;c=S(a,b.hex,e,d);var f=hb(function(){return Z(a,b,d,e,1,function(a,b){return A(a/(1+b))})});c.then(f);return f},Laser:function(a,b,c,d){var e=a.field,f=b.rangeOf(d),g=b.hex,h,k=[];e.straight(g,c.hex,f,function(c){var f=
b.getTarget(e,c);f&&(f=b.estimate(a,f,d),f=a.promiseEffect(f,c),f.attach(a),k.push(f));h=c});var l=F(d);c=new O(400,function(b,c){var d=a.toX(g)+64,e=a.toY(g)+40,f=a.toX(h)+64,k=a.toY(h)+40,m=ub(k-e,f-d),n=64*oa(m);m=40*X(m);c.save();c.beginPath();c.moveTo(d+n,e+m);c.lineTo(f+n,k+m);c.lineCap="round";c.lineWidth=80*b/4;c.strokeStyle=Na(l,1-b);c.stroke();c.restore()});c.attach(a);return x.wait.POPUP?(k.push(c),wa(k)):c},Nova:function(a,b,c,d){c=b.rangeOf(d);return Z(a,b,d,b.hex,c)},Dose:function(a,
b,c,d){b=b.estimate(a,c,d);c=a.promiseEffect(b,c.hex);c.attach(a);return x.wait.POPUP?c:N}}})(Ga||(Ga={}));var Ra;var x=new (function(){function a(){this._refineCanvas=this._magnifyCanvas=!1;this.volume=new vb(50,0,100);this.effects=new vb(Va.length-1,0,Va.length-1)}Object.defineProperty(a.prototype,"magnifyCanvas",{get:function(){return this._magnifyCanvas},set:function(a){this._magnifyCanvas!==a&&(this._magnifyCanvas=a,window.dispatchEvent(new CustomEvent("resize")))},enumerable:!0,configurable:!0});
Object.defineProperty(a.prototype,"refineCanvas",{get:function(){return this._refineCanvas},set:function(a){this._refineCanvas!==a&&(this._refineCanvas=a,window.dispatchEvent(new CustomEvent("resize")))},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"wait",{get:function(){return Va[this.effects.value]},enumerable:!0,configurable:!0});return a}());System.main=function(a,b){b=new Image;b.src="assets/dummy.png";J.DUMMY=b;b=new T;var c=new T;c.attach(b);var d=new Jb(10,10,1260,700,
2E3,Gb);d.attach(b);G=d;Ra=function(){for(;;){var a=c.children,b=a.length;if(0===b)break;a[b-1].detach()}(new eb(new Xa.Scene)).attach(c)};System.checkpoint=function(){cb()};Fb();Ra();Bb(a,b,x)}})();
