(function(){function Ma(a,b,f){return a?a.find(b,f):void 0}function Eb(a,b,f){return a?a.findIndex(b,f):-1}function Fb(a,b,f){return a?a.map(b,f):void 0}function fa(a,b,f){return f<a?a:f>b?b:f}function aa(a,b){return null!=a?a:b}function Na(a){return x(Za()*a)}function ra(a){return a.map(function(a){return null!=a?a.toJSON():void 0})}function N(a,b){return b.map(function(b){return null!=b?a.fromJSON(b):void 0})}function Oa(a){return void 0===a?"(undefined)":null===a?"(null)":a.toString()}function sa(a){for(var b=
[],f=1;f<arguments.length;f++)b[f-1]=arguments[f];return a.replace(/\$\{(\d+)\}/g,function(a,f){return Oa(b[parseInt(f,10)])})}function Pa(a,b,f){return Object.defineProperty(a,b,{enumerable:!0,configurable:!0,writable:!0,value:f})}function ta(a,b,f,e){return Object.defineProperty(a,b,{enumerable:!0,configurable:!0,get:f,set:e})}function Gb(a,b){var f=document.createElement("script");f.src=a;f.onerror=b;document.head.appendChild(f)}function ga(a,b){if(a===b)return 0;if(void 0===a&&void 0!==b)return-1;
if(void 0!==a&&void 0===b)return 1;if(null===a&&null!==b)return-1;if(null!==a&&null===b)return 1;var f=typeof a,e=typeof b;if(f!==e)return f<e?-1:1;if("object"===f){if(a instanceof Date&&b instanceof Date)return ga(a.getTime(),b.getTime());if(a instanceof Array&&b instanceof Array){a:{for(var f=a.length,e=b.length,d=0,m=S(f,e);d<m;++d){var g=ga(a[d],b[d]);if(0!==g){f=g;break a}}f=f<e?-1:f>e?1:0}return f}f=a.constructor;if(f===b.constructor){e=a.compare;if("function"===typeof e&&e===b.compare){f=a.compare(b);
if("number"!==typeof f)throw new TypeError('Cannot compare "'+a+'" and "'+b+'": operator returns non-number "'+f+'"');return f}if(f===Object){a:{for(var f=Qa(a).sort(),e=Qa(b).sort(),d=f.length,m=e.length,g=S(d,m),c=0;c<g;++c){var k=f[c],h=e[c];if(k<h||k>h){f=-1;break a}k=ga(a[k],b[h]);if(0!==k){f=k;break a}}f=d<m?-1:d>m?1:0}return f}}throw new TypeError('Cannot compare "'+a+'" and "'+b+'": not supported');}return a<b?-1:a>b?1:0}function ua(a,b){return(a||24)+"px "+(b||"Arial")}function ha(a,b){if(a){if("function"===
typeof a)return[a,b];a.push(b);return a}return b}function ba(a){if(a)if("function"===typeof a)z.then(a);else for(var b=0;b<a.length;b++)z.then(a[b])}function va(a){for(var b,f=a.length,e=0;e<a.length;e++)a[e].then(function(){0>=--f&&(ba(b),b=void 0)});return{then:function(a){0<f?b=ha(b,a):z.then(a);return this}}}function hb(a){function b(a){z.then(a);return this}var f,e=function(){a().then(function(){ba(f);f=void 0;e.then=b})};e.then=function(a){f=ha(f,a);return this};return e}function k(){for(var a=
[],b=0;b<arguments.length;b++)a[b-0]=arguments[b];return new I(a)}function Hb(a,b,f){function e(b){return(b.pageX-a.offsetLeft)*l/a.offsetWidth}function d(b){return(b.pageY-a.offsetTop)*u/a.offsetHeight}function m(a){if(a.buttons&1)b.onDrag(e(a),d(a));else b.onHover(e(a),d(a));a.preventDefault()}function g(a){switch(a.button){case 0:b.onDown(e(a),d(a))}a.preventDefault()}function c(a){switch(a.button){case 0:b.onUp(e(a),d(a));break;case 2:b.onPress(n.TAB)}a.preventDefault()}function k(){J&&clearTimeout(J);
J=setTimeout(function(){J=void 0;var b=a.parentElement,e=b.clientWidth,b=b.clientHeight,b=b-a.offsetTop;0<b&&(f.magnifyCanvas||(e=S(e,l),b=S(b,u)),e*u>l*b?e=wa(b*l/u):b=wa(e*u/l),0<e&&0<b&&(a.style.width=e+"px",a.style.height=b+"px",!f.refineCanvas&&(e>l||b>u)&&(e=l,b=u),a.width!==e||a.height!==b))&&(a.width=e,a.height=b)},300)}function h(f){z.finish();var e=a.width,d=a.height,m=a.getContext("2d");m&&(m.clearRect(0,0,e,d),m.save(),m.font=ua(),e===l&&d===u||m.scale(e/l,d/u),b.onDraw(m,f),m.restore());
window.requestAnimationFrame(h)}var l=a.width,u=a.height;a.addEventListener("mousemove",m);a.addEventListener("touchmove",m);a.addEventListener("mousedown",g);a.addEventListener("touchstart",g);a.addEventListener("mouseup",c);a.addEventListener("touchend",c);a.addEventListener("contextmenu",function(a){a.preventDefault()});a.addEventListener("mousewheel",function(a){b.onPress(0<a.wheelDelta?n.PAGE_UP:n.PAGE_DOWN);a.preventDefault()});window.addEventListener("keydown",function(a){if(!a.ctrlKey&&!a.altKey){var f=
aa(a.keyCode,a.charCode);f&&n[f]&&(b.onPress(f),a.preventDefault())}});var J;window.addEventListener("resize",k);"complete"===document.readyState?k():window.addEventListener("load",k);window.requestAnimationFrame(h)}function Ra(a,b,f,e){void 0===e&&(e=!1);var d=a.w;a=a.h;if(d>b||a>f||e){e=d/b;var m=a/f;e>m?(d=b,a/=e):(d/=m,a=f)}return{w:d,h:a}}function $a(a,b){if(b)for(var f in b)switch(f){case "fontSize":a.font=ua(b.fontSize,b.fontFamily);break;case "fontFamily":b.fontSize||(a.font=ua(void 0,b.fontFamily));
break;default:a[f]=b[f]}}function ya(a,b,f,e,d,m){var g;null==e?(m=b,b=m.x,g=m.y,e=m.w,d=m.h,m,m=f):g=f;if(0<e&&0<d){a.save();$a(a,m);m&&!m.fillStyle||a.fillRect(b,g,e,d);if(!m||m.strokeStyle)f=a.lineWidth-1,a.strokeRect(b+f/2,g+f/2,e-f,d-f);a.restore()}}function za(a,b,f,e,d){function m(a,b,f,e,d){d&&!d.strokeStyle||a.strokeText(b,f,e);d&&!d.fillStyle||a.fillText(b,f,e)}a.save();$a(a,d);if(0>b.indexOf("\n"))m(a,b,f,e,d);else{var g=b.split("\n");b=1.2*(d&&d.fontSize||24);switch(a.textBaseline){case "top":for(var c=
0;c<g.length;c++){var k=g[c];m(a,k,f,e,d);e+=b}break;case "middle":e-=b*(g.length-1)/2;for(c=0;c<g.length;c++)k=g[c],m(a,k,f,e,d),e+=b;break;case "bottom":for(c=0,g=g.reverse();c<g.length;c++)k=g[c],m(a,k,f,e,d),e-=b}}a.restore()}function ia(a,b,f,e,d,m,g){a.save();$a(a,g);switch(a.textAlign){case "center":f+=d/2;break;case "right":f+=d;break}if(0>b.indexOf("\n")){switch(a.textBaseline){case "middle":e+=m/2;break;case "bottom":e+=m;break}g&&!g.strokeStyle||a.strokeText(b,f,e,d);g&&!g.fillStyle||a.fillText(b,
f,e,d)}else{b=b.split("\n");var c=1.2*(g&&g.fontSize||24);switch(a.textBaseline){case "middle":e+=(m-c*(b.length-1))/2;break;case "bottom":e=e+m-c*(b.length-1);break}for(m=0;m<b.length;m++){var k=a,h=b[m],l=f,n=e,J=d,q=g;q&&!q.strokeStyle||k.strokeText(h,l,n,J);q&&!q.fillStyle||k.fillText(h,l,n,J);e+=c}}a.restore()}function ib(a,b,f,e,d,m,g){a=a.createLinearGradient(b,f,e,d);a.addColorStop(0,m);a.addColorStop(1,g);return a}function Aa(a,b,f,e,d,m,g){0<e&&0<d&&(a.save(),a.fillStyle=ib(a,b,f,b,f+d,
m,g),a.fillRect(b,f,e,d),a.restore())}function ab(a,b,f,e,d,m,g,c){void 0===c&&(c=0);0<e&&0<d&&(a.save(),a.translate(b+e/2,f+d/2),a.scale(e,d),b=a.createRadialGradient(0,0,c/2,0,0,.5),b.addColorStop(0,m),b.addColorStop(1,g),a.fillStyle=b,a.fillRect(-.5,-.5,1,1),a.restore())}function l(a,b,f){return"rgb("+a+","+b+","+f+")"}function r(a,b,f,e){return"rgba("+a+","+b+","+f+","+e.toFixed(6).replace(/([0-9]+(\.[0-9]+[1-9])?)(\.?0+$)/,"$1")+")"}function Sa(a,b){return null==b?l(a.r,a.g,a.b):r(a.r,a.g,a.b,
b)}function Ta(a){for(var b=0,f=0;f<a.length;f++)b|=1<<a[f];return b}function h(){for(var a=[],b=0;b<arguments.length;b++)a[b-0]=arguments[b];return{tags:a,bits:Ta(a)}}function Ba(a){return a.tags.map(function(a){return Ib[a].localized}).join(", ")}function jb(a){var b={fillStyle:"white",strokeStyle:"black",fontSize:44,textAlign:"center",textBaseline:"middle"},f={textAlign:"right",textBaseline:"middle"},e={textAlign:"right",textBaseline:"middle"},d=new D(4,4,32,32,new E("assets/config.png"),function(){function d(a,
b){var e=100+70*a;(new K(640,e,160,60,new B(b,f))).attach(h);return e}function g(a,b,f){a=d(a,b);b=new Jb(810,a+15,300,30,f);b.attach(h);(new K(1120,a,50,60,new B(f,e))).attach(h);return b}function c(a,b,f,e,g,k){a=d(a,b);var l=new D(810,a+0,100,60,new B(function(){var a=g();l.pressed&&l.hover&&(a=!a);return(a?f:e).localized}),k);l.attach(h);return l}var h=new Ua;(new K(0,0,1280,720,new kb(bb))).attach(h);(new K(0,20,1280,80,new B(k("Config","Caption"),b))).attach(h);(new D(480,495,320,90,new B(k("Config",
"OK")),function(){return h.detach()},sb)).attach(h);var l=Qa(I.languages).sort().map(function(a){return k("Language",a)}),n=new G(10,10,160,G.heightOf(S(10,l.length)),[{name:k("Config","LanguageID"),extract:function(a){return a.src[1]},width:40,align:"center"},{name:k("Config","LanguageName"),extract:function(a){return a.localized}}],l,function(a){n.selected=a;I.language=a.src[1]});n.selected=Ma(n.rows,function(a){return a.src[1]===I.language});n.attach(h);g(0,k("Config","Volume"),p.volume);g(1,k("Config",
"CPUEffects"),p.effects);var l=k("Config","On"),u=k("Config","Off");c(2,k("Config","MagnifyCanvas"),l,u,function(){return p.magnifyCanvas},function(){p.magnifyCanvas=!p.magnifyCanvas});c(3,k("Config","RefineCanvas"),l,u,function(){return p.refineCanvas},function(){p.refineCanvas=!p.refineCanvas});(function(a,b,f){a=new D(810,70*a+100,300,60,new B(b),f);a.attach(h);return a})(4,k("Config","BackToTitle"),function(){h.detach();Va()});h.attach(a)},Kb,new D.IconDesign("white"));d.attach(a);return d}function cb(){try{var a=
System.getRoamingStorage("NYO");if(a){var b=db(a);return{shop:b.shop||{},warehouse:N(ka,b.warehouse),reservers:N(Y,b.reservers),party:N(Y,b.party),gold:b.gold||0}}}catch(f){F.error(f)}}function eb(a){try{System.setRoamingStorage("NYO",tb(a))}catch(b){F.error(b)}ub()}function Lb(){function a(a,b){return typeof a===typeof b?b:a}try{var b=System.getLocalStorage("NYO");if(b){var f=db(b);f&&(I.language=a(I.language,f.language),p.magnifyCanvas=a(p.magnifyCanvas,f.magnifyCanvas),p.refineCanvas=a(p.refineCanvas,
f.refineCanvas),p.volume.value=a(p.volume.value,f.volume),p.effects.value=a(p.effects.value,f.effects))}}catch(e){F.error(e)}}function ub(){try{System.setLocalStorage("NYO",tb({language:I.language,magnifyCanvas:p.magnifyCanvas,refineCanvas:p.refineCanvas,volume:p.volume.value,effects:p.effects.value}))}catch(a){F.error(a)}}var w=this&&this.__extends||function(a,b){function f(){this.constructor=a}for(var e in b)b.hasOwnProperty(e)&&(a[e]=b[e]);a.prototype=null===b?Object.create(b):(f.prototype=b.prototype,
new f)},Qa=Object.keys,la=Math.abs,S=Math.min,T=Math.max,x=Math.floor,lb=Math.ceil,wa=Math.round,Ca=Math.pow,U=Math.sin,ma=Math.cos,vb=Math.atan2,V=Math.PI,Za=Math.random,db=JSON.parse,tb=JSON.stringify,ca=function(){},wb=function(){function a(a,f){this.min=a;this.max=f}a.prototype.map=function(a,f){for(var e=this.min,d=this.max,m=Array(d-e);e<d;++e)m[e]=a.call(f,e);return m};a.prototype.toArray=function(){for(var a=this.min,f=this.max,e=Array(f-a);a<f;++a)e[a]=a;return e};return a}(),z=new (function(){function a(){}
a.prototype.then=function(a){this.sig=ha(this.sig,a);return this};a.prototype.finish=function(){var a=this.sig;if(a)if(this.sig=void 0,"function"===typeof a)a();else for(var f=0;f<a.length;f++)(0,a[f])()};return a}()),I=function(){function a(a){this.src=a}Object.defineProperty(a.prototype,"localized",{get:function(){function b(b){var f=a.languages,m=a.language,g=f[m];if(void 0===g)m in f||(m=a.language=a.fallback,g=f[m]),f[m]=!0,Gb(a.path+m+".js",function(){f[m]=!1});else if(!0!==g){if(!1===g)return b.join(".");
for(var c=g,g=0,k=b.length;g<k;++g)if(c=c[b[g]],!c)return b.join(".");return c.toString()}}if(this._language!==a.language){var f=b(this.src);f&&(this._language=a.language,this._localized=f)}return this._localized||this.src.join(".")},enumerable:!0,configurable:!0});a.prototype.toString=function(){return this.localized};a.prototype.compare=function(a){return ga(this.localized,a.localized)};a.language=window.navigator.language.substr(0,2);a.fallback="en";a.path="";a.languages={};return a}();System.localize=
function(a,b){I.languages[a]=b};var n;(function(a){a[a.BACKSPACE=8]="BACKSPACE";a[a.TAB=9]="TAB";a[a.ENTER=13]="ENTER";a[a.ESCAPE=27]="ESCAPE";a[a.SPACE=32]="SPACE";a[a.PAGE_UP=33]="PAGE_UP";a[a.PAGE_DOWN=34]="PAGE_DOWN";a[a.END=35]="END";a[a.HOME=36]="HOME";a[a.LEFT=37]="LEFT";a[a.UP=38]="UP";a[a.RIGHT=39]="RIGHT";a[a.DOWN=40]="DOWN";a[a.DELETE=46]="DELETE";a[a.$0=48]="$0";a[a.$1=49]="$1";a[a.$2=50]="$2";a[a.$3=51]="$3";a[a.$4=52]="$4";a[a.$5=53]="$5";a[a.$6=54]="$6";a[a.$7=55]="$7";a[a.$8=56]="$8";
a[a.$9=57]="$9";a[a.A=65]="A";a[a.B=66]="B";a[a.C=67]="C";a[a.D=68]="D";a[a.E=69]="E";a[a.F=70]="F";a[a.G=71]="G";a[a.H=72]="H";a[a.I=73]="I";a[a.J=74]="J";a[a.K=75]="K";a[a.L=76]="L";a[a.M=77]="M";a[a.N=78]="N";a[a.O=79]="O";a[a.P=80]="P";a[a.Q=81]="Q";a[a.R=82]="R";a[a.S=83]="S";a[a.T=84]="T";a[a.U=85]="U";a[a.V=86]="V";a[a.W=87]="W";a[a.X=88]="X";a[a.Y=89]="Y";a[a.Z=90]="Z"})(n||(n={}));var da=function(){function a(){}a.prototype.onHover=function(a,f){};a.prototype.onDrag=function(a,f){};a.prototype.onDown=
function(a,f){};a.prototype.onUp=function(a,f){};a.prototype.onPress=function(a){};a.prototype.onDraw=function(a,f){};a.prototype.attach=function(a){return a.onAttach(this)};a.prototype.detach=function(){var a=this.parent;if(a)return a.onDetach(this),a};Object.defineProperty(a.prototype,"visible",{get:function(){return!0},set:function(a){Pa(this,"visible",a)},enumerable:!0,configurable:!0});return a}(),P=function(a){function b(f){a.call(this);this.children=[];if(f)for(var b=0;b<f.length;b++)f[b].attach(this)}
w(b,a);b.prototype.onAttach=function(a){if(a.parent===this)return!1;this.children.push(a);a.parent=this;return!0};b.prototype.onDetach=function(a){if(!a.parent)return!1;a.parent=void 0;for(var b=this.children,d=0;d<b.length;++d)if(b[d]===a){a=this.children;for(var b=a.length,m=Array(b-1),g=0;g<d;++g)m[g]=a[g];for(g=d+1;g<b;++g)m[g-1]=a[g];this.children=m;break}return!0};b.prototype.onHover=function(a,b){for(var d=0,m=this.children;d<m.length;d++){var g=m[d];if(g.visible)g.onHover(a,b)}};b.prototype.onDrag=
function(a,b){for(var d=0,m=this.children;d<m.length;d++){var g=m[d];if(g.visible)g.onDrag(a,b)}};b.prototype.onDown=function(a,b){for(var d=0,m=this.children;d<m.length;d++){var g=m[d];if(g.visible)g.onDown(a,b)}};b.prototype.onUp=function(a,b){for(var d=0,m=this.children;d<m.length;d++){var g=m[d];if(g.visible)g.onUp(a,b)}};b.prototype.onPress=function(a){for(var b=0,d=this.children;b<d.length;b++){var m=d[b];if(m.visible)m.onPress(a)}};b.prototype.onDraw=function(a,b){for(var d=0,m=this.children;d<
m.length;d++){var g=m[d];if(g.visible)g.onDraw(a,b)}};return b}(da),kb=function(){function a(a){this.rectStyle=a}a.prototype.draw=function(a,f,e){ya(a,e,this.rectStyle)};return a}(),B=function(){function a(a,f,e){this.value=a;this.textStyle=f;this.rectStyle=e;f&&f.fillStyle&&f.textAlign&&f.textBaseline||(a=Object.create(f||null),f&&f.fillStyle||(a.fillStyle="white"),f&&f.textAlign||(a.textAlign="center"),f&&f.textBaseline||(a.textBaseline="middle"),this.textStyle=a)}a.prototype.draw=function(a,f,
e){f=e.x;var d=e.y,m=e.w;e=e.h;this.rectStyle&&ya(a,f,d,m,e,this.rectStyle);ia(a,this.text,f,d,m,e,this.textStyle)};Object.defineProperty(a.prototype,"text",{get:function(){var a=this.value;"function"===typeof a&&(a=a());return Oa(a)},enumerable:!0,configurable:!0});return a}(),E=function(){function a(a){this.src=a;this._image=void 0}a.from=function(b){var f=new a;f._image=b;return f};a.prototype.then=function(a){this._image?z.then(a):(this.sig=ha(this.sig,a),this.preload());return this};a.prototype.preload=
function(){var b=this;if(void 0===this._image){this._image=null;var f=new Image;f.addEventListener("load",function(){b._image=f;ba(b.sig);b.sig=void 0});f.addEventListener("error",function(){b._image=a.DUMMY;ba(b.sig);b.sig=void 0});this.src&&(f.src=this.src)}};Object.defineProperty(a.prototype,"image",{get:function(){void 0===this._image&&this.preload();return this._image},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"w",{get:function(){var a=this.image;return a?a.width:1},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"h",{get:function(){var a=this.image;return a?a.height:1},enumerable:!0,configurable:!0});a.prototype.draw=function(a,f,e,d,m){f=this.image;var g=e.x,c=e.y,k=e.w;e=e.h;f&&0<k&&0<e&&(!d||0>=m?a.drawImage(f,g,c,k,e):(a.save(),a.globalCompositeOperation="destination-out",a.drawImage(f,g,c,k,e),a.globalCompositeOperation="destination-over",a.fillStyle=d,a.fillRect(g,c,k,e),1>m&&(a.globalCompositeOperation="source-over",a.globalAlpha=1-m,a.drawImage(f,
g,c,k,e)),a.restore()))};a.DUMMY=null;return a}(),Mb={fontSize:32,fillStyle:"white",strokeStyle:"black",textAlign:"left",textBaseline:"top",lineWidth:2},bb={fillStyle:r(0,0,0,.8)},Nb={fillStyle:"white",strokeStyle:"black",fontSize:44,textAlign:"center",textBaseline:"middle"},H=function(a){function b(f,b){a.call(this);this.duration=f;b&&(this.onAnimation=b)}w(b,a);b.prototype.attach=function(f){return a.prototype.attach.call(this,f)?(this.start=performance.now(),!0):!1};b.prototype.detach=function(){this.start=
void 0;return a.prototype.detach.call(this)};b.prototype.onDraw=function(a,b){var d=this.start;d&&(b>=d+this.duration?(this.onAnimation(1,a,b),this.detach(),ba(this.sig),this.sig=void 0):(d=T(0,b-d)/this.duration,this.onAnimation(d,a,b)))};b.prototype.onAnimation=function(a,b,d){};b.prototype.then=function(a){this.sig=ha(this.sig,a);return this};b.clamp=function(a,b,d){return!b||a<b?0:!d||b+d<a?1:(a-b)/d};b.cycle=function(a,b,d){return!b||!d||a<b?0:(a-b)%d/d};return b}(da),xb=function(a){function b(b,
e){void 0===e&&(e=400);a.call(this,e);this.next=b}w(b,a);b.prototype.onAnimation=function(a,b,d){if(1>a){if(0<a)this.next.onDraw(b,d);b.save();b.globalAlpha=1-a;b.fillStyle="black";b.fillRect(0,0,1280,720);b.restore()}else this.next.attach(this.parent)};return b}(H),Q=function(a){function b(b,e,d){void 0===d&&(d=400);a.call(this,d);this.prev=b;this.next=e}w(b,a);b.go=function(a,e,d){void 0===d&&(d=400);(new b(a,e,d)).attach(a.parent)};b.prototype.attach=function(b){return a.prototype.attach.call(this,
b)?(this.prev.detach(),!0):!1};b.prototype.onAnimation=function(a,b,d){1>a?(this.prev.onDraw(b,d),0<a&&(b.save(),b.globalAlpha=a,b.fillStyle="black",b.fillRect(0,0,1280,720),b.restore())):this.next&&(new xb(this.next,this.duration)).attach(this.parent)};return b}(H),Ua=function(a){function b(){a.apply(this,arguments)}w(b,a);b.prototype.attach=function(b){return!this.prev&&b.parent&&a.prototype.attach.call(this,b.parent)?(b.detach(),this.prev=b,!0):!1};b.prototype.detach=function(){var b=a.prototype.detach.call(this);
b&&this.prev.attach(b);return b};b.prototype.onDraw=function(b,e){this.prev.onDraw(b,e);a.prototype.onDraw.call(this,b,e)};b.confirm=function(a,e){for(var d=[],m=2;m<arguments.length;m++)d[m-2]=arguments[m];var c=new b;(new K(0,0,1280,720,new B(e,Nb,bb))).attach(c);for(var m=d.length,k=1280/(3+m),h=k/8,l=(1280-k*m-h*(m-1))/2,n=function(a){var b=d[a],f=b.click,e=b.mnemonic;(new D(l+(k+h)*a,495,k,90,new B(b.label),f?function(){c.detach();f()}:function(){c.detach()},e)).attach(c)},u=0;u<m;++u)n(u);c.attach(a);
return c};return b}(P),na=function(a){function b(b,e,d,c){a.call(this);this.x=b;this.y=e;this.w=d;this.h=c}w(b,a);b.prototype.contains=function(a,b){return this.visible&&this.x<=a&&this.y<=b&&a<this.x+this.w&&b<this.y+this.h};Object.defineProperty(b.prototype,"left",{get:function(){return this.x},set:function(a){this.w=this.w+this.x-a;this.x=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"right",{get:function(){return this.x+this.w},set:function(a){this.w=a-this.x},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"top",{get:function(){return this.y},set:function(a){this.h=this.h+this.y-a;this.y=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"bottom",{get:function(){return this.y+this.h},set:function(a){this.h=a-this.y},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"center",{get:function(){return{x:this.x+this.w/2,y:this.y+this.h/2}},enumerable:!0,configurable:!0});b.prototype.moveTo=function(a,b){this.x=a;this.y=
b;return this};b.prototype.moveBy=function(a,b){this.x+=a;this.y+=b;return this};return b}(da),K=function(a){function b(b,e,d,c,g){a.call(this,b,e,d,c);this.drawable=g}w(b,a);b.prototype.onDraw=function(a,b){this.drawable.draw(a,b,this)};return b}(na),D=function(a){function b(f,e,d,c,g,k,h,l){void 0===l&&(l=b.defaultDesign);a.call(this,f,e,d,c);this.drawable=g;this.click=k;this.mnemonic=h;this.design=l;this.hover=!1}w(b,a);Object.defineProperty(b.prototype,"enabled",{get:function(){return!0},set:function(a){Pa(this,
"enabled",a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"state",{get:function(){return this.enabled?this.pressed?2:this.hover?1:0:3},enumerable:!0,configurable:!0});b.prototype.onHover=function(a,b){this.hover=this.contains(a,b);this.pressed=void 0};b.prototype.onDrag=function(a,b){null!=this.pressed&&(this.pressed=this.contains(a,b))};b.prototype.onDown=function(a,b){this.enabled&&this.contains(a,b)&&(this.pressed=!0)};b.prototype.onUp=function(a,b){var d=this.pressed;this.pressed=
void 0;if(d&&this.contains(a,b))this.onClick()};b.prototype.onPress=function(a){this.mnemonic&&0<=this.mnemonic.indexOf(a)&&this.enabled&&(this.pressed=!1,this.onClick())};b.prototype.onClick=function(){var a=this,b=this.click;b&&z.then(function(){return b.call(a)})};b.prototype.onDraw=function(a,b){this.design.draw(a,b,this)};b.defaultDesign={draw:function(a,e,d){ya(a,d,b.defaultDesign.getStyle(d.state));d.drawable&&d.drawable.draw(a,e,d)},getStyle:function(a){var b={};switch(a){case 0:b.fillStyle=
r(0,0,0,.8);b.strokeStyle=l(200,200,200);break;case 1:b.fillStyle=r(0,0,50,.8);b.strokeStyle=l(100,100,200);break;case 2:b.fillStyle=r(0,0,150,.8);b.strokeStyle=l(100,100,255);break;case 3:b.fillStyle=r(200,200,200,.8),b.strokeStyle=l(200,200,200)}return b}};b.IconDesign=function(){function a(b){this.overlay=b}a.prototype.draw=function(a,b,f){var c=f.drawable;switch(f.state){case 0:c.draw(a,b,f);break;case 1:c.draw(a,b,f,this.overlay,.7);break;case 2:c.draw(a,b,f,this.overlay,.9);break;case 3:c.draw(a,
b,f,l(200,200,200),.8)}};return a}();return b}(na),Ob=function(a){function b(b,e,d,c,g,k,h,l,n,u){void 0===u&&(u=D.defaultDesign);a.call(this,b,e,d,c,k,h,n,u);this.group=g;this.swap=l;g.push(this)}w(b,a);b.prototype.onDrag=function(b,e){var d=this;a.prototype.onDrag.call(this,b,e);var c=this.dragged,g=this.swapping;if(c&&!g){var k=Ma(this.group,function(a){return a!==d&&a.contains(b,e)&&!a.swapping});k?(c=performance.now(),this.onSwap(k,c),k.onSwap(this,c),g=this.swapping,this.dragged={xOrig:g.xTo,
yOrig:g.yTo},this.swap&&this.swap(k)):null!=c.xDown?(this.x=c.xOrig-c.xDown+b,this.y=c.yOrig-c.yDown+e):this.contains(b,e)?(c.xDown=b,c.yDown=e):(this.pressed=this.dragged=void 0,this.hover=!1)}};b.prototype.onDown=function(b,e){a.prototype.onDown.call(this,b,e);!this.dragged&&this.contains(b,e)&&(this.dragged={xDown:b,yDown:e,xOrig:this.x,yOrig:this.y})};b.prototype.onUp=function(b,e){if(this.swapping)this.dragged=void 0,a.prototype.onUp.call(this,b,e);else if(this.dragged){var d=this.dragged,c=
d.xOrig,d=d.yOrig;this.swapping={start:performance.now(),xFrom:this.x,yFrom:this.y,xTo:c,yTo:d};this.dragged=void 0;if(this.pressed&&(this.pressed=void 0,this.contains(b,e)&&c<=b&&d<=e&&b<c+this.w&&e<d+this.h))this.onClick()}else a.prototype.onUp.call(this,b,e)};b.prototype.onSwap=function(a,b){this.pressed=void 0;this.swapping={start:b,xFrom:this.x,yFrom:this.y,xTo:a.dragged?a.dragged.xOrig:a.x,yTo:a.dragged?a.dragged.yOrig:a.y}};b.prototype.onDraw=function(b,e){if(this.swapping){var d=H.clamp(e,
this.swapping.start,200);1>d?(d=(1-ma(V*d))/2,this.x=this.swapping.xFrom*(1-d)+this.swapping.xTo*d,this.y=this.swapping.yFrom*(1-d)+this.swapping.yTo*d):(this.x=this.swapping.xTo,this.y=this.swapping.yTo,this.swapping=void 0)}a.prototype.onDraw.call(this,b,e)};return b}(D),G=function(a){function b(f,e,d,c,g,k,h,l){void 0===l&&(l=b.defaultDesign);a.call(this,f,e,d,c);this.columns=g;this.rows=k;this.click=h;this.design=l;this.topRow=0}w(b,a);b.heightOf=function(a,e){void 0===e&&(e=b.defaultDesign);
return e.headerHeight+a*e.rowHeight};b.prototype.onHover=function(a,b){this.hover=this.toRowIndex(a,b);this.scrolling=this.dragged=void 0};b.prototype.onDrag=function(a,b){var d=this.design.headerHeight;null!=this.scrolling?this.scrollTo(x(this.rows.length*(b-(this.y+d)-this.scrolling)/(this.h-d))):(d=this.toRowIndex(void 0,b),null!=d&&null!=this.dragged&&d!==this.dragged&&(c=[this.rows[d],this.rows[this.dragged]],this.rows[this.dragged]=c[0],this.rows[d]=c[1],this.dragged=d,this.sortkeys=this.scrolling=
this.hover=void 0));var c};b.prototype.onDown=function(a,b){if(this.contains(a,b)&&(this.hover=this.dragged=this.toRowIndex(a,b),null==this.dragged)){var d=this.design,c=d.headerHeight,g=this.w-d.scrollBarWidth,d=this.y+c;if(this.x<=a&&a<this.x+g&&this.y<=b&&b<d)d=this.toColumnIndex(a),null!=d&&this.sort(d,!!this.sortkeys&&this.sortkeys[0]===d+1);else if(this.x+g<=a&&a<this.right){var g=this.rows.length,k=this.displayCount,c=this.h-c,h=d+c*this.topRow/g,l=c*k/g;d<=b&&b<h?(this.scrollTo(x(g*(b-d)/
c)),h=d+c*this.topRow/g):h+l<=b&&b<this.bottom&&(this.scrollTo(x(g*(b-d)/c)-k+1),h=d+c*this.topRow/g);h<=b&&b<h+l&&(this.scrolling=b-h)}}};b.prototype.onUp=function(a,b){null==this.scrolling&&null!=this.dragged&&this.dragged===this.hover&&(this.click(this.rows[this.dragged],this.dragged),this.refresh());this.scrolling=this.dragged=void 0;this.hover=this.toRowIndex(a,b)};b.prototype.onPress=function(a){switch(a){case n.PAGE_DOWN:this.scrollBy(this.scrollStep);break;case n.PAGE_UP:this.scrollBy(-this.scrollStep)}};
b.prototype.onDraw=function(a,b){var d=this.design,c=d.headerHeight,g=d.scrollBarWidth,k=this.rows.length,h=this.displayCount,l=this.x,n=this.y+c,u=this.w-g,p=this.h-c,q=this.x+u,X=(0<k&&p*this.topRow/k||0)+n,M=0<k&&p*h/k||p,xa=this.defaultColumnWidth;d.drawHeader(a,this.x,this.y,this.w,c);d.drawBackground(a,this.x,n,u,p);0<g&&(d.drawHeader(a,q,n,g,p),h<k&&d.drawScrollBar(a,q,X,g,M));a.save();a.font=d.rowFont;a.fillStyle=d.rowStyle;a.textBaseline="middle";for(var M=d.rowHeight,O=0;O<h;++O){var g=
O+this.topRow,rb=this.rows[g],ja=n+M*O;g===this.dragged?d.drawRowDragged(a,this.x,ja,u,M):rb===this.selected?d.drawRowSelected(a,this.x,ja,u,M):g===this.hover&&null==this.dragged&&d.drawRowHover(a,this.x,ja,u,M);for(var yb=0,g=0,k=this.columns.length;g<k;++g){var q=this.columns[g],X=aa(q.width,xa),Da=this.extract(rb,q);if(null!=Da){var oa=l+yb+2,mb=X-4;a.textAlign=q.align||"left";switch(a.textAlign){case "center":oa+=mb/2;break;case "right":oa+=mb}a.fillText(Da,oa,ja+M/2,mb)}yb+=X}}a.restore();a.save();
M=0;a.font=d.headerFont;a.fillStyle=d.headerStyle;a.textAlign="center";a.textBaseline="middle";a.strokeStyle=d.lineStyle;g=0;for(k=this.columns.length;g<k;++g)q=this.columns[g],X=aa(q.width,xa),O=l+M,0<g&&(a.beginPath(),a.moveTo(O,n),a.lineTo(O,this.bottom),a.stroke()),a.fillText(q.name.localized,O+X/2,this.y+c/2),M+=X;a.restore();0===h&&0<p&&d.emptyText&&(a.save(),d.emptyFont&&(a.font=d.emptyFont),a.textAlign="center",a.textBaseline="middle",d.emptyStyle&&(a.fillStyle=d.emptyStyle),a.fillText(d.emptyText.localized,
this.x+u/2,n+p/2),a.restore())};Object.defineProperty(b.prototype,"displayCount",{get:function(){var a=this.design;return S(x((this.h-a.headerHeight)/a.rowHeight),this.rows.length)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"scrollStep",{get:function(){return T(x(.2*this.displayCount),1)},enumerable:!0,configurable:!0});b.prototype.extract=function(a,b){var d=b.extract;switch(typeof d){case "function":return d(a);case "number":return a[d];default:return a[d]}};b.prototype.compare=
function(a,b){var d=this.sortkeys,c=this.columns,g=0;if(d)for(var k=0,h=d.length;0===g&&k<h;++k){var l=d[k],g=c[(0<l?l:-l)-1],g=g.compare?g.compare(a,b):ga(this.extract(a,g),this.extract(b,g));0>l&&(g=-g)}return g};b.prototype.sort=function(a,b){var d=this;void 0===b&&(b=!1);var c=a+1;if(this.sortkeys){for(var g=0,k=this.sortkeys.length;g<k;++g){var h=this.sortkeys[g];if(h===c||h===-c){this.sortkeys.splice(g,1);break}}this.sortkeys.unshift(b?-c:c)}else this.sortkeys=[b?-c:c];this.rows.sort(function(a,
b){return d.compare(a,b)})};b.prototype.toRowIndex=function(a,b){var d=this.design,c=this.w-d.scrollBarWidth;if(void 0===a||this.x<=a&&a<this.x+c)if(d=this.topRow+x((b-this.y-d.headerHeight)/d.rowHeight),this.topRow<=d&&d<this.rows.length)return d};b.prototype.toColumnIndex=function(a){for(var b=this.defaultColumnWidth,d=this.x,c=0,g=this.columns.length;c<g;++c){var k=aa(this.columns[c].width,b);if(d<=a&&a<d+k)return c;d+=k}};Object.defineProperty(b.prototype,"defaultColumnWidth",{get:function(){for(var a=
this.w-this.design.scrollBarWidth,b=0,d=0,c=0,g=this.columns;c<g.length;c++){var k=g[c];null!=k.width?b+=k.width:++d}return 0<d&&b<a?(a-b)/d:0},enumerable:!0,configurable:!0});b.prototype.refresh=function(){var a=this.rows.length;this.dragged>=a&&(this.dragged=void 0);this.hover>=a&&(this.hover=void 0);this.scrollTo(this.topRow)};b.prototype.scrollTo=function(a){this.topRow=fa(0,this.rows.length-this.displayCount,a)};b.prototype.scrollBy=function(a){this.scrollTo(this.topRow+a)};b.defaultDesign={rowHeight:28,
rowFont:ua(20),rowStyle:"white",headerHeight:24,headerFont:ua(18),headerStyle:"white",scrollBarWidth:14,lineStyle:l(102,102,102),drawHeader:function(a,b,d,c,g){a.save();a.fillStyle=r(25,25,25,.8);a.fillRect(b,d,c,g);a.restore()},drawBackground:function(a,b,d,c,g){a.save();a.fillStyle=r(0,0,0,.6);a.fillRect(b,d,c,g);a.restore()},drawScrollBar:function(a,b,d,c,g){Aa(a,b,d,c,g,l(100,100,100),l(75,75,75))},drawRowDragged:function(a,b,d,c,g){Aa(a,b,d,c,g,l(255,0,0),l(50,0,0))},drawRowSelected:function(a,
b,d,c,g){Aa(a,b,d,c,g,l(100,0,0),l(50,0,0))},drawRowHover:function(a,b,d,c,g){Aa(a,b,d,c,g,l(75,0,0),l(50,0,0))}};return b}(na),zb=function(){function a(a,f,c){this.min=f;this.max=c;this.value=a}Object.defineProperty(a.prototype,"value",{get:function(){return this._value},set:function(a){this._value=fa(this.min,this.max,wa(a))},enumerable:!0,configurable:!0});a.prototype.toString=function(){return this._value.toString()};a.prototype.valueOf=function(){return this._value};return a}(),Jb=function(a){function b(f,
c,d,k,g,h){void 0===h&&(h=b.defaultDesign);a.call(this,f,c,d,k);this.value=g;this.design=h;this.hover=this.dragged=!1}w(b,a);b.prototype.getValueAsX=function(){var a=this.design.knobWidth,b=this.value,d=b.min;return this.x+a/2+(b.value-d)/(b.max-d)*(this.w-a)};b.prototype.setValueByX=function(a){var b=this.design.knobWidth;a=fa(0,1,(a-this.x-b/2)/(this.w-b));var b=this.value,d=b.min;this.value.value=wa(d+a*(b.max-d))};b.prototype.onHover=function(a,b){this.hover=this.contains(a,b);this.dragged=!1};
b.prototype.onDrag=function(a,b){this.hover=this.dragged&&this.contains(a,b);this.dragged&&this.setValueByX(a)};b.prototype.onDown=function(a,b){this.contains(a,b)&&(this.dragged=!0,this.setValueByX(a))};b.prototype.onUp=function(a,b){this.dragged=!1};b.prototype.onDraw=function(a,b){this.design.draw(a,b,this)};Object.defineProperty(b.prototype,"knob",{get:function(){var a=this.design.knobWidth,b=this.h;return{x:this.getValueAsX()-a/2,y:this.y-(this.h-b)/2,w:a,h:b,state:this.dragged?2:this.hover?
1:0}},enumerable:!0,configurable:!0});b.defaultDesign={knobWidth:12,draw:function(a,b,d){ya(a,d,{fillStyle:r(50,50,50,.8),strokeStyle:"white",lineWidth:4});b=d.knob;d={strokeStyle:"white",lineWidth:4};switch(b.state){case 0:d.fillStyle=r(150,150,150,.8);break;case 1:d.fillStyle=r(200,200,200,.8);break;case 2:d.fillStyle=r(255,255,255,.8)}ya(a,b,d)}};return b}(na),Pb=function(a){function b(b,c,d,k,g,h){a.call(this,b,c,d,k);this.duration=g;this.style=h;this.logs=[]}w(b,a);b.prototype.onDraw=function(a,
b){var c=this.logs;if(0<c.length){var k=b-this.duration,g=Eb(c,function(a){return a.when>k});0>g?c.length=0:c.splice(0,g);g=c.length;if(0<g)for(var h=this.style,l=1.2*(h&&h.fontSize||24),n=0;n<g;++n)ia(a,c[n].message,this.x,this.y+n*l,this.w,l,h)}};b.prototype.log=function(a){if(a){var b=performance.now(),c=this.logs,k=c.length;0<k&&c[k-1].message===a?c[k-1].when=b:c.push({message:Oa(a),when:b})}};b.prototype.error=function(a){this.log(a)};return b}(na);I.path="assets/lang/";I.languages.en=void 0;
I.languages.ja=void 0;var Kb=[n.ESCAPE],Wa=[n.ENTER,n.SPACE],pa=[n.BACKSPACE,n.TAB,n.DELETE],Qb=[n.PAGE_UP,n.HOME,n.LEFT,n.UP],Rb=[n.PAGE_DOWN,n.END,n.RIGHT,n.DOWN],sb=Wa.concat(pa),nb=Wa.concat(n.Y),ob=pa.concat(n.N),c;(function(a){a[a.Melee=0]="Melee";a[a.Throw=1]="Throw";a[a.Shoot=2]="Shoot";a[a.Magic=3]="Magic";a[a.Alchemy=4]="Alchemy";a[a.Slash=5]="Slash";a[a.Blunt=6]="Blunt";a[a.Pierce=7]="Pierce";a[a.Shield=8]="Shield";a[a.Head=9]="Head";a[a.Body=10]="Body";a[a.Arms=11]="Arms";a[a.Legs=12]=
"Legs";a[a.Fire=13]="Fire";a[a.Cold=14]="Cold";a[a.Lightning=15]="Lightning";a[a.Life=16]="Life";a[a.MAX=17]="MAX"})(c||(c={}));var fb={bkgnd:r(0,0,0,.6),delta:l(255,51,0),normal:l(153,204,0),full:l(0,204,51)},Ab={bkgnd:r(0,0,0,.6),delta:l(0,51,102),normal:l(0,153,204),full:l(0,153,255)},Ea=[{PICK:0,WALK:!1,POPUP:!1},{PICK:0,WALK:!1,POPUP:!0},{PICK:0,WALK:!0,POPUP:!0},{PICK:300,WALK:!0,POPUP:!0}],p,F,Sb={Warrior:{INT:4,DEX:4,STR:7,equipments:["Mace","PlateArmor","FirstAidKit"],skills:["Swing","Crash",
"Bash","PathToWarrior","PotionOfRegeneration"],image:"nazrin"},Samurai:{INT:3,DEX:7,STR:5,equipments:["Katana","Chainmail","FirstAidKit"],skills:["Swing","Slash","CutThrough","Sweep","PotionOfHealth"],image:"rin"},Knight:{INT:6,DEX:2,STR:7,equipments:["Spear","LamellarArmor","KiteShield","FirstAidKit"],skills:"Swing Stab Thrust ShieldBash ShieldCharge PotionOfStrength".split(" "),image:"toramaru"},Thief:{INT:3,DEX:6,STR:6,equipments:["LongBow","LetherArmor","FirstAidKit"],skills:["Shoot","PoisonArrow",
"OilArrow","FirstAid","PotionOfDexterity"],image:"marisa"},Healer:{INT:7,DEX:3,STR:5,equipments:["Staff","Robe"],skills:"Swing Heal PartyHeal Empower Enhance Enlighten Absorber Shelter Barrier".split(" "),image:"reimu"},Mage:{INT:8,DEX:4,STR:3,equipments:["Wand","Robe","FirstAidKit"],skills:"FireBall IceSpear DrainLife LightningLaser FireNova PotionOfIntelligence".split(" "),image:"utsuho"}},Bb={Ant:{INT:3,DEX:3,STR:4,equipments:["Dagger","LetherArmor"],skills:["Swing"],image:"ant.png"},Elemental:{INT:4,
DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["FireBall","AffinityToFire"],image:"elemental.png"},Frog:{INT:4,DEX:4,STR:4,equipments:["ShortBow","LetherArmor"],skills:["Shoot"],image:"frog.png"},Plant:{INT:4,DEX:3,STR:4,equipments:["Wand","LetherArmor"],skills:["FireNova"],image:"plant.png"},Slug:{INT:3,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["DrainLife"],image:"slug.png"},Snail:{INT:3,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["Heal"],image:"snail.png"},Sword:{INT:3,
DEX:5,STR:4,equipments:["LongSword","LetherArmor"],skills:["Swing"],image:"sword.png"},Wall:{INT:2,DEX:2,STR:6,equipments:["Mace","LetherArmor"],skills:["Swing"],image:"wall.png"},Weasel:{INT:3,DEX:6,STR:3,equipments:["Spear","LetherArmor"],skills:["Thrust"],image:"weasel.png"}},Tb={AddedFire:{tags:[c.Melee,c.Throw,c.Shoot],min:5,max:10,ATK:function(a,b){return b+a}}},R={Dagger:{tags:h(c.Melee,c.Slash),weight:13,price:100,ATK:30},ShortSword:{tags:h(c.Melee,c.Slash),weight:15,price:100,ATK:40},LongSword:{tags:h(c.Melee,
c.Slash),weight:16,price:100,ATK:50},Katana:{tags:h(c.Melee,c.Slash),weight:15,price:100,ATK:45},Axe:{tags:h(c.Melee,c.Slash,c.Blunt),weight:18,price:100,ATK:45},Mace:{tags:h(c.Melee,c.Blunt),weight:16,price:100,ATK:40},Spear:{tags:h(c.Melee,c.Pierce),weight:20,price:100,ATK:50},Halberd:{tags:h(c.Melee,c.Slash,c.Blunt,c.Pierce),weight:30,price:100,ATK:50},ShortBow:{tags:h(c.Shoot,c.Pierce),weight:18,price:100,ATK:30},LongBow:{tags:h(c.Shoot,c.Pierce),weight:20,price:100,ATK:40},Staff:{tags:h(c.Melee,
c.Blunt,c.Magic),weight:20,price:100,ATK:20},Wand:{tags:h(c.Magic),weight:16,price:100,ATK:25},FirstAidKit:{tags:h(c.Alchemy),weight:10,price:100,ATK:20},Buckler:{tags:h(c.Shield),weight:20,price:100,ATK:10,DEF:10},RoundShield:{tags:h(c.Shield),weight:25,price:100,ATK:15,DEF:15},SpikedShield:{tags:h(c.Shield),weight:30,price:100,ATK:30,DEF:15},KiteShield:{tags:h(c.Shield),weight:35,price:100,ATK:20,DEF:20},TowerShield:{tags:h(c.Shield),weight:40,price:100,ATK:30,DEF:20},Circlet:{tags:h(c.Head),weight:5,
price:100,DEF:2},LeatherHood:{tags:h(c.Head),weight:10,price:100,DEF:4},Mask:{tags:h(c.Head),weight:15,price:100,DEF:6},Sallet:{tags:h(c.Head),weight:20,price:100,DEF:8},Bascinet:{tags:h(c.Head),weight:25,price:100,DEF:10},Helmet:{tags:h(c.Head),weight:30,price:100,DEF:12},Robe:{tags:h(c.Body),weight:20,price:100,DEF:10},LetherArmor:{tags:h(c.Body),weight:25,price:100,DEF:15},ScaleArmor:{tags:h(c.Body),weight:30,price:100,DEF:20},Chainmail:{tags:h(c.Body),weight:35,price:100,DEF:22},LamellarArmor:{tags:h(c.Body),
weight:40,price:100,DEF:25},PlateArmor:{tags:h(c.Body),weight:45,price:100,DEF:30},Gloves:{tags:h(c.Arms),weight:10,price:100,DEF:4},Mittens:{tags:h(c.Arms),weight:20,price:100,DEF:6},Gauntlets:{tags:h(c.Arms),weight:30,price:100,DEF:8},Slippers:{tags:h(c.Legs),weight:5,price:100,DEF:2},Sandals:{tags:h(c.Legs),weight:10,price:100,DEF:4},Shoes:{tags:h(c.Legs),weight:15,price:100,DEF:6},Boots:{tags:h(c.Legs),weight:20,price:100,DEF:8},Greaves:{tags:h(c.Legs),weight:25,price:100,DEF:10}},Ub={Dummy:{usage:"single-hostile",
range:0,cost:999,AID:"Charge"},Swing:{usage:"single-hostile",range:1,cost:14,tags:h(c.Melee),deltaHP:-100,AID:"Charge"},Slash:{usage:"single-hostile",range:1,cost:15,tags:h(c.Melee,c.Slash),deltaHP:-110,AID:"Charge"},CutThrough:{usage:"single-hostile",range:1,cost:20,tags:h(c.Melee,c.Slash),deltaHP:-100,AID:"GoBehind"},Sweep:{usage:"surround-hostile",range:1,cost:20,tags:h(c.Melee,c.Slash),deltaHP:-100,AID:"Nova"},Crash:{usage:"single-hostile",range:1,cost:15,tags:h(c.Melee,c.Blunt),deltaHP:-110,
AID:"Charge"},Bash:{usage:"single-hostile",range:1,cost:20,tags:h(c.Melee,c.Blunt),deltaHP:-100,AID:"Knockback"},Stab:{usage:"single-hostile",range:1,cost:15,tags:h(c.Melee,c.Pierce),deltaHP:-110,AID:"Charge"},Thrust:{usage:"straight-hostile",range:2,cost:15,tags:h(c.Melee,c.Pierce),deltaHP:-100,AID:"Laser"},ShieldBash:{usage:"single-hostile",range:1,cost:20,tags:h(c.Shield),deltaHP:-100,AID:"Charge"},ShieldCharge:{usage:"single-hostile",range:1,cost:24,tags:h(c.Shield),deltaHP:-100,AID:"Trample"},
Shoot:{usage:"single-hostile",range:3,cost:20,tags:h(c.Shoot),deltaHP:-100,AID:"Shoot"},PoisonArrow:{usage:"single-hostile",range:3,cost:20,tags:h(c.Shoot),deltaHP:-60,turns:2,deltaHPoT:-30,AID:"Shoot"},OilArrow:{usage:"single-hostile",range:3,cost:20,tags:h(c.Shoot),deltaHP:-60,turns:2,mods:[{type:"incoming",level:-4,tags:h(c.Fire)}],AID:"Shoot"},IceSpear:{usage:"single-hostile",range:5,cost:16,tags:h(c.Magic,c.Cold),deltaHP:-80,deltaSP:-40,AID:"Shoot"},DrainLife:{usage:"single-hostile",range:5,
cost:16,tags:h(c.Magic,c.Life),deltaHP:-80,AID:"Drain"},FireBall:{usage:"single-hostile",range:5,cost:16,tags:h(c.Magic,c.Fire),deltaHP:-100,AID:"Explode"},LightningLaser:{usage:"straight-hostile",range:5,cost:16,tags:h(c.Magic,c.Lightning),deltaHP:-100,AID:"Laser"},FireNova:{usage:"surround-hostile",range:2,cost:16,tags:h(c.Magic,c.Fire),deltaHP:-100,AID:"Nova"},Heal:{usage:"single-friendly",range:3,cost:16,tags:h(c.Magic,c.Life),deltaHP:100,AID:"Shoot"},PartyHeal:{usage:"surround-friendly",range:1,
cost:24,tags:h(c.Magic,c.Life),deltaHP:100,AID:"Nova"},FirstAid:{usage:"single-friendly",range:1,cost:24,tags:h(c.Alchemy,c.Life),deltaHP:50,turns:2,deltaHPoT:25,AID:"Charge"},Empower:{usage:"single-friendly",range:3,cost:16,tags:h(c.Magic,c.Life),turns:2,mods:[{type:"outgoing",level:4,tags:h(c.Melee)}],AID:"Shoot"},Enhance:{usage:"single-friendly",range:3,cost:16,tags:h(c.Magic,c.Life),turns:2,mods:[{type:"outgoing",level:4,tags:h(c.Throw,c.Shoot)}],AID:"Shoot"},Enlighten:{usage:"single-friendly",
range:3,cost:16,tags:h(c.Magic,c.Life),turns:2,mods:[{type:"outgoing",level:4,tags:h(c.Magic)}],AID:"Shoot"},Absorber:{usage:"single-friendly",range:3,cost:16,tags:h(c.Magic,c.Life),turns:2,mods:[{type:"incoming",level:4,tags:h(c.Melee)}],AID:"Shoot"},Shelter:{usage:"single-friendly",range:3,cost:16,tags:h(c.Magic,c.Life),turns:2,mods:[{type:"incoming",level:4,tags:h(c.Throw,c.Shoot)}],AID:"Shoot"},Barrier:{usage:"single-friendly",range:3,cost:16,tags:h(c.Magic,c.Life),turns:2,mods:[{type:"incoming",
level:4,tags:h(c.Magic)}],AID:"Shoot"},PotionOfHealth:{usage:"dose",cost:24,tags:h(c.Alchemy,c.Life),deltaHP:100,AID:"Dose"},PotionOfRegeneration:{usage:"dose",cost:24,tags:h(c.Alchemy,c.Life),deltaHP:50,turns:2,deltaHPoT:50,AID:"Dose"},PotionOfStrength:{usage:"dose",cost:24,tags:h(c.Alchemy,c.Life),turns:3,mods:[{type:"outgoing",level:4,tags:h(c.Melee)}],AID:"Dose"},PotionOfDexterity:{usage:"dose",cost:24,tags:h(c.Alchemy,c.Life),turns:3,mods:[{type:"outgoing",level:4,tags:h(c.Throw,c.Shoot)}],AID:"Dose"},
PotionOfIntelligence:{usage:"dose",cost:24,tags:h(c.Alchemy,c.Life),turns:3,mods:[{type:"outgoing",level:4,tags:h(c.Magic)}],AID:"Dose"},PathToWarrior:{usage:"passive",cost:10,mods:[{type:"outgoing",level:2,tags:h(c.Melee)}]},PathToNinja:{usage:"passive",cost:10,mods:[{type:"outgoing",level:2,tags:h(c.Throw)}]},PathToArcher:{usage:"passive",cost:10,mods:[{type:"outgoing",level:2,tags:h(c.Shoot)}]},PathToMage:{usage:"passive",cost:10,mods:[{type:"outgoing",level:2,tags:h(c.Magic)}]},PathToAlchemist:{usage:"passive",
cost:10,mods:[{type:"outgoing",level:2,tags:h(c.Alchemy)}]},Defence:{usage:"passive",cost:10,mods:[{type:"incoming",level:2,tags:h(c.Melee)}]},Dodge:{usage:"passive",cost:10,mods:[{type:"incoming",level:2,tags:h(c.Throw,c.Shoot)}]},Meditation:{usage:"passive",cost:10,mods:[{type:"incoming",level:2,tags:h(c.Magic)}]},Healthy:{usage:"passive",cost:10,mods:[{type:"incoming",level:2,tags:h(c.Alchemy)}]},AffinityToFire:{usage:"passive",cost:10,mods:[{type:"outgoing",level:3,tags:h(c.Fire)},{type:"outgoing",
level:-3,tags:h(c.Cold,c.Lightning)},{type:"incoming",level:3,tags:h(c.Fire)}]},AffinityToCold:{usage:"passive",cost:10,mods:[{type:"outgoing",level:3,tags:h(c.Cold)},{type:"outgoing",level:-3,tags:h(c.Fire,c.Lightning)},{type:"incoming",level:3,tags:h(c.Cold)}]},AffinityToLightning:{usage:"passive",cost:10,mods:[{type:"outgoing",level:3,tags:h(c.Lightning)},{type:"outgoing",level:-3,tags:h(c.Fire,c.Cold)},{type:"incoming",level:3,tags:h(c.Lightning)}]}},Ib=function(a,b){return void 0===b?new wb(0,
a):new wb(a,b)}(c.MAX).map(function(a){return k("Tag",c[a])}),Vb=Ta([c.Melee,c.Throw,c.Shoot,c.Magic,c.Alchemy,c.Slash,c.Blunt,c.Pierce]),Wb=Ta([c.Shield,c.Head,c.Body,c.Arms,c.Legs]),Fa=function(){function a(b){this.EID=b;this.def=Tb[b];if(!this.def)throw new RangeError('Enchantment not found: "'+b+'"');this.name=a.nameOf(b);this.spec=a.specOf(b);this.value=this.def.min+Na(this.def.max-this.def.min)}a.prototype.qualify=function(a){return sa(this.name.localized,a)};a.prototype.modify=function(a){this.def.ATK&&
(a=this.def.ATK(this.value,a));return a};a.nameOf=function(a){return k("Enchant",a,"Name")};a.specOf=function(a){return k("Enchant",a,"Spec")};a.from=function(b){return new a(b)};a.fromJSON=function(b){return new a(b.EID)};a.prototype.toJSON=function(){return{EID:this.EID,value:this.value}};return a}(),ka=function(){function a(b,c){var e=R[b];if(!e)throw new RangeError('Item not found: "'+b+'"');this.IID=b;this.def=e;this.baseName=a.nameOf(b);this.spec=a.specOf(b);this.enchants=c?c:this.def.enchants?
this.def.enchants.map(Fa.from):[]}Object.defineProperty(a.prototype,"name",{get:function(){for(var a=this.baseName.localized,c=0,e=this.enchants;c<e.length;c++)a=e[c].qualify(a);return a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"tags",{get:function(){return this.def.tags},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"weight",{get:function(){return this.def.weight},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"priceToSell",{get:function(){for(var a=
this.def.price,c=0,e=this.enchants;c<e.length;c++)a=e[c].modify(a);return x(a)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ATK",{get:function(){for(var a=this.def.ATK||0,c=0,e=this.enchants;c<e.length;c++)a=e[c].modify(a);return a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){for(var a=this.def.DEF||0,c=0,e=this.enchants;c<e.length;c++)a=e[c].modify(a);return a},enumerable:!0,configurable:!0});a.nameOf=function(a){return k("Item",
a,"Name")};a.specOf=function(a){return k("Item",a,"Spec")};a.from=function(b){return new a(b)};a.fromJSON=function(b){return new a(b.IID,N(Fa,b.enchants))};a.prototype.toJSON=function(){return{IID:this.IID,enchants:ra(this.enchants)}};return a}(),gb=function(){function a(b){var c=Ub[b];if(!c)throw new RangeError('Skill not found: "'+b+'"');this.SID=b;this.def=c;this.name=a.nameOf(b);this.spec=a.specOf(b)}Object.defineProperty(a.prototype,"tags",{get:function(){return this.def.tags},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"usage",{get:function(){return this.def.usage},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"hostile",{get:function(){var a;a:switch(this.def.usage){case "single-hostile":case "straight-hostile":case "surround-hostile":a=!0;break a;default:a=!1}return a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"AID",{get:function(){return this.def.AID},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"isActive",{get:function(){return"passive"!==this.usage},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"isPassive",{get:function(){return"passive"===this.usage},enumerable:!0,configurable:!0});a.prototype.match=function(a){if(!this.def.tags)return!0;var c=this.def.tags.bits&Vb;return(c&a.def.tags.bits)===c};a.nameOf=function(a){return k("Skill",a,"Name")};a.specOf=function(a){return k("Skill",a,"Spec")};a.from=function(b){return new a(b)};a.fromJSON=function(b){return new a(b.SID)};
a.prototype.toJSON=function(){return{SID:this.SID}};a.DUMMY=new a("Dummy");return a}(),Cb=[1,2,3,4,5,5,5,5,4,3,2,1],Ga;(function(a){a[a.DEFAULT=0]="DEFAULT";a[a.BLINK_1=1]="BLINK_1";a[a.BLINK_2=2]="BLINK_2";a[a.BLINK_3=3]="BLINK_3";a[a.BLINK_4=4]="BLINK_4";a[a.CLOSED=5]="CLOSED";a[a.DEAD=6]="DEAD"})(Ga||(Ga={}));var Y=function(){function a(a,c,e,d,k,g,h,l,n){function p(){for(var a=[],b=0;b<arguments.length;b++)a[b-0]=arguments[b];var b=a[0],c=b.w,d=b.h,b=document.createElement("canvas");b.width=c;
b.height=d;var f=b.getContext("2d");if(f)for(c={x:0,y:0,w:c,h:d},d=0;d<a.length;d++)a[d].draw(f,void 0,c);return E.from(b)}function u(a){var b=r[0],c=b.w,d=b.h,b=document.createElement("canvas");b.width=c;b.height=d;var f=b.getContext("2d");if(f){var e={x:0,y:0,w:c,h:d};if(void 0!==f.filter)f.save(),f.filter="grayscale(100%)",a.draw(f,void 0,e),f.restore();else{a.draw(f,void 0,e);a=f.getImageData(0,0,c,d);for(var c=a.data,d=a.width,e=a.height,g=0;g<e;++g)for(var k=0;k<d;++k){var h=4*g*d+4*k,m=.2126*
c[h]+.7152*c[h+1]+.0722*c[h+2];c[h]=m;c[h+1]=m;c[h+2]=m}f.putImageData(a,0,0,0,0,d,e)}}return E.from(b)}this.name=a;this.level=c;this.INT=e;this.DEX=d;this.STR=k;this.equipments=g;this.skills=h;this.known=l;this.src=n;var r=[];a=0>n.indexOf("/")?"assets/char/"+n:n;if(n.endsWith(".png"))n=new E(a),r[0]=n;else{var q=[new E(a+"/back.png"),new E(a+"/eye.png"),new E(a+"/eye1.png"),new E(a+"/eye2.png"),new E(a+"/eye3.png"),new E(a+"/eye4.png"),new E(a+"/eye5.png"),new E(a+"/fore.png")];va(q).then(function(){r.push(p(q[0],
q[1],q[7]),p(q[0],q[2],q[7]),p(q[0],q[3],q[7]),p(q[0],q[4],q[7]),p(q[0],q[5],q[7]),p(q[0],q[6],q[7]));r.push(u(r[Ga.CLOSED]))})}this.images=r;this.blinkCycle=4500+100*e;this.blinkOffset=Na(this.blinkCycle)}Object.defineProperty(a.prototype,"w",{get:function(){var a=this.images[0];return a?a.w:1},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"h",{get:function(){var a=this.images[0];return a?a.h:1},enumerable:!0,configurable:!0});a.prototype.draw=function(a,c,e,d,k){var g;g=(c+this.blinkOffset)%
this.blinkCycle;g=450>g?Cb[x(g/450*Cb.length)]:0;var h=this.images;(g=h[g]||h[Ga.DEFAULT])&&g.draw(a,c,e,d,k)};Object.defineProperty(a.prototype,"HP",{get:function(){return 10*(3+this.STR)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"SP",{get:function(){var a=T(0,this.weight-this.maxWeight);return T(0,4*(3+this.STR)-a)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"reservedSP",{get:function(){var a=this;return this.skills.reduce(function(c,e){return c+(e.isPassive?
a.costOf(e):0)},0)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"step",{get:function(){return 13-this.DEX},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ZoC",{get:function(){return 3+this.DEX},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxWeight",{get:function(){return 10*(3+this.STR)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"weight",{get:function(){return this.equipments.reduce(function(a,c){return a+c.weight},
0)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){return 100*(1-this.equipments.reduce(function(a,c){return a*(1-c.DEF/100)},1))},enumerable:!0,configurable:!0});a.prototype.costOf=function(a){return a.def.cost-this.INT};a.prototype.rangeOf=function(a){return a.def.range};a.prototype.itemFor=function(a){var c;if(a&&a.isActive)for(var e=0,d=0,k=this.equipments;d<k.length;d++){var g=k[d];if(a.match(g)){var h=g.ATK;e<h&&(e=h,c=g)}}return c};a.adventurer=function(b){var c=
Sb[b];if(!c)throw new RangeError('Adventurer not found: "'+b+'"');return a.from(k("Adventurer",b),0,c)};a.monster=function(b,c){var e=Bb[b];if(!e)throw new RangeError('Monster not found: "'+b+'"');return a.from(k("Monster",b),c,e)};a.from=function(b,c,e){return new a(b.localized,c,e.INT,e.DEX,e.STR,e.equipments.map(ka.from),e.skills.map(gb.from),[],e.image)};a.fromJSON=function(b){return new a(b.name,b.level,b.INT,b.DEX,b.STR,N(ka,b.equipments),N(gb,b.skills),N(gb,b.known),b.image)};a.prototype.toJSON=
function(){return{name:this.name,level:this.level,INT:this.INT,DEX:this.DEX,STR:this.STR,equipments:ra(this.equipments),skills:ra(this.skills),known:ra(this.known),image:this.src}};return a}(),Ha;(function(a){var b=function(a){function b(){var c=this;a.call(this);(new K(0,0,1280,720,new E("assets/scene/title.jpg"))).attach(this);var h=cb(),g,l;h?(g=k("Title","Continue"),l=function(){return Q.go(c,new Ia.Home(h))},(new D(1070,650,200,60,new B(k("Title","Delete")),function(){Ua.confirm(c,k("Title",
"ConfirmDelete"),{label:k("Title","Delete"),click:function(){try{System.setRoamingStorage("NYO",void 0)}catch(a){F.error(a)}Q.go(c,new b);F.log(k("Title","NotifyDelete"))},mnemonic:nb},{label:k("Config","Cancel"),mnemonic:ob})})).attach(this)):(g=k("Title","New"),l=function(){var a={},b;for(b in R){var e=Na(4);0<e&&(a[b]=e)}a={shop:a,warehouse:[],reservers:[],party:[Y.adventurer("Knight"),Y.adventurer("Warrior"),Y.adventurer("Samurai"),Y.adventurer("Mage"),Y.adventurer("Healer"),Y.adventurer("Thief")],
gold:1E3};a.party[0].equipments[0].enchants.push(Fa.from("AddedFire"));eb(a);Q.go(c,new Ia.Home(a))});(new D(480,504,320,72,new B(g),l,Wa)).attach(this);(new D(480,612,320,72,new B(k("Title","Quit")),System.exit)).attach(this);jb(this)}w(b,a);return b}(P);a.Scene=b})(Ha||(Ha={}));var Ia;(function(a){function b(){return[{name:k("Character","Name"),extract:function(a){return a.name},width:200},{name:k("Character","INT"),extract:function(a){return a.INT},width:60,align:"right"},{name:k("Character","DEX"),
extract:function(a){return a.DEX},width:60,align:"right"},{name:k("Character","STR"),extract:function(a){return a.STR},width:60,align:"right"}]}function c(a){return[{name:a,extract:function(a){return a.name},width:200},{name:k("Town","Tags"),extract:function(a){return Ba(a.tags)}},{name:k("Town","Weight"),extract:function(a){return a.weight},width:60,align:"right"},{name:k("Town","ATK"),extract:function(a){return a.ATK},width:60,align:"right"},{name:k("Town","DEF"),extract:function(a){return a.DEF},
width:60,align:"right"}]}function e(a,b){var d=b.shop,e=c(a);e.push({name:k("Town","Stock"),extract:function(a){return aa(d[a.IID],k("Town","New"))},width:60,align:"right"});return e}function d(a,b){var c=b.shop,d=b.warehouse;return[{name:a,extract:function(a){return ka.nameOf(a).localized},width:200},{name:k("Town","Tags"),extract:function(a){return Ba(R[a].tags)}},{name:k("Town","ATK"),extract:function(a){return R[a].ATK},width:60,align:"right"},{name:k("Town","DEF"),extract:function(a){return R[a].DEF},
width:60,align:"right"},{name:k("Town","Weight"),extract:function(a){return R[a].weight},width:60,align:"right"},{name:k("Town","Stock"),extract:function(a){return c[a]},width:60,align:"right"},{name:k("Town","Owned"),extract:function(a){return d.reduce(function(b,c){return c.IID===a?b+1:b},0)},width:60,align:"right"}]}function h(a,b){return[{name:a,extract:function(a){return a.name.localized},width:200},{name:k("Town","Required"),extract:function(a){return a.tags?Ba(a.tags):"-"}},{name:k("Town",
"Cost"),extract:function(a){return b.costOf(a)},width:60,align:"right"},{name:k("Town","Range"),extract:function(a){return b.rangeOf(a)},width:60,align:"right"},{name:k("Town","Power"),extract:function(a){return a.def.deltaHP},width:60,align:"right"},{name:k("Town","Spec"),extract:function(a){return a.spec.localized}}]}var g={fontSize:64,fillStyle:l(255,255,255),strokeStyle:l(0,0,0),textAlign:"center",textBaseline:"middle",lineWidth:2},p=function(){function a(b,c){this.party=b;this.index=c}a.prototype.draw=
function(a,b,c){var d=c.x,e=c.y,f=c.w;c=c.h;var k=this.party[this.index];a.save();if(k){var h=Ra(k,140,184);k.draw(a,b,{x:d+f/2-h.w/2,y:e+92-h.h/2,w:h.w,h:h.h});var m=this.party.reduce(function(a,b){return b?T(a,b.HP):a},1);b=k.HP;var h=d+10,n=f-20,p=e+c-30,m=(n-2)*b/m;a.strokeStyle="black";a.fillStyle=fb.full;a.fillRect(h,p,m,6);a.strokeRect(h,p,m,6);ia(a,b.toString(),h+4,p-20,n,20,{fontSize:20,fillStyle:l(255,255,255),strokeStyle:l(0,0,0),textAlign:"left",textBaseline:"bottom",lineWidth:2});ia(a,
k.name,d,e+c-24,f,24,{fontSize:24,fillStyle:l(255,255,255),strokeStyle:l(0,0,0),textAlign:"center",textBaseline:"bottom",lineWidth:2})}else ia(a,(this.index+1).toString(),d,e,f,c,g);a.restore()};return a}(),r=function(a){function b(c){a.call(this);this.data=c}w(b,a);b.prototype.addButton=function(a,b,c,d){a=new D(1280-170*a,665,160,45,new B(c),d,b);a.attach(this);return a};b.prototype.goTo=function(a){Q.go(this,new a(this.data))};return b}(P),z=function(a){function b(c,d){a.call(this,c);(new K(0,
0,1280,720,new E("assets/scene/"+d))).attach(this);jb(this);for(var e=c.party,f=this,g=[],k=0;6>k;++k){var h=x(k/3);(new Ob(10+170*(1-h),10+k%3*214+68*h,160,204,g,new p(e,k),function(){f.onPortraitClick(this.drawable.index)},function(a){var b=this.drawable;a=a.drawable;c=[e[a.index],e[b.index]];e[b.index]=c[0];e[a.index]=c[1];c=[a.index,b.index];b.index=c[0];a.index=c[1];var c},[n.$1+k])).attach(this)}}w(b,a);return b}(r),H=function(a){function b(c){var d=this;a.call(this,c,"town.jpg");var e=["grass",
"moss"],f=Na(e.length);this.addSpot(5,n.A,"Guild",function(){}).enabled=!1;this.addSpot(4,n.B,"Tavern",function(){return d.goTo(u)});this.addSpot(3,n.C,"Shop",function(){return d.goTo(J)});this.addSpot(2,n.D,"Smith",function(){}).enabled=!1;this.addSpot(1,n.E,"Dungeon",function(){Q.go(d,new Ja.Scene(c,new Ja.EndressStage(e[f],0)))}).enabled=c.party.some(function(a){return!!a});this.addButton(2,[n.L],k("Town","Load"),function(){Ua.confirm(d,k("Town","ConfirmLoad"),{label:k("Town","Load"),click:function(){var a=
cb();a&&(Q.go(d,new b(a)),F.log(k("Town","NotifyLoad")))},mnemonic:nb},{label:k("Config","Cancel"),mnemonic:ob})});this.addButton(1,[n.S],k("Town","Save"),function(){eb(d.data);F.log(k("Town","NotifySave"))})}w(b,a);b.prototype.onPortraitClick=function(a){this.data.party[a]&&Q.go(this,new q(this.data,a))};b.prototype.addSpot=function(a,b,c,d){a=new D(950,665-100*a,320,90,new B(k("Town",c)),d,[b]);a.attach(this);return a};return b}(z);a.Home=H;var u=function(a){function c(d){function e(a,b){(c=Array.prototype.splice).call.apply(c,
[a,0,a.length].concat(b));var c}var f=this;a.call(this,d,"tavern.jpg");var g=d.party.concat(),h=d.reservers.concat();this.addButton(3,[n.C],k("Town","Clear"),function(){for(var a=0;6>a;++a){var b=d.party[a];b&&(d.reservers.push(b),d.party[a]=void 0)}});this.addButton(2,[n.R],k("Town","Revert"),function(){e(d.party,g);e(d.reservers,h)});this.addButton(1,pa,k("Town","Back"),function(){return f.goTo(H)});(new G(350,10,920,G.heightOf(10),b(),d.reservers,function(a,b){return f.onReserverClick(a,b)})).attach(this)}
w(c,a);c.prototype.onPortraitClick=function(a){var b=this.data.party[a];b&&(this.data.party[a]=void 0,this.data.reservers.push(b))};c.prototype.onReserverClick=function(a,b){for(var c=0;6>c;++c)if(!this.data.party[c]){this.data.party[c]=a;this.data.reservers.splice(b,1);return}F.error(k("Town","PartyFull"))};return c}(z),J=function(a){function b(c){var f=this;a.call(this,c,"shop.jpg");var g=c.shop,h=c.warehouse,m=new G(350,10,920,G.heightOf(10),d(k("Town","Buy"),c),Qa(g),function(a){if(0>=g[a])F.error(k("Town",
"SoldOut"));else{var b=R[a].price;if(c.gold<b)F.error(k("Town","NoMoney"));else{var d=new ka(a);--g[a];h.push(d);c.gold-=b;F.log(sa(k("Town","NotifyBuy").localized,d.name,b))}}});m.attach(this);var l=new G(350,10,920,G.heightOf(10),e(k("Town","Sell"),c),h,function(a,b){var d=a.IID,e=a.priceToSell;h.splice(b,1);var f=g[d];null==f?(g[d]=1,m.rows.push(d)):g[d]=1+f;c.gold+=e;F.log(sa(k("Town","NotifySell").localized,a.name,e))});l.attach(this);var p,q;p=this.addButton(3,[n.B],k("Town","Buy"),function(){m.visible=
!0;l.visible=!1;p.enabled=!1;q.enabled=!0});q=this.addButton(2,[n.S],k("Town","Sell"),function(){m.visible=!1;l.visible=!0;p.enabled=!0;q.enabled=!1});this.addButton(1,pa,k("Town","Back"),function(){return f.goTo(H)});p.onClick()}w(b,a);b.prototype.onPortraitClick=function(a){F.log("TODO: Shop.onPortraitClick: "+a)};return b}(z),q=function(a){function b(d,e){var g=this;a.call(this,d);var l=d.warehouse,p=d.party,q=p[e],r=Ra(q,1280,720,!0);(new K(0,0,r.w,r.h,q)).attach(this);(new K(0,0,200,40,new B(q.name+
" / Lv: "+q.level))).attach(this);r={textAlign:"left"};(new K(0,40,200,40,new B("INT: "+q.INT,r))).attach(this);(new K(100,40,200,40,new B("DEX: "+q.DEX,r))).attach(this);(new K(200,40,200,40,new B("STR: "+q.STR,r))).attach(this);(new K(0,80,200,40,new B(function(){return"HP: "+q.HP},r))).attach(this);(new K(0,120,200,40,new B(function(){var a;a=q.reservedSP;a=0<a?"SP: "+(q.SP-a)+" ("+a+" reserved)":"SP: "+q.SP;return a},r))).attach(this);(new K(0,160,200,40,new B(function(){return"WT: "+q.weight+
"/"+q.maxWeight},r))).attach(this);(new K(0,200,200,40,new B(function(){return"DEF: "+q.DEF.toFixed(1)},r))).attach(this);var u=new P([new G(350,10,920,G.heightOf(10),c(k("Town","Equipments")),q.equipments,function(a,b){q.equipments.splice(b,1);l.push(a)}),new G(350,360,920,G.heightOf(10),c(k("Town","Warehouse")),l,function(a,b){l.splice(b,1);var c=q.equipments,d=a.tags.bits,e=[];if(d&=Wb)for(var f=0;f<c.length;)c[f].tags.bits&d?(e.push(c[f]),c.splice(f,1)):++f;q.equipments.push(a);(g=l.push).call.apply(g,
[l].concat(e));var g})]);u.attach(this);var w=new P([new G(350,10,920,G.heightOf(10),h(k("Town","Skills"),q),q.skills,function(a,b){q.skills.splice(b,1);q.known.push(a)}),new G(350,360,920,G.heightOf(10),h(k("Town","Knowns"),q),q.known,function(a,b){10>q.skills.length?(q.known.splice(b,1),q.skills.push(a)):F.error(k("Town","SkillFull"))})]);w.attach(this);for(var x=p.length,z=function(a){var c=(e+x-a)%x;if(p[c])return D.addButton(5,Qb,k("Town","Prev"),function(){return Q.go(g,new b(g.data,c))}),"break"},
D=this,r=1;r<x&&"break"!==z(r);++r);for(var z=function(a){var c=(e+a)%x;if(p[c])return E.addButton(4,Rb,k("Town","Next"),function(){return Q.go(g,new b(g.data,c))}),"break"},E=this,r=1;r<x&&"break"!==z(r);++r);var J,I;J=this.addButton(3,[n.E],k("Town","Equipments"),function(){u.visible=!0;w.visible=!1;I.enabled=!0;J.enabled=!1});I=this.addButton(2,[n.S],k("Town","Skills"),function(){u.visible=!1;w.visible=!0;I.enabled=!1;J.enabled=!0});this.addButton(1,pa,k("Town","Back"),function(){return g.goTo(H)});
J.onClick()}w(b,a);return b}(r)})(Ia||(Ia={}));var Ja;(function(a){function b(a,b){var t=a.xH;return{xH:t+[1,2,1,-1,-2,-1][b],yH:a.yH+(0===t%2?[-1,0,0,0,0,-1]:[0,0,1,1,0,0])[b]}}function f(a,b){var t=a.xH,c=b.xH,d=c-t,t=2*b.yH+c%2-(2*a.yH+t%2);return 0>t?t>d?(-d-t)/2:t>-d?(d-t)/2:-t:t<d?(d+t)/2:t<-d?(-d+t)/2:t}function e(a,b){return a===b||!!a&&!!b&&a.xH===b.xH&&a.yH===b.yH}function d(a){return 0>a?a.toString():"+"+a}function h(a,b,t){if(a)return""+la(a);if(b)return"SP: "+la(a);if(t){a=t.deltaHPoT;
b=t.deltaSPoT;t=t.mods;if(a)return"HPoT: "+la(a);if(b)return"SPoT: "+la(b);if(t)return t=t[0],k("Character",t.type)+" "+Ba(t.tags)+" "+d(t.level)}return"?"}function g(a,b,t,c,d,e,f,g,k){var h=fa(0,1,e/f);e=null==g?h:fa(0,1,(e+g)/f);a.save();a.fillStyle=k.bkgnd;a.fillRect(b,t,c,d);b+=1;t+=1;c-=2;d-=2;e>h?(a.fillStyle=1<=h?k.full:k.normal,a.fillRect(b,t,c*h-1,d),a.fillStyle=k.full,a.fillRect(b+c*h,t,c*(e-h),d)):e<h?(f=c*e,0<e&&(f=T(f,2),a.fillStyle=1<=h?k.full:k.normal,a.fillRect(b,t,f-1,d)),a.fillStyle=
k.delta,a.fillRect(b+f,t,c*(h-e),d)):(a.fillStyle=1<=h?k.full:k.normal,a.fillRect(b,t,c*h,d));a.restore()}function G(a,b,t,c,d){b=t.toX(d)+16;t=t.toY(d)+60;g(a,b,t,96,6,c.HP,c.maxHP,void 0,fb)}function I(a,b,t,c,d,e){b=t.toX(d)+16;t=t.toY(d)+60+6;g(a,b,t,96,6,c.SP,c.maxSP,e-c.SP,Ab)}function N(a){var b=a.def.tags,b=b?b.bits:0;return b&1<<c.Fire?{r:255,g:128,b:0}:b&1<<c.Cold?{r:0,g:128,b:255}:b&1<<c.Lightning?{r:255,g:255,b:0}:b&1<<c.Life?a.hostile?{r:255,g:0,b:128}:{r:0,g:255,b:128}:{r:255,g:255,
b:255}}function R(a,b,t){var c,d=f(b,t)+1;a.straight(b,t,d,function(b,t){t===d&&a.get(b).empty&&(c=b)});return c}function u(a,b,t,c){var d=b.hex,e=t.hex;t=b.estimate(a,t,c);var f=a.promiseEffect(t,e),d=new Fa(a,d,e);b.state=d;d.hit(function(){return f.attach(a)});return p.wait.POPUP?va([f,d]):d}function J(a,b,t,c){c=N(c);var d=Sa(c),e=Sa(c,0);c=a.toX(b)-a.toX(t);var f=a.toY(b)-a.toY(t);c=100+Ca(c*c+f*f,.5)/1280*400;c=new H(c,function(c,y){var f=a.toX(b),g=a.toY(b),pb=a.toX(t),k=a.toY(t);ab(y,f*(1-
c)+pb*c+64-20,g*(1-c)+k*c+40-20,40,40,d,e,.5)});c.attach(a);return c}function q(a,b,t,c,d,e){function f(c,d){var y=b.getTarget(g,c);y&&(y=b.estimate(a,y,t),e&&(y.deltaHP&&(y.deltaHP=e(y.deltaHP,d)),y.deltaSP&&(y.deltaSP=e(y.deltaSP,d)),y.eot&&(y.eot.deltaHPoT&&(y.eot.deltaHPoT=e(y.eot.deltaHPoT,d)),y.eot.deltaHPoT&&(y.eot.deltaHPoT=e(y.eot.deltaHPoT,d)))),y=a.promiseEffect(y,c),y.attach(a),k.push(y))}var g=a.field,k=[];f(c,0);g.surround(c,d,f);var h=N(t),C=Sa(h,0),l=new H(400,function(b,t){var e=
a.toX(c)+64,f=a.toY(c)+40,A=128*d*b,L=80*d*b,g=Sa(h,1-b);ab(t,e-A,f-L,2*A,2*L,g,C,b)});l.attach(a);return p.wait.POPUP?(k.push(l),va(k)):l}var X=Ca(2,.1),M=[{lineWidth:2,fillStyle:l(0,0,68),strokeStyle:l(204,204,255)},{lineWidth:2,fillStyle:l(68,0,0),strokeStyle:l(255,204,204)}],xa={fillStyle:"white",textAlign:"left",textBaseline:"top"},O=r(0,0,0,0),aa=r(0,0,0,.75),ja={inner:l(230,255,180),outer:l(51,230,51)},ga={inner:l(230,180,255),outer:l(51,51,230)},Da={inner:l(255,180,230),outer:l(230,51,51)},
oa={inner:l(230,180,255),outer:l(51,51,230)},ia={outer:l(64,192,255),inner:l(180,232,255),bkgnd:r(64,192,255,.3)},ka={outer:l(255,192,64),inner:l(255,232,192),bkgnd:r(255,192,64,.3)},pa={DASH_OR_RANGE:{outer:l(255,64,64),inner:l(255,180,180),bkgnd:r(255,192,64,.3)},RANGE:{outer:l(255,64,64),inner:l(255,180,180),bkgnd:r(255,128,64,.3)},TARGET:{outer:l(255,24,24),inner:l(255,64,64),bkgnd:r(255,24,24,.3)}},ra={DASH_OR_RANGE:{outer:l(24,24,255),inner:l(180,180,255),bkgnd:r(255,192,64,.3)},RANGE:{outer:l(64,
64,255),inner:l(180,180,255),bkgnd:r(24,128,255,.3)},TARGET:{outer:l(24,24,255),inner:l(64,64,255),bkgnd:r(24,24,255,.3)}},wa=r(0,0,0,.65),Aa=r(0,0,0,0),Ja={textAlign:"center",textBaseline:"bottom",fontSize:32,fillStyle:"yellow",strokeStyle:"black",lineWidth:2},Oa={textAlign:"center",textBaseline:"bottom",fontSize:32,fillStyle:"red",strokeStyle:"black",lineWidth:2},sa=r(255,0,0,.8),Ta=l(255,180,180),Va=l(180,255,180),Wa=[{messageID:"PartyTurn",innerStyle:l(0,0,128),outerStyle:r(0,0,128,0),textStyle:{fontSize:64,
fillStyle:"white",textAlign:"center",textBaseline:"middle"}},{messageID:"EnemyTurn",innerStyle:l(128,0,0),outerStyle:r(128,0,0,0),textStyle:{fontSize:64,fillStyle:"white",textAlign:"center",textBaseline:"middle"}}],Xa=function(){function a(b,t){this.dummy=t;this.cells={};this.depth=x(b)}Object.defineProperty(a.prototype,"minXH",{get:function(){return 1+lb(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxXH",{get:function(){return 20+x(this.depth)},enumerable:!0,configurable:!0});
Object.defineProperty(a.prototype,"minVisibleXH",{get:function(){return x(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxVisibleXH",{get:function(){return 21+lb(this.depth)},enumerable:!0,configurable:!0});a.prototype.contains=function(a,b){if(null==a)return!1;var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;return 0<=b&&3>b&&this.minXH<=c&&c<this.maxXH;var d};a.prototype.getLine=function(a){return this.cells[a]};a.prototype.setLine=function(a,b){this.cells[a]=b};a.prototype.deleteLine=
function(a){delete this.cells[a]};a.prototype.rawget=function(a,b){var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;if(0<=b&&3>b&&this.minVisibleXH<=c&&c<this.maxVisibleXH&&(c=this.cells[c]))return c[b];return;var d};a.prototype.get=function(a,b){var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;c=this.rawget(c,b);return void 0===c?this.dummy:c;var d};a.prototype.set=function(a,b,c){null==c&&(d=b,b=d.xH,c=d.yH,d);(d=this.cells[b])||(d=this.cells[b]=[]);d[c]=a;var d};a.prototype.each=function(a){for(var b=this.maxXH,
c=this.minXH;c<b;++c)for(var d=0;3>d;++d)a(this.get(c,d),c,d)};a.prototype.eachVisible=function(a){for(var b=this.maxVisibleXH,c=this.minVisibleXH;c<b;++c)for(var d=0;3>d;++d)a(this.get(c,d),c,d)};a.prototype.straight=function(a,b,c,d){if(!e(a,b)){var L=a.xH,g=1+2*(2*a.yH+a.xH%2),k=b.xH,h=1+2*(2*b.yH+b.xH%2);a=f(a,b);k=(k-L)/a;h=(h-g)/a;for(a=1;a<=c;++a){var v=L+a*k;b=x((g+a*h)/2);v=0===b%2?2*x((v+1)/2):2*x(v/2)+1;b=x(b/2);this.contains(v,b)&&d({xH:v,yH:b},a)}}};a.prototype.surround=function(a,c,
d){if(1===c)for(var e=0;6>e;++e){var f=b(a,e);this.contains(f)&&d(f,1)}else if(1<c){a=b(a,0);for(var g=1;g<=c;++g){for(var f=a,k=0,h=[2,3,4,5,0,1];k<h.length;k++)for(var e=h[k],v=0;v<g;++v,f=b(f,e))this.contains(f)&&d(f,g);a=b(a,0)}}};return a}(),ea=function(){function a(b){this.duration=b}a.prototype.then=function(a){this.duration?this.sig=ha(this.sig,a):z.then(a);return this};a.prototype.commit=function(){ba(this.sig);this.duration=this.sig=void 0};a.prototype.getXY=function(a,b,c){if(this.duration)if(c=
H.clamp(c,this.start,this.duration),1<=c)this.commit();else return this.onGetXY(a,b,c)};a.prototype.drawCharacter=function(a,b,c,d,e,f,g){a.drawCharacter(b,c,d,e,f,g)};return a}(),Ea=function(a){function b(c){a.call(this,400*(13-c)/4)}w(b,a);b.prototype.onGetXY=function(a,b,c){a=a.hex;return{x:b.toX(a)-128*(1-c)+64,y:b.toY(a)+80}};return b}(ea),La=function(a){function b(c){a.call(this,100*Ca(c.length-1,.75));this.path=c}w(b,a);b.prototype.onGetXY=function(a,b,c){var d=this.path.length-1,e=x(d*c),
f=this.path[e],g=this.path[e+1];a=b.toX(f);var f=b.toY(f),k=b.toX(g);b=b.toY(g);c=d*c-e;return{x:a*(1-c)+k*c+64,y:f*(1-c)+b*c+80}};return b}(ea),Fa=function(a){function b(c,d,e){a.call(this,function(a,b,c){var t=a.toX(b)-a.toX(c);a=a.toY(b)-a.toY(c);return 200+Ca(t*t+a*a,.3)/1280*1E3}(c,d,e));this.hexFrom=d;this.hexTo=e}w(b,a);b.prototype.hit=function(a){this.duration?this.hitsig=ha(this.hitsig,a):z.then(a)};b.prototype.commit=function(){ba(this.hitsig);this.hitsig=void 0;a.prototype.commit.call(this)};
b.prototype.onGetXY=function(a,b,c){var d=this.hexFrom,e=this.hexTo;a=b.toX(d);var d=b.toY(d),f=b.toX(e);b=b.toY(e);.5>c?c*=2:(c=2-2*c,ba(this.hitsig),this.hitsig=void 0);return{x:a*(1-c)+f*c+64,y:d*(1-c)+b*c+80}};return b}(ea),Ha=function(a){function b(c,d){a.call(this,500);var e=c.HP;this.dying=d>=e?c.hex:void 0;this.radius=d>=e/2?1:.5+d/e}w(b,a);b.prototype.onGetXY=function(a,b,c){var d=20*(1-c)*this.radius;c=c*V*this.duration/250*this.radius;a=this.dying||a.hex;return{x:d*U(4*c)+b.toX(a)+64,y:d*
U(3*c)+b.toY(a)+80}};b.prototype.drawCharacter=function(b,c,d,e,f,g,k){this.dying?(g=H.clamp(d,this.start,this.duration),c.save(),c.globalAlpha=1-g,a.prototype.drawCharacter.call(this,b,c,d,e,f,"red",g),c.restore()):a.prototype.drawCharacter.call(this,b,c,d,e,f,g,k)};return b}(ea),qb=function(){function a(b,c,d){this.ch=b;this.team=c;this._hex=d;this.idleOffset=Za();this.effectsOverTime=[];this.HP=this.maxHP;c=this.minCost=this.SP=this.availSP;var e;d=0;for(var f=b.skills;d<f.length;d++){var g=f[d];
if(b.itemFor(g)){var k=this.costOf(g);!e&&0<b.rangeOf(g)&&k<=c&&(e=g);k<this.minCost&&(this.minCost=k)}}this.skill=e||gb.DUMMY}Object.defineProperty(a.prototype,"hex",{get:function(){return this._hex},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"alive",{get:function(){return!!this._hex},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"name",{get:function(){return this.ch.name},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"level",{get:function(){return this.ch.level},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"INT",{get:function(){return this.ch.INT},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEX",{get:function(){return this.ch.DEX},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"STR",{get:function(){return this.ch.STR},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxHP",{get:function(){return this.ch.HP},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxSP",
{get:function(){return this.ch.SP},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"availSP",{get:function(){return T(0,this.ch.SP-this.ch.reservedSP)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"step",{get:function(){return this.ch.step},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ZoC",{get:function(){return this.ch.ZoC},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){return this.ch.DEF},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"skills",{get:function(){return this.ch.skills},enumerable:!0,configurable:!0});a.prototype.costOf=function(a){return this.ch.costOf(a)};a.prototype.rangeOf=function(a){return this.ch.rangeOf(a)||0};a.prototype.getModsLevel=function(a,b){function c(a,b,d){var t=0;if(d)for(var e=0;e<d.length;e++){var y=d[e];y.type===b&&a&y.tags.bits&&(t+=y.level)}return t}for(var d=this.level,e=0,f=this.ch.skills;e<f.length;e++){var g=f[e].def;"passive"===g.usage&&
(d+=c(a,b,g.mods))}e=0;for(f=this.effectsOverTime;e<f.length;e++)d+=c(a,b,f[e].mods);return d};a.prototype.getOutgoingLevel=function(a){return this.getModsLevel(a,"outgoing")};a.prototype.getIncomingLevel=function(a){return this.getModsLevel(a,"incoming")};a.prototype.isEnemy=function(a){return!!a&&this.team!==a.team};a.prototype.isTarget=function(a,b){return a?"dose"===b.usage?this===a:b.hostile?this.isEnemy(a):this!==a&&!this.isEnemy(a):!1};a.prototype.getTarget=function(a,b){var c=a.get(b).unit;
if(this.isTarget(c,this.skill))return c};a.prototype.done=function(a){var b=this._hex;return a.enabled&&!!b&&this.SP<this.minCost&&this.SP<this.step+a.zoc[this.team].get(b)};a.prototype.estimate=function(a,b,c){function d(a){return lb(a*Ca(X,h-(0>a?C:l)))}function e(a){return a?d(f*a/100*(100-g)/100):void 0}ca(this.isTarget(b,c));var f=this.ch.itemFor(c).ATK,g=b.DEF,k=c.def;c=k.tags?k.tags.bits:0;var h=this.getOutgoingLevel(c),C=b.getIncomingLevel(c),l=a.getLevel(c);return{target:b,deltaHP:e(k.deltaHP),
deltaSP:e(k.deltaSP),eot:function(a){return a?{turns:a,deltaHPoT:e(k.deltaHPoT),deltaSPoT:e(k.deltaSPoT),mods:Fb(k.mods,function(a){return{type:a.type,level:d(a.level),tags:a.tags}})}:void 0}(k.turns)}};a.prototype.shoot=function(a,b,c){this.isTarget(b,c);var d=this.costOf(c);a:{var e=c.AID;if(e){var f=eb[e];if(f)break a}throw new RangeError('Action not found: "'+e+'"');}a=f(a,this,b,c);this.SP-=d;return a};a.prototype.recuperate=function(){var a=x(.1*this.maxHP);this.HP=S(this.maxHP,this.HP+a)};
Object.defineProperty(a.prototype,"canRevive",{get:function(){return!this._hex&&.5<=this.HP/this.maxHP},enumerable:!0,configurable:!0});a.prototype.onTurnEnd=function(a){this.team===a.team&&(this.SP=this.availSP)};a.prototype.onTurnStart=function(a){if(this.team===a.team){for(var b=0,c=this.effectsOverTime,d=c.length-1;0<=d;--d){var e=c[d];null!=e.deltaHPoT&&(b+=e.deltaHPoT);0>=--e.turns&&c.splice(d,1)}if(b)return b=a.promiseEffect({target:this,deltaHP:b},this.hex),b.attach(a),b}};a.prototype.getXY=
function(a,b){var c;this.state&&(c=this.state.getXY(this,a,b),c||(this.state=void 0));if(!c){var d=this._hex;d&&(c={x:a.toX(d)+64,y:a.toY(d)+80})}return c};Object.defineProperty(a.prototype,"state",{get:function(){return this._state},set:function(a){var b=this._state;if(this._state=a)a.start=performance.now();b&&b.commit()},enumerable:!0,configurable:!0});a.prototype.drawCharacter=function(a,b,c,d,e,f){var g=this.ch,k=Ra(g,128,128),h=k.w,C=.2*h;ab(a,c-h/2,d-10-C/2,h,C,wa,Aa,.75);b&&(h=200*(13-g.DEX),
h=T(0,U(2*V*(this.idleOffset+b%h/h))),d-=16*h+10*(1-h));k.x=c-k.w/2;k.y=d-k.h;g.draw(a,b,k,e,f)};a.prototype.draw=function(a,b,c,d,e,f){this.state?this.state.drawCharacter(this,a,b,c,d,e,f):this.drawCharacter(a,b,c,d,e,f)};a.prototype.drawBars=function(a,b,c,d,e){var f=this.hex;b=c.toX(f)+16;c=c.toY(f)+60;g(a,b,c,96,6,this.HP,this.maxHP,d,fb);g(a,b,c+6,96,6,this.SP,this.maxSP,e,Ab)};a.compare=function(a,b){return a.y<b.y?-1:a.y>b.y?1:a.x<b.x?-1:a.x>b.x?1:0};return a}(),Ma=function(){function a(b,
c){void 0===b&&(b=0);this.type=b;this.unit=c}Object.defineProperty(a.prototype,"empty",{get:function(){return null==this.unit&&0===this.type},enumerable:!0,configurable:!0});a.DUMMY=new a(1);return a}(),Pa=function(a){function c(d,f,g){function k(a){var b=this,c=f.hex,g=d.field,h=d.numScrollsPerTurn,W=this.get(a).SP,L=Ya.get(a),pb=la(2*a.yH+a.xH%2-3),v=g.minXH+h,l=a.xH<v,C=function(c){var d=b.get(c).SP;if(W>d)return!0;if(W<d)return!1;d=c.xH<v;if(!l&&d)return!0;if(l&&!d)return!1;d=Ya.get(c);return L<
d?!0:L>d?!1:a.xH<c.xH?!0:a.xH>c.xH?!1:pb<la(2*c.yH+c.xH%2-3)};g.surround(a,n,function(k){if(!e(k,c)){var h=b.ensure(k);if(h.shotFrom)C(h.shotFrom)&&(h.shotFrom=a);else if(h.shotFrom=a,k=f.getTarget(g,k))h.effect=f.estimate(d,k,m)}})}var h=this,l=d.field;a.call(this,l.depth,c.DUMMY);var Ya=d.zoc[f.team],v=f.hex,C=f.step,m=f.skill,qa=f.costOf(m),n=f.rangeOf(m);this.ensure(v).SP=g;if(g>=C+Ya.get(v))for(var Ka=[],q=v;q;q=Ka.shift()){var p=this.get(q).SP-(C+Ya.get(q));if(0<=p)for(var r=0;6>r;++r){var u=
b(q,r),w=l.rawget(u);w&&0===w.type&&!f.isEnemy(w.unit)&&(w=this.ensure(u),w.SP<p||w.SP===p&&l.get(q).empty&&(!w.comeFrom||!l.get(w.comeFrom).empty))&&(w.SP=p,w.comeFrom=q,p>=C+Ya.get(u)&&Ka.push(u))}}g>=qa&&1<=n&&(k.call(this,v),this.each(function(a,b,c){a.SP>=qa&&l.get(b,c).empty&&k.call(h,{xH:b,yH:c})}))}w(c,a);c.prototype.ensure=function(a){var b=this.rawget(a);b||(b={SP:-1},this.set(b,a));return b};c.prototype.getPath=function(a,b){var c=this.get(a);if(c){var d=c.comeFrom,e=c.shotFrom;if(c.effect&&
e){if(!b.get(e).empty)return;c=[e];e=this.get(e);d=e.comeFrom;e}else if(d){if(!b.get(a).empty)return;c=[a]}else return;for(;d;)c.unshift(d),e=this.get(d),d=e.comeFrom,e;return c}};c.DUMMY={SP:-1};return c}(Xa),bb=function(a){function b(c,d,e,f,g,h){a.call(this,e,f,g,h,new B(function(){var a=c.focus;if(a){var b=a.skills[d];if(b){var e=b.def;if("passive"===e.usage)return e=e.mods[0],b.name.localized+"\n"+k("Character",e.type)+": "+Ba(e.tags);var e=a.skill===b,f=a.costOf(b),a=a.rangeOf(b),g=la(b.def.deltaHP||
0);return""+(e?"E ":"")+b.name.localized+"\n"+f+" / "+a+" / "+(null!=g?g.toFixed(1):"-")}}},{fontSize:20}),function(){if(this.enabled){var a=this.scene.focus,b=a.skills[this.index];"dose"===b.usage?c.controller.dose(a,b):(a.skill=b,c.onSkillChanged(a))}},void 0,b.design);this.scene=c;this.index=d}w(b,a);Object.defineProperty(b.prototype,"visible",{get:function(){var a=this.scene.focus;return!!a&&!!a.skills[this.index]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"enabled",{get:function(){var a=
this.scene.focus;if(a){var b=a.skills[this.index];if(b&&a.ch.itemFor(b))return a.SP>=a.costOf(b)}return!1},enumerable:!0,configurable:!0});b.design={draw:function(a,b,c){if(c.visible){var d=c.scene.focus;if(0<d.rangeOf(d.skills[c.index]))D.defaultDesign.draw(a,b,c);else{var e=D.defaultDesign.getStyle(c.state),f=d=void 0,g=void 0,k,h;null==d?(g=c,k=g.x,h=g.y,d=g.w,f=g.h,g,g=e):(k=c,h=e);if(0<d&&0<f){a.save();$a(a,g);if(!g||g.strokeStyle)e=a.lineWidth-1,k+=e/2,h+=e/2,d-=e,f-=e;e=.2*S(d,f);a.beginPath();
a.moveTo(k+e,h);a.lineTo(k+d-e,h);a.quadraticCurveTo(k+d,h,k+d,h+e);a.lineTo(k+d,h+f-e);a.quadraticCurveTo(k+d,h+f,k+d-e,h+f);a.lineTo(k+e,h+f);a.quadraticCurveTo(k,h+f,k,h+f-e);a.lineTo(k,h+e);a.quadraticCurveTo(k,h,k+e,h);g&&!g.fillStyle||a.fill();g&&!g.strokeStyle||a.stroke();a.restore()}c.drawable&&c.drawable.draw(a,b,c)}}}};return b}(D),ea=function(){function a(b,c,d){void 0===d&&(d=2);this.level=c;this.numScrollsPerTurn=d;b="assets/"+("level/"+b+"/");this.imgSky=new E(b+"sky.png");this.imgCells=
[new E(b+"tile.png"),new E(b+"hole.png")]}a.prototype.generate=function(a,b){var c=0,d=0;a.eachUnit(function(a){0===a.team?++c:++d});for(var e=0===c?.3:.3*Ca(1.1,c-d),f=Array(3),g=Qa(Bb),k=0;3>k;++k){var h=void 0,l=0;12<b&&Za()<e?(h=g[Na(g.length)],h=Y.monster(h,a.getLevel()),h=new qb(h,1,{xH:b,yH:k})):6<b&&.1>Za()&&(l=1);f[k]=new Ma(l,h)}return f};a.prototype.draw=function(a,b,c){var d=this,e=c.field,f=this.imgSky.image;if(f){a.save();var g=128*e.depth/2;a.fillStyle=a.createPattern(f,"repeat");a.translate(-g,
0);a.fillRect(0+g,0,1280,80);a.restore()}var k={x:0,y:0,w:128,h:80};e.eachVisible(function(e,f,g){e=e.type;k.x=c.toX(f,g);k.y=c.toY(f,g);d.imgCells[e].draw(a,b,k)})};return a}();a.EndressStage=ea;ea=function(a){function b(c,d){function e(a,b,c){return new D(10+110*b,570,100,140,{draw:function(a,b,d){var e=c.ch,f=Ra(e,d.w,d.h,!0);f.x=d.x+(d.w-f.w)/2;f.y=d.y+(d.h-f.h)/2;c.alive||c.canRevive?e.draw(a,b,f):(e=e.images,(e[Ga.DEAD]||e[Ga.DEFAULT]).draw(a,b,f));g(a,d.x+10,d.y+128,80,6,c.HP,c.maxHP,void 0,
fb)}},function(){if(c.alive)m.click(c.hex);else if(c.canRevive){for(var d=l.minXH,e=b%3,f=0;3>f;++f){if(l.get(d,e).empty){a.revive(c,{xH:d,yH:e});return}e=(e+1)%3}F.error(k("Combat","NoSpaceToRevive"))}else F.error(k("Combat","CannotRevive"))},[n.$1+b])}function f(a,b,c,d,e){b=new D(1280-150*b,570,140,140,new B(c),d);e&&ta(b,"enabled",e);b.attach(a);return b}var h=this;a.call(this);this.data=c;this.stage=d;this.team=0;this.enabled=!1;var l=this.field=new Xa(0,Ma.DUMMY);this.dying=[];this.deads=[];
this.snapshots=[];var m=new cb;m.attach(this);m.visible=!1;var v=new db;v.attach(this);v.visible=!1;for(var C=l.minVisibleXH,v=l.maxVisibleXH;C<v;++C)l.setLine(C,this.stage.generate(this,C));for(var Z=[],qa=[[2,0],[2,1],[2,2],[1,0],[1,1],[1,2]],q=c.party,v=0;6>v;++v){var Ka=q[v];if(Ka){var p=qa[v],C=p[0],C={xH:C,yH:p[1]},p=new qb(Ka,0,C);p.state=new Ea(Ka.DEX);l.rawget(C).unit=p;Z.push(e(this,v,p))}}var A=new P(Z);ta(A,"visible",function(){return m.visible&&!h.focus});A.attach(this);f(A,1,k("Combat",
"End"),function(){return h.endTurn()});f(A,2,k("Combat","Undo"),function(){return m.undo()},function(){return m.canUndo});f(A,3,k("Combat","Retire"),function(){return h.retire()});var r=f(A,4,k("Combat","View")),v=new da;v.onDraw=function(a,b){return h.drawUnits(a,b,h.focusTime)};v.attach(this);v=new da;v.onDraw=function(a,b){return h.drawBarsOnView(a,b)};ta(v,"visible",function(){return A.visible&&(r.hover||r.pressed)});v.attach(this);v=new P;ta(v,"visible",function(){return!!h.focus});v.attach(this);
Z=new da;Z.onDraw=function(a,b){return h.drawBarsOnFocus(a,b,h.focus,h.controller.caret)};Z.attach(v);var u=new na(0,560,1280,160);u.onDraw=function(a,b){return h.drawPanel(a,b,u,h.focus)};u.attach(v);Z=new P;ta(Z,"visible",function(){return m.visible&&!!h.focus});Z.attach(this);for(v=0;10>v;++v)(new bb(this,v,400+170*x(v/2),570+v%2*75,160,65)).attach(Z);var w=function(){var a=h.focus;if(a&&h.enabled){var a=h.mapFor(a),b=h.controller.caret;if(b&&(a=a.get(b).effect))return a.target}},z=new na(640,
560,640,160);ta(z,"visible",function(){return!!w()});z.onDraw=function(a,b){return h.drawPanel(a,b,z,w())};z.attach(this);if(v=System.canvas.getContext("2d"))(new K(0,0,128,560,new kb({fillStyle:ib(v,0,0,128,0,aa,O)}))).attach(this),(new K(1152,0,1280,560,new kb({fillStyle:ib(v,1152,0,1280,0,O,aa)}))).attach(this);jb(this);this.startTurn()}w(b,a);Object.defineProperty(b.prototype,"controller",{get:function(){return this.children[this.team]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"numScrollsPerTurn",{get:function(){return this.stage.numScrollsPerTurn},enumerable:!0,configurable:!0});b.prototype.getLevel=function(a){var b=this.stage;a=b.level;b=b.numScrollsPerTurn;0<b&&(a+=this.field.depth/b*.1);return a};Object.defineProperty(b.prototype,"focus",{get:function(){return this._focus},set:function(a){a?this._focus!==a&&(this._focus=a,this.focusTime=performance.now()):this.focusTime=this._focus=void 0},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"zoc",{get:function(){var a=
this._zoc;if(!a){var a=this.field.depth,b=[new Xa(a,0),new Xa(a,0)];this.eachUnit(function(a){var c=a.ZoC;if(0<c){var d=b[0===a.team?1:0];d.surround(a.hex,1,function(a){return d.set(d.get(a)+c,a)})}});this._zoc=a=b}return a},enumerable:!0,configurable:!0});b.prototype.mapFor=function(a){var b=this.maps;b||(this.maps=b=new Xa(this.field.depth,void 0));var c=a.hex,d=b.rawget(c);d||(d=new Pa(this,a,a.SP),b.set(d,c));return d};b.prototype.onSkillChanged=function(a){var b=a.hex,c=this.maps,d=this.snapshots;
c&&c.set(void 0,b);if(d)for(b=0;b<d.length;b++)c=d[b],c.unit===a&&c.maps.set(void 0,c.hex)};b.prototype.savepoint=function(a){this.snapshots.push({unit:a,hex:a.hex,SP:a.SP,maps:this.maps,zoc:this.zoc})};b.prototype.rollback=function(){var a=this.snapshots.pop(),b=a.unit;this.setUnit(b,a.hex);b.SP=a.SP;this._zoc=a.zoc;this.maps=a.maps;this.focus=b};b.prototype.setUnit=function(a,b){var c=this.field,d=c.rawget(b),e=d.unit;if(a){if(e===a)return;if(e=a._hex)c.rawget(e).unit=void 0;a._hex=b}else e&&(e._hex=
void 0);d.unit=a;this.invalidate()};b.prototype.revive=function(a,b){var c=this.deads,d=c.indexOf(a);c.splice(d,1);a.SP=a.availSP;a.state=new Ea(a.DEX);this.setUnit(a,b);this.snapshots.length=0};b.prototype.invalidate=function(){this.maps=this._zoc=void 0};b.prototype.startTurn=function(){for(var a=this,b=this.team,c=0,d=this.deads;c<d.length;c++){var e=d[c];e.team===b&&e.recuperate()}var f;this.eachUnit(function(b){(b=b.onTurnStart(a))&&(f?f.push(b):f=[b])});b=function(){a.enabled=!0;a.controller.visible=
!0};f?va(f).then(b):b()};b.prototype.retire=function(){var a=this;Ua.confirm(this,k("Combat","ConfirmRetire"),{label:k("Combat","Retire"),click:function(){a.controller.visible=!1;Q.go(a,new Ia.Home(a.data))},mnemonic:nb},{label:k("Config","Cancel"),mnemonic:ob})};b.prototype.endTurn=function(){var a=this;this.enabled=!1;this.snapshots.length=0;this.controller.visible=!1;this.eachUnit(function(b){b.onTurnEnd(a)});if(0===this.team){var b=this.numScrollsPerTurn;if(0<b){var c=this.field.minXH+b;this.eachUnit(function(b){b.hex.xH<
c&&(b.state=new Ha(b,b.HP),a.kill(b))});var d=this.field.depth;(new H(400*b,function(c){a.scrollTo(d+b*c)})).attach(this);if(this.isGameOver)return}}this.team=0===this.team?1:0;var e=Wa[this.team],f=e.innerStyle,g=e.outerStyle,h=e.textStyle,l=k("Combat",e.messageID);(new H(800,function(a,b){b.save();b.globalAlpha=U(V*a);ab(b,0,0,1280,560,f,g);za(b,l.localized,640,280,h);b.restore()})).then(function(){a.startTurn()}).attach(this)};b.prototype.dose=function(a,b){var c=this;ca(a.SP>=a.costOf(b));this.focus=
a;this.enabled=!1;this.snapshots.length=0;this.invalidate();return a.shoot(this,a,b).then(function(){c.enabled=!0;a.done(c)&&(c.focus=void 0)})};b.prototype.move=function(a,b){var c=this;ca(!e(b,a.hex));var d=function(){c.enabled=!0;a.done(c)&&(c.focus=void 0)};this.focus=a;var f=this.field,g=a.skill,h=this.mapFor(a),k=h.get(b);if(k.effect){ca(a.SP>=a.costOf(g));this.enabled=!1;var l=k.effect.target;ca(a.isTarget(l,g));var m=function(){c.snapshots.length=0;c.invalidate();return a.shoot(c,l,g).then(d)};
if(e(k.shotFrom,a.hex))return m();f=h.getPath(b,f);k=f[f.length-1];ca(!e(k,b));ca(!e(k,a.hex));this.setUnit(a,k);a.SP=h.get(k).SP;h=a.state=new La(f);m=hb(m);h.then(m);return m}ca(0<=k.SP&&f.get(b).empty);f=h.getPath(b,f);this.setUnit(a,b);a.SP=k.SP;h=a.state=new La(f);d();return p.wait.WALK?h:z};b.prototype.findUnit=function(a,b,c){var d=this.field,e=d.minXH,f=d.maxXH,g=(0===this.team?b:!b)?1:-1;b=b?1:-1;var h,k;a?(h=a.xH,k=a.yH,a):(h=0>g?e:f-1,k=0>b?0:2);a=1;for(var l=3*(f-e+1);a<l;++a){k+=b;if(0>
k||3<=k)k=0>k?2:0,h+=g,h<e?h=f-1:f<=h&&(h=e);var m=d.get(h,k).unit;if(m&&c(m))return m}};b.prototype.kill=function(a){var b=this;a.alive&&(a.HP=0,this.setUnit(void 0,a.hex),this.dying.push(a));0===a.team&&(this.deads.push(a),this.parent&&this.isGameOver&&(this.controller.visible=!1,(a.state||z).then(function(){Ua.confirm(b,k("Combat","GameOver"),{label:k("Combat","Retire"),click:function(){return Q.go(b,new Ia.Home(b.data))},mnemonic:sb})})))};Object.defineProperty(b.prototype,"isGameOver",{get:function(){return!this.findUnit(void 0,
!0,function(a){return 0===a.team})},enumerable:!0,configurable:!0});b.prototype.promiseEffect=function(a,b){var c=this,d=a.target,e=a.eot,f=+a.deltaHP,g=+a.deltaSP,k=0>f||!f&&0>g,l=this.toX(b)+64,n=this.toY(b)+80,qa=h(f,g,e),q=k?Ta:Va,A=new H(600,function(a,b){b.save();b.font=ua(48);var c=b.measureText(qa).width;b.restore();c=48/T(1,.7*c/128);za(b,qa,l,n-40*a,{fontSize:c,fillStyle:q,strokeStyle:"black",globalAlpha:U(V*a),lineWidth:4,textAlign:"center",textBaseline:"bottom"})}),p=A.attach;A.attach=
function(a){0>f&&(d.state=new Ha(d,-f));f&&(d.HP=fa(0,d.maxHP,d.HP+f));g&&(d.SP=fa(0,d.maxSP,d.SP+g));0>=d.HP?c.kill(d):e&&d.effectsOverTime.push(e);return p.call(A,a)};return A};b.prototype.eachUnit=function(a){this.field.eachVisible(function(b){(b=b.unit)&&a(b)})};b.prototype.toX=function(a,b){var c;null==b?(d=a,c=d.xH,d):c=a;return 0+64*(c-1-this.field.depth);var d};b.prototype.toY=function(a,b){var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;return 80+80*(2*b+c%2);var d};b.prototype.toHex=function(a,
b){var c=this.field,d=a-0+128*c.depth/2,e=x((b-0-80)/80);if(0<=e&&6>e&&(d=0===e%2?2*x((d+64)/128):2*x(d/128)+1,c.minXH<=d&&d<c.maxXH))return c=x(e/2),{xH:d,yH:c}};b.prototype.scrollTo=function(a){var b=this.field;if(a>b.depth){var c=b.minVisibleXH,d=b.maxVisibleXH;b.depth=a;a=b.minVisibleXH;for(var e=b.maxVisibleXH;c<a;++c)b.deleteLine(c);for(c=T(a,d);c<e;++c)b.setLine(c,this.stage.generate(this,c))}};b.prototype.onDraw=function(b,c){this.stage.draw(b,c,this);var d=this.focus;d&&this.enabled&&this.drawMarkers(b,
c,this.focusTime,this.mapFor(d),d);a.prototype.onDraw.call(this,b,c)};b.prototype.drawMarkers=function(a,b,c,d,e){var f=this,g=H.clamp(b,c,300);if(!(0>=g)){var k=e.costOf(e.skill);b=e.skill.hostile?pa:ra;var h=b.DASH_OR_RANGE,l=b.RANGE,m=b.TARGET;a.save();1>g&&(a.globalAlpha=g);d.eachVisible(function(b,c,d){var e=b.SP,y=b.shotFrom,n,W=0,L=0;b.effect?(n=m,W=32*(1-g),L=20*(1-g)):e>=k?n=ia:0<=e?n=y?h:ka:y&&(n=l);n&&(b=f.toX(c,d)-W,c=f.toY(c,d)-L,W=128+2*W,L=80+2*L,a.fillStyle=n.bkgnd,a.fillRect(b+5,
c+5,W-10,L-10),a.strokeStyle=n.outer,a.lineWidth=2,a.strokeRect(b+2,c+2,W-4,L-4),a.strokeStyle=n.inner,a.lineWidth=1,a.strokeRect(b+4,c+4,W-8,L-8))});a.restore()}};b.prototype.drawUnits=function(a,b,c){var d=this,e=this.focus,f=this.enabled?this.zoc:void 0,g=[];this.eachUnit(function(a){var c=a.getXY(d,b);c.unit=a;g.push(c)});for(var h=0;h<this.dying.length;){var l=this.dying[h],m=l.getXY(this,b);m?(m.unit=l,g.push(m),++h):this.dying.splice(h,1)}g.sort(qb.compare);h=k("Combat","Done").localized;c=
(1-ma(2*V*H.cycle(b,c,1E3)))/2*.5;var m="blue",n;e&&(e.skill.hostile&&(m="red"),this.enabled&&(n=this.mapFor(e)));for(var q=0;q<g.length;q++){var A=g[q],l=A.unit,p=A.x,A=A.y,r=void 0;n&&(e===l?r="yellow":l.alive&&n.get(l.hex).effect&&(r=m));l.draw(a,b,p,A,r,c);if(!l.state&&f&&l.alive){var r=l.SP,Db=l.step,u=l.team;r<l.minCost&&(r<Db?za(a,h,p,A,Ja):r<Db+f[u].get(l.hex)&&za(a,h,p,A,Oa))}}};b.prototype.drawBarsOnView=function(a,b){var c=this;this.eachUnit(function(d){return d.drawBars(a,b,c)})};b.prototype.drawBarsOnFocus=
function(a,b,c,d){var f=this;if(c&&this.enabled){var g=this.mapFor(c);g.each(function(c){(c=c.effect)&&c.target.drawBars(a,b,f,c.deltaHP,c.deltaSP)});if(d){var h=g.get(d);h.effect?(d=h.shotFrom,h=c.costOf(c.skill),e(d,c.hex)?c.drawBars(a,b,this,void 0,-h):(G(a,b,this,c,c.hex),I(a,b,this,c,d,g.get(d).SP-h))):0<h.SP&&this.field.get(d).empty?(G(a,b,this,c,c.hex),I(a,b,this,c,d,h.SP)):c.drawBars(a,b,this)}else c.drawBars(a,b,this)}};b.prototype.drawPanel=function(a,b,c,e){ya(a,c,M[e.team]);var f=e.ch,
g=Ra(f,128,128);g.x=c.x+10+(128-g.w)/2;g.y=c.y+(c.h-g.h)/2;f.draw(a,b,g);b=e.name+" / Lv: ";f=e.level;f=null!=f?f.toFixed(1):"-";za(a,b+f+"\n"+("HP: "+e.HP+" / SP: "+e.SP),c.x+148,c.y+10,xa);e=e.effectsOverTime;b=0;for(f=e.length;b<f;++b){var h=e[b],g="["+h.turns+"] ";h.deltaHPoT?g+="HP: "+d(h.deltaHPoT):h.deltaSPoT?g+="SP: "+d(h.deltaSPoT):h.mods?(h=h.mods[0],g+=k("Character",h.type)+" "+Ba(h.tags)+" "+d(h.level)):g+="?";h=xa.fontSize;za(a,g,c.x+148,c.y+10+1.2*(h&&h.fontSize||24)*(b+2),xa)}};return b}(P);
a.Scene=ea;var cb=function(a){function c(){a.apply(this,arguments);this.mode=0}w(c,a);Object.defineProperty(c.prototype,"caret",{get:function(){return this._caret},set:function(a){this._caret=a;if(0===this.mode){var b=this.parent;b.focus=a?b.field.get(a).unit:void 0}},enumerable:!0,configurable:!0});c.prototype.finish=function(a){var b=this,c=this.parent,d=function(){c.focus||(b.mode=0)};c.enabled?d():a.then(d)};c.prototype.dose=function(a,b){var c=this.parent;this.mode=1;this.finish(c.dose(a,b))};
Object.defineProperty(c.prototype,"canUndo",{get:function(){return 0<this.parent.snapshots.length||1<=this.mode},enumerable:!0,configurable:!0});c.prototype.undo=function(){var a=this.parent,b=a.snapshots,c=b.length,b=0<c?b[c-1].unit:void 0;1<=this.mode&&b!==a.focus?this.mode=0:b?a.rollback():F.error(k("Combat","CannotUndo"));this.caret=this._caret};c.prototype.onHover=function(a,b){this.caret=this.parent.toHex(a,b)};c.prototype.onDrag=function(a,b){this.caret=this.parent.toHex(a,b)};c.prototype.downCaret=
function(a){if(this.caret=a){var b=this.parent,c=this.mode,d=b.focus;if(d){if(d.team===b.team&&!d.done(b)){1===c&&e(a,d.hex)?this.mode=3:this.mode=2;return}}else if(a=b.field.get(a).unit,b.focus=a){this.mode=2;return}this.mode=0}};c.prototype.onDown=function(a,b){this.downCaret(this.parent.toHex(a,b))};c.prototype.upCaret=function(a){if(this.caret=a){var b=this.parent,c=this.mode;if(b.enabled&&!(2>c)){var d=b.focus;if(d&&b.team===d.team)if(e(a,d.hex))this.mode=2===c?1:0;else{c=b.mapFor(d).get(a);
if(!c.effect)if(0<=c.SP&&b.field.get(a).empty)b.savepoint(d);else{b.focus=void 0;this.mode=0;return}this.mode=1;this.finish(b.move(d,a))}else this.mode=0}}};c.prototype.onUp=function(a,b){this.upCaret(this.parent.toHex(a,b))};c.prototype.onPress=function(a){function c(a){var d=this.parent.field,e=this.caret;e?(a=b(e,a),d.contains(a)&&(this.caret=a)):this.caret={xH:d.minXH,yH:0}}function d(a){var b=this.parent,c=this.caret,e=b.team,f=b.focus;(a=b.findUnit(f?f.hex:c,a,function(a){return a.team===e&&
!a.done(b)}))?(b.focus=a,c||(this.caret=a.hex),0===this.mode&&(this.mode=1)):F.error(k("Combat","UnitNotAvailable"))}switch(a){case n.BACKSPACE:case n.TAB:case n.DELETE:case n.Q:this.undo();break;case n.PAGE_DOWN:case n.C:d.call(this,!0);break;case n.PAGE_UP:d.call(this,!1);break;case n.SPACE:case n.ENTER:this.click(this.caret);break;case n.E:c.call(this,0);break;case n.RIGHT:case n.D:c.call(this,1);break;case n.DOWN:case n.X:case n.S:c.call(this,2);break;case n.Z:c.call(this,3);break;case n.LEFT:case n.A:c.call(this,
4);break;case n.UP:case n.W:c.call(this,5)}};c.prototype.click=function(a){a&&this.parent.field.contains(a)&&(this.downCaret(a),this.upCaret(a))};c.prototype.onDraw=function(a,b){function c(a,b,d,e,f){b=d.toX(e)+6.5;d=d.toY(e)+6.5;a.save();a.lineCap="round";a.lineJoin="round";a.beginPath();a.moveTo(b+32,d);a.lineTo(b,d);a.lineTo(b,d+20);a.moveTo(b+115-32,d);a.lineTo(b+115,d);a.lineTo(b+115,d+20);a.moveTo(b+115-32,d+67);a.lineTo(b+115,d+67);a.lineTo(b+115,d+67-20);a.moveTo(b+32,d+67);a.lineTo(b,d+
67);a.lineTo(b,d+67-20);a.lineWidth=7;a.strokeStyle=f.outer;a.stroke();a.lineWidth=3;a.strokeStyle=f.inner;a.stroke();a.restore()}function d(a,b,c){a.save();a.lineCap="butt";a.lineJoin="round";var e=c[c.length-2],f=c[c.length-1],g=b.toX(e)+64,h=b.toY(e)+40,e=b.toX(f)+64,f=b.toY(f)+40,g=vb(f-h,e-g);a.beginPath();a.moveTo(e+20*ma(g),f+20*U(g));a.lineTo(e+20*ma(g+2*V/3),f+20*U(g+2*V/3));a.lineTo(e+20*ma(g-2*V/3),f+20*U(g-2*V/3));a.fillStyle=sa;a.fill();a.beginPath();a.moveTo(e-10*ma(g),f-10*U(g));for(g=
c.length-2;0<=g;--g)e=c[g],a.lineTo(b.toX(e)+64,b.toY(e)+40);a.strokeStyle=sa;a.lineWidth=12;a.stroke();a.restore()}var e=this.caret;if(e){var f=this.parent,g=f.focus,h=f.field;if(0===this.mode)c(a,b,f,e,ja);else if(g&&f.enabled){var k=f.mapFor(g),l=k.getPath(e,h);l&&2<=l.length&&d(a,f,l);k=k.get(e);if(k.effect)switch(l=g.skill,l.usage){case "single-hostile":c(a,b,f,e,Da);break;case "single-friendly":c(a,b,f,e,oa);break;case "straight-hostile":h.straight(k.shotFrom,e,g.rangeOf(l),function(d){return c(a,
b,f,d,Da)});break;case "straight-friendly":h.straight(k.shotFrom,e,g.rangeOf(l),function(d){return c(a,b,f,d,oa)});break;case "surround-hostile":h.surround(k.shotFrom,g.rangeOf(l),function(d){return c(a,b,f,d,Da)});break;case "surround-friendly":h.surround(k.shotFrom,g.rangeOf(l),function(d){return c(a,b,f,d,oa)})}else 0<=k.SP?c(a,b,f,e,ga):c(a,b,f,e,ja)}}};return c}(da),db=function(a){function b(){a.apply(this,arguments);this.running=!1}w(b,a);Object.defineProperty(b.prototype,"visible",{get:function(){return this.running},
set:function(a){var b=this;(this.running=a)&&z.then(function(){return b.run([])})},enumerable:!0,configurable:!0});b.prototype.dose=function(a,b){throw Error("not implemented");};b.prototype.run=function(a){function b(a,c){var d=a.focus;if(d)return d;var e=a.team,d=c.length,d=0<d?a.findUnit(c[d-1].hex,!1,function(b){return b.team===e&&!b.done(a)&&0>c.indexOf(b)}):a.findUnit(void 0,!1,function(b){return b.team===e&&!b.done(a)});return a.focus=d}function c(a,b,f){var g=a.mapFor(b),h=d(a,b,g),k=h.hex;
if(!g.get(k).effect&&b.SP>=b.availSP){var l=new Pa(a,b,999),k=d(a,b,l,h).hex,h=l.get(k);h.effect&&(k=h.shotFrom);for(var h=a.field,m=k;m&&(0>g.get(m).SP||!h.get(m).empty);)m=l.get(m).comeFrom;k=m?m:b.hex}if(e(k,b.hex))f.push(b),a.focus=void 0;else return f.length=0,this.caret=k,f=p.wait.PICK,0<f?(g=hb(function(){return a.move(b,k)}),(new H(f)).then(g).attach(a),g):a.move(b,k)}function d(a,b,c,e){var g=a.field;a=a.numScrollsPerTurn;var h=g.minXH,k=g.maxXH,l=b.hex,m=b.maxSP,t=b.costOf(b.skill)||m,n=
h+a,q=e?e:{hex:l,score:f(b,l.xH,l.yH,h,k,n)+40*b.SP/m};c.each(function(a,d,e){var l=a.SP,p=a.effect;a=a.shotFrom;var r;if(p&&a){var l=r=f(b,a.xH,a.yH,h,k,n),A=p.target;r=1+b.level;p=p.deltaHP||0;p=0>p?-p:S(p,A.maxHP-A.HP);p=S(1,p/A.HP);r=l+1E3*r*p;l=c.get(a).SP-t}else if(0<=l&&g.get(d,e).empty)r=f(b,d,e,h,k,n);else return;r+=40*l/m;q.score<r&&(q.score=r,q.hex={xH:d,yH:e})});return q}function f(a,b,c,d,e,g){var h=0,h=1===a.team?h+10*(e-b):h+10*(b-d);a=2*c+b%2;h=3>a?h+10*a:h+10*(5-a);b<g&&(h*=.1);return h}
for(var g=this,h=this.parent,k;this.running;){h.enabled||(k=z);if(k){k.then(function(){return g.run(a)});break}this.caret=void 0;k=b(h,a);if(!k){h.endTurn();break}k=c.call(this,h,k,a)}};return b}(da),eb={Charge:u,Knockback:function(a,b,c,d){var e=b.hex,f=c.hex,g=R(a.field,e,f);if(!g)return u(a,b,c,d);d=b.estimate(a,c,d);var h=a.promiseEffect(d,g),e=new Fa(a,e,f),k=new La([f,g]);b.state=e;e.hit(function(){a.setUnit(c,g);c.state=k});k.then(function(){return h.attach(a)});return p.wait.POPUP?va([h,e]):
e},GoBehind:function(a,b,c,d){var e=b.hex,f=c.hex,g=R(a.field,e,f);if(!g)return u(a,b,c,d);c=b.estimate(a,c,d);var h=a.promiseEffect(c,f),e=new La([e,f]);a.setUnit(b,g);b.state=e;e.then(function(){return h.attach(a)});return p.wait.POPUP?h:e},Trample:function(a,b,c,d){var e=b.hex,f=c.hex,g=R(a.field,e,f);if(!g)return u(a,b,c,d);d=b.estimate(a,c,d);var h=a.promiseEffect(d,g),e=new La([e,f]);d=new La([f,f,g]);a.setUnit(c,g);c.state=d;a.setUnit(b,f);b.state=e;d.then(function(){return h.attach(a)});return p.wait.POPUP?
h:d},Shoot:function(a,b,c,d){var e=b.hex,f=c.hex;b=b.estimate(a,c,d);var g=a.promiseEffect(b,f);d=J(a,e,f,d);d.then(function(){return g.attach(a)});return p.wait.POPUP?g:d},Drain:function(a,b,c,d){var e=c.hex,f=b.hex,g=b.estimate(a,c,d);c=a.promiseEffect(g,e);var h=a.promiseEffect({target:b,deltaHP:-g.deltaHP},f);b=J(a,e,f,d);b.then(function(){return h.attach(a)});c.attach(a);return p.wait.POPUP?h:b},Explode:function(a,b,c,d){var e=c.hex;c=J(a,b.hex,e,d);var f=hb(function(){return q(a,b,d,e,1,function(a,
b){return x(a/(1+b))})});c.then(f);return f},Laser:function(a,b,c,d){var e=a.field,f=b.rangeOf(d),g=b.hex,h,k=[];e.straight(g,c.hex,f,function(c){var f=b.getTarget(e,c);f&&(f=b.estimate(a,f,d),f=a.promiseEffect(f,c),f.attach(a),k.push(f));h=c});var l=N(d);c=new H(400,function(b,c){var d=a.toX(g)+64,e=a.toY(g)+40,f=a.toX(h)+64,k=a.toY(h)+40,m=vb(k-e,f-d),n=64*ma(m),m=40*U(m);c.save();c.beginPath();c.moveTo(d+n,e+m);c.lineTo(f+n,k+m);c.lineCap="round";c.lineWidth=80*b/4;c.strokeStyle=Sa(l,1-b);c.stroke();
c.restore()});c.attach(a);return p.wait.POPUP?(k.push(c),va(k)):c},Nova:function(a,b,c,d){c=b.rangeOf(d);return q(a,b,d,b.hex,c)},Dose:function(a,b,c,d){b=b.estimate(a,c,d);c=a.promiseEffect(b,c.hex);c.attach(a);return p.wait.POPUP?c:z}}})(Ja||(Ja={}));var Va;p=new (function(){function a(){this._refineCanvas=this._magnifyCanvas=!1;this.volume=new zb(50,0,100);this.effects=new zb(Ea.length-1,0,Ea.length-1)}Object.defineProperty(a.prototype,"magnifyCanvas",{get:function(){return this._magnifyCanvas},
set:function(a){this._magnifyCanvas!==a&&(this._magnifyCanvas=a,window.dispatchEvent(new CustomEvent("resize")))},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"refineCanvas",{get:function(){return this._refineCanvas},set:function(a){this._refineCanvas!==a&&(this._refineCanvas=a,window.dispatchEvent(new CustomEvent("resize")))},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"wait",{get:function(){return Ea[this.effects.value]},enumerable:!0,configurable:!0});
return a}());System.main=function(a,b){var c=new Image;c.src="assets/dummy.png";E.DUMMY=c;var c=new P,e=new P;e.attach(c);var d=new Pb(10,10,1260,700,2E3,Mb);d.attach(c);F=d;Va=function(){for(;;){var a=e.children,b=a.length;if(0===b)break;a[b-1].detach()}(new xb(new Ha.Scene)).attach(e)};System.checkpoint=function(){ub()};Lb();Va();Hb(a,c,p)}})();
