(function(){function D(a,b,d){return d<a?a:d>b?b:d}function ga(a,b){return null!=a?a:b}function Aa(a){return p(Ka()*a)}function ha(a){return null==a?[]:a.map(function(a){return a?a.toJSON():null})}function X(a,b){return null==b?[]:b.map(function(d){return d?a.fromJSON(d):null})}function pa(a){return void 0===a?"(undefined)":null===a?"(null)":a.toString()}function qa(a){for(var b=[],d=1;d<arguments.length;d++)b[d-1]=arguments[d];return a.replace(/\$\{(\d+)\}/g,function(a,d){var g=parseInt(d,10);return pa(b[g])})}
function jb(a,b,d){return Object.defineProperty(a,b,{enumerable:!0,configurable:!0,writable:!0,value:d})}function ia(a,b,d,e){return Object.defineProperty(a,b,{enumerable:!0,configurable:!0,get:d,set:e})}function Bb(a,b){var d=document.createElement("script");d.src=a;d.onerror=b;document.head.appendChild(d)}function ra(a,b){if(a===b)return 0;if(void 0===a&&void 0!==b)return-1;if(void 0!==a&&void 0===b)return 1;if(null===a&&null!==b)return-1;if(null!==a&&null===b)return 1;var d=typeof a,e=typeof b;
if(d!==e)return d<e?-1:1;if("object"===d){if(a instanceof Date&&b instanceof Date)return ra(a.getTime(),b.getTime());if(a instanceof Array&&b instanceof Array){a:{for(var d=a.length,e=b.length,c=0,g=aa(d,e);c<g;++c){var f=ra(a[c],b[c]);if(0!==f){d=f;break a}}d=d<e?-1:d>e?1:0}return d}if(a.consructor===Object&&b.constructor===Object){a:{for(var d=Ba(a).sort(),e=Ba(b).sort(),c=d.length,g=e.length,f=aa(c,g),w=0;w<f;++w){var h=d[w],k=e[w];if(h<k||h>k){d=-1;break a}h=ra(a[h],b[k]);if(0!==h){d=h;break a}}d=
c<g?-1:c>g?1:0}return d}throw new TypeError("Cannot compare: ("+a+") and ("+b+")");}return a<b?-1:a>b?1:0}function sa(a,b){if(null==a)return b;if("function"===typeof a)return[a,b];a.push(b);return a}function ta(a){if(null!=a)if("function"===typeof a)P.then(a);else for(var b=0;b<a.length;b++)P.then(a[b])}function Wa(a){var b=function(){a().then(function(){ta(b.sig);b.sig=void 0})};b.then=function(a){this.sig=sa(this.sig,a);return this};return b}function h(){for(var a=[],b=0;b<arguments.length;b++)a[b-
0]=arguments[b];return new Q(a)}function Cb(a,b,d){function e(d){return(null==d.pageX?d.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-a.offsetLeft:d.pageX-a.offsetLeft)*w/a.offsetWidth}function c(d){return(null==d.pageY?d.clientY+document.body.scrollTop+document.documentElement.scrollTop-a.offsetTop:d.pageY-a.offsetTop)*h/a.offsetHeight}function g(){null!=L&&clearTimeout(L);L=setTimeout(function(){L=void 0;var b=a.parentElement,e=b.clientWidth,b=b.clientHeight,b=b-a.offsetTop;
0<b&&(d.magnifyCanvas||(e=aa(e,w),b=aa(b,h)),e*h>w*b?e=M(b*w/h):b=M(e*h/w),0<e&&0<b&&(a.style.width=e+"px",a.style.height=b+"px",!d.refineCanvas&&(e>w||b>h)&&(e=w,b=h),a.width!=e||a.width!=e))&&(a.width=e,a.height=b)},300)}function f(d){P.finish();var e=a.width,c=a.height,g=a.getContext("2d");g.clearRect(0,0,e,c);g.save();g.font="24px Arial";e===w&&c===h||g.scale(e/w,c/h);b.onDraw(g,d);g.restore();window.requestAnimationFrame(f)}var w=a.width,h=a.height,k=window.navigator.pointerEnabled,Xa=window.navigator.msPointerEnabled,
q=null!=document.ontouchstart,La=k?"pointerdown":Xa?"MSPointerDown":q?"touchstart":"mousedown",ba=k?"pointerup":Xa?"MSPointerUp":q?"touchend":"mouseup";a.addEventListener(k?"pointermove":Xa?"MSPointerMove":q?"touchmove":"mousemove",function(a){if(a.buttons&1)b.onDrag(e(a),c(a));else b.onHover(e(a),c(a));a.preventDefault()});a.addEventListener(La,function(a){switch(a.button){case 0:b.onDown(e(a),c(a))}a.preventDefault()});a.addEventListener(ba,function(a){switch(a.button){case 0:b.onUp(e(a),c(a));
break;case 2:b.onPress(l.TAB)}a.preventDefault()});a.addEventListener("contextmenu",function(a){a.preventDefault()});a.addEventListener("mousewheel",function(a){b.onPress(0<a.wheelDelta?l.PAGE_UP:l.PAGE_DOWN);a.preventDefault()});window.addEventListener("keydown",function(a){if(!a.ctrlKey&&!a.altKey){var d=ga(a.keyCode,a.charCode);d&&l[d]&&(b.onPress(d),a.preventDefault())}});var L;window.addEventListener("resize",g);"complete"===document.readyState?g():window.addEventListener("load",g);window.requestAnimationFrame(f)}
function Ma(a,b,d,e){void 0===e&&(e=!1);var c=a.w,g=a.h;return c>b||g>d||e?(a=c/b,e=g/d,a>e?(c=b,g/=a):(c/=e,g=d),{w:c,h:g}):a}function ja(a,b){if(b)for(var d in b)switch(d){case "fontSize":a.font=b.fontSize+"px "+(b.fontFamily||"Arial");break;case "fontFamily":null==b.fontSize&&(a.font="24px "+b.fontFamily);break;default:a[d]=b[d]}}function ua(a,b,d,e,c,g){var f;null==e?(g=b,b=g.x,f=g.y,e=g.w,c=g.h,g,g=d):f=d;0<e&&0<c&&(a.save(),ja(a,g),g&&!g.fillStyle||a.fillRect(b,f,e,c),g&&!g.strokeStyle||a.strokeRect(b,
f,e,c),a.restore())}function Na(a,b,d,e,c){function g(a,d,b,e,c){c&&!c.strokeStyle||a.strokeText(d,b,e);c&&!c.fillStyle||a.fillText(d,b,e)}a.save();ja(a,c);if(0>b.indexOf("\n"))g(a,b,d,e,c);else{var f=b.split("\n");b=c&&c.fontSize||24;switch(a.textBaseline){case "top":for(var h=0;h<f.length;h++){var v=f[h];g(a,v,d,e,c);e+=b}break;case "middle":e-=b*(f.length-1)/2;for(h=0;h<f.length;h++)v=f[h],g(a,v,d,e,c),e+=b;break;case "bottom":for(h=0,f=f.reverse();h<f.length;h++)v=f[h],g(a,v,d,e,c),e-=b}}a.restore()}
function ka(a,b,d,e,c,g,f){a.save();ja(a,f);switch(a.textAlign){case "center":d+=c/2;break;case "right":d+=c;break}if(0>b.indexOf("\n")){switch(a.textBaseline){case "middle":e+=g/2;break;case "bottom":e+=g;break}f&&!f.strokeStyle||a.strokeText(b,d,e,c);f&&!f.fillStyle||a.fillText(b,d,e,c)}else{b=b.split("\n");var h=f&&f.fontSize||24;switch(a.textBaseline){case "middle":e+=(g-h*(b.length-1))/2;break;case "bottom":e=e+g-h*(b.length-1);break}for(g=0;g<b.length;g++){var v=a,k=b[g],l=d,q=e,La=c,ba=f;ba&&
!ba.strokeStyle||v.strokeText(k,l,q,La);ba&&!ba.fillStyle||v.fillText(k,l,q,La);e+=h}}a.restore()}function va(a,b,d,e,c,g,f){if(0<e&&0<c){a.save();var h=a.createLinearGradient(b,d,b,d+c);h.addColorStop(0,g);h.addColorStop(1,f);a.fillStyle=h;a.fillRect(b,d,e,c);a.restore()}}function Oa(a,b,d,e,c,g,f,h){void 0===h&&(h=0);0<e&&0<c&&(a.save(),a.translate(b+e/2,d+c/2),a.scale(e,c),b=a.createRadialGradient(0,0,h/2,0,0,.5),b.addColorStop(0,g),b.addColorStop(1,f),a.fillStyle=b,a.fillRect(-.5,-.5,1,1),a.restore())}
function x(a,b,d){return"rgb("+a+","+b+","+d+")"}function y(a,b,d,e){return"rgba("+a+","+b+","+d+","+e.toFixed(6).replace(/([0-9]+(\.[0-9]+[1-9])?)(\.?0+$)/,"$1")+")"}function wa(a){null==Ca&&(Ca=[h("Tag","Melee"),h("Tag","Throw"),h("Tag","Shoot"),h("Tag","Shield"),h("Tag","Head"),h("Tag","Body"),h("Tag","Arms"),h("Tag","Legs"),h("Tag","Slash"),h("Tag","Blunt"),h("Tag","Pierce"),h("Tag","Magic"),h("Tag","Alchemy")]);return a.map(function(a){return Ca[a].localized}).join(", ")}function xa(a){for(var b=
0,d=0;d<a.length;d++)b|=1<<a[d];return b}function mb(a,b){0>a.indexOf("/")&&(a="assets/char/"+a);return a.endsWith(".png")?new R(a):new Db(a,b)}function Ya(a){var b={fillStyle:k.WHITE.rgba,strokeStyle:k.BLACK.rgba,fontSize:44,textAlign:"center",textBaseline:"middle"},d={textAlign:"right",textBaseline:"middle"},e={textAlign:"right",textBaseline:"middle"},c=new K(4,4,32,32,new R("assets/config.png"),function(){function c(a,b){var e=100+70*a;(new F(640,e,160,60,new B(b,d))).attach(v);return e}function f(a,
d,b){a=c(a,d);d=new Eb(810,a+15,300,30,b);d.attach(v);(new F(1120,a,50,60,new B(b,e))).attach(v);return d}function w(a,d,b,e,f,h){a=c(a,d);var w=new K(810,a+0,100,60,new B(function(){var a=f();w.pressed&&w.hover&&(a=!a);return(a?b:e).localized}),h);w.attach(v);return w}var v=new Da;(new F(0,0,1280,720,new Za(nb))).attach(v);(new F(0,20,1280,80,new B(h("Config","Caption"),b))).attach(v);(new K(480,495,320,90,new B(h("Config","OK")),function(){v.detach()},ob)).attach(v);var k=Ba(Q.languages).sort().map(function(a){return h("Language",
a)}),l=new E(10,10,160,E.heightOf(aa(10,k.length)),[{name:h("Config","LanguageID"),extract:function(a){return a.src[1]},width:40,align:"center"},{name:h("Config","LanguageName"),extract:function(a){return a.localized}}],k,function(a){l.selected=a;Q.language=a.src[1]});l.selected=l.rows.find(function(a){return a.src[1]===Q.language});l.attach(v);f(0,h("Config","Volume"),m.volume);f(1,h("Config","CPUEffects"),m.effects);var k=h("Config","On"),q=h("Config","Off");w(2,h("Config","FullScreen"),k,q,function(){return System.getFullScreen()},
function(){System.setFullScreenn(!System.getFullScreen())});w(3,h("Config","MagnifyCanvas"),k,q,function(){return m.magnifyCanvas},function(){m.magnifyCanvas=!m.magnifyCanvas});w(4,h("Config","RefineCanvas"),k,q,function(){return m.refineCanvas},function(){m.refineCanvas=!m.refineCanvas});(function(a,d,b){a=new K(810,70*a+100,300,60,new B(d),b);a.attach(v);return a})(5,h("Config","BackToTitle"),function(){v.detach();Ea()});v.attach(a)},Fb,new K.IconDesign("white"));c.attach(a);return c}function pb(){try{var a=
System.getRoamingStorage("NYO");if(!a)return null;var b=qb(a);return{shop:b.shop,warehouse:X(la,b.warehouse),reservers:X(Y,b.reservers),party:X(Y,b.party),gold:b.gold}}catch(d){return G.error(d),null}}function rb(a){try{System.setRoamingStorage("NYO",sb(a))}catch(b){G.error(b)}tb()}function Gb(){try{var a=System.getLocalStorage("NYO");if(a){var b=qb(a);b&&(typeof b.language===typeof Q.language&&(Q.language=b.language),typeof b.magnifyCanvas===typeof m.magnifyCanvas&&(m.magnifyCanvas=b.magnifyCanvas),
typeof b.refineCanvas===typeof m.refineCanvas&&(m.refineCanvas=b.refineCanvas),typeof b.volume===typeof m.volume.value&&(m.volume.value=b.volume),typeof b.effects===typeof m.effects.value&&(m.effects.value=b.effects))}}catch(d){G.error(d)}}function tb(){try{System.setLocalStorage("NYO",sb({language:Q.language,magnifyCanvas:m.magnifyCanvas,refineCanvas:m.refineCanvas,volume:m.volume.value,effects:m.effects.value}))}catch(a){G.error(a)}}var n=this&&this.__extends||function(a,b){function d(){this.constructor=
a}for(var e in b)b.hasOwnProperty(e)&&(a[e]=b[e]);a.prototype=null===b?Object.create(b):(d.prototype=b.prototype,new d)},Ba=Object.keys,$a=Math.abs,aa=Math.min,T=Math.max,p=Math.floor,ab=Math.ceil,M=Math.round,Qa=Math.pow,V=Math.sin,ma=Math.cos,ub=Math.atan2,W=Math.PI,Ka=Math.random,qb=JSON.parse,sb=JSON.stringify,Ra=function(){},P={sig:null,then:function(a){this.sig=sa(this.sig,a);return this},finish:function(){var a=this.sig;if(a)if(this.sig=null,"function"===typeof a)a();else for(var b=0;b<a.length;b++)(0,a[b])()}},
Sa=function(){function a(a){for(var d=this,e=a.length,c=0;c<a.length;c++)a[c].then(function(){0>=--e&&(ta(d.sig),d.sig=void 0)})}a.prototype.then=function(a){this.sig=sa(this.sig,a);return this};return a}(),Q=function(){function a(a){this.src=a}Object.defineProperty(a.prototype,"localized",{get:function(){function b(d){var b=a.languages,g=a.language,f=b[g];null==f&&(g=a.language=a.fallback,f=b[g]);if("string"===typeof f)return b[g]=!0,Bb(f,function(){b[g]=!1}),null;if(!0===f)return null;if(!1===f)return d.join(".");
for(var h=f,f=0,k=d.length;f<k;++f)if(h=h[d[f]],null==h)return d.join(".");return h.toString()}if(this._language!==a.language){var d=b(this.src);if(null===d)return this.src.join(".");this._language=a.language;this._localized=d}return this._localized},enumerable:!0,configurable:!0});a.prototype.toString=function(){return this.localized};a.language=(window.navigator.userLanguage||window.navigator.language||window.navigator.browserLanguage).substr(0,2);a.fallback="en";a.languages={};return a}();System.localize=
function(a,b){Q.languages[a]=b};var l;(function(a){a[a.TAB=9]="TAB";a[a.ENTER=13]="ENTER";a[a.ESCAPE=27]="ESCAPE";a[a.SPACE=32]="SPACE";a[a.PAGE_UP=33]="PAGE_UP";a[a.PAGE_DOWN=34]="PAGE_DOWN";a[a._END=35]="_END";a[a._HOME=36]="_HOME";a[a.LEFT=37]="LEFT";a[a.UP=38]="UP";a[a.RIGHT=39]="RIGHT";a[a.DOWN=40]="DOWN";a[a._INSERT=45]="_INSERT";a[a._DELETE=46]="_DELETE";a[a.$0=48]="$0";a[a.$1=49]="$1";a[a.$2=50]="$2";a[a.$3=51]="$3";a[a.$4=52]="$4";a[a.$5=53]="$5";a[a.$6=54]="$6";a[a.$7=55]="$7";a[a.$8=56]=
"$8";a[a.$9=57]="$9";a[a.A=65]="A";a[a.B=66]="B";a[a.C=67]="C";a[a.D=68]="D";a[a.E=69]="E";a[a.F=70]="F";a[a.G=71]="G";a[a.H=72]="H";a[a.I=73]="I";a[a.J=74]="J";a[a.K=75]="K";a[a.L=76]="L";a[a.M=77]="M";a[a.N=78]="N";a[a.O=79]="O";a[a.P=80]="P";a[a.Q=81]="Q";a[a.R=82]="R";a[a.S=83]="S";a[a.T=84]="T";a[a.U=85]="U";a[a.V=86]="V";a[a.W=87]="W";a[a.X=88]="X";a[a.Y=89]="Y";a[a.Z=90]="Z"})(l||(l={}));var ca=function(){function a(){this.parent=null}a.prototype.onHover=function(a,d){};a.prototype.onDrag=
function(a,d){};a.prototype.onDown=function(a,d){};a.prototype.onUp=function(a,d){};a.prototype.onPress=function(a){};a.prototype.onDraw=function(a,d){};a.prototype.attach=function(a){if(a)return a.onAttach(this);throw new RangeError("Cannot attach to null");};a.prototype.detach=function(){var a=this.parent;return a?(a.onDetach(this),a):null};Object.defineProperty(a.prototype,"visible",{get:function(){return!0},set:function(a){jb(this,"visible",a)},enumerable:!0,configurable:!0});return a}(),S=function(a){function b(d){a.call(this);
this.children=[];if(d)for(var b=0;b<d.length;b++)d[b].attach(this)}n(b,a);b.prototype.onAttach=function(a){if(null==a.parent)return this.children.push(a),a.parent=this,!0;if(a.parent===this)return!1;throw new RangeError("Cannot add Component with another parent");};b.prototype.onDetach=function(a){if(a.parent===this){a.parent=null;for(var b=this.children,c=0;c<b.length;++c)if(b[c]===a){a=this.children;b=a.length;if(0>c||b<=c)throw new RangeError("index is out of range");for(var g=Array(b-1),f=0;f<
c;++f)g[f]=a[f];for(f=c+1;f<b;++f)g[f-1]=a[f];this.children=g;break}return!0}if(null==a.parent)return!1;throw new RangeError("Cannot remove Component with another parent");};b.prototype.onHover=function(a,b){for(var c=0,g=this.children;c<g.length;c++){var f=g[c];if(f.visible)f.onHover(a,b)}};b.prototype.onDrag=function(a,b){for(var c=0,g=this.children;c<g.length;c++){var f=g[c];if(f.visible)f.onDrag(a,b)}};b.prototype.onDown=function(a,b){for(var c=0,g=this.children;c<g.length;c++){var f=g[c];if(f.visible)f.onDown(a,
b)}};b.prototype.onUp=function(a,b){for(var c=0,g=this.children;c<g.length;c++){var f=g[c];if(f.visible)f.onUp(a,b)}};b.prototype.onPress=function(a){for(var b=0,c=this.children;b<c.length;b++){var g=c[b];if(g.visible)g.onPress(a)}};b.prototype.onDraw=function(a,b){for(var c=0,g=this.children;c<g.length;c++){var f=g[c];if(f.visible)f.onDraw(a,b)}};return b}(ca),k=function(){function a(a,d,e,c){void 0===c&&(c=1);this.r=a;this.g=d;this.b=e;this.a=c}Object.defineProperty(a.prototype,"rgb",{get:function(){var a=
D(0,255,M(255*this.r)),d=D(0,255,M(255*this.g)),e=D(0,255,M(255*this.b));return x(a,d,e)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"rgba",{get:function(){var a=D(0,255,M(255*this.r)),d=D(0,255,M(255*this.g)),e=D(0,255,M(255*this.b)),c=D(0,1,this.a);return y(a,d,e,c)},enumerable:!0,configurable:!0});a.prototype.toString=function(){return this.rgba};a.BLACK=new a(0,0,0);a.WHITE=new a(1,1,1);a.GRAY=new a(.5,.5,.5);a.RED=new a(1,0,0);a.MAROON=new a(.5,0,0);a.FUCHSIA=new a(1,0,
1);a.PURPLE=new a(.5,0,.5);a.LIME=new a(0,1,0);a.GREEN=new a(0,.5,0);a.BLUE=new a(0,0,1);a.NAVY=new a(0,0,.5);a.AQUA=new a(0,1,1);a.TEAL=new a(0,.5,.5);a.OLIVE=new a(.5,.5,0);a.YELLOW=new a(1,1,0);return a}(),Za=function(){function a(a){this.rectStyle=a}a.prototype.draw=function(a,d,e){ua(a,e,this.rectStyle)};return a}(),B=function(){function a(a,d,e){this.value=a;this.textStyle=d;this.rectStyle=e;null==this.textStyle&&(this.textStyle={});null==this.textStyle.fillStyle&&(this.textStyle.fillStyle=
k.WHITE.rgba);null==this.textStyle.textAlign&&(this.textStyle.textAlign="center");null==this.textStyle.textBaseline&&(this.textStyle.textBaseline="middle")}a.prototype.draw=function(a,d,e){d=e.x;var c=e.y,g=e.w;e=e.h;this.rectStyle&&ua(a,d,c,g,e,this.rectStyle);ka(a,this.text,d,c,g,e,this.textStyle)};Object.defineProperty(a.prototype,"text",{get:function(){var a=this.value;"function"===typeof a&&(a=a());return pa(a)},enumerable:!0,configurable:!0});return a}(),R=function(){function a(a){this.src=
a;this._image=void 0}Object.defineProperty(a.prototype,"image",{get:function(){var b=this;if(void 0===this._image){this._image=null;var d=new Image;d.addEventListener("load",function(){b._image=d});d.addEventListener("error",function(){b._image=a.DUMMY});d.src=this.src}return this._image},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"w",{get:function(){var a=this.image;return a?a.width:1},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"h",{get:function(){var a=
this.image;return a?a.height:1},enumerable:!0,configurable:!0});a.prototype.draw=function(a,d,e,c,g){void 0===g&&(g=.5);d=this.image;var f=e.x,h=e.y,k=e.w;e=e.h;d&&0<k&&0<e&&(a.save(),null==c||0>=g?a.drawImage(d,f,h,k,e):(a.globalCompositeOperation="destination-out",a.drawImage(d,f,h,k,e),a.globalCompositeOperation="destination-over",a.fillStyle=c,a.fillRect(f,h,k,e),1>g&&(a.globalCompositeOperation="source-over",a.globalAlpha=1-g,a.drawImage(d,f,h,k,e))),a.restore())};a.prototype.createPattern=function(a,
d){var e=this.image;return e?a.createPattern(e,d):y(0,0,0,0)};a.DUMMY=null;return a}(),G,Hb={fontSize:32,fillStyle:"white",strokeStyle:"black",textAlign:"left",textBaseline:"top",lineWidth:2},nb={fillStyle:y(0,0,0,.8)},Ib={fillStyle:"white",strokeStyle:"black",fontSize:44,textAlign:"center",textBaseline:"middle"},I=function(a){function b(d,b){a.call(this);this.duration=d;b&&(this.onAnimation=b)}n(b,a);b.prototype.attach=function(d){return a.prototype.attach.call(this,d)?(this.start=performance.now(),
!0):!1};b.prototype.onDraw=function(a,b){if(null!=this.start)if(b>=this.start+this.duration)this.onAnimation(1,a,b),this.detach(),ta(this.sig),this.sig=void 0;else if(b>=this.start)this.onAnimation((b-this.start)/this.duration,a,b)};b.prototype.onAnimation=function(a,b,c){};b.prototype.then=function(a){this.sig=sa(this.sig,a);return this};b.clamp=function(a,b,c){return null==b||a<b?0:null==c||b+c<a?1:(a-b)/c};b.cycle=function(a,b,c){return null==b||null==c||a<b?0:(a-b)%c/c};return b}(ca),vb=function(a){function b(d,
b){void 0===b&&(b=400);a.call(this,b);this.next=d}n(b,a);b.prototype.onAnimation=function(a,b,c){if(1>a){if(0<a)this.next.onDraw(b,c);b.save();b.globalAlpha=1-a;b.fillStyle="black";b.fillRect(0,0,1280,720);b.restore()}else this.next.attach(this.parent)};return b}(I),da=function(a){function b(b,e,c){void 0===c&&(c=400);a.call(this,c);this.prev=b;this.next=e}n(b,a);b.prototype.attach=function(b){return a.prototype.attach.call(this,b)?(this.prev.detach(),!0):!1};b.prototype.onAnimation=function(a,b,
c){1>a?(this.prev.onDraw(b,c),0<a&&(b.save(),b.globalAlpha=a,b.fillStyle="black",b.fillRect(0,0,1280,720),b.restore())):this.next&&(new vb(this.next,this.duration)).attach(this.parent)};return b}(I),Da=function(a){function b(){a.apply(this,arguments)}n(b,a);b.prototype.attach=function(b){return null==this.prev&&null!=b.parent&&a.prototype.attach.call(this,b.parent)?(b.detach(),this.prev=b,!0):!1};b.prototype.detach=function(){var b=a.prototype.detach.call(this);b&&this.prev.attach(b);return b};b.prototype.onDraw=
function(b,e){this.prev.onDraw(b,e);a.prototype.onDraw.call(this,b,e)};b.confirm=function(a,e){for(var c=[],g=2;g<arguments.length;g++)c[g-2]=arguments[g];var f=new b;(new F(0,0,1280,720,new B(e,Ib,nb))).attach(f);for(var g=c.length,h=1280/(3+c.length),k=h/8,l=(1280-h*g-k*(g-1))/2,m=function(a){var b=c[a],d=b.click,e=b.mnemonic;(new K(l+(h+k)*a,495,h,90,new B(b.label),d?function(){f.detach();d()}:function(){f.detach()},e)).attach(f)},q=0;q<g;++q)m(q);f.attach(a);return f};return b}(S),na=function(a){function b(b,
e,c,g){a.call(this);this.x=b;this.y=e;this.w=c;this.h=g}n(b,a);b.prototype.contains=function(a,b){return this.visible&&this.x<=a&&this.y<=b&&a<this.x+this.w&&b<this.y+this.h};Object.defineProperty(b.prototype,"left",{get:function(){return this.x},set:function(a){this.w=this.w+this.x-a;this.x=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"right",{get:function(){return this.x+this.w},set:function(a){this.w=a-this.x},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"top",{get:function(){return this.y},set:function(a){this.h=this.h+this.y-a;this.y=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"bottom",{get:function(){return this.y+this.h},set:function(a){this.h=a-this.y},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"center",{get:function(){return{x:this.x+this.w/2,y:this.y+this.h/2}},enumerable:!0,configurable:!0});b.prototype.moveTo=function(a,b){this.x=a;this.y=b;return this};b.prototype.moveBy=function(a,b){this.x+=
a;this.y+=b;return this};return b}(ca),F=function(a){function b(b,e,c,g,f){a.call(this,b,e,c,g);this.drawable=f}n(b,a);b.prototype.onDraw=function(a,b){this.drawable.draw(a,b,this)};return b}(na),K=function(a){function b(d,e,c,g,f,h,k,l){void 0===l&&(l=b.defaultDesign);a.call(this,d,e,c,g);this.drawable=f;this.click=h;this.mnemonic=k;this.design=l;this._hover=this._pressed=!1}n(b,a);Object.defineProperty(b.prototype,"enabled",{get:function(){return!0},set:function(a){jb(this,"enabled",a)},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"pressed",{get:function(){return this._pressed},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hover",{get:function(){return this._hover},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"state",{get:function(){return this.enabled?this._hover?this._pressed?2:1:0:3},enumerable:!0,configurable:!0});b.prototype.onHover=function(a,b){this._hover=this.contains(a,b);this._pressed=!1};b.prototype.onDrag=function(a,b){this._hover=
this._pressed&&this.contains(a,b)};b.prototype.onDown=function(a,b){this._hover=this._pressed=this.enabled&&this.contains(a,b)};b.prototype.onUp=function(a,b){if(this._pressed&&(this._pressed=!1,this.contains(a,b)))this.onClick()};b.prototype.onPress=function(a){this.mnemonic&&0<=this.mnemonic.indexOf(a)&&this.enabled&&(this._pressed=!1,this.onClick())};b.prototype.onClick=function(){var a=this;P.then(function(){return a.click()})};b.prototype.onDraw=function(a,b){this.design.draw(a,b,this)};b.defaultDesign=
{draw:function(a,b,c){a.save();switch(c.state){case 0:a.fillStyle=y(0,0,0,.8);a.strokeStyle=x(200,200,200);break;case 1:a.fillStyle=y(0,0,50,.8);a.strokeStyle=x(100,100,200);break;case 2:a.fillStyle=y(0,0,150,.8);a.strokeStyle=x(100,100,255);break;case 3:a.fillStyle=y(200,200,200,.8),a.strokeStyle=x(200,200,200)}a.fillRect(c.x,c.y,c.w,c.h);a.strokeRect(c.x,c.y,c.w,c.h);a.restore();c.drawable&&c.drawable.draw(a,b,c)}};b.IconDesign=function(){function a(b){this.overlay=b}a.prototype.draw=function(a,
b,d){var f=d.drawable;switch(d.state){case 0:f.draw(a,b,d);break;case 1:f.draw(a,b,d,this.overlay,.7);break;case 2:f.draw(a,b,d,this.overlay,.9);break;case 3:f.draw(a,b,d,y(200,200,200,.8))}};return a}();return b}(na),wb=function(a){function b(b,e,c,g,f,h,k,l,m,q){void 0===q&&(q=K.defaultDesign);a.call(this,b,e,c,g,h,k,m,q);this.group=f;this.swap=l;f.push(this)}n(b,a);b.prototype.onDrag=function(b,e){var c=this;a.prototype.onDrag.call(this,b,e);if(this.dragged&&!this.swapping){var g=this.group.find(function(a){return a!==
c&&a.contains(b,e)&&!a.swapping});if(g){var f=performance.now();this.onSwap(g,f);g.onSwap(this,f);this.dragged={xOrig:this.swapping.xTo,yOrig:this.swapping.yTo};this.swap&&this.swap(g)}else null!=this.dragged.xDown?(this.x=this.dragged.xOrig-this.dragged.xDown+b,this.y=this.dragged.yOrig-this.dragged.yDown+e):(this.dragged.xDown=b,this.dragged.yDown=e)}};b.prototype.onDown=function(b,e){a.prototype.onDown.call(this,b,e);!this.dragged&&this.contains(b,e)&&(this.dragged={xDown:b,yDown:e,xOrig:this.x,
yOrig:this.y})};b.prototype.onUp=function(b,e){if(this.swapping)this.dragged=null,a.prototype.onUp.call(this,b,e);else if(this.dragged){var c=this.dragged,g=c.xOrig,c=c.yOrig;this.swapping={start:performance.now(),xFrom:this.x,yFrom:this.y,xTo:g,yTo:c};this.dragged=null;if(this._pressed&&(this._pressed=!1,this.contains(b,e)&&g<=b&&c<=e&&b<g+this.w&&e<c+this.h))this.onClick()}else a.prototype.onUp.call(this,b,e)};b.prototype.onSwap=function(a,b){this._pressed=!1;this.swapping={start:b,xFrom:this.x,
yFrom:this.y,xTo:a.dragged?a.dragged.xOrig:a.x,yTo:a.dragged?a.dragged.yOrig:a.y}};b.prototype.onDraw=function(b,e){if(this.swapping){var c=I.clamp(e,this.swapping.start,200);1>c?(c=(1-ma(W*c))/2,this.x=this.swapping.xFrom*(1-c)+this.swapping.xTo*c,this.y=this.swapping.yFrom*(1-c)+this.swapping.yTo*c):(this.x=this.swapping.xTo,this.y=this.swapping.yTo,this.swapping=null)}a.prototype.onDraw.call(this,b,e)};return b}(K),E=function(a){function b(d,e,c,g,f,h,k,l){void 0===l&&(l=b.defaultDesign);a.call(this,
d,e,c,g);this.columns=f;this.rows=h;this.click=k;this.design=l;this.topRow=0}n(b,a);b.heightOf=function(a,e){void 0===e&&(e=b.defaultDesign);return e.headerHeight+a*e.rowHeight};b.prototype.onHover=function(a,b){this.hover=this.toRowIndex(a,b);this.scrolling=this.dragged=null};b.prototype.onDrag=function(a,b){var c=this.design.headerHeight;null!=this.scrolling?this.scrollTo(p(this.rows.length*(b-(this.y+c)-this.scrolling)/(this.h-c))):(c=this.toRowIndex(a,b),null!=c&&null!=this.dragged&&c!==this.dragged&&
(g=[this.rows[c],this.rows[this.dragged]],this.rows[this.dragged]=g[0],this.rows[c]=g[1],this.dragged=c,this.sortkeys=this.scrolling=this.hover=null));var g};b.prototype.onDown=function(a,b){if(this.contains(a,b)&&(this.hover=this.dragged=this.toRowIndex(a,b),null==this.dragged)){var c=this.design,g=c.headerHeight,f=this.w-c.scrollBarWidth,c=this.y+g;if(this.x<=a&&a<this.x+f&&this.y<=b&&b<c)c=this.toColumnIndex(a,b),null!=c&&this.sort(c,null!=this.sortkeys&&this.sortkeys[0]===c+1);else if(this.x+
f<=a&&a<this.right){var f=this.rows.length,h=this.displayCount,g=this.h-g,k=c+g*this.topRow/f,l=g*h/f;c<=b&&b<k?(this.scrollTo(p(f*(b-c)/g)),k=c+g*this.topRow/f):k+l<=b&&b<this.bottom&&(this.scrollTo(p(f*(b-c)/g)-h+1),k=c+g*this.topRow/f);k<=b&&b<k+l&&(this.scrolling=b-k)}}};b.prototype.onUp=function(a,b){null==this.scrolling&&null!=this.dragged&&this.dragged===this.hover&&(this.click(this.rows[this.dragged],this.dragged),this.refresh());this.scrolling=this.dragged=null;this.hover=this.toRowIndex(a,
b)};b.prototype.onPress=function(a){switch(a){case l.PAGE_DOWN:this.scrollBy(this.scrollStep);break;case l.PAGE_UP:this.scrollBy(-this.scrollStep)}};b.prototype.onDraw=function(a,b){var c=this.design,g=c.headerHeight,f=c.scrollBarWidth,h=this.rows.length,k=this.displayCount,l=this.x,m=this.y+g,q=this.w-f,p=this.h-g,n=this.x+q,L=(0<h&&p*this.topRow/h||0)+m,N=0<h&&p*k/h||p,kb=this.defaultColumnWidth;c.drawHeader(a,this.x,this.y,this.w,g);c.drawBackground(a,this.x,m,q,p);0<f&&(c.drawHeader(a,n,m,f,p),
k<h&&c.drawScrollBar(a,n,L,f,N));a.save();a.font=c.rowFont;a.fillStyle=c.rowStyle;a.textBaseline="middle";for(var N=c.rowHeight,U=0;U<k;++U){var f=U+this.topRow,lb=this.rows[f],Pa=m+N*U;f===this.dragged?c.drawRowDragged(a,this.x,Pa,q,N):lb===this.selected?c.drawRowSelected(a,this.x,Pa,q,N):f===this.hover&&null==this.dragged&&c.drawRowHover(a,this.x,Pa,q,N);for(var bb=0,f=0,h=this.columns.length;f<h;++f){var n=this.columns[f],L=ga(n.width,kb),xb=this.extract(lb,n);if(null!=xb){var oa=l+bb+2,Fa=L-4;
a.textAlign=n.align||"left";switch(a.textAlign){case "center":oa+=Fa/2;break;case "right":oa+=Fa}a.fillText(xb,oa,Pa+N/2,Fa)}bb+=L}}a.restore();a.save();N=0;a.font=c.headerFont;a.fillStyle=c.headerStyle;a.textAlign="center";a.textBaseline="middle";a.strokeStyle=c.lineStyle;f=0;for(h=this.columns.length;f<h;++f)n=this.columns[f],L=ga(n.width,kb),U=l+N,0<f&&(a.beginPath(),a.moveTo(U,m),a.lineTo(U,this.bottom),a.stroke()),a.fillText(n.name.localized,U+L/2,this.y+g/2),N+=L;a.restore();0===k&&0<p&&c.emptyText&&
(a.save(),a.font=c.emptyFont,a.textAlign="center",a.textBaseline="middle",a.fillStyle=c.emptyStyle,a.fillText(c.emptyText.localized,this.x+q/2,m+p/2),a.restore())};Object.defineProperty(b.prototype,"displayCount",{get:function(){var a=this.design;return aa(p((this.h-a.headerHeight)/a.rowHeight),this.rows.length)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"scrollStep",{get:function(){return T(p(.2*this.displayCount),1)},enumerable:!0,configurable:!0});b.prototype.extract=function(a,
b){var c=b.extract;switch(typeof c){case "function":return c(a);case "number":return a[c];default:return a[c]}};b.prototype.compare=function(a,b){for(var c=0,g=0,f=this.sortkeys.length;0===c&&g<f;++g){var h=this.sortkeys[g],c=this.columns[(0<h?h:-h)-1],c=c.compare?c.compare(a,b):ra(this.extract(a,c),this.extract(b,c));0>h&&(c=-c)}return c};b.prototype.sort=function(a,b){var c=this;void 0===b&&(b=!1);var g=a+1;if(this.sortkeys){for(var f=0,h=this.sortkeys.length;f<h;++f)if(this.sortkeys[f]===g||this.sortkeys[f]===
-g){this.sortkeys.splice(f,1);break}this.sortkeys.unshift(b?-g:g)}else this.sortkeys=[b?-g:g];this.rows.sort(function(a,b){return c.compare(a,b)})};b.prototype.toRowIndex=function(a,b){var c=this.design,g=this.w-c.scrollBarWidth;return this.x<=a&&a<this.x+g&&(c=this.topRow+p((b-this.y-c.headerHeight)/c.rowHeight),this.topRow<=c&&c<this.rows.length)?c:null};b.prototype.toColumnIndex=function(a,b){var c=this.w-this.design.scrollBarWidth;if(this.x<=a&&a<this.x+c)for(var c=this.defaultColumnWidth,g=this.x,
f=0,h=this.columns.length;f<h;++f){var k=ga(this.columns[f].width,c);if(g<=a&&a<g+k)return f;g+=k}return null};Object.defineProperty(b.prototype,"defaultColumnWidth",{get:function(){for(var a=this.w-this.design.scrollBarWidth,b=0,c=0,g=0,f=this.columns;g<f.length;g++){var h=f[g];null!=h.width?b+=h.width:++c}return 0<c&&b<a?(a-b)/c:0},enumerable:!0,configurable:!0});b.prototype.refresh=function(){var a=this.rows.length;this.dragged>=a&&(this.dragged=null);this.hover>=a&&(this.hover=null);this.scrollTo(this.topRow)};
b.prototype.scrollTo=function(a){this.topRow=D(0,this.rows.length-this.displayCount,a)};b.prototype.scrollBy=function(a){this.scrollTo(this.topRow+a)};b.defaultDesign={rowHeight:28,rowFont:"20px Arial",rowStyle:k.WHITE.rgb,headerHeight:24,headerFont:"18px Arial",headerStyle:k.WHITE.rgb,scrollBarWidth:14,lineStyle:(new k(.4,.4,.4)).rgba,drawHeader:function(a,b,c,g,f){a.save();a.fillStyle=y(25,25,25,.8);a.fillRect(b,c,g,f);a.restore()},drawBackground:function(a,b,c,g,f){a.save();a.fillStyle=y(0,0,0,
.6);a.fillRect(b,c,g,f);a.restore()},drawScrollBar:function(a,b,c,g,f){va(a,b,c,g,f,x(100,100,100),x(75,75,75))},drawRowDragged:function(a,b,c,g,f){va(a,b,c,g,f,x(255,0,0),x(50,0,0))},drawRowSelected:function(a,b,c,g,f){va(a,b,c,g,f,x(100,0,0),x(50,0,0))},drawRowHover:function(a,b,c,g,f){va(a,b,c,g,f,x(75,0,0),x(50,0,0))}};return b}(na),yb=function(){function a(a,d,e){this.min=d;this.max=e;this.value=a}Object.defineProperty(a.prototype,"value",{get:function(){return this._value},set:function(a){this._value=
D(this.min,this.max,M(a))},enumerable:!0,configurable:!0});a.prototype.toString=function(){return this._value.toString()};a.prototype.valueOf=function(){return this._value};return a}(),Eb=function(a){function b(d,e,c,g,f,h){void 0===h&&(h=b.defaultDesign);a.call(this,d,e,c,g);this.value=f;this.design=h;this.hover=this.dragged=!1}n(b,a);b.prototype.getValueAsX=function(){var a=this.design.knobWidth,b=this.value,c=b.min;return this.x+a/2+(b.value-c)/(b.max-c)*(this.w-a)};b.prototype.setValueByX=function(a){var b=
this.design.knobWidth;a=D(0,1,(a-this.x-b/2)/(this.w-b));var b=this.value,c=b.min;this.value.value=M(c+a*(b.max-c))};b.prototype.onHover=function(a,b){this.hover=this.contains(a,b);this.dragged=!1};b.prototype.onDrag=function(a,b){this.hover=this.dragged&&this.contains(a,b);this.dragged&&this.setValueByX(a)};b.prototype.onDown=function(a,b){this.contains(a,b)&&(this.dragged=!0,this.setValueByX(a))};b.prototype.onUp=function(a,b){this.dragged=!1};b.prototype.onDraw=function(a,b){this.design.draw(a,
b,this)};Object.defineProperty(b.prototype,"knob",{get:function(){var a=this.design.knobWidth,b=this.h;return{x:this.getValueAsX()-a/2,y:this.y-(this.h-b)/2,w:a,h:b,state:this.dragged?2:this.hover?1:0}},enumerable:!0,configurable:!0});b.defaultDesign={knobWidth:12,draw:function(a,b,c){ua(a,c,{fillStyle:y(50,50,50,.8),strokeStyle:"white",lineWidth:4});b=c.knob;c={strokeStyle:"white",lineWidth:4};switch(b.state){case 0:c.fillStyle=y(150,150,150,.8);break;case 1:c.fillStyle=y(200,200,200,.8);break;case 2:c.fillStyle=
y(255,255,255,.8)}ua(a,b,c)}};return b}(na),Jb=function(a){function b(b,e,c,g,f,h){a.call(this,b,e,c,g);this.duration=f;this.style=h;this.logs=[]}n(b,a);b.prototype.onDraw=function(a,b){var c=this.logs;if(0<c.length){var g=b-this.duration,h=c.findIndex(function(a){return a.when>g});0>h?c.length=0:c.splice(0,h);h=c.length;if(0<h)for(var k=this.style,l=ga(k.fontSize,24),m=0;m<h;++m)ka(a,c[m].message,this.x,this.y+m*l,this.w,l,k)}};b.prototype.log=function(a){if(a){var b=performance.now(),c=this.logs,
g=c.length;0<g&&c[g-1].message===a?c[g-1].when=b:c.push({message:pa(a),when:b})}};b.prototype.error=function(a){this.log(a)};return b}(na);Q.languages.en="assets/lang/en.js";Q.languages.ja="assets/lang/ja.js";var zb={bkgnd:new k(0,0,0,.6),delta:new k(1,.2,0),normal:new k(.6,.8,0),full:new k(0,.8,.2)},Kb={bkgnd:new k(0,0,0,.6),delta:new k(0,.2,.4),normal:new k(0,.6,.8),full:new k(0,.6,1)},Ga=[{PICK:0,WALK:!1,POPUP:!1},{PICK:0,WALK:!1,POPUP:!0},{PICK:0,WALK:!0,POPUP:!0},{PICK:300,WALK:!0,POPUP:!0}],
ob=[l.TAB,l.ENTER,l.ESCAPE,l.SPACE],cb=[l.ENTER,l.SPACE,l.Y],db=[l.TAB,l.ESCAPE,l.N],Fb=[l.ESCAPE],Lb=[l.ENTER,l.SPACE],Mb={Warrior:{INT:4,DEX:4,STR:7,equipments:["Mace","PlateArmor","Mace"],skills:["Swing","Crash","Bash"],image:"nazrin"},Samurai:{INT:3,DEX:7,STR:5,equipments:["Katana","Chainmail"],skills:["Swing","Slash","CutThrough","Sweep"],image:"rin"},Knight:{INT:6,DEX:2,STR:7,equipments:["Spear","LamellarArmor","KiteShield"],skills:["Swing","Stab","Thrust","ShieldBash","ShieldCharge"],image:"toramaru"},
Thief:{INT:3,DEX:6,STR:6,equipments:["LongBow","LetherArmor","FirstAidKit"],skills:["Shoot","FirstAid"],image:"marisa"},Healer:{INT:7,DEX:3,STR:5,equipments:["Staff","Robe"],skills:["Swing","Heal","PartyHeal"],image:"reimu"},Mage:{INT:8,DEX:4,STR:3,equipments:["Wand","Robe"],skills:["FireBall","IceSpear","DrainLife","LightningLaser","FireNova"],image:"utsuho"}},Ab={Ant:{INT:3,DEX:3,STR:4,equipments:["Dagger","LetherArmor"],skills:["Swing"],image:"ant.png"},Elemental:{INT:4,DEX:3,STR:3,equipments:["Wand",
"LetherArmor"],skills:["FireBall"],image:"elemental.png"},Frog:{INT:4,DEX:4,STR:4,equipments:["ShortBow","LetherArmor"],skills:["Shoot"],image:"frog.png"},Plant:{INT:4,DEX:3,STR:4,equipments:["Wand","LetherArmor"],skills:["FireNova"],image:"plant.png"},Slug:{INT:3,DEX:3,STR:3,equipments:["Wand","LetherArmor"],skills:["DrainLife"],image:"slug.png"},Snail:{INT:3,DEX:3,STR:3,equipments:["LongBow","LetherArmor"],skills:["Shoot"],image:"snail.png"},Sword:{INT:3,DEX:5,STR:4,equipments:["LongSword","LetherArmor"],
skills:["Swing"],image:"sword.png"},Wall:{INT:3,DEX:3,STR:6,equipments:["Mace","LetherArmor"],skills:["Swing"],image:"wall.png"},Weasel:{INT:3,DEX:6,STR:3,equipments:["Spear","LetherArmor"],skills:["Thrust"],image:"weasel.png"}},Nb={AddedFire:{tags:[0,1,2],min:5,max:10,ATK:function(a,b){return b+a}}},Z={Dagger:{tags:[0,8],weight:13,price:100,ATK:30},ShortSword:{tags:[0,8],weight:15,price:100,ATK:40},LongSword:{tags:[0,8],weight:16,price:100,ATK:50},Katana:{tags:[0,8],weight:15,price:100,ATK:45},Axe:{tags:[0,
8,9],weight:18,price:100,ATK:45},Mace:{tags:[0,9],weight:16,price:100,ATK:40},Spear:{tags:[0,10],weight:20,price:100,ATK:50},Halberd:{tags:[0,8,9,10],weight:30,price:100,ATK:50},ShortBow:{tags:[2,10],weight:18,price:100,ATK:30},LongBow:{tags:[2,10],weight:20,price:100,ATK:40},Staff:{tags:[0,9,11],weight:20,price:100,ATK:20},Wand:{tags:[11],weight:16,price:100,ATK:25},FirstAidKit:{tags:[12],weight:10,price:100,ATK:10},Buckler:{tags:[3],weight:20,price:100,ATK:10,DEF:10},RoundShield:{tags:[3],weight:25,
price:100,ATK:15,DEF:15},SpikedShield:{tags:[3],weight:30,price:100,ATK:30,DEF:15},KiteShield:{tags:[3],weight:35,price:100,ATK:20,DEF:20},TowerShield:{tags:[3],weight:40,price:100,ATK:30,DEF:20},Circlet:{tags:[4],weight:5,price:100,DEF:2},LeatherHood:{tags:[4],weight:10,price:100,DEF:4},Mask:{tags:[4],weight:15,price:100,DEF:6},Sallet:{tags:[4],weight:20,price:100,DEF:8},Bascinet:{tags:[4],weight:25,price:100,DEF:10},Helmet:{tags:[4],weight:30,price:100,DEF:12},Robe:{tags:[5],weight:20,price:100,
DEF:10},LetherArmor:{tags:[5],weight:25,price:100,DEF:15},ScaleArmor:{tags:[5],weight:30,price:100,DEF:20},Chainmail:{tags:[5],weight:35,price:100,DEF:22},LamellarArmor:{tags:[5],weight:40,price:100,DEF:25},PlateArmor:{tags:[5],weight:45,price:100,DEF:30},Gloves:{tags:[6],weight:10,price:100,DEF:4},Mittens:{tags:[6],weight:20,price:100,DEF:6},Gauntlets:{tags:[6],weight:30,price:100,DEF:8},Slippers:{tags:[7],weight:5,price:100,DEF:2},Sandals:{tags:[7],weight:10,price:100,DEF:4},Shoes:{tags:[7],weight:15,
price:100,DEF:6},Boots:{tags:[7],weight:20,price:100,DEF:8},Greaves:{tags:[7],weight:25,price:100,DEF:10}},Ob={Dummy:{tags:[],cost:999,range:0,power:0,target:0,aciton:"Charge"},Swing:{tags:[0],cost:14,range:1,power:100,target:0,aciton:"Charge"},Slash:{tags:[0,8],cost:15,range:1,power:110,target:0,aciton:"Charge"},CutThrough:{tags:[0,8],cost:20,range:1,power:100,target:0,aciton:"GoBehind"},Sweep:{tags:[0,8],cost:20,range:1,power:100,target:4,aciton:"Nova"},Crash:{tags:[0,9],cost:15,range:1,power:110,
target:0,aciton:"Charge"},Bash:{tags:[0,9],cost:20,range:1,power:100,target:0,aciton:"Knockback"},Stab:{tags:[0,10],cost:15,range:1,power:110,target:0,aciton:"Charge"},Thrust:{tags:[0,10],cost:15,range:2,power:100,target:2,aciton:"Laser"},ShieldBash:{tags:[3],cost:20,range:1,power:100,target:0,aciton:"Charge"},ShieldCharge:{tags:[3],cost:24,range:1,power:100,target:0,aciton:"Trample"},Shoot:{tags:[2],cost:20,range:3,power:100,target:0,aciton:"Shoot"},IceSpear:{tags:[11],cost:16,range:5,power:80,target:0,
aciton:"Freeze"},DrainLife:{tags:[11],cost:16,range:5,power:80,target:0,aciton:"Drain"},FireBall:{tags:[11],cost:16,range:5,power:100,target:0,aciton:"Explode"},LightningLaser:{tags:[11],cost:16,range:5,power:100,target:2,aciton:"Laser"},FireNova:{tags:[11],cost:16,range:2,power:100,target:4,aciton:"Nova"},Heal:{tags:[11],cost:24,range:3,power:100,target:1,aciton:"Charge"},PartyHeal:{tags:[11],cost:24,range:1,power:100,target:5,aciton:"Nova"},FirstAid:{tags:[12],cost:24,range:1,power:100,target:1,
aciton:"Charge"}},Ca,Pb=xa([3,4,5,6,7]),Ha=function(){function a(b){this.EID=b;this.def=Nb[this.EID];if(null==this.def)throw new RangeError('Enchantment not found: "'+this.EID+'"');this.name=a.nameOf(this.EID);this.spec=a.specOf(this.EID);this.value=this.def.min+Aa(this.def.max-this.def.min)}a.prototype.qualify=function(a){return qa(this.name.localized,a)};a.prototype.modify=function(a){this.def.ATK&&(a=this.def.ATK(this.value,a));return a};a.nameOf=function(a){return h("Enchant",a,"Name")};a.specOf=
function(a){return h("Enchant",a,"Spec")};a.from=function(b){return new a(b)};a.fromJSON=function(b){return new a(b.EID)};a.prototype.toJSON=function(){return{EID:this.EID,value:this.value}};return a}(),la=function(){function a(b,d){this.IID=b;this.enchants=d;this.def=Z[this.IID];if(null==this.def)throw new RangeError('Item not found: "'+this.IID+'"');this.baseName=a.nameOf(this.IID);this.spec=a.specOf(this.IID);this.tagbits=xa(this.def.tags);null==this.enchants&&(this.enchants=(this.def.enchants||
[]).map(Ha.from))}Object.defineProperty(a.prototype,"name",{get:function(){for(var a=this.baseName.localized,d=0,e=this.enchants;d<e.length;d++)a=e[d].qualify(a);return a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"tags",{get:function(){return this.def.tags},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"weight",{get:function(){return this.def.weight},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"priceToSell",{get:function(){for(var a=
this.def.price,d=0,e=this.enchants;d<e.length;d++)a=e[d].modify(a);return p(a)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ATK",{get:function(){for(var a=this.def.ATK||0,d=0,e=this.enchants;d<e.length;d++)a=e[d].modify(a);return a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){for(var a=this.def.DEF||0,d=0,e=this.enchants;d<e.length;d++)a=e[d].modify(a);return a},enumerable:!0,configurable:!0});a.nameOf=function(a){return h("Item",
a,"Name")};a.specOf=function(a){return h("Item",a,"Spec")};a.from=function(b){return new a(b)};a.fromJSON=function(b){return new a(b.IID,X(Ha,b.enchants))};a.prototype.toJSON=function(){return{IID:this.IID,enchants:ha(this.enchants)}};return a}(),Ta=function(){function a(b){this.SID=b;this.def=Ob[this.SID];if(null==this.def)throw new RangeError('Skill not found: "'+this.SID+'"');this.name=a.nameOf(this.SID);this.spec=a.specOf(this.SID);this.tagbits=xa(this.def.tags)}Object.defineProperty(a.prototype,
"tags",{get:function(){return this.def.tags},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"cost",{get:function(){return this.def.cost},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"range",{get:function(){return this.def.range},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"power",{get:function(){return this.def.power},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"target",{get:function(){return this.def.target},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"hostile",{get:function(){var a;a:switch(this.def.target){case 1:case 3:case 5:a=!1;break a;default:a=!0}return a},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"action",{get:function(){return this.def.aciton},enumerable:!0,configurable:!0});a.prototype.match=function(a){return(this.tagbits&a.tagbits)===this.tagbits};a.nameOf=function(a){return h("Skill",a,"Name")};a.specOf=function(a){return h("Skill",a,"Spec")};a.from=function(b){return new a(b)};
a.fromJSON=function(b){return new a(b.SID)};a.prototype.toJSON=function(){return{SID:this.SID}};a.DUMMY=new a("Dummy");return a}(),eb=[1,2,3,4,5,5,5,5,4,3,2,1],Qb=eb.reduce(function(a,b){return T(a,b)},0),Db=function(){function a(a,d){this.src=a;this.back=new R(a+"/back.png");for(var e=[new R(a+"/eye.png")],c=1;c<=Qb;++c)e.push(new R(a+("/eye"+c+".png")));this.eyes=e;this.fore=new R(a+"/fore.png");this.cycle=4500+100*d;this.offset=Aa(this.cycle)}Object.defineProperty(a.prototype,"w",{get:function(){return this.back.w},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"h",{get:function(){return this.back.h},enumerable:!0,configurable:!0});a.prototype.draw=function(a,d,e,c,g){this.back.draw(a,d,e,c,g);var h;h=(d+this.offset)%this.cycle;h=450>h?eb[p(h/450*eb.length)]:0;this.eyes[h].draw(a,d,e,c,g);this.fore.draw(a,d,e,c,g)};return a}(),Y=function(){function a(a,d,e,c,h,f,k,l){this.name=a;this.INT=d;this.DEX=e;this.STR=c;this.equipments=h;this.skills=f;this.known=k;this.image=l}Object.defineProperty(a.prototype,
"HP",{get:function(){return 10*(3+this.STR)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"SP",{get:function(){var a=T(0,this.weight-this.maxWeight);return T(0,4*(3+this.STR)-a)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"step",{get:function(){return 13-this.DEX},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ZoC",{get:function(){return 3+this.DEX},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxWeight",{get:function(){return 10*
(3+this.STR)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"weight",{get:function(){return this.equipments.reduce(function(a,d){return a+d.weight},0)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){return 100*(1-this.equipments.reduce(function(a,d){return a*(1-d.DEF/100)},1))},enumerable:!0,configurable:!0});a.prototype.costOf=function(a){return null==a?void 0:a.cost-this.INT};a.prototype.rangeOf=function(a){return null==a?void 0:a.range};
a.prototype.powerOf=function(a){var d=this.itemFor(a);return d?d.ATK*a.power/100:void 0};a.prototype.itemFor=function(a){var d=void 0;if(a)for(var e=0,c=0,h=this.equipments;c<h.length;c++){var f=h[c];if(a.match(f)){var k=f.ATK;e<k&&(e=k,d=f)}}return d};a.adventurer=function(b){var d=Mb[b];if(null==d)throw new RangeError('Adventurer not found: "'+b+'"');return a.from(h("Adventurer",b),d)};a.monster=function(b){var d=Ab[b];if(null==d)throw new RangeError('Monster not found: "'+b+'"');return a.from(h("Monster",
b),d)};a.from=function(b,d){return new a(b.localized,d.INT,d.DEX,d.STR,d.equipments.map(la.from),d.skills.map(Ta.from),[],mb(d.image,d.INT))};a.fromJSON=function(b){return new a(b.name,b.INT,b.DEX,b.STR,X(la,b.equipments),X(Ta,b.skills),X(Ta,b.known),mb(b.image,b.INT))};a.prototype.toJSON=function(){var a=this.name,d=this.INT,e=this.DEX,c=this.STR,h=ha(this.equipments),f=ha(this.skills),k=ha(this.known),l;l=this.image.src;l=l.startsWith("assets/char/")?l.substr(12):l;return{name:a,INT:d,DEX:e,STR:c,
equipments:h,skills:f,known:k,image:l}};return a}(),fb;(function(a){var b=function(a){function b(){var c=this;a.call(this);(new F(0,0,1280,720,new R("assets/scene/title.jpg"))).attach(this);var g=pb(),f=function(a){(new da(c,new Ia.Home(a))).attach(c.parent)},k,l;g?(k=h("Title","Continue"),l=function(){return f(g)},(new K(1070,650,200,60,new B(h("Title","Delete")),function(){Da.confirm(c,h("Title","ConfirmDelete"),{label:h("Title","Delete"),click:function(){try{System.setRoamingStorage("NYO",null)}catch(a){G.error(a)}(new da(c,
new b)).attach(c.parent);G.log(h("Title","NotifyDelete"))},mnemonic:cb},{label:h("Config","Cancel"),mnemonic:db})})).attach(this)):(k=h("Title","New"),l=function(){var a={},b;for(b in Z){var c=Aa(4);0<c&&(a[b]=c)}a={shop:a,warehouse:[],reservers:[],party:[Y.adventurer("Knight"),Y.adventurer("Warrior"),Y.adventurer("Samurai"),Y.adventurer("Mage"),Y.adventurer("Healer"),Y.adventurer("Thief")],gold:1E3};a.party[0].equipments[0].enchants.push(Ha.from("AddedFire"));rb(a);f(a)});(new K(480,504,320,72,new B(k),
l,Lb)).attach(this);(new K(480,612,320,72,new B(h("Title","Quit")),System.exit)).attach(this);Ya(this)}n(b,a);return b}(S);a.Scene=b})(fb||(fb={}));var Ia;(function(a){function b(){return[{name:h("Character","Name"),extract:function(a){return a.name},width:200},{name:h("Character","INT"),extract:function(a){return a.INT},width:60,align:"right"},{name:h("Character","DEX"),extract:function(a){return a.DEX},width:60,align:"right"},{name:h("Character","STR"),extract:function(a){return a.STR},width:60,
align:"right"}]}function d(a){return[{name:a,extract:function(a){return a.name},width:200},{name:h("Town","Tags"),extract:function(a){return wa(a.tags)}},{name:h("Town","Weight"),extract:function(a){return a.weight},width:60,align:"right"},{name:h("Town","ATK"),extract:function(a){return a.ATK},width:60,align:"right"},{name:h("Town","DEF"),extract:function(a){return a.DEF},width:60,align:"right"}]}function e(a,b){var c=b.shop,e=d(a);e.push({name:h("Town","Stock"),extract:function(a){return ga(c[a.IID],
h("Town","New"))},width:60,align:"right"});return e}function c(a,b){var c=b.shop,d=b.warehouse;return[{name:a,extract:function(a){return la.nameOf(a)},width:200},{name:h("Town","Tags"),extract:function(a){return wa(Z[a].tags)}},{name:h("Town","ATK"),extract:function(a){return Z[a].ATK},width:60,align:"right"},{name:h("Town","DEF"),extract:function(a){return Z[a].DEF},width:60,align:"right"},{name:h("Town","Weight"),extract:function(a){return Z[a].weight},width:60,align:"right"},{name:h("Town","Stock"),
extract:function(a){return c[a]},width:60,align:"right"},{name:h("Town","Owned"),extract:function(a){return d.reduce(function(b,c){return c.IID===a?b+1:b},0)},width:60,align:"right"}]}function g(a){return[{name:a,extract:function(a){return a.name.localized},width:200},{name:h("Town","Required"),extract:function(a){return wa(a.tags)}},{name:h("Town","Cost"),extract:function(a){return a.cost},width:60,align:"right"},{name:h("Town","Range"),extract:function(a){return a.range},width:60,align:"right"},
{name:h("Town","Power"),extract:function(a){return a.power},width:60,align:"right"},{name:h("Town","Spec"),extract:function(a){return a.spec.localized}}]}var f={fontSize:64,fillStyle:x(255,255,255),strokeStyle:x(0,0,0),textAlign:"center",textBaseline:"middle",lineWidth:2},m=function(){function a(b,c){this.party=b;this.index=c}a.prototype.draw=function(a,b,c){var d=c.x,e=c.y,h=c.w;c=c.h;var g=this.party[this.index];a.save();if(g){var l=Ma(g.image,140,184);g.image.draw(a,b,{x:d+h/2-l.w/2,y:e+92-l.h/
2,w:l.w,h:l.h});var m=this.party.reduce(function(a,b){return b?T(a,b.HP):a},1);b=g.HP;var l=d+10,n=h-20,p=e+c-30,m=(n-2)*b/m;a.strokeStyle=k.BLACK;a.fillStyle=zb.full;a.fillRect(l,p,m,6);a.strokeRect(l,p,m,6);ka(a,b.toString(),l+4,p-20,n,20,{fontSize:20,fillStyle:x(255,255,255),strokeStyle:x(0,0,0),textAlign:"left",textBaseline:"bottom",lineWidth:2});ka(a,g.name,d,e+c-24,h,24,{fontSize:24,fillStyle:x(255,255,255),strokeStyle:x(0,0,0),textAlign:"center",textBaseline:"bottom",lineWidth:2})}else ka(a,
(this.index+1).toString(),d,e,h,c,f);a.restore()};return a}(),v=function(a){function b(c){a.call(this);this.data=c}n(b,a);b.prototype.addButton=function(a,b,c,d){a=new K(1280-170*a,665,160,45,new B(c),d,[b]);a.attach(this);return a};b.prototype.goTo=function(a){(new da(this,new a(this.data))).attach(this.parent)};return b}(S),y=function(a){function b(c,d){a.call(this,c);(new F(0,0,1280,720,new R("assets/scene/"+d))).attach(this);Ya(this);for(var e=c.party,h=this,g=[],f=0;6>f;++f){var k=p(f/3),l=p(f%
3);(new wb(10+170*(1-k),10+214*l+68*k,160,204,g,new m(e,f),function(){h.onPortraitClick(this.drawable.index)},function(a){var b=this.drawable;a=a.drawable;c=[e[a.index],e[b.index]];e[b.index]=c[0];e[a.index]=c[1];c=[a.index,b.index];b.index=c[0];a.index=c[1];var c})).attach(this)}}n(b,a);return b}(v),D=function(a){function b(c){var d=this;a.call(this,c,"town.jpg");var e=["grass","moss"],g=Aa(e.length);this.addSpot(5,l.G,"Guild",function(){}).enabled=!1;this.addSpot(4,l.P,"Pub",function(){return d.goTo(q)});
this.addSpot(3,l.T,"Shop",function(){return d.goTo(I)});this.addSpot(2,l.S,"Smith",function(){}).enabled=!1;this.addSpot(1,l.D,"Dungeon",function(){(new da(d,new ya.Scene(c,new ya.EndressStage(e[g])))).attach(d.parent)}).enabled=c.party.some(function(a){return null!=a});this.addButton(2,l.L,h("Town","Load"),function(){Da.confirm(d,h("Town","ConfirmLoad"),{label:h("Town","Load"),click:function(){var a=pb();a&&((new da(d,new b(a))).attach(d.parent),G.log(h("Town","NotifyLoad")))},mnemonic:cb},{label:h("Config",
"Cancel"),mnemonic:db})});this.addButton(1,l.S,h("Town","Save"),function(){rb(d.data);G.log(h("Town","NotifySave"))})}n(b,a);b.prototype.onPortraitClick=function(a){(a=this.data.party[a])&&(new da(this,new P(this.data,a))).attach(this.parent)};b.prototype.addSpot=function(a,b,c,d){a=new K(950,665-100*a,320,90,new B(h("Town",c)),d,[b]);a.attach(this);return a};return b}(y);a.Home=D;var q=function(a){function c(d){function e(a,b){(c=Array.prototype.splice).call.apply(c,[a,0,a.length].concat(b));var c}
var g=this;a.call(this,d,"pub.jpg");var f=d.party.concat(),k=d.reservers.concat();this.addButton(3,l.C,h("Town","Clear"),function(){for(var a=0;6>a;++a){var b=d.party[a];b&&(d.reservers.push(b),d.party[a]=null)}});this.addButton(2,l.R,h("Town","Revert"),function(){e(d.party,f);e(d.reservers,k)});this.addButton(1,l.TAB,h("Town","Back"),function(){return g.goTo(D)});(new E(350,10,920,E.heightOf(10),b(),d.reservers,function(a,b){return g.onReserverClick(a,b)})).attach(this)}n(c,a);c.prototype.onPortraitClick=
function(a){var b=this.data.party[a];b&&(this.data.party[a]=null,this.data.reservers.push(b))};c.prototype.onReserverClick=function(a,b){for(var c=0;6>c;++c)if(null==this.data.party[c]){this.data.party[c]=a;this.data.reservers.splice(b,1);return}G.error(h("Town","PartyFull"))};return c}(y),I=function(a){function b(d){var g=this;a.call(this,d,"shop.jpg");var f=d.shop,k=d.warehouse,m=new E(350,10,920,E.heightOf(10),c(h("Town","Buy"),d),Ba(f),function(a){if(0>=f[a])G.error(h("Town","SoldOut"));else{var b=
Z[a].price;if(d.gold<b)G.error(h("Town","NoMoney"));else{var c=new la(a);--f[a];k.push(c);d.gold-=b;G.log(qa(h("Town","NotifyBuy").localized,c.name,b))}}});m.attach(this);var p=new E(350,10,920,E.heightOf(10),e(h("Town","Sell"),d),k,function(a,b){var c=a.IID,e=a.priceToSell;k.splice(b,1);var g=f[c];null==g?(f[c]=1,m.rows.push(c)):f[c]=1+g;d.gold+=e;G.log(qa(h("Town","NotifySell").localized,a.name,e))});p.attach(this);var n,q;n=this.addButton(3,l.B,h("Town","Buy"),function(){m.visible=!0;p.visible=
!1;n.enabled=!1;q.enabled=!0});q=this.addButton(2,l.S,h("Town","Sell"),function(){m.visible=!1;p.visible=!0;n.enabled=!0;q.enabled=!1});this.addButton(1,l.TAB,h("Town","Back"),function(){return g.goTo(D)});n.click()}n(b,a);b.prototype.onPortraitClick=function(a){G.log("Shop.onPortraitClick: "+a)};return b}(y),P=function(a){function b(c,e){var f=this;a.call(this,c);var k=c.warehouse,m=Ma(e.image,1280,720,!0);(new F(0,0,m.w,m.h,e.image)).attach(this);(new F(0,0,200,40,new B(e.name))).attach(this);(new F(0,
40,200,40,new B("INT: "+e.INT))).attach(this);(new F(100,40,200,40,new B("DEX: "+e.DEX))).attach(this);(new F(200,40,200,40,new B("STR: "+e.STR))).attach(this);(new F(0,80,200,40,new B(function(){return"HP: "+e.HP}))).attach(this);(new F(0,120,200,40,new B(function(){return"SP: "+e.SP}))).attach(this);(new F(0,160,200,40,new B(function(){return"WT: "+e.weight+"/"+e.maxWeight}))).attach(this);(new F(0,200,200,40,new B(function(){return"DEF: "+e.DEF.toFixed(1)}))).attach(this);var n=new S([new E(350,
10,920,E.heightOf(10),d(h("Town","Equipments")),e.equipments,function(a,b){e.equipments.splice(b,1);k.push(a)}),new E(350,360,920,E.heightOf(10),d(h("Town","Warehouse")),k,function(a,b){k.splice(b,1);var c=e.equipments,d=a.tagbits,h=[],d=d&Pb;if(0!==d)for(var g=0;g<c.length;)0!==(c[g].tagbits&d)?(h.push(c[g]),c.splice(g,1)):++g;e.equipments.push(a);(f=k.push).call.apply(f,[k].concat(h));var f})]);n.attach(this);var p=new S([new E(350,10,920,E.heightOf(10),g(h("Town","Skills")),e.skills,function(a,
b){e.skills.splice(b,1);e.known.push(a)}),new E(350,360,920,E.heightOf(10),g(h("Town","Knowns")),e.known,function(a,b){e.known.splice(b,1);e.skills.push(a)})]);p.attach(this);var q,v;q=this.addButton(3,l.E,h("Town","Equipments"),function(){n.visible=!0;p.visible=!1;v.enabled=!0;q.enabled=!1});v=this.addButton(2,l.S,h("Town","Skills"),function(){n.visible=!1;p.visible=!0;v.enabled=!1;q.enabled=!0});this.addButton(1,l.TAB,h("Town","Back"),function(){return f.goTo(D)});q.click()}n(b,a);return b}(v)})(Ia||
(Ia={}));var ya;(function(a){function b(a,b,r,c,z,d,e,h,g){var f=D(0,1,d/e);d=null==h?f:D(0,1,(d+h)/e);a.save();a.fillStyle=g.bkgnd;a.fillRect(b,r,c,z);b+=1;r+=1;c-=2;z-=2;d>f?(a.fillStyle=1<=f?g.full:g.normal,a.fillRect(b,r,c*f-1,z),a.fillStyle=g.full,a.fillRect(b+c*f,r,c*(d-f),z)):d<f?(e=c*d,0<d&&(e=T(e,2),a.fillStyle=1<=f?g.full:g.normal,a.fillRect(b,r,e-1,z)),a.fillStyle=g.delta,a.fillRect(b+e,r,c*(f-d),z)):(a.fillStyle=1<=f?g.full:g.normal,a.fillRect(b,r,c*f,z));a.restore()}function d(a,b,r,
c,z,d){var e=0,e=1===a.team?e+10*(z-b):e+10*(b-c);a=2*r+b%2;e=3>a?e+10*a:e+10*(5-a);b<d&&(e*=.1);return e}function e(a,b,r){var c=void 0,z=b.distance(r)+1;a.straight(b,r,z,function(b,r){r===z&&a.get(b).empty&&(c=b)});return c}function c(a,b,r,c,z){var d=a.toX(b)-a.toX(r),e=a.toY(b)-a.toY(r),d=100+Qa(d*d+e*e,.5)/1280*400,d=new I(d,function(d,e){var g=a.toX(b),h=a.toY(b),f=a.toX(r),gb=a.toY(r);Oa(e,g*(1-d)+f*d+64-20,h*(1-d)+gb*d+40-20,40,40,c,z,.5)});d.attach(a);return d}function g(a,b,r,H,d,e){b=c(a,
b.hex,r.hex,d,e);b.then(function(){H.attach(a)});return m.wait.POPUP?H:b}function f(a,b,r,c,d,e){function g(r,c){var H=h.get(r).unit;if(b.isTarget(H)){var d=b.trySkill(H);e&&(d=e(d,c));H=a.prepareEffect(H,d);H.attach(a);f.push(H)}}var h=a.field,f=[];g(r,0);h.surround(r,c,g);var A=new I(400,function(b,t){var e=a.toX(r)+64,g=a.toY(r)+40,h=128*c*b,f=80*c*b,gb=(new k(d.r,d.g,d.b,d.a*(1-b))).rgba,u=(new k(d.r,d.g,d.b,0)).rgba;Oa(t,e-h,g-f,2*h,2*f,gb,u,b)});A.attach(a);return m.wait.POPUP?(f.push(A),new Sa(f)):
A}var w=y(0,0,0,0),v=y(0,0,0,.75),E={inner:new k(.9,1,.7),outer:new k(.2,.9,.2)},Q={inner:new k(.9,.7,1),outer:new k(.2,.2,.9)},q={inner:new k(1,.7,.9),outer:new k(.9,.2,.2)},M={inner:new k(.9,.7,1),outer:new k(.2,.2,.9)},ba={outer:new k(.25,.75,1),inner:new k(.7,.9,1),bkgnd:new k(.25,.75,1,.3)},L={outer:new k(1,.75,.25),inner:new k(1,.9,.75),bkgnd:new k(1,.75,.25,.3)},N={DASH_OR_RANGE:{outer:new k(1,.25,.25),inner:new k(1,.7,.7),bkgnd:new k(1,.75,.25,.3)},RANGE:{outer:new k(1,.25,.25),inner:new k(1,
.7,.7),bkgnd:new k(1,.5,.25,.3)},TARGET:{outer:new k(1,.1,.1),inner:new k(1,.25,.25),bkgnd:new k(1,.1,.1,.3)}},X={DASH_OR_RANGE:{outer:new k(.25,.25,1),inner:new k(.7,.7,1),bkgnd:new k(1,.75,.25,.3)},RANGE:{outer:new k(.25,.25,1),inner:new k(.7,.7,1),bkgnd:new k(.25,.5,1,.3)},TARGET:{outer:new k(.1,.1,1),inner:new k(.25,.25,1),bkgnd:new k(.1,.1,1,.3)}},U=new k(1,1,0,.5),Z=new k(1,0,0,.5),aa=new k(0,0,1,.5),ka=y(0,0,0,.65),la=y(0,0,0,0),oa={textAlign:"center",textBaseline:"bottom",fontSize:32,fillStyle:"yellow",
strokeStyle:"black",lineWidth:2},Fa={textAlign:"center",textBaseline:"bottom",fontSize:32,fillStyle:"red",strokeStyle:"black",lineWidth:2},ha=y(255,0,0,.8),ra=new k(1,.7,.7),ua=new k(.7,1,.7),va=[{messageID:"PartyTurn",bkgnd:k.NAVY,textStyle:{fontSize:64,fillStyle:"white",textAlign:"center",textBaseline:"middle"}},{messageID:"EnemyTurn",bkgnd:k.MAROON,textStyle:{fontSize:64,fillStyle:"white",textAlign:"center",textBaseline:"middle"}}],O=function(){function a(b,r){this.xH=b;this.yH=r}a.prototype.near=
function(b){var r=0===this.xH%2?0:1;return new a(this.xH+[[1,2,1,-1,-2,-1],[1,2,1,-1,-2,-1]][r][b],this.yH+[[-1,0,0,0,0,-1],[0,0,1,1,0,0]][r][b])};a.distance=function(a,b,c,d){var e=c-a;a=2*d+c%2-(2*b+a%2);return 0>a?a>e?(-e-a)/2:a>-e?(e-a)/2:-a:a<e?(e+a)/2:a<-e?(-e+a)/2:a};a.prototype.distance=function(b,r){var c;null==r?(d=b,c=d.xH,r=d.yH,d):c=b;return a.distance(this.xH,this.yH,c,r);var d};a.prototype.toString=function(){return"("+this.xH+","+this.yH+")"};a.prototype.equals=function(a,b){if(null==
a)return!1;var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;return this.xH===c&&this.yH===b;var d};a.is=function(a,b){return a===b?!0:null==a||null==b?!1:a.equals(b)};return a}(),Ja=function(){function a(b,r){this.dummy=r;this.cells={};this.depth=p(b)}Object.defineProperty(a.prototype,"minXH",{get:function(){return 1+ab(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxXH",{get:function(){return 20+p(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"minVisibleXH",{get:function(){return p(this.depth)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxVisibleXH",{get:function(){return 21+ab(this.depth)},enumerable:!0,configurable:!0});a.prototype.contains=function(a,b){if(null==a)return!1;var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;return 0<=b&&3>b&&this.minXH<=c&&c<this.maxXH;var d};a.prototype.getLine=function(a){return this.cells[a]};a.prototype.setLine=function(a,b){this.cells[a]=b};a.prototype.deleteLine=function(a){delete this.cells[a]};
a.prototype.rawget=function(a,b){var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;return 0<=b&&3>b&&this.minVisibleXH<=c&&c<this.maxVisibleXH&&(c=this.cells[c])?c[b]:null;var d};a.prototype.get=function(a,b){var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;c=this.rawget(c,b);return ga(c,this.dummy);var d};a.prototype.set=function(a,b,c){null==c&&(d=b,b=d.xH,c=d.yH,d);d=this.cells[b];null==d&&(d=this.cells[b]=[]);d[c]=a;var d};a.prototype.each=function(a){for(var b=this.maxXH,c=this.minXH;c<b;++c)for(var d=0;3>d;++d)a.call(this,
this.get(c,d),c,d)};a.prototype.eachVisible=function(a){for(var b=this.maxVisibleXH,c=this.minVisibleXH;c<b;++c)for(var d=0;3>d;++d)a.call(this,this.get(c,d),c,d)};a.prototype.straight=function(a,b,c,d){if(!a.equals(b)){var e=a.distance(b),g=a.xH;a=1+2*(2*a.yH+a.xH%2);var h=(b.xH-g)/e;b=(1+2*(2*b.yH+b.xH%2)-a)/e;for(e=1;e<=c;++e){var f=g+e*h,k=p((a+e*b)/2),J=void 0,J=0===k%2?2*p((f+1)/2):2*p(f/2)+1,f=p(k/2);this.contains(J,f)&&d(new O(J,f),e)}}};a.prototype.surround=function(a,b,c){if(1===b)for(var d=
0;6>d;++d){var e=a.near(d);this.contains(e)&&c(e,1)}if(1<b){a=a.near(0);for(var g=1;g<=b;++g){for(var e=a,h=0,f=[2,3,4,5,0,1];h<f.length;h++)for(var d=f[h],k=0;k<g;++k,e=e.near(d))this.contains(e)&&c(e,g);a=a.near(0)}}};return a}(),ea=function(){function a(b){this.duration=b}a.prototype.then=function(a){null==this.duration?P.then(a):this.sig=sa(this.sig,a);return this};a.prototype.commit=function(){ta(this.sig);this.duration=this.sig=void 0};a.prototype.getXY=function(a,b,c){if(null!=this.duration)if(c=
I.clamp(c,this.start,this.duration),1<=c)this.commit();else return this.onGetXY(a,b,c)};a.prototype.drawCharacter=function(a,b,c,d,e,g){a.drawCharacter(b,c,d,e,g)};return a}(),ya=function(a){function b(c){a.call(this,400*(13-c)/4)}n(b,a);b.prototype.onGetXY=function(a,b,c){a=a.hex;return{x:b.toX(a)-128*(1-c)+64,y:b.toY(a)+80}};return b}(ea),za=function(a){function b(c){a.call(this,100*Qa(c.length-1,.75));this.path=c}n(b,a);b.prototype.onGetXY=function(a,b,c){var d=this.path.length-1,e=p(d*c),g=this.path[e],
h=this.path[e+1];a=b.toX(g);var g=b.toY(g),f=b.toX(h);b=b.toY(h);c=d*c-e;return{x:a*(1-c)+f*c+64,y:g*(1-c)+b*c+80}};return b}(ea),pa=function(a){function b(c,d,e){a.call(this,b.durationOf(c,d,e));this.hexFrom=d;this.hexTo=e}n(b,a);b.durationOf=function(a,b,c){var d=a.toX(b)-a.toX(c);a=a.toY(b)-a.toY(c);return 200+Qa(d*d+a*a,.3)/1280*1E3};b.prototype.hit=function(a){null==this.duration?P.then(a):this.hitsig=sa(this.hitsig,a)};b.prototype.commit=function(){ta(this.hitsig);this.hitsig=void 0;a.prototype.commit.call(this)};
b.prototype.onGetXY=function(a,b,c){a=b.toX(this.hexFrom);var d=b.toY(this.hexFrom),e=b.toX(this.hexTo);b=b.toY(this.hexTo);.5>c?c*=2:(c=2-2*c,ta(this.hitsig),this.hitsig=null);return{x:a*(1-c)+e*c+64,y:d*(1-c)+b*c+80}};return b}(ea),qa=function(a){function b(c,d){a.call(this,500);var e=c.HP;this.dying=d>=e?c.hex:null;this.radius=d>=e/2?1:.5+d/e}n(b,a);b.prototype.onGetXY=function(a,b,c){var d=20*(1-c)*this.radius;c=c*W*this.duration/250*this.radius;a=this.dying||a.hex;return{x:d*V(4*c)+b.toX(a)+
64,y:d*V(3*c)+b.toY(a)+80}};b.prototype.drawCharacter=function(b,c,d,e,g,h){this.dying?(h=I.clamp(d,this.start,this.duration),c.save(),c.globalAlpha=1-h,a.prototype.drawCharacter.call(this,b,c,d,e,g,new k(1,0,0,h)),c.restore()):a.prototype.drawCharacter.call(this,b,c,d,e,g,h)};return b}(ea),ja=function(){function a(b,c,d){this.ch=b;this.team=c;this.hex=d;this.idleOffset=Ka();this.HP=this.maxHP;this.SP=this.maxSP;this.skill=b.skills.find(function(a){return null!=b.powerOf(a)})||Ta.DUMMY}a.prototype.toString=
function(){return"Unit(name="+this.name+", hex="+this.hex+")"};Object.defineProperty(a.prototype,"name",{get:function(){return this.ch.name},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxHP",{get:function(){return this.ch.HP},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"maxSP",{get:function(){return this.ch.SP},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"step",{get:function(){return this.ch.step},enumerable:!0,configurable:!0});
Object.defineProperty(a.prototype,"ZoC",{get:function(){return this.ch.ZoC},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"DEF",{get:function(){return this.ch.DEF},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"cost",{get:function(){return this.ch.costOf(this.skill)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"range",{get:function(){return this.ch.rangeOf(this.skill)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"ATK",
{get:function(){return this.ch.powerOf(this.skill)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"minCost",{get:function(){var a=this;return this.ch.skills.reduce(function(b,c){var d=a.ch.costOf(c);return d<b?d:b},this.maxSP)},enumerable:!0,configurable:!0});a.prototype.isEnemy=function(a){return null!=a&&this.team!==a.team};a.prototype.isTarget=function(a){return null==a?!1:this.skill.hostile?this.isEnemy(a):this!==a&&!this.isEnemy(a)};a.prototype.canTargetFrom=function(a,b,
c,d,e){return this.SP>=this.cost&&this.isTarget(a.get(d,e).unit)&&O.distance(b,c,d,e)<=this.range};a.prototype.canTarget=function(a,b){if(null==b)return!1;var c=this.hex;return this.canTargetFrom(a,c.xH,c.yH,b.xH,b.yH)};a.prototype.done=function(a){var b=this.hex;return b&&this.SP<this.minCost&&this.SP<this.step+a.zoc[this.team].get(b)};a.prototype.trySkill=function(a){return this.isTarget(a)?this.skill.hostile?-ab(this.ATK*(100-a.DEF)/100):this.ATK:null};a.prototype.shoot=function(a,b){var c=Va[this.skill.action](a,
this,b);this.SP-=this.cost;return c};a.prototype.onTurnEnd=function(a){this.team===a.team&&(this.SP=this.maxSP)};a.prototype.onTurnStart=function(a){};a.prototype.getXY=function(a,b){var c;this.state&&(c=this.state.getXY(this,a,b),null==c&&(this.state=null));if(null==c){var d=this.hex;d&&(c={x:a.toX(d)+64,y:a.toY(d)+80})}return c};Object.defineProperty(a.prototype,"state",{get:function(){return this._state},set:function(a){var b=this._state;if(this._state=a)a.start=performance.now();b&&b.commit()},
enumerable:!0,configurable:!0});a.prototype.drawCharacter=function(a,b,c,d,e){var g=this.ch.image,h=Ma(g,128,128),f=h.w,k=.2*f;Oa(a,c-f/2,d-10-k/2,f,k,ka,la,.75);b&&(f=200*(12-this.ch.DEX),f=T(0,V(2*W*(this.idleOffset+b%f/f))),d-=20*f+10*(1-f));h.x=c-h.w/2;h.y=d-h.h;g.draw(a,b,h,e?e.rgb:null,e?e.a:null)};a.prototype.draw=function(a,b,c,d,e){this.state?this.state.drawCharacter(this,a,b,c,d,e):this.drawCharacter(a,b,c,d,e)};a.prototype.drawHP=function(a,c,d,e){b(a,c,d,96,6,this.HP,this.maxHP,e,zb)};
a.compare=function(a,b){return a.y<b.y?-1:a.y>b.y?1:a.x<b.x?-1:a.x>b.x?1:0};return a}(),wa=function(){function a(b,c){void 0===b&&(b=0);this.type=b;this.unit=c}Object.defineProperty(a.prototype,"empty",{get:function(){return null==this.unit&&0===this.type},enumerable:!0,configurable:!0});a.DUMMY=new a(1);return a}(),Ca=function(a){function b(c,d,e){var g=this,h=c.field;a.call(this,h.depth,b.DUMMY);var f=d.step,k=d.cost,A=d.hex,l=d.SP;this.ensure(A).SP=l;if(l>=f+e.get(A)){A=[A];do{var Ua=A.shift(),
C=this.get(Ua).SP,fa=f+e.get(Ua);if(C>=fa)for(C-=fa,fa=0;6>fa;++fa){var m=Ua.near(fa),n=h.rawget(m);n&&0===n.type&&!d.isEnemy(n.unit)&&(n=this.ensure(m),n.SP<C&&(n.SP=C,n.comeFrom=Ua,C>=f+e.get(m)&&A.push(m)))}}while(0<A.length)}l>=k&&(this.each(function(a,b,f){a.SP>=k&&h.rawget(b,f).empty&&g.expandRange(c,d,e,new O(b,f))}),this.expandRange(c,d,e,d.hex))}n(b,a);b.prototype.expandRange=function(a,b,c,d){var e=this,g=b.range;if(1<=g){var h=b.hex,f=a.field;a=a.numScrollsPerTurn;var k=this.get(d),t=c.get(d),
l=$a(2*d.yH+d.xH%2-3),J=f.minXH+a,m=d.xH<J,n=function(a){var b=e.get(a);if(k.SP>b.SP)return!0;if(k.SP<b.SP)return!1;b=a.xH<J;if(!m&&b)return!0;if(m&&!b)return!1;b=c.get(a);return t<b?!0:t>b?!1:d.xH<a.xH?!0:d.xH>a.xH?!1:l<$a(2*a.yH+a.xH%2-3)};f.surround(d,g,function(a){if(!a.equals(h)){var c=f.rawget(a);a=e.ensure(a);if(null==a.shotFrom||n(a.shotFrom))a.shotFrom=d,null==a.deltaHP&&(a.deltaHP=b.trySkill(c.unit))}})}};b.prototype.ensure=function(a,b){var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;d=this.rawget(c,
b);null==d&&(d={SP:-1},this.set(d,c,b));return d;var d};b.prototype.getPath=function(a){var b=this.get(a),c=b.deltaHP,d=b.comeFrom,b=b.shotFrom;if(!c&&!d)return null;null!=c?(a=[b],c=this.get(b),d=c.comeFrom,c):a=[a];for(;d;)a.unshift(d),c=this.get(d),d=c.comeFrom,c;return a};b.DUMMY={SP:-1};return b}(Ja),xa=function(){function a(b,c,d){this.scene=b;this.zoc=c;this.previous=d;this.maps=new Ja(b.field.depth)}Object.defineProperty(a.prototype,"focus",{get:function(){return this._focus},set:function(a){null==
a?(this._focus=null,this.startTime=this.SP=this.from=void 0):this._focus!==a&&(this._focus=a,this.from=a.hex,this.SP=a.SP,this.startTime=performance.now(),this.ensure(a))},enumerable:!0,configurable:!0});a.prototype.ensure=function(a){var b=a.hex,c=this.maps.rawget(b);null==c&&(c=new Ca(this.scene,a,this.zoc[a.team]),this.maps.set(c,b));return c};a.prototype.invalidate=function(){this.maps.set(void 0,this.from);this.startTime=performance.now()};a.prototype.undo=function(a){var b=this.previous;if(b){var c=
b.focus;a.setUnit(c,b.from);c.SP=b.SP;return b}return this.focus?(this.focus=null,this):null};return a}(),Ea=function(a){function b(c,d,e,g,h,f){var k=this;a.call(this,d,e,g,h,f,new B(function(){var a=k.focus;if(a){var b=a.ch.skills[k.index];if(b){var c=a.skill===b,d=a.ch.costOf(b),e=a.ch.rangeOf(b),a=a.ch.powerOf(b);return""+(c?"E ":"")+b.name.localized+"\n"+d+" / "+e+" / "+(0<a?a.toFixed(1):"-")}}},b.textStyle),function(){var a=this.focus;if(a){var b=a.ch.skills[this.index];if(b&&0<a.ch.powerOf(b)){a.skill=
b;b=this.scene.stack;do b.focus===a&&b.invalidate(),b=b.previous;while(b)}}},function(a){var b=this.focus;b&&(c=[b.ch.skills[a.index],b.ch.skills[this.index]],b.ch.skills[this.index]=c[0],b.ch.skills[a.index]=c[1],b=[a.index,this.index],this.index=b[0],a.index=b[1]);var c});this.scene=c;this.index=f.length-1}n(b,a);Object.defineProperty(b.prototype,"visible",{get:function(){return null!=this.skill},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"enabled",{get:function(){var a=this.focus;
return a?null!=a.ch.powerOf(a.ch.skills[this.index]):null},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"focus",{get:function(){return this.scene.focus},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"skill",{get:function(){var a=this.focus;return a?a.ch.skills[this.index]:null},enumerable:!0,configurable:!0});b.textStyle={fontSize:20};return b}(wb),ea=function(){function a(b,c){void 0===c&&(c=2);this.numScrollsPerTurn=c;var d="assets/"+("level/"+b+"/");this.imgSky=
new R(d+"sky.png");this.imgCells=[new R(d+"tile.png"),new R(d+"hole.png")]}a.prototype.generate=function(a,b){var c=0,d=0;a.each(function(a){(a=a.unit)&&(0===a.team?++c:++d)});for(var e=0===c?.3:.3*Qa(1.1,c-d),g=Array(3),h=Ba(Ab),f=0;3>f;++f){var k=void 0,l=0;12<b&&Ka()<e?(k=h[Aa(h.length)],k=Y.monster(k),k=new ja(k,1,new O(b,f))):6<b&&.1>Ka()&&(l=1);g[f]=new wa(l,k)}return g};a.prototype.draw=function(a,b,c){var d=this,e=c.field;a.save();var g=128*e.depth/2;a.fillStyle=this.imgSky.createPattern(a,
"repeat");a.translate(-g,0);a.fillRect(0+g,0,1280,80);a.restore();var h={x:0,y:0,w:128,h:80};e.eachVisible(function(e,g,f){e=e.type;h.x=c.toX(g,f);h.y=c.toY(g,f);d.imgCells[e].draw(a,b,h)})};return a}();a.EndressStage=ea;ea=function(a){function c(b,d){function e(a,b){return new K(10+110*a,570,100,140,{draw:function(a,c,d){var e=d.x,f=d.y,r=Ma(b.ch.image,d.w,d.h,!0),g=r.w,r=r.h,e=e+(d.w-g)/2,f=f+(d.h-r)/2;b.ch.image.draw(a,c,{x:e,y:f,w:g,h:r})}},function(){return k.click(b.hex)},[l.$1+a])}function g(a,
b,c,d){a=new K(1280-150*a,570,140,140,new B(b),c);d&&ia(a,"enabled",d);return a}var f=this;a.call(this);this.data=b;this.stage=d;this.team=0;this.enabled=!0;var k=new Ga;k.attach(this);k.visible=!1;var u=new Ha;u.attach(this);u.visible=!1;for(var u=b.party,A=new Ja(0,wa.DUMMY),t=A.minVisibleXH,m=A.maxVisibleXH;t<m;++t)A.setLine(t,this.stage.generate(A,t));for(var t=[],C=[new O(2,0),new O(2,1),new O(2,2),new O(1,0),new O(1,1),new O(1,2)],m=0,fa=C.length;m<fa;++m){var n=u[m];if(n){var q=new ja(n,0,
C[m]);q.state=new ya(n.DEX);A.rawget(q.hex).unit=q;t.push(e(m,q))}}this.field=A;this.dying=[];this.startTurn();u=new ca;u.onDraw=function(a,b){return f.drawUnits(a,b,f.stack.startTime)};u.attach(this);u=new S;ia(u,"visible",function(){return k.visible&&null==f.focus});u.attach(this);g(1,h("Combat","End"),function(){return f.endTurn()}).attach(u);g(2,h("Combat","Undo"),function(){return f.undo()},function(){return null!=f.stack.previous}).attach(u);g(3,h("Combat","Retire"),function(){return f.retire()}).attach(u);
u=new S(t);ia(u,"visible",function(){return 0===f.team&&null==f.focus});u.attach(this);A=new ca;A.onDraw=function(a){return f.drawBarsOnIdle(a)};A.attach(u);u=new ca;u.onDraw=function(a){var b=f.focus;f.drawBarsOnFocus(a,b,f.mapFor(b))};ia(u,"visible",function(){return f.controller.visible&&null!=f.focus});u.attach(this);var hb=new na(0,560,1280,160);hb.onDraw=function(a){return f.drawPanel(a,f.focus,hb)};ia(u,"visible",function(){return null!=f.focus});hb.attach(this);u=new S;ia(u,"visible",function(){return k.visible&&
null!=f.focus});u.attach(this);A=[];for(m=0;6>m;++m)(new Ea(this,400+170*p(m/2),570+m%2*75,160,65,A)).attach(u);u=new S;ia(u,"visible",function(){return k.visible&&null!=k.target});u.attach(this);var ib=new na(640,560,640,160);ib.onDraw=function(a){return f.drawPanel(a,f.controller.target,ib)};ib.attach(u);u=System.canvas.getContext("2d");A=u.createLinearGradient(0,0,128,0);A.addColorStop(0,v);A.addColorStop(1,w);(new F(0,0,128,560,new Za({fillStyle:A}))).attach(this);u=u.createLinearGradient(1152,
0,1280,0);u.addColorStop(0,w);u.addColorStop(1,v);(new F(1152,0,1280,560,new Za({fillStyle:u}))).attach(this);Ya(this)}n(c,a);Object.defineProperty(c.prototype,"controller",{get:function(){return this.children[this.team]},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"numScrollsPerTurn",{get:function(){return this.stage.numScrollsPerTurn},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"focus",{get:function(){return this.stack.focus},set:function(a){this.stack.focus=
a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"zoc",{get:function(){if(null==this._zoc){var a=this.field.depth,b=[new Ja(a,0),new Ja(a,0)];this.eachUnit(function(a){var c=a.ZoC;if(0<c){var d=b[0===a.team?1:0];d.surround(a.hex,1,function(a){return d.set(d.get(a)+c,a)})}});this._zoc=b}return this._zoc},enumerable:!0,configurable:!0});c.prototype.mapFor=function(a){return a?this.stack.ensure(a):void 0};c.prototype.setUnit=function(a,b){var c=this.field,d=c.rawget(b);if(null==d)throw Error("Cannot set unit at "+
b+": out of range");var e=d.unit;if(a){if(e===a)return;if(e)throw Error("Cannot set unit at "+b+": already exists");a.hex&&(c.rawget(a.hex).unit=null);a.hex=b}else e&&(e.hex=null);d.unit=a;this._zoc=void 0};c.prototype.startTurn=function(){var a=this;this.eachUnit(function(b){b.onTurnStart(a)});this.stack=new xa(this,this.zoc);this.controller.visible=!0};c.prototype.retire=function(){var a=this;Da.confirm(this,h("Combat","ConfirmRetire"),{label:h("Combat","Retire"),click:function(){a.controller.visible=
!1;(new da(a,new Ia.Home(a.data))).attach(a.parent)},mnemonic:cb},{label:h("Config","Cancel"),mnemonic:db})};c.prototype.endTurn=function(){var a=this;this.controller.visible=!1;this.eachUnit(function(b){b.onTurnEnd(a)});if(0===this.team){var b=this.numScrollsPerTurn;if(0<b){var c=this.field.minXH+b;this.eachUnit(function(b){b.hex.xH<c&&(b.state=new qa(b,b.HP),a.kill(b))});var d=this.field.depth;(new I(400*b,function(c){a.scrollTo(d+b*c)})).attach(this);if(this.isGameOver)return}}this.team=0===this.team?
1:0;var e=va[this.team],f=e.bkgnd,g=f.rgba,l=(new k(f.r,f.g,f.b,0)).rgba,m=e.textStyle,t=h("Combat",e.messageID);(new I(800,function(a,b){b.save();b.globalAlpha=V(W*a);Oa(b,0,0,1280,560,g,l);Na(b,t.localized,640,280,m);b.restore()})).then(function(){a.startTurn()}).attach(this)};c.prototype.move=function(a,b){var c=this;if(!this.enabled)return null;Ra(!b.equals(a.hex));var d=function(b){b=c.stack=new xa(c,c.zoc,b);a.done(c)||(b.focus=a);c.enabled=!0};this.focus=a;var e=this.field,f=this.mapFor(a),
g=f.get(b);if(null!=g.deltaHP){this.enabled=!1;g=function(){return a.shoot(c,b).then(d)};if(a.canTarget(e,b))return g();var h=this.mapFor(a),f=h.getPath(b),k=f[f.length-1];Ra(!k.equals(b));Ra(!k.equals(a.hex));Ra(a.canTargetFrom(e,k.xH,k.yH,b.xH,b.yH));this.setUnit(a,k);a.SP=h.get(k).SP;e=a.state=new za(f);g=Wa(g);e.then(g);return g}if(0<=g.SP&&e.rawget(b).empty)return f=f.getPath(b),this.setUnit(a,b),a.SP=g.SP,e=a.state=new za(f),d(this.stack),m.wait.WALK?e:P};c.prototype.findUnit=function(a,b,c){var d=
this.field,e=d.minXH,f=d.maxXH,g=(0===this.team?b:!b)?1:-1;b=b?1:-1;var h,k;a?(h=a.xH,k=a.yH,a):(h=0>g?e:f-1,k=0>b?0:2);for(a=1;a<3*(f-e+1);++a){k+=b;if(0>k||3<=k)k=0>k?2:0,h+=g,h<e?h=f-1:f<=h&&(h=e);var l=d.rawget(h,k).unit;if(l&&c(l))return l}return null};c.prototype.undo=function(){var a=this.stack.undo(this);a?this.stack=a:G.error(h("Combat","CannotUndo"))};c.prototype.kill=function(a){var b=this;a.HP=0;this.setUnit(null,a.hex);this.dying.push(a);0===a.team&&this.parent&&this.isGameOver&&(this.controller.visible=
!1,(a.state||P).then(function(){Da.confirm(b,h("Combat","GameOver"),{label:h("Combat","Retire"),click:function(){(new da(b,new Ia.Home(b.data))).attach(b.parent)},mnemonic:ob})}))};Object.defineProperty(c.prototype,"isGameOver",{get:function(){return null==this.findUnit(null,!0,function(a){return 0===a.team})},enumerable:!0,configurable:!0});c.prototype.createPopup=function(a,b,c){var d=this.toX(c)+64,e=this.toY(c)+80;c=new I(600);c.onAnimation=function(c,f){Na(f,a,d,e-40*c,{fontSize:48,fillStyle:b,
strokeStyle:k.BLACK,globalAlpha:V(W*c),lineWidth:4,textAlign:"center",textBaseline:"bottom"})};return c};c.prototype.prepareEffect=function(a,b,c,d){var e=this,f=$a(b).toString(),g=this.createPopup(f,0<b?ua:ra,d||a.hex),h=g.attach;g.attach=function(d){if(0>b||0>c)a.state=new qa(a,-b);d=h.call(g,d);a.HP=D(0,a.maxHP,a.HP+b);null!=c&&(a.SP=D(0,a.maxSP,a.SP+c));0>=a.HP&&e.kill(a);return d};return g};c.prototype.eachUnit=function(a){var b=this;this.field.eachVisible(function(c){(c=c.unit)&&a.call(b,c)})};
c.prototype.toX=function(a,b){var c;null==b?(d=a,c=d.xH,d):c=a;return 0+64*(c-1-this.field.depth);var d};c.prototype.toY=function(a,b){var c;null==b?(d=a,c=d.xH,b=d.yH,d):c=a;return 80+80*(2*b+c%2);var d};c.prototype.toHex=function(a,b){var c=this.field,d=a-0+128*c.depth/2,e=p((b-0-80)/80);if(0<=e&&6>e){var f=void 0,f=0===e%2?2*p((d+64)/128):2*p(d/128)+1;if(c.minXH<=f&&f<c.maxXH)return c=p(e/2),new O(f,c)}return null};c.prototype.scrollTo=function(a){var b=this.field;if(a>b.depth){var c=b.minVisibleXH,
d=b.maxVisibleXH;b.depth=a;a=b.minVisibleXH;for(var e=b.maxVisibleXH;c<a;++c)b.deleteLine(c);for(c=T(a,d);c<e;++c)b.setLine(c,this.stage.generate(b,c))}};c.prototype.onDraw=function(b,c){this.stage.draw(b,c,this);var d=this.focus;d&&this.drawMarkers(b,c,this.stack.startTime,this.mapFor(d),d);a.prototype.onDraw.call(this,b,c)};c.prototype.drawMarkers=function(a,b,c,d,e){var f=this,g=I.clamp(b,c,300);if(!(0>=g)){var h=e.cost;b=e.skill.hostile?N:X;var k=b.DASH_OR_RANGE,l=b.RANGE,C=b.TARGET;a.save();
1>g&&(a.globalAlpha=g);d.eachVisible(function(b,c,d){var e=b.SP,H=b.shotFrom,z,m=0,t=0;null!=b.deltaHP?(z=C,m=32*(1-g),t=20*(1-g)):e>=h?z=ba:0<=e?z=H?k:L:H&&(z=l);z&&(b=f.toX(c,d)-m,c=f.toY(c,d)-t,m=128+2*m,t=80+2*t,a.fillStyle=z.bkgnd,a.fillRect(b+5,c+5,m-10,t-10),a.strokeStyle=z.outer,a.lineWidth=2,a.strokeRect(b+2,c+2,m-4,t-4),a.strokeStyle=z.inner,a.lineWidth=1,a.strokeRect(b+4,c+4,m-8,t-8))});a.restore()}};c.prototype.drawUnits=function(a,b,c){function d(a,b,c,e){if(null==a)return null;if(null==
c)return a;b=I.cycle(b,c,e);b=(1-ma(2*W*b))/2;return 0>=b?null:1<=b?a:new k(a.r,a.g,a.b,a.a*b)}var e=this,f=this.zoc,g=this.focus,l=this.mapFor(g),m=[];this.eachUnit(function(a){var c=a.getXY(e,b);c.unit=a;m.push(c)});for(var t=0;t<this.dying.length;){var C=this.dying[t],J=C.getXY(this,b);J?(J.unit=C,m.push(J),++t):this.dying.splice(t,1)}m.sort(ja.compare);for(var t=h("Combat","Done").localized,n,p,q,J=0;J<m.length;J++){var v=m[J],C=v.unit,y=v.x,v=v.y,w=void 0;if(g)if(g===C)w=n=n?n:d(U,b,c,1E3);else{var x=
C.hex;x&&(x=l.get(x).deltaHP,0>x?w=p=p?p:d(Z,b,c,1E3):0<x&&(w=q=q?q:d(aa,b,c,1E3)))}C.draw(a,b,y,v,w);if(null==C.state){var x=C.hex,w=C.SP,B=C.step,D=C.cost,C=C.team;x&&w<D&&(w<B?Na(a,t,y,v,oa):w<B+f[C].get(x)&&Na(a,t,y,v,Fa))}}};c.prototype.drawBarsOnIdle=function(a){var c=this;this.eachUnit(function(d){var e=d.hex,f=c.toX(e)+16,e=c.toY(e)+60;d.drawHP(a,f,e);b(a,f,e+6,96,6,d.SP,d.maxSP,null,Kb)})};c.prototype.drawBarsOnFocus=function(a,b,c){var d=this,e=this.field;c.each(function(b,c,f){b=b.deltaHP;
if(null!=b){var g=e.get(c,f).unit;g&&g.drawHP(a,d.toX(c,f)+16,d.toY(c,f)+60,b)}})};c.prototype.drawPanel=function(a,b,c){if(b){a.save();switch(b.team){case 0:a.fillStyle="#000044";a.strokeStyle="#CCCCFF";break;case 1:a.fillStyle="#440000";a.strokeStyle="#FFCCCC";break;default:a.fillStyle="#004400",a.strokeStyle="#CCFFCC"}a.fillRect(c.x,c.y,c.w,c.h);a.strokeRect(c.x,c.y,c.w,c.h);a.restore();b.drawCharacter(a,null,c.x+64,c.y+c.h-10);a.save();a.fillStyle="#FFFFFF";a.textAlign="left";a.textBaseline="top";
a.fillText(b.name,c.x+128,c.y+10);a.fillText("HP: "+b.HP+" / "+b.maxHP,c.x+128,c.y+10+30);var d=b.SP>=b.cost?p((b.SP-b.cost)/b.step):"-";a.fillText("SP: "+b.SP+" / "+b.maxSP,c.x+128,c.y+10+60);a.fillText("MOVE: "+d+"/"+p(b.SP/b.step),c.x+128,c.y+10+90);a.fillText("ATK/DEF: "+function(a){return null!=a?a.toFixed(1):"-"}(b.ATK)+" / "+b.DEF.toFixed(1),c.x+128,c.y+10+120);a.restore()}};return c}(S);a.Scene=ea;var Ga=function(a){function b(){a.apply(this,arguments);this._mode=0}n(b,a);Object.defineProperty(b.prototype,
"mode",{get:function(){0!==this._mode&&null==this.parent.focus&&(this._mode=0);return this._mode},set:function(a){this._mode=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"target",{get:function(){if(1<=this.mode){var a=this.caret;if(a){var b=this.parent,c=b.focus,d=b.field.get(a).unit;if(c&&c.isTarget(d)&&b.mapFor(c).get(a).shotFrom)return d}}return null},enumerable:!0,configurable:!0});b.prototype.moveCaretTo=function(a){this.caret=a;if(0===this.mode){var b=this.parent;b.focus=
a?b.field.get(a).unit:null}};b.prototype.onHover=function(a,b){this.moveCaretTo(this.parent.toHex(a,b))};b.prototype.onDrag=function(a,b){this.moveCaretTo(this.parent.toHex(a,b))};b.prototype.downCaret=function(a){if(this.caret=a){var b;a:{b=this.parent;var c=this.mode,d=b.focus;if(d){if(d.team===b.team&&!d.done(b)){b=1===c&&a.equals(d.hex)?3:2;break a}}else if(a=b.field.get(a).unit,b.focus=a){b=2;break a}b=0}this.mode=b}};b.prototype.onDown=function(a,b){this.downCaret(this.parent.toHex(a,b))};b.prototype.upCaret=
function(a){function b(a,c,d){if(2>c)return c;var e=a.focus;if(null==e||a.team!=e.team)return 0;if(d.equals(e.hex))return 2===c?1:0;if(a.move(e,d))return a.focus?1:0;a.focus=null;return 0}if(this.caret=a)this.mode=b(this.parent,this.mode,a)};b.prototype.onUp=function(a,b){this.upCaret(this.parent.toHex(a,b))};b.prototype.onPress=function(a){function b(a){var c=this.parent.field,d=this.caret;d?(a=d.near(a),c.contains(a)&&this.moveCaretTo(a)):this.moveCaretTo(new O(c.minXH,0))}function c(a){var b=this.parent,
d=this.caret,e=b.team,f=b.focus;(a=b.findUnit(f?f.hex:d,a,function(a){return a.team===e&&!a.done(b)}))?(b.focus=a,null==d&&(this.caret=a.hex),0===this._mode&&(this.mode=1)):G.error(h("Combat","UnitNotAvailable"))}var d=this.parent;switch(a){case l.TAB:case l.Q:d.undo();break;case l.PAGE_DOWN:case l.C:c.call(this,!0);break;case l.PAGE_UP:c.call(this,!1);break;case l.SPACE:case l.ENTER:this.click(this.caret);break;case l.E:b.call(this,0);break;case l.RIGHT:case l.D:b.call(this,1);break;case l.DOWN:case l.X:case l.S:b.call(this,
2);break;case l.Z:b.call(this,3);break;case l.LEFT:case l.A:b.call(this,4);break;case l.UP:case l.W:b.call(this,5)}};b.prototype.click=function(a){this.parent.field.contains(a)&&(this.downCaret(a),this.upCaret(a))};b.prototype.onDraw=function(a,b){function c(a,b,d,e){var f=b.toX(d)+6.5;b=b.toY(d)+6.5;a.save();a.lineCap="round";a.lineJoin="round";a.beginPath();a.moveTo(f+32,b);a.lineTo(f,b);a.lineTo(f,b+20);a.moveTo(f+115-32,b);a.lineTo(f+115,b);a.lineTo(f+115,b+20);a.moveTo(f+115-32,b+67);a.lineTo(f+
115,b+67);a.lineTo(f+115,b+67-20);a.moveTo(f+32,b+67);a.lineTo(f,b+67);a.lineTo(f,b+67-20);a.lineWidth=7;a.strokeStyle=e.outer;a.stroke();a.lineWidth=3;a.strokeStyle=e.inner;a.stroke();a.restore()}function d(a,b,c){a.save();a.lineCap="butt";a.lineJoin="round";var e=b.toX(c[c.length-2])+64,f=b.toY(c[c.length-2])+40,g=b.toX(c[c.length-1])+64,h=b.toY(c[c.length-1])+40,e=ub(h-f,g-e);a.beginPath();a.moveTo(g+20*ma(e),h+20*V(e));a.lineTo(g+20*ma(e+2*W/3),h+20*V(e+2*W/3));a.lineTo(g+20*ma(e-2*W/3),h+20*
V(e-2*W/3));a.fillStyle=ha;a.fill();a.beginPath();a.moveTo(g-10*ma(e),h-10*V(e));for(g=c.length-2;0<=g;--g)h=c[g],a.lineTo(b.toX(h)+64,b.toY(h)+40);a.strokeStyle=ha;a.lineWidth=12;a.stroke();a.restore()}var e=this.caret;if(e){var f=this.parent,g=f.focus,h=f.field;if(0===this.mode)c(a,f,e,E);else if(g&&g.team===f.team){var k=f.mapFor(g),l=k.get(e);(k=k.getPath(e))&&2<=k.length&&d(a,f,k);if(null!=l.deltaHP)switch(g=g.skill,g.target){case 0:c(a,f,e,q);break;case 1:c(a,f,e,M);break;case 2:h.straight(l.shotFrom,
e,g.range,function(b){return c(a,f,b,q)});break;case 3:h.straight(l.shotFrom,e,g.range,function(b){return c(a,f,b,M)});break;case 4:h.surround(l.shotFrom,g.range,function(b){return c(a,f,b,q)});break;case 5:h.surround(l.shotFrom,g.range,function(b){return c(a,f,b,M)})}else 0<=l.SP?c(a,f,e,Q):c(a,f,e,E)}}};return b}(ca),Ha=function(a){function b(){a.apply(this,arguments);this.running=!1}n(b,a);Object.defineProperty(b.prototype,"visible",{get:function(){return this.running},set:function(a){var b=this;
(this.running=a)&&P.then(function(){return b.run([])})},enumerable:!0,configurable:!0});b.prototype.run=function(a){function b(a,c){var d=a.focus;if(d)return d;var e=a.team,d=c.length,d=0<d?a.findUnit(c[d-1].hex,!1,function(b){return b.team===e&&!b.done(a)&&0>c.indexOf(b)}):a.findUnit(null,!1,function(b){return b.team===e&&!b.done(a)});return a.focus=d}function c(a,b,e){var f=a.field,g=a.numScrollsPerTurn,h=a.mapFor(b),k=f.minXH,l=f.maxXH,r=b.maxSP,t=b.hex,J=b.cost,n=k+g,H=t,z=d(b,t.xH,t.yH,k,l,n)+
40*b.SP/r;h.each(function(a,c,e){var g=a.SP,m=a.deltaHP;a=a.shotFrom;var t;if(null!=m){g=t=d(b,a.xH,a.yH,k,l,n);t=400;var u=f.rawget(c,e).unit,p=-u.trySkill(b),u=u.HP,m=-m,q=b.maxHP;0<p&&0<m&&(t=u<=m?t+600*T(1,p/q):t+600*T(1,p/q)*T(1,m/u));t=g+t;g=h.get(a).SP-J}else if(0<=g&&f.rawget(c,e).empty)t=d(b,c,e,k,l,n);else return;t+=40*g/r;z<t&&(z=t,H=new O(c,e))});if(H.equals(t))return e.push(b),a.focus=null;e.length=0;e=m.wait.PICK;return 0<e?(g=Wa(function(){return a.move(b,H)}),(new I(e)).then(g).attach(a),
g):a.move(b,H)}for(var e=this,f=this.parent,g=null;this.running;){f.enabled||(g=P);if(g){g.then(function(){return e.run(a)});break}g=b(f,a);if(null==g){f.endTurn();break}g=c(f,g,a)}};return b}(ca),Va={Charge:function(a,b,c){c=a.field.get(c).unit;var d=b.trySkill(c),e=a.prepareEffect(c,d);c=new pa(a,b.hex,c.hex);b.state=c;c.hit(function(){e.attach(a)});return m.wait.POPUP?new Sa([e,c]):c},Knockback:function(a,b,c){var d=a.field,f=e(d,b.hex,c);if(null==f)return Va.Charge(a,b,c);var g=d.get(c).unit,
d=b.trySkill(g),h=a.prepareEffect(g,d,null,f),d=new pa(a,b.hex,g.hex),k=new za([c,f]);b.state=d;d.hit(function(){a.setUnit(g,f);g.state=k});k.then(function(){h.attach(a)});return m.wait.POPUP?new Sa([h,d]):d},GoBehind:function(a,b,c){var d=a.field,f=e(d,b.hex,c);if(null==f)return Va.Charge(a,b,c);var g=b.hex,d=d.get(c).unit,h=b.trySkill(d),k=a.prepareEffect(d,h);c=new za([g,c]);a.setUnit(b,f);b.state=c;c.then(function(){k.attach(a)});return m.wait.POPUP?k:c},Trample:function(a,b,c){var d=a.field,
f=e(d,b.hex,c);if(null==f)return Va.Charge(a,b,c);var g=b.hex,d=d.get(c).unit,h=b.trySkill(d),k=a.prepareEffect(d,h,null,f),g=new za([g,c]),h=new za([c,c,f]);a.setUnit(d,f);d.state=h;a.setUnit(b,c);b.state=g;h.then(function(){k.attach(a)});return m.wait.POPUP?k:h},Shoot:function(a,b,c){c=a.field.get(c).unit;var d=b.trySkill(c);return g(a,b,c,a.prepareEffect(c,d),x(255,128,0),y(255,128,0,0))},Freeze:function(a,b,c){c=a.field.get(c).unit;var d=b.trySkill(c),e=p(d/2);return g(a,b,c,a.prepareEffect(c,
d,e),x(0,128,255),y(0,128,255,0))},Drain:function(a,b,d){var e=a.field.get(d).unit,f=b.trySkill(e);d=a.prepareEffect(e,f);var g=a.prepareEffect(b,-f);b=c(a,e.hex,b.hex,x(255,0,128),y(255,0,128,0));b.then(function(){g.attach(a)});d.attach(a);return m.wait.POPUP?g:b},Explode:function(a,b,d){var e=a.field.get(d).unit;b.trySkill(e);var e=c(a,b.hex,e.hex,x(255,128,0),y(255,128,0,0)),g=Wa(function(){return f(a,b,d,1,new k(1,.5,0),function(a,b){return p(a/(1+b))})});e.then(g);return g},Laser:function(a,
b,c){var d=a.field,e=b.hex,f,g=[];d.straight(e,c,b.skill.range,function(c){var e=d.get(c).unit;if(b.isTarget(e)){var h=b.trySkill(e),e=a.prepareEffect(e,h);e.attach(a);g.push(e)}f=c});c=new I(400,function(b,c){var d=a.toX(e)+64,g=a.toY(e)+40,h=a.toX(f)+64,l=a.toY(f)+40,m=ub(l-g,h-d),n=64*ma(m),m=40*V(m);c.save();c.beginPath();c.moveTo(d+n,g+m);c.lineTo(h+n,l+m);c.lineCap="round";c.lineWidth=80*b/4;c.strokeStyle=(new k(1,.5,0,1-b)).rgba;c.stroke();c.restore()});c.attach(a);return m.wait.POPUP?(g.push(c),
new Sa(g)):c},Nova:function(a,b,c){return f(a,b,b.hex,b.skill.range,new k(1,.5,0),function(a,b){return p(a/b)})}}})(ya||(ya={}));var Ea,m=new (function(){function a(){this._refineCanvas=this._magnifyCanvas=!1;this.volume=new yb(50,0,100);this.effects=new yb(Ga.length-1,0,Ga.length-1)}Object.defineProperty(a.prototype,"magnifyCanvas",{get:function(){return this._magnifyCanvas},set:function(a){this._magnifyCanvas!=a&&(this._magnifyCanvas=a,window.dispatchEvent(new UIEvent("resize")))},enumerable:!0,
configurable:!0});Object.defineProperty(a.prototype,"refineCanvas",{get:function(){return this._refineCanvas},set:function(a){this._refineCanvas!=a&&(this._refineCanvas=a,window.dispatchEvent(new UIEvent("resize")))},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"wait",{get:function(){return Ga[this.effects.value]},enumerable:!0,configurable:!0});return a}());System.main=function(a,b){var d=new Image;d.src="assets/dummy.png";R.DUMMY=d;var d=new S,e=new S;e.attach(d);var c=new Jb(10,
10,1260,700,2E3,Hb);c.attach(d);G=c;Ea=function(){for(;;){var a=e.children,b=a.length;if(0===b)break;a[b-1].detach()}(new vb(new fb.Scene)).attach(e)};Gb();Ea();Cb(a,d,m)};System.checkpoint=function(){tb()}})();
